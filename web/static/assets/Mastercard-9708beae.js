var $t=Object.defineProperty;var Ut=(e,a,l)=>a in e?$t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[a]=l;var ct=(e,a,l)=>(Ut(e,typeof a!="symbol"?a+"":a,l),l);import{D as Me,H as gt}from"./Date-92490656.js";import{G as Ve,F as _t,d as x,r as O,ae as ie,a6 as ve,a2 as be,c as M,a as t,w as n,u as c,K as W,o as I,q as De,$ as We,b as E,S as Ye,i as re,j as ae,k as T,J as qe,s as Le,ar as xe,C as je,I as te,n as Je,ai as Ie,H as B,L as g,f as fe,h as U,y as H,at as Bt,t as oe,au as bt,N as Se,av as Ft,a5 as Ht,aw as Mt,l as qt,a4 as Lt,ax as Gt,p as zt,e as Wt,ay as Yt,U as jt,af as Jt,as as mt,az as Qt}from"./index-2cf16bdb.js";import{g as Kt,D as ht,C as He,P as Ge,O as Ue}from"./patient_service-5fb5c7e9.js";import{g as Ke,i as z}from"./common-abc2f84d.js";import{A as ce,P as Xt,V as Zt,C as xt,E as pt}from"./consultation_service-cb26fe93.js";import{P as yt}from"./program_service-9319d8f8.js";import{p as Vt}from"./VoidReason-29de2c13.js";import{a as K,t as _e,d as Z,e as ea}from"./his_date-ed090df2.js";import{D as ge}from"./DateInput-720c83c7.js";import{S as le}from"./SelectInput-7841d8a1.js";import{N as ee,R as Ce}from"./regimen_service-3af42624.js";import{t as ze,a as ta,g as aa}from"./DTFormElements-a1199b88.js";import{e as Te}from"./encounter_types-ae359711.js";import{s as Ne,i as na,r as oa,a as Be}from"./form-8963dd6a.js";import{E as q,a as L}from"./emc_event-4721851b.js";import{m as F,D as la}from"./DrilldownTable-d77041f8.js";import{a as Oe,t as at}from"./toasts-c6607b61.js";import{D as nt}from"./index-3ac00770.js";import{_ as ne}from"./_plugin-vue_export-helper-c27b6911.js";import{T as Pe}from"./TextInput-22aa6ac4.js";import{g as ia,a as ra,b as sa}from"./location_options-97fdbb0a.js";import{r as de,v as Fe,d as ue,e as vt,a as Ee,b as ua,c as wt}from"./validations-b9fbcec4.js";import{Y as pe}from"./YesNoInput-6f8e8d99.js";import{c as da,u as ft}from"./arrays-31d2d38b.js";import{t as ca}from"./Strs-7ee8a435.js";import{P as et,R as Xe}from"./relations_service-4587ea44.js";import{l as Ze}from"./loader-4d6883e8.js";import"./patient_identifier_service-82916d86.js";import"./index-95d3a767.js";import"./vue-datepicker-b5cf8b92.js";const ma=e=>{const a=e.given_name,l=e.family_name,r=e.middle_name?e.middle_name:"";return"".concat(a," ").concat(r," ").concat(l)};class pa{static getRelationships(a){return Ve.getJson("/people/".concat(a,"/relationships")).then(l=>l.data)}static async getGuardianDetails(a){return await this.getRelationships(a).then(l=>l.map(r=>{const d=Ke(r,"relation.names[0]");return{id:r.relationship_id,name:d?ma(d):"",relationshipType:Ke(r,"type.b_is_to_a",""),phoneNumber:Kt(Ke(r,"relation.person_attributes",[]),12),names:d}}))}}const Ae=class Ae extends ce{constructor(a){super(a,Te.LAB_ORDERS,K())}async loadConcepts(){Ae.conceptID=await ce.getConceptID("HIV Viral Load")}createLabOrder(a,l){const r=Ve.getUsername(),d=_t().facility.name,f=ce.getCachedConceptID(l,!0);return Ve.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:r,target_lab:d,reason_for_test_id:f,encounter_id:this.encounterID,tests:[{concept_id:Ae.conceptID}],date:this.date,specimen:{concept_id:a}}]})}createLabResult(a,l,r,d="numeric"){return Ve.postJson("lab/tests/".concat(a,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Ae.conceptID},value:l,value_modifier:r,value_type:d}]})}static getSpecimens(a){return Ve.getJson("/lab/specimen_types",{test_type:a})}static async getOrders(a,l={}){var d;return(d=(await Ve.getJson("/lab/orders",{patient_id:a,...l})).data)!=null?d:[]}static async getViralLoadResultTrail(a,l={}){return(await this.getOrders(a,l)).reduce((d,f)=>(f.tests.forEach(i=>i.result.forEach(s=>d.push({...f,test:i.name,result:"".concat(s.value_modifier," ").concat(s.value),result_date:s.date}))),d),[])}static async getlatestViralLoadResult(a,l={}){const d=(await this.getOrders(a,l)).reduce((f,i)=>(f.push(...i.tests.flatMap(s=>s.result)),f),[]).sort((f,i)=>new Date(f.date)>new Date(i.date)?-1:1);return d&&d.length>0?"".concat(d[0].value_modifier).concat(d[0].value," (").concat(_e(d[0].date),")"):"N/A"}};ct(Ae,"conceptID",-1);let we=Ae;const va=x({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=O(!1),r=ze(["=",">","<",">=","<="]),d=ze(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),f=O([]),i=a.patient.getBirthdate(),s=ie({orderDate:{value:"",label:"Order Date",required:!0,validation:async _=>Z(_.value).isValid()?new Date(_.value)>new Date(K())?["Order date cannot be in the future"]:new Date(_.value)<new Date(i)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(_,y)=>Z(_.value).isValid()?new Date(_.value)>new Date(K())?["Result date cannot be in the future"]:new Date(_.value)<new Date(y.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function p(){Ne(s,async _=>{const y=new we(a.patient.getID());if(await y.loadConcepts(),y.setDate(_.orderDate),!await y.createEncounter())throw new Error("Unable to create lab order encounter");const b=await y.createLabOrder(_.specimen.value,_.reason.value);if(!b.ok||!b.data)throw new Error("Unable to save lab orders");const A=new we(a.patient.getID());if(A.setDate(_.resultDate),!await A.createEncounter())throw new Error("Unable to create lab result encounter");const h=l.value?"LDL":parseInt(_.result),w=l.value?"=":_.modifier.value,C=l.value?"text":"numeric",$=b.data[0].tests[0].id;await A.createLabResult($,h,w,C),await F.hide(),q.emit(L.RELOAD_LATEST_VL_RESULT),q.emit(L.RELOAD_PATIENT_VISIT_DATA)})}async function V(){if(await Ie("Are you sure you want to clear all fields?")){l.value=!1;for(const _ in s)s[_].value="",s[_].error="";q.emit(L.ON_CLEAR)}}return ve(l,_=>{_&&(s.modifier.value="",s.result.value=void 0,s.modifier.error="",s.result.error=""),s.modifier.disabled=_,s.modifier.required=!_,s.result.disabled=_,s.result.required=!_}),be(async()=>{f.value=(await we.getSpecimens("HIV viral load")).data.map(_=>({label:_.name,value:_.concept_id}))}),(_,y)=>(I(),M(W,null,[t(c(Ye),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(We),null,{default:n(()=>[E("Viral Load Results")]),_:1})]),_:1})]),_:1}),t(c(je),{class:"ion-padding"},{default:n(()=>[t(c(re),{style:{width:"100%"}},{default:n(()=>[t(c(ae),null,{default:n(()=>[t(c(T),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:s.orderDate,"onUpdate:modelValue":y[0]||(y[0]=N=>s.orderDate=N),form:s,minDate:c(i),maxDate:c(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:s.reason,"onUpdate:modelValue":y[1]||(y[1]=N=>s.reason=N),options:c(d)},null,8,["modelValue","options"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:s.specimen,"onUpdate:modelValue":y[2]||(y[2]=N=>s.specimen=N),options:f.value},null,8,["modelValue","options"])]),_:1}),t(c(T),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:s.resultDate,"onUpdate:modelValue":y[3]||(y[3]=N=>s.resultDate=N),form:s,minDate:s.orderDate.value,"max-date":c(K)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:s.modifier,"onUpdate:modelValue":y[4]||(y[4]=N=>s.modifier=N),options:c(r)},null,8,["modelValue","options"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:s.result,"onUpdate:modelValue":y[5]||(y[5]=N=>s.result=N),form:s,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),t(c(ae),{class:"ion-margin-top"},{default:n(()=>[t(c(T),{size:"12"},{default:n(()=>[t(c(qe),{class:"ion-padding-vertical bold"},{default:n(()=>[E(" Other Results Options: ")]),_:1}),t(c(Le),null,{default:n(()=>[t(c(qe),null,{default:n(()=>[E("LDL")]),_:1}),t(c(xe),{slot:"start",modelValue:l.value,"onUpdate:modelValue":y[6]||(y[6]=N=>l.value=N)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(c(Je),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(te),{color:"primary",onClick:y[7]||(y[7]=N=>c(F).hide()),slot:"end"},{default:n(()=>[E(" Close ")]),_:1}),t(c(te),{color:"warning",onClick:V,slot:"end"},{default:n(()=>[E(" Reset ")]),_:1}),t(c(te),{color:"success",onClick:p,slot:"end"},{default:n(()=>[E(" Save ")]),_:1})]),_:1})]),_:1})],64))}}),fa=x({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:nt},emits:["voidOutcome"],setup(e,{emit:a}){const l=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:i=>Z(i).format(Me)},{path:"end_date",label:"End Date",formatter:i=>Z(i).format(Me)}],r={showSearchField:!1,showSubmitButton:!1};return{rows:B(()=>e.patientStates.map((i,s)=>({...i,index:s}))),columns:l,tableConfig:r,TableRowActions:[{label:"void",color:"danger",action:async i=>{await Ie("Are you sure you want to void this outcome?")&&a("voidOutcome",{stateId:i.patient_state_id,index:i.index})}}]}}}),ga=fe("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1);function _a(e,a,l,r,d,f){const i=g("data-table");return I(),M(W,null,[ga,t(i,{rows:e.rows,columns:e.columns,config:e.tableConfig,"row-actions-buttons":e.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const ba=ne(fa,[["render",_a]]),ha=x({name:"EnrollmentForm",components:{DateInput:ge,IonGrid:re,IonRow:ae,IonCol:T,IonButton:te},props:["birthdate"],emits:["enrollProgram"],setup(e,{emit:a}){const l=Z().format("YYYY-MM-DD"),r=ie({date:{value:"",label:"Date of Enrollment",required:!0,validation:async i=>new Date(i.value)<new Date(e.birthdate)?["Date of enrollment cannot be before date of birth"]:new Date(i.value)>new Date(l)?["Date of enrollment cannot be in the future"]:null}});return{form:r,today:l,onReset:async()=>{await Ie("Are you sure you want to clear all fields")&&(r.date.value="",r.date.error="",q.emit(L.ON_CLEAR))},enrollProgram:async()=>Ne(r,({date:i})=>a("enrollProgram",i))}}});function ya(e,a,l,r,d,f){const i=g("DateInput"),s=g("ion-col"),p=g("ion-button"),V=g("ion-row"),_=g("ion-grid");return I(),U(_,null,{default:n(()=>[t(V,null,{default:n(()=>[t(s,{size:"12"},{default:n(()=>[t(i,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=y=>e.form.date=y),form:e.form,minDate:e.birthdate,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(s,null,{default:n(()=>[t(p,{color:"warning",onClick:e.onReset},{default:n(()=>[E("Reset")]),_:1},8,["onClick"]),t(p,{color:"success",onClick:e.enrollProgram},{default:n(()=>[E("Enroll")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Va=ne(ha,[["render",ya]]),wa=x({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:ge,IonGrid:re,IonRow:ae,IonCol:T,IonButton:te,SelectInput:le,TextInput:Pe},emits:["saveOutcome"],setup(e,{emit:a}){const l=Z().format("YYYY-MM-DD"),r=ie({date:{value:"",label:"Outcome Date",required:!0,validation:async p=>new Date(p.value)<new Date(e.birthdate)?["Outcome date cannot be before date of birth - ".concat(Z(e.birthdate).format(Me))]:new Date(p.value)<new Date(e.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(Z(e.dateEnrolled).format(Me))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(p,V)=>V.status.value.label==="Patient transferred out"&&de(p)},reason:{value:"",label:"Reason for transfer out",validation:async(p,V)=>V.status.value.label==="Patient transferred out"&&de(p)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(p,V)=>{var _,y,N,b;return((y=(_=V.status)==null?void 0:_.value)==null?void 0:y.label)==="Patient transferred out"&&((b=(N=V.reason)==null?void 0:N.value)==null?void 0:b.label)==="Other"&&de(p)}}}),d=B(()=>{var p;return((p=r.status.value)==null?void 0:p.label)==="Patient transferred out"}),f=B(()=>{var p,V;return((V=(p=r.reason)==null?void 0:p.value)==null?void 0:V.label)==="Other"});return{form:r,today:l,isTransferredOut:d,specifyOther:f,onSave:()=>Ne(r,p=>a("saveOutcome",{...p,isTransferredOut:d.value})),onReset:async()=>{if(await Ie("are you sure you want to clear all fields")){for(const p in r)r[p].value="",r[p].error="";q.emit(L.ON_CLEAR)}},getFacilities:ia,transferOutReasons:ta}}}),Da=fe("p",null,"Add New Outcome",-1);function Ia(e,a,l,r,d,f){const i=g("ion-col"),s=g("DateInput"),p=g("SelectInput"),V=g("text-input"),_=g("ion-button"),y=g("ion-row"),N=g("ion-grid");return I(),U(N,null,{default:n(()=>[t(y,null,{default:n(()=>[t(i,{size:"12"},{default:n(()=>[Da]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(s,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=b=>e.form.date=b),form:e.form,minDate:e.dateEnrolled,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(p,{modelValue:e.form.status,"onUpdate:modelValue":a[1]||(a[1]=b=>e.form.status=b),form:e.form,options:e.outcomes},null,8,["modelValue","form","options"])]),_:1}),e.isTransferredOut?(I(),M(W,{key:0},[t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(p,{modelValue:e.form.nextFacility,"onUpdate:modelValue":a[2]||(a[2]=b=>e.form.nextFacility=b),form:e.form,asyncOptions:e.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(p,{modelValue:e.form.reason,"onUpdate:modelValue":a[3]||(a[3]=b=>e.form.reason=b),form:e.form,options:e.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),e.specifyOther?(I(),U(i,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[t(V,{modelValue:e.form.otherReason,"onUpdate:modelValue":a[4]||(a[4]=b=>e.form.otherReason=b),form:e.form},null,8,["modelValue","form"])]),_:1})):H("",!0)],64)):H("",!0),t(i,{size:"12",class:"ion-margin-top"},{default:n(()=>[t(_,{color:"warning",onClick:e.onReset},{default:n(()=>[E("Reset")]),_:1},8,["onClick"]),t(_,{color:"success",onClick:e.onSave},{default:n(()=>[E("Save")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Na=ne(wa,[["render",Ia]]),Ra=x({components:{IonContent:je,IonFooter:Je,IonHeader:Ye,IonTitle:We,IonToolbar:De,IonButton:te,IonGrid:re,IonRow:ae,IonCol:T,IonBadge:Bt,OutcomesTable:ba,EnrollmentForm:Va,OutcomeForm:Na},props:{patient:{type:Object,required:!0}},setup(e){const{toStandardHisDisplayFormat:a,toStandardHisFormat:l}=gt,r=new Xt(e.patient.getID()),d=B(()=>l(e.patient.getBirthdate())),f=O(),i=B(()=>!z(f.value)),s=O(""),p=O(),V=B(()=>{var D,h,w;return(w=(h=(D=f.value)==null?void 0:D.patient_states)==null?void 0:h.length)!=null?w:0}),_=B(()=>i.value&&s.value?"Patient enrolled in this porgram on ".concat(a(s.value)):"Patient is not enrolled in this program"),y=async({date:D,status:h,nextFacility:w,reason:C,otherReason:$,isTransferredOut:R})=>{if(r.setStateDate(D),r.setStateId(h.value),R){const P=C.value!=="Other"?C.value:$;await r.transferOutEncounter(w.other,P)}await r.updateState(),await Oe("Outcome saved successfully",1e3),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},N=async D=>{r.setProgramDate(D),await r.enrollProgram(),await Oe("Program enrolled successfully",1e3),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},b=async()=>{var D;r.setPatientProgramId(((D=f.value)==null?void 0:D.patient_program_id)||-1),await r.voidProgram("duplicate / system error"),await Oe("Patient voided from program successfully",1e3),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},A=async({stateId:D,index:h})=>{var w;r.setStateId(D),await r.voidState("duplicate / system error"),Oe("Outcome voided successfully"),(w=f.value)==null||w.patient_states.splice(h,1),q.emit(L.RELOAD_PATIENT_VISIT_DATA)};return be(async()=>{const D=(await r.getPrograms()).data;if(f.value=D.find(h=>h.program.name==="HIV PROGRAM"),f.value){s.value=f.value.date_enrolled;const h=await r.getProgramOutcomes(),w=new Set(r.removedStates);p.value=h.map(C=>({label:C.name,value:C.program_workflow_state_id,other:C})).filter(C=>!w.has(C.label))}}),{modal:F,patientProgram:r,isEnrolled:i,enrollDate:s,birthdate:d,enrollmentStatus:_,outcomes:p,program:f,totalStates:V,toStandardHisDisplayFormat:a,saveOutcome:y,enrollProgram:N,voidProgram:b,voidOutcome:A}}});function Aa(e,a,l,r,d,f){const i=g("ion-title"),s=g("ion-toolbar"),p=g("ion-header"),V=g("ion-badge"),_=g("ion-col"),y=g("ion-row"),N=g("enrollment-form"),b=g("outcome-form"),A=g("outcomes-table"),D=g("ion-grid"),h=g("ion-content"),w=g("ion-button"),C=g("ion-footer");return I(),M(W,null,[t(p,null,{default:n(()=>[t(s,null,{default:n(()=>[t(i,null,{default:n(()=>[E("Patient Outcomes")]),_:1})]),_:1})]),_:1}),t(h,null,{default:n(()=>[t(D,{style:{width:"100%"}},{default:n(()=>[t(y,null,{default:n(()=>[t(_,null,{default:n(()=>[t(V,{color:"lightblue",class:"ion-padding",style:{width:"100%"},disabled:""},{default:n(()=>[E(oe(e.enrollmentStatus),1)]),_:1})]),_:1})]),_:1}),e.isEnrolled?(I(),M(W,{key:1},[e.outcomes?(I(),U(y,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[t(b,{"date-enrolled":e.enrollDate,birthdate:e.birthdate,outcomes:e.outcomes,onSaveOutcome:e.saveOutcome},null,8,["date-enrolled","birthdate","outcomes","onSaveOutcome"])]),_:1})):H("",!0),t(y,{class:"his-card",style:bt({minHeight:e.totalStates?"0":"30vh"})},{default:n(()=>[t(_,{size:"12",class:"ion-no-padding"},{default:n(()=>{var $;return[t(A,{patientStates:($=e.program)==null?void 0:$.patient_states,onVoidOutcome:e.voidOutcome},null,8,["patientStates","onVoidOutcome"])]}),_:1})]),_:1},8,["style"])],64)):(I(),U(y,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[t(_,{size:"12"},{default:n(()=>[t(N,{patientProgram:e.patientProgram,birthdate:e.birthdate,onEnrollProgram:e.enrollProgram},null,8,["patientProgram","birthdate","onEnrollProgram"])]),_:1})]),_:1}))]),_:1})]),_:1}),t(C,null,{default:n(()=>[t(s,null,{default:n(()=>[t(w,{color:"primary",onClick:a[0]||(a[0]=$=>e.modal.hide()),slot:"end"},{default:n(()=>[E("Close")]),_:1}),e.isEnrolled?(I(),U(w,{key:0,color:"danger",onClick:e.voidProgram,slot:"end"},{default:n(()=>[E("Void Program")]),_:1},8,["onClick"])):H("",!0)]),_:1})]),_:1})],64)}const Sa=ne(Ra,[["render",Aa]]),Pa=x({name:"MultiColumnView",components:{IonGrid:re,IonRow:ae,IonCol:T},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(e){const a={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:B(()=>da(e.items,Math.ceil(e.items.length/e.numberOfColumns))),grid:a}}});function Ta(e,a,l,r,d,f){const i=g("ion-col"),s=g("ion-row"),p=g("ion-grid");return I(),U(p,null,{default:n(()=>[t(s,null,{default:n(()=>[(I(!0),M(W,null,Se(e.computedItems,(V,_)=>(I(),U(i,{key:_,size:e.grid[e.numberOfColumns]},{default:n(()=>[Ft(e.$slots,"default",{entries:V})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const tt=ne(Pa,[["render",Ta]]);class Ca extends ce{constructor(a,l=K()){super(a,Te.HIV_RECEPTION,l)}}class Oa extends ce{constructor(a,l=K()){super(a,Te.ART_ADHERENCE,l)}buildPillCountObs(a,l){return this.buildValueNumber("Number of tablets brought to clinic",l,null,a)}async buildAdherenceObs(a,l,r){return{concept_id:await ce.getConceptID("Drug adherence",!0),value_numeric:r,value_drug:l,value_modifier:"%",order_id:a,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(a,l,r){return Math.round(100*(a-l)/(a-r))}calculateExpected(a,l,r,d){const f=d==="QW"?"week":"day",i=this.calcTimeElapsed(r,f);return a-i*parseFloat(l.toString())}calcTimeElapsed(a,l){return Z(this.date).diff(a,l)+1}}class Ea extends ce{constructor(a,l=K()){super(a,Te.APPOINTMENT,l)}}class ka extends ce{constructor(a,l=K()){super(a,Te.TREATMENT,l)}calculateDosage(a,l){let r=0;return l===0&&(r=a),a==0&&(r=l),a>0&&l>0&&(r=(a+l)/2),r}calculateEquivalentDosage(a,l){return a+l}calculateDrugRunOutDate(a,l){return ea(Z(l).add(a,"days"))}getInstructions(a,l,r,d){return"".concat(a," :- Morning: ").concat(l," ").concat(d,", Evening: ").concat(r," ").concat(d)}toDrugOrder(a,l,r,d){return{drug_inventory_id:a.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(a.am,a.pm),start_date:d,auto_expire_date:this.calculateDrugRunOutDate(r,d),units:a.units,instructions:this.getInstructions(a.drug_name,a.am,a.pm,a.units),dose:this.calculateDosage(a.am,a.pm),frequency:a.frequency,qty:l}}async createDrugOrder(a){return ht.create({encounter_id:this.encounterID,drug_orders:a})}}class $a{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(a,l,r){let d={result:"",color:"",index:r};if(r<=0)return d.index=0,d;if(l<5&&l>0)d.result="Use MUAC to calculate nutrition status",d.color="red";else{l>18&&(l=19);const f=await this.getBMIData(),i=f[a][l];i&&(d=this.buildBounds(Object.keys(i),i,r,f.colors))}return d}static buildBounds(a,l,r,d){const f={result:"",color:"",index:r};return a.forEach(i=>{if(i.indexOf("-")>=0){const s=i.split("-");r>=parseFloat(s[0])&&r<=parseFloat(s[1])&&(f.result=l[i],f.color=d[l[i]])}else if(i.indexOf("<")>=0){const s=i.replace("<","");r<parseFloat(s)&&(f.result=l[i],f.color=d[l[i]])}else if(i.indexOf(">=")>=0){const s=i.replace(">=","");r>=parseFloat(s)&&(f.result=l[i],f.color=d[l[i]])}}),f}static getBMI(a,l,r,d){const f=this.calculateBMI(a,l);return this.getBMIResult(r,d,f)}static calculateBMI(a,l){if(l==0||a==0)return 0;let r=a/l/l*1e4;return r=Math.round(r*10)/10}}class Ua extends ce{constructor(a,l=K()){super(a,Te.DISPENSING,l)}buildDispensations(a,l,r){const d=[];for(let f=0;f<r;f++)d.push({drug_order_id:a,date:this.date,quantity:l/r});return d}saveDispensations(a){return Ve.postJson("/dispensations",{dispensations:a,program_id:this.programID})}}const Ba=x({__name:"PatientVisit",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=B(()=>a.patient.getID()),r=new Zt(l.value),d=new xt(l.value),f=new ka(l.value),i=new Ua(l.value),s=new Ca(l.value),p=new Oa(l.value),V=new Ea(l.value),_=O(),y=O(),N=O([]),b=O([]),A=O([]),D=O([]),h=B(()=>!(_.value&&a.patient.getAge()>18)),w=B(()=>a.patient.isFemale()),C=O(""),$=a.patient.getBirthdate(),R=O(!1),P=ie({}),u=ie({visitDate:{value:Z().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async o=>new Date(o.value)>new Date(K())?["Visit date cannot be after today's date"]:new Date(o.value)<new Date($)?["Visit date cannot be before patient's birth date"]:null},weight:{value:void 0,label:"Weight",required:!0,computedValue:o=>({tag:"vitals",obs:r.buildValueNumber("Weight",o)}),validation:(o,v)=>(z(o)||!o.value)&&v.patientPresent.value==="No"?null:Fe([()=>de(o),()=>ue(o,"DECIMALS"),()=>vt(o,2,250)])},height:{value:void 0,label:"Height",computedValue:o=>({tag:"vitals",obs:r.buildValueNumber("Height",o)}),validation:o=>!h.value||(z(o)||!o.value)&&u.patientPresent.value==="No"?null:Fe([()=>de(o),()=>ue(o),()=>vt(o,20,220)])},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:w.value,computedValue:o=>({tag:"consultation",obs:d.buildValueCoded("Is patient pregnant",o)}),validation:async o=>w.value&&de(o)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:w.value,computedValue:o=>({tag:"consultation",obs:d.buildValueCoded("Is patient breast feeding",o)}),validation:async o=>w.value&&de(o)},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:o=>({tag:"appointment",obs:V.buildValueDate("Appointment date",o)}),validation:async(o,v)=>new Date(o.value)<new Date(v.visitDate.value)?["Appointment date cannot be before visit date"]:new Date(o.value)>new Date(C.value)?["Appointment date cannot be after drug run out date"]:null},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:o=>({tag:"reception",obs:s.buildValueCoded("Patient present",o)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:o=>({tag:"reception",obs:s.buildValueCoded("Guardian present",o)})},pillCount:{value:void 0,label:"Pill Count",required:D.value.length>0,validation:async o=>D.value.length>0&&ue(o)},regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:f.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:f.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:f.buildValueCoded("Medication orders","INH")}),validation:async(o,v)=>{var m,k;return(((m=v.tbMed.value)==null?void 0:m.label)==="6H"||((k=v.tbMed.value)==null?void 0:k.label)==="3HP (RFP + INH)")&&ue(o)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:f.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(o,v)=>{var m;return((m=v.tbMed.value)==null?void 0:m.label)==="3HP (RFP + INH)"&&ue(o)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:f.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(o,v)=>{var m;return((m=v.tbMed.value)==null?void 0:m.label)==="3HP (INH 300 / RFP 300)"&&ue(o)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(o,v)=>{var m;return((m=v.tbMed.value)==null?void 0:m.label)&&ue(o)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async o=>Fe([()=>de(o),()=>o.value==="No"||b.value.some(v=>v.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async o=>Fe([()=>de(o),()=>o.value==="No"||A.value.some(v=>v.isChecked)?null:["Please select at least one side effect"]])},tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:o=>({tag:"consultation",obs:d.buildValueCoded("TB Status",o.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async o=>{if(!R.value){if(new Date(o.value)>new Date(K()))return["TB treatment start date cannot be after today's date"];if(new Date(o.value)<new Date($))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:o=>({tag:"consultation",obs:d.buildValueDate("TB treatment start date",o)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:o=>({tag:"consultation",obs:d.buildValueNumber("TB treatment period",o)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:o=>({tag:"consultation",obs:d.buildGroupValueCoded("TB screening method used","chest xray",o)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:o=>({tag:"consultation",obs:d.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",o)})}}),j=async(o,v)=>{const m={label:"Unkown",value:"Unkown",other:[{drug_id:1046,drug_name:"Unknown ARV",am:1,pm:0,units:"",frequency:"Daily (QOD)"}]},k=(await Ce.getRegimensByWeight(o,v)).data;return z(k)?[m]:Object.keys(k).map(J=>({label:J,value:J,other:k[J]})).concat([m])};ve(()=>u.regimen.value,o=>{var v;Qe(),o&&((v=o==null?void 0:o.other)==null||v.forEach(m=>{var k;P[m.drug_name]={label:"".concat((k=m.alternative_drug_name)!=null?k:m.drug_name," given"),value:0,required:!0,validation:J=>ue(J,"POSITIVE_INTEGERS")}}))}),ve(u.patientPresent,o=>{o.value==="No"?(u.weight.required=!1,u.weight.error="",u.guardianPresent.value="Yes"):u.weight.required=!0}),ve(u.guardianPresent,o=>{o.value==="No"&&(u.patientPresent.value="Yes")}),ve([()=>u.weight.value,()=>u.tbStatus.value],async([o,v])=>{u.regimen.value=void 0,Qe();const m=!z(v)&&!v.label.match(/TB Not Suspected/i);o?(N.value=await j(u.weight.value,m),u.patientPresent.value="Yes",u.patientPresent.disabled=!0):!o&&u.weight.required&&(u.patientPresent.value=void 0,u.patientPresent.disabled=!1),u.tbMed.disabled=m||R.value});const se=()=>{var o,v;return z(P)?1/0:Math.min(...(v=(o=u.regimen.value)==null?void 0:o.other)==null?void 0:v.map(m=>{var k,J,me,ke,$e;return((J=(k=P[m.drug_name])==null?void 0:k.value)!=null?J:0)/(((me=m.am)!=null?me:0)+((ke=m.noon)!=null?ke:0)+(($e=m.pm)!=null?$e:0))||1}))};ve([()=>P,()=>u.pillCount.value,()=>u.visitDate.value],()=>{const o=parseInt(u.pillCount.value)||0,v=se();v!==1/0&&(C.value=f.calculateDrugRunOutDate(v+o,u.visitDate.value),u.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(_e(C.value),")"),u.nextAppointmentDate.value=C.value)},{deep:!0}),ve(()=>u.visitDate.value,()=>lt());const he=B(()=>{var o;return((o=u.tbMed.value)==null?void 0:o.label)==="3HP (INH 300 / RFP 300)"}),G=B(()=>{var o;return((o=u.tbMed.value)==null?void 0:o.label)==="3HP (RFP + INH)"}),S=B(()=>{var o;return((o=u.tbMed.value)==null?void 0:o.label)==="6H"}),Re=B(()=>u.hasContraindications.value==="Yes"),ot=B(()=>u.hasSideEffects.value==="Yes"),Dt=B(()=>{var o;return/Confirmed TB on treatment/i.test((o=u.tbStatus.value)==null?void 0:o.label)}),It=B(()=>{var o;return/Suspected/i.test((o=u.tbStatus.value)==null?void 0:o.label)}),Nt=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Rt=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],At=ze(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),St=ze(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),lt=async()=>{d.setDate(u.visitDate.value),R.value=!1;const o=await d.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(o)){const v=await d.getFirstValueDatetime("TB treatment start date"),m=await d.getFirstValueNumber("TB treatment period")||6;if(v){const k=Z(u.visitDate.value).diff(v,"months");R.value=k<=m}}u.tbStatus.required=!R.value},Pt=async o=>{const v=o.height||_.value,m=$a.calculateBMI(o.weight,v);return r.buildValueNumber("BMI",m)},Tt=async()=>{const o=[await d.buildValueCoded("Patient using family planning","No")];return d.getFamilyPlanningMethods().forEach(async m=>{o.push(await d.buildValueCoded(m,"No"))}),o},Ct=async()=>Promise.all(He.getConceptsByCategory("tb_symptom",!0).map(async o=>d.buildGroupValueCoded(o.name,o.name,"No"))),Ot=async()=>{r.setDate(u.visitDate.value),d.setDate(u.visitDate.value),f.setDate(u.visitDate.value),s.setDate(u.visitDate.value),p.setDate(u.visitDate.value),V.setDate(u.visitDate.value),i.setDate(u.visitDate.value),await Ne(u,async(o,v)=>{var it,rt,st,ut,dt;const m=[];let k=0;if(!z(o.regimen)&&await na(P)){const X=o.regimen.other,Q=oa(P).formData;k=se(),X.forEach(Y=>m.push(f.toDrugOrder(Y,Q[Y.drug_name],k,o.visitDate)))}else if(!await Ie("Are you sure you want to continue without dispensing ART drugs?"))return;if(o.totalCPTGiven&&ft((await Ce.getRegimenExtras("Cotrimoxazole",(it=o.weight)!=null?it:y.value)).data,"concept_name").filter(X=>X.frequency==="Daily (QOD)").forEach(X=>m.push(f.toDrugOrder(X,o.totalCPTGiven,k,o.visitDate))),(rt=o.tbMed)!=null&&rt.value){const X=ft((await Ce.getRegimenExtras("INH",(st=o.weight)!=null?st:y.value)).data,["concept_name","frequency"]),Q=X.find(Y=>Y.concept_name==="Pyridoxine");if(Q&&o.totalPyridoxineGiven&&m.push(f.toDrugOrder(Q,o.totalPyridoxineGiven,k,o.visitDate)),o.totalIPTGiven){const Y=X.find(ye=>ye.concept_name==="Isoniazid"&&(S.value&&ye.frequency==="Daily (QOD)"||G.value&&ye.frequency==="Weekly (QW)"));m.push(f.toDrugOrder(Y,o.totalIPTGiven,k,o.visitDate))}if(o.totalRFPGiven&&G.value){const Y=(await Ce.getRegimenExtras("Rifapentine",(ut=o.weight)!=null?ut:y.value)).data;Y.length&&m.push(f.toDrugOrder(Y[0],o.totalRFPGiven,k,o.visitDate))}if(o.total3HPGiven&&he.value){const Y=(await Ce.getRegimenExtras("INH / RFP",(dt=o.weight)!=null?dt:y.value)).data;m.push(f.toDrugOrder(Y[0],o.total3HPGiven,k,o.visitDate))}}if(!z(m)){await f.createEncounter();const Q=(await f.createDrugOrder(m)).data.map(Y=>{const ye=m.find(kt=>kt.drug_inventory_id===Y.drug_inventory_id);return i.buildDispensations(Y.order_id,ye.qty,1)});await i.saveDispensations(Q.flat(1))}const J=await Be(v,"vitals");if(!z(J)){await r.createEncounter();const X=await Pt(o);await r.saveObservationList([...J,X])}await d.createEncounter();const me=await Be(v,"consultation");me.push(...await d.buildOptionsGroupObs("Malawi ART side effects",b.value)),me.push(...await Ct()),ot.value&&me.push(...await d.buildOptionsGroupObs("Other side effect",A.value)),w.value&&me.push(...await Tt()),await d.saveObservationList(me),await s.createEncounter();const ke=await Be(v,"reception");if(await s.saveObservationList(ke),D.value.length>0){await p.createEncounter();const X=await Promise.all(D.value.map(async Q=>{const Y=p.calculateExpected(Q.quantity,Q.equivalent_daily_dose,Q.order.start_date,Q.frequency),ye=p.calculateAdherence(Q.quantity,o.pillCount,Y);return[await p.buildAdherenceObs(Q.order_id,Q.drug_inventory_id,ye),await p.buildPillCountObs(Q.order_id,o.pillCount)]}));await p.saveObservationList(X.flat(1))}await V.createEncounter();const $e=await Be(v,"appointment");await V.saveObservationList($e),await Oe("Patient visit saved successfully"),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA),q.emit(L.RELOAD_STAGING_INFORMATION)})},Et=async()=>{if(await Ie("Are you sure you want to clear all fields?")){for(const o in u)u[o].value="",u[o].error="",u[o].disabled=!1;Qe(),q.emit(L.ON_CLEAR)}},Qe=()=>{for(const o in P)delete P[o]};return be(async()=>{try{await lt(),_.value=await a.patient.getRecentHeight(),y.value=await a.patient.getRecentWeight(),y.value&&(N.value=await j(y.value)),D.value=(await ht.getLastDrugsReceived(a.patient.getID())).data,u.pillCount.required=D.value.length>0,b.value=He.getConceptsByCategory("contraindication",!0).map(o=>({value:o.concept_id,label:o.name,other:o})),A.value=He.getConceptsByCategory("side_effect",!0).map(o=>({value:o.concept_id,label:o.name,other:o}))}catch(o){at("Form initialization failed. Try to refresh the page"),console.error(o)}}),(o,v)=>(I(),M(W,null,[t(c(Ye),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(We),null,{default:n(()=>[E("Patient Visit")]),_:1})]),_:1})]),_:1}),t(c(je),{class:"ion-padding"},{default:n(()=>[t(c(re),{style:{width:"100%"}},{default:n(()=>[t(c(ae),null,{default:n(()=>[t(c(T),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:u.visitDate,"onUpdate:modelValue":v[0]||(v[0]=m=>u.visitDate=m),form:u,minDate:c($),maxDate:c(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:u.patientPresent,"onUpdate:modelValue":v[1]||(v[1]=m=>u.patientPresent=m),inline:"",disabled:u.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:u.guardianPresent,"onUpdate:modelValue":v[2]||(v[2]=m=>u.guardianPresent=m),inline:""},null,8,["modelValue"])]),_:1}),w.value?(I(),M(W,{key:0},[t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:u.isPregnant,"onUpdate:modelValue":v[3]||(v[3]=m=>u.isPregnant=m),inline:""},null,8,["modelValue"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:u.isBreastfeeding,"onUpdate:modelValue":v[4]||(v[4]=m=>u.isBreastfeeding=m),inline:""},null,8,["modelValue"])]),_:1})],64)):H("",!0),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:u.hasContraindications,"onUpdate:modelValue":v[5]||(v[5]=m=>u.hasContraindications=m),inline:""},null,8,["modelValue"]),Re.value?(I(),U(tt,{key:0,items:b.value,numberOfColumns:2},{default:n(({entries:m})=>[(I(!0),M(W,null,Se(m,k=>(I(),U(c(Le),{lines:"none",key:k.value},{default:n(()=>[t(c(qe),null,{default:n(()=>[E(oe(k.label),1)]),_:2},1024),t(c(xe),{slot:"start",modelValue:k.isChecked,"onUpdate:modelValue":J=>k.isChecked=J},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):H("",!0)]),_:1}),t(c(T),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[t(pe,{modelValue:u.hasSideEffects,"onUpdate:modelValue":v[6]||(v[6]=m=>u.hasSideEffects=m),inline:""},null,8,["modelValue"]),ot.value?(I(),U(tt,{key:0,items:A.value,numberOfColumns:2},{default:n(({entries:m})=>[(I(!0),M(W,null,Se(m,k=>(I(),U(c(Le),{lines:"none",key:k.value},{default:n(()=>[t(c(qe),null,{default:n(()=>[E(oe(k.label),1)]),_:2},1024),t(c(xe),{slot:"start",modelValue:k.isChecked,"onUpdate:modelValue":J=>k.isChecked=J},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):H("",!0)]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.weight,"onUpdate:modelValue":v[7]||(v[7]=m=>u.weight=m),form:u,min:1},null,8,["modelValue","form"])]),_:1}),h.value?(I(),U(c(T),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.height,"onUpdate:modelValue":v[8]||(v[8]=m=>u.height=m),form:u,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),R.value?H("",!0):(I(),U(c(T),{key:2,class:"ion-margin-vertical",size:h.value?"12":"6"},{default:n(()=>[t(le,{modelValue:u.tbStatus,"onUpdate:modelValue":v[9]||(v[9]=m=>u.tbStatus=m),options:c(St)},null,8,["modelValue","options"])]),_:1},8,["size"])),Dt.value?(I(),M(W,{key:3},[t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:u.tbTreatmentStartDate,"onUpdate:modelValue":v[10]||(v[10]=m=>u.tbTreatmentStartDate=m),form:u,minDate:c($),maxDate:c(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.tbTreatmentPeriod,"onUpdate:modelValue":v[11]||(v[11]=m=>u.tbTreatmentPeriod=m),form:u,min:1},null,8,["modelValue","form"])]),_:1})],64)):It.value?(I(),M(W,{key:4},[t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:u.cxrResult,"onUpdate:modelValue":v[12]||(v[12]=m=>u.cxrResult=m),"custom-options":Nt},null,8,["modelValue"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:u.mwrdResult,"onUpdate:modelValue":v[13]||(v[13]=m=>u.mwrdResult=m),"custom-options":Rt},null,8,["modelValue"])]),_:1})],64)):H("",!0),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:u.regimen,"onUpdate:modelValue":v[14]||(v[14]=m=>u.regimen=m),options:N.value},null,8,["modelValue","options"])]),_:1}),c(z)(P)?H("",!0):(I(!0),M(W,{key:5},Se(Object.values(P),(m,k)=>(I(),U(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{"model-value":m,form:P,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.totalCPTGiven,"onUpdate:modelValue":v[15]||(v[15]=m=>u.totalCPTGiven=m),form:u,min:1},null,8,["modelValue","form"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:u.tbMed,"onUpdate:modelValue":v[16]||(v[16]=m=>u.tbMed=m),options:c(At)},null,8,["modelValue","options"])]),_:1}),S.value||G.value?(I(),U(c(T),{key:6,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.totalIPTGiven,"onUpdate:modelValue":v[17]||(v[17]=m=>u.totalIPTGiven=m),form:u,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),G.value?(I(),U(c(T),{key:7,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.totalRFPGiven,"onUpdate:modelValue":v[18]||(v[18]=m=>u.totalRFPGiven=m),form:u,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),he.value?(I(),U(c(T),{key:8,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.total3HPGiven,"onUpdate:modelValue":v[19]||(v[19]=m=>u.total3HPGiven=m),form:u,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),he.value||G.value||S.value?(I(),U(c(T),{key:9,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.totalPyridoxineGiven,"onUpdate:modelValue":v[20]||(v[20]=m=>u.totalPyridoxineGiven=m),form:u,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),D.value.length>0?(I(),U(c(T),{key:10,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.pillCount,"onUpdate:modelValue":v[21]||(v[21]=m=>u.pillCount=m),form:u,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),t(c(T),{size:D.value.length>0?"6":"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:u.nextAppointmentDate,"onUpdate:modelValue":v[22]||(v[22]=m=>u.nextAppointmentDate=m),form:u,minDate:u.visitDate.value,maxDate:C.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1},8,["size"])]),_:1})]),_:1})]),_:1}),t(c(Je),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(te),{color:"primary",onClick:v[23]||(v[23]=m=>c(F).hide()),slot:"end"},{default:n(()=>[E(" Close ")]),_:1}),t(c(te),{color:"warning",onClick:Et,slot:"end"},{default:n(()=>[E(" Reset ")]),_:1}),t(c(te),{color:"success",onClick:Ot,slot:"end"},{default:n(()=>[E(" Save ")]),_:1})]),_:1})]),_:1})],64))}});const Fa=ne(Ba,[["__scopeId","data-v-6a4282f7"]]),Ha=x({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:nt,IonCard:Ht,IonCardHeader:Mt,IonCardTitle:qt,IonCardContent:Lt,IonButton:te},setup(e){const a=O([]),l=B(()=>e.patient.getID()),r=ie({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),d=O([{label:"Add Visit",action:async()=>{await F.show(Fa,{patient:e.patient})}},{label:"Update Outcome",action:async()=>F.show(Sa,{patient:e.patient})},{label:"Enter VL Results",action:async()=>F.show(va,{patient:e.patient})}]),f=b=>{const A=e.startDate!=="N/A"?"("+Z(b).diff(e.startDate,"months")+"M)":"";return"".concat(_e(b)," ").concat(A)},i=O([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To"},{path:"weight",label:"Weight (Kg)"},{path:"height",label:"Height (cm)"},{path:"bmi",label:"BMI"},...e.patient.isFemale()?[{path:"pregnant",label:"Preg"},{path:"breastfeeding",label:"B/F"}]:[],{path:"tbStatus",label:"TB Status"},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:b=>b.length>0?"Yes":"No"},{path:"regimen",label:"ART Regimen",drillable:!0},{path:"nextAppointment",label:"Next Appointment"},{path:"outcome",label:"Outcome"},{path:"vlResult",label:"Viral Load"}]),s=b=>({title:"Side effects noted on ".concat(b.row.visitDate),rows:b.row.sideEffects.map(A=>({sideEffect:A})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),p=b=>({title:"Drugs dispensed on ".concat(b.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:b.row.drugs.map(A=>({name:A[0],quantity:A[1],units:"tab (s)"}))}),V=async b=>{const A=/regimen/i.test(b.column.path)?p(b):s(b);z(A.rows)||await F.show(la,A)},_=[{label:"void",icon:Gt,color:"danger",action(b,A){Vt(async D=>{var w;const h=await pt.getEncounters(l.value,{date:b.date});h.ok?((w=h.data)==null||w.forEach(async C=>{await pt.voidEncounter(C.encounter_id,D)}),a.value.splice(A,1)):at(h.errorMessage||"Failed to void encounters")},"small-modal")}}],y=async b=>b.tb_status.match(/Unknown/i)||b.outcome==="Defaulted"?"":He.getCachedConceptName(b.tb_status),N=()=>{Ge.getPatientVisits(l.value,!0).then(async b=>{a.value=[];for(const A of b){const D=(await yt.getCurrentProgramInformation(l.value,A)).data;let h="",w="",C="",$="";if(D.outcome!=="Defaulted"){const R=await Ue.getFirstValueDatetime(l.value,"appointment date",A);if(R&&(h=_e(R)),w=await Ue.getFirstValueCoded(l.value,"Is patient pregnant",A),C=await Ue.getFirstValueCoded(l.value,"Is patient breast feeding",A),D.viral_load==="N/A"){const P=await Ue.getFirstObs(l.value,"HIV viral load",A);P&&P.value_text&&P.value_numeric&&($=P.value_numeric===1?"LDL":P.value_text+P.value_numeric.toString())}else $=D.viral_load}D&&a.value.push({visitDate:f(A),visitBy:D.visit_by.match(/Unk/i)?"":D.visit_by,weight:D.outcome==="Defaulted"?"":D.weight,height:D.outcome==="Defaulted"?"":D.height,bmi:D.outcome==="Defaulted"?"":D.bmi,pregnant:w,breastfeeding:C,tbStatus:await y(D),sideEffects:D.outcome==="Defaulted"?"":D.side_effects,regimen:D.outcome==="Defaulted"?"":D.regimen,nextAppointment:h,outcome:D.outcome.match(/Unk/i)?"":D.outcome,vlResult:$,drugs:D.pills_dispensed,date:A})}})};return q.on(L.RELOAD_PATIENT_VISIT_DATA,()=>N()),be(()=>{N()}),{actionButtons:d,tableConfig:r,rowButtons:_,columns:i,rows:a,onDrilldownHandler:V}}});const Ma=e=>(zt("data-v-c585a8e7"),e=e(),Wt(),e),qa=Ma(()=>fe("span",{class:"title"},"Summary of Visits",-1)),La={class:"ion-float-right ion-margin-end ion-margin-bottom"};function Ga(e,a,l,r,d,f){const i=g("ion-icon"),s=g("ion-button"),p=g("ion-card-title"),V=g("ion-card-header"),_=g("data-table"),y=g("ion-card-content"),N=g("ion-card");return I(),U(N,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[t(V,null,{default:n(()=>[t(p,null,{default:n(()=>[qa,fe("span",La,[(I(!0),M(W,null,Se(e.actionButtons,b=>(I(),U(s,{key:b.label,onClick:b.action,color:b.color||"primary"},{default:n(()=>[b.icon?(I(),U(i,{key:0,icon:b.icon,class:"ion-margin-right"},null,8,["icon"])):H("",!0),E(" "+oe(b.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),t(y,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[t(_,{rows:e.rows,columns:e.columns,"row-actions-buttons":e.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:e.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const za=ne(Ha,[["render",Ga],["__scopeId","data-v-c585a8e7"]]),Wa=x({__name:"ViralLoadTrail",props:{patient:{}},setup(e){const a=e,l=B(()=>"Viral Load Results Trail for ".concat(a.patient.getFullName())),r=O([]),d=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:_e},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:_e}],f={label:"X",color:"danger",action({encounter_id:i}){Vt(async s=>{try{await Yt.void(i,s),F.hide(),q.emit(L.RELOAD_LATEST_VL_RESULT),q.emit(L.RELOAD_PATIENT_VISIT_DATA)}catch(p){console.error(p)}},"small-modal custom-modal-backdrop")}};return be(async()=>{r.value=await we.getViralLoadResultTrail(a.patient.getID())}),(i,s)=>(I(),M(W,null,[t(c(Ye),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(We),null,{default:n(()=>[E(oe(l.value),1)]),_:1})]),_:1})]),_:1}),t(c(je),null,{default:n(()=>[t(c(re),{style:{width:"100%"}},{default:n(()=>[t(c(ae),{style:bt([{padding:"0 !important"},{minHeight:r.value.length?"0":"30vh"}])},{default:n(()=>[t(c(T),{size:"12",class:"ion-no-padding"},{default:n(()=>[t(c(nt),{rows:r.value,columns:d,"row-actions-buttons":[f],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),t(c(Je),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(te),{color:"primary",onClick:s[0]||(s[0]=p=>c(F).hide()),slot:"end"},{default:n(()=>[E(" Close ")]),_:1})]),_:1})]),_:1})],64))}}),Ya=x({components:{MultiColumnView:tt,IonList:jt,IonItem:Le},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(e,{emit:a}){const l=O(0),r=O(0),d=O(0),f=O(""),i=O(""),s=O(""),p=O(""),V=O(""),_=O(""),y=O(""),N=O(""),b=O(""),A=O(""),D=O(""),h=S=>S.other&&typeof S.other.onClickHandler=="function",w=B(()=>!z(e.guardians)),C=async S=>{var Re;h(S)&&await((Re=S.other)==null?void 0:Re.onClickHandler())},$=()=>{const S=e.patient.getBirthdate(),Re=e.artStartDate!=="N/A"?Z(e.artStartDate).diff(S,"years"):"";return"".concat(_e(S)," (").concat(Re,")")},R=()=>{we.getlatestViralLoadResult(e.patient.getID()).then(S=>A.value=S)},P=()=>({onClickHandler(){Jt.push("/patient/reception/".concat(e.patient.getID(),"/false"))}}),u=()=>w.value?e.guardians.map(S=>"".concat(S.name," (").concat(S.relationshipType,")")).join(","):"Add",j=()=>({onClickHandler:()=>a("updatePatient")}),se=B(()=>[{label:"ARV Number",value:e.patient.getArvNumber(),other:{onClickHandler:()=>a("updateARVNumber")}},{label:"MW National ID",value:e.patient.getMWNationalID(),other:j()},{label:"Name",value:e.patient.getGivenName()+" "+e.patient.getFamilyName(),other:j()},{label:"DOB and Age at Initiation",value:$(),other:j()},{label:"Sex",value:ca(e.patient.getGender()),other:j()},{label:"Location",value:e.patient.getCurrentVillage(),other:j()},{label:"Landmark",value:e.patient.getClosestLandmark(),other:j()},{label:"Phone Number",value:e.patient.getPhoneNumber(),other:j()},{label:"Guardian",value:u(),other:{onClickHandler:()=>a("updateGuardian")}},{label:"Agrees to follow up",value:V.value,other:P()},{label:"Date of starting first line ARV Regimen",value:e.artStartDate,other:P()},{label:"Initial Weight (KG)",value:l.value,other:P()},{label:"Initial Height (CM)",value:r.value,other:P()},{label:"Initial BMI",value:d.value,other:P()},{label:"Initial TB Status",value:f.value,other:P()},{label:"Pregnant at Initiation",value:s.value,other:P()},{label:"Breastfeeding at Initiation",value:i.value,other:P()},{label:"Latest VL Result and Result Date",value:A.value,other:{onClickHandler:()=>F.show(Wa,{patient:e.patient})}},{label:"TI",value:p.value,other:P()},{label:"HIV test place",value:N.value,other:P()},{label:"HIV test date",value:y.value,other:P()},{label:"WHO stage",value:D.value,other:P()},{label:"Reason for starting ART",value:_.value,other:P()},{label:"Staging codition",value:b.value,other:P()}]),he=async()=>{const S=await e.patient.getHIVTestDate();S&&(y.value=_e(S))},G=()=>{e.patient.getInitialWeight().then(S=>l.value=S),e.patient.getInitialHeight().then(S=>r.value=S),e.patient.getInitialBMI().then(S=>d.value=S),e.patient.getInitialTBStatus().then(S=>f.value=S),e.patient.hasPregnancyAtARTInitiation().then(S=>s.value=S),e.patient.breastFeedingAtARTInitiation().then(S=>i.value=S),e.patient.everReceivedART().then(S=>p.value=S),e.patient.agreesToFollowUp().then(S=>V.value=S),e.patient.getReasonForStartingART().then(S=>_.value=S),e.patient.getHIVTestLocation().then(S=>N.value=S),e.patient.getStagingCondition().then(S=>b.value=S),e.patient.getWhoStage().then(S=>D.value=S),he()};return be(()=>{G(),R(),q.on(L.RELOAD_LATEST_VL_RESULT,()=>R()),q.on(L.RELOAD_STAGING_INFORMATION,()=>G())}),{patientInfo:se,onClickHandler:C,clickable:h}}});const ja={style:{width:"100%",display:"flex",justifyContent:"space-between"}},Ja={key:0},Qa={key:1},Ka={key:2},Xa={key:3};function Za(e,a,l,r,d,f){const i=g("ion-item"),s=g("ion-list"),p=g("multi-column-view");return I(),U(p,{items:e.patientInfo,numberOfColumns:3},{default:n(({entries:V})=>[t(s,{class:"his-card ion-margin-end"},{default:n(()=>[(I(!0),M(W,null,Se(V,(_,y)=>(I(),U(i,{key:y,lines:y===V.length-1?"none":void 0,button:e.clickable(_),onClick:N=>e.onClickHandler(_)},{default:n(()=>[fe("div",ja,[_.label?(I(),M("span",Ja,oe(_.label)+": ",1)):(I(),M("span",Qa)),e.clickable(_)?(I(),M("span",Ka,[fe("a",null,[fe("b",null,oe(_.value||"N/A"),1)])])):(I(),M("span",Xa,[fe("b",null,oe(_.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const xa=ne(Ya,[["render",Za],["__scopeId","data-v-5306de30"]]),en=x({components:{IonGrid:re,IonRow:ae,IonCol:T,TextInput:Pe,DateInput:ge,SelectInput:le},props:{patientService:{type:Object,required:!0}},setup(e){const a=O(!1),l=B(()=>/Unknown/i.test(e.patientService.getMWNationalID())?"":e.patientService.getMWNationalID()),r=ie({givenName:{label:"First Name",value:e.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:i=>Ee(i)},familyName:{label:"last Name",value:e.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:i=>Ee(i)},middleName:{label:"middle Name",value:e.patientService.getMiddleName(),placeholder:"middle Name",validation:i=>!!i&&Ee(i)},nationalId:{label:"Malawi National ID Number",value:l.value,placeholder:"Enter Malawi National ID Number",validation:i=>i&&i.label?ua(i):null},gender:{value:e.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:e.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:e.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async i=>!(i.value==="Unknown"||i.value==="N/A")&&wt(i)},homeVillage:{value:e.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:e.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),d=async i=>{var V,_,y,N,b;let s,p;try{(V=i==null?void 0:i.other)!=null&&V.traditional_authority_id&&(s=await mt.getTraditionalAuthorityById(i.other.traditional_authority_id)),s&&(p=await mt.getDistrictByID(s.district_id))}catch(A){at("Unable to resolve patient address. Saving using default address"),console.error(A)}return{home_district:(_=p==null?void 0:p.name)!=null?_:"N/A",home_traditional_authority:(y=s==null?void 0:s.name)!=null?y:"N/A",home_village:(i==null?void 0:i.label)||"N/A",current_district:(N=p==null?void 0:p.name)!=null?N:"N/A",current_traditional_authority:(b=s==null?void 0:s.name)!=null?b:"N/A",current_village:(i==null?void 0:i.label)||"N/A"}};return{today:K,patient:r,getLandmarks:ra,genderOptions:aa,isBirthdateEstimated:a,modal:F,onFinish:async()=>Ne(r,async i=>{const s={};if(i.givenName!==e.patientService.getGivenName()&&(s.given_name=i.givenName),i.familyName!==e.patientService.getFamilyName()&&(s.family_name=i.familyName),i.middleName!==e.patientService.getMiddleName()&&(s.middle_name=i.middleName),i.birthdate!==e.patientService.getBirthdate()&&(s.birthdate=i.birthdate),i.gender.value!==e.patientService.getGender()&&(s.gender=i.gender.value),i.cellPhoneNumber!==e.patientService.getPhoneNumber()&&(s.cell_phone_number=i.cellPhoneNumber),i.landmark.label!==e.patientService.getClosestLandmark()&&(s.landmark=i.landmark.label),i.homeVillage!==e.patientService.getCurrentVillage()&&Object.assign(s,{...s,...await d(i.homeVillage)}),!z(s)){const p=new et;p.setPersonID(e.patientService.getID()),await p.updatePerson(s)}i.nationalId!==l.value&&await e.patientService.updateMWNationalId(i.nationalId),await F.hide(),q.emit(L.RELOAD_PATIENT_DATA)}),getVillagesByName:sa}}});function tn(e,a,l,r,d,f){const i=g("ion-title"),s=g("ion-icon"),p=g("ion-button"),V=g("ion-buttons"),_=g("ion-toolbar"),y=g("ion-header"),N=g("TextInput"),b=g("ion-col"),A=g("SelectInput"),D=g("DateInput"),h=g("ion-row"),w=g("ion-grid"),C=g("ion-content"),$=g("ion-footer");return I(),M(W,null,[t(y,null,{default:n(()=>[t(_,null,{default:n(()=>[t(i,null,{default:n(()=>[E("Edit Patient Demographics")]),_:1}),t(V,{slot:"end"},{default:n(()=>[t(p,{onClick:a[0]||(a[0]=R=>e.modal.hide())},{default:n(()=>[t(s,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(C,{class:"ion-padding"},{default:n(()=>[t(w,null,{default:n(()=>[t(h,null,{default:n(()=>[t(b,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.givenName,"onUpdate:modelValue":a[1]||(a[1]=R=>e.patient.givenName=R)},null,8,["modelValue"])]),_:1}),t(b,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.middleName,"onUpdate:modelValue":a[2]||(a[2]=R=>e.patient.middleName=R)},null,8,["modelValue"])]),_:1}),t(b,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.familyName,"onUpdate:modelValue":a[3]||(a[3]=R=>e.patient.familyName=R)},null,8,["modelValue"])]),_:1}),t(b,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.nationalId,"onUpdate:modelValue":a[4]||(a[4]=R=>e.patient.nationalId=R)},null,8,["modelValue"])]),_:1}),t(b,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(A,{modelValue:e.patient.gender,"onUpdate:modelValue":a[5]||(a[5]=R=>e.patient.gender=R),options:e.genderOptions},null,8,["modelValue","options"])]),_:1}),t(b,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(D,{modelValue:e.patient.birthdate,"onUpdate:modelValue":a[6]||(a[6]=R=>e.patient.birthdate=R),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:e.today,onIsEstimated:a[7]||(a[7]=R=>e.isBirthdateEstimated=R)},null,8,["modelValue","maxDate"])]),_:1}),t(b,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.cellPhoneNumber,"onUpdate:modelValue":a[8]||(a[8]=R=>e.patient.cellPhoneNumber=R),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(b,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(A,{modelValue:e.patient.homeVillage,"onUpdate:modelValue":a[9]||(a[9]=R=>e.patient.homeVillage=R),asyncOptions:e.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),t(b,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(A,{modelValue:e.patient.landmark,"onUpdate:modelValue":a[10]||(a[10]=R=>e.patient.landmark=R),asyncOptions:e.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),t($,null,{default:n(()=>[t(_,null,{default:n(()=>[t(p,{color:"primary",onClick:a[11]||(a[11]=R=>e.modal.hide()),slot:"end"},{default:n(()=>[E("Close")]),_:1}),t(p,{class:"ion-margin-end",color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[E("Save")]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const an=ne(en,[["render",tn]]),nn=x({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(e){var A,D;const a=new et,l=e,r=O(z(l.guardians)),d=B(()=>"".concat(r.value?"Add":"Edit"," Guardian Demographics")),f=B(()=>"".concat(r.value?"Edit":"Add"," Guardian")),i=O([]),s=(D=(A=l.guardians)==null?void 0:A.map(h=>({label:"".concat(h.name," (").concat(h.relationshipType,")"),value:h.name,other:h})))!=null?D:[],p=ie({label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}),V=ie({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:h=>Ee(h)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:h=>Ee(h)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async h=>h.value!=="Unknown"&&wt(h)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});ve(()=>p.value,h=>{var w,C,$,R,P,u,j,se;V.givenName.value=(C=(w=h==null?void 0:h.other)==null?void 0:w.names.given_name)!=null?C:"",V.familyName.value=(R=($=h==null?void 0:h.other)==null?void 0:$.names.family_name)!=null?R:"",V.cellPhoneNumber.value=(u=(P=h==null?void 0:h.other)==null?void 0:P.phoneNumber)!=null?u:"",V.relation.value=(se=(j=h==null?void 0:h.other)==null?void 0:j.relationshipType)!=null?se:""},{deep:!0,immediate:!0});function _(){r.value=!r.value,p.value=""}async function y(h){var w,C;await a.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:l.patientId,...h}),await Xe.createRelation(l.patientId,a.getPersonID(),(C=(w=h.relation)==null?void 0:w.value)!=null?C:13)}async function N(h,w){var R,P;const C=w.names.person_id,$={};if(w.names.given_name!==h.given_name&&($.given_name=h.given_name),w.names.family_name!==h.family_name&&($.family_name=h.family_name),w.phoneNumber!==h.cell_phone_number&&($.cell_phone_number=h.cell_phone_number),!z($)){const u=new et;u.setPersonID(C),await u.updatePerson($)}w.relationshipType!==h.relation.label&&await Xe.amendRelation(l.patientId,C,w.id,(P=(R=h.relation)==null?void 0:R.value)!=null?P:13)}const b=async()=>Ne(V,async h=>{!r.value&&!z(p.value)?await N(h,p.value.other):await y(h),await F.hide(),q.emit(L.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return be(async()=>{const h=(await Xe.getRelations()).data;i.value=h.map(w=>({label:w.b_is_to_a,value:w.relationship_type_id,other:w}))}),(h,w)=>{const C=g("ion-title"),$=g("ion-icon"),R=g("ion-button"),P=g("ion-buttons"),u=g("ion-toolbar"),j=g("ion-header"),se=g("ion-content"),he=g("ion-footer");return I(),M(W,null,[t(j,null,{default:n(()=>[t(u,null,{default:n(()=>[t(C,null,{default:n(()=>[E(oe(d.value),1)]),_:1}),t(P,{slot:"end"},{default:n(()=>[t(R,{onClick:w[0]||(w[0]=G=>c(F).hide())},{default:n(()=>[t($,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(se,{class:"ion-padding"},{default:n(()=>[t(c(re),null,{default:n(()=>[t(c(ae),null,{default:n(()=>[r.value?H("",!0):(I(),U(c(T),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(le,{modelValue:p,"onUpdate:modelValue":w[1]||(w[1]=G=>p=G),options:c(s)},null,8,["modelValue","options"])]),_:1})),p.value||r.value?(I(),M(W,{key:1},[t(c(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Pe,{modelValue:V.givenName,"onUpdate:modelValue":w[2]||(w[2]=G=>V.givenName=G)},null,8,["modelValue"])]),_:1}),t(c(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Pe,{modelValue:V.familyName,"onUpdate:modelValue":w[3]||(w[3]=G=>V.familyName=G)},null,8,["modelValue"])]),_:1}),t(c(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Pe,{modelValue:V.cellPhoneNumber,"onUpdate:modelValue":w[4]||(w[4]=G=>V.cellPhoneNumber=G),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(c(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(le,{modelValue:V.relation,"onUpdate:modelValue":w[5]||(w[5]=G=>V.relation=G),options:i.value},null,8,["modelValue","options"])]),_:1})],64)):H("",!0)]),_:1})]),_:1})]),_:1}),t(he,null,{default:n(()=>[t(u,null,{default:n(()=>[c(z)(l.guardians)?H("",!0):(I(),U(R,{key:0,color:"primary",onClick:_,slot:"start"},{default:n(()=>[E(oe(f.value),1)]),_:1})),t(R,{color:"primary",onClick:w[6]||(w[6]=G=>c(F).hide()),slot:"end"},{default:n(()=>[E("Close")]),_:1}),t(R,{class:"ion-margin-end",color:"success",onClick:b,slot:"end"},{default:n(()=>[E("Save")]),_:1})]),_:1})]),_:1})],64)}}}),on=x({components:{IonGrid:re,IonRow:ae,IonCol:T,TextInput:Pe},props:{patient:{type:Object,required:!0}},setup(e){const{facility:a}=_t(),l=B(()=>e.patient.getArvNumber()),r=B(()=>!z(l.value)&&l.value!=="Unknown"),d=ie({arvNumber:{value:r.value?l.value.split("-")[2]:"",label:"".concat(r.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async s=>{const p=ue(s,"POSITIVE_INTEGERS");if(p!==null)return p;if(s.value===l.value.split("-")[2])return null;const V=await Ge.findByOtherID(4,"".concat(a.code,"-ARV-").concat(s.value));return V.ok?z(V.data)?null:["ARV Number already taken"]:[V.errorMessage||V.clientErrorType||"Unable to determine ARV number with status: ".concat(V.httpStatusResponse)]}}});return{form:d,modal:F,arvNumber:l,facility:a,hasValidARVNumber:r,onFinish:async()=>Ne(d,async s=>{s.arvNumber!==l.value.split("-")[2]&&(r.value?await e.patient.updateARVNumber("".concat(a.code,"-ARV-").concat(s.arvNumber)):await e.patient.createArvNumber("".concat(a.code,"-ARV-").concat(s.arvNumber)),q.emit(L.RELOAD_PATIENT_DATA)),await F.hide()}),voidARV:async()=>{if(await Ie("Are you sure you want to void this ARV Number ".concat(l.value,"?"))){await Ze.show("Voiding ARV Number...");try{await yt.voidARVNumber(l.value),await Ze.hide(),await F.hide(),q.emit(L.RELOAD_PATIENT_DATA)}catch(p){await Ze.hide(),console.log(p)}}}}}});function ln(e,a,l,r,d,f){const i=g("ion-title"),s=g("ion-icon"),p=g("ion-button"),V=g("ion-buttons"),_=g("ion-toolbar"),y=g("ion-header"),N=g("text-input"),b=g("ion-col"),A=g("ion-row"),D=g("ion-grid"),h=g("ion-content"),w=g("ion-footer");return I(),M(W,null,[t(y,null,{default:n(()=>[t(_,null,{default:n(()=>[t(i,null,{default:n(()=>[E("ARV NUMBER")]),_:1}),t(V,{slot:"end"},{default:n(()=>[t(p,{onClick:a[0]||(a[0]=C=>e.modal.hide())},{default:n(()=>[t(s,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(h,{class:"ion-padding"},{default:n(()=>[t(D,null,{default:n(()=>[t(A,null,{default:n(()=>[t(b,null,{default:n(()=>[t(N,{modelValue:e.form.arvNumber,"onUpdate:modelValue":a[1]||(a[1]=C=>e.form.arvNumber=C),form:e.form,prefix:"".concat(e.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),t(w,{class:"ion-padding-horizontal"},{default:n(()=>[t(_,null,{default:n(()=>[t(p,{color:"primary",onClick:a[2]||(a[2]=C=>e.modal.hide()),slot:"end"},{default:n(()=>[E("Close")]),_:1}),e.hasValidARVNumber?(I(),U(p,{key:0,color:"danger",onClick:e.voidARV,slot:"start"},{default:n(()=>[E("Void ARV Number")]),_:1},8,["onClick"])):H("",!0),t(p,{color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[E("Save")]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const rn=ne(on,[["render",ln]]),sn=x({components:{VisitsSummary:za,InformationHeader:xa},setup(){const e=Qt(),a=parseInt(e.params.patientId.toString())||0,l=O(),r=O(""),d=O([]),f=B(()=>!z(l.value)),i=async()=>{if(a){const y=(await Ge.findByID(a)).data;y&&(l.value=new Ge(y))}},s=async()=>{d.value=await pa.getGuardianDetails(a)},p=async y=>{await F.show(an,{patientService:l.value,attribute:y})},V=async()=>{await F.show(nn,{patientId:a,guardians:d.value})},_=async()=>{await F.show(rn,{patient:l.value})};return q.on(L.RELOAD_PATIENT_DATA,async()=>{await i()}),q.on(L.RELOAD_GUARDIAN_DATA,async()=>{await s()}),be(async()=>{var N;await i();const y=await((N=l.value)==null?void 0:N.getARTStartDate());r.value=y?gt.toStandardHisDisplayFormat(y):"N/A",await s()}),{patient:l,artStartDate:r,guardians:d,isReady:f,updateDemographics:p,updateGuardian:V,updateARVNumber:_}}});function un(e,a,l,r,d,f){const i=g("information-header"),s=g("ion-col"),p=g("ion-row"),V=g("visits-summary"),_=g("ion-grid");return e.isReady?(I(),U(_,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[t(p,null,{default:n(()=>[t(s,{size:"12"},{default:n(()=>[e.patient?(I(),U(i,{key:0,patient:e.patient,guardians:e.guardians,artStartDate:e.artStartDate,onUpdateARVNumber:e.updateARVNumber,onUpdateGuardian:e.updateGuardian,onUpdatePatient:e.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):H("",!0)]),_:1})]),_:1}),t(p,null,{default:n(()=>[t(s,null,{default:n(()=>[e.patient?(I(),U(V,{key:0,patient:e.patient,startDate:e.artStartDate},null,8,["patient","startDate"])):H("",!0)]),_:1})]),_:1})]),_:1})):H("",!0)}const qn=ne(sn,[["render",un]]);export{qn as default};
