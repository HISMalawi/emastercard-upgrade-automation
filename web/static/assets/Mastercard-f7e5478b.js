var $t=Object.defineProperty;var Ut=(e,t,l)=>t in e?$t(e,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[t]=l;var mt=(e,t,l)=>(Ut(e,typeof t!="symbol"?t+"":t,l),l);import{D as qe,H as gt}from"./Date-c5ff4f23.js";import{E as Ve,D as bt,d as x,r as O,ac as ie,a4 as ve,a0 as _e,c as M,e as a,w as n,u as m,H as z,o as I,n as De,Z as Ye,b as k,Q as je,h as re,i as ae,j as T,G as Le,p as Ge,ap as xe,A as Je,I as te,m as Qe,ag as Ie,F as B,J as _,a as fe,g as U,v as H,ar as Bt,t as oe,as as _t,L as Se,at as Ft,a3 as Ht,au as Mt,k as qt,a2 as Lt,av as Gt,aw as zt,S as Wt,ad as Yt,aq as ct,ax as jt}from"./index-b34da4cb.js";import{g as Jt,D as yt,C as Me,P as ze,O as Be}from"./patient_service-8bb3b4cd.js";import{g as Ke,i as W}from"./common-abc2f84d.js";import{A as me,P as Qt,V as Xt,C as Kt,E as pt}from"./consultation_service-16c2da75.js";import{P as ht}from"./program_service-4e650002.js";import{p as Vt}from"./VoidReason-d5ec44a3.js";import{a as X,t as be,d as Z,c as Zt}from"./his_date-3774cb27.js";import{_ as ge}from"./DateInput.vue_vue_type_style_index_0_lang-7008110a.js";import{S as le}from"./SelectInput-3966d61d.js";import{N as ee,R as Ce}from"./regimen_service-41e85ed5.js";import{t as We,a as xt,g as ea}from"./DTFormElements-a1199b88.js";import{e as Te}from"./encounter_types-ae359711.js";import{s as Ne,i as ta,r as aa,a as Fe}from"./form-4b6e0e9a.js";import{E as q,a as L}from"./emc_event-4721851b.js";import{m as F,D as na}from"./DrilldownTable-7a34763e.js";import{a as Oe,t as at}from"./toasts-5a6b8805.js";import{D as nt}from"./index-07ada3e1.js";import{_ as ne}from"./_plugin-vue_export-helper-c27b6911.js";import{T as Pe}from"./TextInput-6d943a31.js";import{g as oa,a as la,b as ia}from"./location_options-964b1669.js";import{r as de,v as He,d as ue,e as vt,a as Ee,b as ra,c as wt}from"./validations-b9fbcec4.js";import{Y as pe}from"./YesNoInput-46748994.js";import{c as sa,u as ft}from"./arrays-31d2d38b.js";import{l as ke}from"./loader-d835876b.js";import{t as ua}from"./Strs-7ee8a435.js";import{P as et,R as Ze}from"./relations_service-500d6be8.js";import"./patient_identifier_service-5ba3bc09.js";import"./index-95d3a767.js";import"./vue-datepicker-bce64927.js";const da=e=>{const t=e.given_name,l=e.family_name,u=e.middle_name?e.middle_name:"";return"".concat(t," ").concat(u," ").concat(l)};class ma{static getRelationships(t){return Ve.getJson("/people/".concat(t,"/relationships")).then(l=>l.data)}static async getGuardianDetails(t){return await this.getRelationships(t).then(l=>l.map(u=>{const d=Ke(u,"relation.names[0]");return{id:u.relationship_id,name:d?da(d):"",relationshipType:Ke(u,"type.b_is_to_a",""),phoneNumber:Jt(Ke(u,"relation.person_attributes",[]),12),names:d}}))}}const Ae=class Ae extends me{constructor(t){super(t,Te.LAB_ORDERS,X())}async loadConcepts(){Ae.conceptID=await me.getConceptID("HIV Viral Load")}createLabOrder(t,l){const u=Ve.getUsername(),d=bt().facility.name,b=me.getCachedConceptID(l,!0);return Ve.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:u,target_lab:d,reason_for_test_id:b,encounter_id:this.encounterID,tests:[{concept_id:Ae.conceptID}],date:this.date,specimen:{concept_id:t}}]})}createLabResult(t,l,u,d="numeric"){return Ve.postJson("lab/tests/".concat(t,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Ae.conceptID},value:l,value_modifier:u,value_type:d}]})}static getSpecimens(t){return Ve.getJson("/lab/specimen_types",{test_type:t})}static async getOrders(t,l={}){var d;return(d=(await Ve.getJson("/lab/orders",{patient_id:t,...l})).data)!=null?d:[]}static async getViralLoadResultTrail(t,l={}){return(await this.getOrders(t,l)).reduce((d,b)=>(b.tests.forEach(i=>i.result.forEach(s=>d.push({...b,test:i.name,result:"".concat(s.value_modifier," ").concat(s.value),result_date:s.date}))),d),[])}static async getlatestViralLoadResult(t,l={}){const d=(await this.getOrders(t,l)).reduce((b,i)=>(b.push(...i.tests.flatMap(s=>s.result)),b),[]).sort((b,i)=>new Date(b.date)>new Date(i.date)?-1:1);return d&&d.length>0?"".concat(d[0].value_modifier).concat(d[0].value," (").concat(be(d[0].date),")"):"N/A"}};mt(Ae,"conceptID",-1);let we=Ae;const ca=x({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(e){const t=e,l=O(!1),u=We(["=",">","<",">=","<="]),d=We(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),b=O([]),i=t.patient.getBirthdate(),s=ie({orderDate:{value:"",label:"Order Date",required:!0,validation:async y=>Z(y.value).isValid()?new Date(y.value)>new Date(X())?["Order date cannot be in the future"]:new Date(y.value)<new Date(i)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(y,g)=>Z(y.value).isValid()?new Date(y.value)>new Date(X())?["Result date cannot be in the future"]:new Date(y.value)<new Date(g.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function v(){Ne(s,async y=>{const g=new we(t.patient.getID());if(await g.loadConcepts(),g.setDate(y.orderDate),!await g.createEncounter())throw new Error("Unable to create lab order encounter");const w=await g.createLabOrder(y.specimen.value,y.reason.value);if(!w.ok||!w.data)throw new Error("Unable to save lab orders");const R=new we(t.patient.getID());if(R.setDate(y.resultDate),!await R.createEncounter())throw new Error("Unable to create lab result encounter");const f=l.value?"LDL":parseInt(y.result),h=l.value?"=":y.modifier.value,P=l.value?"text":"numeric",$=w.data[0].tests[0].id;await R.createLabResult($,f,h,P),await F.hide(),q.emit(L.RELOAD_LATEST_VL_RESULT),q.emit(L.RELOAD_PATIENT_VISIT_DATA)})}async function V(){if(await Ie("Are you sure you want to clear all fields?")){l.value=!1;for(const y in s)s[y].value="",s[y].error="";q.emit(L.ON_CLEAR)}}return ve(l,y=>{y&&(s.modifier.value="",s.result.value=void 0,s.modifier.error="",s.result.error=""),s.modifier.disabled=y,s.modifier.required=!y,s.result.disabled=y,s.result.required=!y}),_e(async()=>{b.value=(await we.getSpecimens("HIV viral load")).data.map(y=>({label:y.name,value:y.concept_id}))}),(y,g)=>(I(),M(z,null,[a(m(je),null,{default:n(()=>[a(m(De),null,{default:n(()=>[a(m(Ye),null,{default:n(()=>g[8]||(g[8]=[k("Viral Load Results")])),_:1})]),_:1})]),_:1}),a(m(Je),{class:"ion-padding"},{default:n(()=>[a(m(re),{style:{width:"100%"}},{default:n(()=>[a(m(ae),null,{default:n(()=>[a(m(T),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[a(ge,{modelValue:s.orderDate,"onUpdate:modelValue":g[0]||(g[0]=N=>s.orderDate=N),form:s,minDate:m(i),maxDate:m(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(le,{modelValue:s.reason,"onUpdate:modelValue":g[1]||(g[1]=N=>s.reason=N),options:m(d)},null,8,["modelValue","options"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(le,{modelValue:s.specimen,"onUpdate:modelValue":g[2]||(g[2]=N=>s.specimen=N),options:b.value},null,8,["modelValue","options"])]),_:1}),a(m(T),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[a(ge,{modelValue:s.resultDate,"onUpdate:modelValue":g[3]||(g[3]=N=>s.resultDate=N),form:s,minDate:s.orderDate.value,"max-date":m(X)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(le,{modelValue:s.modifier,"onUpdate:modelValue":g[4]||(g[4]=N=>s.modifier=N),options:m(u)},null,8,["modelValue","options"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:s.result,"onUpdate:modelValue":g[5]||(g[5]=N=>s.result=N),form:s,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),a(m(ae),{class:"ion-margin-top"},{default:n(()=>[a(m(T),{size:"12"},{default:n(()=>[a(m(Le),{class:"ion-padding-vertical bold"},{default:n(()=>g[9]||(g[9]=[k(" Other Results Options: ")])),_:1}),a(m(Ge),null,{default:n(()=>[a(m(Le),null,{default:n(()=>g[10]||(g[10]=[k("LDL")])),_:1}),a(m(xe),{slot:"start",modelValue:l.value,"onUpdate:modelValue":g[6]||(g[6]=N=>l.value=N)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(m(Qe),null,{default:n(()=>[a(m(De),null,{default:n(()=>[a(m(te),{color:"primary",onClick:g[7]||(g[7]=N=>m(F).hide()),slot:"end"},{default:n(()=>g[11]||(g[11]=[k(" Close ")])),_:1}),a(m(te),{color:"warning",onClick:V,slot:"end"},{default:n(()=>g[12]||(g[12]=[k(" Reset ")])),_:1}),a(m(te),{color:"success",onClick:v,slot:"end"},{default:n(()=>g[13]||(g[13]=[k(" Save ")])),_:1})]),_:1})]),_:1})],64))}}),pa=x({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:nt},emits:["voidOutcome"],setup(e,{emit:t}){const l=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:i=>Z(i).format(qe)},{path:"end_date",label:"End Date",formatter:i=>Z(i).format(qe)}],u={showSearchField:!1,showSubmitButton:!1};return{rows:B(()=>e.patientStates.map((i,s)=>({...i,index:s}))),columns:l,tableConfig:u,TableRowActions:[{label:"void",color:"danger",action:async i=>{await Ie("Are you sure you want to void this outcome?")&&t("voidOutcome",{stateId:i.patient_state_id,index:i.index})}}]}}});function va(e,t,l,u,d,b){const i=_("data-table");return I(),M(z,null,[t[0]||(t[0]=fe("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1)),a(i,{rows:e.rows,columns:e.columns,config:e.tableConfig,"row-actions-buttons":e.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const fa=ne(pa,[["render",va]]),ga=x({name:"EnrollmentForm",components:{DateInput:ge,IonGrid:re,IonRow:ae,IonCol:T,IonButton:te},props:["birthdate"],emits:["enrollProgram"],setup(e,{emit:t}){const l=Z().format("YYYY-MM-DD"),u=ie({date:{value:"",label:"Date of Enrollment",required:!0,validation:async i=>new Date(i.value)<new Date(e.birthdate)?["Date of enrollment cannot be before date of birth"]:new Date(i.value)>new Date(l)?["Date of enrollment cannot be in the future"]:null}});return{form:u,today:l,onReset:async()=>{await Ie("Are you sure you want to clear all fields")&&(u.date.value="",u.date.error="",q.emit(L.ON_CLEAR))},enrollProgram:async()=>Ne(u,({date:i})=>t("enrollProgram",i))}}});function ba(e,t,l,u,d,b){const i=_("DateInput"),s=_("ion-col"),v=_("ion-button"),V=_("ion-row"),y=_("ion-grid");return I(),U(y,null,{default:n(()=>[a(V,null,{default:n(()=>[a(s,{size:"12"},{default:n(()=>[a(i,{modelValue:e.form.date,"onUpdate:modelValue":t[0]||(t[0]=g=>e.form.date=g),form:e.form,minDate:e.birthdate,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),a(s,null,{default:n(()=>[a(v,{color:"warning",onClick:e.onReset},{default:n(()=>t[1]||(t[1]=[k("Reset")])),_:1},8,["onClick"]),a(v,{color:"success",onClick:e.enrollProgram},{default:n(()=>t[2]||(t[2]=[k("Enroll")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const _a=ne(ga,[["render",ba]]),ya=x({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:ge,IonGrid:re,IonRow:ae,IonCol:T,IonButton:te,SelectInput:le,TextInput:Pe},emits:["saveOutcome"],setup(e,{emit:t}){const l=Z().format("YYYY-MM-DD"),u=ie({date:{value:"",label:"Outcome Date",required:!0,validation:async v=>new Date(v.value)<new Date(e.birthdate)?["Outcome date cannot be before date of birth - ".concat(Z(e.birthdate).format(qe))]:new Date(v.value)<new Date(e.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(Z(e.dateEnrolled).format(qe))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(v,V)=>V.status.value.label==="Patient transferred out"&&de(v)},reason:{value:"",label:"Reason for transfer out",validation:async(v,V)=>V.status.value.label==="Patient transferred out"&&de(v)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(v,V)=>{var y,g,N,w;return((g=(y=V.status)==null?void 0:y.value)==null?void 0:g.label)==="Patient transferred out"&&((w=(N=V.reason)==null?void 0:N.value)==null?void 0:w.label)==="Other"&&de(v)}}}),d=B(()=>{var v;return((v=u.status.value)==null?void 0:v.label)==="Patient transferred out"}),b=B(()=>{var v,V;return((V=(v=u.reason)==null?void 0:v.value)==null?void 0:V.label)==="Other"});return{form:u,today:l,isTransferredOut:d,specifyOther:b,onSave:()=>Ne(u,v=>t("saveOutcome",{...v,isTransferredOut:d.value})),onReset:async()=>{if(await Ie("are you sure you want to clear all fields")){for(const v in u)u[v].value="",u[v].error="";q.emit(L.ON_CLEAR)}},getFacilities:oa,transferOutReasons:xt}}});function ha(e,t,l,u,d,b){const i=_("ion-col"),s=_("DateInput"),v=_("SelectInput"),V=_("text-input"),y=_("ion-button"),g=_("ion-row"),N=_("ion-grid");return I(),U(N,null,{default:n(()=>[a(g,null,{default:n(()=>[a(i,{size:"12"},{default:n(()=>t[5]||(t[5]=[fe("p",null,"Add New Outcome",-1)])),_:1}),a(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[a(s,{modelValue:e.form.date,"onUpdate:modelValue":t[0]||(t[0]=w=>e.form.date=w),form:e.form,minDate:e.dateEnrolled,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),a(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[a(v,{modelValue:e.form.status,"onUpdate:modelValue":t[1]||(t[1]=w=>e.form.status=w),form:e.form,options:e.outcomes},null,8,["modelValue","form","options"])]),_:1}),e.isTransferredOut?(I(),M(z,{key:0},[a(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[a(v,{modelValue:e.form.nextFacility,"onUpdate:modelValue":t[2]||(t[2]=w=>e.form.nextFacility=w),form:e.form,asyncOptions:e.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),a(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[a(v,{modelValue:e.form.reason,"onUpdate:modelValue":t[3]||(t[3]=w=>e.form.reason=w),form:e.form,options:e.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),e.specifyOther?(I(),U(i,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[a(V,{modelValue:e.form.otherReason,"onUpdate:modelValue":t[4]||(t[4]=w=>e.form.otherReason=w),form:e.form},null,8,["modelValue","form"])]),_:1})):H("",!0)],64)):H("",!0),a(i,{size:"12",class:"ion-margin-top"},{default:n(()=>[a(y,{color:"warning",onClick:e.onReset},{default:n(()=>t[6]||(t[6]=[k("Reset")])),_:1},8,["onClick"]),a(y,{color:"success",onClick:e.onSave},{default:n(()=>t[7]||(t[7]=[k("Save")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Va=ne(ya,[["render",ha]]),wa=x({components:{IonContent:Je,IonFooter:Qe,IonHeader:je,IonTitle:Ye,IonToolbar:De,IonButton:te,IonGrid:re,IonRow:ae,IonCol:T,IonBadge:Bt,OutcomesTable:fa,EnrollmentForm:_a,OutcomeForm:Va},props:{patient:{type:Object,required:!0}},setup(e){const{toStandardHisDisplayFormat:t,toStandardHisFormat:l}=gt,u=new Qt(e.patient.getID()),d=B(()=>l(e.patient.getBirthdate())),b=O(),i=B(()=>!W(b.value)),s=O(""),v=O(),V=B(()=>{var D,f,h;return(h=(f=(D=b.value)==null?void 0:D.patient_states)==null?void 0:f.length)!=null?h:0}),y=B(()=>i.value&&s.value?"Patient enrolled in this porgram on ".concat(t(s.value)):"Patient is not enrolled in this program"),g=async({date:D,status:f,nextFacility:h,reason:P,otherReason:$,isTransferredOut:A})=>{if(u.setStateDate(D),u.setStateId(f.value),A){const C=P.value!=="Other"?P.value:$;await u.transferOutEncounter(h.other,C)}await u.updateState(),await Oe("Outcome saved successfully",1e3),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},N=async D=>{u.setProgramDate(D),await u.enrollProgram(),await Oe("Program enrolled successfully",1e3),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},w=async()=>{var D;u.setPatientProgramId(((D=b.value)==null?void 0:D.patient_program_id)||-1),await u.voidProgram("duplicate / system error"),await Oe("Patient voided from program successfully",1e3),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},R=async({stateId:D,index:f})=>{var h;u.setStateId(D),await u.voidState("duplicate / system error"),Oe("Outcome voided successfully"),(h=b.value)==null||h.patient_states.splice(f,1),q.emit(L.RELOAD_PATIENT_VISIT_DATA)};return _e(async()=>{const D=(await u.getPrograms()).data;if(b.value=D.find(f=>f.program.name==="HIV PROGRAM"),b.value){s.value=b.value.date_enrolled;const f=await u.getProgramOutcomes(),h=new Set(u.removedStates);v.value=f.map(P=>({label:P.name,value:P.program_workflow_state_id,other:P})).filter(P=>!h.has(P.label))}}),{modal:F,patientProgram:u,isEnrolled:i,enrollDate:s,birthdate:d,enrollmentStatus:y,outcomes:v,program:b,totalStates:V,toStandardHisDisplayFormat:t,saveOutcome:g,enrollProgram:N,voidProgram:w,voidOutcome:R}}});function Da(e,t,l,u,d,b){const i=_("ion-title"),s=_("ion-toolbar"),v=_("ion-header"),V=_("ion-badge"),y=_("ion-col"),g=_("ion-row"),N=_("enrollment-form"),w=_("outcome-form"),R=_("outcomes-table"),D=_("ion-grid"),f=_("ion-content"),h=_("ion-button"),P=_("ion-footer");return I(),M(z,null,[a(v,null,{default:n(()=>[a(s,null,{default:n(()=>[a(i,null,{default:n(()=>t[1]||(t[1]=[k("Patient Outcomes")])),_:1})]),_:1})]),_:1}),a(f,null,{default:n(()=>[a(D,{style:{width:"100%"}},{default:n(()=>[a(g,null,{default:n(()=>[a(y,null,{default:n(()=>[a(V,{color:"lightblue",class:"ion-padding",style:{width:"100%"},disabled:""},{default:n(()=>[k(oe(e.enrollmentStatus),1)]),_:1})]),_:1})]),_:1}),e.isEnrolled?(I(),M(z,{key:1},[e.outcomes?(I(),U(g,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[a(w,{"date-enrolled":e.enrollDate,birthdate:e.birthdate,outcomes:e.outcomes,onSaveOutcome:e.saveOutcome},null,8,["date-enrolled","birthdate","outcomes","onSaveOutcome"])]),_:1})):H("",!0),a(g,{class:"his-card",style:_t({minHeight:e.totalStates?"0":"30vh"})},{default:n(()=>[a(y,{size:"12",class:"ion-no-padding"},{default:n(()=>{var $;return[a(R,{patientStates:($=e.program)==null?void 0:$.patient_states,onVoidOutcome:e.voidOutcome},null,8,["patientStates","onVoidOutcome"])]}),_:1})]),_:1},8,["style"])],64)):(I(),U(g,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[a(y,{size:"12"},{default:n(()=>[a(N,{patientProgram:e.patientProgram,birthdate:e.birthdate,onEnrollProgram:e.enrollProgram},null,8,["patientProgram","birthdate","onEnrollProgram"])]),_:1})]),_:1}))]),_:1})]),_:1}),a(P,null,{default:n(()=>[a(s,null,{default:n(()=>[a(h,{color:"primary",onClick:t[0]||(t[0]=$=>e.modal.hide()),slot:"end"},{default:n(()=>t[2]||(t[2]=[k("Close")])),_:1}),e.isEnrolled?(I(),U(h,{key:0,color:"danger",onClick:e.voidProgram,slot:"end"},{default:n(()=>t[3]||(t[3]=[k("Void Program")])),_:1},8,["onClick"])):H("",!0)]),_:1})]),_:1})],64)}const Ia=ne(wa,[["render",Da]]),Na=x({name:"MultiColumnView",components:{IonGrid:re,IonRow:ae,IonCol:T},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(e){const t={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:B(()=>sa(e.items,Math.ceil(e.items.length/e.numberOfColumns))),grid:t}}});function Ra(e,t,l,u,d,b){const i=_("ion-col"),s=_("ion-row"),v=_("ion-grid");return I(),U(v,null,{default:n(()=>[a(s,null,{default:n(()=>[(I(!0),M(z,null,Se(e.computedItems,(V,y)=>(I(),U(i,{key:y,size:e.grid[e.numberOfColumns]},{default:n(()=>[Ft(e.$slots,"default",{entries:V})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const tt=ne(Na,[["render",Ra]]);class Aa extends me{constructor(t,l=X()){super(t,Te.HIV_RECEPTION,l)}}class Sa extends me{constructor(t,l=X()){super(t,Te.ART_ADHERENCE,l)}buildPillCountObs(t,l){return this.buildValueNumber("Number of tablets brought to clinic",l,null,t)}async buildAdherenceObs(t,l,u){return{concept_id:await me.getConceptID("Drug adherence",!0),value_numeric:u,value_drug:l,value_modifier:"%",order_id:t,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(t,l,u){return Math.round(100*(t-l)/(t-u))}calculateExpected(t,l,u,d){const b=d==="QW"?"week":"day",i=this.calcTimeElapsed(u,b);return t-i*parseFloat(l.toString())}calcTimeElapsed(t,l){return Z(this.date).diff(t,l)+1}}class Pa extends me{constructor(t,l=X()){super(t,Te.APPOINTMENT,l)}}class Ta extends me{constructor(t,l=X()){super(t,Te.TREATMENT,l)}calculateDosage(t,l){let u=0;return l===0&&(u=t),t==0&&(u=l),t>0&&l>0&&(u=(t+l)/2),u}calculateEquivalentDosage(t,l){return t+l}calculateDrugRunOutDate(t,l){return Zt(Z(l).add(t,"days"))}getInstructions(t,l,u,d){return"".concat(t," :- Morning: ").concat(l," ").concat(d,", Evening: ").concat(u," ").concat(d)}toDrugOrder(t,l,u,d){return{drug_inventory_id:t.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(t.am,t.pm),start_date:d,auto_expire_date:this.calculateDrugRunOutDate(u,d),units:t.units,instructions:this.getInstructions(t.drug_name,t.am,t.pm,t.units),dose:this.calculateDosage(t.am,t.pm),frequency:t.frequency,qty:l}}async createDrugOrder(t){return yt.create({encounter_id:this.encounterID,drug_orders:t})}}class Ca{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(t,l,u){let d={result:"",color:"",index:u};if(u<=0)return d.index=0,d;if(l<5&&l>0)d.result="Use MUAC to calculate nutrition status",d.color="red";else{l>18&&(l=19);const b=await this.getBMIData(),i=b[t][l];i&&(d=this.buildBounds(Object.keys(i),i,u,b.colors))}return d}static buildBounds(t,l,u,d){const b={result:"",color:"",index:u};return t.forEach(i=>{if(i.indexOf("-")>=0){const s=i.split("-");u>=parseFloat(s[0])&&u<=parseFloat(s[1])&&(b.result=l[i],b.color=d[l[i]])}else if(i.indexOf("<")>=0){const s=i.replace("<","");u<parseFloat(s)&&(b.result=l[i],b.color=d[l[i]])}else if(i.indexOf(">=")>=0){const s=i.replace(">=","");u>=parseFloat(s)&&(b.result=l[i],b.color=d[l[i]])}}),b}static getBMI(t,l,u,d){const b=this.calculateBMI(t,l);return this.getBMIResult(u,d,b)}static calculateBMI(t,l){if(l==0||t==0)return 0;let u=t/l/l*1e4;return u=Math.round(u*10)/10}}class Oa extends me{constructor(t,l=X()){super(t,Te.DISPENSING,l)}buildDispensations(t,l,u){const d=[];for(let b=0;b<u;b++)d.push({drug_order_id:t,date:this.date,quantity:l/u});return d}saveDispensations(t){return Ve.postJson("/dispensations",{dispensations:t,program_id:this.programID})}}const Ea=x({__name:"PatientVisit",props:{patient:{type:Object,required:!0}},setup(e){const t=e,l=B(()=>t.patient.getID()),u=new Xt(l.value),d=new Kt(l.value),b=new Ta(l.value),i=new Oa(l.value),s=new Aa(l.value),v=new Sa(l.value),V=new Pa(l.value),y=O(),g=O(),N=O([]),w=O([]),R=O([]),D=O([]),f=B(()=>!(y.value&&t.patient.getAge()>18)),h=B(()=>t.patient.isFemale()),P=O(""),$=t.patient.getBirthdate(),A=O(!1),C=ie({}),r=ie({visitDate:{value:Z().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async o=>new Date(o.value)>new Date(X())?["Visit date cannot be after today's date"]:new Date(o.value)<new Date($)?["Visit date cannot be before patient's birth date"]:null},weight:{value:void 0,label:"Weight",required:!0,computedValue:o=>({tag:"vitals",obs:u.buildValueNumber("Weight",o)}),validation:(o,c)=>(W(o)||!o.value)&&c.patientPresent.value==="No"?null:He([()=>de(o),()=>ue(o,"DECIMALS"),()=>vt(o,2,250)])},height:{value:void 0,label:"Height",computedValue:o=>({tag:"vitals",obs:u.buildValueNumber("Height",o)}),validation:o=>!f.value||(W(o)||!o.value)&&r.patientPresent.value==="No"?null:He([()=>de(o),()=>ue(o),()=>vt(o,20,220)])},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:h.value,computedValue:o=>({tag:"consultation",obs:d.buildValueCoded("Is patient pregnant",o)}),validation:async o=>h.value&&de(o)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:h.value,computedValue:o=>({tag:"consultation",obs:d.buildValueCoded("Is patient breast feeding",o)}),validation:async o=>h.value&&de(o)},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:o=>({tag:"appointment",obs:V.buildValueDate("Appointment date",o)}),validation:async(o,c)=>new Date(o.value)<new Date(c.visitDate.value)?["Appointment date cannot be before visit date"]:new Date(o.value)>new Date(P.value)?["Appointment date cannot be after drug run out date"]:null},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:o=>({tag:"reception",obs:s.buildValueCoded("Patient present",o)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:o=>({tag:"reception",obs:s.buildValueCoded("Guardian present",o)})},pillCount:{value:void 0,label:"Pill Count",required:D.value.length>0,validation:async o=>D.value.length>0&&ue(o)},regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","INH")}),validation:async(o,c)=>{var p,E;return(((p=c.tbMed.value)==null?void 0:p.label)==="6H"||((E=c.tbMed.value)==null?void 0:E.label)==="3HP (RFP + INH)")&&ue(o)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(o,c)=>{var p;return((p=c.tbMed.value)==null?void 0:p.label)==="3HP (RFP + INH)"&&ue(o)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(o,c)=>{var p;return((p=c.tbMed.value)==null?void 0:p.label)==="3HP (INH 300 / RFP 300)"&&ue(o)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(o,c)=>{var p;return((p=c.tbMed.value)==null?void 0:p.label)&&ue(o)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async o=>He([()=>de(o),()=>o.value==="No"||w.value.some(c=>c.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async o=>He([()=>de(o),()=>o.value==="No"||R.value.some(c=>c.isChecked)?null:["Please select at least one side effect"]])},tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:o=>({tag:"consultation",obs:d.buildValueCoded("TB Status",o.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async o=>{if(!A.value){if(new Date(o.value)>new Date(X()))return["TB treatment start date cannot be after today's date"];if(new Date(o.value)<new Date($))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:o=>({tag:"consultation",obs:d.buildValueDate("TB treatment start date",o)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:o=>({tag:"consultation",obs:d.buildValueNumber("TB treatment period",o)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:o=>({tag:"consultation",obs:d.buildGroupValueCoded("TB screening method used","chest xray",o)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:o=>({tag:"consultation",obs:d.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",o)})}}),j=async(o,c)=>{const p={label:"Unkown",value:"Unkown",other:[{drug_id:1046,drug_name:"Unknown ARV",am:1,pm:0,units:"",frequency:"Daily (QOD)"}]},E=(await Ce.getRegimensByWeight(o,c)).data;return W(E)?[p]:Object.keys(E).map(J=>({label:J,value:J,other:E[J]})).concat([p])};ve(()=>r.regimen.value,o=>{var c;Xe(),o&&((c=o==null?void 0:o.other)==null||c.forEach(p=>{var E;C[p.drug_name]={label:"".concat((E=p.alternative_drug_name)!=null?E:p.drug_name," given"),value:0,required:!0,validation:J=>ue(J,"POSITIVE_INTEGERS")}}))}),ve(r.patientPresent,o=>{o.value==="No"?(r.weight.required=!1,r.weight.error="",r.guardianPresent.value="Yes"):r.weight.required=!0}),ve(r.guardianPresent,o=>{o.value==="No"&&(r.patientPresent.value="Yes")}),ve([()=>r.weight.value,()=>r.tbStatus.value],async([o,c])=>{var E;r.regimen.value=void 0,Xe();const p=A.value||/confirmed/i.test((E=c==null?void 0:c.label)!=null?E:"");o?(N.value=await j(r.weight.value,p),r.patientPresent.value="Yes",r.patientPresent.disabled=!0):!o&&r.weight.required&&(r.patientPresent.value=void 0,r.patientPresent.disabled=!1),r.tbMed.disabled=p});const se=()=>{var o,c;return W(C)?1/0:Math.min(...(c=(o=r.regimen.value)==null?void 0:o.other)==null?void 0:c.map(p=>{var E,J,ce,$e,Ue;return((J=(E=C[p.drug_name])==null?void 0:E.value)!=null?J:0)/(((ce=p.am)!=null?ce:0)+(($e=p.noon)!=null?$e:0)+((Ue=p.pm)!=null?Ue:0))||1}))};ve([()=>C,()=>r.pillCount.value,()=>r.visitDate.value],()=>{const o=parseInt(r.pillCount.value)||0,c=se();c!==1/0&&(P.value=b.calculateDrugRunOutDate(c+o,r.visitDate.value),r.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(be(P.value),")"),r.nextAppointmentDate.value=P.value)},{deep:!0}),ve(()=>r.visitDate.value,()=>lt());const ye=B(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (INH 300 / RFP 300)"}),G=B(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (RFP + INH)"}),S=B(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="6H"}),Re=B(()=>r.hasContraindications.value==="Yes"),ot=B(()=>r.hasSideEffects.value==="Yes"),Dt=B(()=>{var o;return/Confirmed TB on treatment/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),It=B(()=>{var o;return/Suspected/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),Nt=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Rt=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],At=We(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),St=We(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),lt=async()=>{d.setDate(r.visitDate.value),A.value=!1;const o=await d.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(o)){const c=await d.getFirstValueDatetime("TB treatment start date"),p=await d.getFirstValueNumber("TB treatment period")||6;if(c){const E=Z(r.visitDate.value).diff(c,"months");A.value=E<=p}}r.tbStatus.required=!A.value},Pt=async o=>{const c=o.height||y.value,p=Ca.calculateBMI(o.weight,c);return u.buildValueNumber("BMI",p)},Tt=async()=>{const o=[await d.buildValueCoded("Patient using family planning","No")];return d.getFamilyPlanningMethods().forEach(async p=>{o.push(await d.buildValueCoded(p,"No"))}),o},Ct=async()=>Promise.all(Me.getConceptsByCategory("tb_symptom",!0).map(async o=>d.buildGroupValueCoded(o.name,o.name,"No"))),Ot=async()=>{u.setDate(r.visitDate.value),d.setDate(r.visitDate.value),b.setDate(r.visitDate.value),s.setDate(r.visitDate.value),v.setDate(r.visitDate.value),V.setDate(r.visitDate.value),i.setDate(r.visitDate.value),await Ne(r,async(o,c)=>{var it,rt,st,ut,dt;const p=[];let E=0;if(!W(o.regimen)&&await ta(C)){const K=o.regimen.other,Q=aa(C).formData;E=se(),K.forEach(Y=>p.push(b.toDrugOrder(Y,Q[Y.drug_name],E,o.visitDate)))}else if(!await Ie("Are you sure you want to continue without dispensing ART drugs?"))return;if(ke.show("Saving patient visit..."),o.totalCPTGiven&&ft((await Ce.getRegimenExtras("Cotrimoxazole",(it=o.weight)!=null?it:g.value)).data,"concept_name").filter(K=>K.frequency==="Daily (QOD)").forEach(K=>p.push(b.toDrugOrder(K,o.totalCPTGiven,E,o.visitDate))),(rt=o.tbMed)!=null&&rt.value){const K=ft((await Ce.getRegimenExtras("INH",(st=o.weight)!=null?st:g.value)).data,["concept_name","frequency"]),Q=K.find(Y=>Y.concept_name==="Pyridoxine");if(Q&&o.totalPyridoxineGiven&&p.push(b.toDrugOrder(Q,o.totalPyridoxineGiven,E,o.visitDate)),o.totalIPTGiven){const Y=K.find(he=>he.concept_name==="Isoniazid"&&(S.value&&he.frequency==="Daily (QOD)"||G.value&&he.frequency==="Weekly (QW)"));p.push(b.toDrugOrder(Y,o.totalIPTGiven,E,o.visitDate))}if(o.totalRFPGiven&&G.value){const Y=(await Ce.getRegimenExtras("Rifapentine",(ut=o.weight)!=null?ut:g.value)).data;Y.length&&p.push(b.toDrugOrder(Y[0],o.totalRFPGiven,E,o.visitDate))}if(o.total3HPGiven&&ye.value){const Y=(await Ce.getRegimenExtras("INH / RFP",(dt=o.weight)!=null?dt:g.value)).data;p.push(b.toDrugOrder(Y[0],o.total3HPGiven,E,o.visitDate))}}if(!W(p)){await b.createEncounter();const Q=(await b.createDrugOrder(p)).data.map(Y=>{const he=p.find(kt=>kt.drug_inventory_id===Y.drug_inventory_id);return i.buildDispensations(Y.order_id,he.qty,1)});await i.saveDispensations(Q.flat(1))}const J=await Fe(c,"vitals");if(!W(J)){await u.createEncounter();const K=await Pt(o);await u.saveObservationList([...J,K])}await d.createEncounter();const ce=await Fe(c,"consultation");ce.push(...await d.buildOptionsGroupObs("Malawi ART side effects",w.value)),ce.push(...await Ct()),ot.value&&ce.push(...await d.buildOptionsGroupObs("Other side effect",R.value)),h.value&&ce.push(...await Tt()),await d.saveObservationList(ce),await s.createEncounter();const $e=await Fe(c,"reception");if(await s.saveObservationList($e),D.value.length>0){await v.createEncounter();const K=await Promise.all(D.value.map(async Q=>{const Y=v.calculateExpected(Q.quantity,Q.equivalent_daily_dose,Q.order.start_date,Q.frequency),he=v.calculateAdherence(Q.quantity,o.pillCount,Y);return[await v.buildAdherenceObs(Q.order_id,Q.drug_inventory_id,he),await v.buildPillCountObs(Q.order_id,o.pillCount)]}));await v.saveObservationList(K.flat(1))}await V.createEncounter();const Ue=await Fe(c,"appointment");await V.saveObservationList(Ue),await Oe("Patient visit saved successfully"),await F.hide(),ke.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA),q.emit(L.RELOAD_STAGING_INFORMATION)},{showloader:!1})},Et=async()=>{if(await Ie("Are you sure you want to clear all fields?")){for(const o in r)r[o].value="",r[o].error="",r[o].disabled=!1;Xe(),q.emit(L.ON_CLEAR)}},Xe=()=>{for(const o in C)delete C[o]};return _e(async()=>{try{await lt(),y.value=await t.patient.getRecentHeight(),g.value=await t.patient.getRecentWeight(),g.value&&(N.value=await j(g.value)),D.value=(await yt.getLastDrugsReceived(t.patient.getID())).data,r.pillCount.required=D.value.length>0,w.value=Me.getConceptsByCategory("contraindication",!0).map(o=>({value:o.concept_id,label:o.name,other:o})),R.value=Me.getConceptsByCategory("side_effect",!0).map(o=>({value:o.concept_id,label:o.name,other:o}))}catch(o){at("Form initialization failed. Try to refresh the page"),console.error(o)}}),(o,c)=>(I(),M(z,null,[a(m(je),null,{default:n(()=>[a(m(De),null,{default:n(()=>[a(m(Ye),null,{default:n(()=>c[24]||(c[24]=[k("Patient Visit")])),_:1})]),_:1})]),_:1}),a(m(Je),{class:"ion-padding"},{default:n(()=>[a(m(re),{style:{width:"100%"}},{default:n(()=>[a(m(ae),null,{default:n(()=>[a(m(T),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[a(ge,{modelValue:r.visitDate,"onUpdate:modelValue":c[0]||(c[0]=p=>r.visitDate=p),form:r,minDate:m($),maxDate:m(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(pe,{modelValue:r.patientPresent,"onUpdate:modelValue":c[1]||(c[1]=p=>r.patientPresent=p),inline:"",disabled:r.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(pe,{modelValue:r.guardianPresent,"onUpdate:modelValue":c[2]||(c[2]=p=>r.guardianPresent=p),inline:""},null,8,["modelValue"])]),_:1}),h.value?(I(),M(z,{key:0},[a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(pe,{modelValue:r.isPregnant,"onUpdate:modelValue":c[3]||(c[3]=p=>r.isPregnant=p),inline:""},null,8,["modelValue"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(pe,{modelValue:r.isBreastfeeding,"onUpdate:modelValue":c[4]||(c[4]=p=>r.isBreastfeeding=p),inline:""},null,8,["modelValue"])]),_:1})],64)):H("",!0),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(pe,{modelValue:r.hasContraindications,"onUpdate:modelValue":c[5]||(c[5]=p=>r.hasContraindications=p),inline:""},null,8,["modelValue"]),Re.value?(I(),U(tt,{key:0,items:w.value,numberOfColumns:2},{default:n(({entries:p})=>[(I(!0),M(z,null,Se(p,E=>(I(),U(m(Ge),{lines:"none",key:E.value},{default:n(()=>[a(m(Le),null,{default:n(()=>[k(oe(E.label),1)]),_:2},1024),a(m(xe),{slot:"start",modelValue:E.isChecked,"onUpdate:modelValue":J=>E.isChecked=J},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):H("",!0)]),_:1}),a(m(T),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[a(pe,{modelValue:r.hasSideEffects,"onUpdate:modelValue":c[6]||(c[6]=p=>r.hasSideEffects=p),inline:""},null,8,["modelValue"]),ot.value?(I(),U(tt,{key:0,items:R.value,numberOfColumns:2},{default:n(({entries:p})=>[(I(!0),M(z,null,Se(p,E=>(I(),U(m(Ge),{lines:"none",key:E.value},{default:n(()=>[a(m(Le),null,{default:n(()=>[k(oe(E.label),1)]),_:2},1024),a(m(xe),{slot:"start",modelValue:E.isChecked,"onUpdate:modelValue":J=>E.isChecked=J},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):H("",!0)]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:r.weight,"onUpdate:modelValue":c[7]||(c[7]=p=>r.weight=p),form:r,min:1},null,8,["modelValue","form"])]),_:1}),f.value?(I(),U(m(T),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:r.height,"onUpdate:modelValue":c[8]||(c[8]=p=>r.height=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),A.value?H("",!0):(I(),U(m(T),{key:2,class:"ion-margin-vertical",size:f.value?"12":"6"},{default:n(()=>[a(le,{modelValue:r.tbStatus,"onUpdate:modelValue":c[9]||(c[9]=p=>r.tbStatus=p),options:m(St)},null,8,["modelValue","options"])]),_:1},8,["size"])),Dt.value?(I(),M(z,{key:3},[a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ge,{modelValue:r.tbTreatmentStartDate,"onUpdate:modelValue":c[10]||(c[10]=p=>r.tbTreatmentStartDate=p),form:r,minDate:m($),maxDate:m(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:r.tbTreatmentPeriod,"onUpdate:modelValue":c[11]||(c[11]=p=>r.tbTreatmentPeriod=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})],64)):It.value?(I(),M(z,{key:4},[a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(pe,{modelValue:r.cxrResult,"onUpdate:modelValue":c[12]||(c[12]=p=>r.cxrResult=p),"custom-options":Nt},null,8,["modelValue"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(pe,{modelValue:r.mwrdResult,"onUpdate:modelValue":c[13]||(c[13]=p=>r.mwrdResult=p),"custom-options":Rt},null,8,["modelValue"])]),_:1})],64)):H("",!0),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(le,{modelValue:r.regimen,"onUpdate:modelValue":c[14]||(c[14]=p=>r.regimen=p),options:N.value},null,8,["modelValue","options"])]),_:1}),m(W)(C)?H("",!0):(I(!0),M(z,{key:5},Se(Object.values(C),(p,E)=>(I(),U(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{"model-value":p,form:C,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:r.totalCPTGiven,"onUpdate:modelValue":c[15]||(c[15]=p=>r.totalCPTGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1}),a(m(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(le,{modelValue:r.tbMed,"onUpdate:modelValue":c[16]||(c[16]=p=>r.tbMed=p),options:m(At)},null,8,["modelValue","options"])]),_:1}),S.value||G.value?(I(),U(m(T),{key:6,size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:r.totalIPTGiven,"onUpdate:modelValue":c[17]||(c[17]=p=>r.totalIPTGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),G.value?(I(),U(m(T),{key:7,size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:r.totalRFPGiven,"onUpdate:modelValue":c[18]||(c[18]=p=>r.totalRFPGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),ye.value?(I(),U(m(T),{key:8,size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:r.total3HPGiven,"onUpdate:modelValue":c[19]||(c[19]=p=>r.total3HPGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),ye.value||G.value||S.value?(I(),U(m(T),{key:9,size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:r.totalPyridoxineGiven,"onUpdate:modelValue":c[20]||(c[20]=p=>r.totalPyridoxineGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),D.value.length>0?(I(),U(m(T),{key:10,size:"6",class:"ion-margin-vertical"},{default:n(()=>[a(ee,{modelValue:r.pillCount,"onUpdate:modelValue":c[21]||(c[21]=p=>r.pillCount=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),a(m(T),{size:D.value.length>0?"6":"12",class:"ion-margin-vertical"},{default:n(()=>[a(ge,{modelValue:r.nextAppointmentDate,"onUpdate:modelValue":c[22]||(c[22]=p=>r.nextAppointmentDate=p),form:r,minDate:r.visitDate.value,maxDate:P.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1},8,["size"])]),_:1})]),_:1})]),_:1}),a(m(Qe),null,{default:n(()=>[a(m(De),null,{default:n(()=>[a(m(te),{color:"primary",onClick:c[23]||(c[23]=p=>m(F).hide()),slot:"end"},{default:n(()=>c[25]||(c[25]=[k(" Close ")])),_:1}),a(m(te),{color:"warning",onClick:Et,slot:"end"},{default:n(()=>c[26]||(c[26]=[k(" Reset ")])),_:1}),a(m(te),{color:"success",onClick:Ot,slot:"end"},{default:n(()=>c[27]||(c[27]=[k(" Save ")])),_:1})]),_:1})]),_:1})],64))}});const ka=ne(Ea,[["__scopeId","data-v-7cbaf355"]]),$a=x({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:nt,IonCard:Ht,IonCardHeader:Mt,IonCardTitle:qt,IonCardContent:Lt,IonButton:te},setup(e){const t=O([]),l=B(()=>e.patient.getID()),u=ie({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),d=O([{label:"Add Visit",action:async()=>{await F.show(ka,{patient:e.patient})}},{label:"Update Outcome",action:async()=>F.show(Ia,{patient:e.patient})},{label:"Enter VL Results",action:async()=>F.show(ca,{patient:e.patient})}]),b=R=>{const D=e.startDate!=="N/A"?"("+Z(R).diff(e.startDate,"months")+"M)":"";return"".concat(be(R)," ").concat(D)},i={minWidth:"68px !important"},s=O([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:i},{path:"weight",label:"Weight (Kg)",sortable:!1,thStyles:i},{path:"height",label:"Height (cm)",sortable:!1,thStyles:i},{path:"bmi",label:"BMI",sortable:!1,thStyles:i},...e.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:i},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:i}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:R=>R.length>0?"Yes":"No",sortable:!1,thStyles:i},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:i},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:i},{path:"vlResult",label:"Viral Load",sortable:!1}]),v=R=>({title:"Side effects noted on ".concat(R.row.visitDate),rows:R.row.sideEffects.map(D=>({sideEffect:D})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),V=R=>({title:"Drugs dispensed on ".concat(R.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:R.row.drugs.map(D=>({name:D[0],quantity:D[1],units:"tab (s)"}))}),y=async R=>{const D=/regimen/i.test(R.column.path)?V(R):v(R);W(D.rows)||await F.show(na,D)},g=[{label:"void",icon:Gt,color:"danger",action(R,D){Vt(async f=>{var P;const h=await pt.getEncounters(l.value,{date:R.date});h.ok?((P=h.data)==null||P.forEach(async $=>{await pt.voidEncounter($.encounter_id,f)}),t.value.splice(D,1)):at(h.errorMessage||"Failed to void encounters")},"small-modal")}}],N=async R=>R.tb_status.match(/Unknown/i)||R.outcome==="Defaulted"?"":Me.getCachedConceptName(R.tb_status),w=()=>{ze.getPatientVisits(l.value,!0).then(async R=>{t.value=[];for(const D of R){const f=(await ht.getCurrentProgramInformation(l.value,D)).data;let h="",P="",$="",A="";if(f.outcome!=="Defaulted"){const C=await Be.getFirstValueDatetime(l.value,"appointment date",D);if(C&&(h=be(C)),P=await Be.getFirstValueCoded(l.value,"Is patient pregnant",D),$=await Be.getFirstValueCoded(l.value,"Is patient breast feeding",D),f.viral_load==="N/A"){const r=await Be.getFirstObs(l.value,"HIV viral load",D);r&&r.value_text&&r.value_numeric&&(A=r.value_numeric===1?"LDL":r.value_text+r.value_numeric.toString())}else A=f.viral_load}f&&t.value.push({visitDate:b(D),visitBy:f.visit_by.match(/Unk/i)?"":f.visit_by,weight:f.outcome==="Defaulted"?"":f.weight,height:f.outcome==="Defaulted"?"":f.height,bmi:f.outcome==="Defaulted"?"":f.bmi,pregnant:P,breastfeeding:$,tbStatus:await N(f),sideEffects:f.outcome==="Defaulted"?"":f.side_effects,regimen:f.outcome==="Defaulted"?"":f.regimen,nextAppointment:h,outcome:f.outcome.match(/Unk/i)?"":f.outcome,vlResult:A,drugs:f.pills_dispensed,date:D})}})};return q.on(L.RELOAD_PATIENT_VISIT_DATA,()=>w()),_e(()=>{w()}),{actionButtons:d,tableConfig:u,rowButtons:g,columns:s,rows:t,onDrilldownHandler:y}}});const Ua={class:"ion-float-right ion-margin-end ion-margin-bottom"};function Ba(e,t,l,u,d,b){const i=_("ion-icon"),s=_("ion-button"),v=_("ion-card-title"),V=_("ion-card-header"),y=_("data-table"),g=_("ion-card-content"),N=_("ion-card");return I(),U(N,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[a(V,null,{default:n(()=>[a(v,null,{default:n(()=>[t[0]||(t[0]=fe("span",{class:"title"},"Summary of Visits",-1)),fe("span",Ua,[(I(!0),M(z,null,Se(e.actionButtons,w=>(I(),U(s,{key:w.label,onClick:w.action,color:w.color||"primary"},{default:n(()=>[w.icon?(I(),U(i,{key:0,icon:w.icon,class:"ion-margin-right"},null,8,["icon"])):H("",!0),k(" "+oe(w.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),a(g,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[a(y,{rows:e.rows,columns:e.columns,"row-actions-buttons":e.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:e.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const Fa=ne($a,[["render",Ba],["__scopeId","data-v-b764fd01"]]),Ha=x({__name:"ViralLoadTrail",props:{patient:{}},setup(e){const t=e,l=B(()=>"Viral Load Results Trail for ".concat(t.patient.getFullName())),u=O([]),d=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:be},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:be}],b={label:"X",color:"danger",action({encounter_id:i}){Vt(async s=>{try{await zt.void(i,s),F.hide(),q.emit(L.RELOAD_LATEST_VL_RESULT),q.emit(L.RELOAD_PATIENT_VISIT_DATA)}catch(v){console.error(v)}},"small-modal custom-modal-backdrop")}};return _e(async()=>{u.value=await we.getViralLoadResultTrail(t.patient.getID())}),(i,s)=>(I(),M(z,null,[a(m(je),null,{default:n(()=>[a(m(De),null,{default:n(()=>[a(m(Ye),null,{default:n(()=>[k(oe(l.value),1)]),_:1})]),_:1})]),_:1}),a(m(Je),null,{default:n(()=>[a(m(re),{style:{width:"100%"}},{default:n(()=>[a(m(ae),{style:_t([{padding:"0 !important"},{minHeight:u.value.length?"0":"30vh"}])},{default:n(()=>[a(m(T),{size:"12",class:"ion-no-padding"},{default:n(()=>[a(m(nt),{rows:u.value,columns:d,"row-actions-buttons":[b],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),a(m(Qe),null,{default:n(()=>[a(m(De),null,{default:n(()=>[a(m(te),{color:"primary",onClick:s[0]||(s[0]=v=>m(F).hide()),slot:"end"},{default:n(()=>s[1]||(s[1]=[k(" Close ")])),_:1})]),_:1})]),_:1})],64))}}),Ma=x({components:{MultiColumnView:tt,IonList:Wt,IonItem:Ge},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(e,{emit:t}){const l=O(0),u=O(0),d=O(0),b=O(""),i=O(""),s=O(""),v=O(""),V=O(""),y=O(""),g=O(""),N=O(""),w=O(""),R=O(""),D=O(""),f=S=>S.other&&typeof S.other.onClickHandler=="function",h=B(()=>!W(e.guardians)),P=async S=>{var Re;f(S)&&await((Re=S.other)==null?void 0:Re.onClickHandler())},$=()=>{const S=e.patient.getBirthdate(),Re=e.artStartDate!=="N/A"?Z(e.artStartDate).diff(S,"years"):"";return"".concat(be(S)," (").concat(Re,")")},A=()=>{we.getlatestViralLoadResult(e.patient.getID()).then(S=>R.value=S)},C=()=>({onClickHandler(){Yt.push("/patient/reception/".concat(e.patient.getID(),"/false"))}}),r=()=>h.value?e.guardians.map(S=>"".concat(S.name," (").concat(S.relationshipType,")")).join(","):"Add",j=()=>({onClickHandler:()=>t("updatePatient")}),se=B(()=>[{label:"ARV Number",value:e.patient.getArvNumber(),other:{onClickHandler:()=>t("updateARVNumber")}},{label:"MW National ID",value:e.patient.getMWNationalID(),other:j()},{label:"Name",value:e.patient.getGivenName()+" "+e.patient.getFamilyName(),other:j()},{label:"DOB and Age at Initiation",value:$(),other:j()},{label:"Sex",value:ua(e.patient.getGender()),other:j()},{label:"Location",value:e.patient.getCurrentVillage(),other:j()},{label:"Landmark",value:e.patient.getClosestLandmark(),other:j()},{label:"Phone Number",value:e.patient.getPhoneNumber(),other:j()},{label:"Guardian",value:r(),other:{onClickHandler:()=>t("updateGuardian")}},{label:"Agrees to follow up",value:V.value,other:C()},{label:"Date of starting first line ARV Regimen",value:e.artStartDate,other:C()},{label:"Initial Weight (KG)",value:l.value,other:C()},{label:"Initial Height (CM)",value:u.value,other:C()},{label:"Initial BMI",value:d.value,other:C()},{label:"Initial TB Status",value:b.value,other:C()},{label:"Pregnant at Initiation",value:s.value,other:C()},{label:"Breastfeeding at Initiation",value:i.value,other:C()},{label:"Latest VL Result and Result Date",value:R.value,other:{onClickHandler:()=>F.show(Ha,{patient:e.patient})}},{label:"TI",value:v.value,other:C()},{label:"HIV test place",value:N.value,other:C()},{label:"HIV test date",value:g.value,other:C()},{label:"WHO stage",value:D.value,other:C()},{label:"Reason for starting ART",value:y.value,other:C()},{label:"Staging codition",value:w.value,other:C()}]),ye=async()=>{const S=await e.patient.getHIVTestDate();S&&(g.value=be(S))},G=()=>{e.patient.getInitialWeight().then(S=>l.value=S),e.patient.getInitialHeight().then(S=>u.value=S),e.patient.getInitialBMI().then(S=>d.value=S),e.patient.getInitialTBStatus().then(S=>b.value=S),e.patient.hasPregnancyAtARTInitiation().then(S=>s.value=S),e.patient.breastFeedingAtARTInitiation().then(S=>i.value=S),e.patient.everReceivedART().then(S=>v.value=S),e.patient.agreesToFollowUp().then(S=>V.value=S),e.patient.getReasonForStartingART().then(S=>y.value=S),e.patient.getHIVTestLocation().then(S=>N.value=S),e.patient.getStagingCondition().then(S=>w.value=S),e.patient.getWhoStage().then(S=>D.value=S),ye()};return _e(()=>{G(),A(),q.on(L.RELOAD_LATEST_VL_RESULT,()=>A()),q.on(L.RELOAD_STAGING_INFORMATION,()=>G())}),{patientInfo:se,onClickHandler:P,clickable:f}}});const qa={style:{width:"100%",display:"flex",justifyContent:"space-between"}},La={key:0},Ga={key:1},za={key:2},Wa={key:3};function Ya(e,t,l,u,d,b){const i=_("ion-item"),s=_("ion-list"),v=_("multi-column-view");return I(),U(v,{items:e.patientInfo,numberOfColumns:3},{default:n(({entries:V})=>[a(s,{class:"his-card ion-margin-end"},{default:n(()=>[(I(!0),M(z,null,Se(V,(y,g)=>(I(),U(i,{key:g,lines:g===V.length-1?"none":void 0,button:e.clickable(y),onClick:N=>e.onClickHandler(y)},{default:n(()=>[fe("div",qa,[y.label?(I(),M("span",La,oe(y.label)+": ",1)):(I(),M("span",Ga)),e.clickable(y)?(I(),M("span",za,[fe("a",null,[fe("b",null,oe(y.value||"N/A"),1)])])):(I(),M("span",Wa,[fe("b",null,oe(y.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const ja=ne(Ma,[["render",Ya],["__scopeId","data-v-5306de30"]]),Ja=x({components:{IonGrid:re,IonRow:ae,IonCol:T,TextInput:Pe,DateInput:ge,SelectInput:le},props:{patientService:{type:Object,required:!0}},setup(e){const t=O(!1),l=B(()=>/Unknown/i.test(e.patientService.getMWNationalID())?"":e.patientService.getMWNationalID()),u=ie({givenName:{label:"First Name",value:e.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:i=>Ee(i)},familyName:{label:"last Name",value:e.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:i=>Ee(i)},middleName:{label:"middle Name",value:e.patientService.getMiddleName(),placeholder:"middle Name",validation:i=>!!i&&Ee(i)},nationalId:{label:"Malawi National ID Number",value:l.value,placeholder:"Enter Malawi National ID Number",validation:i=>i&&i.label?ra(i):null},gender:{value:e.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:e.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:e.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async i=>!(i.value==="Unknown"||i.value==="N/A")&&wt(i)},homeVillage:{value:e.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:e.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),d=async i=>{var V,y,g,N,w;let s,v;try{(V=i==null?void 0:i.other)!=null&&V.traditional_authority_id&&(s=await ct.getTraditionalAuthorityById(i.other.traditional_authority_id)),s&&(v=await ct.getDistrictByID(s.district_id))}catch(R){at("Unable to resolve patient address. Saving using default address"),console.error(R)}return{home_district:(y=v==null?void 0:v.name)!=null?y:"N/A",home_traditional_authority:(g=s==null?void 0:s.name)!=null?g:"N/A",home_village:(i==null?void 0:i.label)||"N/A",current_district:(N=v==null?void 0:v.name)!=null?N:"N/A",current_traditional_authority:(w=s==null?void 0:s.name)!=null?w:"N/A",current_village:(i==null?void 0:i.label)||"N/A"}};return{today:X,patient:u,getLandmarks:la,genderOptions:ea,isBirthdateEstimated:t,modal:F,onFinish:async()=>Ne(u,async i=>{const s={};if(i.givenName!==e.patientService.getGivenName()&&(s.given_name=i.givenName),i.familyName!==e.patientService.getFamilyName()&&(s.family_name=i.familyName),i.middleName!==e.patientService.getMiddleName()&&(s.middle_name=i.middleName),i.birthdate!==e.patientService.getBirthdate()&&(s.birthdate=i.birthdate),i.gender.value!==e.patientService.getGender()&&(s.gender=i.gender.value),i.cellPhoneNumber!==e.patientService.getPhoneNumber()&&(s.cell_phone_number=i.cellPhoneNumber),i.landmark.label!==e.patientService.getClosestLandmark()&&(s.landmark=i.landmark.label),i.homeVillage!==e.patientService.getCurrentVillage()&&Object.assign(s,{...s,...await d(i.homeVillage)}),!W(s)){const v=new et;v.setPersonID(e.patientService.getID()),await v.updatePerson(s)}i.nationalId!==l.value&&await e.patientService.updateMWNationalId(i.nationalId),await F.hide(),q.emit(L.RELOAD_PATIENT_DATA)}),getVillagesByName:ia}}});function Qa(e,t,l,u,d,b){const i=_("ion-title"),s=_("ion-icon"),v=_("ion-button"),V=_("ion-buttons"),y=_("ion-toolbar"),g=_("ion-header"),N=_("TextInput"),w=_("ion-col"),R=_("SelectInput"),D=_("DateInput"),f=_("ion-row"),h=_("ion-grid"),P=_("ion-content"),$=_("ion-footer");return I(),M(z,null,[a(g,null,{default:n(()=>[a(y,null,{default:n(()=>[a(i,null,{default:n(()=>t[12]||(t[12]=[k("Edit Patient Demographics")])),_:1}),a(V,{slot:"end"},{default:n(()=>[a(v,{onClick:t[0]||(t[0]=A=>e.modal.hide())},{default:n(()=>[a(s,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),a(P,{class:"ion-padding"},{default:n(()=>[a(h,null,{default:n(()=>[a(f,null,{default:n(()=>[a(w,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(N,{modelValue:e.patient.givenName,"onUpdate:modelValue":t[1]||(t[1]=A=>e.patient.givenName=A)},null,8,["modelValue"])]),_:1}),a(w,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(N,{modelValue:e.patient.middleName,"onUpdate:modelValue":t[2]||(t[2]=A=>e.patient.middleName=A)},null,8,["modelValue"])]),_:1}),a(w,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(N,{modelValue:e.patient.familyName,"onUpdate:modelValue":t[3]||(t[3]=A=>e.patient.familyName=A)},null,8,["modelValue"])]),_:1}),a(w,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(N,{modelValue:e.patient.nationalId,"onUpdate:modelValue":t[4]||(t[4]=A=>e.patient.nationalId=A)},null,8,["modelValue"])]),_:1}),a(w,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(R,{modelValue:e.patient.gender,"onUpdate:modelValue":t[5]||(t[5]=A=>e.patient.gender=A),options:e.genderOptions},null,8,["modelValue","options"])]),_:1}),a(w,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(D,{modelValue:e.patient.birthdate,"onUpdate:modelValue":t[6]||(t[6]=A=>e.patient.birthdate=A),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:e.today,onIsEstimated:t[7]||(t[7]=A=>e.isBirthdateEstimated=A)},null,8,["modelValue","maxDate"])]),_:1}),a(w,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(N,{modelValue:e.patient.cellPhoneNumber,"onUpdate:modelValue":t[8]||(t[8]=A=>e.patient.cellPhoneNumber=A),allowUnknown:""},null,8,["modelValue"])]),_:1}),a(w,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(R,{modelValue:e.patient.homeVillage,"onUpdate:modelValue":t[9]||(t[9]=A=>e.patient.homeVillage=A),asyncOptions:e.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),a(w,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(R,{modelValue:e.patient.landmark,"onUpdate:modelValue":t[10]||(t[10]=A=>e.patient.landmark=A),asyncOptions:e.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),a($,null,{default:n(()=>[a(y,null,{default:n(()=>[a(v,{color:"primary",onClick:t[11]||(t[11]=A=>e.modal.hide()),slot:"end"},{default:n(()=>t[13]||(t[13]=[k("Close")])),_:1}),a(v,{class:"ion-margin-end",color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>t[14]||(t[14]=[k("Save")])),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const Xa=ne(Ja,[["render",Qa]]),Ka=x({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(e){var R,D;const t=new et,l=e,u=O(W(l.guardians)),d=B(()=>"".concat(u.value?"Add":"Edit"," Guardian Demographics")),b=B(()=>"".concat(u.value?"Edit":"Add"," Guardian")),i=O([]),s=(D=(R=l.guardians)==null?void 0:R.map(f=>({label:"".concat(f.name," (").concat(f.relationshipType,")"),value:f.name,other:f})))!=null?D:[],v=ie({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),V=ie({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:f=>Ee(f)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:f=>Ee(f)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async f=>f.value!=="Unknown"&&wt(f)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});ve(()=>v.guardian.value,f=>{var h,P,$,A,C,r,j,se;V.givenName.value=(P=(h=f==null?void 0:f.other)==null?void 0:h.names.given_name)!=null?P:"",V.familyName.value=(A=($=f==null?void 0:f.other)==null?void 0:$.names.family_name)!=null?A:"",V.cellPhoneNumber.value=(r=(C=f==null?void 0:f.other)==null?void 0:C.phoneNumber)!=null?r:"",V.relation.value=(se=(j=f==null?void 0:f.other)==null?void 0:j.relationshipType)!=null?se:""},{deep:!0,immediate:!0});function y(){u.value=!u.value,v.guardian.value=""}async function g(f){var h,P;await t.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:l.patientId,...f}),await Ze.createRelation(l.patientId,t.getPersonID(),(P=(h=f.relation)==null?void 0:h.value)!=null?P:13)}async function N(f,h){var A,C;const P=h.names.person_id,$={};if(h.names.given_name!==f.given_name&&($.given_name=f.given_name),h.names.family_name!==f.family_name&&($.family_name=f.family_name),h.phoneNumber!==f.cell_phone_number&&($.cell_phone_number=f.cell_phone_number),!W($)){const r=new et;r.setPersonID(P),await r.updatePerson($)}h.relationshipType!==f.relation.label&&await Ze.amendRelation(l.patientId,P,h.id,(C=(A=f.relation)==null?void 0:A.value)!=null?C:13)}const w=async()=>Ne(V,async f=>{!u.value&&!W(v.guardian.value)?await N(f,v.guardian.value.other):await g(f),await F.hide(),q.emit(L.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return _e(async()=>{const f=(await Ze.getRelations()).data;i.value=f.map(h=>({label:h.b_is_to_a,value:h.relationship_type_id,other:h}))}),(f,h)=>{const P=_("ion-title"),$=_("ion-icon"),A=_("ion-button"),C=_("ion-buttons"),r=_("ion-toolbar"),j=_("ion-header"),se=_("ion-content"),ye=_("ion-footer");return I(),M(z,null,[a(j,null,{default:n(()=>[a(r,null,{default:n(()=>[a(P,null,{default:n(()=>[k(oe(d.value),1)]),_:1}),a(C,{slot:"end"},{default:n(()=>[a(A,{onClick:h[0]||(h[0]=G=>m(F).hide())},{default:n(()=>[a($,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),a(se,{class:"ion-padding"},{default:n(()=>[a(m(re),null,{default:n(()=>[a(m(ae),null,{default:n(()=>[u.value?H("",!0):(I(),U(m(T),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(le,{modelValue:v.guardian,"onUpdate:modelValue":h[1]||(h[1]=G=>v.guardian=G),options:m(s)},null,8,["modelValue","options"])]),_:1})),v.guardian.value||u.value?(I(),M(z,{key:1},[a(m(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(Pe,{modelValue:V.givenName,"onUpdate:modelValue":h[2]||(h[2]=G=>V.givenName=G)},null,8,["modelValue"])]),_:1}),a(m(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(Pe,{modelValue:V.familyName,"onUpdate:modelValue":h[3]||(h[3]=G=>V.familyName=G)},null,8,["modelValue"])]),_:1}),a(m(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(Pe,{modelValue:V.cellPhoneNumber,"onUpdate:modelValue":h[4]||(h[4]=G=>V.cellPhoneNumber=G),allowUnknown:""},null,8,["modelValue"])]),_:1}),a(m(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[a(le,{modelValue:V.relation,"onUpdate:modelValue":h[5]||(h[5]=G=>V.relation=G),options:i.value},null,8,["modelValue","options"])]),_:1})],64)):H("",!0)]),_:1})]),_:1})]),_:1}),a(ye,null,{default:n(()=>[a(r,null,{default:n(()=>[m(W)(l.guardians)?H("",!0):(I(),U(A,{key:0,color:"primary",onClick:y,slot:"start"},{default:n(()=>[k(oe(b.value),1)]),_:1})),a(A,{color:"primary",onClick:h[6]||(h[6]=G=>m(F).hide()),slot:"end"},{default:n(()=>h[7]||(h[7]=[k("Close")])),_:1}),a(A,{class:"ion-margin-end",color:"success",onClick:w,slot:"end"},{default:n(()=>h[8]||(h[8]=[k("Save")])),_:1})]),_:1})]),_:1})],64)}}}),Za=x({components:{IonGrid:re,IonRow:ae,IonCol:T,TextInput:Pe},props:{patient:{type:Object,required:!0}},setup(e){const{facility:t}=bt(),l=B(()=>e.patient.getArvNumber()),u=B(()=>!W(l.value)&&l.value!=="Unknown"),d=ie({arvNumber:{value:u.value?l.value.split("-")[2]:"",label:"".concat(u.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async s=>{const v=ue(s,"POSITIVE_INTEGERS");if(v!==null)return v;if(s.value===l.value.split("-")[2])return null;const V=await ze.findByOtherID(4,"".concat(t.code,"-ARV-").concat(s.value));return V.ok?W(V.data)?null:["ARV Number already taken"]:[V.errorMessage||V.clientErrorType||"Unable to determine ARV number with status: ".concat(V.httpStatusResponse)]}}});return{form:d,modal:F,arvNumber:l,facility:t,hasValidARVNumber:u,onFinish:async()=>Ne(d,async s=>{s.arvNumber!==l.value.split("-")[2]&&(u.value?await e.patient.updateARVNumber("".concat(t.code,"-ARV-").concat(s.arvNumber)):await e.patient.createArvNumber("".concat(t.code,"-ARV-").concat(s.arvNumber)),q.emit(L.RELOAD_PATIENT_DATA)),await F.hide()}),voidARV:async()=>{if(await Ie("Are you sure you want to void this ARV Number ".concat(l.value,"?"))){await ke.show("Voiding ARV Number...");try{await ht.voidARVNumber(l.value),await ke.hide(),await F.hide(),q.emit(L.RELOAD_PATIENT_DATA)}catch(v){await ke.hide(),console.log(v)}}}}}});function xa(e,t,l,u,d,b){const i=_("ion-title"),s=_("ion-icon"),v=_("ion-button"),V=_("ion-buttons"),y=_("ion-toolbar"),g=_("ion-header"),N=_("text-input"),w=_("ion-col"),R=_("ion-row"),D=_("ion-grid"),f=_("ion-content"),h=_("ion-footer");return I(),M(z,null,[a(g,null,{default:n(()=>[a(y,null,{default:n(()=>[a(i,null,{default:n(()=>t[3]||(t[3]=[k("ARV NUMBER")])),_:1}),a(V,{slot:"end"},{default:n(()=>[a(v,{onClick:t[0]||(t[0]=P=>e.modal.hide())},{default:n(()=>[a(s,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),a(f,{class:"ion-padding"},{default:n(()=>[a(D,null,{default:n(()=>[a(R,null,{default:n(()=>[a(w,null,{default:n(()=>[a(N,{modelValue:e.form.arvNumber,"onUpdate:modelValue":t[1]||(t[1]=P=>e.form.arvNumber=P),form:e.form,prefix:"".concat(e.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),a(h,{class:"ion-padding-horizontal"},{default:n(()=>[a(y,null,{default:n(()=>[a(v,{color:"primary",onClick:t[2]||(t[2]=P=>e.modal.hide()),slot:"end"},{default:n(()=>t[4]||(t[4]=[k("Close")])),_:1}),e.hasValidARVNumber?(I(),U(v,{key:0,color:"danger",onClick:e.voidARV,slot:"start"},{default:n(()=>t[5]||(t[5]=[k("Void ARV Number")])),_:1},8,["onClick"])):H("",!0),a(v,{color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>t[6]||(t[6]=[k("Save")])),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const en=ne(Za,[["render",xa]]),tn=x({components:{VisitsSummary:Fa,InformationHeader:ja},setup(){const e=jt(),t=parseInt(e.params.patientId.toString())||0,l=O(),u=O(""),d=O([]),b=B(()=>!W(l.value)),i=async()=>{if(t){const g=(await ze.findByID(t)).data;g&&(l.value=new ze(g))}},s=async()=>{d.value=await ma.getGuardianDetails(t)},v=async g=>{await F.show(Xa,{patientService:l.value,attribute:g})},V=async()=>{await F.show(Ka,{patientId:t,guardians:d.value})},y=async()=>{await F.show(en,{patient:l.value})};return q.on(L.RELOAD_PATIENT_DATA,async()=>{await i()}),q.on(L.RELOAD_GUARDIAN_DATA,async()=>{await s()}),_e(async()=>{var N;await i();const g=await((N=l.value)==null?void 0:N.getARTStartDate());u.value=g?gt.toStandardHisDisplayFormat(g):"N/A",await s()}),{patient:l,artStartDate:u,guardians:d,isReady:b,updateDemographics:v,updateGuardian:V,updateARVNumber:y}}});function an(e,t,l,u,d,b){const i=_("information-header"),s=_("ion-col"),v=_("ion-row"),V=_("visits-summary"),y=_("ion-grid");return e.isReady?(I(),U(y,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[a(v,null,{default:n(()=>[a(s,{size:"12"},{default:n(()=>[e.patient?(I(),U(i,{key:0,patient:e.patient,guardians:e.guardians,artStartDate:e.artStartDate,onUpdateARVNumber:e.updateARVNumber,onUpdateGuardian:e.updateGuardian,onUpdatePatient:e.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):H("",!0)]),_:1})]),_:1}),a(v,null,{default:n(()=>[a(s,null,{default:n(()=>[e.patient?(I(),U(V,{key:0,patient:e.patient,startDate:e.artStartDate},null,8,["patient","startDate"])):H("",!0)]),_:1})]),_:1})]),_:1})):H("",!0)}const $n=ne(tn,[["render",an]]);export{$n as default};
