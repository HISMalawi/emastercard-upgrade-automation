!function(){function e(e,t,a){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var l=a.call(e,t||"default");if("object"!=typeof l)return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}System.register(["./Date-legacy-5518fe5a.js","./index-legacy-65d6eaec.js","./patient_service-legacy-b0dedd24.js","./toasts-legacy-4bd31a3d.js","./consultation_service-legacy-ada5ffd1.js","./program_service-legacy-a8007d75.js","./VoidReason-legacy-4b62d04f.js","./his_date-legacy-f6da7b16.js","./DateInput.vue_vue_type_style_index_0_lang-legacy-f3ea58cb.js","./SelectInput-legacy-be04d03d.js","./regimen_service-legacy-778d0a1b.js","./DTFormElements-legacy-8934eb68.js","./encounter_types-legacy-dd9af3d0.js","./form-legacy-a2cb2c0a.js","./emc_event-legacy-58754a45.js","./index-legacy-a4410d47.js","./TextInput-legacy-3c47726e.js","./location_options-legacy-96f34587.js","./validations-legacy-dd101fef.js","./YesNoInput-legacy-8fdcafcb.js","./arrays-legacy-681d874a.js","./loader-legacy-3d9f610c.js","./DrilldownTable-legacy-7c31441b.js","./Strs-legacy-09248991.js","./relations_service-legacy-df02d22e.js","./patient_identifier_service-legacy-4ff17be7.js","./vue-datepicker-legacy-f849676a.js"],(function(t,a){"use strict";var l,n,i,o,r,u,s,d,c,m,v,p,g,f,b,h,_,y,w,D,V,I,N,A,R,P,T,C,S,O,E,k,U,x,L,B,G,H,F,q,M,z,j,$,W,Y,J,Q,K,X,Z,ee,te,ae,le,ne,ie,oe,re,ue,se,de,ce,me,ve,pe,ge,fe,be,he,_e,ye,we,De,Ve,Ie,Ne,Ae,Re,Pe,Te,Ce,Se,Oe,Ee,ke,Ue,xe,Le,Be,Ge,He,Fe,qe,Me,ze,je,$e,We,Ye,Je,Qe,Ke,Xe,Ze;return{setters:[e=>{l=e.D,n=e.H},e=>{i=e.F,o=e.E,r=e.d,u=e.r,s=e.ae,d=e.a6,c=e.a2,m=e.c,v=e.e,p=e.w,g=e.u,f=e.J,b=e.o,h=e.p,_=e.$,y=e.b,w=e.R,D=e.i,V=e.j,I=e.k,N=e.H,A=e.q,R=e.au,P=e.B,T=e.I,C=e.ak,S=e.n,O=e.ai,E=e.G,k=e._,U=e.K,x=e.a,L=e.h,B=e.x,G=e.ax,H=e.t,F=e.ay,q=e.M,M=e.az,z=e.a5,j=e.aA,$=e.l,W=e.a4,Y=e.aB,J=e.aC,Q=e.T,K=e.af,X=e.aw,Z=e.aD},e=>{ee=e.g,te=e.D,ae=e.C,le=e.P,ne=e.O},e=>{ie=e.g,oe=e.i,re=e.a,ue=e.t},e=>{se=e.A,de=e.P,ce=e.V,me=e.C,ve=e.E},e=>{pe=e.P},e=>{ge=e.p},e=>{fe=e.a,be=e.t,he=e.d,_e=e.c},e=>{ye=e._},e=>{we=e.S},e=>{De=e.N,Ve=e.R},e=>{Ie=e.t,Ne=e.a,Ae=e.g},e=>{Re=e.e},e=>{Pe=e.s,Te=e.i,Ce=e.r,Se=e.a},e=>{Oe=e.E,Ee=e.a},e=>{ke=e.D},e=>{Ue=e.T},e=>{xe=e.g,Le=e.a,Be=e.b},e=>{Ge=e.r,He=e.v,Fe=e.d,qe=e.e,Me=e.a,ze=e.b,je=e.c},e=>{$e=e.Y},e=>{We=e.c,Ye=e.u},e=>{Je=e.l},e=>{Qe=e.D},e=>{Ke=e.t},e=>{Xe=e.P,Ze=e.R},null,null],execute:function(){var a=document.createElement("style");a.textContent="ion-label[data-v-7cbaf355]{font-weight:700}ion-checkbox[data-v-7cbaf355]{--size: 20px !important}.title[data-v-b764fd01]{font-weight:700}ion-list[data-v-5306de30]{height:100%}\n",document.head.appendChild(a);const et=e=>{const t=e.given_name,a=e.family_name;return`${t} ${e.middle_name?e.middle_name:""} ${a}`};class tt{static getRelationships(e){return i.getJson(`/people/${e}/relationships`).then((e=>e.data))}static async getGuardianDetails(e){return await this.getRelationships(e).then((e=>e.map((e=>{const t=ie(e,"relation.names[0]");return{id:e.relationship_id,name:t?et(t):"",relationshipType:ie(e,"type.b_is_to_a",""),phoneNumber:ee(ie(e,"relation.person_attributes",[]),12),names:t}}))))}}class at extends se{constructor(e){super(e,Re.LAB_ORDERS,fe())}async loadConcepts(){at.conceptID=await se.getConceptID("HIV Viral Load")}createLabOrder(e,t){const a=i.getUsername(),l=o().facility.name,n=se.getCachedConceptID(t,!0);return i.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:a,target_lab:l,reason_for_test_id:n,encounter_id:this.encounterID,tests:[{concept_id:at.conceptID}],date:this.date,specimen:{concept_id:e}}]})}createLabResult(e,t,a,l="numeric"){return i.postJson(`lab/tests/${e}/results`,{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:at.conceptID},value:t,value_modifier:a,value_type:l}]})}static getSpecimens(e){return i.getJson("/lab/specimen_types",{test_type:e})}static async getOrders(e,t={}){var a;return null!==(a=(await i.getJson("/lab/orders",{patient_id:e,...t})).data)&&void 0!==a?a:[]}static async getViralLoadResultTrail(e,t={}){return(await this.getOrders(e,t)).reduce(((e,t)=>(t.tests.forEach((a=>a.result.forEach((l=>e.push({...t,test:a.name,result:`${l.value_modifier} ${l.value}`,result_date:l.date}))))),e)),[])}static async getlatestViralLoadResult(e,t={}){const a=(await this.getOrders(e,t)).reduce(((e,t)=>(e.push(...t.tests.flatMap((e=>e.result))),e)),[]).sort(((e,t)=>new Date(e.date)>new Date(t.date)?-1:1));return a&&a.length>0?`${a[0].value_modifier}${a[0].value} (${be(a[0].date)})`:"N/A"}}e(at,"conceptID",-1);const lt=r({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(e){const t=e,a=u(!1),l=Ie(["=",">","<",">=","<="]),n=Ie(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),i=u([]),o=t.patient.getBirthdate(),r=s({orderDate:{value:"",label:"Order Date",required:!0,validation:async e=>he(e.value).isValid()?new Date(e.value)>new Date(fe())?["Order date cannot be in the future"]:new Date(e.value)<new Date(o)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(e,t)=>he(e.value).isValid()?new Date(e.value)>new Date(fe())?["Result date cannot be in the future"]:new Date(e.value)<new Date(t.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function E(){Pe(r,(async e=>{const l=new at(t.patient.getID());await l.loadConcepts(),l.setDate(e.orderDate);if(!(await l.createEncounter()))throw new Error("Unable to create lab order encounter");const n=await l.createLabOrder(e.specimen.value,e.reason.value);if(!n.ok||!n.data)throw new Error("Unable to save lab orders");const i=new at(t.patient.getID());i.setDate(e.resultDate);if(!(await i.createEncounter()))throw new Error("Unable to create lab result encounter");const o=a.value?"LDL":parseInt(e.result),r=a.value?"=":e.modifier.value,u=a.value?"text":"numeric",s=n.data[0].tests[0].id;await i.createLabResult(s,o,r,u),await C.hide(),Oe.emit(Ee.RELOAD_LATEST_VL_RESULT),Oe.emit(Ee.RELOAD_PATIENT_VISIT_DATA)}))}async function k(){if(await O("Are you sure you want to clear all fields?")){a.value=!1;for(const e in r)r[e].value="",r[e].error="";Oe.emit(Ee.ON_CLEAR)}}return d(a,(e=>{e&&(r.modifier.value="",r.result.value=void 0,r.modifier.error="",r.result.error=""),r.modifier.disabled=e,r.modifier.required=!e,r.result.disabled=e,r.result.required=!e})),c((async()=>{i.value=(await at.getSpecimens("HIV viral load")).data.map((e=>({label:e.name,value:e.concept_id})))})),(e,t)=>(b(),m(f,null,[v(g(w),null,{default:p((()=>[v(g(h),null,{default:p((()=>[v(g(_),null,{default:p((()=>t[8]||(t[8]=[y("Viral Load Results")]))),_:1})])),_:1})])),_:1}),v(g(P),{class:"ion-padding"},{default:p((()=>[v(g(D),{style:{width:"100%"}},{default:p((()=>[v(g(V),null,{default:p((()=>[v(g(I),{size:"12",class:"ion-margin-vertical"},{default:p((()=>[v(ye,{modelValue:r.orderDate,"onUpdate:modelValue":t[0]||(t[0]=e=>r.orderDate=e),form:r,minDate:g(o),maxDate:g(fe)},null,8,["modelValue","form","minDate","maxDate"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(we,{modelValue:r.reason,"onUpdate:modelValue":t[1]||(t[1]=e=>r.reason=e),options:g(n)},null,8,["modelValue","options"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(we,{modelValue:r.specimen,"onUpdate:modelValue":t[2]||(t[2]=e=>r.specimen=e),options:i.value},null,8,["modelValue","options"])])),_:1}),v(g(I),{size:"12",class:"ion-margin-vertical"},{default:p((()=>[v(ye,{modelValue:r.resultDate,"onUpdate:modelValue":t[3]||(t[3]=e=>r.resultDate=e),form:r,minDate:r.orderDate.value,"max-date":g(fe)},null,8,["modelValue","form","minDate","max-date"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(we,{modelValue:r.modifier,"onUpdate:modelValue":t[4]||(t[4]=e=>r.modifier=e),options:g(l)},null,8,["modelValue","options"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:r.result,"onUpdate:modelValue":t[5]||(t[5]=e=>r.result=e),form:r,min:1},null,8,["modelValue","form"])])),_:1})])),_:1}),v(g(V),{class:"ion-margin-top"},{default:p((()=>[v(g(I),{size:"12"},{default:p((()=>[v(g(N),{class:"ion-padding-vertical bold"},{default:p((()=>t[9]||(t[9]=[y(" Other Results Options: ")]))),_:1}),v(g(A),null,{default:p((()=>[v(g(N),null,{default:p((()=>t[10]||(t[10]=[y("LDL")]))),_:1}),v(g(R),{slot:"start",modelValue:a.value,"onUpdate:modelValue":t[6]||(t[6]=e=>a.value=e)},null,8,["modelValue"])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),v(g(S),null,{default:p((()=>[v(g(h),null,{default:p((()=>[v(g(T),{color:"primary",onClick:t[7]||(t[7]=e=>g(C).hide()),slot:"end"},{default:p((()=>t[11]||(t[11]=[y(" Close ")]))),_:1}),v(g(T),{color:"warning",onClick:k,slot:"end"},{default:p((()=>t[12]||(t[12]=[y(" Reset ")]))),_:1}),v(g(T),{color:"success",onClick:E,slot:"end"},{default:p((()=>t[13]||(t[13]=[y(" Save ")]))),_:1})])),_:1})])),_:1})],64))}}),nt=r({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:ke},emits:["voidOutcome"],setup(e,{emit:t}){const a=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:e=>he(e).format(l)},{path:"end_date",label:"End Date",formatter:e=>he(e).format(l)}];return{rows:E((()=>e.patientStates.map(((e,t)=>({...e,index:t}))))),columns:a,tableConfig:{showSearchField:!1,showSubmitButton:!1},TableRowActions:[{label:"void",color:"danger",action:async e=>{await O("Are you sure you want to void this outcome?")&&t("voidOutcome",{stateId:e.patient_state_id,index:e.index})}}]}}});const it=k(nt,[["render",function(e,t,a,l,n,i){const o=U("data-table");return b(),m(f,null,[t[0]||(t[0]=x("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1)),v(o,{rows:e.rows,columns:e.columns,config:e.tableConfig,"row-actions-buttons":e.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}]]),ot=r({name:"EnrollmentForm",components:{DateInput:ye,IonGrid:D,IonRow:V,IonCol:I,IonButton:T},props:["birthdate"],emits:["enrollProgram"],setup(e,{emit:t}){const a=he().format("YYYY-MM-DD"),l=s({date:{value:"",label:"Date of Enrollment",required:!0,validation:async t=>new Date(t.value)<new Date(e.birthdate)?["Date of enrollment cannot be before date of birth"]:new Date(t.value)>new Date(a)?["Date of enrollment cannot be in the future"]:null}});return{form:l,today:a,onReset:async()=>{await O("Are you sure you want to clear all fields")&&(l.date.value="",l.date.error="",Oe.emit(Ee.ON_CLEAR))},enrollProgram:async()=>Pe(l,(({date:e})=>t("enrollProgram",e)))}}});const rt=k(ot,[["render",function(e,t,a,l,n,i){const o=U("DateInput"),r=U("ion-col"),u=U("ion-button"),s=U("ion-row"),d=U("ion-grid");return b(),L(d,null,{default:p((()=>[v(s,null,{default:p((()=>[v(r,{size:"12"},{default:p((()=>[v(o,{modelValue:e.form.date,"onUpdate:modelValue":t[0]||(t[0]=t=>e.form.date=t),form:e.form,minDate:e.birthdate,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])])),_:1}),v(r,null,{default:p((()=>[v(u,{color:"warning",onClick:e.onReset},{default:p((()=>t[1]||(t[1]=[y("Reset")]))),_:1},8,["onClick"]),v(u,{color:"success",onClick:e.enrollProgram},{default:p((()=>t[2]||(t[2]=[y("Enroll")]))),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})}]]),ut=r({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:ye,IonGrid:D,IonRow:V,IonCol:I,IonButton:T,SelectInput:we,TextInput:Ue},emits:["saveOutcome"],setup(e,{emit:t}){const a=he().format("YYYY-MM-DD"),n=s({date:{value:"",label:"Outcome Date",required:!0,validation:async t=>new Date(t.value)<new Date(e.birthdate)?[`Outcome date cannot be before date of birth - ${he(e.birthdate).format(l)}`]:new Date(t.value)<new Date(e.dateEnrolled)?[`Outcome date cannot be before enrollment date- ${he(e.dateEnrolled).format(l)}`]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(e,t)=>"Patient transferred out"===t.status.value.label&&Ge(e)},reason:{value:"",label:"Reason for transfer out",validation:async(e,t)=>"Patient transferred out"===t.status.value.label&&Ge(e)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(e,t)=>{var a,l;return"Patient transferred out"===(null===(a=t.status)||void 0===a||null===(a=a.value)||void 0===a?void 0:a.label)&&"Other"===(null===(l=t.reason)||void 0===l||null===(l=l.value)||void 0===l?void 0:l.label)&&Ge(e)}}}),i=E((()=>{var e;return"Patient transferred out"===(null===(e=n.status.value)||void 0===e?void 0:e.label)})),o=E((()=>{var e;return"Other"===(null===(e=n.reason)||void 0===e||null===(e=e.value)||void 0===e?void 0:e.label)}));return{form:n,today:a,isTransferredOut:i,specifyOther:o,onSave:()=>Pe(n,(e=>t("saveOutcome",{...e,isTransferredOut:i.value}))),onReset:async()=>{if(await O("are you sure you want to clear all fields")){for(const e in n)n[e].value="",n[e].error="";Oe.emit(Ee.ON_CLEAR)}},getFacilities:xe,transferOutReasons:Ne}}});const st=r({components:{IonContent:P,IonFooter:S,IonHeader:w,IonTitle:_,IonToolbar:h,IonButton:T,IonGrid:D,IonRow:V,IonCol:I,IonBadge:G,OutcomesTable:it,EnrollmentForm:rt,OutcomeForm:k(ut,[["render",function(e,t,a,l,n,i){const o=U("ion-col"),r=U("DateInput"),u=U("SelectInput"),s=U("text-input"),d=U("ion-button"),c=U("ion-row"),g=U("ion-grid");return b(),L(g,null,{default:p((()=>[v(c,null,{default:p((()=>[v(o,{size:"12"},{default:p((()=>t[5]||(t[5]=[x("p",null,"Add New Outcome",-1)]))),_:1}),v(o,{size:"6",class:"ion-margin-top-vertical"},{default:p((()=>[v(r,{modelValue:e.form.date,"onUpdate:modelValue":t[0]||(t[0]=t=>e.form.date=t),form:e.form,minDate:e.dateEnrolled,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])])),_:1}),v(o,{size:"6",class:"ion-margin-top-vertical"},{default:p((()=>[v(u,{modelValue:e.form.status,"onUpdate:modelValue":t[1]||(t[1]=t=>e.form.status=t),form:e.form,options:e.outcomes},null,8,["modelValue","form","options"])])),_:1}),e.isTransferredOut?(b(),m(f,{key:0},[v(o,{size:"6",class:"ion-margin-top-vertical"},{default:p((()=>[v(u,{modelValue:e.form.nextFacility,"onUpdate:modelValue":t[2]||(t[2]=t=>e.form.nextFacility=t),form:e.form,asyncOptions:e.getFacilities},null,8,["modelValue","form","asyncOptions"])])),_:1}),v(o,{size:"6",class:"ion-margin-top-vertical"},{default:p((()=>[v(u,{modelValue:e.form.reason,"onUpdate:modelValue":t[3]||(t[3]=t=>e.form.reason=t),form:e.form,options:e.transferOutReasons},null,8,["modelValue","form","options"])])),_:1}),e.specifyOther?(b(),L(o,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:p((()=>[v(s,{modelValue:e.form.otherReason,"onUpdate:modelValue":t[4]||(t[4]=t=>e.form.otherReason=t),form:e.form},null,8,["modelValue","form"])])),_:1})):B("",!0)],64)):B("",!0),v(o,{size:"12",class:"ion-margin-top"},{default:p((()=>[v(d,{color:"warning",onClick:e.onReset},{default:p((()=>t[6]||(t[6]=[y("Reset")]))),_:1},8,["onClick"]),v(d,{color:"success",onClick:e.onSave},{default:p((()=>t[7]||(t[7]=[y("Save")]))),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})}]])},props:{patient:{type:Object,required:!0}},setup(e){const{toStandardHisDisplayFormat:t,toStandardHisFormat:a}=n,l=new de(e.patient.getID()),i=E((()=>a(e.patient.getBirthdate()))),o=u(),r=E((()=>!oe(o.value))),s=u(""),d=u(),m=E((()=>{var e,t;return null!==(e=null===(t=o.value)||void 0===t||null===(t=t.patient_states)||void 0===t?void 0:t.length)&&void 0!==e?e:0})),v=E((()=>r.value&&s.value?`Patient enrolled in this porgram on ${t(s.value)}`:"Patient is not enrolled in this program"));return c((async()=>{const e=(await l.getPrograms()).data;if(o.value=e.find((e=>"HIV PROGRAM"===e.program.name)),o.value){s.value=o.value.date_enrolled;const e=await l.getProgramOutcomes(),t=new Set(l.removedStates);d.value=e.map((e=>({label:e.name,value:e.program_workflow_state_id,other:e}))).filter((e=>!t.has(e.label)))}})),{modal:C,patientProgram:l,isEnrolled:r,enrollDate:s,birthdate:i,enrollmentStatus:v,outcomes:d,program:o,totalStates:m,toStandardHisDisplayFormat:t,saveOutcome:async({date:e,status:t,nextFacility:a,reason:n,otherReason:i,isTransferredOut:o})=>{if(l.setStateDate(e),l.setStateId(t.value),o){const e="Other"!==n.value?n.value:i;await l.transferOutEncounter(a.other,e)}await l.updateState(),await re("Outcome saved successfully",1e3),await C.hide(),Oe.emit(Ee.RELOAD_PATIENT_VISIT_DATA)},enrollProgram:async e=>{l.setProgramDate(e),await l.enrollProgram(),await re("Program enrolled successfully",1e3),await C.hide(),Oe.emit(Ee.RELOAD_PATIENT_VISIT_DATA)},voidProgram:async()=>{var e;l.setPatientProgramId((null===(e=o.value)||void 0===e?void 0:e.patient_program_id)||-1),await l.voidProgram("duplicate / system error"),await re("Patient voided from program successfully",1e3),await C.hide(),Oe.emit(Ee.RELOAD_PATIENT_VISIT_DATA)},voidOutcome:async({stateId:e,index:t})=>{var a;l.setStateId(e),await l.voidState("duplicate / system error"),re("Outcome voided successfully"),null===(a=o.value)||void 0===a||a.patient_states.splice(t,1),Oe.emit(Ee.RELOAD_PATIENT_VISIT_DATA)}}}});const dt=k(st,[["render",function(e,t,a,l,n,i){const o=U("ion-title"),r=U("ion-toolbar"),u=U("ion-header"),s=U("ion-badge"),d=U("ion-col"),c=U("ion-row"),g=U("enrollment-form"),h=U("outcome-form"),_=U("outcomes-table"),w=U("ion-grid"),D=U("ion-content"),V=U("ion-button"),I=U("ion-footer");return b(),m(f,null,[v(u,null,{default:p((()=>[v(r,null,{default:p((()=>[v(o,null,{default:p((()=>t[1]||(t[1]=[y("Patient Outcomes")]))),_:1})])),_:1})])),_:1}),v(D,null,{default:p((()=>[v(w,{style:{width:"100%"}},{default:p((()=>[v(c,null,{default:p((()=>[v(d,null,{default:p((()=>[v(s,{color:"lightblue",class:"ion-padding",style:{width:"100%"},disabled:""},{default:p((()=>[y(H(e.enrollmentStatus),1)])),_:1})])),_:1})])),_:1}),e.isEnrolled?(b(),m(f,{key:1},[e.outcomes?(b(),L(c,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:p((()=>[v(h,{"date-enrolled":e.enrollDate,birthdate:e.birthdate,outcomes:e.outcomes,onSaveOutcome:e.saveOutcome},null,8,["date-enrolled","birthdate","outcomes","onSaveOutcome"])])),_:1})):B("",!0),v(c,{class:"his-card",style:F({minHeight:e.totalStates?"0":"30vh"})},{default:p((()=>[v(d,{size:"12",class:"ion-no-padding"},{default:p((()=>{var t;return[v(_,{patientStates:null===(t=e.program)||void 0===t?void 0:t.patient_states,onVoidOutcome:e.voidOutcome},null,8,["patientStates","onVoidOutcome"])]})),_:1})])),_:1},8,["style"])],64)):(b(),L(c,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:p((()=>[v(d,{size:"12"},{default:p((()=>[v(g,{patientProgram:e.patientProgram,birthdate:e.birthdate,onEnrollProgram:e.enrollProgram},null,8,["patientProgram","birthdate","onEnrollProgram"])])),_:1})])),_:1}))])),_:1})])),_:1}),v(I,null,{default:p((()=>[v(r,null,{default:p((()=>[v(V,{color:"primary",onClick:t[0]||(t[0]=t=>e.modal.hide()),slot:"end"},{default:p((()=>t[2]||(t[2]=[y("Close")]))),_:1}),e.isEnrolled?(b(),L(V,{key:0,color:"danger",onClick:e.voidProgram,slot:"end"},{default:p((()=>t[3]||(t[3]=[y("Void Program")]))),_:1},8,["onClick"])):B("",!0)])),_:1})])),_:1})],64)}]]),ct=r({name:"MultiColumnView",components:{IonGrid:D,IonRow:V,IonCol:I},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup:e=>({computedItems:E((()=>We(e.items,Math.ceil(e.items.length/e.numberOfColumns)))),grid:{1:"12",2:"6",3:"4",4:"3",6:"2"}})});const mt=k(ct,[["render",function(e,t,a,l,n,i){const o=U("ion-col"),r=U("ion-row"),u=U("ion-grid");return b(),L(u,null,{default:p((()=>[v(r,null,{default:p((()=>[(b(!0),m(f,null,q(e.computedItems,((t,a)=>(b(),L(o,{key:a,size:e.grid[e.numberOfColumns]},{default:p((()=>[M(e.$slots,"default",{entries:t})])),_:2},1032,["size"])))),128))])),_:3})])),_:3})}]]);class vt extends se{constructor(e,t=fe()){super(e,Re.HIV_RECEPTION,t)}}class pt extends se{constructor(e,t=fe()){super(e,Re.ART_ADHERENCE,t)}buildPillCountObs(e,t){return this.buildValueNumber("Number of tablets brought to clinic",t,null,e)}async buildAdherenceObs(e,t,a){return{concept_id:await se.getConceptID("Drug adherence",!0),value_numeric:a,value_drug:t,value_modifier:"%",order_id:e,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(e,t,a){return Math.round(100*(e-t)/(e-a))}calculateExpected(e,t,a,l){const n="QW"===l?"week":"day";return e-this.calcTimeElapsed(a,n)*parseFloat(t.toString())}calcTimeElapsed(e,t){return he(this.date).diff(e,t)+1}}class gt extends se{constructor(e,t=fe()){super(e,Re.APPOINTMENT,t)}}class ft extends se{constructor(e,t=fe()){super(e,Re.TREATMENT,t)}calculateDosage(e,t){let a=0;return 0===t&&(a=e),0==e&&(a=t),e>0&&t>0&&(a=(e+t)/2),a}calculateEquivalentDosage(e,t){return e+t}calculateDrugRunOutDate(e,t){return _e(he(t).add(e,"days"))}getInstructions(e,t,a,l){return`${e} :- Morning: ${t} ${l}, Evening: ${a} ${l}`}toDrugOrder(e,t,a,l){return{drug_inventory_id:e.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(e.am,e.pm),start_date:l,auto_expire_date:this.calculateDrugRunOutDate(a,l),units:e.units,instructions:this.getInstructions(e.drug_name,e.am,e.pm,e.units),dose:this.calculateDosage(e.am,e.pm),frequency:e.frequency,qty:t}}async createDrugOrder(e){return te.create({encounter_id:this.encounterID,drug_orders:e})}}class bt{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(e,t,a){let l={result:"",color:"",index:a};if(a<=0)return l.index=0,l;if(t<5&&t>0)l.result="Use MUAC to calculate nutrition status",l.color="red";else{t>18&&(t=19);const n=await this.getBMIData(),i=n[e][t];i&&(l=this.buildBounds(Object.keys(i),i,a,n.colors))}return l}static buildBounds(e,t,a,l){const n={result:"",color:"",index:a};return e.forEach((e=>{if(e.indexOf("-")>=0){const i=e.split("-");a>=parseFloat(i[0])&&a<=parseFloat(i[1])&&(n.result=t[e],n.color=l[t[e]])}else if(e.indexOf("<")>=0){const i=e.replace("<","");a<parseFloat(i)&&(n.result=t[e],n.color=l[t[e]])}else if(e.indexOf(">=")>=0){const i=e.replace(">=","");a>=parseFloat(i)&&(n.result=t[e],n.color=l[t[e]])}})),n}static getBMI(e,t,a,l){const n=this.calculateBMI(e,t);return this.getBMIResult(a,l,n)}static calculateBMI(e,t){if(0==t||0==e)return 0;let a=e/t/t*1e4;return Math.round(10*a)/10}}class ht extends se{constructor(e,t=fe()){super(e,Re.DISPENSING,t)}buildDispensations(e,t,a){const l=[];for(let n=0;n<a;n++)l.push({drug_order_id:e,date:this.date,quantity:t/a});return l}saveDispensations(e){return i.postJson("/dispensations",{dispensations:e,program_id:this.programID})}}const _t=k(r({__name:"PatientVisit",props:{patient:{type:Object,required:!0}},setup(e){const t=e,a=E((()=>t.patient.getID())),l=new ce(a.value),n=new me(a.value),i=new ft(a.value),o=new ht(a.value),r=new vt(a.value),k=new pt(a.value),U=new gt(a.value),x=u(),G=u(),F=u([]),M=u([]),z=u([]),j=u([]),$=E((()=>!(x.value&&t.patient.getAge()>18))),W=E((()=>t.patient.isFemale())),Y=u(""),J=t.patient.getBirthdate(),Q=u(!1),K=s({}),X=s({visitDate:{value:he().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async e=>new Date(e.value)>new Date(fe())?["Visit date cannot be after today's date"]:new Date(e.value)<new Date(J)?["Visit date cannot be before patient's birth date"]:null},weight:{value:void 0,label:"Weight",required:!0,computedValue:e=>({tag:"vitals",obs:l.buildValueNumber("Weight",e)}),validation:(e,t)=>!oe(e)&&e.value||"No"!==t.patientPresent.value?He([()=>Ge(e),()=>Fe(e,"DECIMALS"),()=>qe(e,2,250)]):null},height:{value:void 0,label:"Height",computedValue:e=>({tag:"vitals",obs:l.buildValueNumber("Height",e)}),validation:e=>$.value&&(!oe(e)&&e.value||"No"!==X.patientPresent.value)?He([()=>Ge(e),()=>Fe(e),()=>qe(e,20,220)]):null},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:W.value,computedValue:e=>({tag:"consultation",obs:n.buildValueCoded("Is patient pregnant",e)}),validation:async e=>W.value&&Ge(e)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:W.value,computedValue:e=>({tag:"consultation",obs:n.buildValueCoded("Is patient breast feeding",e)}),validation:async e=>W.value&&Ge(e)},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:e=>({tag:"appointment",obs:U.buildValueDate("Appointment date",e)}),validation:async(e,t)=>new Date(e.value)<new Date(t.visitDate.value)?["Appointment date cannot be before visit date"]:new Date(e.value)>new Date(Y.value)?["Appointment date cannot be after drug run out date"]:null},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:e=>({tag:"reception",obs:r.buildValueCoded("Patient present",e)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:e=>({tag:"reception",obs:r.buildValueCoded("Guardian present",e)})},pillCount:{value:void 0,label:"Pill Count",required:j.value.length>0,validation:async e=>j.value.length>0&&Fe(e)},regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:i.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:i.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:i.buildValueCoded("Medication orders","INH")}),validation:async(e,t)=>{var a,l;return("6H"===(null===(a=t.tbMed.value)||void 0===a?void 0:a.label)||"3HP (RFP + INH)"===(null===(l=t.tbMed.value)||void 0===l?void 0:l.label))&&Fe(e)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:i.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(e,t)=>{var a;return"3HP (RFP + INH)"===(null===(a=t.tbMed.value)||void 0===a?void 0:a.label)&&Fe(e)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:i.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(e,t)=>{var a;return"3HP (INH 300 / RFP 300)"===(null===(a=t.tbMed.value)||void 0===a?void 0:a.label)&&Fe(e)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(e,t)=>{var a;return(null===(a=t.tbMed.value)||void 0===a?void 0:a.label)&&Fe(e)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async e=>He([()=>Ge(e),()=>"No"===e.value||M.value.some((e=>e.isChecked))?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async e=>He([()=>Ge(e),()=>"No"===e.value||z.value.some((e=>e.isChecked))?null:["Please select at least one side effect"]])},tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:e=>({tag:"consultation",obs:n.buildValueCoded("TB Status",e.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async e=>{if(!Q.value){if(new Date(e.value)>new Date(fe()))return["TB treatment start date cannot be after today's date"];if(new Date(e.value)<new Date(J))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:e=>({tag:"consultation",obs:n.buildValueDate("TB treatment start date",e)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:e=>({tag:"consultation",obs:n.buildValueNumber("TB treatment period",e)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:e=>({tag:"consultation",obs:n.buildGroupValueCoded("TB screening method used","chest xray",e)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:e=>({tag:"consultation",obs:n.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",e)})}}),Z=async(e,t)=>{const a={label:"Unkown",value:"Unkown",other:[{drug_id:1046,drug_name:"Unknown ARV",am:1,pm:0,units:"",frequency:"Daily (QOD)"}]},l=(await Ve.getRegimensByWeight(e,t)).data;return oe(l)?[a]:Object.keys(l).map((e=>({label:e,value:e,other:l[e]}))).concat([a])};d((()=>X.regimen.value),(e=>{var t;(xe(),e)&&(null==e||null===(t=e.other)||void 0===t||t.forEach((e=>{var t;K[e.drug_name]={label:`${null!==(t=e.alternative_drug_name)&&void 0!==t?t:e.drug_name} given`,value:0,required:!0,validation:e=>Fe(e,"POSITIVE_INTEGERS")}})))})),d(X.patientPresent,(e=>{"No"===e.value?(X.weight.required=!1,X.weight.error="",X.guardianPresent.value="Yes"):X.weight.required=!0})),d(X.guardianPresent,(e=>{"No"===e.value&&(X.patientPresent.value="Yes")})),d([()=>X.weight.value,()=>X.tbStatus.value],(async([e,t])=>{var a;X.regimen.value=void 0,xe();const l=Q.value||/confirmed/i.test(null!==(a=null==t?void 0:t.label)&&void 0!==a?a:"");e?(F.value=await Z(X.weight.value,l),X.patientPresent.value="Yes",X.patientPresent.disabled=!0):!e&&X.weight.required&&(X.patientPresent.value=void 0,X.patientPresent.disabled=!1),X.tbMed.disabled=l}));const ee=()=>{var e;return oe(K)?1/0:Math.min(...null===(e=X.regimen.value)||void 0===e||null===(e=e.other)||void 0===e?void 0:e.map((e=>{var t,a,l,n,i;return(null!==(t=null===(a=K[e.drug_name])||void 0===a?void 0:a.value)&&void 0!==t?t:0)/((null!==(l=e.am)&&void 0!==l?l:0)+(null!==(n=e.noon)&&void 0!==n?n:0)+(null!==(i=e.pm)&&void 0!==i?i:0))||1})))};d([()=>K,()=>X.pillCount.value,()=>X.visitDate.value],(()=>{const e=parseInt(X.pillCount.value)||0,t=ee();t!==1/0&&(Y.value=i.calculateDrugRunOutDate(t+e,X.visitDate.value),X.nextAppointmentDate.label=`Next Appointment Date (Drug run out date: ${be(Y.value)})`,X.nextAppointmentDate.value=Y.value)}),{deep:!0}),d((()=>X.visitDate.value),(()=>Re()));const le=E((()=>{var e;return"3HP (INH 300 / RFP 300)"===(null===(e=X.tbMed.value)||void 0===e?void 0:e.label)})),ne=E((()=>{var e;return"3HP (RFP + INH)"===(null===(e=X.tbMed.value)||void 0===e?void 0:e.label)})),ie=E((()=>{var e;return"6H"===(null===(e=X.tbMed.value)||void 0===e?void 0:e.label)})),se=E((()=>"Yes"===X.hasContraindications.value)),de=E((()=>"Yes"===X.hasSideEffects.value)),ve=E((()=>{var e;return/Confirmed TB on treatment/i.test(null===(e=X.tbStatus.value)||void 0===e?void 0:e.label)})),pe=E((()=>{var e;return/Suspected/i.test(null===(e=X.tbStatus.value)||void 0===e?void 0:e.label)})),ge=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],_e=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Ne=Ie(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),Ae=Ie(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),Re=async()=>{n.setDate(X.visitDate.value),Q.value=!1;const e=await n.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(e)){const e=await n.getFirstValueDatetime("TB treatment start date"),t=await n.getFirstValueNumber("TB treatment period")||6;if(e){const a=he(X.visitDate.value).diff(e,"months");Q.value=a<=t}}X.tbStatus.required=!Q.value},ke=async()=>{l.setDate(X.visitDate.value),n.setDate(X.visitDate.value),i.setDate(X.visitDate.value),r.setDate(X.visitDate.value),k.setDate(X.visitDate.value),U.setDate(X.visitDate.value),o.setDate(X.visitDate.value),await Pe(X,(async(e,t)=>{var a;const u=[];let s=0;if(!oe(e.regimen)&&await Te(K)){const t=e.regimen.other,a=Ce(K).formData;s=ee(),t.forEach((t=>u.push(i.toDrugOrder(t,a[t.drug_name],s,e.visitDate))))}else{if(!(await O("Are you sure you want to continue without dispensing ART drugs?")))return}var d;(Je.show("Saving patient visit..."),e.totalCPTGiven)&&Ye((await Ve.getRegimenExtras("Cotrimoxazole",null!==(d=e.weight)&&void 0!==d?d:G.value)).data,"concept_name").filter((e=>"Daily (QOD)"===e.frequency)).forEach((t=>u.push(i.toDrugOrder(t,e.totalCPTGiven,s,e.visitDate))));if(null!==(a=e.tbMed)&&void 0!==a&&a.value){var c;const t=Ye((await Ve.getRegimenExtras("INH",null!==(c=e.weight)&&void 0!==c?c:G.value)).data,["concept_name","frequency"]),a=t.find((e=>"Pyridoxine"===e.concept_name));if(a&&e.totalPyridoxineGiven&&u.push(i.toDrugOrder(a,e.totalPyridoxineGiven,s,e.visitDate)),e.totalIPTGiven){const a=t.find((e=>"Isoniazid"===e.concept_name&&(ie.value&&"Daily (QOD)"===e.frequency||ne.value&&"Weekly (QW)"===e.frequency)));u.push(i.toDrugOrder(a,e.totalIPTGiven,s,e.visitDate))}if(e.totalRFPGiven&&ne.value){var m;const t=(await Ve.getRegimenExtras("Rifapentine",null!==(m=e.weight)&&void 0!==m?m:G.value)).data;t.length&&u.push(i.toDrugOrder(t[0],e.totalRFPGiven,s,e.visitDate))}if(e.total3HPGiven&&le.value){var v;const t=(await Ve.getRegimenExtras("INH / RFP",null!==(v=e.weight)&&void 0!==v?v:G.value)).data;u.push(i.toDrugOrder(t[0],e.total3HPGiven,s,e.visitDate))}}if(!oe(u)){await i.createEncounter();const e=(await i.createDrugOrder(u)).data.map((e=>{const t=u.find((t=>t.drug_inventory_id===e.drug_inventory_id));return o.buildDispensations(e.order_id,t.qty,1)}));await o.saveDispensations(e.flat(1))}const p=await Se(t,"vitals");if(!oe(p)){await l.createEncounter();const t=await(async e=>{const t=e.height||x.value,a=bt.calculateBMI(e.weight,t);return l.buildValueNumber("BMI",a)})(e);await l.saveObservationList([...p,t])}await n.createEncounter();const g=await Se(t,"consultation");g.push(...await n.buildOptionsGroupObs("Malawi ART side effects",M.value)),g.push(...await(async()=>Promise.all(ae.getConceptsByCategory("tb_symptom",!0).map((async e=>n.buildGroupValueCoded(e.name,e.name,"No")))))()),de.value&&g.push(...await n.buildOptionsGroupObs("Other side effect",z.value)),W.value&&g.push(...await(async()=>{const e=[await n.buildValueCoded("Patient using family planning","No")];return n.getFamilyPlanningMethods().forEach((async t=>{e.push(await n.buildValueCoded(t,"No"))})),e})()),await n.saveObservationList(g),await r.createEncounter();const f=await Se(t,"reception");if(await r.saveObservationList(f),j.value.length>0){await k.createEncounter();const t=await Promise.all(j.value.map((async t=>{const a=k.calculateExpected(t.quantity,t.equivalent_daily_dose,t.order.start_date,t.frequency),l=k.calculateAdherence(t.quantity,e.pillCount,a);return[await k.buildAdherenceObs(t.order_id,t.drug_inventory_id,l),await k.buildPillCountObs(t.order_id,e.pillCount)]})));await k.saveObservationList(t.flat(1))}await U.createEncounter();const b=await Se(t,"appointment");await U.saveObservationList(b),await re("Patient visit saved successfully"),await C.hide(),Je.hide(),Oe.emit(Ee.RELOAD_PATIENT_VISIT_DATA),Oe.emit(Ee.RELOAD_STAGING_INFORMATION)}),{showloader:!1})},Ue=async()=>{if(await O("Are you sure you want to clear all fields?")){for(const e in X)X[e].value="",X[e].error="",X[e].disabled=!1;xe(),Oe.emit(Ee.ON_CLEAR)}},xe=()=>{for(const e in K)delete K[e]};return c((async()=>{try{await Re(),x.value=await t.patient.getRecentHeight(),G.value=await t.patient.getRecentWeight(),G.value&&(F.value=await Z(G.value)),j.value=(await te.getLastDrugsReceived(t.patient.getID())).data,X.pillCount.required=j.value.length>0,M.value=ae.getConceptsByCategory("contraindication",!0).map((e=>({value:e.concept_id,label:e.name,other:e}))),z.value=ae.getConceptsByCategory("side_effect",!0).map((e=>({value:e.concept_id,label:e.name,other:e})))}catch(e){ue("Form initialization failed. Try to refresh the page"),console.error(e)}})),(e,t)=>(b(),m(f,null,[v(g(w),null,{default:p((()=>[v(g(h),null,{default:p((()=>[v(g(_),null,{default:p((()=>t[24]||(t[24]=[y("Patient Visit")]))),_:1})])),_:1})])),_:1}),v(g(P),{class:"ion-padding"},{default:p((()=>[v(g(D),{style:{width:"100%"}},{default:p((()=>[v(g(V),null,{default:p((()=>[v(g(I),{size:"12",class:"ion-margin-vertical"},{default:p((()=>[v(ye,{modelValue:X.visitDate,"onUpdate:modelValue":t[0]||(t[0]=e=>X.visitDate=e),form:X,minDate:g(J),maxDate:g(fe)},null,8,["modelValue","form","minDate","maxDate"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v($e,{modelValue:X.patientPresent,"onUpdate:modelValue":t[1]||(t[1]=e=>X.patientPresent=e),inline:"",disabled:X.patientPresent.disabled},null,8,["modelValue","disabled"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v($e,{modelValue:X.guardianPresent,"onUpdate:modelValue":t[2]||(t[2]=e=>X.guardianPresent=e),inline:""},null,8,["modelValue"])])),_:1}),W.value?(b(),m(f,{key:0},[v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v($e,{modelValue:X.isPregnant,"onUpdate:modelValue":t[3]||(t[3]=e=>X.isPregnant=e),inline:""},null,8,["modelValue"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v($e,{modelValue:X.isBreastfeeding,"onUpdate:modelValue":t[4]||(t[4]=e=>X.isBreastfeeding=e),inline:""},null,8,["modelValue"])])),_:1})],64)):B("",!0),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v($e,{modelValue:X.hasContraindications,"onUpdate:modelValue":t[5]||(t[5]=e=>X.hasContraindications=e),inline:""},null,8,["modelValue"]),se.value?(b(),L(mt,{key:0,items:M.value,numberOfColumns:2},{default:p((({entries:e})=>[(b(!0),m(f,null,q(e,(e=>(b(),L(g(A),{lines:"none",key:e.value},{default:p((()=>[v(g(N),null,{default:p((()=>[y(H(e.label),1)])),_:2},1024),v(g(R),{slot:"start",modelValue:e.isChecked,"onUpdate:modelValue":t=>e.isChecked=t},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)))),128))])),_:1},8,["items"])):B("",!0)])),_:1}),v(g(I),{class:"ion-margin-vertical",size:"6"},{default:p((()=>[v($e,{modelValue:X.hasSideEffects,"onUpdate:modelValue":t[6]||(t[6]=e=>X.hasSideEffects=e),inline:""},null,8,["modelValue"]),de.value?(b(),L(mt,{key:0,items:z.value,numberOfColumns:2},{default:p((({entries:e})=>[(b(!0),m(f,null,q(e,(e=>(b(),L(g(A),{lines:"none",key:e.value},{default:p((()=>[v(g(N),null,{default:p((()=>[y(H(e.label),1)])),_:2},1024),v(g(R),{slot:"start",modelValue:e.isChecked,"onUpdate:modelValue":t=>e.isChecked=t},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)))),128))])),_:1},8,["items"])):B("",!0)])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:X.weight,"onUpdate:modelValue":t[7]||(t[7]=e=>X.weight=e),form:X,min:1},null,8,["modelValue","form"])])),_:1}),$.value?(b(),L(g(I),{key:1,size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:X.height,"onUpdate:modelValue":t[8]||(t[8]=e=>X.height=e),form:X,min:1},null,8,["modelValue","form"])])),_:1})):B("",!0),Q.value?B("",!0):(b(),L(g(I),{key:2,class:"ion-margin-vertical",size:$.value?"12":"6"},{default:p((()=>[v(we,{modelValue:X.tbStatus,"onUpdate:modelValue":t[9]||(t[9]=e=>X.tbStatus=e),options:g(Ae)},null,8,["modelValue","options"])])),_:1},8,["size"])),ve.value?(b(),m(f,{key:3},[v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(ye,{modelValue:X.tbTreatmentStartDate,"onUpdate:modelValue":t[10]||(t[10]=e=>X.tbTreatmentStartDate=e),form:X,minDate:g(J),maxDate:g(fe)},null,8,["modelValue","form","minDate","maxDate"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:X.tbTreatmentPeriod,"onUpdate:modelValue":t[11]||(t[11]=e=>X.tbTreatmentPeriod=e),form:X,min:1},null,8,["modelValue","form"])])),_:1})],64)):pe.value?(b(),m(f,{key:4},[v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v($e,{modelValue:X.cxrResult,"onUpdate:modelValue":t[12]||(t[12]=e=>X.cxrResult=e),"custom-options":ge},null,8,["modelValue"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v($e,{modelValue:X.mwrdResult,"onUpdate:modelValue":t[13]||(t[13]=e=>X.mwrdResult=e),"custom-options":_e},null,8,["modelValue"])])),_:1})],64)):B("",!0),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(we,{modelValue:X.regimen,"onUpdate:modelValue":t[14]||(t[14]=e=>X.regimen=e),options:F.value},null,8,["modelValue","options"])])),_:1}),g(oe)(K)?B("",!0):(b(!0),m(f,{key:5},q(Object.values(K),((e,t)=>(b(),L(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{"model-value":e,form:K,min:1},null,8,["model-value","form"])])),_:2},1024)))),256)),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:X.totalCPTGiven,"onUpdate:modelValue":t[15]||(t[15]=e=>X.totalCPTGiven=e),form:X,min:1},null,8,["modelValue","form"])])),_:1}),v(g(I),{size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(we,{modelValue:X.tbMed,"onUpdate:modelValue":t[16]||(t[16]=e=>X.tbMed=e),options:g(Ne)},null,8,["modelValue","options"])])),_:1}),ie.value||ne.value?(b(),L(g(I),{key:6,size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:X.totalIPTGiven,"onUpdate:modelValue":t[17]||(t[17]=e=>X.totalIPTGiven=e),form:X,min:1},null,8,["modelValue","form"])])),_:1})):B("",!0),ne.value?(b(),L(g(I),{key:7,size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:X.totalRFPGiven,"onUpdate:modelValue":t[18]||(t[18]=e=>X.totalRFPGiven=e),form:X,min:1},null,8,["modelValue","form"])])),_:1})):B("",!0),le.value?(b(),L(g(I),{key:8,size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:X.total3HPGiven,"onUpdate:modelValue":t[19]||(t[19]=e=>X.total3HPGiven=e),form:X,min:1},null,8,["modelValue","form"])])),_:1})):B("",!0),le.value||ne.value||ie.value?(b(),L(g(I),{key:9,size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:X.totalPyridoxineGiven,"onUpdate:modelValue":t[20]||(t[20]=e=>X.totalPyridoxineGiven=e),form:X,min:1},null,8,["modelValue","form"])])),_:1})):B("",!0),j.value.length>0?(b(),L(g(I),{key:10,size:"6",class:"ion-margin-vertical"},{default:p((()=>[v(De,{modelValue:X.pillCount,"onUpdate:modelValue":t[21]||(t[21]=e=>X.pillCount=e),form:X,min:1},null,8,["modelValue","form"])])),_:1})):B("",!0),v(g(I),{size:j.value.length>0?"6":"12",class:"ion-margin-vertical"},{default:p((()=>[v(ye,{modelValue:X.nextAppointmentDate,"onUpdate:modelValue":t[22]||(t[22]=e=>X.nextAppointmentDate=e),form:X,minDate:X.visitDate.value,maxDate:Y.value},null,8,["modelValue","form","minDate","maxDate"])])),_:1},8,["size"])])),_:1})])),_:1})])),_:1}),v(g(S),null,{default:p((()=>[v(g(h),null,{default:p((()=>[v(g(T),{color:"primary",onClick:t[23]||(t[23]=e=>g(C).hide()),slot:"end"},{default:p((()=>t[25]||(t[25]=[y(" Close ")]))),_:1}),v(g(T),{color:"warning",onClick:Ue,slot:"end"},{default:p((()=>t[26]||(t[26]=[y(" Reset ")]))),_:1}),v(g(T),{color:"success",onClick:ke,slot:"end"},{default:p((()=>t[27]||(t[27]=[y(" Save ")]))),_:1})])),_:1})])),_:1})],64))}}),[["__scopeId","data-v-7cbaf355"]]),yt=r({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:ke,IonCard:z,IonCardHeader:j,IonCardTitle:$,IonCardContent:W,IonButton:T},setup(e){const t=u([]),a=E((()=>e.patient.getID())),l=s({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),n=u([{label:"Add Visit",action:async()=>{await C.show(_t,{patient:e.patient})}},{label:"Update Outcome",action:async()=>C.show(dt,{patient:e.patient})},{label:"Enter VL Results",action:async()=>C.show(lt,{patient:e.patient})}]),i=t=>{const a="N/A"!==e.startDate?"("+he(t).diff(e.startDate,"months")+"M)":"";return`${be(t)} ${a}`},o={minWidth:"68px !important"},r=u([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:o},{path:"weight",label:"Weight (Kg)",sortable:!1,thStyles:o},{path:"height",label:"Height (cm)",sortable:!1,thStyles:o},{path:"bmi",label:"BMI",sortable:!1,thStyles:o},...e.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:o},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:o}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:e=>e.length>0?"Yes":"No",sortable:!1,thStyles:o},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:o},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:o},{path:"vlResult",label:"Viral Load",sortable:!1}]),d=[{label:"void",icon:Y,color:"danger",action(e,l){ge((async n=>{const i=await ve.getEncounters(a.value,{date:e.date});var o;i.ok?(null===(o=i.data)||void 0===o||o.forEach((async e=>{await ve.voidEncounter(e.encounter_id,n)})),t.value.splice(l,1)):ue(i.errorMessage||"Failed to void encounters")}),"small-modal")}}],m=async e=>e.tb_status.match(/Unknown/i)||"Defaulted"===e.outcome?"":ae.getCachedConceptName(e.tb_status),v=()=>{le.getPatientVisits(a.value,!0).then((async e=>{t.value=[];for(const l of e){const e=(await pe.getCurrentProgramInformation(a.value,l)).data;let n="",o="",r="",u="";if("Defaulted"!==e.outcome){const t=await ne.getFirstValueDatetime(a.value,"appointment date",l);if(t&&(n=be(t)),o=await ne.getFirstValueCoded(a.value,"Is patient pregnant",l),r=await ne.getFirstValueCoded(a.value,"Is patient breast feeding",l),"N/A"===e.viral_load){const e=await ne.getFirstObs(a.value,"HIV viral load",l);e&&e.value_text&&e.value_numeric&&(u=1===e.value_numeric?"LDL":e.value_text+e.value_numeric.toString())}else u=e.viral_load}e&&t.value.push({visitDate:i(l),visitBy:e.visit_by.match(/Unk/i)?"":e.visit_by,weight:"Defaulted"===e.outcome?"":e.weight,height:"Defaulted"===e.outcome?"":e.height,bmi:"Defaulted"===e.outcome?"":e.bmi,pregnant:o,breastfeeding:r,tbStatus:await m(e),sideEffects:"Defaulted"===e.outcome?"":e.side_effects,regimen:"Defaulted"===e.outcome?"":e.regimen,nextAppointment:n,outcome:e.outcome.match(/Unk/i)?"":e.outcome,vlResult:u,drugs:e.pills_dispensed,date:l})}}))};return Oe.on(Ee.RELOAD_PATIENT_VISIT_DATA,(()=>v())),c((()=>{v()})),{actionButtons:n,tableConfig:l,rowButtons:d,columns:r,rows:t,onDrilldownHandler:async e=>{const t=/regimen/i.test(e.column.path)?(e=>({title:`Drugs dispensed on ${e.row.visitDate}`,columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:e.row.drugs.map((e=>({name:e[0],quantity:e[1],units:"tab (s)"})))}))(e):(e=>({title:`Side effects noted on ${e.row.visitDate}`,rows:e.row.sideEffects.map((e=>({sideEffect:e}))),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}))(e);oe(t.rows)||await C.show(Qe,t)}}}}),wt={class:"ion-float-right ion-margin-end ion-margin-bottom"};const Dt=k(yt,[["render",function(e,t,a,l,n,i){const o=U("ion-icon"),r=U("ion-button"),u=U("ion-card-title"),s=U("ion-card-header"),d=U("data-table"),c=U("ion-card-content"),g=U("ion-card");return b(),L(g,{class:"his-card",style:{padding:"0 !important"}},{default:p((()=>[v(s,null,{default:p((()=>[v(u,null,{default:p((()=>[t[0]||(t[0]=x("span",{class:"title"},"Summary of Visits",-1)),x("span",wt,[(b(!0),m(f,null,q(e.actionButtons,(e=>(b(),L(r,{key:e.label,onClick:e.action,color:e.color||"primary"},{default:p((()=>[e.icon?(b(),L(o,{key:0,icon:e.icon,class:"ion-margin-right"},null,8,["icon"])):B("",!0),y(" "+H(e.label),1)])),_:2},1032,["onClick","color"])))),128))])])),_:1})])),_:1}),v(c,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:p((()=>[v(d,{rows:e.rows,columns:e.columns,"row-actions-buttons":e.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:e.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])])),_:1})])),_:1})}],["__scopeId","data-v-b764fd01"]]),Vt=r({__name:"ViralLoadTrail",props:{patient:{}},setup(e){const t=e,a=E((()=>`Viral Load Results Trail for ${t.patient.getFullName()}`)),l=u([]),n=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:be},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:be}],i={label:"X",color:"danger",action({encounter_id:e}){ge((async t=>{try{await J.void(e,t),C.hide(),Oe.emit(Ee.RELOAD_LATEST_VL_RESULT),Oe.emit(Ee.RELOAD_PATIENT_VISIT_DATA)}catch(a){console.error(a)}}),"small-modal custom-modal-backdrop")}};return c((async()=>{l.value=await at.getViralLoadResultTrail(t.patient.getID())})),(e,t)=>(b(),m(f,null,[v(g(w),null,{default:p((()=>[v(g(h),null,{default:p((()=>[v(g(_),null,{default:p((()=>[y(H(a.value),1)])),_:1})])),_:1})])),_:1}),v(g(P),null,{default:p((()=>[v(g(D),{style:{width:"100%"}},{default:p((()=>[v(g(V),{style:F([{padding:"0 !important"},{minHeight:l.value.length?"0":"30vh"}])},{default:p((()=>[v(g(I),{size:"12",class:"ion-no-padding"},{default:p((()=>[v(g(ke),{rows:l.value,columns:n,"row-actions-buttons":[i],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])])),_:1})])),_:1},8,["style"])])),_:1})])),_:1}),v(g(S),null,{default:p((()=>[v(g(h),null,{default:p((()=>[v(g(T),{color:"primary",onClick:t[0]||(t[0]=e=>g(C).hide()),slot:"end"},{default:p((()=>t[1]||(t[1]=[y(" Close ")]))),_:1})])),_:1})])),_:1})],64))}}),It=r({components:{MultiColumnView:mt,IonList:Q,IonItem:A},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(e,{emit:t}){const a=u(0),l=u(0),n=u(0),i=u(""),o=u(""),r=u(""),s=u(""),d=u(""),m=u(""),v=u(""),p=u(""),g=u(""),f=u(""),b=u(""),h=e=>e.other&&"function"==typeof e.other.onClickHandler,_=E((()=>!oe(e.guardians))),y=()=>{const t=e.patient.getBirthdate(),a="N/A"!==e.artStartDate?he(e.artStartDate).diff(t,"years"):"";return`${be(t)} (${a})`},w=()=>{at.getlatestViralLoadResult(e.patient.getID()).then((e=>f.value=e))},D=()=>({onClickHandler(){K.push(`/patient/reception/${e.patient.getID()}/false`)}}),V=()=>({onClickHandler:()=>t("updatePatient")}),I=E((()=>[{label:"ARV Number",value:e.patient.getArvNumber(),other:{onClickHandler:()=>t("updateARVNumber")}},{label:"MW National ID",value:e.patient.getMWNationalID(),other:V()},{label:"Name",value:e.patient.getGivenName()+" "+e.patient.getFamilyName(),other:V()},{label:"DOB and Age at Initiation",value:y(),other:V()},{label:"Sex",value:Ke(e.patient.getGender()),other:V()},{label:"Location",value:e.patient.getCurrentVillage(),other:V()},{label:"Landmark",value:e.patient.getClosestLandmark(),other:V()},{label:"Phone Number",value:e.patient.getPhoneNumber(),other:V()},{label:"Guardian",value:_.value?e.guardians.map((e=>`${e.name} (${e.relationshipType})`)).join(","):"Add",other:{onClickHandler:()=>t("updateGuardian")}},{label:"Agrees to follow up",value:d.value,other:D()},{label:"Date of starting first line ARV Regimen",value:e.artStartDate,other:D()},{label:"Initial Weight (KG)",value:a.value,other:D()},{label:"Initial Height (CM)",value:l.value,other:D()},{label:"Initial BMI",value:n.value,other:D()},{label:"Initial TB Status",value:i.value,other:D()},{label:"Pregnant at Initiation",value:r.value,other:D()},{label:"Breastfeeding at Initiation",value:o.value,other:D()},{label:"Latest VL Result and Result Date",value:f.value,other:{onClickHandler:()=>C.show(Vt,{patient:e.patient})}},{label:"TI",value:s.value,other:D()},{label:"HIV test place",value:p.value,other:D()},{label:"HIV test date",value:v.value,other:D()},{label:"WHO stage",value:b.value,other:D()},{label:"Reason for starting ART",value:m.value,other:D()},{label:"Staging codition",value:g.value,other:D()}])),N=()=>{e.patient.getInitialWeight().then((e=>a.value=e)),e.patient.getInitialHeight().then((e=>l.value=e)),e.patient.getInitialBMI().then((e=>n.value=e)),e.patient.getInitialTBStatus().then((e=>i.value=e)),e.patient.hasPregnancyAtARTInitiation().then((e=>r.value=e)),e.patient.breastFeedingAtARTInitiation().then((e=>o.value=e)),e.patient.everReceivedART().then((e=>s.value=e)),e.patient.agreesToFollowUp().then((e=>d.value=e)),e.patient.getReasonForStartingART().then((e=>m.value=e)),e.patient.getHIVTestLocation().then((e=>p.value=e)),e.patient.getStagingCondition().then((e=>g.value=e)),e.patient.getWhoStage().then((e=>b.value=e)),(async()=>{const t=await e.patient.getHIVTestDate();t&&(v.value=be(t))})()};return c((()=>{N(),w(),Oe.on(Ee.RELOAD_LATEST_VL_RESULT,(()=>w())),Oe.on(Ee.RELOAD_STAGING_INFORMATION,(()=>N()))})),{patientInfo:I,onClickHandler:async e=>{var t;h(e)&&await(null===(t=e.other)||void 0===t?void 0:t.onClickHandler())},clickable:h}}}),Nt={style:{width:"100%",display:"flex",justifyContent:"space-between"}},At={key:0},Rt={key:1},Pt={key:2},Tt={key:3};const Ct=k(It,[["render",function(e,t,a,l,n,i){const o=U("ion-item"),r=U("ion-list"),u=U("multi-column-view");return b(),L(u,{items:e.patientInfo,numberOfColumns:3},{default:p((({entries:t})=>[v(r,{class:"his-card ion-margin-end"},{default:p((()=>[(b(!0),m(f,null,q(t,((a,l)=>(b(),L(o,{key:l,lines:l===t.length-1?"none":void 0,button:e.clickable(a),onClick:t=>e.onClickHandler(a)},{default:p((()=>[x("div",Nt,[a.label?(b(),m("span",At,H(a.label)+": ",1)):(b(),m("span",Rt)),e.clickable(a)?(b(),m("span",Pt,[x("a",null,[x("b",null,H(a.value||"N/A"),1)])])):(b(),m("span",Tt,[x("b",null,H(a.value||"N/A"),1)]))])])),_:2},1032,["lines","button","onClick"])))),128))])),_:2},1024)])),_:1},8,["items"])}],["__scopeId","data-v-5306de30"]]),St=r({components:{IonGrid:D,IonRow:V,IonCol:I,TextInput:Ue,DateInput:ye,SelectInput:we},props:{patientService:{type:Object,required:!0}},setup(e){const t=u(!1),a=E((()=>/Unknown/i.test(e.patientService.getMWNationalID())?"":e.patientService.getMWNationalID())),l=s({givenName:{label:"First Name",value:e.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:e=>Me(e)},familyName:{label:"last Name",value:e.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:e=>Me(e)},middleName:{label:"middle Name",value:e.patientService.getMiddleName(),placeholder:"middle Name",validation:e=>!!e&&Me(e)},nationalId:{label:"Malawi National ID Number",value:a.value,placeholder:"Enter Malawi National ID Number",validation:e=>e&&e.label?ze(e):null},gender:{value:e.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:e.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:e.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async e=>!("Unknown"===e.value||"N/A"===e.value)&&je(e)},homeVillage:{value:e.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:e.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),n=async e=>{var t,a,l,n,i,o,r,u;let s,d;try{var c;null!=e&&null!==(c=e.other)&&void 0!==c&&c.traditional_authority_id&&(s=await X.getTraditionalAuthorityById(e.other.traditional_authority_id)),s&&(d=await X.getDistrictByID(s.district_id))}catch(m){ue("Unable to resolve patient address. Saving using default address"),console.error(m)}return{home_district:null!==(t=null===(a=d)||void 0===a?void 0:a.name)&&void 0!==t?t:"N/A",home_traditional_authority:null!==(l=null===(n=s)||void 0===n?void 0:n.name)&&void 0!==l?l:"N/A",home_village:(null==e?void 0:e.label)||"N/A",current_district:null!==(i=null===(o=d)||void 0===o?void 0:o.name)&&void 0!==i?i:"N/A",current_traditional_authority:null!==(r=null===(u=s)||void 0===u?void 0:u.name)&&void 0!==r?r:"N/A",current_village:(null==e?void 0:e.label)||"N/A"}};return{today:fe,patient:l,getLandmarks:Le,genderOptions:Ae,isBirthdateEstimated:t,modal:C,onFinish:async()=>Pe(l,(async t=>{const l={};if(t.givenName!==e.patientService.getGivenName()&&(l.given_name=t.givenName),t.familyName!==e.patientService.getFamilyName()&&(l.family_name=t.familyName),t.middleName!==e.patientService.getMiddleName()&&(l.middle_name=t.middleName),t.birthdate!==e.patientService.getBirthdate()&&(l.birthdate=t.birthdate),t.gender.value!==e.patientService.getGender()&&(l.gender=t.gender.value),t.cellPhoneNumber!==e.patientService.getPhoneNumber()&&(l.cell_phone_number=t.cellPhoneNumber),t.landmark.label!==e.patientService.getClosestLandmark()&&(l.landmark=t.landmark.label),t.homeVillage!==e.patientService.getCurrentVillage()&&Object.assign(l,{...l,...await n(t.homeVillage)}),!oe(l)){const t=new Xe;t.setPersonID(e.patientService.getID()),await t.updatePerson(l)}t.nationalId!==a.value&&await e.patientService.updateMWNationalId(t.nationalId),await C.hide(),Oe.emit(Ee.RELOAD_PATIENT_DATA)})),getVillagesByName:Be}}});const Ot=k(St,[["render",function(e,t,a,l,n,i){const o=U("ion-title"),r=U("ion-icon"),u=U("ion-button"),s=U("ion-buttons"),d=U("ion-toolbar"),c=U("ion-header"),g=U("TextInput"),h=U("ion-col"),_=U("SelectInput"),w=U("DateInput"),D=U("ion-row"),V=U("ion-grid"),I=U("ion-content"),N=U("ion-footer");return b(),m(f,null,[v(c,null,{default:p((()=>[v(d,null,{default:p((()=>[v(o,null,{default:p((()=>t[12]||(t[12]=[y("Edit Patient Demographics")]))),_:1}),v(s,{slot:"end"},{default:p((()=>[v(u,{onClick:t[0]||(t[0]=t=>e.modal.hide())},{default:p((()=>[v(r,{slot:"icon-only",name:"close"})])),_:1})])),_:1})])),_:1})])),_:1}),v(I,{class:"ion-padding"},{default:p((()=>[v(V,null,{default:p((()=>[v(D,null,{default:p((()=>[v(h,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(g,{modelValue:e.patient.givenName,"onUpdate:modelValue":t[1]||(t[1]=t=>e.patient.givenName=t)},null,8,["modelValue"])])),_:1}),v(h,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(g,{modelValue:e.patient.middleName,"onUpdate:modelValue":t[2]||(t[2]=t=>e.patient.middleName=t)},null,8,["modelValue"])])),_:1}),v(h,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(g,{modelValue:e.patient.familyName,"onUpdate:modelValue":t[3]||(t[3]=t=>e.patient.familyName=t)},null,8,["modelValue"])])),_:1}),v(h,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(g,{modelValue:e.patient.nationalId,"onUpdate:modelValue":t[4]||(t[4]=t=>e.patient.nationalId=t)},null,8,["modelValue"])])),_:1}),v(h,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(_,{modelValue:e.patient.gender,"onUpdate:modelValue":t[5]||(t[5]=t=>e.patient.gender=t),options:e.genderOptions},null,8,["modelValue","options"])])),_:1}),v(h,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(w,{modelValue:e.patient.birthdate,"onUpdate:modelValue":t[6]||(t[6]=t=>e.patient.birthdate=t),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:e.today,onIsEstimated:t[7]||(t[7]=t=>e.isBirthdateEstimated=t)},null,8,["modelValue","maxDate"])])),_:1}),v(h,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(g,{modelValue:e.patient.cellPhoneNumber,"onUpdate:modelValue":t[8]||(t[8]=t=>e.patient.cellPhoneNumber=t),allowUnknown:""},null,8,["modelValue"])])),_:1}),v(h,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(_,{modelValue:e.patient.homeVillage,"onUpdate:modelValue":t[9]||(t[9]=t=>e.patient.homeVillage=t),asyncOptions:e.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])])),_:1}),v(h,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(_,{modelValue:e.patient.landmark,"onUpdate:modelValue":t[10]||(t[10]=t=>e.patient.landmark=t),asyncOptions:e.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])])),_:1})])),_:1})])),_:1})])),_:1}),v(N,null,{default:p((()=>[v(d,null,{default:p((()=>[v(u,{color:"primary",onClick:t[11]||(t[11]=t=>e.modal.hide()),slot:"end"},{default:p((()=>t[13]||(t[13]=[y("Close")]))),_:1}),v(u,{class:"ion-margin-end",color:"success",onClick:e.onFinish,slot:"end"},{default:p((()=>t[14]||(t[14]=[y("Save")]))),_:1},8,["onClick"])])),_:1})])),_:1})],64)}]]),Et=r({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(e){var t,a;const l=new Xe,n=e,i=u(oe(n.guardians)),o=E((()=>(i.value?"Add":"Edit")+" Guardian Demographics")),r=E((()=>(i.value?"Edit":"Add")+" Guardian")),h=u([]),_=null!==(t=null===(a=n.guardians)||void 0===a?void 0:a.map((e=>({label:`${e.name} (${e.relationshipType})`,value:e.name,other:e}))))&&void 0!==t?t:[],w=s({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),N=s({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:e=>Me(e)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:e=>Me(e)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async e=>"Unknown"!==e.value&&je(e)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});function A(){i.value=!i.value,w.guardian.value=""}d((()=>w.guardian.value),(e=>{var t,a,l,n,i,o,r,u;N.givenName.value=null!==(t=null==e||null===(a=e.other)||void 0===a?void 0:a.names.given_name)&&void 0!==t?t:"",N.familyName.value=null!==(l=null==e||null===(n=e.other)||void 0===n?void 0:n.names.family_name)&&void 0!==l?l:"",N.cellPhoneNumber.value=null!==(i=null==e||null===(o=e.other)||void 0===o?void 0:o.phoneNumber)&&void 0!==i?i:"",N.relation.value=null!==(r=null==e||null===(u=e.other)||void 0===u?void 0:u.relationshipType)&&void 0!==r?r:""}),{deep:!0,immediate:!0});const R=async()=>Pe(N,(async e=>{i.value||oe(w.guardian.value)?await async function(e){var t,a;await l.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:n.patientId,...e}),await Ze.createRelation(n.patientId,l.getPersonID(),null!==(t=null===(a=e.relation)||void 0===a?void 0:a.value)&&void 0!==t?t:13)}(e):await async function(e,t){const a=t.names.person_id,l={};if(t.names.given_name!==e.given_name&&(l.given_name=e.given_name),t.names.family_name!==e.family_name&&(l.family_name=e.family_name),t.phoneNumber!==e.cell_phone_number&&(l.cell_phone_number=e.cell_phone_number),!oe(l)){const e=new Xe;e.setPersonID(a),await e.updatePerson(l)}var i,o;t.relationshipType!==e.relation.label&&await Ze.amendRelation(n.patientId,a,t.id,null!==(i=null===(o=e.relation)||void 0===o?void 0:o.value)&&void 0!==i?i:13)}(e,w.guardian.value.other),await C.hide(),Oe.emit(Ee.RELOAD_GUARDIAN_DATA)}),{underscoreKeys:!0});return c((async()=>{const e=(await Ze.getRelations()).data;h.value=e.map((e=>({label:e.b_is_to_a,value:e.relationship_type_id,other:e})))})),(e,t)=>{const a=U("ion-title"),l=U("ion-icon"),u=U("ion-button"),s=U("ion-buttons"),d=U("ion-toolbar"),c=U("ion-header"),P=U("ion-content"),T=U("ion-footer");return b(),m(f,null,[v(c,null,{default:p((()=>[v(d,null,{default:p((()=>[v(a,null,{default:p((()=>[y(H(o.value),1)])),_:1}),v(s,{slot:"end"},{default:p((()=>[v(u,{onClick:t[0]||(t[0]=e=>g(C).hide())},{default:p((()=>[v(l,{slot:"icon-only",name:"close"})])),_:1})])),_:1})])),_:1})])),_:1}),v(P,{class:"ion-padding"},{default:p((()=>[v(g(D),null,{default:p((()=>[v(g(V),null,{default:p((()=>[i.value?B("",!0):(b(),L(g(I),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(we,{modelValue:w.guardian,"onUpdate:modelValue":t[1]||(t[1]=e=>w.guardian=e),options:g(_)},null,8,["modelValue","options"])])),_:1})),w.guardian.value||i.value?(b(),m(f,{key:1},[v(g(I),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(Ue,{modelValue:N.givenName,"onUpdate:modelValue":t[2]||(t[2]=e=>N.givenName=e)},null,8,["modelValue"])])),_:1}),v(g(I),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(Ue,{modelValue:N.familyName,"onUpdate:modelValue":t[3]||(t[3]=e=>N.familyName=e)},null,8,["modelValue"])])),_:1}),v(g(I),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(Ue,{modelValue:N.cellPhoneNumber,"onUpdate:modelValue":t[4]||(t[4]=e=>N.cellPhoneNumber=e),allowUnknown:""},null,8,["modelValue"])])),_:1}),v(g(I),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:p((()=>[v(we,{modelValue:N.relation,"onUpdate:modelValue":t[5]||(t[5]=e=>N.relation=e),options:h.value},null,8,["modelValue","options"])])),_:1})],64)):B("",!0)])),_:1})])),_:1})])),_:1}),v(T,null,{default:p((()=>[v(d,null,{default:p((()=>[g(oe)(n.guardians)?B("",!0):(b(),L(u,{key:0,color:"primary",onClick:A,slot:"start"},{default:p((()=>[y(H(r.value),1)])),_:1})),v(u,{color:"primary",onClick:t[6]||(t[6]=e=>g(C).hide()),slot:"end"},{default:p((()=>t[7]||(t[7]=[y("Close")]))),_:1}),v(u,{class:"ion-margin-end",color:"success",onClick:R,slot:"end"},{default:p((()=>t[8]||(t[8]=[y("Save")]))),_:1})])),_:1})])),_:1})],64)}}}),kt=r({components:{IonGrid:D,IonRow:V,IonCol:I,TextInput:Ue},props:{patient:{type:Object,required:!0}},setup(e){const{facility:t}=o(),a=E((()=>e.patient.getArvNumber())),l=E((()=>!oe(a.value)&&"Unknown"!==a.value)),n=s({arvNumber:{value:l.value?a.value.split("-")[2]:"",label:(l.value?"Edit":"Add New")+" ARV Number",placeholder:"Enter ARV Number",required:!0,validation:async e=>{const l=Fe(e,"POSITIVE_INTEGERS");if(null!==l)return l;if(e.value===a.value.split("-")[2])return null;const n=await le.findByOtherID(4,`${t.code}-ARV-${e.value}`);return n.ok?oe(n.data)?null:["ARV Number already taken"]:[n.errorMessage||n.clientErrorType||`Unable to determine ARV number with status: ${n.httpStatusResponse}`]}}});return{form:n,modal:C,arvNumber:a,facility:t,hasValidARVNumber:l,onFinish:async()=>Pe(n,(async n=>{n.arvNumber!==a.value.split("-")[2]&&(l.value?await e.patient.updateARVNumber(`${t.code}-ARV-${n.arvNumber}`):await e.patient.createArvNumber(`${t.code}-ARV-${n.arvNumber}`),Oe.emit(Ee.RELOAD_PATIENT_DATA)),await C.hide()})),voidARV:async()=>{if(await O(`Are you sure you want to void this ARV Number ${a.value}?`)){await Je.show("Voiding ARV Number...");try{await pe.voidARVNumber(a.value),await Je.hide(),await C.hide(),Oe.emit(Ee.RELOAD_PATIENT_DATA)}catch(e){await Je.hide(),console.log(e)}}}}}});const Ut=k(kt,[["render",function(e,t,a,l,n,i){const o=U("ion-title"),r=U("ion-icon"),u=U("ion-button"),s=U("ion-buttons"),d=U("ion-toolbar"),c=U("ion-header"),g=U("text-input"),h=U("ion-col"),_=U("ion-row"),w=U("ion-grid"),D=U("ion-content"),V=U("ion-footer");return b(),m(f,null,[v(c,null,{default:p((()=>[v(d,null,{default:p((()=>[v(o,null,{default:p((()=>t[3]||(t[3]=[y("ARV NUMBER")]))),_:1}),v(s,{slot:"end"},{default:p((()=>[v(u,{onClick:t[0]||(t[0]=t=>e.modal.hide())},{default:p((()=>[v(r,{slot:"icon-only",name:"close"})])),_:1})])),_:1})])),_:1})])),_:1}),v(D,{class:"ion-padding"},{default:p((()=>[v(w,null,{default:p((()=>[v(_,null,{default:p((()=>[v(h,null,{default:p((()=>[v(g,{modelValue:e.form.arvNumber,"onUpdate:modelValue":t[1]||(t[1]=t=>e.form.arvNumber=t),form:e.form,prefix:`${e.facility.code}-ARV-`},null,8,["modelValue","form","prefix"])])),_:1})])),_:1})])),_:1})])),_:1}),v(V,{class:"ion-padding-horizontal"},{default:p((()=>[v(d,null,{default:p((()=>[v(u,{color:"primary",onClick:t[2]||(t[2]=t=>e.modal.hide()),slot:"end"},{default:p((()=>t[4]||(t[4]=[y("Close")]))),_:1}),e.hasValidARVNumber?(b(),L(u,{key:0,color:"danger",onClick:e.voidARV,slot:"start"},{default:p((()=>t[5]||(t[5]=[y("Void ARV Number")]))),_:1},8,["onClick"])):B("",!0),v(u,{color:"success",onClick:e.onFinish,slot:"end"},{default:p((()=>t[6]||(t[6]=[y("Save")]))),_:1},8,["onClick"])])),_:1})])),_:1})],64)}]]),xt=r({components:{VisitsSummary:Dt,InformationHeader:Ct},setup(){const e=Z(),t=parseInt(e.params.patientId.toString())||0,a=u(),l=u(""),i=u([]),o=E((()=>!oe(a.value))),r=async()=>{if(t){const e=(await le.findByID(t)).data;e&&(a.value=new le(e))}},s=async()=>{i.value=await tt.getGuardianDetails(t)};return Oe.on(Ee.RELOAD_PATIENT_DATA,(async()=>{await r()})),Oe.on(Ee.RELOAD_GUARDIAN_DATA,(async()=>{await s()})),c((async()=>{var e;await r();const t=await(null===(e=a.value)||void 0===e?void 0:e.getARTStartDate());l.value=t?n.toStandardHisDisplayFormat(t):"N/A",await s()})),{patient:a,artStartDate:l,guardians:i,isReady:o,updateDemographics:async e=>{await C.show(Ot,{patientService:a.value,attribute:e})},updateGuardian:async()=>{await C.show(Et,{patientId:t,guardians:i.value})},updateARVNumber:async()=>{await C.show(Ut,{patient:a.value})}}}});t("default",k(xt,[["render",function(e,t,a,l,n,i){const o=U("information-header"),r=U("ion-col"),u=U("ion-row"),s=U("visits-summary"),d=U("ion-grid");return e.isReady?(b(),L(d,{key:0,class:"ion-no-margin ion-no-padding"},{default:p((()=>[v(u,null,{default:p((()=>[v(r,{size:"12"},{default:p((()=>[e.patient?(b(),L(o,{key:0,patient:e.patient,guardians:e.guardians,artStartDate:e.artStartDate,onUpdateARVNumber:e.updateARVNumber,onUpdateGuardian:e.updateGuardian,onUpdatePatient:e.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):B("",!0)])),_:1})])),_:1}),v(u,null,{default:p((()=>[v(r,null,{default:p((()=>[e.patient?(b(),L(s,{key:0,patient:e.patient,startDate:e.artStartDate},null,8,["patient","startDate"])):B("",!0)])),_:1})])),_:1})])),_:1})):B("",!0)}]]))}}}))}();
