var st=Object.defineProperty;var ot=(a,i,e)=>i in a?st(a,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[i]=e;var D=(a,i,e)=>(ot(a,typeof i!="symbol"?i+"":i,e),e);import{d as rt,ay as W,h as ct,i as ut,j as lt,I as dt,ax as vt,f as gt,r as v,ac as k,F as z,a0 as _t,aw as N,az as M,J as E,g as C,w as P,o as b,e as pt,R as mt,aA as ft,v as wt}from"./index-b34da4cb.js";import{P as j,C as x}from"./patient_service-8bb3b4cd.js";import{a as St,t as U}from"./toasts-5a6b8805.js";import{l as L}from"./loader-d835876b.js";import{e as h}from"./encounter_types-ae359711.js";import{A as p,P as J,V as It,C as yt}from"./consultation_service-16c2da75.js";import{a as F}from"./his_date-3774cb27.js";import{a as S}from"./form-4b6e0e9a.js";import{C as Ct,P as bt}from"./index-95d3a767.js";import{i as K,g as ht}from"./common-abc2f84d.js";import{E as Y,a as q}from"./emc_event-4721851b.js";import{_ as At}from"./_plugin-vue_export-helper-c27b6911.js";class Rt extends p{constructor(i,e=F()){super(i,h.HIV_CLINIC_REGISTRATION,e)}}class Ot extends p{constructor(i,e=F()){super(i,h.REGISTRATION,e)}}class Tt extends p{constructor(e,r,c=F()){super(e,h.HIV_STAGING,c);D(this,"age");D(this,"confirmatoryTest");this.age=r,this.confirmatoryTest=null}isAdult(){return this.age>=15}cd4CountIsValid(e){try{return!!e.match(/^(=|<|>)([0-9]*)$/m)}catch(r){return!1}}getStagingConditions(e){const r=this.getStagingCategoryByNum(e);return p.getConceptsByCategory(r)}getAllWhoStages(){return p.getConceptsByCategory("whole_staging_numbers")}getAllReasonsForART(e=this.date,r=!1){return p.getConceptsByCategory("reason_for_art").filter(c=>!(new Date(e)>new Date(Ct)&&c.name.match(/cd4/i)||r&&c.name.match(/breastfeeding|pregnant/i)))}buildWhoStageObs(e){return this.buildValueCoded("Who stage",e)}buildWhoCriteriaObs(e){return this.buildValueCoded("Who stages criteria present",e)}buildReasonForArtObs(e){return this.buildValueCoded("Reason for ART eligibility",e)}getStagingCategoryByNum(e){switch(e){case 1:return this.isAdult()?"stage_1_conditions_adults":"stage_1_conditions_pedaids";case 2:return this.isAdult()?"stage_2_conditions_adults":"stage_2_conditions_pedaids";case 3:return this.isAdult()?"stage_3_conditions_adults":"stage_3_conditions_pedaids";case 4:return this.isAdult()?"stage_4_conditions_adults":"stage_4_conditions_pedaids";default:return""}}}const Vt=rt({components:{ClinicRegistration:W(()=>M(()=>import("./ClinicRegistration-6564e8fe.js"),["assets/ClinicRegistration-6564e8fe.js","assets/index-b34da4cb.js","assets/index-41952c18.css","assets/patient_service-8bb3b4cd.js","assets/patient_identifier_service-5ba3bc09.js","assets/his_date-3774cb27.js","assets/index-95d3a767.js","assets/Date-c5ff4f23.js","assets/common-abc2f84d.js","assets/TextInput-6d943a31.js","assets/_plugin-vue_export-helper-c27b6911.js","assets/TextInput-e777cfa6.css","assets/DateInput.vue_vue_type_style_index_0_lang-7008110a.js","assets/validations-b9fbcec4.js","assets/emc_event-4721851b.js","assets/vue-datepicker-bce64927.js","assets/DateInput-5fa0484d.css","assets/YesNoInput-46748994.js","assets/SelectInput-3966d61d.js","assets/SelectInput-5e7944e5.css","assets/location_options-964b1669.js","assets/regimen_service-41e85ed5.js","assets/DTFormElements-a1199b88.js","assets/consultation_service-16c2da75.js","assets/program_service-4e650002.js","assets/encounter_types-ae359711.js","assets/form-4b6e0e9a.js","assets/Strs-7ee8a435.js","assets/toasts-5a6b8805.js","assets/loader-d835876b.js"])),Staging:W(()=>M(()=>import("./Staging-b5e20435.js"),["assets/Staging-b5e20435.js","assets/index-b34da4cb.js","assets/index-41952c18.css","assets/TextInput-6d943a31.js","assets/_plugin-vue_export-helper-c27b6911.js","assets/TextInput-e777cfa6.css","assets/DateInput.vue_vue_type_style_index_0_lang-7008110a.js","assets/his_date-3774cb27.js","assets/validations-b9fbcec4.js","assets/common-abc2f84d.js","assets/emc_event-4721851b.js","assets/vue-datepicker-bce64927.js","assets/DateInput-5fa0484d.css","assets/YesNoInput-46748994.js","assets/SelectInput-3966d61d.js","assets/SelectInput-5e7944e5.css","assets/location_options-964b1669.js","assets/form-4b6e0e9a.js","assets/Strs-7ee8a435.js","assets/toasts-5a6b8805.js","assets/loader-d835876b.js","assets/patient_service-8bb3b4cd.js","assets/patient_identifier_service-5ba3bc09.js","assets/index-95d3a767.js","assets/Date-c5ff4f23.js","assets/encounter_types-ae359711.js","assets/consultation_service-16c2da75.js","assets/program_service-4e650002.js","assets/Staging-fc4f8fe8.css"])),IonGrid:ct,IonRow:ut,IonCol:lt,IonButton:dt},setup(){const a=vt(),i=gt(),e=v(!1),r=k({}),c=v("ClinicRegistration"),s=parseInt(a.params.patientId.toString()||""),g=!!a.params.new.toString().match(/true/i),A=z(()=>c.value==="Staging"),R=z(()=>c.value==="Staging"),I=v({}),m=v(""),G=v(""),y=v([]),O=k({}),B=v(!1),Q=()=>{new J(s).getPrograms().then(t=>{const u=t.data;B.value=u.some(n=>n.program.name==="HIV PROGRAM")})},X=o=>r[o.type]=o.data,Z=()=>c.value="Staging",tt=()=>c.value="ClinicRegistration",et=async()=>{const{arvNumberEditable:o,formData:t,computedData:u}=r.registration,{computedData:n}=r.staging;try{if(L.show(),!g&&!K(y.value))for(const d of y.value)await N.void(d,"Duplicate");o&&t.arvNumber&&await I.value.createArvNumber(t.arvNumber);const l=new Ot(s,t.initialVisitDate);await l.createEncounter();const T=await S(u,"patient type");await l.saveObservationList(T);const _=new Rt(s,t.initialVisitDate);await _.createEncounter();const V=await S(u,"registration");if(await _.saveObservationList(V),t.everRegisteredAtClinic==="Yes"){const d=new It(s,t.initialVisitDate);await d.createEncounter();const it=await S(u,"vitals");await d.saveObservationList(it);const $=new yt(s,t.initialVisitDate);await $.createEncounter();const nt=await S(u,"consultation");await $.saveObservationList(nt)}const f=new Tt(s,I.value.getAge(),t.initialVisitDate);await f.createEncounter();const w=await S(n);if(await f.saveObservationList(w),g||!B.value){const d=new J(s);d.setProgramDate(t.initialVisitDate),await d.enrollProgram()}await L.hide(),await St("Saved successfully"),i.push("/patient/".concat(s))}catch(l){await L.hide(),console.log(l),U("".concat(l))}},H=async o=>{for(const t of o){y.value.includes(t.encounter_id)||y.value.push(t.encounter_id);const u=await x.getConceptName(t.concept_id);let n="";t.value_datetime||t.value_drug?n=t.value_datetime:t.value_text?n=t.value_text:t.value_numeric?n=t.value_numeric:t.value_coded&&(n=await x.getConceptName(t.value_coded)),t.value_modifier&&(n=t.value_modifier+n),O[u]=n}},at=async()=>{const{HIV_CLINIC_CONSULTATION:o,HIV_CLINIC_REGISTRATION:t,REGISTRATION:u,HIV_STAGING:n,VITALS:l}=h;try{const _=(await N.all({encounter_type_id:t,patient_id:s})).data;if(K(_))return;if(m.value=ht(_,"[0].encounter_datetime",""),m.value){await H(_[0].observations);const V=(await N.all({program_id:bt,patient_id:s,date:m.value})).data||[];for(const f of V){let w=[u,n];/yes/i.test("".concat(O["Ever registered at ART clinic"]))&&(w=[...w,o,l]),w.includes(f.encounter_type)&&await H(f.observations)}}}catch(T){U("Unable to load previous observations")}};return _t(async()=>{Q();const o=await j.findByID(s);o.ok&&(I.value=new j(o.data)),g||await at(),e.value=!0,Y.on(q.ON_INITIAL_VISIT_DATE,t=>{m.value=t}),Y.on(q.ON_ART_START_DATE,t=>{G.value=t})}),{activeForm:c,patient:I,isNewPatient:g,isStaging:A,isRegistration:R,isReady:e,initialVisitDate:m,observations:O,artStartDate:G,onValue:X,onFinish:et,onNext:Z,onPrevious:tt}}});function Dt(a,i,e,r,c,s){const g=E("ion-col"),A=E("ion-row"),R=E("ion-grid");return b(),C(R,null,{default:P(()=>[pt(A,{class:"his-card"},{default:P(()=>[a.isReady?(b(),C(g,{key:0,size:"12"},{default:P(()=>[(b(),C(mt,null,[(b(),C(ft(a.activeForm),{patient:a.patient,isNewPatient:a.isNewPatient,initialVisitDate:a.initialVisitDate,artStartDate:a.artStartDate,observations:a.observations,onOnValue:a.onValue,onOnNext:a.onNext,onOnPrevious:a.onPrevious,onOnFinish:a.onFinish},null,40,["patient","isNewPatient","initialVisitDate","artStartDate","observations","onOnValue","onOnNext","onOnPrevious","onOnFinish"]))],1024))]),_:1})):wt("",!0)]),_:1})]),_:1})}const Nt=At(Vt,[["render",Dt]]),xt=Object.freeze(Object.defineProperty({__proto__:null,default:Nt},Symbol.toStringTag,{value:"Module"}));export{Rt as C,xt as H,Ot as P,Tt as S};
