import{d as L,i as E,am as A,o as M,c as W,e as t,w as i,u as b,v as U,a3 as Y,b as k,t as j,V as J,G as K,I as Q,s as X,N as Z,m as x,n as ee,p as ae,aB as te,g as oe,a9 as F,aq as B,J as R,ak as T,aC as ne,aD as z,aE as le,ar as ie,_ as re,O as c,k as se,a as P}from"./index-229c1236.js";import{P as me,R as de}from"./relations_service-affe9b4b.js";import{T as ue}from"./TextInput-021dee31.js";import{_ as pe}from"./DateInput.vue_vue_type_style_index_0_lang-649911b3.js";import{S as ce}from"./SelectInput-b7ea47ef.js";import{a as fe,b as ge}from"./location_options-3955ad41.js";import{i as S,r as $}from"./form-21d73841.js";import{a as be}from"./Strs-0c962638.js";import{l as y}from"./loader-8159f1a1.js";import{E as Ne,a as he}from"./emc_event-4721851b.js";import{a as V,b as ve,c as q}from"./validations-60812f1e.js";import{t as we,d as ye,a as Ve}from"./his_date-b0a0907c.js";import{t as ke}from"./toasts-6e9d0182.js";import{P as Ie}from"./patient_identifier_service-b0ae9293.js";import{t as _e,i as Pe}from"./common-abc2f84d.js";import{D as De}from"./index-9f8e2b10.js";import"./vue-datepicker-956f19a2.js";const Ae=L({__name:"PatientMatch",props:{matchedPatients:{type:Array,required:!0},person:{type:Object,required:!0}},setup(o){const a=o,g=E(()=>"Possible Matches Found (".concat(a.matchedPatients.length,") for ").concat(a.person.given_name," ").concat(a.person.family_name)),I=E(()=>a.matchedPatients.map(({score:f,person:d})=>({name:"".concat(d.given_name," ").concat(d.family_name),...d,score:Number(f*100)+"%"}))),_=[{path:"name",label:"Name"},{path:"score",label:"Score"},{path:"gender",label:"Gender",formatter:_e},{path:"birthdate",label:"Birthdate",formatter:we},{path:"home_village",label:"Home Village"},{path:"home_traditional_authority",label:"Home T/A"},{path:"home_district",label:"Home District"}],p=[{label:"Select",color:"primary",action:A.hide}];function n(){return A.hide()}return(f,d)=>(M(),W(Z,null,[t(b(J),null,{default:i(()=>[t(b(U),null,{default:i(()=>[t(b(Y),null,{default:i(()=>[k(j(g.value),1)]),_:1})]),_:1})]),_:1}),t(b(K),{class:"ion-padding-top"},{default:i(()=>[t(b(De),{color:"light",rows:I.value,columns:_,"row-actions-buttons":p,config:{showSearchField:!1,showSubmitButton:!1}},null,8,["rows"])]),_:1}),t(b(X),null,{default:i(()=>[t(b(U),null,{default:i(()=>[t(b(Q),{slot:"end",onClick:n,color:"primary"},{default:i(()=>[...d[0]||(d[0]=[k(" Register as New Patient ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),Ce=L({components:{IonGrid:x,IonRow:ee,IonCol:ae,TextInput:ue,DateInput:pe,SelectInput:ce,IonCheckbox:te},setup(){const o=oe(),a=R(!1),g=R(!1),I=fe(),_=[{label:"Male",value:"M"},{label:"Female",value:"F"}],p=T({givenName:{label:"First Name",value:"",placeholder:"Enter First Name",required:!0,validation:e=>V(e)},familyName:{label:"Last Name",value:"",placeholder:"Enter Last Name",required:!0,validation:e=>V(e)},middleName:{label:"Middle Name",value:"",placeholder:"Enter middle Name",validation:e=>e&&e.label?V(e):null},nationalId:{label:"Malawi National ID Number",value:"",placeholder:"Enter Malawi National ID Number",validation:e=>e&&e.label?ve(e):null},gender:{value:"",required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:"",label:"Date of Birth",required:!0},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",placeholder:"Enter cellphone number e.g. 0991234567",validation:async e=>e.value!=="Unknown"&&q(e)},homeVillage:{value:"",label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:"",label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),n=T({givenName:{label:"First Name",value:"",placeholder:"Enter First Name",required:!0,validation:e=>V(e)},familyName:{label:"Last Name",value:"",placeholder:"Enter Last Name",required:!0,validation:e=>V(e)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",placeholder:"Enter cellphone number e.g. 0991234567",validation:async e=>e.value!=="Unknown"&&q(e)}});F(g,e=>{e?(n.givenName.value="Unknown",n.familyName.value="Unknown",n.cellPhoneNumber.value="Unknown",n.givenName.disabled=!0,n.familyName.disabled=!0,n.givenName.error="",n.familyName.error="",n.cellPhoneNumber.error=""):(n.givenName.value="",n.familyName.value="",n.cellPhoneNumber.value="",n.givenName.disabled=!1,n.familyName.disabled=!1)}),F(()=>p.birthdate.value,async e=>{const s=ye().diff(e,"weeks");if(s<6&&!await B("Patient is only ".concat(s," weeks old. \n          Patient should be at least 6 weeks old to enroll in ART. \n          Are you sure you want to proceed?\n        "),{header:"ART Enrollment Warning",color:"warning"}))return o.back()});const f=async()=>{if(await B("Are you sure you want to clear all fields?")){for(const e in p)p[e].value=void 0,p[e].error="";for(const e in n)n[e].value=void 0,n[e].error="";Ne.emit(he.ON_CLEAR)}},d=(e,s={})=>{const r={facility_name:null,occupation:null};for(const m in e)r[be(m)]=e[m];return{...r,...s}},u=async e=>{var m,l,v,w,N;let s,r;try{(m=e==null?void 0:e.other)!=null&&m.traditional_authority_id&&(s=await z.getTraditionalAuthorityById(e.other.traditional_authority_id)),s&&(r=await z.getDistrictByID(s.district_id))}catch(D){ke("Unable to resolve client address. Saving using default address"),console.error(D)}return{home_district:(l=r==null?void 0:r.name)!=null?l:"N/A",home_traditional_authority:(v=s==null?void 0:s.name)!=null?v:"N/A",home_village:(e==null?void 0:e.label)||"N/A",current_district:(w=r==null?void 0:r.name)!=null?w:"N/A",current_traditional_authority:(N=s==null?void 0:s.name)!=null?N:"N/A",current_village:(e==null?void 0:e.label)||"N/A"}},h=async e=>{var r;const s=new le(ie);try{const m=await s.checkPotentialDuplicates(e);if(m.ok&&((r=m.data)==null?void 0:r.length)>0)return A.show(Ae,{matchedPatients:m.data,person:e},"custom-summary-modal",!1)}catch(m){console.error(m)}};return{today:Ve,patient:p,guardian:n,landmarks:I,genderOptions:_,guardianAbsent:g,isBirthdateEstimated:a,onClear:f,onFinish:async()=>{const e=await S(p),s=g.value?!0:await S(n);if(e&&s)try{y.show("Checking for possible duplicates...");const r=$(p).formData,m=new me,l=await u(r.homeVillage),v=d(r,{...l,isPatient:!0,patient_type:null,gender:r.gender.value,landmark:r.landmark.value,birthdate_estimated:a.value?"Yes":"No",relationship:g.value?"No":"Yes"});y.hide();const w=await h(v);if(!Pe(w))return o.push("/patient/".concat(w.patient_id));await y.show("Saving..."),await m.createPerson(v),await m.createPatient();const N=m.getPersonID();if(r.nationalId&&await Ie.create(N,ne,r.nationalId),!g.value&&s){const{formData:D}=$(n),G=await u(),O=d(D,{...G,middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:N});await m.registerGuardian(O);const H=m.getPersonID();await de.createRelation(N,H,13)}o.push("/patient/reception/".concat(N,"/true")),y.hide()}catch(r){console.log(r),y.hide()}},getVillagesByName:ge}}}),Ee={class:"ion-margin-start checkbox-label"};function Ue(o,a,g,I,_,p){const n=c("ion-col"),f=c("ion-row"),d=c("ion-title"),u=c("TextInput"),h=c("SelectInput"),C=c("DateInput"),e=c("ion-checkbox"),s=c("ion-button"),r=c("ion-grid"),m=c("Layout");return M(),se(m,null,{default:i(()=>[t(r,null,{default:i(()=>[t(f,null,{default:i(()=>[t(n,{class:"ion-margin-bottom"},{default:i(()=>[...a[14]||(a[14]=[P("h1",null,"New Patient Registration",-1)])]),_:1})]),_:1}),t(f,{class:"his-card"},{default:i(()=>[t(n,{size:"12"},{default:i(()=>[t(d,{class:"ion-text-center ion-margin-vertical"},{default:i(()=>[...a[15]||(a[15]=[P("b",null,"Personal Details",-1)])]),_:1}),t(f,{class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(n,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(u,{modelValue:o.patient.givenName,"onUpdate:modelValue":a[0]||(a[0]=l=>o.patient.givenName=l)},null,8,["modelValue"])]),_:1}),t(n,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(u,{modelValue:o.patient.middleName,"onUpdate:modelValue":a[1]||(a[1]=l=>o.patient.middleName=l)},null,8,["modelValue"])]),_:1}),t(n,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(u,{modelValue:o.patient.familyName,"onUpdate:modelValue":a[2]||(a[2]=l=>o.patient.familyName=l)},null,8,["modelValue"])]),_:1}),t(n,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(u,{modelValue:o.patient.nationalId,"onUpdate:modelValue":a[3]||(a[3]=l=>o.patient.nationalId=l)},null,8,["modelValue"])]),_:1}),t(n,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(h,{modelValue:o.patient.gender,"onUpdate:modelValue":a[4]||(a[4]=l=>o.patient.gender=l),options:o.genderOptions},null,8,["modelValue","options"])]),_:1}),t(n,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(u,{modelValue:o.patient.cellPhoneNumber,"onUpdate:modelValue":a[5]||(a[5]=l=>o.patient.cellPhoneNumber=l),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(n,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(C,{modelValue:o.patient.birthdate,"onUpdate:modelValue":a[6]||(a[6]=l=>o.patient.birthdate=l),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1920-01-01",maxDate:o.today(),onIsEstimated:a[7]||(a[7]=l=>o.isBirthdateEstimated=l)},null,8,["modelValue","maxDate"])]),_:1}),t(n,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(h,{modelValue:o.patient.homeVillage,"onUpdate:modelValue":a[8]||(a[8]=l=>o.patient.homeVillage=l),asyncOptions:o.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),t(n,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(h,{modelValue:o.patient.landmark,"onUpdate:modelValue":a[9]||(a[9]=l=>o.patient.landmark=l),options:o.landmarks,allowCustom:""},null,8,["modelValue","options"])]),_:1})]),_:1}),t(d,{class:"ion-text-center ion-margin-vertical ion-padding-top"},{default:i(()=>[a[17]||(a[17]=P("b",null,"Guardian details",-1)),P("span",Ee,[a[16]||(a[16]=k(" Guardian Details Unknown? ",-1)),t(e,{modelValue:o.guardianAbsent,"onUpdate:modelValue":a[10]||(a[10]=l=>o.guardianAbsent=l)},null,8,["modelValue"])])]),_:1}),t(f,{class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(n,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(u,{modelValue:o.guardian.givenName,"onUpdate:modelValue":a[11]||(a[11]=l=>o.guardian.givenName=l)},null,8,["modelValue"])]),_:1}),t(n,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(u,{modelValue:o.guardian.familyName,"onUpdate:modelValue":a[12]||(a[12]=l=>o.guardian.familyName=l)},null,8,["modelValue"])]),_:1}),t(n,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:i(()=>[t(u,{modelValue:o.guardian.cellPhoneNumber,"onUpdate:modelValue":a[13]||(a[13]=l=>o.guardian.cellPhoneNumber=l),allowUnknown:""},null,8,["modelValue"])]),_:1})]),_:1}),t(s,{class:"ion-margin-top ion-float-right",onClick:o.onFinish,size:"large",color:"success"},{default:i(()=>[...a[18]||(a[18]=[k("Finish",-1)])]),_:1},8,["onClick"]),t(s,{class:"ion-margin-top ion-float-right",onClick:o.onClear,size:"large",color:"warning"},{default:i(()=>[...a[19]||(a[19]=[k("Clear",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1})}const Ke=re(Ce,[["render",Ue]]);export{Ke as default};
