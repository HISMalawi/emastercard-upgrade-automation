var ot=Object.defineProperty;var rt=(s,e,t)=>e in s?ot(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var l=(s,e,t)=>(rt(s,typeof e!="symbol"?e+"":e,t),t);import{at as I,l as ct,d as ut,au as $,a7 as lt,_ as dt,$ as pt,I as gt,as as vt,J as _t,S as v,a8 as x,g as W,T as mt,av as M,r as E,h as S,w as R,o as D,a as ht,K as yt,aw as ft,j as bt}from"./index-1c16650e.js";import{A as u,S as Tt,P as U,V as wt,C as St}from"./ApiStore-7ff79166.js";import{a as Dt,t as j}from"./toasts-926a2fd9.js";import{l as P}from"./loader-1441845f.js";import{P as Y,C as It}from"./index-95d3a767.js";import{O as k,C as L,a as b}from"./form-c5c112ea.js";import{e as Q}from"./encounter_types-55fa45e3.js";import{i as z,g as Ct}from"./common-94ac9539.js";import{E as K,a as q}from"./emc_event-4721851b.js";import{_ as At}from"./_plugin-vue_export-helper-c27b6911.js";class J{constructor(e,t){l(this,"encounterTypeID");l(this,"programID");l(this,"encounterID");l(this,"providerID");l(this,"patientID");l(this,"date");this.encounterTypeID=9,this.patientID=e,this.encounterID=0,this.date=this.getSessionDate(),this.providerID=t,this.programID=Y}getSessionDate(){return sessionStorage.getItem("sessionDate")||""}async createEncounter(){var n;const e={encounter_type_id:this.encounterTypeID,patient_id:this.patientID,encounter_datetime:this.date,program_id:this.programID},a=(await I.create(e)).data;if(a)return this.encounterID=(n=a.encounter_id)!=null?n:0,a}static async resetSessionDate(){const e=await this.getApiDate();if(console.log("HERE IS THE API DATE",e),e){sessionStorage.removeItem("apiDate"),sessionStorage.setItem("sessionDate",e);return}throw"Unable to reset session date"}static async getApiDate(){const e=await ct.getDate();if(e)return e.date}saveObservationList(e){return k.saveObsArray(this.encounterID,e)}async saveValueTextObs(e,t){const a=await k.buildValueText(e,t);return this.saveObs(a)}saveObs(e){return u.saveObs(this.encounterID,e)}buildValueText(e,t){return u.buildValueText(e,t,this.date)}buildGroupValueCoded(e,t,a){return u.buildGroupValueCoded(e,t,a,this.date)}buildValueDate(e,t){return u.buildValueDate(e,t,this.date)}buildValueNumber(e,t,a=null,n=null){return u.buildValueNumber(e,t,a,n,this.date)}buildValueCoded(e,t){return u.buildValueCoded(e,t,this.date)}setDate(e){this.date=e}}class Ot extends u{constructor(t,a){super(t,5,a);l(this,"patientType");l(this,"locationName");this.patientType="N/A",this.locationName=""}setLocationName(t){this.locationName=t}setPatientType(t){this.patientType=t}getType(){return this.patientType}static getPatientTypes(){return L.getConceptsByCategory("art_patient_type").map(({name:t})=>({label:t,value:t}))}static async isDrugRefillPatient(t){const a=await u.getFirstValueCoded(t,"Type of patient");return a&&a==="Emergency supply"}async loadPatientType(){const t=await this.getFirstValueCoded("Type of patient");t&&(this.patientType=t)}async save(){await this.savePatientType(this.patientType),this.locationName&&["External consultation","Emergency supply"].includes(this.patientType)&&await this.saveLocationClinic(this.locationName)}saveLocationClinic(t){return this.saveValueTextObs("Art clinic location",t)}savePatientType(t){return this.saveValueCodedObs("Type of patient",t)}}class Vt extends u{constructor(t,a,n){super(t,Q.HIV_STAGING,n);l(this,"age");l(this,"confirmatoryTest");this.age=a,this.confirmatoryTest=null}isAdult(){return this.age>=15}cd4CountIsValid(t){try{return!!t.match(/^(=|<|>)([0-9]*)$/m)}catch(a){return!1}}getStagingConditions(t){const a=this.getStagingCategoryByNum(t);return u.getConceptsByCategory(a)}getAllWhoStages(){return u.getConceptsByCategory("whole_staging_numbers")}getAllReasonsForART(t=this.date,a=!1){return u.getConceptsByCategory("reason_for_art").filter(n=>!(new Date(t)>new Date(It)&&n.name.match(/cd4/i)||a&&n.name.match(/breastfeeding|pregnant/i)))}buildWhoStageObs(t){return this.buildValueCoded("Who stage",t)}buildWhoCriteriaObs(t){return this.buildValueCoded("Who stages criteria present",t)}buildReasonForArtObs(t){return this.buildValueCoded("Reason for ART eligibility",t)}getStagingCategoryByNum(t){switch(t){case 1:return this.isAdult()?"stage_1_conditions_adults":"stage_1_conditions_pedaids";case 2:return this.isAdult()?"stage_2_conditions_adults":"stage_2_conditions_pedaids";case 3:return this.isAdult()?"stage_3_conditions_adults":"stage_3_conditions_pedaids";case 4:return this.isAdult()?"stage_4_conditions_adults":"stage_4_conditions_pedaids";default:return""}}}const Nt=ut({components:{ClinicRegistration:$(()=>M(()=>import("./ClinicRegistration-38746777.js"),["assets/ClinicRegistration-38746777.js","assets/index-1c16650e.js","assets/index-8b885fd4.css","assets/patient_service-29b1e70e.js","assets/patient_identifier_service-31eb4b11.js","assets/his_date-3ca53c6f.js","assets/index-95d3a767.js","assets/common-94ac9539.js","assets/TextInput-9a09c3ed.js","assets/_plugin-vue_export-helper-c27b6911.js","assets/TextInput-e777cfa6.css","assets/DateInput-1961bd72.js","assets/validations-11aef89d.js","assets/emc_event-4721851b.js","assets/vue-datepicker-312099be.js","assets/DateInput-5fa0484d.css","assets/YesNoInput-6d682510.js","assets/SelectInput-61d8e31d.js","assets/SelectInput-5e7944e5.css","assets/location_options-3cab4a71.js","assets/regimen_service-c545acb4.js","assets/DTFormElements-a1199b88.js","assets/ApiStore-7ff79166.js","assets/program_service-dfa5bbb7.js","assets/image-cb93bc3e.js","assets/program_service-1ed4f047.css","assets/form-c5c112ea.js","assets/Strs-7ee8a435.js","assets/Date-c63183ce.js","assets/toasts-926a2fd9.js","assets/loader-1441845f.js","assets/user_service-6565a8e9.js","assets/services-f7c3fb9d.js","assets/encounter_types-55fa45e3.js"])),Staging:$(()=>M(()=>import("./Staging-0308f8f1.js"),["assets/Staging-0308f8f1.js","assets/index-1c16650e.js","assets/index-8b885fd4.css","assets/Date-c63183ce.js","assets/his_date-3ca53c6f.js","assets/TextInput-9a09c3ed.js","assets/_plugin-vue_export-helper-c27b6911.js","assets/TextInput-e777cfa6.css","assets/DateInput-1961bd72.js","assets/validations-11aef89d.js","assets/common-94ac9539.js","assets/emc_event-4721851b.js","assets/vue-datepicker-312099be.js","assets/DateInput-5fa0484d.css","assets/YesNoInput-6d682510.js","assets/SelectInput-61d8e31d.js","assets/SelectInput-5e7944e5.css","assets/location_options-3cab4a71.js","assets/form-c5c112ea.js","assets/Strs-7ee8a435.js","assets/toasts-926a2fd9.js","assets/loader-1441845f.js","assets/ApiStore-7ff79166.js","assets/program_service-dfa5bbb7.js","assets/image-cb93bc3e.js","assets/index-95d3a767.js","assets/program_service-1ed4f047.css","assets/user_service-6565a8e9.js","assets/patient_service-29b1e70e.js","assets/patient_identifier_service-31eb4b11.js","assets/services-f7c3fb9d.js","assets/encounter_types-55fa45e3.js","assets/Staging-bd4ab211.css"])),IonGrid:lt,IonRow:dt,IonCol:pt,IonButton:gt},setup(){const s=vt(),e=_t(),t=v(!1),a=x({}),n=v("ClinicRegistration"),c=parseInt(s.params.patientId.toString()||""),_=!!s.params.new.toString().match(/true/i),C=W(()=>n.value==="Staging"),A=W(()=>n.value==="Staging"),T=v({}),h=v(""),F=v(""),w=v([]),O=x({}),G=v(!1),X=()=>{new U(c).getPrograms().then(i=>{const d=i.data;G.value=d.some(o=>o.program.name==="HIV PROGRAM")})},Z=r=>a[r.type]=r.data,tt=()=>n.value="Staging",et=()=>n.value="ClinicRegistration",at=async()=>{const{arvNumberEditable:r,formData:i,computedData:d}=a.registration,{computedData:o}=a.staging;try{if(P.show(),!_&&!z(w.value))for(const g of w.value)await I.void(g,"Duplicate");r&&i.arvNumber&&await T.value.createArvNumber(i.arvNumber);const p=new Ot(c,-1);await p.createEncounter();const V=await b(d,"patient type");await p.saveObservationList(V);const m=new J(c,-1);await m.createEncounter();const N=await b(d,"registration");if(await m.saveObservationList(N),i.everRegisteredAtClinic==="Yes"){const g=new wt(c,-1);await g.createEncounter();const st=await b(d,"vitals");await g.saveObservationList(st);const H=new St(c,-1);await H.createEncounter();const nt=await b(d,"consultation");await H.saveObservationList(nt)}const y=new Vt(c,T.value.getAge(),-1);await y.createEncounter();const f=await b(o);if(await y.saveObservationList(f),_||!G.value){const g=new U(c);g.setProgramDate(i.initialVisitDate),await g.enrollProgram()}await P.hide(),await J.resetSessionDate(),await Dt("Saved successfully"),e.push("/patient/".concat(c))}catch(p){await P.hide(),console.log(p),j("".concat(p))}},B=async r=>{for(const i of r){w.value.includes(i.encounter_id)||w.value.push(i.encounter_id);const d=await L.getConceptName(i.concept_id);let o="";i.value_datetime||i.value_drug?o=i.value_datetime:i.value_text?o=i.value_text:i.value_numeric?o=i.value_numeric:i.value_coded&&(o=await L.getConceptName(i.value_coded)),i.value_modifier&&(o=i.value_modifier+o),O[d]=o}},it=async()=>{const{HIV_CLINIC_CONSULTATION:r,HIV_CLINIC_REGISTRATION:i,REGISTRATION:d,HIV_STAGING:o,VITALS:p}=Q;try{const m=(await I.all({encounter_type_id:i,patient_id:c})).data;if(z(m))return;if(h.value=Ct(m,"[0].encounter_datetime",""),h.value){await B(m[0].observations);const N=(await I.all({program_id:Y,patient_id:c,date:h.value})).data||[];for(const y of N){let f=[d,o];/yes/i.test("".concat(O["Ever registered at ART clinic"]))&&(f=[...f,r,p]),f.includes(y.encounter_type)&&await B(y.observations)}}}catch(V){j("Unable to load previous observations")}};return mt(async()=>{X(),T.value=await Tt.get("ACTIVE_PATIENT",{patientID:c}),_||await it(),t.value=!0,K.on(q.ON_INITIAL_VISIT_DATE,r=>{h.value=r}),K.on(q.ON_ART_START_DATE,r=>{F.value=r})}),{activeForm:n,patient:T,isNewPatient:_,isStaging:C,isRegistration:A,isReady:t,initialVisitDate:h,observations:O,artStartDate:F,onValue:Z,onFinish:at,onNext:tt,onPrevious:et}}});function Et(s,e,t,a,n,c){const _=E("ion-col"),C=E("ion-row"),A=E("ion-grid");return D(),S(A,null,{default:R(()=>[ht(C,{class:"his-card"},{default:R(()=>[s.isReady?(D(),S(_,{key:0,size:"12"},{default:R(()=>[(D(),S(yt,null,[(D(),S(ft(s.activeForm),{patient:s.patient,isNewPatient:s.isNewPatient,initialVisitDate:s.initialVisitDate,artStartDate:s.artStartDate,observations:s.observations,onOnValue:s.onValue,onOnNext:s.onNext,onOnPrevious:s.onPrevious,onOnFinish:s.onFinish},null,40,["patient","isNewPatient","initialVisitDate","artStartDate","observations","onOnValue","onOnNext","onOnPrevious","onOnFinish"]))],1024))]),_:1})):bt("",!0)]),_:1})]),_:1})}const Rt=At(Nt,[["render",Et]]),jt=Object.freeze(Object.defineProperty({__proto__:null,default:Rt},Symbol.toStringTag,{value:"Module"}));export{J as C,jt as H,Ot as P,Vt as S};
