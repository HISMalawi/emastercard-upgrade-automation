var na=Object.defineProperty;var oa=(e,a,l)=>a in e?na(e,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[a]=l;var Mt=(e,a,l)=>(oa(e,typeof a!="symbol"?a+"":a,l),l);import{L as Ae,l as Ct,d as ee,r as q,ak as se,a9 as he,j as we,c as G,e as t,w as n,u as i,N as J,o as _,x as pe,a3 as nt,b as $,V as He,m as fe,n as ne,p as P,M as Ue,y as at,aB as Tt,H as Ge,I as Z,am as x,v as Le,aq as Ie,i as M,_ as ue,O as I,a as C,k,B as z,X as jt,Q as Ve,t as K,Z as ia,aF as la,aG as Wt,aH as sa,aI as Yt,aJ as ra,ao as Xt,aA as ua,z as mt,a1 as Ht,aK as Ut,aL as da,aM as ca,W as ma,aN as fa,aO as Nt,aP as va,a8 as pa,aQ as ba,q as ga,a7 as ya,aR as ha,aS as _a,aT as wa,aD as Gt,ar as Va,aU as Da}from"./index-bb739e40.js";import{g as Ia,D as Et,C as ft,P as et,O as ct}from"./patient_service-4ab78208.js";import{g as At,i as L}from"./common-abc2f84d.js";import{A as ge,u as gt,V as Ra,C as Na,E as Lt}from"./consultation_service-e2ac1262.js";import{p as Jt}from"./VoidReason-13a11203.js";import{a as ae,t as me,d as oe,e as kt,f as Aa}from"./his_date-cdf9b1f5.js";import{_ as Re}from"./DateInput.vue_vue_type_style_index_0_lang-3c482956.js";import{S as ye}from"./SelectInput-3025774a.js";import{N as ve,R as Oe}from"./regimen_service-2226684b.js";import{e as Te}from"./encounter_types-1e88a09d.js";import{s as Sa,a as vt,u as zt,c as Ta}from"./arrays-1b521787.js";import{s as ze,i as qe,r as pt,a as Fe}from"./form-4de9093f.js";import{E as j,a as W}from"./emc_event-4721851b.js";import{a as Me,t as Ee}from"./toasts-ee9dd090.js";import{D as bt}from"./Date-d94a9384.js";import{D as $t}from"./index-f14e3cf4.js";import{l as re}from"./loader-108d20fb.js";import{d as Qt,r as De,v as Ze,e as Oa,f as _e,g as xt,a as tt,b as Pa,c as Kt}from"./validations-dc58628e.js";import{T as Pe}from"./TextInput-7c99ab18.js";import{g as Zt,a as Ca,b as Ea}from"./location_options-e8a642c8.js";import{t as ka,g as $a}from"./DTFormElements-9dbc03af.js";import{Y as Se}from"./YesNoInput-24d6ddc4.js";import{D as Fa}from"./DrilldownTable-6b55fd47.js";import{t as Ba,i as qa}from"./Strs-0c962638.js";import{P as Ot,R as St}from"./relations_service-ce5e91f0.js";import{r as Ma,d as Ha,h as Ua,a as Ga}from"./dde-58acf1bd.js";import"./patient_identifier_service-11ced062.js";import"./vue-datepicker-048f13dd.js";const La=e=>{const a=e.given_name,l=e.family_name,u=e.middle_name?e.middle_name:"";return"".concat(a," ").concat(u," ").concat(l)};class za{static getRelationships(a){return Ae.getJson("/people/".concat(a,"/relationships")).then(l=>l.data)}static async getGuardianDetails(a){return await this.getRelationships(a).then(l=>l.map(u=>{const c=At(u,"relation.names[0]");return{id:u.relationship_id,name:c?La(c):"",relationshipType:At(u,"type.b_is_to_a",""),phoneNumber:Ia(At(u,"relation.person_attributes",[]),12),names:c}}))}}const Be=class Be extends ge{constructor(a){super(a,Te.LAB_ORDERS,ae())}async loadConcepts(){Be.conceptID=await ge.getConceptID("HIV Viral Load")}createLabOrder(a,l){const u=Ae.getUsername(),c=Ct().facility.name,b=ge.getCachedConceptID(l,!0);return Ae.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:u,target_lab:c,reason_for_test_id:b,encounter_id:this.encounterID,tests:[{concept_id:Be.conceptID}],date:this.date,specimen:{concept_id:a}}]})}createLabResult(a,l,u,c="numeric"){return Ae.postJson("lab/tests/".concat(a,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Be.conceptID},value:l,value_modifier:u,value_type:c}]})}static getSpecimens(a){return Ae.getJson("/lab/specimen_types",{test_type:a})}static async getOrders(a,l={}){var c;return(c=(await Ae.getJson("/lab/orders",{patient_id:a,...l})).data)!=null?c:[]}static async getViralLoadResultTrail(a,l={}){return(await this.getOrders(a,l)).reduce((c,b)=>(b.tests.forEach(o=>o.result.forEach(r=>c.push({...b,test:o.name,result:"".concat(r.value_modifier," ").concat(r.value),result_date:r.date}))),c),[])}static async getlatestViralLoadResult(a,l={}){const c=(await this.getOrders(a,l)).flatMap(o=>o.tests.flatMap(r=>r.result)).filter(Boolean);if(L(c))return"N/A";const b=Sa(c,"date","desc")[0];return"".concat(b.value_modifier).concat(b.value," (").concat(me(b.date),")")}};Mt(Be,"conceptID",-1);let Ce=Be;const xa=ee({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=q(!1),u=vt(["=",">","<",">=","<="]),c=vt(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),b=q([]),o=a.patient.getBirthdate(),r=se({orderDate:{value:"",label:"Order Date",required:!0,validation:async p=>oe(p.value).isValid()?new Date(p.value)>new Date(ae())?["Order date cannot be in the future"]:new Date(p.value)<new Date(o)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(p,v)=>oe(p.value).isValid()?new Date(p.value)>new Date(ae())?["Result date cannot be in the future"]:new Date(p.value)<new Date(v.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function d(){ze(r,async p=>{const v=new Ce(a.patient.getID());if(await v.loadConcepts(),v.setDate(p.orderDate),!await v.createEncounter())throw new Error("Unable to create lab order encounter");const A=await v.createLabOrder(p.specimen.value,p.reason.value);if(!A.ok||!A.data)throw new Error("Unable to save lab orders");const E=new Ce(a.patient.getID());if(E.setDate(p.resultDate),!await E.createEncounter())throw new Error("Unable to create lab result encounter");const g=l.value?"LDL":parseInt(p.result),R=l.value?"=":p.modifier.value,S=l.value?"text":"numeric",F=A.data[0].tests[0].id;await E.createLabResult(F,g,R,S),await x.hide(),j.emit(W.RELOAD_LATEST_VL_RESULT),j.emit(W.RELOAD_PATIENT_VISIT_DATA)})}async function f(){if(await Ie("Are you sure you want to clear all fields?")){l.value=!1;for(const p in r)r[p].value="",r[p].error="";j.emit(W.ON_CLEAR)}}return he(l,p=>{p&&(r.modifier.value="",r.result.value=void 0,r.modifier.error="",r.result.error=""),r.modifier.disabled=p,r.modifier.required=!p,r.result.disabled=p,r.result.required=!p}),we(async()=>{b.value=(await Ce.getSpecimens("HIV viral load")).data.map(p=>({label:p.name,value:p.concept_id}))}),(p,v)=>(_(),G(J,null,[t(i(He),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(nt),null,{default:n(()=>[...v[8]||(v[8]=[$("Viral Load Results",-1)])]),_:1})]),_:1})]),_:1}),t(i(Ge),{class:"ion-padding"},{default:n(()=>[t(i(fe),{style:{width:"100%"}},{default:n(()=>[t(i(ne),null,{default:n(()=>[t(i(P),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Re,{modelValue:r.orderDate,"onUpdate:modelValue":v[0]||(v[0]=T=>r.orderDate=T),form:r,minDate:i(o),maxDate:i(ae)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ye,{modelValue:r.reason,"onUpdate:modelValue":v[1]||(v[1]=T=>r.reason=T),options:i(c)},null,8,["modelValue","options"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ye,{modelValue:r.specimen,"onUpdate:modelValue":v[2]||(v[2]=T=>r.specimen=T),options:b.value},null,8,["modelValue","options"])]),_:1}),t(i(P),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Re,{modelValue:r.resultDate,"onUpdate:modelValue":v[3]||(v[3]=T=>r.resultDate=T),form:r,minDate:r.orderDate.value,"max-date":i(ae)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ye,{modelValue:r.modifier,"onUpdate:modelValue":v[4]||(v[4]=T=>r.modifier=T),options:i(u)},null,8,["modelValue","options"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ve,{modelValue:r.result,"onUpdate:modelValue":v[5]||(v[5]=T=>r.result=T),form:r,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),t(i(ne),{class:"ion-margin-top"},{default:n(()=>[t(i(P),{size:"12"},{default:n(()=>[t(i(Ue),{class:"ion-padding-vertical bold"},{default:n(()=>[...v[9]||(v[9]=[$(" Other Results Options: ",-1)])]),_:1}),t(i(at),null,{default:n(()=>[t(i(Ue),null,{default:n(()=>[...v[10]||(v[10]=[$("LDL",-1)])]),_:1}),t(i(Tt),{slot:"start",modelValue:l.value,"onUpdate:modelValue":v[6]||(v[6]=T=>l.value=T)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(i(Le),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(Z),{color:"primary",onClick:v[7]||(v[7]=T=>i(x).hide()),slot:"end"},{default:n(()=>[...v[11]||(v[11]=[$(" Close ",-1)])]),_:1}),t(i(Z),{color:"warning",onClick:f,slot:"end"},{default:n(()=>[...v[12]||(v[12]=[$(" Reset ",-1)])]),_:1}),t(i(Z),{color:"success",onClick:d,slot:"end"},{default:n(()=>[...v[13]||(v[13]=[$(" Save ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),ja=ee({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:$t},emits:["voidOutcome"],setup(e,{emit:a}){const l=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:o=>oe(o).format(bt)},{path:"end_date",label:"End Date",formatter:o=>oe(o).format(bt)}],u={showSearchField:!1,showSubmitButton:!1};return{rows:M(()=>e.patientStates.map((o,r)=>({...o,index:r}))),columns:l,tableConfig:u,TableRowActions:[{label:"void",color:"danger",action:async o=>{await Ie("Are you sure you want to void this outcome?")&&a("voidOutcome",{stateId:o.patient_state_id,index:o.index})}}]}}});function Wa(e,a,l,u,c,b){const o=I("data-table");return _(),G(J,null,[a[0]||(a[0]=C("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1)),t(o,{rows:e.rows,columns:e.columns,config:e.tableConfig,"row-actions-buttons":e.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const Ya=ue(ja,[["render",Wa]]),Xa=ee({name:"EnrollmentForm",components:{DateInput:Re,IonGrid:fe,IonRow:ne,IonCol:P,IonButton:Z},props:["birthdate","patientId"],setup(e){const a=se({programId:{label:"Select program",required:!0,value:""},date:{value:"",label:"Date of Enrollment",required:!0,validation:async o=>Qt(o,e.birthdate)}}),{enrollPatient:l,fetchPatientPrograms:u}=gt(e.patientId),c=async()=>{await Ie("Are you sure you want to clear all fields")&&(a.date.value="",a.date.error="",j.emit(W.ON_CLEAR))};async function b(){await qe(a)&&re.show(),await l(a.date.value),await Me("Program enrolled successfully"),await x.hide(),u().catch(console.error)}return{form:a,today:ae,onReset:c,enrollProgram:b}}});function Ja(e,a,l,u,c,b){const o=I("DateInput"),r=I("ion-col"),d=I("ion-button"),f=I("ion-row"),p=I("ion-grid");return _(),k(p,null,{default:n(()=>[t(f,null,{default:n(()=>[t(r,{size:"12"},{default:n(()=>[t(o,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=v=>e.form.date=v),form:e.form,minDate:e.birthdate,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(r,null,{default:n(()=>[t(d,{color:"warning",onClick:e.onReset},{default:n(()=>[...a[1]||(a[1]=[$("Reset",-1)])]),_:1},8,["onClick"]),t(d,{color:"success",onClick:e.enrollProgram},{default:n(()=>[...a[2]||(a[2]=[$("Enroll",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Qa=ue(Xa,[["render",Ja]]),Ka=ee({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:Re,IonGrid:fe,IonRow:ne,IonCol:P,IonButton:Z,SelectInput:ye,TextInput:Pe},emits:["saveOutcome"],setup(e,{emit:a}){const l=oe().format("YYYY-MM-DD"),u=se({date:{value:"",label:"Outcome Date",required:!0,validation:async d=>new Date(d.value)<new Date(e.birthdate)?["Outcome date cannot be before date of birth - ".concat(oe(e.birthdate).format(bt))]:new Date(d.value)<new Date(e.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(oe(e.dateEnrolled).format(bt))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(d,f)=>f.status.value.label==="Patient transferred out"&&De(d)},reason:{value:"",label:"Reason for transfer out",validation:async(d,f)=>f.status.value.label==="Patient transferred out"&&De(d)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(d,f)=>{var p,v,T,A;return((v=(p=f.status)==null?void 0:p.value)==null?void 0:v.label)==="Patient transferred out"&&((A=(T=f.reason)==null?void 0:T.value)==null?void 0:A.label)==="Other"&&De(d)}}}),c=M(()=>{var d;return((d=u.status.value)==null?void 0:d.label)==="Patient transferred out"}),b=M(()=>{var d,f;return((f=(d=u.reason)==null?void 0:d.value)==null?void 0:f.label)==="Other"});return{form:u,today:l,isTransferredOut:c,specifyOther:b,onSave:()=>ze(u,d=>a("saveOutcome",{...d,isTransferredOut:c.value})),onReset:async()=>{if(await Ie("are you sure you want to clear all fields")){for(const d in u)u[d].value="",u[d].error="";j.emit(W.ON_CLEAR)}},getFacilities:Zt,transferOutReasons:ka}}});function Za(e,a,l,u,c,b){const o=I("ion-col"),r=I("DateInput"),d=I("SelectInput"),f=I("text-input"),p=I("ion-button"),v=I("ion-row"),T=I("ion-grid");return _(),k(T,null,{default:n(()=>[t(v,null,{default:n(()=>[t(o,{size:"12"},{default:n(()=>[...a[5]||(a[5]=[C("p",null,"Add New Outcome",-1)])]),_:1}),t(o,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(r,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=A=>e.form.date=A),form:e.form,minDate:e.dateEnrolled,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(o,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(d,{modelValue:e.form.status,"onUpdate:modelValue":a[1]||(a[1]=A=>e.form.status=A),form:e.form,options:e.outcomes},null,8,["modelValue","form","options"])]),_:1}),e.isTransferredOut?(_(),G(J,{key:0},[t(o,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(d,{modelValue:e.form.nextFacility,"onUpdate:modelValue":a[2]||(a[2]=A=>e.form.nextFacility=A),form:e.form,asyncOptions:e.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),t(o,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(d,{modelValue:e.form.reason,"onUpdate:modelValue":a[3]||(a[3]=A=>e.form.reason=A),form:e.form,options:e.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),e.specifyOther?(_(),k(o,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[t(f,{modelValue:e.form.otherReason,"onUpdate:modelValue":a[4]||(a[4]=A=>e.form.otherReason=A),form:e.form},null,8,["modelValue","form"])]),_:1})):z("",!0)],64)):z("",!0),t(o,{size:"12",class:"ion-margin-top"},{default:n(()=>[t(p,{color:"warning",onClick:e.onReset},{default:n(()=>[...a[6]||(a[6]=[$("Reset",-1)])]),_:1},8,["onClick"]),t(p,{color:"success",onClick:e.onSave},{default:n(()=>[...a[7]||(a[7]=[$("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const en=ue(Ka,[["render",Za]]),tn={class:"ion-page",id:"main"},an={class:"ion-margin-start"},nn=ee({__name:"OutcomeStatus",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=q(),u=M(()=>a.patient.getID()),c=M(()=>{var h,D;return(D=(h=l.value)==null?void 0:h.other)==null?void 0:D.date_enrolled}),b=M(()=>kt(a.patient.getBirthdate())),o=M(()=>{var h;return f.value.get((h=l.value)==null?void 0:h.value)}),r=M(()=>{var h,D,B,H;return(H=(B=(D=(h=l.value)==null?void 0:h.other)==null?void 0:D.patient_states)==null?void 0:B.length)!=null?H:0}),{patientPrograms:d,programStates:f,hasArtProgram:p,updateState:v,voidProgram:T,voidState:A,fetchPatientPrograms:E}=gt(u.value);function V(h){l.value=h}async function g(h,D,B=""){const H=new ge(u.value,Te.EXIT_FROM_HIV_CARE,D);if(!await H.createEncounter())throw"Unable to transfer out encounter";return B&&await H.saveValueTextObs("Reason for transfer out",B),H.saveValueTextObs("Transfer to",h.name)}async function R(h){var de;const{date:D,status:B,nextFacility:H,reason:Y,otherReason:y,isTransferredOut:O}=h;if(O){const xe=Y.value!=="Other"?Y.value:y;await g(H.other,D,xe)}await v(B.value,D,(de=l.value)==null?void 0:de.value),await Me("Outcome saved successfully",1e3),await x.hide(),j.emit(W.RELOAD_PATIENT_VISIT_DATA)}async function S(){var h,D,B;await T((B=(D=(h=l.value)==null?void 0:h.other)==null?void 0:D.patient_program_id)!=null?B:-1,"duplicate / system error"),await Me("Patient voided from program successfully",1e3),await x.hide(),j.emit(W.RELOAD_PATIENT_VISIT_DATA)}async function F({stateId:h,index:D}){var B,H,Y;await A(h,"duplicate / system error",(B=l.value)==null?void 0:B.value),Me("Outcome voided successfully"),(Y=(H=l.value)==null?void 0:H.other)==null||Y.patient_states.splice(D,1),j.emit(W.RELOAD_PATIENT_VISIT_DATA)}async function m(){await x.show(Qa,{birthdate:b.value,patientId:u.value},"custom-modal custom-modal-backdrop")}return we(E),(h,D)=>{const B=I("ion-icon"),H=I("ion-buttons");return _(),k(i(sa),{when:"xs",contentId:"main"},{default:n(()=>[t(i(ia),{contentId:"main"},{default:n(()=>[t(i(He),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(nt),null,{default:n(()=>[...D[0]||(D[0]=[$("Patient Programs",-1)])]),_:1})]),_:1})]),_:1}),t(i(Ge),{class:"ion-no-padding"},{default:n(()=>[t(i(jt),null,{default:n(()=>[(_(!0),G(J,null,Ve(i(d),Y=>{var y;return _(),k(i(at),{button:"",key:Y.value,color:Y.value===((y=l.value)==null?void 0:y.value)?"secondary":"light",onClick:O=>V(Y)},{default:n(()=>[t(i(Ue),null,{default:n(()=>[$(K(Y.label),1)]),_:2},1024)]),_:2},1032,["color","onClick"])}),128))]),_:1})]),_:1}),t(i(Le),null,{default:n(()=>[t(i(pe),{class:"ion-padding-start"},{default:n(()=>[l.value?(_(),k(i(Z),{key:0,color:"danger",onClick:S,slot:"start"},{default:n(()=>[...D[1]||(D[1]=[$("Void Program",-1)])]),_:1})):z("",!0),i(p)?z("",!0):(_(),k(i(Z),{key:1,onClick:m,slot:"start"},{default:n(()=>[...D[2]||(D[2]=[$("Enroll HIV Program",-1)])]),_:1}))]),_:1})]),_:1})]),_:1}),C("div",tn,[t(i(He),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(H,{slot:"end"},{default:n(()=>[t(i(Z),{onClick:i(x).hide,color:"danger",size:"large"},{default:n(()=>[t(B,{size:"large",icon:i(la)},null,8,["icon"])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),t(i(Ge),{class:"ion-padding"},{default:n(()=>[l.value?(_(),k(i(fe),{key:0,style:{width:"100%"}},{default:n(()=>[t(i(ne),{class:"his-card",style:Wt({minHeight:r.value?"0":"30vh"})},{default:n(()=>[t(i(P),{size:"12",class:"ion-no-padding"},{default:n(()=>{var Y,y,O;return[C("h5",an," Enrollment Date: "+K(c.value?i(me)(c.value):"Unknown"),1),t(Ya,{patientStates:(O=(y=(Y=l.value)==null?void 0:Y.other)==null?void 0:y.patient_states)!=null?O:[],onVoidOutcome:F},null,8,["patientStates"])]}),_:1})]),_:1},8,["style"]),o.value?(_(),k(i(ne),{key:0,class:"his-card ion-margin-top",style:{"margin-bottom":"0.4rem"}},{default:n(()=>[t(en,{"date-enrolled":c.value,birthdate:b.value,outcomes:o.value,onSaveOutcome:R},null,8,["date-enrolled","birthdate","outcomes"])]),_:1})):z("",!0)]),_:1})):z("",!0)]),_:1}),t(i(Le),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(Z),{slot:"end",color:"warning"},{default:n(()=>[...D[3]||(D[3]=[$(" Reset ",-1)])]),_:1}),t(i(Z),{slot:"end",color:"primary"},{default:n(()=>[...D[4]||(D[4]=[$(" Submit ",-1)])]),_:1})]),_:1})]),_:1})])]),_:1})}}});class on extends ge{constructor(a,l=ae()){super(a,Te.TREATMENT,l)}calculateDosage(a,l){let u=0;return l===0&&(u=a),a==0&&(u=l),a>0&&l>0&&(u=(a+l)/2),u}calculateEquivalentDosage(a,l){return a+l}calculateDrugRunOutDate(a,l){return kt(oe(l).add(a,"days"))}getInstructions(a,l,u,c){return"".concat(a," :- Morning: ").concat(l," ").concat(c,", Evening: ").concat(u," ").concat(c)}toDrugOrder(a,l,u,c){return{drug_inventory_id:a.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(a.am,a.pm),start_date:c,auto_expire_date:this.calculateDrugRunOutDate(u,c),units:a.units,instructions:this.getInstructions(a.drug_name,a.am,a.pm,a.units),dose:this.calculateDosage(a.am,a.pm),frequency:a.frequency,qty:l}}async createDrugOrder(a){return Et.create({encounter_id:this.encounterID,drug_orders:a})}}class ln extends ge{constructor(a,l=ae()){super(a,Te.HIV_RECEPTION,l)}}class ea extends ge{constructor(a,l=ae()){super(a,Te.ART_ADHERENCE,l)}buildPillCountObs(a,l){return this.buildValueNumber("Number of tablets brought to clinic",l,null,a)}async buildAdherenceObs(a,l,u){return{concept_id:await ge.getConceptID("Drug adherence",!0),value_numeric:u,value_drug:l,value_modifier:"%",order_id:a,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(a,l,u){return Math.round(100*(a-l)/(a-u))}calculateExpected(a,l,u,c){const b=c==="QW"?"week":"day",o=this.calcTimeElapsed(u,b);return a-o*parseFloat(l.toString())}calcTimeElapsed(a,l){return oe(this.date).diff(a,l)+1}}class sn extends ge{constructor(a,l=ae()){super(a,Te.APPOINTMENT,l)}}class rn extends ge{constructor(a,l=ae()){super(a,Te.DISPENSING,l)}buildDispensations(a,l,u){const c=[];for(let b=0;b<u;b++)c.push({drug_order_id:a,date:this.date,quantity:l/u});return c}saveDispensations(a){return Ae.postJson("/dispensations",{dispensations:a,program_id:this.programID})}}class un{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(a,l,u){let c={result:"",color:"",index:u};if(u<=0)return c.index=0,c;if(l<5&&l>0)c.result="Use MUAC to calculate nutrition status",c.color="red";else{l>18&&(l=19);const b=await this.getBMIData(),o=b[a][l];o&&(c=this.buildBounds(Object.keys(o),o,u,b.colors))}return c}static buildBounds(a,l,u,c){const b={result:"",color:"",index:u};return a.forEach(o=>{if(o.indexOf("-")>=0){const r=o.split("-");u>=parseFloat(r[0])&&u<=parseFloat(r[1])&&(b.result=l[o],b.color=c[l[o]])}else if(o.indexOf("<")>=0){const r=o.replace("<","");u<parseFloat(r)&&(b.result=l[o],b.color=c[l[o]])}else if(o.indexOf(">=")>=0){const r=o.replace(">=","");u>=parseFloat(r)&&(b.result=l[o],b.color=c[l[o]])}}),b}static getBMI(a,l,u,c){const b=this.calculateBMI(a,l);return this.getBMIResult(u,c,b)}static calculateBMI(a,l){if(l==0||a==0)return 0;let u=a/l/l*1e4;return u=Math.round(u*10)/10}}function dn(e){const a=M(()=>e.getID()),l=new Ra(a.value),u=new Na(a.value),c=new on(a.value),b=new rn(a.value),o=new ln(a.value),r=new ea(a.value),d=new sn(a.value),f=q(),p=q(),v=q([]),T=q([]),A=q([]),E=q([]),V=M(()=>e.isFemale()),g=q(""),R=e.getBirthdate(),S=q(!1),F=se({}),m=M(()=>E.value.reduce((s,N)=>{var U;const w=(U=N.drug.name)!=null?U:N.regimen;return s[w]={label:"".concat(w," brought"),placeholder:"Enter number of ".concat(w," pills brought"),required:!0,value:void 0,computedValue:async Q=>{const te=r.calculateExpected(N.quantity,N.equivalent_daily_dose,N.order.start_date,N.frequency),Ne=r.calculateAdherence(N.quantity,Q,te);return[await r.buildAdherenceObs(N.order_id,N.drug_inventory_id,Ne),await r.buildPillCountObs(N.order_id,Q)]}},s},{})),h=M(()=>!(f.value&&e.getAge()>18)),D=se({visitDate:{value:oe().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async s=>new Date(s.value)>new Date(ae())?["Visit date cannot be after today's date"]:Qt(s,R)},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:s=>({tag:"reception",obs:o.buildValueCoded("Patient present",s)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:s=>({tag:"reception",obs:o.buildValueCoded("Guardian present",s)})},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:V.value,computedValue:s=>({tag:"consultation",obs:u.buildValueCoded("Is patient pregnant",s)}),validation:async s=>V.value&&De(s)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:V.value,computedValue:s=>({tag:"consultation",obs:u.buildValueCoded("Is patient breast feeding",s)}),validation:async s=>V.value&&De(s)},weight:{value:void 0,label:"Weight",required:!0,computedValue:s=>({tag:"vitals",obs:l.buildValueNumber("Weight",s)}),validation:(s,N)=>(L(s)||!s.value)&&N.patientPresent.value==="No"?null:Ze([()=>De(s),()=>_e(s,"DECIMALS"),()=>xt(s,2,250)])},height:{value:void 0,label:"Height (cm)",computedValue:s=>({tag:"vitals",obs:l.buildValueNumber("Height",s)}),validation:s=>!h.value||(L(s)||!s.value)&&D.patientPresent.value==="No"?null:Ze([()=>De(s),()=>_e(s),()=>xt(s,20,220)])},bp:{value:"",label:"Blood Pressure (mmHG)",placeholder:"Enter Blood Pressure e.g 120/80",validation:s=>L(s)||!s.value?null:Oa(s),computedValue:s=>{if(L(s))return null;const[N,w]=s.split("/").map(Number);return{tag:"vitals",obs:[l.buildValueNumber("Systolic",N),l.buildValueNumber("Diastolic",w)]}}}}),B=se({tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:s=>({tag:"consultation",obs:u.buildValueCoded("TB Status",s.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async s=>{if(!S.value){if(new Date(s.value)>new Date(ae()))return["TB treatment start date cannot be after today's date"];if(new Date(s.value)<new Date(R))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:s=>({tag:"consultation",obs:u.buildValueDate("TB treatment start date",s)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:s=>({tag:"consultation",obs:u.buildValueNumber("TB treatment period",s)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:s=>({tag:"consultation",obs:u.buildGroupValueCoded("TB screening method used","chest xray",s)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:s=>({tag:"consultation",obs:u.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",s)})},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async s=>Ze([()=>De(s),()=>s.value==="No"||T.value.some(N=>N.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async s=>Ze([()=>De(s),()=>s.value==="No"||A.value.some(N=>N.isChecked)?null:["Please select at least one side effect"]])}}),H=se({regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:c.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:c.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:c.buildValueCoded("Medication orders","INH")}),validation:async(s,N)=>{var w,U;return(((w=N.tbMed.value)==null?void 0:w.label)==="6H"||((U=N.tbMed.value)==null?void 0:U.label)==="3HP (RFP + INH)")&&_e(s)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:c.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(s,N)=>{var w;return((w=N.tbMed.value)==null?void 0:w.label)==="3HP (RFP + INH)"&&_e(s)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:c.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(s,N)=>{var w;return((w=N.tbMed.value)==null?void 0:w.label)==="3HP (INH 300 / RFP 300)"&&_e(s)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(s,N)=>{var w;return((w=N.tbMed.value)==null?void 0:w.label)&&_e(s)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"}}),Y=se({nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:s=>({tag:"appointment",obs:d.buildValueDate("Appointment date",s)}),validation:async(s,N)=>new Date(s.value)<new Date(D.visitDate.value)?["Appointment date cannot be before visit date"]:g.value&&new Date(s.value)>new Date(g.value)?["Appointment date cannot be after drug run out date"]:null}}),y=se({...D,...B,...H,...Y}),O=vt(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),de=vt(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),xe=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],ht=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],ot=M(()=>{var s;return((s=y.tbMed.value)==null?void 0:s.label)==="3HP (INH 300 / RFP 300)"}),je=M(()=>{var s;return((s=y.tbMed.value)==null?void 0:s.label)==="3HP (RFP + INH)"}),it=M(()=>{var s;return((s=y.tbMed.value)==null?void 0:s.label)==="6H"}),_t=M(()=>y.hasContraindications.value==="Yes"),lt=M(()=>y.hasSideEffects.value==="Yes"),st=M(()=>{var s;return/Confirmed TB on treatment/i.test((s=y.tbStatus.value)==null?void 0:s.label)}),wt=M(()=>{var s;return/Suspected/i.test((s=y.tbStatus.value)==null?void 0:s.label)});async function Vt(){const s=["visitDate","patientPresent","guardianPresent","weight"];V.value&&s.push("isPregnant","isBreastfeeding"),h.value&&s.push("height");for(const N of s){const w=y[N];if(!w)continue;const{required:U,value:Q,validation:te}=w;if(U&&L(Q)){w.error="This field is required";continue}if(typeof te=="function"){const be=await te(typeof Q=="object"?Q:{label:Q,value:Q},y);w.error=L(be)?"":be.join()}else w.error=""}return s.every(N=>{var w;return!((w=y[N])!=null&&w.error)})}async function Dt(){const s=["tbStatus"];st.value&&!S.value&&s.push("tbTreatmentStartDate","tbTreatmentPeriod");for(const N of s){const w=y[N];if(!w)continue;const{required:U,value:Q,validation:te}=w;if(U&&L(Q)){w.error="This field is required";continue}if(typeof te=="function"){const be=await te(typeof Q=="object"?Q:{label:Q,value:Q},y);w.error=L(be)?"":be.join()}else w.error=""}return s.every(N=>{var w;return!((w=y[N])!=null&&w.error)})}async function It(){return!(!L(m.value)&&!await qe(m.value)||y.regimen.value&&!L(F)&&!await qe(F))}async function Rt(){const s=y.nextAppointmentDate;if(!s)return!0;const{required:N,value:w,validation:U}=s;if(N&&L(w))return s.error="This field is required",!1;if(typeof U=="function"){const te=await U(typeof w=="object"?w:{label:w,value:w},y);return s.error=L(te)?"":te.join(),!s.error}return s.error="",!0}he(()=>y.regimen.value,s=>{var N;Xe(),s&&((N=s==null?void 0:s.other)==null||N.forEach(w=>{var U;F[w.drug_name]={label:"".concat((U=w.drug_name)!=null?U:w.alternative_drug_name," given"),value:void 0,required:!0,validation:Q=>Ze([()=>_e(Q,"POSITIVE_INTEGERS"),()=>Number(Q.value)%30!==0?["Quantity should be in multiples of 30"]:null])}}))}),he(()=>y.patientPresent.value,s=>{s==="No"?(y.weight.required=!1,y.weight.error="",y.guardianPresent.value="Yes"):y.weight.required=!0}),he(()=>y.guardianPresent.value,s=>{s==="No"&&(y.patientPresent.value="Yes")}),he([()=>y.weight.value,()=>{var s;return(s=y.tbStatus)==null?void 0:s.value}],async([s,N])=>{var U;y.regimen.value=void 0,Xe();const w=/confirmed/i.test((U=N==null?void 0:N.label)!=null?U:"");s?(v.value=await Oe.getRegimens(s,w,y.visitDate.value),y.patientPresent.value="Yes",y.patientPresent.disabled=!0):!s&&y.weight.required&&(y.patientPresent.value=void 0,y.patientPresent.disabled=!1),y.tbMed.disabled=w}),he(()=>y.nextAppointmentDate.value,async s=>{s&&g.value&&oe(g.value).diff(oe(s),"days")>7&&await Ie("The selected appointment date ".concat(me(s)," is more than 7 days earlier than drug run out date. \n            The client will have excess medication"),{header:"Drug Dispensation Alert",icon:"informationOutline",confirmBtnLabel:"OK",showCancelBtn:!1,color:"danger"})});const We=()=>{var s,N;return L(F)?1/0:Math.min(...((N=(s=y.regimen.value)==null?void 0:s.other)!=null?N:[]).map(w=>{var Ne,be,dt,Je,Qe;const U=Number((be=(Ne=F[w.drug_name])==null?void 0:Ne.value)!=null?be:0),Q=Number(w.am+w.noon+w.pm||1),te=Number((Qe=(Je=(dt=m.value)==null?void 0:dt[w.drug_name])==null?void 0:Je.value)!=null?Qe:0);return U/Q+te}))};he([()=>F,()=>m,()=>y.visitDate.value],()=>{const s=We();if(s!==1/0){g.value=c.calculateDrugRunOutDate(s,y.visitDate.value),y.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(me(g.value),")");const N=oe(g.value).subtract(2,"day"),w=N.day();let U;w===0?U=N.subtract(2,"day"):w===6?U=N.subtract(1,"day"):U=N,y.nextAppointmentDate.value=kt(U)}},{deep:!0,immediate:!0}),he(()=>y.visitDate.value,()=>Ye());const Ye=async()=>{u.setDate(y.visitDate.value),S.value=!1;const s=await u.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(s)){const N=await u.getFirstValueDatetime("TB treatment start date"),w=(await u.getFirstValueNumber("TB treatment period")||6)*30;if(N){const U=oe(y.visitDate.value).diff(N,"days");S.value=U<=w}}y.tbStatus.required=!S.value},Xe=()=>{for(const s in F)delete F[s]},rt=async s=>{const N=s.height||f.value,w=un.calculateBMI(s.weight,N);return l.buildValueNumber("BMI",w)},ie=async()=>{const s=[await u.buildValueCoded("Patient using family planning","No")];return u.getFamilyPlanningMethods().forEach(async w=>{s.push(await u.buildValueCoded(w,"No"))}),s},X=async()=>Promise.all(ft.getConceptsByCategory("tb_symptom",!0).map(async s=>u.buildGroupValueCoded(s.name,s.name,"No")));return{form:y,drugsForm:F,adherenceForm:m,regimens:v,contraIndications:T,sideEffects:A,prevDrugs:E,isFemale:V,drugRunOutDate:g,isOnActiveTBTreatment:S,showHeightField:h,tbMeds:O,tbStatuses:de,chestXRayResultsOptions:xe,mwrdResultsOptions:ht,hasGiven3HP:ot,hasGivenRFP:je,hasGiven6H:it,hasContraindications:_t,hasSideEffects:lt,isOnTBTreatment:st,canTestForTB:wt,loadPatientData:async()=>{try{await Ye(),f.value=await e.getRecentHeight(),p.value=await e.getRecentWeight(),p.value&&(v.value=await Oe.getRegimens(p.value)),E.value=await Et.getLastDrugsReceived(e.getID()),T.value=ft.getConceptsByCategory("contraindication",!0).map(s=>({value:s.concept_id,label:s.name,other:s,isChecked:!1})),A.value=ft.getConceptsByCategory("side_effect",!0).map(s=>({value:s.concept_id,label:s.name,other:s,isChecked:!1}))}catch(s){Ee("Form initialization failed. Try to refresh the page"),console.error(s)}},resetForm:async()=>{if(await Ie("Are you sure you want to clear all fields?")){for(const s in y)y[s].value="",y[s].error="",y[s].disabled=!1;return Xe(),!0}return!1},saveVisit:async()=>{l.setDate(y.visitDate.value),u.setDate(y.visitDate.value),c.setDate(y.visitDate.value),o.setDate(y.visitDate.value),r.setDate(y.visitDate.value),d.setDate(y.visitDate.value),b.setDate(y.visitDate.value),await ze(y,async(s,N)=>{var Je,Qe,Ft,Bt,qt;const w=[];let U=0;if(!L(s.regimen)&&await qe(F)){const le=s.regimen.other,$e=pt(F).formData;U=We(),le.forEach(ce=>w.push(c.toDrugOrder(ce,$e[ce.drug_name],U,s.visitDate)))}else if(!await Ie("Are you sure you want to continue without dispensing ART drugs?"))return;if(re.show("Saving patient visit..."),s.totalCPTGiven&&zt((await Oe.getRegimenExtras("Cotrimoxazole",(Je=s.weight)!=null?Je:p.value)).data,"concept_name").filter(le=>le.frequency==="Daily (QOD)").forEach(le=>w.push(c.toDrugOrder(le,s.totalCPTGiven,U,s.visitDate))),(Qe=s.tbMed)!=null&&Qe.value){const le=zt((await Oe.getRegimenExtras("INH",(Ft=s.weight)!=null?Ft:p.value)).data,["concept_name","frequency"]),$e=le.find(ce=>ce.concept_name==="Pyridoxine");if($e&&s.totalPyridoxineGiven&&w.push(c.toDrugOrder($e,s.totalPyridoxineGiven,U,s.visitDate)),s.totalIPTGiven){const ce=le.find(Ke=>Ke.concept_name==="Isoniazid"&&(it.value&&Ke.frequency==="Daily (QOD)"||je.value&&Ke.frequency==="Weekly (QW)"));w.push(c.toDrugOrder(ce,s.totalIPTGiven,U,s.visitDate))}if(s.totalRFPGiven&&je.value){const ce=(await Oe.getRegimenExtras("Rifapentine",(Bt=s.weight)!=null?Bt:p.value)).data;ce.length&&w.push(c.toDrugOrder(ce[0],s.totalRFPGiven,U,s.visitDate))}if(s.total3HPGiven&&ot.value){const ce=(await Oe.getRegimenExtras("INH / RFP",(qt=s.weight)!=null?qt:p.value)).data;w.push(c.toDrugOrder(ce[0],s.total3HPGiven,U,s.visitDate))}}if(!L(w)){await c.createEncounter();const $e=(await c.createDrugOrder(w)).data.map(ce=>{const Ke=w.find(aa=>aa.drug_inventory_id===ce.drug_inventory_id);return b.buildDispensations(ce.order_id,Ke.qty,1)});await b.saveDispensations($e.flat(1))}const Q=await Fe(N,"vitals");if(!L(Q)){await l.createEncounter();const le=await rt(s);await l.saveObservationList([...Q,le])}await u.createEncounter();const te=await Fe(N,"consultation");te.push(...await u.buildOptionsGroupObs("Malawi ART side effects",T.value)),te.push(...await X()),lt.value&&te.push(...await u.buildOptionsGroupObs("Other side effect",A.value)),V.value&&te.push(...await ie()),await u.saveObservationList(te),await o.createEncounter();const Ne=await Fe(N,"reception");await o.saveObservationList(Ne);const be=pt(m.value).computedFormData;if(!L(be)){const le=await Fe(be);L(le)||(await r.createEncounter(),await r.saveObservationList(le.flat()))}await d.createEncounter();const dt=await Fe(N,"appointment");await d.saveObservationList(dt)},{showloader:!1})},validateReceptionStep:Vt,validateConsultationStep:Dt,validateMedicationStep:It,validateAppointmentStep:Rt}}const cn={class:"step-container"},mn=ee({__name:"StepContainer",props:{title:{type:String,required:!0},isFirstStep:{type:Boolean,default:!1},isLastStep:{type:Boolean,default:!1},stepIndex:{type:Number,required:!0}},emits:["back","next"],setup(e,{emit:a}){return(l,u)=>(_(),G("div",cn,[C("h2",null,K(e.title),1),Yt(l.$slots,"default",{},void 0,!0)]))}});const yt=ue(mn,[["__scopeId","data-v-fc159c8d"]]),fn=ee({__name:"ReceptionStep",props:{form:{type:Object,required:!0},isFemale:{type:Boolean,required:!0},birthdate:{type:String,required:!0},showHeightField:{type:Boolean,required:!0}},emits:["next"],setup(e,{emit:a}){const l=a,u=()=>{l("next",0)};return(c,b)=>(_(),k(yt,{title:"Reception","is-first-step":!0,"is-last-step":!1,"step-index":0,onNext:u},{default:n(()=>[t(i(fe),{style:{width:"100%"}},{default:n(()=>[t(i(ne),null,{default:n(()=>[t(i(P),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Re,{modelValue:e.form.visitDate,"onUpdate:modelValue":b[0]||(b[0]=o=>e.form.visitDate=o),form:e.form,minDate:e.birthdate,maxDate:i(ae)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Se,{modelValue:e.form.patientPresent,"onUpdate:modelValue":b[1]||(b[1]=o=>e.form.patientPresent=o),disabled:e.form.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Se,{modelValue:e.form.guardianPresent,"onUpdate:modelValue":b[2]||(b[2]=o=>e.form.guardianPresent=o)},null,8,["modelValue"])]),_:1}),e.isFemale?(_(),G(J,{key:0},[t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Se,{modelValue:e.form.isPregnant,"onUpdate:modelValue":b[3]||(b[3]=o=>e.form.isPregnant=o)},null,8,["modelValue"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Se,{modelValue:e.form.isBreastfeeding,"onUpdate:modelValue":b[4]||(b[4]=o=>e.form.isBreastfeeding=o)},null,8,["modelValue"])]),_:1})],64)):z("",!0),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ve,{modelValue:e.form.weight,"onUpdate:modelValue":b[5]||(b[5]=o=>e.form.weight=o),form:e.form,min:1},null,8,["modelValue","form"])]),_:1}),e.showHeightField?(_(),k(i(P),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ve,{modelValue:e.form.height,"onUpdate:modelValue":b[6]||(b[6]=o=>e.form.height=o),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):z("",!0),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Pe,{modelValue:e.form.bp,"onUpdate:modelValue":b[7]||(b[7]=o=>e.form.bp=o),form:e.form},null,8,["modelValue","form"])]),_:1})]),_:1})]),_:1})]),_:1}))}});const vn=ue(fn,[["__scopeId","data-v-153ee5f1"]]),pn=ee({name:"MultiColumnView",components:{IonGrid:fe,IonRow:ne,IonCol:P},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(e){const a={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:M(()=>Ta(e.items,Math.ceil(e.items.length/e.numberOfColumns))),grid:a}}});function bn(e,a,l,u,c,b){const o=I("ion-col"),r=I("ion-row"),d=I("ion-grid");return _(),k(d,null,{default:n(()=>[t(r,null,{default:n(()=>[(_(!0),G(J,null,Ve(e.computedItems,(f,p)=>(_(),k(o,{key:p,size:e.grid[e.numberOfColumns]},{default:n(()=>[Yt(e.$slots,"default",{entries:f})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const Pt=ue(pn,[["render",bn]]),gn=ee({__name:"ConsultationStep",props:{form:{type:Object,required:!0},showHeightField:{type:Boolean,required:!0},tbStatuses:{type:Array,required:!0},chestXRayResultsOptions:{type:Array,required:!0},mwrdResultsOptions:{type:Array,required:!0},isOnTBTreatment:{type:Boolean,required:!0},isOnActiveTBTreatment:{type:Boolean,required:!0},canTestForTB:{type:Boolean,required:!0},birthdate:{type:String,required:!0},contraIndications:{type:Array,required:!0},sideEffects:{type:Array,required:!0},hasContraindications:{type:Boolean,required:!0},hasSideEffects:{type:Boolean,required:!0}},emits:["back","next"],setup(e,{emit:a}){const l=a,u=()=>{l("back",1)},c=()=>{l("next",1)};return(b,o)=>(_(),k(yt,{title:"Consultation","step-index":1,onBack:u,onNext:c},{default:n(()=>[t(i(fe),{style:{width:"100%"}},{default:n(()=>[t(i(ne),null,{default:n(()=>[t(i(P),{size:"12"},{default:n(()=>[...o[7]||(o[7]=[C("h4",{class:"section-title"},"TB Assessment",-1)])]),_:1}),t(i(P),{class:"ion-margin-vertical",size:"12"},{default:n(()=>[t(ye,{modelValue:e.form.tbStatus,"onUpdate:modelValue":o[0]||(o[0]=r=>e.form.tbStatus=r),options:e.tbStatuses},null,8,["modelValue","options"])]),_:1}),e.isOnTBTreatment&&!e.isOnActiveTBTreatment?(_(),G(J,{key:0},[t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Re,{modelValue:e.form.tbTreatmentStartDate,"onUpdate:modelValue":o[1]||(o[1]=r=>e.form.tbTreatmentStartDate=r),form:e.form,minDate:e.birthdate,maxDate:i(ae)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ve,{modelValue:e.form.tbTreatmentPeriod,"onUpdate:modelValue":o[2]||(o[2]=r=>e.form.tbTreatmentPeriod=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})],64)):e.canTestForTB?(_(),G(J,{key:1},[t(i(P),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Se,{modelValue:e.form.cxrResult,"onUpdate:modelValue":o[3]||(o[3]=r=>e.form.cxrResult=r),"custom-options":e.chestXRayResultsOptions},null,8,["modelValue","custom-options"])]),_:1}),t(i(P),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Se,{modelValue:e.form.mwrdResult,"onUpdate:modelValue":o[4]||(o[4]=r=>e.form.mwrdResult=r),"custom-options":e.mwrdResultsOptions},null,8,["modelValue","custom-options"])]),_:1})],64)):z("",!0)]),_:1}),t(i(ne),null,{default:n(()=>[t(i(P),{size:"12"},{default:n(()=>[...o[8]||(o[8]=[C("h4",{class:"section-title"},"Side Effects & Contraindications",-1)])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Se,{modelValue:e.form.hasContraindications,"onUpdate:modelValue":o[5]||(o[5]=r=>e.form.hasContraindications=r)},null,8,["modelValue"]),e.hasContraindications?(_(),k(Pt,{key:0,items:e.contraIndications,numberOfColumns:2},{default:n(({entries:r})=>[(_(!0),G(J,null,Ve(r,d=>(_(),k(i(at),{lines:"none",key:d.value},{default:n(()=>[t(i(Ue),null,{default:n(()=>[$(K(d.label),1)]),_:2},1024),t(i(Tt),{slot:"start",modelValue:d.isChecked,"onUpdate:modelValue":f=>d.isChecked=f},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):z("",!0)]),_:1}),t(i(P),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[t(Se,{modelValue:e.form.hasSideEffects,"onUpdate:modelValue":o[6]||(o[6]=r=>e.form.hasSideEffects=r)},null,8,["modelValue"]),e.hasSideEffects?(_(),k(Pt,{key:0,items:e.sideEffects,numberOfColumns:2},{default:n(({entries:r})=>[(_(!0),G(J,null,Ve(r,d=>(_(),k(i(at),{lines:"none",key:d.value},{default:n(()=>[t(i(Ue),null,{default:n(()=>[$(K(d.label),1)]),_:2},1024),t(i(Tt),{slot:"start",modelValue:d.isChecked,"onUpdate:modelValue":f=>d.isChecked=f},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):z("",!0)]),_:1})]),_:1})]),_:1})]),_:1}))}});const yn=ue(gn,[["__scopeId","data-v-1d2ba071"]]),hn=ee({__name:"MedicationStep",props:{form:{type:Object,required:!0},drugsForm:{type:Object,required:!0},adherenceForm:{type:Object,required:!0},regimens:{type:Array,required:!0},tbMeds:{type:Array,required:!0},hasGiven3HP:{type:Boolean,required:!0},hasGivenRFP:{type:Boolean,required:!0},hasGiven6H:{type:Boolean,required:!0}},emits:["back","next"],setup(e,{emit:a}){const l=a,u=()=>{l("back",3)},c=()=>{l("next",3)};return(b,o)=>(_(),k(yt,{title:"Medication & Adherence","step-index":3,onBack:u,onNext:c},{default:n(()=>[t(i(fe),{style:{width:"100%"}},{default:n(()=>[t(i(ne),null,{default:n(()=>[e.adherenceForm&&!i(L)(e.adherenceForm)?(_(),G(J,{key:0},[t(i(P),{size:"12"},{default:n(()=>[...o[7]||(o[7]=[C("h4",{class:"section-title"},"Adherence Assessment",-1),C("p",{class:"section-description"},"Record the number of pills the patient has brought back from their previous visit",-1)])]),_:1}),(_(!0),G(J,null,Ve(Object.values(e.adherenceForm),(r,d)=>(_(),k(i(P),{size:"6",class:"ion-margin-bottom",key:d},{default:n(()=>[t(ve,{"model-value":r,form:e.adherenceForm,min:0},null,8,["model-value","form"])]),_:2},1024))),128))],64)):z("",!0),t(i(P),{size:"12"},{default:n(()=>[...o[8]||(o[8]=[C("h4",{class:"section-title"},"Medication Orders",-1),C("p",{class:"section-description"},"Record the number of pills the patient has received during this visit",-1)])]),_:1}),t(i(P),{size:"12",class:"ion-margin-bottom"},{default:n(()=>[t(ye,{modelValue:e.form.regimen,"onUpdate:modelValue":o[0]||(o[0]=r=>e.form.regimen=r),options:e.regimens},null,8,["modelValue","options"])]),_:1}),i(L)(e.drugsForm)?z("",!0):(_(!0),G(J,{key:1},Ve(Object.values(e.drugsForm),(r,d)=>(_(),k(i(P),{size:"6",class:"ion-margin-bottom",key:"drug-".concat(d)},{default:n(()=>[t(ve,{"model-value":r,form:e.drugsForm,min:1},null,8,["model-value","form"])]),_:2},1024))),128)),t(i(P),{size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(ve,{modelValue:e.form.totalCPTGiven,"onUpdate:modelValue":o[1]||(o[1]=r=>e.form.totalCPTGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(ye,{modelValue:e.form.tbMed,"onUpdate:modelValue":o[2]||(o[2]=r=>e.form.tbMed=r),options:e.tbMeds,"drop-direction":"top"},null,8,["modelValue","options"])]),_:1}),e.hasGiven6H||e.hasGivenRFP?(_(),k(i(P),{key:2,size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(ve,{modelValue:e.form.totalIPTGiven,"onUpdate:modelValue":o[3]||(o[3]=r=>e.form.totalIPTGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):z("",!0),e.hasGivenRFP?(_(),k(i(P),{key:3,size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(ve,{modelValue:e.form.totalRFPGiven,"onUpdate:modelValue":o[4]||(o[4]=r=>e.form.totalRFPGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):z("",!0),e.hasGiven3HP?(_(),k(i(P),{key:4,size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(ve,{modelValue:e.form.total3HPGiven,"onUpdate:modelValue":o[5]||(o[5]=r=>e.form.total3HPGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):z("",!0),e.hasGiven3HP||e.hasGivenRFP||e.hasGiven6H?(_(),k(i(P),{key:5,size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(ve,{modelValue:e.form.totalPyridoxineGiven,"onUpdate:modelValue":o[6]||(o[6]=r=>e.form.totalPyridoxineGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):z("",!0)]),_:1})]),_:1})]),_:1}))}});const _n=ue(hn,[["__scopeId","data-v-27c751fc"]]),wn={class:"calendar-section"},Vn={class:"date-picker-container"},Dn={key:0,class:"text-danger"},In={class:"info-section"},Rn={class:"info-box"},Nn={class:"drug-runout-info"},An={class:"info-content"},Sn={class:"date"},Tn={class:"summary-section"},On={class:"summary-content"},Pn={class:"summary-item"},Cn={class:"value"},En={class:"summary-item"},kn={class:"value"},$n={class:"summary-item"},Fn={class:"value"},Bn={key:0,class:"summary-item"},qn={class:"value"},Mn={key:1,class:"summary-item"},Hn={class:"value"},Un={key:2,class:"summary-item"},Gn={class:"value"},Ln=ee({__name:"AppointmentStep",props:{form:{type:Object,required:!0},drugRunOutDate:{type:String,required:!0}},emits:["back","next"],setup(e,{emit:a}){const l=e,u=a,c=M(()=>l.drugRunOutDate?me(l.drugRunOutDate):"Not available"),b=d=>d?me(d):"",o=()=>{u("back",4)},r=()=>{u("next",4)};return(d,f)=>(_(),k(yt,{title:"Next Appointment","step-index":4,"is-last-step":!0,onBack:o,onNext:r},{default:n(()=>[t(i(fe),{style:{width:"100%"}},{default:n(()=>[t(i(ne),null,{default:n(()=>[t(i(P),{size:"12","size-md":"6",class:"left-column"},{default:n(()=>[C("div",wn,[f[1]||(f[1]=C("h4",{class:"section-title"},"Schedule Next Appointment",-1)),C("div",Vn,[t(i(Ue),{class:"ion-padding-bottom bold"},{default:n(()=>[C("span",null,K(e.form.nextAppointmentDate.label),1),e.form.nextAppointmentDate.required?(_(),G("span",Dn," *")):z("",!0)]),_:1}),t(i(ra),{presentation:"date",class:Xt(["ion-margin-top",e.form.nextAppointmentDate.error?"box-input-error":"box-input"]),modelValue:e.form.nextAppointmentDate.value,"onUpdate:modelValue":f[0]||(f[0]=p=>e.form.nextAppointmentDate.value=p),min:e.form.visitDate.value,max:e.drugRunOutDate,onIonChange:()=>{}},null,8,["class","modelValue","min","max"]),e.form.nextAppointmentDate.error?(_(),k(i(ua),{key:0,color:"danger"},{default:n(()=>[$(K(e.form.nextAppointmentDate.error),1)]),_:1})):z("",!0)])])]),_:1}),t(i(P),{size:"12","size-md":"6",class:"right-column"},{default:n(()=>[C("div",In,[f[3]||(f[3]=C("h4",{class:"section-title"},"Drug Run Out Information",-1)),C("div",Rn,[C("div",Nn,[t(i(mt),{name:"calendar-outline",class:"info-icon"}),C("div",An,[C("div",Sn,K(c.value),1),f[2]||(f[2]=C("p",{class:"note"},"The patient will run out of medication on this date",-1))])])])]),C("div",Tn,[f[10]||(f[10]=C("h4",{class:"section-title"},"Visit Summary",-1)),C("div",On,[C("div",Pn,[f[4]||(f[4]=C("div",{class:"label"},"Visit Date:",-1)),C("div",Cn,K(b(e.form.visitDate.value)),1)]),C("div",En,[f[5]||(f[5]=C("div",{class:"label"},"Patient Present:",-1)),C("div",kn,K(e.form.patientPresent.value),1)]),C("div",$n,[f[6]||(f[6]=C("div",{class:"label"},"Guardian Present:",-1)),C("div",Fn,K(e.form.guardianPresent.value),1)]),e.form.weight.value?(_(),G("div",Bn,[f[7]||(f[7]=C("div",{class:"label"},"Weight:",-1)),C("div",qn,K(e.form.weight.value)+" kg",1)])):z("",!0),e.form.regimen.value?(_(),G("div",Mn,[f[8]||(f[8]=C("div",{class:"label"},"Regimen:",-1)),C("div",Hn,K(e.form.regimen.value.label),1)])):z("",!0),e.form.tbStatus.value?(_(),G("div",Un,[f[9]||(f[9]=C("div",{class:"label"},"TB Status:",-1)),C("div",Gn,K(e.form.tbStatus.value.label),1)])):z("",!0)])])]),_:1})]),_:1})]),_:1})]),_:1}))}});const zn=ue(Ln,[["__scopeId","data-v-db361dbb"]]),xn={class:"visit-container"},jn={class:"side-navigation"},Wn=["onClick"],Yn={class:"nav-number"},Xn={class:"nav-label"},Jn={class:"main-content"},Qn=ee({__name:"Index",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=[{label:"Reception",component:vn},{label:"Consultation",component:yn},{label:"Medication",component:_n},{label:"Appointment",component:zn}],u=q(0),c=M(()=>(u.value+1)/l.length),b=M(()=>l[u.value].component),{form:o,drugsForm:r,adherenceForm:d,regimens:f,contraIndications:p,sideEffects:v,isFemale:T,drugRunOutDate:A,isOnActiveTBTreatment:E,showHeightField:V,tbMeds:g,tbStatuses:R,chestXRayResultsOptions:S,mwrdResultsOptions:F,hasGiven3HP:m,hasGivenRFP:h,hasGiven6H:D,hasContraindications:B,hasSideEffects:H,isOnTBTreatment:Y,canTestForTB:y,loadPatientData:O,resetForm:de,saveVisit:xe,validateReceptionStep:ht,validateConsultationStep:ot,validateMedicationStep:je,validateAppointmentStep:it}=dn(a.patient),_t=a.patient.getBirthdate(),{isDICSite:lt,refreshDICStatus:st}=Ct(),{enrollPatient:wt,fetchPatientPrograms:Vt,hasProgram:Dt,updateState:It}=gt(a.patient.getID()),Rt=ie=>{ie<=u.value&&(u.value=ie)},We=ie=>{ie>0&&(u.value=ie-1)},Ye=async ie=>{let X=!1;switch(ie){case 0:X=await ht();break;case 1:X=await ot();break;case 2:X=await je();break;case 3:X=await it();break;default:X=!0}X?ie<l.length-1?u.value=ie+1:rt():Ee("Please correct the errors before proceeding")},Xe=async()=>{await de()&&(u.value=0,j.emit(W.ON_CLEAR))},rt=async()=>{re.show("Saving patient visit...");try{await xe(),lt.value&&!Dt(Nt)&&(await wt(o.visitDate.value,Nt),await It(va,o.visitDate.value,Nt)),await Me("Patient visit saved successfully"),await re.hide(),await x.hide(),j.emit(W.RELOAD_PATIENT_VISIT_DATA),j.emit(W.RELOAD_STAGING_INFORMATION)}catch(ie){console.error("Error saving visit:",ie)}finally{re.hide()}};return we(async()=>{await O(),await st(),await Vt()}),we(()=>{j.on(W.ON_CLEAR,()=>{u.value=0})}),(ie,X)=>(_(),G(J,null,[t(i(He),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(nt),null,{default:n(()=>[...X[2]||(X[2]=[$("Patient Visit",-1)])]),_:1}),t(i(Ht),{slot:"end"},{default:n(()=>[t(i(Z),{color:"danger",fill:"clear",size:"large",onClick:i(x).hide},{default:n(()=>[t(i(mt),{icon:i(Ut)},null,8,["icon"])]),_:1},8,["onClick"])]),_:1})]),_:1}),t(i(da),{value:c.value},null,8,["value"])]),_:1}),t(i(Ge),{class:"ion-padding"},{default:n(()=>[C("div",xn,[C("div",jn,[(_(),G(J,null,Ve(l,(ut,ke)=>C("div",{key:ke,class:Xt(["nav-item",{active:u.value===ke,completed:u.value>ke}]),onClick:ta=>Rt(ke)},[C("div",Yn,K(ke+1),1),C("div",Xn,K(ut.label),1)],10,Wn)),64))]),C("div",Jn,[(_(),k(ma,null,[(_(),k(ca(b.value),{form:i(o),drugsForm:i(r),adherenceForm:i(d),regimens:i(f),contraIndications:i(p),sideEffects:i(v),showHeightField:i(V),isFemale:i(T),drugRunOutDate:i(A),birthdate:i(_t),tbMeds:i(g),tbStatuses:i(R),chestXRayResultsOptions:i(S),mwrdResultsOptions:i(F),isOnTBTreatment:i(Y),isOnActiveTBTreatment:i(E),canTestForTB:i(y),hasGiven3HP:i(m),hasGivenRFP:i(h),hasGiven6H:i(D),hasContraindications:i(B),hasSideEffects:i(H),onBack:We,onNext:Ye},null,40,["form","drugsForm","adherenceForm","regimens","contraIndications","sideEffects","showHeightField","isFemale","drugRunOutDate","birthdate","tbMeds","tbStatuses","chestXRayResultsOptions","mwrdResultsOptions","isOnTBTreatment","isOnActiveTBTreatment","canTestForTB","hasGiven3HP","hasGivenRFP","hasGiven6H","hasContraindications","hasSideEffects"]))],1024))])])]),_:1}),t(i(Le),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(Ht),{slot:"end"},{default:n(()=>[u.value>0?(_(),k(i(Z),{key:0,color:"primary",fill:"solid",onClick:X[0]||(X[0]=ut=>We(u.value))},{default:n(()=>[...X[3]||(X[3]=[$(" Back ",-1)])]),_:1})):z("",!0),t(i(Z),{color:"danger",fill:"solid",onClick:i(x).hide},{default:n(()=>[t(i(mt),{slot:"start",icon:i(Ut)},null,8,["icon"]),X[4]||(X[4]=$(" Cancel ",-1))]),_:1},8,["onClick"]),t(i(Z),{color:"warning",fill:"solid",onClick:Xe},{default:n(()=>[t(i(mt),{slot:"start",icon:i(fa)},null,8,["icon"]),X[5]||(X[5]=$(" Reset ",-1))]),_:1}),u.value<l.length-1?(_(),k(i(Z),{key:1,color:"primary",fill:"solid",onClick:X[1]||(X[1]=ut=>Ye(u.value))},{default:n(()=>[...X[6]||(X[6]=[$(" Next ",-1)])]),_:1})):(_(),k(i(Z),{key:2,color:"success",fill:"solid",onClick:rt},{default:n(()=>[...X[7]||(X[7]=[$(" Save Visit ",-1)])]),_:1}))]),_:1})]),_:1})]),_:1})],64))}});const Kn=ue(Qn,[["__scopeId","data-v-94ed98d5"]]),Zn=ee({__name:"EmergencyRefill",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=M(()=>a.patient.getID()),u=new ea(l.value),c=q(),b=q([]),o=q([]),r=M(()=>{var m;return(m=o.value[0])==null?void 0:m.order.start_date}),d=q(""),f=a.patient.getBirthdate(),p=q({}),v=se({date:{value:ae(),label:"Date of emergency refill",required:!0,computedValue:m=>({obs:u.buildValueDate("Prescription refill date",m)})},facility:{value:void 0,label:"Facility where emergency refill was collected",required:!0,placeholder:"Select a facility",computedValue:m=>({obs:u.buildValueText("Health facility name",m.label)})},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:m=>({obs:u.buildValueDate("Appointment date",m)})}});async function T(m,h,D){const B=u.calculateExpected(m.quantity,m.equivalent_daily_dose,m.order.start_date,m.frequency),H=u.calculateAdherence(m.quantity,D,B);return{...await u.buildValueCoded("Medications dispensed",m.drug.concept_id),child:[await u.buildAdherenceObs(m.order_id,m.drug_inventory_id,H),await u.buildPillCountObs(m.order_id,D),,await u.buildValueNumber("Amount of drug dispensed",h)]}}async function A(){if(await Ie("Are you sure you want to clear all fields?")){for(const m in v)v[m].value="",v[m].error="",v[m].disabled=!1;E(),j.emit(W.ON_CLEAR)}}function E(){for(const m in p.value)delete p.value[m]}function V(m){return m.regimen?"".concat(m.regimen," - ").concat(m.drug.name):m.drug.name}function g(){return L(o.value)?1/0:Math.min(...o.value.map(m=>{var Y,y,O,de;const h=V(m),D=Number((y=(Y=p.value["".concat(h,"_given")])==null?void 0:Y.value)!=null?y:0),B=Number((de=(O=p.value["".concat(h,"_brought")])==null?void 0:O.value)!=null?de:0),H=Number(m.equivalent_daily_dose);return(D+B)/H}))}function R(){const m=g();m!==1/0&&(d.value=Aa(v.date.value,m,"days"),v.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(me(d.value),")"),v.nextAppointmentDate.value=d.value)}async function S(){if(await qe(v)&&await qe(p.value))try{re.show(),u.setDate(v.date.value);const m=await Fe({...pt(v).computedFormData,...pt(p.value).computedFormData}),h=new ge(l.value,Te.EMERGENCY_DRUG_REFILL,v.date.value);await h.createEncounter(),await h.saveObservationList(m),Me("Emergency refill saved successfully"),x.hide(),j.emit(W.RELOAD_PATIENT_VISIT_DATA),j.emit(W.RELOAD_STAGING_INFORMATION)}catch(m){console.error(m),Ee("Failed to save emergency refill")}finally{re.hide()}}function F(){o.value.forEach(m=>{const h=V(m);p.value["".concat(h,"_brought")]={label:"".concat(h," brought"),value:void 0,required:!0,placeholder:"Enter the number of pills brought",validation:D=>_e(D,"POSITIVE_INTEGERS")},p.value["".concat(h,"_given")]={label:"".concat(h," given"),value:void 0,required:!0,placeholder:"Enter the number of pills given",validation:D=>_e(D,"POSITIVE_INTEGERS"),computedValue:(D,B)=>T(m,D,B["".concat(h,"_brought")].value)}})}return he([()=>p,()=>v.date.value],R,{deep:!0,immediate:!0}),we(async()=>{try{re.show(),c.value=await a.patient.getRecentWeight(),b.value=await Oe.getRegimens(c.value,void 0,v.date.value),o.value=await Et.getLastDrugsReceived(l.value),F()}catch(m){Ee("Form initialization failed. Try to refresh the page"),console.error(m)}finally{re.hide()}}),(m,h)=>(_(),G(J,null,[t(i(He),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(nt),null,{default:n(()=>[...h[4]||(h[4]=[$("Emergency Drug Refill",-1)])]),_:1})]),_:1})]),_:1}),t(i(Ge),{class:"ion-padding"},{default:n(()=>[t(i(fe),{style:{width:"100%"}},{default:n(()=>[t(i(ne),null,{default:n(()=>[t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Re,{modelValue:v.date,"onUpdate:modelValue":h[0]||(h[0]=D=>v.date=D),form:v,minDate:r.value||i(f),maxDate:i(ae)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ye,{modelValue:v.facility,"onUpdate:modelValue":h[1]||(h[1]=D=>v.facility=D),form:v,asyncOptions:i(Zt)},null,8,["modelValue","form","asyncOptions"])]),_:1}),(_(!0),G(J,null,Ve(Object.values(p.value),D=>(_(),k(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ve,{"model-value":D,form:p.value,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),t(i(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Re,{modelValue:v.nextAppointmentDate,"onUpdate:modelValue":h[2]||(h[2]=D=>v.nextAppointmentDate=D),form:v,minDate:v.date.value,maxDate:d.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1})]),_:1})]),_:1})]),_:1}),t(i(Le),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(Z),{color:"primary",onClick:h[3]||(h[3]=D=>i(x).hide()),slot:"end"},{default:n(()=>[...h[5]||(h[5]=[$(" Close ",-1)])]),_:1}),t(i(Z),{color:"warning",onClick:A,slot:"end"},{default:n(()=>[...h[6]||(h[6]=[$(" Reset ",-1)])]),_:1}),t(i(Z),{color:"success",onClick:S,slot:"end"},{default:n(()=>[...h[7]||(h[7]=[$(" Save ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),eo=ee({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:$t,IonCard:pa,IonCardHeader:ba,IonCardTitle:ga,IonCardContent:ya,IonButton:Z},setup(e){const a=q([]),l=M(()=>e.patient.getID()),u=se({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),c=q([{label:"Add Visit",action:async()=>{await x.show(Kn,{patient:e.patient})}},{label:"Emergency Refill",action:async()=>{await x.show(Zn,{patient:e.patient})}},{label:"Update Outcome",action:async()=>x.show(nn,{patient:e.patient})},{label:"Enter VL Results",action:async()=>x.show(xa,{patient:e.patient})}]),b=V=>{const g=e.startDate!=="N/A"?"("+oe(V).diff(e.startDate,"months")+"M)":"";return"".concat(me(V)," ").concat(g)},o={minWidth:"68px !important"},r=q([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:o},{path:"vitals",label:"Vitals",sortable:!1,thStyles:{minWidth:"120px !important"}},...e.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:o},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:o}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:V=>V.length>0?"Yes":"No",sortable:!1,thStyles:o},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:o},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:o},{path:"vlResult",label:"Viral Load",sortable:!1}]),d=V=>({title:"Side effects noted on ".concat(V.row.visitDate),rows:V.row.sideEffects.map(g=>({sideEffect:g})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),f=V=>({title:"Drugs dispensed on ".concat(V.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:V.row.drugs.map(g=>({name:g[0],quantity:g[1],units:"tab (s)"}))}),p=async V=>{const g=/regimen/i.test(V.column.path)?f(V):d(V);L(g.rows)||await x.show(Fa,g)},v=[{label:"void",icon:ha,color:"danger",action(V,g){Jt(async R=>{var F;const S=await Lt.getEncounters(l.value,{date:V.date});S.ok?((F=S.data)==null||F.forEach(async m=>{await Lt.voidEncounter(m.encounter_id,R)}),a.value.splice(g,1)):Ee(S.errorMessage||"Failed to void encounters")},"small-modal")}}],T=async V=>V.tb_status.match(/Unknown/i)||V.outcome==="Defaulted"?"":ft.getCachedConceptName(V.tb_status),A=V=>{const g=V.weight?"Wt: ".concat(V.weight,"kg"):"",R=V.height?"Ht: ".concat(V.height,"cm"):"",S=V.bmi?"BMI: ".concat(V.bmi):"",F=V.systolic_blood_pressure&&V.diastolic_blood_pressure?"BP: ".concat(V.systolic_blood_pressure,"/").concat(V.diastolic_blood_pressure):"";return[g,R,S,F].filter(Boolean).join(", ")},E=()=>{const{getProgramInfo:V}=gt(l.value);et.getPatientVisits(l.value,!0).then(async g=>{a.value=[];for(const R of g){const S=await V(R);let F="",m="",h="",D="";if(S.outcome!=="Defaulted"){const B=await ct.getFirstValueDatetime(l.value,"appointment date",R);if(B&&(F=me(B)),m=await ct.getFirstValueCoded(l.value,"Is patient pregnant",R),h=await ct.getFirstValueCoded(l.value,"Is patient breast feeding",R),S.viral_load==="N/A"){const H=await ct.getFirstObs(l.value,"HIV viral load",R);H&&H.value_text&&H.value_numeric&&(D=H.value_numeric===1?"LDL":H.value_text+H.value_numeric.toString())}else D=S.viral_load}S&&a.value.push({visitDate:b(R),visitBy:S.visit_by.match(/Unk/i)?"":S.visit_by,vitals:A(S),pregnant:m,breastfeeding:h,tbStatus:await T(S),sideEffects:S.outcome==="Defaulted"?"":S.side_effects,regimen:S.outcome==="Defaulted"?"":S.regimen,nextAppointment:F,outcome:S.outcome.match(/Unk/i)?"":S.outcome,vlResult:D,drugs:S.pills_dispensed,date:R})}})};return j.on(W.RELOAD_PATIENT_VISIT_DATA,()=>E()),we(()=>{E()}),{actionButtons:c,tableConfig:u,rowButtons:v,columns:r,rows:a,onDrilldownHandler:p}}});const to={class:"ion-float-right ion-margin-end ion-margin-bottom"};function ao(e,a,l,u,c,b){const o=I("ion-icon"),r=I("ion-button"),d=I("ion-card-title"),f=I("ion-card-header"),p=I("data-table"),v=I("ion-card-content"),T=I("ion-card");return _(),k(T,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[t(f,null,{default:n(()=>[t(d,null,{default:n(()=>[a[0]||(a[0]=C("span",{class:"title"},"Summary of Visits",-1)),C("span",to,[(_(!0),G(J,null,Ve(e.actionButtons,A=>(_(),k(r,{key:A.label,onClick:A.action,color:A.color||"primary"},{default:n(()=>[A.icon?(_(),k(o,{key:0,icon:A.icon,class:"ion-margin-right"},null,8,["icon"])):z("",!0),$(" "+K(A.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),t(v,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[t(p,{rows:e.rows,columns:e.columns,"row-actions-buttons":e.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:e.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const no=ue(eo,[["render",ao],["__scopeId","data-v-7bb05fd5"]]),oo=ee({__name:"ViralLoadTrail",props:{patient:{}},setup(e){const a=e,l=M(()=>"Viral Load Results Trail for ".concat(a.patient.getFullName())),u=q([]),c=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:me},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:me}],b={label:"X",color:"danger",action({encounter_id:o}){Jt(async r=>{try{await _a.void(o,r),x.hide(),j.emit(W.RELOAD_LATEST_VL_RESULT),j.emit(W.RELOAD_PATIENT_VISIT_DATA)}catch(d){console.error(d)}},"small-modal custom-modal-backdrop")}};return we(async()=>{u.value=await Ce.getViralLoadResultTrail(a.patient.getID())}),(o,r)=>(_(),G(J,null,[t(i(He),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(nt),null,{default:n(()=>[$(K(l.value),1)]),_:1})]),_:1})]),_:1}),t(i(Ge),null,{default:n(()=>[t(i(fe),{style:{width:"100%"}},{default:n(()=>[t(i(ne),{style:Wt([{padding:"0 !important"},{minHeight:u.value.length?"0":"30vh"}])},{default:n(()=>[t(i(P),{size:"12",class:"ion-no-padding"},{default:n(()=>[t(i($t),{rows:u.value,columns:c,"row-actions-buttons":[b],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),t(i(Le),null,{default:n(()=>[t(i(pe),null,{default:n(()=>[t(i(Z),{color:"primary",onClick:r[0]||(r[0]=d=>i(x).hide()),slot:"end"},{default:n(()=>[...r[1]||(r[1]=[$(" Close ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),io=ee({components:{MultiColumnView:Pt,IonList:jt,IonItem:at},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(e,{emit:a}){const l=q(0),u=q(0),c=q(0),b=q(""),o=q(""),r=q(""),d=q(""),f=q(""),p=q(""),v=q(""),T=q(""),A=q(""),E=q(""),V=q(""),g=O=>O.other&&typeof O.other.onClickHandler=="function",R=M(()=>!L(e.guardians)),S=async O=>{var de;g(O)&&await((de=O.other)==null?void 0:de.onClickHandler())},F=()=>{const O=e.patient.getBirthdate(),de=e.artStartDate!=="N/A"?oe(e.artStartDate).diff(O,"years"):"";return"".concat(me(O)," (").concat(de,")")},m=()=>{Ce.getlatestViralLoadResult(e.patient.getID()).then(O=>E.value=O)},h=()=>({onClickHandler(){wa.push("/patient/reception/".concat(e.patient.getID(),"/false"))}}),D=()=>R.value?e.guardians.map(O=>"".concat(O.name," (").concat(O.relationshipType,")")).join(","):"Add",B=()=>({onClickHandler:()=>a("updatePatient")}),H=M(()=>[{label:"ARV Number",value:e.patient.getArvNumber(),other:{onClickHandler:()=>a("updateARVNumber")}},{label:"NPID",value:e.patient.getNationalID()},{label:"MW National ID",value:e.patient.getMWNationalID(),other:B()},{label:"Name",value:e.patient.getGivenName()+" "+e.patient.getFamilyName(),other:B()},{label:"DOB and Age at Initiation",value:F(),other:B()},{label:"Sex",value:Ba(e.patient.getGender()),other:B()},{label:"Location",value:e.patient.getCurrentVillage(),other:B()},{label:"Landmark",value:e.patient.getClosestLandmark(),other:B()},{label:"Phone Number",value:e.patient.getPhoneNumber(),other:B()},{label:"Guardian",value:D(),other:{onClickHandler:()=>a("updateGuardian")}},{label:"Agrees to follow up",value:f.value,other:h()},{label:"Date of starting first line ARV Regimen",value:e.artStartDate,other:h()},{label:"Initial Weight and Height",value:"".concat(l.value,"Kg, ").concat(u.value,"cm"),other:h()},{label:"Initial BMI",value:c.value,other:h()},{label:"Initial TB Status",value:b.value,other:h()},{label:"Pregnant at Initiation",value:r.value,other:h()},{label:"Breastfeeding at Initiation",value:o.value,other:h()},{label:"Latest VL Result and Result Date",value:E.value,other:{onClickHandler:()=>x.show(oo,{patient:e.patient})}},{label:"TI",value:d.value,other:h()},{label:"HIV test place",value:T.value,other:h()},{label:"HIV test date",value:v.value,other:h()},{label:"WHO stage",value:V.value,other:h()},{label:"Reason for starting ART",value:p.value,other:h()},{label:"Staging condition",value:A.value,other:h()}]),Y=async()=>{const O=await e.patient.getHIVTestDate();O&&(v.value=me(O))},y=()=>{e.patient.getInitialWeight().then(O=>l.value=O),e.patient.getInitialHeight().then(O=>u.value=O),e.patient.getInitialBMI().then(O=>c.value=O),e.patient.getInitialTBStatus().then(O=>b.value=O),e.patient.hasPregnancyAtARTInitiation().then(O=>r.value=O),e.patient.breastFeedingAtARTInitiation().then(O=>o.value=O),e.patient.everReceivedART().then(O=>d.value=O),e.patient.agreesToFollowUp().then(O=>f.value=O),e.patient.getReasonForStartingART().then(O=>p.value=O),e.patient.getHIVTestLocation().then(O=>T.value=O),e.patient.getStagingCondition().then(O=>A.value=O),e.patient.getWhoStage().then(O=>V.value=O),Y()};return we(()=>{y(),m(),j.on(W.RELOAD_LATEST_VL_RESULT,()=>m()),j.on(W.RELOAD_STAGING_INFORMATION,()=>y())}),{patientInfo:H,onClickHandler:S,clickable:g}}});const lo={style:{width:"100%",display:"flex",justifyContent:"space-between"}},so={key:0},ro={key:1},uo={key:2},co={key:3};function mo(e,a,l,u,c,b){const o=I("ion-item"),r=I("ion-list"),d=I("multi-column-view");return _(),k(d,{items:e.patientInfo,numberOfColumns:3},{default:n(({entries:f})=>[t(r,{class:"his-card ion-margin-end"},{default:n(()=>[(_(!0),G(J,null,Ve(f,(p,v)=>(_(),k(o,{key:v,lines:v===f.length-1?"none":void 0,button:e.clickable(p),onClick:T=>e.onClickHandler(p)},{default:n(()=>[C("div",lo,[p.label?(_(),G("span",so,K(p.label)+": ",1)):(_(),G("span",ro)),e.clickable(p)?(_(),G("span",uo,[C("a",null,[C("b",null,K(p.value||"N/A"),1)])])):(_(),G("span",co,[C("b",null,K(p.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const fo=ue(io,[["render",mo],["__scopeId","data-v-6b436603"]]),vo=ee({components:{IonGrid:fe,IonRow:ne,IonCol:P,TextInput:Pe,DateInput:Re,SelectInput:ye},props:{patientService:{type:Object,required:!0}},setup(e){const a=q(!1),l=M(()=>/Unknown/i.test(e.patientService.getMWNationalID())?"":e.patientService.getMWNationalID()),u=se({givenName:{label:"First Name",value:e.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:o=>tt(o)},familyName:{label:"last Name",value:e.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:o=>tt(o)},middleName:{label:"middle Name",value:e.patientService.getMiddleName(),placeholder:"middle Name",validation:o=>!!o&&tt(o)},nationalId:{label:"Malawi National ID Number",value:l.value,placeholder:"Enter Malawi National ID Number",validation:o=>o&&o.label?Pa(o):null},gender:{value:e.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:e.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:e.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async o=>!(o.value==="Unknown"||o.value==="N/A")&&Kt(o)},homeVillage:{value:e.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:e.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),c=async o=>{var f,p,v,T,A;let r,d;try{(f=o==null?void 0:o.other)!=null&&f.traditional_authority_id&&(r=await Gt.getTraditionalAuthorityById(o.other.traditional_authority_id)),r&&(d=await Gt.getDistrictByID(r.district_id))}catch(E){Ee("Unable to resolve patient address. Saving using default address"),console.error(E)}return{home_district:(p=d==null?void 0:d.name)!=null?p:"N/A",home_traditional_authority:(v=r==null?void 0:r.name)!=null?v:"N/A",home_village:(o==null?void 0:o.label)||"N/A",current_district:(T=d==null?void 0:d.name)!=null?T:"N/A",current_traditional_authority:(A=r==null?void 0:r.name)!=null?A:"N/A",current_village:(o==null?void 0:o.label)||"N/A"}};return{today:ae,patient:u,getLandmarks:Ca,genderOptions:$a,isBirthdateEstimated:a,modal:x,onFinish:async()=>ze(u,async o=>{const r={};if(o.givenName!==e.patientService.getGivenName()&&(r.given_name=o.givenName),o.familyName!==e.patientService.getFamilyName()&&(r.family_name=o.familyName),o.middleName!==e.patientService.getMiddleName()&&(r.middle_name=o.middleName),o.birthdate!==e.patientService.getBirthdate()&&(r.birthdate=o.birthdate),o.gender.value!==e.patientService.getGender()&&(r.gender=o.gender.value),o.cellPhoneNumber!==e.patientService.getPhoneNumber()&&(r.cell_phone_number=o.cellPhoneNumber),o.landmark.label!==e.patientService.getClosestLandmark()&&(r.landmark=o.landmark.label),o.homeVillage!==e.patientService.getCurrentVillage()&&Object.assign(r,{...r,...await c(o.homeVillage)}),!L(r)){const d=new Ot;d.setPersonID(e.patientService.getID()),await d.updatePerson(r)}o.nationalId!==l.value&&await e.patientService.updateMWNationalId(o.nationalId),await x.hide(),j.emit(W.RELOAD_PATIENT_DATA)}),getVillagesByName:Ea}}});function po(e,a,l,u,c,b){const o=I("ion-title"),r=I("ion-icon"),d=I("ion-button"),f=I("ion-buttons"),p=I("ion-toolbar"),v=I("ion-header"),T=I("TextInput"),A=I("ion-col"),E=I("SelectInput"),V=I("DateInput"),g=I("ion-row"),R=I("ion-grid"),S=I("ion-content"),F=I("ion-footer");return _(),G(J,null,[t(v,null,{default:n(()=>[t(p,null,{default:n(()=>[t(o,null,{default:n(()=>[...a[12]||(a[12]=[$("Edit Patient Demographics",-1)])]),_:1}),t(f,{slot:"end"},{default:n(()=>[t(d,{onClick:a[0]||(a[0]=m=>e.modal.hide())},{default:n(()=>[t(r,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(S,{class:"ion-padding"},{default:n(()=>[t(R,null,{default:n(()=>[t(g,null,{default:n(()=>[t(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.givenName,"onUpdate:modelValue":a[1]||(a[1]=m=>e.patient.givenName=m)},null,8,["modelValue"])]),_:1}),t(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.middleName,"onUpdate:modelValue":a[2]||(a[2]=m=>e.patient.middleName=m)},null,8,["modelValue"])]),_:1}),t(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.familyName,"onUpdate:modelValue":a[3]||(a[3]=m=>e.patient.familyName=m)},null,8,["modelValue"])]),_:1}),t(A,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.nationalId,"onUpdate:modelValue":a[4]||(a[4]=m=>e.patient.nationalId=m)},null,8,["modelValue"])]),_:1}),t(A,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(E,{modelValue:e.patient.gender,"onUpdate:modelValue":a[5]||(a[5]=m=>e.patient.gender=m),options:e.genderOptions},null,8,["modelValue","options"])]),_:1}),t(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(V,{modelValue:e.patient.birthdate,"onUpdate:modelValue":a[6]||(a[6]=m=>e.patient.birthdate=m),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:e.today,onIsEstimated:a[7]||(a[7]=m=>e.isBirthdateEstimated=m)},null,8,["modelValue","maxDate"])]),_:1}),t(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.cellPhoneNumber,"onUpdate:modelValue":a[8]||(a[8]=m=>e.patient.cellPhoneNumber=m),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(E,{modelValue:e.patient.homeVillage,"onUpdate:modelValue":a[9]||(a[9]=m=>e.patient.homeVillage=m),asyncOptions:e.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),t(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(E,{modelValue:e.patient.landmark,"onUpdate:modelValue":a[10]||(a[10]=m=>e.patient.landmark=m),asyncOptions:e.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),t(F,null,{default:n(()=>[t(p,null,{default:n(()=>[t(d,{color:"primary",onClick:a[11]||(a[11]=m=>e.modal.hide()),slot:"end"},{default:n(()=>[...a[13]||(a[13]=[$("Close",-1)])]),_:1}),t(d,{class:"ion-margin-end",color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[...a[14]||(a[14]=[$("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const bo=ue(vo,[["render",po]]),go=ee({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(e){var E,V;const a=new Ot,l=e,u=q(L(l.guardians)),c=M(()=>"".concat(u.value?"Add":"Edit"," Guardian Demographics")),b=M(()=>"".concat(u.value?"Edit":"Add"," Guardian")),o=q([]),r=(V=(E=l.guardians)==null?void 0:E.map(g=>({label:"".concat(g.name," (").concat(g.relationshipType,")"),value:g.name,other:g})))!=null?V:[],d=se({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),f=se({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:g=>tt(g)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:g=>tt(g)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async g=>g.value!=="Unknown"&&Kt(g)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});he(()=>d.guardian.value,g=>{var R,S,F,m,h,D,B,H;f.givenName.value=(S=(R=g==null?void 0:g.other)==null?void 0:R.names.given_name)!=null?S:"",f.familyName.value=(m=(F=g==null?void 0:g.other)==null?void 0:F.names.family_name)!=null?m:"",f.cellPhoneNumber.value=(D=(h=g==null?void 0:g.other)==null?void 0:h.phoneNumber)!=null?D:"",f.relation.value=(H=(B=g==null?void 0:g.other)==null?void 0:B.relationshipType)!=null?H:""},{deep:!0,immediate:!0});function p(){u.value=!u.value,d.guardian.value=""}async function v(g){var R,S;await a.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:l.patientId,...g}),await St.createRelation(l.patientId,a.getPersonID(),(S=(R=g.relation)==null?void 0:R.value)!=null?S:13)}async function T(g,R){var m,h;const S=R.names.person_id,F={};if(R.names.given_name!==g.given_name&&(F.given_name=g.given_name),R.names.family_name!==g.family_name&&(F.family_name=g.family_name),R.phoneNumber!==g.cell_phone_number&&(F.cell_phone_number=g.cell_phone_number),!L(F)){const D=new Ot;D.setPersonID(S),await D.updatePerson(F)}R.relationshipType!==g.relation.label&&await St.amendRelation(l.patientId,S,R.id,(h=(m=g.relation)==null?void 0:m.value)!=null?h:13)}const A=async()=>ze(f,async g=>{!u.value&&!L(d.guardian.value)?await T(g,d.guardian.value.other):await v(g),await x.hide(),j.emit(W.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return we(async()=>{const g=(await St.getRelations()).data;o.value=g.map(R=>({label:R.b_is_to_a,value:R.relationship_type_id,other:R}))}),(g,R)=>{const S=I("ion-title"),F=I("ion-icon"),m=I("ion-button"),h=I("ion-buttons"),D=I("ion-toolbar"),B=I("ion-header"),H=I("ion-content"),Y=I("ion-footer");return _(),G(J,null,[t(B,null,{default:n(()=>[t(D,null,{default:n(()=>[t(S,null,{default:n(()=>[$(K(c.value),1)]),_:1}),t(h,{slot:"end"},{default:n(()=>[t(m,{onClick:R[0]||(R[0]=y=>i(x).hide())},{default:n(()=>[t(F,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(H,{class:"ion-padding"},{default:n(()=>[t(i(fe),null,{default:n(()=>[t(i(ne),null,{default:n(()=>[u.value?z("",!0):(_(),k(i(P),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(ye,{modelValue:d.guardian,"onUpdate:modelValue":R[1]||(R[1]=y=>d.guardian=y),options:i(r)},null,8,["modelValue","options"])]),_:1})),d.guardian.value||u.value?(_(),G(J,{key:1},[t(i(P),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Pe,{modelValue:f.givenName,"onUpdate:modelValue":R[2]||(R[2]=y=>f.givenName=y)},null,8,["modelValue"])]),_:1}),t(i(P),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Pe,{modelValue:f.familyName,"onUpdate:modelValue":R[3]||(R[3]=y=>f.familyName=y)},null,8,["modelValue"])]),_:1}),t(i(P),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Pe,{modelValue:f.cellPhoneNumber,"onUpdate:modelValue":R[4]||(R[4]=y=>f.cellPhoneNumber=y),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(i(P),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(ye,{modelValue:f.relation,"onUpdate:modelValue":R[5]||(R[5]=y=>f.relation=y),options:o.value},null,8,["modelValue","options"])]),_:1})],64)):z("",!0)]),_:1})]),_:1})]),_:1}),t(Y,null,{default:n(()=>[t(D,null,{default:n(()=>[i(L)(l.guardians)?z("",!0):(_(),k(m,{key:0,color:"primary",onClick:p,slot:"start"},{default:n(()=>[$(K(b.value),1)]),_:1})),t(m,{color:"primary",onClick:R[6]||(R[6]=y=>i(x).hide()),slot:"end"},{default:n(()=>[...R[7]||(R[7]=[$("Close",-1)])]),_:1}),t(m,{class:"ion-margin-end",color:"success",onClick:A,slot:"end"},{default:n(()=>[...R[8]||(R[8]=[$("Save",-1)])]),_:1})]),_:1})]),_:1})],64)}}}),yo=ee({components:{IonGrid:fe,IonRow:ne,IonCol:P,TextInput:Pe},props:{patient:{type:Object,required:!0}},setup(e){const{facility:a}=Ct(),l=M(()=>e.patient.getArvNumber()),u=M(()=>!L(l.value)&&l.value!=="Unknown"),c=se({arvNumber:{value:u.value?l.value.split("-")[2]:"",label:"".concat(u.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async r=>{const d=_e(r,"POSITIVE_INTEGERS");if(d!==null)return d;if(r.value===l.value.split("-")[2])return null;const f=await et.findByOtherID(4,"".concat(a.code,"-ARV-").concat(r.value));return f.ok?L(f.data)?null:["ARV Number already taken"]:[f.errorMessage||f.clientErrorType||"Unable to determine ARV number with status: ".concat(f.httpStatusResponse)]}}});return{form:c,modal:x,arvNumber:l,facility:a,hasValidARVNumber:u,onFinish:async()=>ze(c,async r=>{r.arvNumber!==l.value.split("-")[2]&&(u.value?await e.patient.updateARVNumber("".concat(a.code,"-ARV-").concat(r.arvNumber)):await e.patient.createArvNumber("".concat(a.code,"-ARV-").concat(r.arvNumber)),j.emit(W.RELOAD_PATIENT_DATA)),await x.hide()}),voidARV:async()=>{if(await Ie("Are you sure you want to void this ARV Number ".concat(l.value,"?"))){await re.show("Voiding ARV Number...");try{await Ae.postJson("/programs/".concat(Va,"/void_arv_number/").concat(l),{}),await re.hide(),await x.hide(),j.emit(W.RELOAD_PATIENT_DATA)}catch(d){await re.hide(),console.log(d)}}}}}});function ho(e,a,l,u,c,b){const o=I("ion-title"),r=I("ion-icon"),d=I("ion-button"),f=I("ion-buttons"),p=I("ion-toolbar"),v=I("ion-header"),T=I("text-input"),A=I("ion-col"),E=I("ion-row"),V=I("ion-grid"),g=I("ion-content"),R=I("ion-footer");return _(),G(J,null,[t(v,null,{default:n(()=>[t(p,null,{default:n(()=>[t(o,null,{default:n(()=>[...a[3]||(a[3]=[$("ARV NUMBER",-1)])]),_:1}),t(f,{slot:"end"},{default:n(()=>[t(d,{onClick:a[0]||(a[0]=S=>e.modal.hide())},{default:n(()=>[t(r,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(g,{class:"ion-padding"},{default:n(()=>[t(V,null,{default:n(()=>[t(E,null,{default:n(()=>[t(A,null,{default:n(()=>[t(T,{modelValue:e.form.arvNumber,"onUpdate:modelValue":a[1]||(a[1]=S=>e.form.arvNumber=S),form:e.form,prefix:"".concat(e.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),t(R,{class:"ion-padding-horizontal"},{default:n(()=>[t(p,null,{default:n(()=>[t(d,{color:"primary",onClick:a[2]||(a[2]=S=>e.modal.hide()),slot:"end"},{default:n(()=>[...a[4]||(a[4]=[$("Close",-1)])]),_:1}),e.hasValidARVNumber?(_(),k(d,{key:0,color:"danger",onClick:e.voidARV,slot:"start"},{default:n(()=>[...a[5]||(a[5]=[$("Void ARV Number",-1)])]),_:1},8,["onClick"])):z("",!0),t(d,{color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[...a[6]||(a[6]=[$("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const _o=ue(yo,[["render",ho]]),wo=ee({components:{VisitsSummary:no,InformationHeader:fo},setup(){const e=Da(),a=parseInt(e.params.patientId.toString())||0,l=q(),u=q(""),c=q([]),b=M(()=>!L(l.value)),o=M(()=>{var E;return(E=l.value)==null?void 0:E.getNationalID()}),r=async()=>{if(a){const E=(await et.findByID(a)).data;E&&(l.value=new et(E))}},d=async()=>{c.value=await za.getGuardianDetails(a)},f=async E=>{await x.show(bo,{patientService:l.value,attribute:E})},p=async()=>{await x.show(go,{patientId:a,guardians:c.value})},v=async()=>{await x.show(_o,{patient:l.value})},T=async()=>{var V;await re.show("Client has Invalid NPID. Assigning NPID...");const E=await et.assignNPID(a);E.ok?(await r(),await re.hide()):(await re.hide(),Ee((V=E.errorMessage)!=null?V:"Failed to assign NPID"))},A=async()=>{var V;let E=!1;if(Ha.value)E=!((V=l.value)==null?void 0:V.getDocID())||qa(o.value)||await Ua(a);else{const g=await Ga(o.value);E=!g||g.length>1}E&&await T()};return j.on(W.RELOAD_PATIENT_DATA,async()=>{await r()}),j.on(W.RELOAD_GUARDIAN_DATA,async()=>{await d()}),we(async()=>{var V;await Ma(),await r(),await A();const E=await((V=l.value)==null?void 0:V.getARTStartDate());u.value=E?me(E):"N/A",d()}),{patient:l,artStartDate:u,guardians:c,isReady:b,updateDemographics:f,updateGuardian:p,updateARVNumber:v}}});function Vo(e,a,l,u,c,b){const o=I("information-header"),r=I("ion-col"),d=I("ion-row"),f=I("visits-summary"),p=I("ion-grid");return e.isReady?(_(),k(p,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[t(d,null,{default:n(()=>[t(r,{size:"12"},{default:n(()=>[e.patient?(_(),k(o,{key:0,patient:e.patient,guardians:e.guardians,artStartDate:e.artStartDate,onUpdateARVNumber:e.updateARVNumber,onUpdateGuardian:e.updateGuardian,onUpdatePatient:e.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):z("",!0)]),_:1})]),_:1}),t(d,null,{default:n(()=>[t(r,null,{default:n(()=>[e.patient?(_(),k(f,{key:0,patient:e.patient,startDate:e.artStartDate},null,8,["patient","startDate"])):z("",!0)]),_:1})]),_:1})]),_:1})):z("",!0)}const Ko=ue(wo,[["render",Vo]]);export{Ko as default};
