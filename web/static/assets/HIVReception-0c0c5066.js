var st=Object.defineProperty;var ot=(a,i,e)=>i in a?st(a,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[i]=e;var V=(a,i,e)=>(ot(a,typeof i!="symbol"?i+"":i,e),e);import{aQ as rt,d as ct,aR as H,l as ut,m as lt,n as dt,I as _t,aO as vt,f as gt,r as v,aj as W,h as j,i as pt,aN as D,ar as mt,aS as k,_ as ft,N as E,j as C,w as P,o as h,e as wt,V as St,aT as It,A as yt}from"./index-51dd004c.js";import{P as z,C as M}from"./patient_service-a6ae3da8.js";import{a as Ct,t as U}from"./toasts-4a7e4d69.js";import{l as L}from"./loader-c9c57168.js";import{e as b}from"./encounter_types-1e88a09d.js";import{A as g,u as ht,V as bt,C as At}from"./consultation_service-e56b7e07.js";import{a as F}from"./his_date-126a9ecc.js";import{a as w}from"./form-8b32afba.js";import{i as x,g as Ot}from"./common-abc2f84d.js";import{E as K,a as Q}from"./emc_event-4721851b.js";class Tt extends g{constructor(i,e=F()){super(i,b.HIV_CLINIC_REGISTRATION,e)}}class Rt extends g{constructor(i,e=F()){super(i,b.REGISTRATION,e)}}class Nt extends g{constructor(e,s,o=F()){super(e,b.HIV_STAGING,o);V(this,"age");V(this,"confirmatoryTest");this.age=s,this.confirmatoryTest=null}isAdult(){return this.age>=15}cd4CountIsValid(e){try{return!!e.match(/^(=|<|>)([0-9]*)$/m)}catch(s){return!1}}getStagingConditions(e){const s=this.getStagingCategoryByNum(e);return g.getConceptsByCategory(s)}getAllWhoStages(){return g.getConceptsByCategory("whole_staging_numbers")}getAllReasonsForART(e=this.date,s=!1){return g.getConceptsByCategory("reason_for_art").filter(o=>!(new Date(e)>new Date(rt)&&o.name.match(/cd4/i)||s&&o.name.match(/breastfeeding|pregnant/i)))}buildWhoStageObs(e){return this.buildValueCoded("Who stage",e)}buildWhoCriteriaObs(e){return this.buildValueCoded("Who stages criteria present",e)}buildReasonForArtObs(e){return this.buildValueCoded("Reason for ART eligibility",e)}getStagingCategoryByNum(e){switch(e){case 1:return this.isAdult()?"stage_1_conditions_adults":"stage_1_conditions_pedaids";case 2:return this.isAdult()?"stage_2_conditions_adults":"stage_2_conditions_pedaids";case 3:return this.isAdult()?"stage_3_conditions_adults":"stage_3_conditions_pedaids";case 4:return this.isAdult()?"stage_4_conditions_adults":"stage_4_conditions_pedaids";default:return""}}}const Vt=ct({components:{ClinicRegistration:H(()=>k(()=>import("./ClinicRegistration-7cabac9f.js"),["assets/ClinicRegistration-7cabac9f.js","assets/index-51dd004c.js","assets/index-4ecf4d26.css","assets/patient_service-a6ae3da8.js","assets/patient_identifier_service-7065756a.js","assets/his_date-126a9ecc.js","assets/Date-53be4074.js","assets/common-abc2f84d.js","assets/TextInput-1b036a7a.js","assets/TextInput-e777cfa6.css","assets/DateInput.vue_vue_type_style_index_0_lang-9c408a64.js","assets/validations-6f974720.js","assets/emc_event-4721851b.js","assets/vue-datepicker-1c0a0cbb.js","assets/DateInput-5fa0484d.css","assets/YesNoInput-458bf274.js","assets/SelectInput-e4566de2.js","assets/SelectInput-5e7944e5.css","assets/location_options-7f2abad1.js","assets/regimen_service-f1b85d5c.js","assets/DTFormElements-9dbc03af.js","assets/arrays-1b521787.js","assets/consultation_service-e56b7e07.js","assets/encounter_types-1e88a09d.js","assets/form-8b32afba.js","assets/Strs-0c962638.js","assets/toasts-4a7e4d69.js","assets/loader-c9c57168.js"])),Staging:H(()=>k(()=>import("./Staging-ff3a9760.js"),["assets/Staging-ff3a9760.js","assets/index-51dd004c.js","assets/index-4ecf4d26.css","assets/TextInput-1b036a7a.js","assets/TextInput-e777cfa6.css","assets/DateInput.vue_vue_type_style_index_0_lang-9c408a64.js","assets/his_date-126a9ecc.js","assets/validations-6f974720.js","assets/common-abc2f84d.js","assets/emc_event-4721851b.js","assets/vue-datepicker-1c0a0cbb.js","assets/DateInput-5fa0484d.css","assets/YesNoInput-458bf274.js","assets/SelectInput-e4566de2.js","assets/SelectInput-5e7944e5.css","assets/location_options-7f2abad1.js","assets/form-8b32afba.js","assets/Strs-0c962638.js","assets/toasts-4a7e4d69.js","assets/loader-c9c57168.js","assets/patient_service-a6ae3da8.js","assets/patient_identifier_service-7065756a.js","assets/Date-53be4074.js","assets/encounter_types-1e88a09d.js","assets/consultation_service-e56b7e07.js","assets/arrays-1b521787.js","assets/Staging-fc4f8fe8.css"])),IonGrid:ut,IonRow:lt,IonCol:dt,IonButton:_t},setup(){const a=vt(),i=gt(),e=v(!1),s=W({}),o=v("ClinicRegistration"),r=parseInt(a.params.patientId.toString()||""),d=!!a.params.new.toString().match(/true/i),A=j(()=>o.value==="Staging"),O=j(()=>o.value==="Staging"),S=v({}),p=v(""),B=v(""),I=v([]),T=W({}),{hasProgram:Y,fetchPatientPrograms:q,enrollPatient:J}=ht(r),X=c=>s[c.type]=c.data,Z=()=>o.value="Staging",tt=()=>o.value="ClinicRegistration",et=async()=>{const{arvNumberEditable:c,formData:t,computedData:u}=s.registration,{computedData:n}=s.staging;try{if(L.show(),!d&&!x(I.value))for(const y of I.value)await D.void(y,"Duplicate");c&&t.arvNumber&&await S.value.createArvNumber(t.arvNumber);const l=new Rt(r,t.initialVisitDate);await l.createEncounter();const R=await w(u,"patient type");await l.saveObservationList(R);const _=new Tt(r,t.initialVisitDate);await _.createEncounter();const N=await w(u,"registration");if(await _.saveObservationList(N),t.everRegisteredAtClinic==="Yes"){const y=new bt(r,t.initialVisitDate);await y.createEncounter();const it=await w(u,"vitals");await y.saveObservationList(it);const $=new At(r,t.initialVisitDate);await $.createEncounter();const nt=await w(u,"consultation");await $.saveObservationList(nt)}const m=new Nt(r,S.value.getAge(),t.initialVisitDate);await m.createEncounter();const f=await w(n);await m.saveObservationList(f),(d||!Y())&&await J(t.initialVisitDate),await L.hide(),await Ct("Saved successfully"),i.push("/patient/".concat(r))}catch(l){await L.hide(),console.log(l),U("".concat(l))}},G=async c=>{for(const t of c){I.value.includes(t.encounter_id)||I.value.push(t.encounter_id);const u=await M.getConceptName(t.concept_id);let n="";t.value_datetime||t.value_drug?n=t.value_datetime:t.value_text?n=t.value_text:t.value_numeric?n=t.value_numeric:t.value_coded&&(n=await M.getConceptName(t.value_coded)),t.value_modifier&&(n=t.value_modifier+n),T[u]=n}},at=async()=>{const{HIV_CLINIC_CONSULTATION:c,HIV_CLINIC_REGISTRATION:t,REGISTRATION:u,HIV_STAGING:n,VITALS:l}=b;try{const _=(await D.all({encounter_type_id:t,patient_id:r})).data;if(x(_))return;if(p.value=Ot(_,"[0].encounter_datetime",""),p.value){await G(_[0].observations);const N=(await D.all({program_id:mt,patient_id:r,date:p.value})).data||[];for(const m of N){let f=[u,n];/yes/i.test("".concat(T["Ever registered at ART clinic"]))&&(f=[...f,c,l]),f.includes(m.encounter_type)&&await G(m.observations)}}}catch(R){U("Unable to load previous observations")}};return pt(async()=>{q();const c=await z.findByID(r);c.ok&&(S.value=new z(c.data)),d||await at(),e.value=!0,K.on(Q.ON_INITIAL_VISIT_DATE,t=>{p.value=t}),K.on(Q.ON_ART_START_DATE,t=>{B.value=t})}),{activeForm:o,patient:S,isNewPatient:d,isStaging:A,isRegistration:O,isReady:e,initialVisitDate:p,observations:T,artStartDate:B,onValue:X,onFinish:et,onNext:Z,onPrevious:tt}}});function Dt(a,i,e,s,o,r){const d=E("ion-col"),A=E("ion-row"),O=E("ion-grid");return h(),C(O,null,{default:P(()=>[wt(A,{class:"his-card"},{default:P(()=>[a.isReady?(h(),C(d,{key:0,size:"12"},{default:P(()=>[(h(),C(St,null,[(h(),C(It(a.activeForm),{patient:a.patient,isNewPatient:a.isNewPatient,initialVisitDate:a.initialVisitDate,artStartDate:a.artStartDate,observations:a.observations,onOnValue:a.onValue,onOnNext:a.onNext,onOnPrevious:a.onPrevious,onOnFinish:a.onFinish},null,40,["patient","isNewPatient","initialVisitDate","artStartDate","observations","onOnValue","onOnNext","onOnPrevious","onOnFinish"]))],1024))]),_:1})):yt("",!0)]),_:1})]),_:1})}const Et=ft(Vt,[["render",Dt]]),Mt=Object.freeze(Object.defineProperty({__proto__:null,default:Et},Symbol.toStringTag,{value:"Module"}));export{Tt as C,Mt as H,Rt as P,Nt as S};
