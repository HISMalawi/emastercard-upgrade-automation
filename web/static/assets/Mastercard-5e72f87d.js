var Ut=Object.defineProperty;var Ht=(t,a,o)=>a in t?Ut(t,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[a]=o;var pt=(t,a,o)=>(Ht(t,typeof a!="symbol"?a+"":a,o),o);import{D as Ye,H as _t}from"./Date-d6cf1fc2.js";import{H as Ae,G as yt,d as Q,r as O,ah as re,a6 as ve,i as ye,c as M,e,w as n,u as d,K as W,o as N,s as be,a0 as Fe,b as C,S as Ue,k as se,l as ne,m as P,J as je,v as Je,az as et,D as He,I as Z,ak as U,q as Me,ao as De,h as F,_ as ue,L as V,a as we,j as $,z as G,aD as Mt,t as me,aE as ht,N as Re,aF as qt,a5 as Lt,aG as Gt,n as zt,a4 as Wt,aH as Yt,aI as jt,U as Jt,ai as xt,aB as vt,aJ as Qt}from"./index-0dab41e9.js";import{g as Xt,D as ot,C as We,P as xe,O as Ge}from"./patient_service-fa642ea3.js";import{g as Ke,i as z}from"./common-abc2f84d.js";import{A as ce,P as Kt,V as Zt,C as ea,E as ft}from"./consultation_service-d2e7c589.js";import{P as Vt}from"./program_service-fc73886d.js";import{p as wt}from"./VoidReason-99ebf3b9.js";import{a as j,t as _e,d as ee,c as ta,e as aa}from"./his_date-1be895e6.js";import{_ as pe}from"./DateInput.vue_vue_type_style_index_0_lang-820ea7dc.js";import{S as ie}from"./SelectInput-bcf6e373.js";import{N as ae,R as Ne}from"./regimen_service-2bc62eae.js";import{t as Qe,a as na,g as la}from"./DTFormElements-a1199b88.js";import{e as Te}from"./encounter_types-1e88a09d.js";import{s as oa,c as ia,u as gt}from"./arrays-31d2d38b.js";import{s as Oe,i as tt,r as at,a as ke}from"./form-9e3f9bc9.js";import{E as q,a as L}from"./emc_event-4721851b.js";import{a as Ce,t as Be}from"./toasts-efd70885.js";import{D as it}from"./index-5faacd6b.js";import{T as Se}from"./TextInput-0aacbbd5.js";import{g as Dt,a as ra,b as sa}from"./location_options-d816fd70.js";import{r as fe,v as ze,d as ua,e as oe,f as bt,a as $e,b as da,c as It}from"./validations-6f974720.js";import{Y as Ve}from"./YesNoInput-64a88047.js";import{l as ge}from"./loader-09fe7d6a.js";import{D as ma}from"./DrilldownTable-f8933899.js";import{t as ca}from"./Strs-7ee8a435.js";import{P as nt,R as Ze}from"./relations_service-7be9357b.js";import"./patient_identifier_service-7790a48c.js";import"./vue-datepicker-b770edc0.js";const pa=t=>{const a=t.given_name,o=t.family_name,s=t.middle_name?t.middle_name:"";return"".concat(a," ").concat(s," ").concat(o)};class va{static getRelationships(a){return Ae.getJson("/people/".concat(a,"/relationships")).then(o=>o.data)}static async getGuardianDetails(a){return await this.getRelationships(a).then(o=>o.map(s=>{const c=Ke(s,"relation.names[0]");return{id:s.relationship_id,name:c?pa(c):"",relationshipType:Ke(s,"type.b_is_to_a",""),phoneNumber:Xt(Ke(s,"relation.person_attributes",[]),12),names:c}}))}}const Ee=class Ee extends ce{constructor(a){super(a,Te.LAB_ORDERS,j())}async loadConcepts(){Ee.conceptID=await ce.getConceptID("HIV Viral Load")}createLabOrder(a,o){const s=Ae.getUsername(),c=yt().facility.name,h=ce.getCachedConceptID(o,!0);return Ae.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:s,target_lab:c,reason_for_test_id:h,encounter_id:this.encounterID,tests:[{concept_id:Ee.conceptID}],date:this.date,specimen:{concept_id:a}}]})}createLabResult(a,o,s,c="numeric"){return Ae.postJson("lab/tests/".concat(a,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Ee.conceptID},value:o,value_modifier:s,value_type:c}]})}static getSpecimens(a){return Ae.getJson("/lab/specimen_types",{test_type:a})}static async getOrders(a,o={}){var c;return(c=(await Ae.getJson("/lab/orders",{patient_id:a,...o})).data)!=null?c:[]}static async getViralLoadResultTrail(a,o={}){return(await this.getOrders(a,o)).reduce((c,h)=>(h.tests.forEach(r=>r.result.forEach(u=>c.push({...h,test:r.name,result:"".concat(u.value_modifier," ").concat(u.value),result_date:u.date}))),c),[])}static async getlatestViralLoadResult(a,o={}){const c=(await this.getOrders(a,o)).flatMap(r=>r.tests.flatMap(u=>u.result)).filter(Boolean);if(z(c))return"N/A";const h=oa(c,"date","desc")[0];return"".concat(h.value_modifier).concat(h.value," (").concat(_e(h.date),")")}};pt(Ee,"conceptID",-1);let Pe=Ee;const fa=Q({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(t){const a=t,o=O(!1),s=Qe(["=",">","<",">=","<="]),c=Qe(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),h=O([]),r=a.patient.getBirthdate(),u=re({orderDate:{value:"",label:"Order Date",required:!0,validation:async _=>ee(_.value).isValid()?new Date(_.value)>new Date(j())?["Order date cannot be in the future"]:new Date(_.value)<new Date(r)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(_,m)=>ee(_.value).isValid()?new Date(_.value)>new Date(j())?["Result date cannot be in the future"]:new Date(_.value)<new Date(m.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function v(){Oe(u,async _=>{const m=new Pe(a.patient.getID());if(await m.loadConcepts(),m.setDate(_.orderDate),!await m.createEncounter())throw new Error("Unable to create lab order encounter");const A=await m.createLabOrder(_.specimen.value,_.reason.value);if(!A.ok||!A.data)throw new Error("Unable to save lab orders");const B=new Pe(a.patient.getID());if(B.setDate(_.resultDate),!await B.createEncounter())throw new Error("Unable to create lab result encounter");const b=o.value?"LDL":parseInt(_.result),y=o.value?"=":_.modifier.value,S=o.value?"text":"numeric",E=A.data[0].tests[0].id;await B.createLabResult(E,b,y,S),await U.hide(),q.emit(L.RELOAD_LATEST_VL_RESULT),q.emit(L.RELOAD_PATIENT_VISIT_DATA)})}async function I(){if(await De("Are you sure you want to clear all fields?")){o.value=!1;for(const _ in u)u[_].value="",u[_].error="";q.emit(L.ON_CLEAR)}}return ve(o,_=>{_&&(u.modifier.value="",u.result.value=void 0,u.modifier.error="",u.result.error=""),u.modifier.disabled=_,u.modifier.required=!_,u.result.disabled=_,u.result.required=!_}),ye(async()=>{h.value=(await Pe.getSpecimens("HIV viral load")).data.map(_=>({label:_.name,value:_.concept_id}))}),(_,m)=>(N(),M(W,null,[e(d(Ue),null,{default:n(()=>[e(d(be),null,{default:n(()=>[e(d(Fe),null,{default:n(()=>m[8]||(m[8]=[C("Viral Load Results")])),_:1})]),_:1})]),_:1}),e(d(He),{class:"ion-padding"},{default:n(()=>[e(d(se),{style:{width:"100%"}},{default:n(()=>[e(d(ne),null,{default:n(()=>[e(d(P),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(pe,{modelValue:u.orderDate,"onUpdate:modelValue":m[0]||(m[0]=R=>u.orderDate=R),form:u,minDate:d(r),maxDate:d(j)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:u.reason,"onUpdate:modelValue":m[1]||(m[1]=R=>u.reason=R),options:d(c)},null,8,["modelValue","options"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:u.specimen,"onUpdate:modelValue":m[2]||(m[2]=R=>u.specimen=R),options:h.value},null,8,["modelValue","options"])]),_:1}),e(d(P),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(pe,{modelValue:u.resultDate,"onUpdate:modelValue":m[3]||(m[3]=R=>u.resultDate=R),form:u,minDate:u.orderDate.value,"max-date":d(j)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:u.modifier,"onUpdate:modelValue":m[4]||(m[4]=R=>u.modifier=R),options:d(s)},null,8,["modelValue","options"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:u.result,"onUpdate:modelValue":m[5]||(m[5]=R=>u.result=R),form:u,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),e(d(ne),{class:"ion-margin-top"},{default:n(()=>[e(d(P),{size:"12"},{default:n(()=>[e(d(je),{class:"ion-padding-vertical bold"},{default:n(()=>m[9]||(m[9]=[C(" Other Results Options: ")])),_:1}),e(d(Je),null,{default:n(()=>[e(d(je),null,{default:n(()=>m[10]||(m[10]=[C("LDL")])),_:1}),e(d(et),{slot:"start",modelValue:o.value,"onUpdate:modelValue":m[6]||(m[6]=R=>o.value=R)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(d(Me),null,{default:n(()=>[e(d(be),null,{default:n(()=>[e(d(Z),{color:"primary",onClick:m[7]||(m[7]=R=>d(U).hide()),slot:"end"},{default:n(()=>m[11]||(m[11]=[C(" Close ")])),_:1}),e(d(Z),{color:"warning",onClick:I,slot:"end"},{default:n(()=>m[12]||(m[12]=[C(" Reset ")])),_:1}),e(d(Z),{color:"success",onClick:v,slot:"end"},{default:n(()=>m[13]||(m[13]=[C(" Save ")])),_:1})]),_:1})]),_:1})],64))}}),ga=Q({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:it},emits:["voidOutcome"],setup(t,{emit:a}){const o=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:r=>ee(r).format(Ye)},{path:"end_date",label:"End Date",formatter:r=>ee(r).format(Ye)}],s={showSearchField:!1,showSubmitButton:!1};return{rows:F(()=>t.patientStates.map((r,u)=>({...r,index:u}))),columns:o,tableConfig:s,TableRowActions:[{label:"void",color:"danger",action:async r=>{await De("Are you sure you want to void this outcome?")&&a("voidOutcome",{stateId:r.patient_state_id,index:r.index})}}]}}});function ba(t,a,o,s,c,h){const r=V("data-table");return N(),M(W,null,[a[0]||(a[0]=we("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1)),e(r,{rows:t.rows,columns:t.columns,config:t.tableConfig,"row-actions-buttons":t.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const _a=ue(ga,[["render",ba]]),ya=Q({name:"EnrollmentForm",components:{DateInput:pe,IonGrid:se,IonRow:ne,IonCol:P,IonButton:Z},props:["birthdate"],emits:["enrollProgram"],setup(t,{emit:a}){const o=ee().format("YYYY-MM-DD"),s=re({date:{value:"",label:"Date of Enrollment",required:!0,validation:async r=>new Date(r.value)<new Date(t.birthdate)?["Date of enrollment cannot be before date of birth"]:new Date(r.value)>new Date(o)?["Date of enrollment cannot be in the future"]:null}});return{form:s,today:o,onReset:async()=>{await De("Are you sure you want to clear all fields")&&(s.date.value="",s.date.error="",q.emit(L.ON_CLEAR))},enrollProgram:async()=>Oe(s,({date:r})=>a("enrollProgram",r))}}});function ha(t,a,o,s,c,h){const r=V("DateInput"),u=V("ion-col"),v=V("ion-button"),I=V("ion-row"),_=V("ion-grid");return N(),$(_,null,{default:n(()=>[e(I,null,{default:n(()=>[e(u,{size:"12"},{default:n(()=>[e(r,{modelValue:t.form.date,"onUpdate:modelValue":a[0]||(a[0]=m=>t.form.date=m),form:t.form,minDate:t.birthdate,"max-date":t.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(u,null,{default:n(()=>[e(v,{color:"warning",onClick:t.onReset},{default:n(()=>a[1]||(a[1]=[C("Reset")])),_:1},8,["onClick"]),e(v,{color:"success",onClick:t.enrollProgram},{default:n(()=>a[2]||(a[2]=[C("Enroll")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Va=ue(ya,[["render",ha]]),wa=Q({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:pe,IonGrid:se,IonRow:ne,IonCol:P,IonButton:Z,SelectInput:ie,TextInput:Se},emits:["saveOutcome"],setup(t,{emit:a}){const o=ee().format("YYYY-MM-DD"),s=re({date:{value:"",label:"Outcome Date",required:!0,validation:async v=>new Date(v.value)<new Date(t.birthdate)?["Outcome date cannot be before date of birth - ".concat(ee(t.birthdate).format(Ye))]:new Date(v.value)<new Date(t.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(ee(t.dateEnrolled).format(Ye))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(v,I)=>I.status.value.label==="Patient transferred out"&&fe(v)},reason:{value:"",label:"Reason for transfer out",validation:async(v,I)=>I.status.value.label==="Patient transferred out"&&fe(v)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(v,I)=>{var _,m,R,A;return((m=(_=I.status)==null?void 0:_.value)==null?void 0:m.label)==="Patient transferred out"&&((A=(R=I.reason)==null?void 0:R.value)==null?void 0:A.label)==="Other"&&fe(v)}}}),c=F(()=>{var v;return((v=s.status.value)==null?void 0:v.label)==="Patient transferred out"}),h=F(()=>{var v,I;return((I=(v=s.reason)==null?void 0:v.value)==null?void 0:I.label)==="Other"});return{form:s,today:o,isTransferredOut:c,specifyOther:h,onSave:()=>Oe(s,v=>a("saveOutcome",{...v,isTransferredOut:c.value})),onReset:async()=>{if(await De("are you sure you want to clear all fields")){for(const v in s)s[v].value="",s[v].error="";q.emit(L.ON_CLEAR)}},getFacilities:Dt,transferOutReasons:na}}});function Da(t,a,o,s,c,h){const r=V("ion-col"),u=V("DateInput"),v=V("SelectInput"),I=V("text-input"),_=V("ion-button"),m=V("ion-row"),R=V("ion-grid");return N(),$(R,null,{default:n(()=>[e(m,null,{default:n(()=>[e(r,{size:"12"},{default:n(()=>a[5]||(a[5]=[we("p",null,"Add New Outcome",-1)])),_:1}),e(r,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(u,{modelValue:t.form.date,"onUpdate:modelValue":a[0]||(a[0]=A=>t.form.date=A),form:t.form,minDate:t.dateEnrolled,"max-date":t.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(r,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(v,{modelValue:t.form.status,"onUpdate:modelValue":a[1]||(a[1]=A=>t.form.status=A),form:t.form,options:t.outcomes},null,8,["modelValue","form","options"])]),_:1}),t.isTransferredOut?(N(),M(W,{key:0},[e(r,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(v,{modelValue:t.form.nextFacility,"onUpdate:modelValue":a[2]||(a[2]=A=>t.form.nextFacility=A),form:t.form,asyncOptions:t.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),e(r,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(v,{modelValue:t.form.reason,"onUpdate:modelValue":a[3]||(a[3]=A=>t.form.reason=A),form:t.form,options:t.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),t.specifyOther?(N(),$(r,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[e(I,{modelValue:t.form.otherReason,"onUpdate:modelValue":a[4]||(a[4]=A=>t.form.otherReason=A),form:t.form},null,8,["modelValue","form"])]),_:1})):G("",!0)],64)):G("",!0),e(r,{size:"12",class:"ion-margin-top"},{default:n(()=>[e(_,{color:"warning",onClick:t.onReset},{default:n(()=>a[6]||(a[6]=[C("Reset")])),_:1},8,["onClick"]),e(_,{color:"success",onClick:t.onSave},{default:n(()=>a[7]||(a[7]=[C("Save")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Ia=ue(wa,[["render",Da]]),Na=Q({components:{IonContent:He,IonFooter:Me,IonHeader:Ue,IonTitle:Fe,IonToolbar:be,IonButton:Z,IonGrid:se,IonRow:ne,IonCol:P,IonBadge:Mt,OutcomesTable:_a,EnrollmentForm:Va,OutcomeForm:Ia},props:{patient:{type:Object,required:!0}},setup(t){const{toStandardHisDisplayFormat:a,toStandardHisFormat:o}=_t,s=new Kt(t.patient.getID()),c=F(()=>o(t.patient.getBirthdate())),h=O(),r=F(()=>!z(h.value)),u=O(""),v=O(),I=F(()=>{var D,b,y;return(y=(b=(D=h.value)==null?void 0:D.patient_states)==null?void 0:b.length)!=null?y:0}),_=F(()=>r.value&&u.value?"Patient enrolled in this porgram on ".concat(a(u.value)):"Patient is not enrolled in this program"),m=async({date:D,status:b,nextFacility:y,reason:S,otherReason:E,isTransferredOut:g})=>{if(s.setStateDate(D),s.setStateId(b.value),g){const w=S.value!=="Other"?S.value:E;await s.transferOutEncounter(y.other,w)}await s.updateState(),await Ce("Outcome saved successfully",1e3),await U.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},R=async D=>{s.setProgramDate(D),await s.enrollProgram(),await Ce("Program enrolled successfully",1e3),await U.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},A=async()=>{var D;s.setPatientProgramId(((D=h.value)==null?void 0:D.patient_program_id)||-1),await s.voidProgram("duplicate / system error"),await Ce("Patient voided from program successfully",1e3),await U.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},B=async({stateId:D,index:b})=>{var y;s.setStateId(D),await s.voidState("duplicate / system error"),Ce("Outcome voided successfully"),(y=h.value)==null||y.patient_states.splice(b,1),q.emit(L.RELOAD_PATIENT_VISIT_DATA)};return ye(async()=>{const D=(await s.getPrograms()).data;if(h.value=D.find(b=>b.program.name==="HIV PROGRAM"),h.value){u.value=h.value.date_enrolled;const b=await s.getProgramOutcomes(),y=new Set(s.removedStates);v.value=b.map(S=>({label:S.name,value:S.program_workflow_state_id,other:S})).filter(S=>!y.has(S.label))}}),{modal:U,patientProgram:s,isEnrolled:r,enrollDate:u,birthdate:c,enrollmentStatus:_,outcomes:v,program:h,totalStates:I,toStandardHisDisplayFormat:a,saveOutcome:m,enrollProgram:R,voidProgram:A,voidOutcome:B}}});function Aa(t,a,o,s,c,h){const r=V("ion-title"),u=V("ion-toolbar"),v=V("ion-header"),I=V("ion-badge"),_=V("ion-col"),m=V("ion-row"),R=V("enrollment-form"),A=V("outcome-form"),B=V("outcomes-table"),D=V("ion-grid"),b=V("ion-content"),y=V("ion-button"),S=V("ion-footer");return N(),M(W,null,[e(v,null,{default:n(()=>[e(u,null,{default:n(()=>[e(r,null,{default:n(()=>a[1]||(a[1]=[C("Patient Outcomes")])),_:1})]),_:1})]),_:1}),e(b,null,{default:n(()=>[e(D,{style:{width:"100%"}},{default:n(()=>[e(m,null,{default:n(()=>[e(_,null,{default:n(()=>[e(I,{color:"lightblue",class:"ion-padding",style:{width:"100%"},disabled:""},{default:n(()=>[C(me(t.enrollmentStatus),1)]),_:1})]),_:1})]),_:1}),t.isEnrolled?(N(),M(W,{key:1},[t.outcomes?(N(),$(m,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[e(A,{"date-enrolled":t.enrollDate,birthdate:t.birthdate,outcomes:t.outcomes,onSaveOutcome:t.saveOutcome},null,8,["date-enrolled","birthdate","outcomes","onSaveOutcome"])]),_:1})):G("",!0),e(m,{class:"his-card",style:ht({minHeight:t.totalStates?"0":"30vh"})},{default:n(()=>[e(_,{size:"12",class:"ion-no-padding"},{default:n(()=>{var E;return[e(B,{patientStates:(E=t.program)==null?void 0:E.patient_states,onVoidOutcome:t.voidOutcome},null,8,["patientStates","onVoidOutcome"])]}),_:1})]),_:1},8,["style"])],64)):(N(),$(m,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[e(_,{size:"12"},{default:n(()=>[e(R,{patientProgram:t.patientProgram,birthdate:t.birthdate,onEnrollProgram:t.enrollProgram},null,8,["patientProgram","birthdate","onEnrollProgram"])]),_:1})]),_:1}))]),_:1})]),_:1}),e(S,null,{default:n(()=>[e(u,null,{default:n(()=>[e(y,{color:"primary",onClick:a[0]||(a[0]=E=>t.modal.hide()),slot:"end"},{default:n(()=>a[2]||(a[2]=[C("Close")])),_:1}),t.isEnrolled?(N(),$(y,{key:0,color:"danger",onClick:t.voidProgram,slot:"end"},{default:n(()=>a[3]||(a[3]=[C("Void Program")])),_:1},8,["onClick"])):G("",!0)]),_:1})]),_:1})],64)}const Ra=ue(Na,[["render",Aa]]),Sa=Q({name:"MultiColumnView",components:{IonGrid:se,IonRow:ne,IonCol:P},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(t){const a={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:F(()=>ia(t.items,Math.ceil(t.items.length/t.numberOfColumns))),grid:a}}});function Pa(t,a,o,s,c,h){const r=V("ion-col"),u=V("ion-row"),v=V("ion-grid");return N(),$(v,null,{default:n(()=>[e(u,null,{default:n(()=>[(N(!0),M(W,null,Re(t.computedItems,(I,_)=>(N(),$(r,{key:_,size:t.grid[t.numberOfColumns]},{default:n(()=>[qt(t.$slots,"default",{entries:I})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const lt=ue(Sa,[["render",Pa]]);class Ta extends ce{constructor(a,o=j()){super(a,Te.HIV_RECEPTION,o)}}class Nt extends ce{constructor(a,o=j()){super(a,Te.ART_ADHERENCE,o)}buildPillCountObs(a,o){return this.buildValueNumber("Number of tablets brought to clinic",o,null,a)}async buildAdherenceObs(a,o,s){return{concept_id:await ce.getConceptID("Drug adherence",!0),value_numeric:s,value_drug:o,value_modifier:"%",order_id:a,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(a,o,s){return Math.round(100*(a-o)/(a-s))}calculateExpected(a,o,s,c){const h=c==="QW"?"week":"day",r=this.calcTimeElapsed(s,h);return a-r*parseFloat(o.toString())}calcTimeElapsed(a,o){return ee(this.date).diff(a,o)+1}}class Oa extends ce{constructor(a,o=j()){super(a,Te.APPOINTMENT,o)}}class Ca extends ce{constructor(a,o=j()){super(a,Te.TREATMENT,o)}calculateDosage(a,o){let s=0;return o===0&&(s=a),a==0&&(s=o),a>0&&o>0&&(s=(a+o)/2),s}calculateEquivalentDosage(a,o){return a+o}calculateDrugRunOutDate(a,o){return ta(ee(o).add(a,"days"))}getInstructions(a,o,s,c){return"".concat(a," :- Morning: ").concat(o," ").concat(c,", Evening: ").concat(s," ").concat(c)}toDrugOrder(a,o,s,c){return{drug_inventory_id:a.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(a.am,a.pm),start_date:c,auto_expire_date:this.calculateDrugRunOutDate(s,c),units:a.units,instructions:this.getInstructions(a.drug_name,a.am,a.pm,a.units),dose:this.calculateDosage(a.am,a.pm),frequency:a.frequency,qty:o}}async createDrugOrder(a){return ot.create({encounter_id:this.encounterID,drug_orders:a})}}class Ea{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(a,o,s){let c={result:"",color:"",index:s};if(s<=0)return c.index=0,c;if(o<5&&o>0)c.result="Use MUAC to calculate nutrition status",c.color="red";else{o>18&&(o=19);const h=await this.getBMIData(),r=h[a][o];r&&(c=this.buildBounds(Object.keys(r),r,s,h.colors))}return c}static buildBounds(a,o,s,c){const h={result:"",color:"",index:s};return a.forEach(r=>{if(r.indexOf("-")>=0){const u=r.split("-");s>=parseFloat(u[0])&&s<=parseFloat(u[1])&&(h.result=o[r],h.color=c[o[r]])}else if(r.indexOf("<")>=0){const u=r.replace("<","");s<parseFloat(u)&&(h.result=o[r],h.color=c[o[r]])}else if(r.indexOf(">=")>=0){const u=r.replace(">=","");s>=parseFloat(u)&&(h.result=o[r],h.color=c[o[r]])}}),h}static getBMI(a,o,s,c){const h=this.calculateBMI(a,o);return this.getBMIResult(s,c,h)}static calculateBMI(a,o){if(o==0||a==0)return 0;let s=a/o/o*1e4;return s=Math.round(s*10)/10}}class ka extends ce{constructor(a,o=j()){super(a,Te.DISPENSING,o)}buildDispensations(a,o,s){const c=[];for(let h=0;h<s;h++)c.push({drug_order_id:a,date:this.date,quantity:o/s});return c}saveDispensations(a){return Ae.postJson("/dispensations",{dispensations:a,program_id:this.programID})}}const $a=Q({__name:"PatientVisit",props:{patient:{type:Object,required:!0}},setup(t){const a=t,o=F(()=>a.patient.getID()),s=new Zt(o.value),c=new ea(o.value),h=new Ca(o.value),r=new ka(o.value),u=new Ta(o.value),v=new Nt(o.value),I=new Oa(o.value),_=O(),m=O(),R=O([]),A=O([]),B=O([]),D=O([]),b=F(()=>!(_.value&&a.patient.getAge()>18)),y=F(()=>a.patient.isFemale()),S=O(""),E=a.patient.getBirthdate(),g=O(!1),w=re({}),i=re({visitDate:{value:ee().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async l=>new Date(l.value)>new Date(j())?["Visit date cannot be after today's date"]:new Date(l.value)<new Date(E)?["Visit date cannot be before patient's birth date"]:null},weight:{value:void 0,label:"Weight",required:!0,computedValue:l=>({tag:"vitals",obs:s.buildValueNumber("Weight",l)}),validation:(l,p)=>(z(l)||!l.value)&&p.patientPresent.value==="No"?null:ze([()=>fe(l),()=>oe(l,"DECIMALS"),()=>bt(l,2,250)])},bp:{value:"",label:"Blood Pressure (mmHG)",placeholder:"Enter Blood Pressure e.g 120/80",validation:l=>z(l)||!l.value?null:ua(l),computedValue:l=>{if(z(l))return null;const[p,f]=l.split("/").map(Number);return{tag:"vitals",obs:[s.buildValueNumber("Systolic",p),s.buildValueNumber("Diastolic",f)]}}},height:{value:void 0,label:"Height (cm)",computedValue:l=>({tag:"vitals",obs:s.buildValueNumber("Height",l)}),validation:l=>!b.value||(z(l)||!l.value)&&i.patientPresent.value==="No"?null:ze([()=>fe(l),()=>oe(l),()=>bt(l,20,220)])},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:y.value,computedValue:l=>({tag:"consultation",obs:c.buildValueCoded("Is patient pregnant",l)}),validation:async l=>y.value&&fe(l)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:y.value,computedValue:l=>({tag:"consultation",obs:c.buildValueCoded("Is patient breast feeding",l)}),validation:async l=>y.value&&fe(l)},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:l=>({tag:"appointment",obs:I.buildValueDate("Appointment date",l)}),validation:async(l,p)=>new Date(l.value)<new Date(p.visitDate.value)?["Appointment date cannot be before visit date"]:new Date(l.value)>new Date(S.value)?["Appointment date cannot be after drug run out date"]:null},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:l=>({tag:"reception",obs:u.buildValueCoded("Patient present",l)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:l=>({tag:"reception",obs:u.buildValueCoded("Guardian present",l)})},pillCount:{value:void 0,label:"Pill Count",required:D.value.length>0,validation:async l=>D.value.length>0&&oe(l)},regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","INH")}),validation:async(l,p)=>{var f,k;return(((f=p.tbMed.value)==null?void 0:f.label)==="6H"||((k=p.tbMed.value)==null?void 0:k.label)==="3HP (RFP + INH)")&&oe(l)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(l,p)=>{var f;return((f=p.tbMed.value)==null?void 0:f.label)==="3HP (RFP + INH)"&&oe(l)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(l,p)=>{var f;return((f=p.tbMed.value)==null?void 0:f.label)==="3HP (INH 300 / RFP 300)"&&oe(l)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(l,p)=>{var f;return((f=p.tbMed.value)==null?void 0:f.label)&&oe(l)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async l=>ze([()=>fe(l),()=>l.value==="No"||A.value.some(p=>p.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async l=>ze([()=>fe(l),()=>l.value==="No"||B.value.some(p=>p.isChecked)?null:["Please select at least one side effect"]])},tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:l=>({tag:"consultation",obs:c.buildValueCoded("TB Status",l.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async l=>{if(!g.value){if(new Date(l.value)>new Date(j()))return["TB treatment start date cannot be after today's date"];if(new Date(l.value)<new Date(E))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:l=>({tag:"consultation",obs:c.buildValueDate("TB treatment start date",l)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:l=>({tag:"consultation",obs:c.buildValueNumber("TB treatment period",l)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:l=>({tag:"consultation",obs:c.buildGroupValueCoded("TB screening method used","chest xray",l)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:l=>({tag:"consultation",obs:c.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",l)})}});ve(()=>i.regimen.value,l=>{var p;Xe(),l&&((p=l==null?void 0:l.other)==null||p.forEach(f=>{var k;w[f.drug_name]={label:"".concat((k=f.alternative_drug_name)!=null?k:f.drug_name," given"),value:0,required:!0,validation:le=>oe(le,"POSITIVE_INTEGERS")}}))}),ve(i.patientPresent,l=>{l.value==="No"?(i.weight.required=!1,i.weight.error="",i.guardianPresent.value="Yes"):i.weight.required=!0}),ve(i.guardianPresent,l=>{l.value==="No"&&(i.patientPresent.value="Yes")}),ve([()=>i.weight.value,()=>i.tbStatus.value],async([l,p])=>{var k;i.regimen.value=void 0,Xe();const f=g.value||/confirmed/i.test((k=p==null?void 0:p.label)!=null?k:"");l?(R.value=await Ne.getRegimensByWeight(i.weight.value,f),i.patientPresent.value="Yes",i.patientPresent.disabled=!0):!l&&i.weight.required&&(i.patientPresent.value=void 0,i.patientPresent.disabled=!1),i.tbMed.disabled=f});const H=()=>{var l,p;return z(w)?1/0:Math.min(...(p=(l=i.regimen.value)==null?void 0:l.other)==null?void 0:p.map(f=>{var k,le,he,qe,Le;return((le=(k=w[f.drug_name])==null?void 0:k.value)!=null?le:0)/(((he=f.am)!=null?he:0)+((qe=f.noon)!=null?qe:0)+((Le=f.pm)!=null?Le:0))||1}))};ve([()=>w,()=>i.pillCount.value,()=>i.visitDate.value],()=>{const l=parseInt(i.pillCount.value)||0,p=H();p!==1/0&&(S.value=h.calculateDrugRunOutDate(p+l,i.visitDate.value),i.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(_e(S.value),")"),i.nextAppointmentDate.value=S.value)},{deep:!0}),ve(()=>i.visitDate.value,()=>rt());const X=F(()=>{var l;return((l=i.tbMed.value)==null?void 0:l.label)==="3HP (INH 300 / RFP 300)"}),te=F(()=>{var l;return((l=i.tbMed.value)==null?void 0:l.label)==="3HP (RFP + INH)"}),Y=F(()=>{var l;return((l=i.tbMed.value)==null?void 0:l.label)==="6H"}),T=F(()=>i.hasContraindications.value==="Yes"),de=F(()=>i.hasSideEffects.value==="Yes"),At=F(()=>{var l;return/Confirmed TB on treatment/i.test((l=i.tbStatus.value)==null?void 0:l.label)}),Rt=F(()=>{var l;return/Suspected/i.test((l=i.tbStatus.value)==null?void 0:l.label)}),St=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Pt=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Tt=Qe(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),Ot=Qe(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),rt=async()=>{c.setDate(i.visitDate.value),g.value=!1;const l=await c.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(l)){const p=await c.getFirstValueDatetime("TB treatment start date"),f=await c.getFirstValueNumber("TB treatment period")||6;if(p){const k=ee(i.visitDate.value).diff(p,"months");g.value=k<=f}}i.tbStatus.required=!g.value},Ct=async l=>{const p=l.height||_.value,f=Ea.calculateBMI(l.weight,p);return s.buildValueNumber("BMI",f)},Et=async()=>{const l=[await c.buildValueCoded("Patient using family planning","No")];return c.getFamilyPlanningMethods().forEach(async f=>{l.push(await c.buildValueCoded(f,"No"))}),l},kt=async()=>Promise.all(We.getConceptsByCategory("tb_symptom",!0).map(async l=>c.buildGroupValueCoded(l.name,l.name,"No"))),$t=async()=>{s.setDate(i.visitDate.value),c.setDate(i.visitDate.value),h.setDate(i.visitDate.value),u.setDate(i.visitDate.value),v.setDate(i.visitDate.value),I.setDate(i.visitDate.value),r.setDate(i.visitDate.value),await Oe(i,async(l,p)=>{var st,ut,dt,mt,ct;const f=[];let k=0;if(!z(l.regimen)&&await tt(w)){const K=l.regimen.other,x=at(w).formData;k=H(),K.forEach(J=>f.push(h.toDrugOrder(J,x[J.drug_name],k,l.visitDate)))}else if(!await De("Are you sure you want to continue without dispensing ART drugs?"))return;if(ge.show("Saving patient visit..."),l.totalCPTGiven&&gt((await Ne.getRegimenExtras("Cotrimoxazole",(st=l.weight)!=null?st:m.value)).data,"concept_name").filter(K=>K.frequency==="Daily (QOD)").forEach(K=>f.push(h.toDrugOrder(K,l.totalCPTGiven,k,l.visitDate))),(ut=l.tbMed)!=null&&ut.value){const K=gt((await Ne.getRegimenExtras("INH",(dt=l.weight)!=null?dt:m.value)).data,["concept_name","frequency"]),x=K.find(J=>J.concept_name==="Pyridoxine");if(x&&l.totalPyridoxineGiven&&f.push(h.toDrugOrder(x,l.totalPyridoxineGiven,k,l.visitDate)),l.totalIPTGiven){const J=K.find(Ie=>Ie.concept_name==="Isoniazid"&&(Y.value&&Ie.frequency==="Daily (QOD)"||te.value&&Ie.frequency==="Weekly (QW)"));f.push(h.toDrugOrder(J,l.totalIPTGiven,k,l.visitDate))}if(l.totalRFPGiven&&te.value){const J=(await Ne.getRegimenExtras("Rifapentine",(mt=l.weight)!=null?mt:m.value)).data;J.length&&f.push(h.toDrugOrder(J[0],l.totalRFPGiven,k,l.visitDate))}if(l.total3HPGiven&&X.value){const J=(await Ne.getRegimenExtras("INH / RFP",(ct=l.weight)!=null?ct:m.value)).data;f.push(h.toDrugOrder(J[0],l.total3HPGiven,k,l.visitDate))}}if(!z(f)){await h.createEncounter();const x=(await h.createDrugOrder(f)).data.map(J=>{const Ie=f.find(Ft=>Ft.drug_inventory_id===J.drug_inventory_id);return r.buildDispensations(J.order_id,Ie.qty,1)});await r.saveDispensations(x.flat(1))}const le=await ke(p,"vitals");if(!z(le)){await s.createEncounter();const K=await Ct(l);await s.saveObservationList([...le,K])}await c.createEncounter();const he=await ke(p,"consultation");he.push(...await c.buildOptionsGroupObs("Malawi ART side effects",A.value)),he.push(...await kt()),de.value&&he.push(...await c.buildOptionsGroupObs("Other side effect",B.value)),y.value&&he.push(...await Et()),await c.saveObservationList(he),await u.createEncounter();const qe=await ke(p,"reception");if(await u.saveObservationList(qe),D.value.length>0){await v.createEncounter();const K=await Promise.all(D.value.map(async x=>{const J=v.calculateExpected(x.quantity,x.equivalent_daily_dose,x.order.start_date,x.frequency),Ie=v.calculateAdherence(x.quantity,l.pillCount,J);return[await v.buildAdherenceObs(x.order_id,x.drug_inventory_id,Ie),await v.buildPillCountObs(x.order_id,l.pillCount)]}));await v.saveObservationList(K.flat(1))}await I.createEncounter();const Le=await ke(p,"appointment");await I.saveObservationList(Le),await Ce("Patient visit saved successfully"),await U.hide(),ge.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA),q.emit(L.RELOAD_STAGING_INFORMATION)},{showloader:!1})},Bt=async()=>{if(await De("Are you sure you want to clear all fields?")){for(const l in i)i[l].value="",i[l].error="",i[l].disabled=!1;Xe(),q.emit(L.ON_CLEAR)}},Xe=()=>{for(const l in w)delete w[l]};return ye(async()=>{try{await rt(),_.value=await a.patient.getRecentHeight(),m.value=await a.patient.getRecentWeight(),m.value&&(R.value=await Ne.getRegimensByWeight(m.value)),D.value=await ot.getLastDrugsReceived(a.patient.getID()),i.pillCount.required=D.value.length>0,A.value=We.getConceptsByCategory("contraindication",!0).map(l=>({value:l.concept_id,label:l.name,other:l})),B.value=We.getConceptsByCategory("side_effect",!0).map(l=>({value:l.concept_id,label:l.name,other:l}))}catch(l){Be("Form initialization failed. Try to refresh the page"),console.error(l)}}),(l,p)=>(N(),M(W,null,[e(d(Ue),null,{default:n(()=>[e(d(be),null,{default:n(()=>[e(d(Fe),null,{default:n(()=>p[25]||(p[25]=[C("Patient Visit")])),_:1})]),_:1})]),_:1}),e(d(He),{class:"ion-padding"},{default:n(()=>[e(d(se),{style:{width:"100%"}},{default:n(()=>[e(d(ne),null,{default:n(()=>[e(d(P),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(pe,{modelValue:i.visitDate,"onUpdate:modelValue":p[0]||(p[0]=f=>i.visitDate=f),form:i,minDate:d(E),maxDate:d(j)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Ve,{modelValue:i.patientPresent,"onUpdate:modelValue":p[1]||(p[1]=f=>i.patientPresent=f),inline:"",disabled:i.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Ve,{modelValue:i.guardianPresent,"onUpdate:modelValue":p[2]||(p[2]=f=>i.guardianPresent=f),inline:""},null,8,["modelValue"])]),_:1}),y.value?(N(),M(W,{key:0},[e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Ve,{modelValue:i.isPregnant,"onUpdate:modelValue":p[3]||(p[3]=f=>i.isPregnant=f),inline:""},null,8,["modelValue"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Ve,{modelValue:i.isBreastfeeding,"onUpdate:modelValue":p[4]||(p[4]=f=>i.isBreastfeeding=f),inline:""},null,8,["modelValue"])]),_:1})],64)):G("",!0),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Ve,{modelValue:i.hasContraindications,"onUpdate:modelValue":p[5]||(p[5]=f=>i.hasContraindications=f),inline:""},null,8,["modelValue"]),T.value?(N(),$(lt,{key:0,items:A.value,numberOfColumns:2},{default:n(({entries:f})=>[(N(!0),M(W,null,Re(f,k=>(N(),$(d(Je),{lines:"none",key:k.value},{default:n(()=>[e(d(je),null,{default:n(()=>[C(me(k.label),1)]),_:2},1024),e(d(et),{slot:"start",modelValue:k.isChecked,"onUpdate:modelValue":le=>k.isChecked=le},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1}),e(d(P),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[e(Ve,{modelValue:i.hasSideEffects,"onUpdate:modelValue":p[6]||(p[6]=f=>i.hasSideEffects=f),inline:""},null,8,["modelValue"]),de.value?(N(),$(lt,{key:0,items:B.value,numberOfColumns:2},{default:n(({entries:f})=>[(N(!0),M(W,null,Re(f,k=>(N(),$(d(Je),{lines:"none",key:k.value},{default:n(()=>[e(d(je),null,{default:n(()=>[C(me(k.label),1)]),_:2},1024),e(d(et),{slot:"start",modelValue:k.isChecked,"onUpdate:modelValue":le=>k.isChecked=le},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:i.weight,"onUpdate:modelValue":p[7]||(p[7]=f=>i.weight=f),form:i,min:1},null,8,["modelValue","form"])]),_:1}),b.value?(N(),$(d(P),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:i.height,"onUpdate:modelValue":p[8]||(p[8]=f=>i.height=f),form:i,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Se,{modelValue:i.bp,"onUpdate:modelValue":p[9]||(p[9]=f=>i.bp=f),form:i},null,8,["modelValue","form"])]),_:1}),g.value?G("",!0):(N(),$(d(P),{key:2,class:"ion-margin-vertical",size:b.value?"6":"12"},{default:n(()=>[e(ie,{modelValue:i.tbStatus,"onUpdate:modelValue":p[10]||(p[10]=f=>i.tbStatus=f),options:d(Ot)},null,8,["modelValue","options"])]),_:1},8,["size"])),At.value?(N(),M(W,{key:3},[e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(pe,{modelValue:i.tbTreatmentStartDate,"onUpdate:modelValue":p[11]||(p[11]=f=>i.tbTreatmentStartDate=f),form:i,minDate:d(E),maxDate:d(j)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:i.tbTreatmentPeriod,"onUpdate:modelValue":p[12]||(p[12]=f=>i.tbTreatmentPeriod=f),form:i,min:1},null,8,["modelValue","form"])]),_:1})],64)):Rt.value?(N(),M(W,{key:4},[e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Ve,{modelValue:i.cxrResult,"onUpdate:modelValue":p[13]||(p[13]=f=>i.cxrResult=f),"custom-options":St},null,8,["modelValue"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Ve,{modelValue:i.mwrdResult,"onUpdate:modelValue":p[14]||(p[14]=f=>i.mwrdResult=f),"custom-options":Pt},null,8,["modelValue"])]),_:1})],64)):G("",!0),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:i.regimen,"onUpdate:modelValue":p[15]||(p[15]=f=>i.regimen=f),options:R.value},null,8,["modelValue","options"])]),_:1}),d(z)(w)?G("",!0):(N(!0),M(W,{key:5},Re(Object.values(w),(f,k)=>(N(),$(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{"model-value":f,form:w,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:i.totalCPTGiven,"onUpdate:modelValue":p[16]||(p[16]=f=>i.totalCPTGiven=f),form:i,min:1},null,8,["modelValue","form"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:i.tbMed,"onUpdate:modelValue":p[17]||(p[17]=f=>i.tbMed=f),options:d(Tt)},null,8,["modelValue","options"])]),_:1}),Y.value||te.value?(N(),$(d(P),{key:6,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:i.totalIPTGiven,"onUpdate:modelValue":p[18]||(p[18]=f=>i.totalIPTGiven=f),form:i,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),te.value?(N(),$(d(P),{key:7,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:i.totalRFPGiven,"onUpdate:modelValue":p[19]||(p[19]=f=>i.totalRFPGiven=f),form:i,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),X.value?(N(),$(d(P),{key:8,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:i.total3HPGiven,"onUpdate:modelValue":p[20]||(p[20]=f=>i.total3HPGiven=f),form:i,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),X.value||te.value||Y.value?(N(),$(d(P),{key:9,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:i.totalPyridoxineGiven,"onUpdate:modelValue":p[21]||(p[21]=f=>i.totalPyridoxineGiven=f),form:i,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),D.value.length>0?(N(),$(d(P),{key:10,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{modelValue:i.pillCount,"onUpdate:modelValue":p[22]||(p[22]=f=>i.pillCount=f),form:i,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e(d(P),{size:D.value.length>0?"6":"12",class:"ion-margin-vertical"},{default:n(()=>[e(pe,{modelValue:i.nextAppointmentDate,"onUpdate:modelValue":p[23]||(p[23]=f=>i.nextAppointmentDate=f),form:i,minDate:i.visitDate.value,maxDate:S.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1},8,["size"])]),_:1})]),_:1})]),_:1}),e(d(Me),null,{default:n(()=>[e(d(be),null,{default:n(()=>[e(d(Z),{color:"primary",onClick:p[24]||(p[24]=f=>d(U).hide()),slot:"end"},{default:n(()=>p[26]||(p[26]=[C(" Close ")])),_:1}),e(d(Z),{color:"warning",onClick:Bt,slot:"end"},{default:n(()=>p[27]||(p[27]=[C(" Reset ")])),_:1}),e(d(Z),{color:"success",onClick:$t,slot:"end"},{default:n(()=>p[28]||(p[28]=[C(" Save ")])),_:1})]),_:1})]),_:1})],64))}});const Ba=ue($a,[["__scopeId","data-v-ec5a6412"]]),Fa=Q({__name:"EmergencyRefill",props:{patient:{type:Object,required:!0}},setup(t){const a=t,o=F(()=>a.patient.getID()),s=new Nt(o.value),c=O(),h=O([]),r=O([]),u=F(()=>{var g;return(g=r.value[0])==null?void 0:g.order.start_date}),v=O(""),I=a.patient.getBirthdate(),_=O({}),m=re({date:{value:j(),label:"Date of emergency refill",required:!0,computedValue:g=>({obs:s.buildValueDate("Prescription refill date",g)})},facility:{value:void 0,label:"Facility where emergency refill was collected",required:!0,placeholder:"Select a facility",computedValue:g=>({obs:s.buildValueText("Health facility name",g.label)})},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:g=>({obs:s.buildValueDate("Appointment date",g)})}});async function R(g,w,i){const H=s.calculateExpected(g.quantity,g.equivalent_daily_dose,g.order.start_date,g.frequency),X=s.calculateAdherence(g.quantity,i,H);return{...await s.buildValueCoded("Medications dispensed",g.drug.concept_id),child:[await s.buildAdherenceObs(g.order_id,g.drug_inventory_id,X),await s.buildPillCountObs(g.order_id,i),,await s.buildValueNumber("Amount of drug dispensed",w)]}}async function A(){if(await De("Are you sure you want to clear all fields?")){for(const g in m)m[g].value="",m[g].error="",m[g].disabled=!1;B(),q.emit(L.ON_CLEAR)}}function B(){for(const g in _.value)delete _.value[g]}function D(g){return g.regimen?"".concat(g.regimen," - ").concat(g.drug.name):g.drug.name}function b(){return z(r.value)?1/0:Math.min(...r.value.map(g=>{var te,Y,T,de;const w=D(g),i=Number((Y=(te=_.value["".concat(w,"_given")])==null?void 0:te.value)!=null?Y:0),H=Number((de=(T=_.value["".concat(w,"_brought")])==null?void 0:T.value)!=null?de:0),X=Number(g.equivalent_daily_dose);return(i+H)/X}))}function y(){const g=b();g!==1/0&&(v.value=aa(m.date.value,g,"days"),m.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(_e(v.value),")"),m.nextAppointmentDate.value=v.value)}async function S(){if(await tt(m)&&await tt(_.value))try{ge.show(),s.setDate(m.date.value);const g=await ke({...at(m).computedFormData,...at(_.value).computedFormData}),w=new ce(o.value,Te.EMERGENCY_DRUG_REFILL,m.date.value);await w.createEncounter(),await w.saveObservationList(g),Ce("Emergency refill saved successfully"),U.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA),q.emit(L.RELOAD_STAGING_INFORMATION)}catch(g){console.error(g),Be("Failed to save emergency refill")}finally{ge.hide()}}function E(){r.value.forEach(g=>{const w=D(g);_.value["".concat(w,"_brought")]={label:"".concat(w," brought"),value:void 0,required:!0,placeholder:"Enter the number of pills brought",validation:i=>oe(i,"POSITIVE_INTEGERS")},_.value["".concat(w,"_given")]={label:"".concat(w," given"),value:void 0,required:!0,placeholder:"Enter the number of pills given",validation:i=>oe(i,"POSITIVE_INTEGERS"),computedValue:(i,H)=>R(g,i,H["".concat(w,"_brought")].value)}})}return ve([()=>_,()=>m.date.value],y,{deep:!0,immediate:!0}),ye(async()=>{try{ge.show(),c.value=await a.patient.getRecentWeight(),h.value=await Ne.getRegimensByWeight(c.value),r.value=await ot.getLastDrugsReceived(o.value),E()}catch(g){Be("Form initialization failed. Try to refresh the page"),console.error(g)}finally{ge.hide()}}),(g,w)=>(N(),M(W,null,[e(d(Ue),null,{default:n(()=>[e(d(be),null,{default:n(()=>[e(d(Fe),null,{default:n(()=>w[4]||(w[4]=[C("Emergency Drug Refill")])),_:1})]),_:1})]),_:1}),e(d(He),{class:"ion-padding"},{default:n(()=>[e(d(se),{style:{width:"100%"}},{default:n(()=>[e(d(ne),null,{default:n(()=>[e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(pe,{modelValue:m.date,"onUpdate:modelValue":w[0]||(w[0]=i=>m.date=i),form:m,minDate:u.value||d(I),maxDate:d(j)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:m.facility,"onUpdate:modelValue":w[1]||(w[1]=i=>m.facility=i),form:m,asyncOptions:d(Dt)},null,8,["modelValue","form","asyncOptions"])]),_:1}),(N(!0),M(W,null,Re(Object.values(_.value),i=>(N(),$(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ae,{"model-value":i,form:_.value,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),e(d(P),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(pe,{modelValue:m.nextAppointmentDate,"onUpdate:modelValue":w[2]||(w[2]=i=>m.nextAppointmentDate=i),form:m,minDate:m.date.value,maxDate:v.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1})]),_:1})]),_:1})]),_:1}),e(d(Me),null,{default:n(()=>[e(d(be),null,{default:n(()=>[e(d(Z),{color:"primary",onClick:w[3]||(w[3]=i=>d(U).hide()),slot:"end"},{default:n(()=>w[5]||(w[5]=[C(" Close ")])),_:1}),e(d(Z),{color:"warning",onClick:A,slot:"end"},{default:n(()=>w[6]||(w[6]=[C(" Reset ")])),_:1}),e(d(Z),{color:"success",onClick:S,slot:"end"},{default:n(()=>w[7]||(w[7]=[C(" Save ")])),_:1})]),_:1})]),_:1})],64))}}),Ua=Q({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:it,IonCard:Lt,IonCardHeader:Gt,IonCardTitle:zt,IonCardContent:Wt,IonButton:Z},setup(t){const a=O([]),o=F(()=>t.patient.getID()),s=re({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),c=O([{label:"Add Visit",action:async()=>{await U.show(Ba,{patient:t.patient})}},{label:"Emegency Refill",action:async()=>{await U.show(Fa,{patient:t.patient})}},{label:"Update Outcome",action:async()=>U.show(Ra,{patient:t.patient})},{label:"Enter VL Results",action:async()=>U.show(fa,{patient:t.patient})}]),h=D=>{const b=t.startDate!=="N/A"?"("+ee(D).diff(t.startDate,"months")+"M)":"";return"".concat(_e(D)," ").concat(b)},r={minWidth:"68px !important"},u=O([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:r},{path:"vitals",label:"Vitals",sortable:!1,thStyles:r},...t.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:r},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:r}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:D=>D.length>0?"Yes":"No",sortable:!1,thStyles:r},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:r},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:r},{path:"vlResult",label:"Viral Load",sortable:!1}]),v=D=>({title:"Side effects noted on ".concat(D.row.visitDate),rows:D.row.sideEffects.map(b=>({sideEffect:b})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),I=D=>({title:"Drugs dispensed on ".concat(D.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:D.row.drugs.map(b=>({name:b[0],quantity:b[1],units:"tab (s)"}))}),_=async D=>{const b=/regimen/i.test(D.column.path)?I(D):v(D);z(b.rows)||await U.show(ma,b)},m=[{label:"void",icon:Yt,color:"danger",action(D,b){wt(async y=>{var E;const S=await ft.getEncounters(o.value,{date:D.date});S.ok?((E=S.data)==null||E.forEach(async g=>{await ft.voidEncounter(g.encounter_id,y)}),a.value.splice(b,1)):Be(S.errorMessage||"Failed to void encounters")},"small-modal")}}],R=async D=>D.tb_status.match(/Unknown/i)||D.outcome==="Defaulted"?"":We.getCachedConceptName(D.tb_status),A=D=>{const b=D.weight?"Wt: ".concat(D.weight,"kg"):"",y=D.height?"Ht: ".concat(D.height,"cm"):"",S=D.bmi?"BMI: ".concat(D.bmi):"",E=D.bp?"BP: ".concat(D.bp):"";return[b,y,S,E].filter(Boolean).join(", ")},B=()=>{xe.getPatientVisits(o.value,!0).then(async D=>{a.value=[];for(const b of D){const y=(await Vt.getCurrentProgramInformation(o.value,b)).data;let S="",E="",g="",w="";if(y.outcome!=="Defaulted"){const i=await Ge.getFirstValueDatetime(o.value,"appointment date",b);if(i&&(S=_e(i)),E=await Ge.getFirstValueCoded(o.value,"Is patient pregnant",b),g=await Ge.getFirstValueCoded(o.value,"Is patient breast feeding",b),y.viral_load==="N/A"){const H=await Ge.getFirstObs(o.value,"HIV viral load",b);H&&H.value_text&&H.value_numeric&&(w=H.value_numeric===1?"LDL":H.value_text+H.value_numeric.toString())}else w=y.viral_load}y&&a.value.push({visitDate:h(b),visitBy:y.visit_by.match(/Unk/i)?"":y.visit_by,vitals:A(y),pregnant:E,breastfeeding:g,tbStatus:await R(y),sideEffects:y.outcome==="Defaulted"?"":y.side_effects,regimen:y.outcome==="Defaulted"?"":y.regimen,nextAppointment:S,outcome:y.outcome.match(/Unk/i)?"":y.outcome,vlResult:w,drugs:y.pills_dispensed,date:b})}})};return q.on(L.RELOAD_PATIENT_VISIT_DATA,()=>B()),ye(()=>{B()}),{actionButtons:c,tableConfig:s,rowButtons:m,columns:u,rows:a,onDrilldownHandler:_}}});const Ha={class:"ion-float-right ion-margin-end ion-margin-bottom"};function Ma(t,a,o,s,c,h){const r=V("ion-icon"),u=V("ion-button"),v=V("ion-card-title"),I=V("ion-card-header"),_=V("data-table"),m=V("ion-card-content"),R=V("ion-card");return N(),$(R,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[e(I,null,{default:n(()=>[e(v,null,{default:n(()=>[a[0]||(a[0]=we("span",{class:"title"},"Summary of Visits",-1)),we("span",Ha,[(N(!0),M(W,null,Re(t.actionButtons,A=>(N(),$(u,{key:A.label,onClick:A.action,color:A.color||"primary"},{default:n(()=>[A.icon?(N(),$(r,{key:0,icon:A.icon,class:"ion-margin-right"},null,8,["icon"])):G("",!0),C(" "+me(A.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),e(m,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[e(_,{rows:t.rows,columns:t.columns,"row-actions-buttons":t.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:t.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const qa=ue(Ua,[["render",Ma],["__scopeId","data-v-2c90703e"]]),La=Q({__name:"ViralLoadTrail",props:{patient:{}},setup(t){const a=t,o=F(()=>"Viral Load Results Trail for ".concat(a.patient.getFullName())),s=O([]),c=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:_e},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:_e}],h={label:"X",color:"danger",action({encounter_id:r}){wt(async u=>{try{await jt.void(r,u),U.hide(),q.emit(L.RELOAD_LATEST_VL_RESULT),q.emit(L.RELOAD_PATIENT_VISIT_DATA)}catch(v){console.error(v)}},"small-modal custom-modal-backdrop")}};return ye(async()=>{s.value=await Pe.getViralLoadResultTrail(a.patient.getID())}),(r,u)=>(N(),M(W,null,[e(d(Ue),null,{default:n(()=>[e(d(be),null,{default:n(()=>[e(d(Fe),null,{default:n(()=>[C(me(o.value),1)]),_:1})]),_:1})]),_:1}),e(d(He),null,{default:n(()=>[e(d(se),{style:{width:"100%"}},{default:n(()=>[e(d(ne),{style:ht([{padding:"0 !important"},{minHeight:s.value.length?"0":"30vh"}])},{default:n(()=>[e(d(P),{size:"12",class:"ion-no-padding"},{default:n(()=>[e(d(it),{rows:s.value,columns:c,"row-actions-buttons":[h],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),e(d(Me),null,{default:n(()=>[e(d(be),null,{default:n(()=>[e(d(Z),{color:"primary",onClick:u[0]||(u[0]=v=>d(U).hide()),slot:"end"},{default:n(()=>u[1]||(u[1]=[C(" Close ")])),_:1})]),_:1})]),_:1})],64))}}),Ga=Q({components:{MultiColumnView:lt,IonList:Jt,IonItem:Je},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(t,{emit:a}){const o=O(0),s=O(0),c=O(0),h=O(""),r=O(""),u=O(""),v=O(""),I=O(""),_=O(""),m=O(""),R=O(""),A=O(""),B=O(""),D=O(""),b=T=>T.other&&typeof T.other.onClickHandler=="function",y=F(()=>!z(t.guardians)),S=async T=>{var de;b(T)&&await((de=T.other)==null?void 0:de.onClickHandler())},E=()=>{const T=t.patient.getBirthdate(),de=t.artStartDate!=="N/A"?ee(t.artStartDate).diff(T,"years"):"";return"".concat(_e(T)," (").concat(de,")")},g=()=>{Pe.getlatestViralLoadResult(t.patient.getID()).then(T=>B.value=T)},w=()=>({onClickHandler(){xt.push("/patient/reception/".concat(t.patient.getID(),"/false"))}}),i=()=>y.value?t.guardians.map(T=>"".concat(T.name," (").concat(T.relationshipType,")")).join(","):"Add",H=()=>({onClickHandler:()=>a("updatePatient")}),X=F(()=>[{label:"ARV Number",value:t.patient.getArvNumber(),other:{onClickHandler:()=>a("updateARVNumber")}},{label:"MW National ID",value:t.patient.getMWNationalID(),other:H()},{label:"Name",value:t.patient.getGivenName()+" "+t.patient.getFamilyName(),other:H()},{label:"DOB and Age at Initiation",value:E(),other:H()},{label:"Sex",value:ca(t.patient.getGender()),other:H()},{label:"Location",value:t.patient.getCurrentVillage(),other:H()},{label:"Landmark",value:t.patient.getClosestLandmark(),other:H()},{label:"Phone Number",value:t.patient.getPhoneNumber(),other:H()},{label:"Guardian",value:i(),other:{onClickHandler:()=>a("updateGuardian")}},{label:"Agrees to follow up",value:I.value,other:w()},{label:"Date of starting first line ARV Regimen",value:t.artStartDate,other:w()},{label:"Initial Weight (KG)",value:o.value,other:w()},{label:"Initial Height (CM)",value:s.value,other:w()},{label:"Initial BMI",value:c.value,other:w()},{label:"Initial TB Status",value:h.value,other:w()},{label:"Pregnant at Initiation",value:u.value,other:w()},{label:"Breastfeeding at Initiation",value:r.value,other:w()},{label:"Latest VL Result and Result Date",value:B.value,other:{onClickHandler:()=>U.show(La,{patient:t.patient})}},{label:"TI",value:v.value,other:w()},{label:"HIV test place",value:R.value,other:w()},{label:"HIV test date",value:m.value,other:w()},{label:"WHO stage",value:D.value,other:w()},{label:"Reason for starting ART",value:_.value,other:w()},{label:"Staging codition",value:A.value,other:w()}]),te=async()=>{const T=await t.patient.getHIVTestDate();T&&(m.value=_e(T))},Y=()=>{t.patient.getInitialWeight().then(T=>o.value=T),t.patient.getInitialHeight().then(T=>s.value=T),t.patient.getInitialBMI().then(T=>c.value=T),t.patient.getInitialTBStatus().then(T=>h.value=T),t.patient.hasPregnancyAtARTInitiation().then(T=>u.value=T),t.patient.breastFeedingAtARTInitiation().then(T=>r.value=T),t.patient.everReceivedART().then(T=>v.value=T),t.patient.agreesToFollowUp().then(T=>I.value=T),t.patient.getReasonForStartingART().then(T=>_.value=T),t.patient.getHIVTestLocation().then(T=>R.value=T),t.patient.getStagingCondition().then(T=>A.value=T),t.patient.getWhoStage().then(T=>D.value=T),te()};return ye(()=>{Y(),g(),q.on(L.RELOAD_LATEST_VL_RESULT,()=>g()),q.on(L.RELOAD_STAGING_INFORMATION,()=>Y())}),{patientInfo:X,onClickHandler:S,clickable:b}}});const za={style:{width:"100%",display:"flex",justifyContent:"space-between"}},Wa={key:0},Ya={key:1},ja={key:2},Ja={key:3};function xa(t,a,o,s,c,h){const r=V("ion-item"),u=V("ion-list"),v=V("multi-column-view");return N(),$(v,{items:t.patientInfo,numberOfColumns:3},{default:n(({entries:I})=>[e(u,{class:"his-card ion-margin-end"},{default:n(()=>[(N(!0),M(W,null,Re(I,(_,m)=>(N(),$(r,{key:m,lines:m===I.length-1?"none":void 0,button:t.clickable(_),onClick:R=>t.onClickHandler(_)},{default:n(()=>[we("div",za,[_.label?(N(),M("span",Wa,me(_.label)+": ",1)):(N(),M("span",Ya)),t.clickable(_)?(N(),M("span",ja,[we("a",null,[we("b",null,me(_.value||"N/A"),1)])])):(N(),M("span",Ja,[we("b",null,me(_.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const Qa=ue(Ga,[["render",xa],["__scopeId","data-v-5306de30"]]),Xa=Q({components:{IonGrid:se,IonRow:ne,IonCol:P,TextInput:Se,DateInput:pe,SelectInput:ie},props:{patientService:{type:Object,required:!0}},setup(t){const a=O(!1),o=F(()=>/Unknown/i.test(t.patientService.getMWNationalID())?"":t.patientService.getMWNationalID()),s=re({givenName:{label:"First Name",value:t.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:r=>$e(r)},familyName:{label:"last Name",value:t.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:r=>$e(r)},middleName:{label:"middle Name",value:t.patientService.getMiddleName(),placeholder:"middle Name",validation:r=>!!r&&$e(r)},nationalId:{label:"Malawi National ID Number",value:o.value,placeholder:"Enter Malawi National ID Number",validation:r=>r&&r.label?da(r):null},gender:{value:t.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:t.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:t.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async r=>!(r.value==="Unknown"||r.value==="N/A")&&It(r)},homeVillage:{value:t.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:t.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),c=async r=>{var I,_,m,R,A;let u,v;try{(I=r==null?void 0:r.other)!=null&&I.traditional_authority_id&&(u=await vt.getTraditionalAuthorityById(r.other.traditional_authority_id)),u&&(v=await vt.getDistrictByID(u.district_id))}catch(B){Be("Unable to resolve patient address. Saving using default address"),console.error(B)}return{home_district:(_=v==null?void 0:v.name)!=null?_:"N/A",home_traditional_authority:(m=u==null?void 0:u.name)!=null?m:"N/A",home_village:(r==null?void 0:r.label)||"N/A",current_district:(R=v==null?void 0:v.name)!=null?R:"N/A",current_traditional_authority:(A=u==null?void 0:u.name)!=null?A:"N/A",current_village:(r==null?void 0:r.label)||"N/A"}};return{today:j,patient:s,getLandmarks:ra,genderOptions:la,isBirthdateEstimated:a,modal:U,onFinish:async()=>Oe(s,async r=>{const u={};if(r.givenName!==t.patientService.getGivenName()&&(u.given_name=r.givenName),r.familyName!==t.patientService.getFamilyName()&&(u.family_name=r.familyName),r.middleName!==t.patientService.getMiddleName()&&(u.middle_name=r.middleName),r.birthdate!==t.patientService.getBirthdate()&&(u.birthdate=r.birthdate),r.gender.value!==t.patientService.getGender()&&(u.gender=r.gender.value),r.cellPhoneNumber!==t.patientService.getPhoneNumber()&&(u.cell_phone_number=r.cellPhoneNumber),r.landmark.label!==t.patientService.getClosestLandmark()&&(u.landmark=r.landmark.label),r.homeVillage!==t.patientService.getCurrentVillage()&&Object.assign(u,{...u,...await c(r.homeVillage)}),!z(u)){const v=new nt;v.setPersonID(t.patientService.getID()),await v.updatePerson(u)}r.nationalId!==o.value&&await t.patientService.updateMWNationalId(r.nationalId),await U.hide(),q.emit(L.RELOAD_PATIENT_DATA)}),getVillagesByName:sa}}});function Ka(t,a,o,s,c,h){const r=V("ion-title"),u=V("ion-icon"),v=V("ion-button"),I=V("ion-buttons"),_=V("ion-toolbar"),m=V("ion-header"),R=V("TextInput"),A=V("ion-col"),B=V("SelectInput"),D=V("DateInput"),b=V("ion-row"),y=V("ion-grid"),S=V("ion-content"),E=V("ion-footer");return N(),M(W,null,[e(m,null,{default:n(()=>[e(_,null,{default:n(()=>[e(r,null,{default:n(()=>a[12]||(a[12]=[C("Edit Patient Demographics")])),_:1}),e(I,{slot:"end"},{default:n(()=>[e(v,{onClick:a[0]||(a[0]=g=>t.modal.hide())},{default:n(()=>[e(u,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(S,{class:"ion-padding"},{default:n(()=>[e(y,null,{default:n(()=>[e(b,null,{default:n(()=>[e(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(R,{modelValue:t.patient.givenName,"onUpdate:modelValue":a[1]||(a[1]=g=>t.patient.givenName=g)},null,8,["modelValue"])]),_:1}),e(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(R,{modelValue:t.patient.middleName,"onUpdate:modelValue":a[2]||(a[2]=g=>t.patient.middleName=g)},null,8,["modelValue"])]),_:1}),e(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(R,{modelValue:t.patient.familyName,"onUpdate:modelValue":a[3]||(a[3]=g=>t.patient.familyName=g)},null,8,["modelValue"])]),_:1}),e(A,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(R,{modelValue:t.patient.nationalId,"onUpdate:modelValue":a[4]||(a[4]=g=>t.patient.nationalId=g)},null,8,["modelValue"])]),_:1}),e(A,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(B,{modelValue:t.patient.gender,"onUpdate:modelValue":a[5]||(a[5]=g=>t.patient.gender=g),options:t.genderOptions},null,8,["modelValue","options"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(D,{modelValue:t.patient.birthdate,"onUpdate:modelValue":a[6]||(a[6]=g=>t.patient.birthdate=g),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:t.today,onIsEstimated:a[7]||(a[7]=g=>t.isBirthdateEstimated=g)},null,8,["modelValue","maxDate"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(R,{modelValue:t.patient.cellPhoneNumber,"onUpdate:modelValue":a[8]||(a[8]=g=>t.patient.cellPhoneNumber=g),allowUnknown:""},null,8,["modelValue"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(B,{modelValue:t.patient.homeVillage,"onUpdate:modelValue":a[9]||(a[9]=g=>t.patient.homeVillage=g),asyncOptions:t.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(B,{modelValue:t.patient.landmark,"onUpdate:modelValue":a[10]||(a[10]=g=>t.patient.landmark=g),asyncOptions:t.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),e(E,null,{default:n(()=>[e(_,null,{default:n(()=>[e(v,{color:"primary",onClick:a[11]||(a[11]=g=>t.modal.hide()),slot:"end"},{default:n(()=>a[13]||(a[13]=[C("Close")])),_:1}),e(v,{class:"ion-margin-end",color:"success",onClick:t.onFinish,slot:"end"},{default:n(()=>a[14]||(a[14]=[C("Save")])),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const Za=ue(Xa,[["render",Ka]]),en=Q({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(t){var B,D;const a=new nt,o=t,s=O(z(o.guardians)),c=F(()=>"".concat(s.value?"Add":"Edit"," Guardian Demographics")),h=F(()=>"".concat(s.value?"Edit":"Add"," Guardian")),r=O([]),u=(D=(B=o.guardians)==null?void 0:B.map(b=>({label:"".concat(b.name," (").concat(b.relationshipType,")"),value:b.name,other:b})))!=null?D:[],v=re({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),I=re({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:b=>$e(b)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:b=>$e(b)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async b=>b.value!=="Unknown"&&It(b)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});ve(()=>v.guardian.value,b=>{var y,S,E,g,w,i,H,X;I.givenName.value=(S=(y=b==null?void 0:b.other)==null?void 0:y.names.given_name)!=null?S:"",I.familyName.value=(g=(E=b==null?void 0:b.other)==null?void 0:E.names.family_name)!=null?g:"",I.cellPhoneNumber.value=(i=(w=b==null?void 0:b.other)==null?void 0:w.phoneNumber)!=null?i:"",I.relation.value=(X=(H=b==null?void 0:b.other)==null?void 0:H.relationshipType)!=null?X:""},{deep:!0,immediate:!0});function _(){s.value=!s.value,v.guardian.value=""}async function m(b){var y,S;await a.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:o.patientId,...b}),await Ze.createRelation(o.patientId,a.getPersonID(),(S=(y=b.relation)==null?void 0:y.value)!=null?S:13)}async function R(b,y){var g,w;const S=y.names.person_id,E={};if(y.names.given_name!==b.given_name&&(E.given_name=b.given_name),y.names.family_name!==b.family_name&&(E.family_name=b.family_name),y.phoneNumber!==b.cell_phone_number&&(E.cell_phone_number=b.cell_phone_number),!z(E)){const i=new nt;i.setPersonID(S),await i.updatePerson(E)}y.relationshipType!==b.relation.label&&await Ze.amendRelation(o.patientId,S,y.id,(w=(g=b.relation)==null?void 0:g.value)!=null?w:13)}const A=async()=>Oe(I,async b=>{!s.value&&!z(v.guardian.value)?await R(b,v.guardian.value.other):await m(b),await U.hide(),q.emit(L.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return ye(async()=>{const b=(await Ze.getRelations()).data;r.value=b.map(y=>({label:y.b_is_to_a,value:y.relationship_type_id,other:y}))}),(b,y)=>{const S=V("ion-title"),E=V("ion-icon"),g=V("ion-button"),w=V("ion-buttons"),i=V("ion-toolbar"),H=V("ion-header"),X=V("ion-content"),te=V("ion-footer");return N(),M(W,null,[e(H,null,{default:n(()=>[e(i,null,{default:n(()=>[e(S,null,{default:n(()=>[C(me(c.value),1)]),_:1}),e(w,{slot:"end"},{default:n(()=>[e(g,{onClick:y[0]||(y[0]=Y=>d(U).hide())},{default:n(()=>[e(E,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(X,{class:"ion-padding"},{default:n(()=>[e(d(se),null,{default:n(()=>[e(d(ne),null,{default:n(()=>[s.value?G("",!0):(N(),$(d(P),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(ie,{modelValue:v.guardian,"onUpdate:modelValue":y[1]||(y[1]=Y=>v.guardian=Y),options:d(u)},null,8,["modelValue","options"])]),_:1})),v.guardian.value||s.value?(N(),M(W,{key:1},[e(d(P),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Se,{modelValue:I.givenName,"onUpdate:modelValue":y[2]||(y[2]=Y=>I.givenName=Y)},null,8,["modelValue"])]),_:1}),e(d(P),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Se,{modelValue:I.familyName,"onUpdate:modelValue":y[3]||(y[3]=Y=>I.familyName=Y)},null,8,["modelValue"])]),_:1}),e(d(P),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Se,{modelValue:I.cellPhoneNumber,"onUpdate:modelValue":y[4]||(y[4]=Y=>I.cellPhoneNumber=Y),allowUnknown:""},null,8,["modelValue"])]),_:1}),e(d(P),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(ie,{modelValue:I.relation,"onUpdate:modelValue":y[5]||(y[5]=Y=>I.relation=Y),options:r.value},null,8,["modelValue","options"])]),_:1})],64)):G("",!0)]),_:1})]),_:1})]),_:1}),e(te,null,{default:n(()=>[e(i,null,{default:n(()=>[d(z)(o.guardians)?G("",!0):(N(),$(g,{key:0,color:"primary",onClick:_,slot:"start"},{default:n(()=>[C(me(h.value),1)]),_:1})),e(g,{color:"primary",onClick:y[6]||(y[6]=Y=>d(U).hide()),slot:"end"},{default:n(()=>y[7]||(y[7]=[C("Close")])),_:1}),e(g,{class:"ion-margin-end",color:"success",onClick:A,slot:"end"},{default:n(()=>y[8]||(y[8]=[C("Save")])),_:1})]),_:1})]),_:1})],64)}}}),tn=Q({components:{IonGrid:se,IonRow:ne,IonCol:P,TextInput:Se},props:{patient:{type:Object,required:!0}},setup(t){const{facility:a}=yt(),o=F(()=>t.patient.getArvNumber()),s=F(()=>!z(o.value)&&o.value!=="Unknown"),c=re({arvNumber:{value:s.value?o.value.split("-")[2]:"",label:"".concat(s.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async u=>{const v=oe(u,"POSITIVE_INTEGERS");if(v!==null)return v;if(u.value===o.value.split("-")[2])return null;const I=await xe.findByOtherID(4,"".concat(a.code,"-ARV-").concat(u.value));return I.ok?z(I.data)?null:["ARV Number already taken"]:[I.errorMessage||I.clientErrorType||"Unable to determine ARV number with status: ".concat(I.httpStatusResponse)]}}});return{form:c,modal:U,arvNumber:o,facility:a,hasValidARVNumber:s,onFinish:async()=>Oe(c,async u=>{u.arvNumber!==o.value.split("-")[2]&&(s.value?await t.patient.updateARVNumber("".concat(a.code,"-ARV-").concat(u.arvNumber)):await t.patient.createArvNumber("".concat(a.code,"-ARV-").concat(u.arvNumber)),q.emit(L.RELOAD_PATIENT_DATA)),await U.hide()}),voidARV:async()=>{if(await De("Are you sure you want to void this ARV Number ".concat(o.value,"?"))){await ge.show("Voiding ARV Number...");try{await Vt.voidARVNumber(o.value),await ge.hide(),await U.hide(),q.emit(L.RELOAD_PATIENT_DATA)}catch(v){await ge.hide(),console.log(v)}}}}}});function an(t,a,o,s,c,h){const r=V("ion-title"),u=V("ion-icon"),v=V("ion-button"),I=V("ion-buttons"),_=V("ion-toolbar"),m=V("ion-header"),R=V("text-input"),A=V("ion-col"),B=V("ion-row"),D=V("ion-grid"),b=V("ion-content"),y=V("ion-footer");return N(),M(W,null,[e(m,null,{default:n(()=>[e(_,null,{default:n(()=>[e(r,null,{default:n(()=>a[3]||(a[3]=[C("ARV NUMBER")])),_:1}),e(I,{slot:"end"},{default:n(()=>[e(v,{onClick:a[0]||(a[0]=S=>t.modal.hide())},{default:n(()=>[e(u,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(b,{class:"ion-padding"},{default:n(()=>[e(D,null,{default:n(()=>[e(B,null,{default:n(()=>[e(A,null,{default:n(()=>[e(R,{modelValue:t.form.arvNumber,"onUpdate:modelValue":a[1]||(a[1]=S=>t.form.arvNumber=S),form:t.form,prefix:"".concat(t.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),e(y,{class:"ion-padding-horizontal"},{default:n(()=>[e(_,null,{default:n(()=>[e(v,{color:"primary",onClick:a[2]||(a[2]=S=>t.modal.hide()),slot:"end"},{default:n(()=>a[4]||(a[4]=[C("Close")])),_:1}),t.hasValidARVNumber?(N(),$(v,{key:0,color:"danger",onClick:t.voidARV,slot:"start"},{default:n(()=>a[5]||(a[5]=[C("Void ARV Number")])),_:1},8,["onClick"])):G("",!0),e(v,{color:"success",onClick:t.onFinish,slot:"end"},{default:n(()=>a[6]||(a[6]=[C("Save")])),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const nn=ue(tn,[["render",an]]),ln=Q({components:{VisitsSummary:qa,InformationHeader:Qa},setup(){const t=Qt(),a=parseInt(t.params.patientId.toString())||0,o=O(),s=O(""),c=O([]),h=F(()=>!z(o.value)),r=async()=>{if(a){const m=(await xe.findByID(a)).data;m&&(o.value=new xe(m))}},u=async()=>{c.value=await va.getGuardianDetails(a)},v=async m=>{await U.show(Za,{patientService:o.value,attribute:m})},I=async()=>{await U.show(en,{patientId:a,guardians:c.value})},_=async()=>{await U.show(nn,{patient:o.value})};return q.on(L.RELOAD_PATIENT_DATA,async()=>{await r()}),q.on(L.RELOAD_GUARDIAN_DATA,async()=>{await u()}),ye(async()=>{var R;await r();const m=await((R=o.value)==null?void 0:R.getARTStartDate());s.value=m?_t.toStandardHisDisplayFormat(m):"N/A",await u()}),{patient:o,artStartDate:s,guardians:c,isReady:h,updateDemographics:v,updateGuardian:I,updateARVNumber:_}}});function on(t,a,o,s,c,h){const r=V("information-header"),u=V("ion-col"),v=V("ion-row"),I=V("visits-summary"),_=V("ion-grid");return t.isReady?(N(),$(_,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[e(v,null,{default:n(()=>[e(u,{size:"12"},{default:n(()=>[t.patient?(N(),$(r,{key:0,patient:t.patient,guardians:t.guardians,artStartDate:t.artStartDate,onUpdateARVNumber:t.updateARVNumber,onUpdateGuardian:t.updateGuardian,onUpdatePatient:t.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):G("",!0)]),_:1})]),_:1}),e(v,null,{default:n(()=>[e(u,null,{default:n(()=>[t.patient?(N(),$(I,{key:0,patient:t.patient,startDate:t.artStartDate},null,8,["patient","startDate"])):G("",!0)]),_:1})]),_:1})]),_:1})):G("",!0)}const Bn=ue(ln,[["render",on]]);export{Bn as default};
