var jt=Object.defineProperty;var Yt=(a,t,l)=>t in a?jt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l;var wt=(a,t,l)=>(Yt(a,typeof t!="symbol"?t+"":t,l),l);import{K as Ie,k as mt,d as ae,r as E,aj as ce,a8 as fe,i as Ve,c as z,e,w as n,u as i,M as J,o as A,v as se,a2 as We,b as k,U as Ee,l as ve,m as oe,n as O,L as Ge,x as ze,aB as st,G as ke,I as Q,am as L,s as $e,aq as he,h as q,_ as _e,N as w,a as ge,j as F,A as G,W as Rt,P as Ne,t as ue,Y as Jt,aF as Qt,aG as Tt,aH as Kt,aI as Xt,aJ as Zt,aK as lt,aL as ea,a7 as ta,aM as aa,p as na,a6 as la,aN as oa,aO as ia,ak as sa,aD as Dt,ar as ra,aP as ua}from"./index-f1e5fa33.js";import{g as da,D as ct,C as Qe,P as Le,O as Je}from"./patient_service-3f8894f0.js";import{g as ot,i as Y}from"./common-abc2f84d.js";import{A as de,u as et,V as ma,C as ca,E as It}from"./consultation_service-f698ac4e.js";import{p as Pt}from"./VoidReason-c552cb66.js";import{a as K,t as pe,d as ee,e as pt,f as pa}from"./his_date-4bcc965c.js";import{_ as be}from"./DateInput.vue_vue_type_style_index_0_lang-06c5da89.js";import{S as me}from"./SelectInput-95bf7c98.js";import{N as ie,R as Te}from"./regimen_service-32a47e6c.js";import{e as Ae}from"./encounter_types-1e88a09d.js";import{s as va,a as Ke,c as fa,u as Nt}from"./arrays-1b521787.js";import{s as Ue,i as Xe,r as rt,a as qe}from"./form-2facde7e.js";import{E as W,a as x}from"./emc_event-4721851b.js";import{a as Ce,t as Be}from"./toasts-d1d3b45b.js";import{D as Ze}from"./Date-32599aab.js";import{D as vt}from"./index-df3a20fe.js";import{l as le}from"./loader-7aea5113.js";import{d as St,r as ye,v as Me,e as ga,f as re,g as At,a as He,b as ba,c as Ot}from"./validations-f17a1dc8.js";import{T as Pe}from"./TextInput-6c31dded.js";import{g as Ct,a as _a,b as ya}from"./location_options-f37138cf.js";import{t as ha,g as Va}from"./DTFormElements-9dbc03af.js";import{Y as De}from"./YesNoInput-3e09f40a.js";import{D as wa}from"./DrilldownTable-83ed38cd.js";import{t as Da,i as Ia}from"./Strs-0c962638.js";import{P as ut,R as it}from"./relations_service-39e4d47f.js";import{r as Na,d as Aa,h as Ra,a as Ta}from"./dde-2fdf22a7.js";import"./patient_identifier_service-6cc21b88.js";import"./vue-datepicker-46e39df1.js";const Pa=a=>{const t=a.given_name,l=a.family_name,u=a.middle_name?a.middle_name:"";return"".concat(t," ").concat(u," ").concat(l)};class Sa{static getRelationships(t){return Ie.getJson("/people/".concat(t,"/relationships")).then(l=>l.data)}static async getGuardianDetails(t){return await this.getRelationships(t).then(l=>l.map(u=>{const m=ot(u,"relation.names[0]");return{id:u.relationship_id,name:m?Pa(m):"",relationshipType:ot(u,"type.b_is_to_a",""),phoneNumber:da(ot(u,"relation.person_attributes",[]),12),names:m}}))}}const Oe=class Oe extends de{constructor(t){super(t,Ae.LAB_ORDERS,K())}async loadConcepts(){Oe.conceptID=await de.getConceptID("HIV Viral Load")}createLabOrder(t,l){const u=Ie.getUsername(),m=mt().facility.name,h=de.getCachedConceptID(l,!0);return Ie.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:u,target_lab:m,reason_for_test_id:h,encounter_id:this.encounterID,tests:[{concept_id:Oe.conceptID}],date:this.date,specimen:{concept_id:t}}]})}createLabResult(t,l,u,m="numeric"){return Ie.postJson("lab/tests/".concat(t,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Oe.conceptID},value:l,value_modifier:u,value_type:m}]})}static getSpecimens(t){return Ie.getJson("/lab/specimen_types",{test_type:t})}static async getOrders(t,l={}){var m;return(m=(await Ie.getJson("/lab/orders",{patient_id:t,...l})).data)!=null?m:[]}static async getViralLoadResultTrail(t,l={}){return(await this.getOrders(t,l)).reduce((m,h)=>(h.tests.forEach(s=>s.result.forEach(d=>m.push({...h,test:s.name,result:"".concat(d.value_modifier," ").concat(d.value),result_date:d.date}))),m),[])}static async getlatestViralLoadResult(t,l={}){const m=(await this.getOrders(t,l)).flatMap(s=>s.tests.flatMap(d=>d.result)).filter(Boolean);if(Y(m))return"N/A";const h=va(m,"date","desc")[0];return"".concat(h.value_modifier).concat(h.value," (").concat(pe(h.date),")")}};wt(Oe,"conceptID",-1);let Se=Oe;const Oa=ae({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=E(!1),u=Ke(["=",">","<",">=","<="]),m=Ke(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),h=E([]),s=t.patient.getBirthdate(),d=ce({orderDate:{value:"",label:"Order Date",required:!0,validation:async b=>ee(b.value).isValid()?new Date(b.value)>new Date(K())?["Order date cannot be in the future"]:new Date(b.value)<new Date(s)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(b,g)=>ee(b.value).isValid()?new Date(b.value)>new Date(K())?["Result date cannot be in the future"]:new Date(b.value)<new Date(g.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function f(){Ue(d,async b=>{const g=new Se(t.patient.getID());if(await g.loadConcepts(),g.setDate(b.orderDate),!await g.createEncounter())throw new Error("Unable to create lab order encounter");const R=await g.createLabOrder(b.specimen.value,b.reason.value);if(!R.ok||!R.data)throw new Error("Unable to save lab orders");const C=new Se(t.patient.getID());if(C.setDate(b.resultDate),!await C.createEncounter())throw new Error("Unable to create lab result encounter");const _=l.value?"LDL":parseInt(b.result),D=l.value?"=":b.modifier.value,P=l.value?"text":"numeric",U=R.data[0].tests[0].id;await C.createLabResult(U,_,D,P),await L.hide(),W.emit(x.RELOAD_LATEST_VL_RESULT),W.emit(x.RELOAD_PATIENT_VISIT_DATA)})}async function V(){if(await he("Are you sure you want to clear all fields?")){l.value=!1;for(const b in d)d[b].value="",d[b].error="";W.emit(x.ON_CLEAR)}}return fe(l,b=>{b&&(d.modifier.value="",d.result.value=void 0,d.modifier.error="",d.result.error=""),d.modifier.disabled=b,d.modifier.required=!b,d.result.disabled=b,d.result.required=!b}),Ve(async()=>{h.value=(await Se.getSpecimens("HIV viral load")).data.map(b=>({label:b.name,value:b.concept_id}))}),(b,g)=>(A(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>[...g[8]||(g[8]=[k("Viral Load Results",-1)])]),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(oe),null,{default:n(()=>[e(i(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(be,{modelValue:d.orderDate,"onUpdate:modelValue":g[0]||(g[0]=T=>d.orderDate=T),form:d,minDate:i(s),maxDate:i(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:d.reason,"onUpdate:modelValue":g[1]||(g[1]=T=>d.reason=T),options:i(m)},null,8,["modelValue","options"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:d.specimen,"onUpdate:modelValue":g[2]||(g[2]=T=>d.specimen=T),options:h.value},null,8,["modelValue","options"])]),_:1}),e(i(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(be,{modelValue:d.resultDate,"onUpdate:modelValue":g[3]||(g[3]=T=>d.resultDate=T),form:d,minDate:d.orderDate.value,"max-date":i(K)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:d.modifier,"onUpdate:modelValue":g[4]||(g[4]=T=>d.modifier=T),options:i(u)},null,8,["modelValue","options"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:d.result,"onUpdate:modelValue":g[5]||(g[5]=T=>d.result=T),form:d,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),e(i(oe),{class:"ion-margin-top"},{default:n(()=>[e(i(O),{size:"12"},{default:n(()=>[e(i(Ge),{class:"ion-padding-vertical bold"},{default:n(()=>[...g[9]||(g[9]=[k(" Other Results Options: ",-1)])]),_:1}),e(i(ze),null,{default:n(()=>[e(i(Ge),null,{default:n(()=>[...g[10]||(g[10]=[k("LDL",-1)])]),_:1}),e(i(st),{slot:"start",modelValue:l.value,"onUpdate:modelValue":g[6]||(g[6]=T=>l.value=T)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:g[7]||(g[7]=T=>i(L).hide()),slot:"end"},{default:n(()=>[...g[11]||(g[11]=[k(" Close ",-1)])]),_:1}),e(i(Q),{color:"warning",onClick:V,slot:"end"},{default:n(()=>[...g[12]||(g[12]=[k(" Reset ",-1)])]),_:1}),e(i(Q),{color:"success",onClick:f,slot:"end"},{default:n(()=>[...g[13]||(g[13]=[k(" Save ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),Ca=ae({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:vt},emits:["voidOutcome"],setup(a,{emit:t}){const l=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:s=>ee(s).format(Ze)},{path:"end_date",label:"End Date",formatter:s=>ee(s).format(Ze)}],u={showSearchField:!1,showSubmitButton:!1};return{rows:q(()=>a.patientStates.map((s,d)=>({...s,index:d}))),columns:l,tableConfig:u,TableRowActions:[{label:"void",color:"danger",action:async s=>{await he("Are you sure you want to void this outcome?")&&t("voidOutcome",{stateId:s.patient_state_id,index:s.index})}}]}}});function Ea(a,t,l,u,m,h){const s=w("data-table");return A(),z(J,null,[t[0]||(t[0]=ge("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1)),e(s,{rows:a.rows,columns:a.columns,config:a.tableConfig,"row-actions-buttons":a.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const ka=_e(Ca,[["render",Ea]]),$a=ae({name:"EnrollmentForm",components:{DateInput:be,IonGrid:ve,IonRow:oe,IonCol:O,IonButton:Q},props:["birthdate","patientId"],setup(a){const t=ce({programId:{label:"Select program",required:!0,value:""},date:{value:"",label:"Date of Enrollment",required:!0,validation:async s=>St(s,a.birthdate)}}),{enrollPatient:l,fetchPatientPrograms:u}=et(a.patientId),m=async()=>{await he("Are you sure you want to clear all fields")&&(t.date.value="",t.date.error="",W.emit(x.ON_CLEAR))};async function h(){await Xe(t)&&le.show(),await l(t.date.value),await Ce("Program enrolled successfully"),await L.hide(),u().catch(console.error)}return{form:t,today:K,onReset:m,enrollProgram:h}}});function Ba(a,t,l,u,m,h){const s=w("DateInput"),d=w("ion-col"),f=w("ion-button"),V=w("ion-row"),b=w("ion-grid");return A(),F(b,null,{default:n(()=>[e(V,null,{default:n(()=>[e(d,{size:"12"},{default:n(()=>[e(s,{modelValue:a.form.date,"onUpdate:modelValue":t[0]||(t[0]=g=>a.form.date=g),form:a.form,minDate:a.birthdate,"max-date":a.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(d,null,{default:n(()=>[e(f,{color:"warning",onClick:a.onReset},{default:n(()=>[...t[1]||(t[1]=[k("Reset",-1)])]),_:1},8,["onClick"]),e(f,{color:"success",onClick:a.enrollProgram},{default:n(()=>[...t[2]||(t[2]=[k("Enroll",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Ua=_e($a,[["render",Ba]]),Fa=ae({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:be,IonGrid:ve,IonRow:oe,IonCol:O,IonButton:Q,SelectInput:me,TextInput:Pe},emits:["saveOutcome"],setup(a,{emit:t}){const l=ee().format("YYYY-MM-DD"),u=ce({date:{value:"",label:"Outcome Date",required:!0,validation:async f=>new Date(f.value)<new Date(a.birthdate)?["Outcome date cannot be before date of birth - ".concat(ee(a.birthdate).format(Ze))]:new Date(f.value)<new Date(a.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(ee(a.dateEnrolled).format(Ze))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(f,V)=>V.status.value.label==="Patient transferred out"&&ye(f)},reason:{value:"",label:"Reason for transfer out",validation:async(f,V)=>V.status.value.label==="Patient transferred out"&&ye(f)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(f,V)=>{var b,g,T,R;return((g=(b=V.status)==null?void 0:b.value)==null?void 0:g.label)==="Patient transferred out"&&((R=(T=V.reason)==null?void 0:T.value)==null?void 0:R.label)==="Other"&&ye(f)}}}),m=q(()=>{var f;return((f=u.status.value)==null?void 0:f.label)==="Patient transferred out"}),h=q(()=>{var f,V;return((V=(f=u.reason)==null?void 0:f.value)==null?void 0:V.label)==="Other"});return{form:u,today:l,isTransferredOut:m,specifyOther:h,onSave:()=>Ue(u,f=>t("saveOutcome",{...f,isTransferredOut:m.value})),onReset:async()=>{if(await he("are you sure you want to clear all fields")){for(const f in u)u[f].value="",u[f].error="";W.emit(x.ON_CLEAR)}},getFacilities:Ct,transferOutReasons:ha}}});function Ma(a,t,l,u,m,h){const s=w("ion-col"),d=w("DateInput"),f=w("SelectInput"),V=w("text-input"),b=w("ion-button"),g=w("ion-row"),T=w("ion-grid");return A(),F(T,null,{default:n(()=>[e(g,null,{default:n(()=>[e(s,{size:"12"},{default:n(()=>[...t[5]||(t[5]=[ge("p",null,"Add New Outcome",-1)])]),_:1}),e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(d,{modelValue:a.form.date,"onUpdate:modelValue":t[0]||(t[0]=R=>a.form.date=R),form:a.form,minDate:a.dateEnrolled,"max-date":a.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(f,{modelValue:a.form.status,"onUpdate:modelValue":t[1]||(t[1]=R=>a.form.status=R),form:a.form,options:a.outcomes},null,8,["modelValue","form","options"])]),_:1}),a.isTransferredOut?(A(),z(J,{key:0},[e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(f,{modelValue:a.form.nextFacility,"onUpdate:modelValue":t[2]||(t[2]=R=>a.form.nextFacility=R),form:a.form,asyncOptions:a.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(f,{modelValue:a.form.reason,"onUpdate:modelValue":t[3]||(t[3]=R=>a.form.reason=R),form:a.form,options:a.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),a.specifyOther?(A(),F(s,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[e(V,{modelValue:a.form.otherReason,"onUpdate:modelValue":t[4]||(t[4]=R=>a.form.otherReason=R),form:a.form},null,8,["modelValue","form"])]),_:1})):G("",!0)],64)):G("",!0),e(s,{size:"12",class:"ion-margin-top"},{default:n(()=>[e(b,{color:"warning",onClick:a.onReset},{default:n(()=>[...t[6]||(t[6]=[k("Reset",-1)])]),_:1},8,["onClick"]),e(b,{color:"success",onClick:a.onSave},{default:n(()=>[...t[7]||(t[7]=[k("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const qa=_e(Fa,[["render",Ma]]),La={class:"ion-page",id:"main"},Ha={class:"ion-margin-start"},Ga=ae({__name:"OutcomeStatus",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=E(),u=q(()=>t.patient.getID()),m=q(()=>{var y,N;return(N=(y=l.value)==null?void 0:y.other)==null?void 0:N.date_enrolled}),h=q(()=>pt(t.patient.getBirthdate())),s=q(()=>{var y;return V.value.get((y=l.value)==null?void 0:y.value)}),d=q(()=>{var y,N,$,M;return(M=($=(N=(y=l.value)==null?void 0:y.other)==null?void 0:N.patient_states)==null?void 0:$.length)!=null?M:0}),{patientPrograms:f,programStates:V,hasArtProgram:b,updateState:g,voidProgram:T,voidState:R,fetchPatientPrograms:C}=et(u.value);function I(y){l.value=y}async function _(y,N,$=""){const M=new de(u.value,Ae.EXIT_FROM_HIV_CARE,N);if(!await M.createEncounter())throw"Unable to transfer out encounter";return $&&await M.saveValueTextObs("Reason for transfer out",$),M.saveValueTextObs("Transfer to",y.name)}async function D(y){var r;const{date:N,status:$,nextFacility:M,reason:j,otherReason:H,isTransferredOut:S}=y;if(S){const xe=j.value!=="Other"?j.value:H;await _(M.other,N,xe)}await g($.value,N,(r=l.value)==null?void 0:r.value),await Ce("Outcome saved successfully",1e3),await L.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}async function P(){var y,N,$;await T(($=(N=(y=l.value)==null?void 0:y.other)==null?void 0:N.patient_program_id)!=null?$:-1,"duplicate / system error"),await Ce("Patient voided from program successfully",1e3),await L.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}async function U({stateId:y,index:N}){var $,M,j;await R(y,"duplicate / system error",($=l.value)==null?void 0:$.value),Ce("Outcome voided successfully"),(j=(M=l.value)==null?void 0:M.other)==null||j.patient_states.splice(N,1),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}async function v(){await L.show(Ua,{birthdate:h.value,patientId:u.value},"custom-modal custom-modal-backdrop")}return Ve(C),(y,N)=>{const $=w("ion-icon"),M=w("ion-buttons");return A(),F(i(Kt),{when:"xs",contentId:"main"},{default:n(()=>[e(i(Jt),{contentId:"main"},{default:n(()=>[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>[...N[0]||(N[0]=[k("Patient Programs",-1)])]),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-no-padding"},{default:n(()=>[e(i(Rt),null,{default:n(()=>[(A(!0),z(J,null,Ne(i(f),j=>{var H;return A(),F(i(ze),{button:"",key:j.value,color:j.value===((H=l.value)==null?void 0:H.value)?"secondary":"light",onClick:S=>I(j)},{default:n(()=>[e(i(Ge),null,{default:n(()=>[k(ue(j.label),1)]),_:2},1024)]),_:2},1032,["color","onClick"])}),128))]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),{class:"ion-padding-start"},{default:n(()=>[l.value?(A(),F(i(Q),{key:0,color:"danger",onClick:P,slot:"start"},{default:n(()=>[...N[1]||(N[1]=[k("Void Program",-1)])]),_:1})):G("",!0),i(b)?G("",!0):(A(),F(i(Q),{key:1,onClick:v,slot:"start"},{default:n(()=>[...N[2]||(N[2]=[k("Enroll HIV Program",-1)])]),_:1}))]),_:1})]),_:1})]),_:1}),ge("div",La,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(M,{slot:"end"},{default:n(()=>[e(i(Q),{onClick:i(L).hide,color:"danger",size:"large"},{default:n(()=>[e($,{size:"large",icon:i(Qt)},null,8,["icon"])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[l.value?(A(),F(i(ve),{key:0,style:{width:"100%"}},{default:n(()=>[e(i(oe),{class:"his-card",style:Tt({minHeight:d.value?"0":"30vh"})},{default:n(()=>[e(i(O),{size:"12",class:"ion-no-padding"},{default:n(()=>{var j,H,S;return[ge("h5",Ha," Enrollment Date: "+ue(m.value?i(pe)(m.value):"Unknown"),1),e(ka,{patientStates:(S=(H=(j=l.value)==null?void 0:j.other)==null?void 0:H.patient_states)!=null?S:[],onVoidOutcome:U},null,8,["patientStates"])]}),_:1})]),_:1},8,["style"]),s.value?(A(),F(i(oe),{key:0,class:"his-card ion-margin-top",style:{"margin-bottom":"0.4rem"}},{default:n(()=>[e(qa,{"date-enrolled":m.value,birthdate:h.value,outcomes:s.value,onSaveOutcome:D},null,8,["date-enrolled","birthdate","outcomes"])]),_:1})):G("",!0)]),_:1})):G("",!0)]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{slot:"end",color:"warning"},{default:n(()=>[...N[3]||(N[3]=[k(" Reset ",-1)])]),_:1}),e(i(Q),{slot:"end",color:"primary"},{default:n(()=>[...N[4]||(N[4]=[k(" Submit ",-1)])]),_:1})]),_:1})]),_:1})])]),_:1})}}}),za=ae({name:"MultiColumnView",components:{IonGrid:ve,IonRow:oe,IonCol:O},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(a){const t={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:q(()=>fa(a.items,Math.ceil(a.items.length/a.numberOfColumns))),grid:t}}});function Wa(a,t,l,u,m,h){const s=w("ion-col"),d=w("ion-row"),f=w("ion-grid");return A(),F(f,null,{default:n(()=>[e(d,null,{default:n(()=>[(A(!0),z(J,null,Ne(a.computedItems,(V,b)=>(A(),F(s,{key:b,size:a.grid[a.numberOfColumns]},{default:n(()=>[Xt(a.$slots,"default",{entries:V})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const dt=_e(za,[["render",Wa]]);class xa extends de{constructor(t,l=K()){super(t,Ae.HIV_RECEPTION,l)}}class Et extends de{constructor(t,l=K()){super(t,Ae.ART_ADHERENCE,l)}buildPillCountObs(t,l){return this.buildValueNumber("Number of tablets brought to clinic",l,null,t)}async buildAdherenceObs(t,l,u){return{concept_id:await de.getConceptID("Drug adherence",!0),value_numeric:u,value_drug:l,value_modifier:"%",order_id:t,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(t,l,u){return Math.round(100*(t-l)/(t-u))}calculateExpected(t,l,u,m){const h=m==="QW"?"week":"day",s=this.calcTimeElapsed(u,h);return t-s*parseFloat(l.toString())}calcTimeElapsed(t,l){return ee(this.date).diff(t,l)+1}}class ja extends de{constructor(t,l=K()){super(t,Ae.APPOINTMENT,l)}}class Ya extends de{constructor(t,l=K()){super(t,Ae.TREATMENT,l)}calculateDosage(t,l){let u=0;return l===0&&(u=t),t==0&&(u=l),t>0&&l>0&&(u=(t+l)/2),u}calculateEquivalentDosage(t,l){return t+l}calculateDrugRunOutDate(t,l){return pt(ee(l).add(t,"days"))}getInstructions(t,l,u,m){return"".concat(t," :- Morning: ").concat(l," ").concat(m,", Evening: ").concat(u," ").concat(m)}toDrugOrder(t,l,u,m){return{drug_inventory_id:t.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(t.am,t.pm),start_date:m,auto_expire_date:this.calculateDrugRunOutDate(u,m),units:t.units,instructions:this.getInstructions(t.drug_name,t.am,t.pm,t.units),dose:this.calculateDosage(t.am,t.pm),frequency:t.frequency,qty:l}}async createDrugOrder(t){return ct.create({encounter_id:this.encounterID,drug_orders:t})}}class Ja{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(t,l,u){let m={result:"",color:"",index:u};if(u<=0)return m.index=0,m;if(l<5&&l>0)m.result="Use MUAC to calculate nutrition status",m.color="red";else{l>18&&(l=19);const h=await this.getBMIData(),s=h[t][l];s&&(m=this.buildBounds(Object.keys(s),s,u,h.colors))}return m}static buildBounds(t,l,u,m){const h={result:"",color:"",index:u};return t.forEach(s=>{if(s.indexOf("-")>=0){const d=s.split("-");u>=parseFloat(d[0])&&u<=parseFloat(d[1])&&(h.result=l[s],h.color=m[l[s]])}else if(s.indexOf("<")>=0){const d=s.replace("<","");u<parseFloat(d)&&(h.result=l[s],h.color=m[l[s]])}else if(s.indexOf(">=")>=0){const d=s.replace(">=","");u>=parseFloat(d)&&(h.result=l[s],h.color=m[l[s]])}}),h}static getBMI(t,l,u,m){const h=this.calculateBMI(t,l);return this.getBMIResult(u,m,h)}static calculateBMI(t,l){if(l==0||t==0)return 0;let u=t/l/l*1e4;return u=Math.round(u*10)/10}}class Qa extends de{constructor(t,l=K()){super(t,Ae.DISPENSING,l)}buildDispensations(t,l,u){const m=[];for(let h=0;h<u;h++)m.push({drug_order_id:t,date:this.date,quantity:l/u});return m}saveDispensations(t){return Ie.postJson("/dispensations",{dispensations:t,program_id:this.programID})}}const Ka=ae({__name:"PatientVisit",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=q(()=>t.patient.getID()),u=new ma(l.value),m=new ca(l.value),h=new Ya(l.value),s=new Qa(l.value),d=new xa(l.value),f=new Et(l.value),V=new ja(l.value),b=E(),g=E(),T=E([]),R=E([]),C=E([]),I=E([]),_=q(()=>t.patient.isFemale()),D=E(""),P=t.patient.getBirthdate(),U=E(!1),v=ce({}),y=q(()=>!(b.value&&t.patient.getAge()>18)),{isDICSite:N,refreshDICStatus:$}=mt(),{enrollPatient:M,fetchPatientPrograms:j,hasProgram:H,updateState:S}=et(l.value),r=ce({visitDate:{value:ee().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async o=>new Date(o.value)>new Date(K())?["Visit date cannot be after today's date"]:St(o,P)},weight:{value:void 0,label:"Weight",required:!0,computedValue:o=>({tag:"vitals",obs:u.buildValueNumber("Weight",o)}),validation:(o,c)=>(Y(o)||!o.value)&&c.patientPresent.value==="No"?null:Me([()=>ye(o),()=>re(o,"DECIMALS"),()=>At(o,2,250)])},bp:{value:"",label:"Blood Pressure (mmHG)",placeholder:"Enter Blood Pressure e.g 120/80",validation:o=>Y(o)||!o.value?null:ga(o),computedValue:o=>{if(Y(o))return null;const[c,p]=o.split("/").map(Number);return{tag:"vitals",obs:[u.buildValueNumber("Systolic",c),u.buildValueNumber("Diastolic",p)]}}},height:{value:void 0,label:"Height (cm)",computedValue:o=>({tag:"vitals",obs:u.buildValueNumber("Height",o)}),validation:o=>!y.value||(Y(o)||!o.value)&&r.patientPresent.value==="No"?null:Me([()=>ye(o),()=>re(o),()=>At(o,20,220)])},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:_.value,computedValue:o=>({tag:"consultation",obs:m.buildValueCoded("Is patient pregnant",o)}),validation:async o=>_.value&&ye(o)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:_.value,computedValue:o=>({tag:"consultation",obs:m.buildValueCoded("Is patient breast feeding",o)}),validation:async o=>_.value&&ye(o)},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:o=>({tag:"appointment",obs:V.buildValueDate("Appointment date",o)}),validation:async(o,c)=>new Date(o.value)<new Date(c.visitDate.value)?["Appointment date cannot be before visit date"]:new Date(o.value)>new Date(D.value)?["Appointment date cannot be after drug run out date"]:null},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:o=>({tag:"reception",obs:d.buildValueCoded("Patient present",o)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:o=>({tag:"reception",obs:d.buildValueCoded("Guardian present",o)})},pillCount:{value:void 0,label:"Pill Count",required:I.value.length>0,validation:async o=>I.value.length>0&&re(o)},regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","INH")}),validation:async(o,c)=>{var p,B;return(((p=c.tbMed.value)==null?void 0:p.label)==="6H"||((B=c.tbMed.value)==null?void 0:B.label)==="3HP (RFP + INH)")&&re(o)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(o,c)=>{var p;return((p=c.tbMed.value)==null?void 0:p.label)==="3HP (RFP + INH)"&&re(o)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(o,c)=>{var p;return((p=c.tbMed.value)==null?void 0:p.label)==="3HP (INH 300 / RFP 300)"&&re(o)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(o,c)=>{var p;return((p=c.tbMed.value)==null?void 0:p.label)&&re(o)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async o=>Me([()=>ye(o),()=>o.value==="No"||R.value.some(c=>c.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async o=>Me([()=>ye(o),()=>o.value==="No"||C.value.some(c=>c.isChecked)?null:["Please select at least one side effect"]])},tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:o=>({tag:"consultation",obs:m.buildValueCoded("TB Status",o.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async o=>{if(!U.value){if(new Date(o.value)>new Date(K()))return["TB treatment start date cannot be after today's date"];if(new Date(o.value)<new Date(P))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:o=>({tag:"consultation",obs:m.buildValueDate("TB treatment start date",o)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:o=>({tag:"consultation",obs:m.buildValueNumber("TB treatment period",o)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:o=>({tag:"consultation",obs:m.buildGroupValueCoded("TB screening method used","chest xray",o)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:o=>({tag:"consultation",obs:m.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",o)})}});fe(()=>r.regimen.value,o=>{var c;nt(),o&&((c=o==null?void 0:o.other)==null||c.forEach(p=>{var B;v[p.drug_name]={label:"".concat((B=p.alternative_drug_name)!=null?B:p.drug_name," given"),value:0,required:!0,validation:X=>Me([()=>re(X,"POSITIVE_INTEGERS"),()=>Number(X.value)%30!==0?["Quantity should be in multiples of 30"]:null])}}))}),fe(r.patientPresent,o=>{o.value==="No"?(r.weight.required=!1,r.weight.error="",r.guardianPresent.value="Yes"):r.weight.required=!0}),fe(r.guardianPresent,o=>{o.value==="No"&&(r.patientPresent.value="Yes")}),fe([()=>r.weight.value,()=>r.tbStatus.value],async([o,c])=>{var B;r.regimen.value=void 0,nt();const p=/confirmed/i.test((B=c==null?void 0:c.label)!=null?B:"");o?(T.value=await Te.getRegimensByWeight(r.weight.value,p),r.patientPresent.value="Yes",r.patientPresent.disabled=!0):!o&&r.weight.required&&(r.patientPresent.value=void 0,r.patientPresent.disabled=!1),r.tbMed.disabled=p}),fe(()=>r.nextAppointmentDate.value,async o=>{ee(D.value).diff(ee(o),"days")>7&&await he("Appointment date is more than 7 days earlier than drug run out date. The client will have excess medication",{header:"Drug Dispensation Alert",icon:Zt,confirmBtnLabel:"OK",showCancelBtn:!1,color:"danger"})});const xe=()=>{var o,c;return Y(v)?1/0:Math.min(...((c=(o=r.regimen.value)==null?void 0:o.other)!=null?c:[]).map(p=>{var B,X,we,je,Ye;return((X=(B=v[p.drug_name])==null?void 0:B.value)!=null?X:0)/(((we=p.am)!=null?we:0)+((je=p.noon)!=null?je:0)+((Ye=p.pm)!=null?Ye:0))||1}))};fe([()=>v,()=>r.pillCount.value,()=>r.visitDate.value],()=>{const o=parseInt(r.pillCount.value)||0,c=xe();if(c!==1/0){D.value=h.calculateDrugRunOutDate(c+o,r.visitDate.value),r.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(pe(D.value),")");const p=ee(D.value).subtract(2,"day"),B=p.day();let X;B===0?X=p.subtract(2,"day"):B===6?X=p.subtract(1,"day"):X=p,r.nextAppointmentDate.value=pt(X)}},{deep:!0}),fe(()=>r.visitDate.value,()=>gt());const tt=q(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (INH 300 / RFP 300)"}),Fe=q(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (RFP + INH)"}),at=q(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="6H"}),kt=q(()=>r.hasContraindications.value==="Yes"),ft=q(()=>r.hasSideEffects.value==="Yes"),$t=q(()=>{var o;return/Confirmed TB on treatment/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),Bt=q(()=>{var o;return/Suspected/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),Ut=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Ft=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Mt=Ke(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),qt=Ke(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),gt=async()=>{m.setDate(r.visitDate.value),U.value=!1;const o=await m.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(o)){const c=await m.getFirstValueDatetime("TB treatment start date"),p=(await m.getFirstValueNumber("TB treatment period")||6)*30;if(c){const B=ee(r.visitDate.value).diff(c,"days");U.value=B<=p}}r.tbStatus.required=!U.value},Lt=async o=>{const c=o.height||b.value,p=Ja.calculateBMI(o.weight,c);return u.buildValueNumber("BMI",p)},Ht=async()=>{const o=[await m.buildValueCoded("Patient using family planning","No")];return m.getFamilyPlanningMethods().forEach(async p=>{o.push(await m.buildValueCoded(p,"No"))}),o},Gt=async()=>Promise.all(Qe.getConceptsByCategory("tb_symptom",!0).map(async o=>m.buildGroupValueCoded(o.name,o.name,"No")));async function zt(){u.setDate(r.visitDate.value),m.setDate(r.visitDate.value),h.setDate(r.visitDate.value),d.setDate(r.visitDate.value),f.setDate(r.visitDate.value),V.setDate(r.visitDate.value),s.setDate(r.visitDate.value),await Ue(r,async(o,c)=>{var bt,_t,yt,ht,Vt;const p=[];let B=0;if(!Y(o.regimen)&&await Xe(v)){const ne=o.regimen.other,te=rt(v).formData;B=xe(),ne.forEach(Z=>p.push(h.toDrugOrder(Z,te[Z.drug_name],B,o.visitDate)))}else if(!await he("Are you sure you want to continue without dispensing ART drugs?"))return;if(le.show("Saving patient visit..."),o.totalCPTGiven&&Nt((await Te.getRegimenExtras("Cotrimoxazole",(bt=o.weight)!=null?bt:g.value)).data,"concept_name").filter(ne=>ne.frequency==="Daily (QOD)").forEach(ne=>p.push(h.toDrugOrder(ne,o.totalCPTGiven,B,o.visitDate))),(_t=o.tbMed)!=null&&_t.value){const ne=Nt((await Te.getRegimenExtras("INH",(yt=o.weight)!=null?yt:g.value)).data,["concept_name","frequency"]),te=ne.find(Z=>Z.concept_name==="Pyridoxine");if(te&&o.totalPyridoxineGiven&&p.push(h.toDrugOrder(te,o.totalPyridoxineGiven,B,o.visitDate)),o.totalIPTGiven){const Z=ne.find(Re=>Re.concept_name==="Isoniazid"&&(at.value&&Re.frequency==="Daily (QOD)"||Fe.value&&Re.frequency==="Weekly (QW)"));p.push(h.toDrugOrder(Z,o.totalIPTGiven,B,o.visitDate))}if(o.totalRFPGiven&&Fe.value){const Z=(await Te.getRegimenExtras("Rifapentine",(ht=o.weight)!=null?ht:g.value)).data;Z.length&&p.push(h.toDrugOrder(Z[0],o.totalRFPGiven,B,o.visitDate))}if(o.total3HPGiven&&tt.value){const Z=(await Te.getRegimenExtras("INH / RFP",(Vt=o.weight)!=null?Vt:g.value)).data;p.push(h.toDrugOrder(Z[0],o.total3HPGiven,B,o.visitDate))}}if(!Y(p)){await h.createEncounter();const te=(await h.createDrugOrder(p)).data.map(Z=>{const Re=p.find(xt=>xt.drug_inventory_id===Z.drug_inventory_id);return s.buildDispensations(Z.order_id,Re.qty,1)});await s.saveDispensations(te.flat(1))}const X=await qe(c,"vitals");if(!Y(X)){await u.createEncounter();const ne=await Lt(o);await u.saveObservationList([...X,ne])}await m.createEncounter();const we=await qe(c,"consultation");we.push(...await m.buildOptionsGroupObs("Malawi ART side effects",R.value)),we.push(...await Gt()),ft.value&&we.push(...await m.buildOptionsGroupObs("Other side effect",C.value)),_.value&&we.push(...await Ht()),await m.saveObservationList(we),await d.createEncounter();const je=await qe(c,"reception");if(await d.saveObservationList(je),I.value.length>0){await f.createEncounter();const ne=await Promise.all(I.value.map(async te=>{const Z=f.calculateExpected(te.quantity,te.equivalent_daily_dose,te.order.start_date,te.frequency),Re=f.calculateAdherence(te.quantity,o.pillCount,Z);return[await f.buildAdherenceObs(te.order_id,te.drug_inventory_id,Re),await f.buildPillCountObs(te.order_id,o.pillCount)]}));await f.saveObservationList(ne.flat(1))}await V.createEncounter();const Ye=await qe(c,"appointment");await V.saveObservationList(Ye),await Ce("Patient visit saved successfully"),N.value&&!H(lt)&&(await M(o.visitDate,lt),await S(ea,o.visitDate,lt)),await L.hide(),le.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA),W.emit(x.RELOAD_STAGING_INFORMATION)},{showloader:!1})}const Wt=async()=>{if(await he("Are you sure you want to clear all fields?")){for(const o in r)r[o].value="",r[o].error="",r[o].disabled=!1;nt(),W.emit(x.ON_CLEAR)}},nt=()=>{for(const o in v)delete v[o]};return Ve(async()=>{try{await gt(),b.value=await t.patient.getRecentHeight(),g.value=await t.patient.getRecentWeight(),g.value&&(T.value=await Te.getRegimensByWeight(g.value)),I.value=await ct.getLastDrugsReceived(t.patient.getID()),r.pillCount.required=I.value.length>0,R.value=Qe.getConceptsByCategory("contraindication",!0).map(o=>({value:o.concept_id,label:o.name,other:o})),C.value=Qe.getConceptsByCategory("side_effect",!0).map(o=>({value:o.concept_id,label:o.name,other:o}))}catch(o){Be("Form initialization failed. Try to refresh the page"),console.error(o)}$().catch(console.error),j().catch(console.error)}),(o,c)=>(A(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>[...c[25]||(c[25]=[k("Patient Visit",-1)])]),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(oe),null,{default:n(()=>[e(i(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(be,{modelValue:r.visitDate,"onUpdate:modelValue":c[0]||(c[0]=p=>r.visitDate=p),form:r,minDate:i(P),maxDate:i(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(De,{modelValue:r.patientPresent,"onUpdate:modelValue":c[1]||(c[1]=p=>r.patientPresent=p),inline:"",disabled:r.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(De,{modelValue:r.guardianPresent,"onUpdate:modelValue":c[2]||(c[2]=p=>r.guardianPresent=p),inline:""},null,8,["modelValue"])]),_:1}),_.value?(A(),z(J,{key:0},[e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(De,{modelValue:r.isPregnant,"onUpdate:modelValue":c[3]||(c[3]=p=>r.isPregnant=p),inline:""},null,8,["modelValue"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(De,{modelValue:r.isBreastfeeding,"onUpdate:modelValue":c[4]||(c[4]=p=>r.isBreastfeeding=p),inline:""},null,8,["modelValue"])]),_:1})],64)):G("",!0),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(De,{modelValue:r.hasContraindications,"onUpdate:modelValue":c[5]||(c[5]=p=>r.hasContraindications=p),inline:""},null,8,["modelValue"]),kt.value?(A(),F(dt,{key:0,items:R.value,numberOfColumns:2},{default:n(({entries:p})=>[(A(!0),z(J,null,Ne(p,B=>(A(),F(i(ze),{lines:"none",key:B.value},{default:n(()=>[e(i(Ge),null,{default:n(()=>[k(ue(B.label),1)]),_:2},1024),e(i(st),{slot:"start",modelValue:B.isChecked,"onUpdate:modelValue":X=>B.isChecked=X},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1}),e(i(O),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[e(De,{modelValue:r.hasSideEffects,"onUpdate:modelValue":c[6]||(c[6]=p=>r.hasSideEffects=p),inline:""},null,8,["modelValue"]),ft.value?(A(),F(dt,{key:0,items:C.value,numberOfColumns:2},{default:n(({entries:p})=>[(A(!0),z(J,null,Ne(p,B=>(A(),F(i(ze),{lines:"none",key:B.value},{default:n(()=>[e(i(Ge),null,{default:n(()=>[k(ue(B.label),1)]),_:2},1024),e(i(st),{slot:"start",modelValue:B.isChecked,"onUpdate:modelValue":X=>B.isChecked=X},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.weight,"onUpdate:modelValue":c[7]||(c[7]=p=>r.weight=p),form:r,min:1},null,8,["modelValue","form"])]),_:1}),y.value?(A(),F(i(O),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.height,"onUpdate:modelValue":c[8]||(c[8]=p=>r.height=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Pe,{modelValue:r.bp,"onUpdate:modelValue":c[9]||(c[9]=p=>r.bp=p),form:r},null,8,["modelValue","form"])]),_:1}),e(i(O),{class:"ion-margin-vertical",size:y.value?"6":"12"},{default:n(()=>[e(me,{modelValue:r.tbStatus,"onUpdate:modelValue":c[10]||(c[10]=p=>r.tbStatus=p),options:i(qt)},null,8,["modelValue","options"])]),_:1},8,["size"]),$t.value&&!U.value?(A(),z(J,{key:2},[e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(be,{modelValue:r.tbTreatmentStartDate,"onUpdate:modelValue":c[11]||(c[11]=p=>r.tbTreatmentStartDate=p),form:r,minDate:i(P),maxDate:i(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.tbTreatmentPeriod,"onUpdate:modelValue":c[12]||(c[12]=p=>r.tbTreatmentPeriod=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})],64)):Bt.value?(A(),z(J,{key:3},[e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(De,{modelValue:r.cxrResult,"onUpdate:modelValue":c[13]||(c[13]=p=>r.cxrResult=p),"custom-options":Ut},null,8,["modelValue"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(De,{modelValue:r.mwrdResult,"onUpdate:modelValue":c[14]||(c[14]=p=>r.mwrdResult=p),"custom-options":Ft},null,8,["modelValue"])]),_:1})],64)):G("",!0),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:r.regimen,"onUpdate:modelValue":c[15]||(c[15]=p=>r.regimen=p),options:T.value},null,8,["modelValue","options"])]),_:1}),i(Y)(v)?G("",!0):(A(!0),z(J,{key:4},Ne(Object.values(v),(p,B)=>(A(),F(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{"model-value":p,form:v,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.totalCPTGiven,"onUpdate:modelValue":c[16]||(c[16]=p=>r.totalCPTGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:r.tbMed,"onUpdate:modelValue":c[17]||(c[17]=p=>r.tbMed=p),options:i(Mt)},null,8,["modelValue","options"])]),_:1}),at.value||Fe.value?(A(),F(i(O),{key:5,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.totalIPTGiven,"onUpdate:modelValue":c[18]||(c[18]=p=>r.totalIPTGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),Fe.value?(A(),F(i(O),{key:6,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.totalRFPGiven,"onUpdate:modelValue":c[19]||(c[19]=p=>r.totalRFPGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),tt.value?(A(),F(i(O),{key:7,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.total3HPGiven,"onUpdate:modelValue":c[20]||(c[20]=p=>r.total3HPGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),tt.value||Fe.value||at.value?(A(),F(i(O),{key:8,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.totalPyridoxineGiven,"onUpdate:modelValue":c[21]||(c[21]=p=>r.totalPyridoxineGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),I.value.length>0?(A(),F(i(O),{key:9,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.pillCount,"onUpdate:modelValue":c[22]||(c[22]=p=>r.pillCount=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e(i(O),{size:I.value.length>0?"6":"12",class:"ion-margin-vertical"},{default:n(()=>[e(be,{modelValue:r.nextAppointmentDate,"onUpdate:modelValue":c[23]||(c[23]=p=>r.nextAppointmentDate=p),form:r,minDate:r.visitDate.value,maxDate:D.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1},8,["size"])]),_:1})]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:c[24]||(c[24]=p=>i(L).hide()),slot:"end"},{default:n(()=>[...c[26]||(c[26]=[k(" Close ",-1)])]),_:1}),e(i(Q),{color:"warning",onClick:Wt,slot:"end"},{default:n(()=>[...c[27]||(c[27]=[k(" Reset ",-1)])]),_:1}),e(i(Q),{color:"success",onClick:zt,slot:"end"},{default:n(()=>[...c[28]||(c[28]=[k(" Save ",-1)])]),_:1})]),_:1})]),_:1})],64))}});const Xa=_e(Ka,[["__scopeId","data-v-1fc2510f"]]),Za=ae({__name:"EmergencyRefill",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=q(()=>t.patient.getID()),u=new Et(l.value),m=E(),h=E([]),s=E([]),d=q(()=>{var v;return(v=s.value[0])==null?void 0:v.order.start_date}),f=E(""),V=t.patient.getBirthdate(),b=E({}),g=ce({date:{value:K(),label:"Date of emergency refill",required:!0,computedValue:v=>({obs:u.buildValueDate("Prescription refill date",v)})},facility:{value:void 0,label:"Facility where emergency refill was collected",required:!0,placeholder:"Select a facility",computedValue:v=>({obs:u.buildValueText("Health facility name",v.label)})},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:v=>({obs:u.buildValueDate("Appointment date",v)})}});async function T(v,y,N){const $=u.calculateExpected(v.quantity,v.equivalent_daily_dose,v.order.start_date,v.frequency),M=u.calculateAdherence(v.quantity,N,$);return{...await u.buildValueCoded("Medications dispensed",v.drug.concept_id),child:[await u.buildAdherenceObs(v.order_id,v.drug_inventory_id,M),await u.buildPillCountObs(v.order_id,N),,await u.buildValueNumber("Amount of drug dispensed",y)]}}async function R(){if(await he("Are you sure you want to clear all fields?")){for(const v in g)g[v].value="",g[v].error="",g[v].disabled=!1;C(),W.emit(x.ON_CLEAR)}}function C(){for(const v in b.value)delete b.value[v]}function I(v){return v.regimen?"".concat(v.regimen," - ").concat(v.drug.name):v.drug.name}function _(){return Y(s.value)?1/0:Math.min(...s.value.map(v=>{var j,H,S,r;const y=I(v),N=Number((H=(j=b.value["".concat(y,"_given")])==null?void 0:j.value)!=null?H:0),$=Number((r=(S=b.value["".concat(y,"_brought")])==null?void 0:S.value)!=null?r:0),M=Number(v.equivalent_daily_dose);return(N+$)/M}))}function D(){const v=_();v!==1/0&&(f.value=pa(g.date.value,v,"days"),g.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(pe(f.value),")"),g.nextAppointmentDate.value=f.value)}async function P(){if(await Xe(g)&&await Xe(b.value))try{le.show(),u.setDate(g.date.value);const v=await qe({...rt(g).computedFormData,...rt(b.value).computedFormData}),y=new de(l.value,Ae.EMERGENCY_DRUG_REFILL,g.date.value);await y.createEncounter(),await y.saveObservationList(v),Ce("Emergency refill saved successfully"),L.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA),W.emit(x.RELOAD_STAGING_INFORMATION)}catch(v){console.error(v),Be("Failed to save emergency refill")}finally{le.hide()}}function U(){s.value.forEach(v=>{const y=I(v);b.value["".concat(y,"_brought")]={label:"".concat(y," brought"),value:void 0,required:!0,placeholder:"Enter the number of pills brought",validation:N=>re(N,"POSITIVE_INTEGERS")},b.value["".concat(y,"_given")]={label:"".concat(y," given"),value:void 0,required:!0,placeholder:"Enter the number of pills given",validation:N=>re(N,"POSITIVE_INTEGERS"),computedValue:(N,$)=>T(v,N,$["".concat(y,"_brought")].value)}})}return fe([()=>b,()=>g.date.value],D,{deep:!0,immediate:!0}),Ve(async()=>{try{le.show(),m.value=await t.patient.getRecentWeight(),h.value=await Te.getRegimensByWeight(m.value),s.value=await ct.getLastDrugsReceived(l.value),U()}catch(v){Be("Form initialization failed. Try to refresh the page"),console.error(v)}finally{le.hide()}}),(v,y)=>(A(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>[...y[4]||(y[4]=[k("Emergency Drug Refill",-1)])]),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(oe),null,{default:n(()=>[e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(be,{modelValue:g.date,"onUpdate:modelValue":y[0]||(y[0]=N=>g.date=N),form:g,minDate:d.value||i(V),maxDate:i(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:g.facility,"onUpdate:modelValue":y[1]||(y[1]=N=>g.facility=N),form:g,asyncOptions:i(Ct)},null,8,["modelValue","form","asyncOptions"])]),_:1}),(A(!0),z(J,null,Ne(Object.values(b.value),N=>(A(),F(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{"model-value":N,form:b.value,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(be,{modelValue:g.nextAppointmentDate,"onUpdate:modelValue":y[2]||(y[2]=N=>g.nextAppointmentDate=N),form:g,minDate:g.date.value,maxDate:f.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1})]),_:1})]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:y[3]||(y[3]=N=>i(L).hide()),slot:"end"},{default:n(()=>[...y[5]||(y[5]=[k(" Close ",-1)])]),_:1}),e(i(Q),{color:"warning",onClick:R,slot:"end"},{default:n(()=>[...y[6]||(y[6]=[k(" Reset ",-1)])]),_:1}),e(i(Q),{color:"success",onClick:P,slot:"end"},{default:n(()=>[...y[7]||(y[7]=[k(" Save ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),en=ae({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:vt,IonCard:ta,IonCardHeader:aa,IonCardTitle:na,IonCardContent:la,IonButton:Q},setup(a){const t=E([]),l=q(()=>a.patient.getID()),u=ce({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),m=E([{label:"Add Visit",action:async()=>{await L.show(Xa,{patient:a.patient})}},{label:"Emegency Refill",action:async()=>{await L.show(Za,{patient:a.patient})}},{label:"Update Outcome",action:async()=>L.show(Ga,{patient:a.patient})},{label:"Enter VL Results",action:async()=>L.show(Oa,{patient:a.patient})}]),h=I=>{const _=a.startDate!=="N/A"?"("+ee(I).diff(a.startDate,"months")+"M)":"";return"".concat(pe(I)," ").concat(_)},s={minWidth:"68px !important"},d=E([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:s},{path:"vitals",label:"Vitals",sortable:!1,thStyles:s},...a.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:s},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:s}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:I=>I.length>0?"Yes":"No",sortable:!1,thStyles:s},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:s},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:s},{path:"vlResult",label:"Viral Load",sortable:!1}]),f=I=>({title:"Side effects noted on ".concat(I.row.visitDate),rows:I.row.sideEffects.map(_=>({sideEffect:_})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),V=I=>({title:"Drugs dispensed on ".concat(I.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:I.row.drugs.map(_=>({name:_[0],quantity:_[1],units:"tab (s)"}))}),b=async I=>{const _=/regimen/i.test(I.column.path)?V(I):f(I);Y(_.rows)||await L.show(wa,_)},g=[{label:"void",icon:oa,color:"danger",action(I,_){Pt(async D=>{var U;const P=await It.getEncounters(l.value,{date:I.date});P.ok?((U=P.data)==null||U.forEach(async v=>{await It.voidEncounter(v.encounter_id,D)}),t.value.splice(_,1)):Be(P.errorMessage||"Failed to void encounters")},"small-modal")}}],T=async I=>I.tb_status.match(/Unknown/i)||I.outcome==="Defaulted"?"":Qe.getCachedConceptName(I.tb_status),R=I=>{const _=I.weight?"Wt: ".concat(I.weight,"kg"):"",D=I.height?"Ht: ".concat(I.height,"cm"):"",P=I.bmi?"BMI: ".concat(I.bmi):"",U=I.bp?"BP: ".concat(I.bp):"";return[_,D,P,U].filter(Boolean).join(", ")},C=()=>{const{getProgramInfo:I}=et(l.value);Le.getPatientVisits(l.value,!0).then(async _=>{t.value=[];for(const D of _){const P=await I(D);let U="",v="",y="",N="";if(P.outcome!=="Defaulted"){const $=await Je.getFirstValueDatetime(l.value,"appointment date",D);if($&&(U=pe($)),v=await Je.getFirstValueCoded(l.value,"Is patient pregnant",D),y=await Je.getFirstValueCoded(l.value,"Is patient breast feeding",D),P.viral_load==="N/A"){const M=await Je.getFirstObs(l.value,"HIV viral load",D);M&&M.value_text&&M.value_numeric&&(N=M.value_numeric===1?"LDL":M.value_text+M.value_numeric.toString())}else N=P.viral_load}P&&t.value.push({visitDate:h(D),visitBy:P.visit_by.match(/Unk/i)?"":P.visit_by,vitals:R(P),pregnant:v,breastfeeding:y,tbStatus:await T(P),sideEffects:P.outcome==="Defaulted"?"":P.side_effects,regimen:P.outcome==="Defaulted"?"":P.regimen,nextAppointment:U,outcome:P.outcome.match(/Unk/i)?"":P.outcome,vlResult:N,drugs:P.pills_dispensed,date:D})}})};return W.on(x.RELOAD_PATIENT_VISIT_DATA,()=>C()),Ve(()=>{C()}),{actionButtons:m,tableConfig:u,rowButtons:g,columns:d,rows:t,onDrilldownHandler:b}}});const tn={class:"ion-float-right ion-margin-end ion-margin-bottom"};function an(a,t,l,u,m,h){const s=w("ion-icon"),d=w("ion-button"),f=w("ion-card-title"),V=w("ion-card-header"),b=w("data-table"),g=w("ion-card-content"),T=w("ion-card");return A(),F(T,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[e(V,null,{default:n(()=>[e(f,null,{default:n(()=>[t[0]||(t[0]=ge("span",{class:"title"},"Summary of Visits",-1)),ge("span",tn,[(A(!0),z(J,null,Ne(a.actionButtons,R=>(A(),F(d,{key:R.label,onClick:R.action,color:R.color||"primary"},{default:n(()=>[R.icon?(A(),F(s,{key:0,icon:R.icon,class:"ion-margin-right"},null,8,["icon"])):G("",!0),k(" "+ue(R.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),e(g,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[e(b,{rows:a.rows,columns:a.columns,"row-actions-buttons":a.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:a.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const nn=_e(en,[["render",an],["__scopeId","data-v-824715c1"]]),ln=ae({__name:"ViralLoadTrail",props:{patient:{}},setup(a){const t=a,l=q(()=>"Viral Load Results Trail for ".concat(t.patient.getFullName())),u=E([]),m=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:pe},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:pe}],h={label:"X",color:"danger",action({encounter_id:s}){Pt(async d=>{try{await ia.void(s,d),L.hide(),W.emit(x.RELOAD_LATEST_VL_RESULT),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}catch(f){console.error(f)}},"small-modal custom-modal-backdrop")}};return Ve(async()=>{u.value=await Se.getViralLoadResultTrail(t.patient.getID())}),(s,d)=>(A(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>[k(ue(l.value),1)]),_:1})]),_:1})]),_:1}),e(i(ke),null,{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(oe),{style:Tt([{padding:"0 !important"},{minHeight:u.value.length?"0":"30vh"}])},{default:n(()=>[e(i(O),{size:"12",class:"ion-no-padding"},{default:n(()=>[e(i(vt),{rows:u.value,columns:m,"row-actions-buttons":[h],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:d[0]||(d[0]=f=>i(L).hide()),slot:"end"},{default:n(()=>[...d[1]||(d[1]=[k(" Close ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),on=ae({components:{MultiColumnView:dt,IonList:Rt,IonItem:ze},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(a,{emit:t}){const l=E(0),u=E(0),m=E(0),h=E(""),s=E(""),d=E(""),f=E(""),V=E(""),b=E(""),g=E(""),T=E(""),R=E(""),C=E(""),I=E(""),_=S=>S.other&&typeof S.other.onClickHandler=="function",D=q(()=>!Y(a.guardians)),P=async S=>{var r;_(S)&&await((r=S.other)==null?void 0:r.onClickHandler())},U=()=>{const S=a.patient.getBirthdate(),r=a.artStartDate!=="N/A"?ee(a.artStartDate).diff(S,"years"):"";return"".concat(pe(S)," (").concat(r,")")},v=()=>{Se.getlatestViralLoadResult(a.patient.getID()).then(S=>C.value=S)},y=()=>({onClickHandler(){sa.push("/patient/reception/".concat(a.patient.getID(),"/false"))}}),N=()=>D.value?a.guardians.map(S=>"".concat(S.name," (").concat(S.relationshipType,")")).join(","):"Add",$=()=>({onClickHandler:()=>t("updatePatient")}),M=q(()=>[{label:"ARV Number",value:a.patient.getArvNumber(),other:{onClickHandler:()=>t("updateARVNumber")}},{label:"NPID",value:a.patient.getNationalID()},{label:"MW National ID",value:a.patient.getMWNationalID(),other:$()},{label:"Name",value:a.patient.getGivenName()+" "+a.patient.getFamilyName(),other:$()},{label:"DOB and Age at Initiation",value:U(),other:$()},{label:"Sex",value:Da(a.patient.getGender()),other:$()},{label:"Location",value:a.patient.getCurrentVillage(),other:$()},{label:"Landmark",value:a.patient.getClosestLandmark(),other:$()},{label:"Phone Number",value:a.patient.getPhoneNumber(),other:$()},{label:"Guardian",value:N(),other:{onClickHandler:()=>t("updateGuardian")}},{label:"Agrees to follow up",value:V.value,other:y()},{label:"Date of starting first line ARV Regimen",value:a.artStartDate,other:y()},{label:"Initial Weight and Height",value:"".concat(l.value,"Kg, ").concat(u.value,"cm"),other:y()},{label:"Initial BMI",value:m.value,other:y()},{label:"Initial TB Status",value:h.value,other:y()},{label:"Pregnant at Initiation",value:d.value,other:y()},{label:"Breastfeeding at Initiation",value:s.value,other:y()},{label:"Latest VL Result and Result Date",value:C.value,other:{onClickHandler:()=>L.show(ln,{patient:a.patient})}},{label:"TI",value:f.value,other:y()},{label:"HIV test place",value:T.value,other:y()},{label:"HIV test date",value:g.value,other:y()},{label:"WHO stage",value:I.value,other:y()},{label:"Reason for starting ART",value:b.value,other:y()},{label:"Staging codition",value:R.value,other:y()}]),j=async()=>{const S=await a.patient.getHIVTestDate();S&&(g.value=pe(S))},H=()=>{a.patient.getInitialWeight().then(S=>l.value=S),a.patient.getInitialHeight().then(S=>u.value=S),a.patient.getInitialBMI().then(S=>m.value=S),a.patient.getInitialTBStatus().then(S=>h.value=S),a.patient.hasPregnancyAtARTInitiation().then(S=>d.value=S),a.patient.breastFeedingAtARTInitiation().then(S=>s.value=S),a.patient.everReceivedART().then(S=>f.value=S),a.patient.agreesToFollowUp().then(S=>V.value=S),a.patient.getReasonForStartingART().then(S=>b.value=S),a.patient.getHIVTestLocation().then(S=>T.value=S),a.patient.getStagingCondition().then(S=>R.value=S),a.patient.getWhoStage().then(S=>I.value=S),j()};return Ve(()=>{H(),v(),W.on(x.RELOAD_LATEST_VL_RESULT,()=>v()),W.on(x.RELOAD_STAGING_INFORMATION,()=>H())}),{patientInfo:M,onClickHandler:P,clickable:_}}});const sn={style:{width:"100%",display:"flex",justifyContent:"space-between"}},rn={key:0},un={key:1},dn={key:2},mn={key:3};function cn(a,t,l,u,m,h){const s=w("ion-item"),d=w("ion-list"),f=w("multi-column-view");return A(),F(f,{items:a.patientInfo,numberOfColumns:3},{default:n(({entries:V})=>[e(d,{class:"his-card ion-margin-end"},{default:n(()=>[(A(!0),z(J,null,Ne(V,(b,g)=>(A(),F(s,{key:g,lines:g===V.length-1?"none":void 0,button:a.clickable(b),onClick:T=>a.onClickHandler(b)},{default:n(()=>[ge("div",sn,[b.label?(A(),z("span",rn,ue(b.label)+": ",1)):(A(),z("span",un)),a.clickable(b)?(A(),z("span",dn,[ge("a",null,[ge("b",null,ue(b.value||"N/A"),1)])])):(A(),z("span",mn,[ge("b",null,ue(b.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const pn=_e(on,[["render",cn],["__scopeId","data-v-1195e33c"]]),vn=ae({components:{IonGrid:ve,IonRow:oe,IonCol:O,TextInput:Pe,DateInput:be,SelectInput:me},props:{patientService:{type:Object,required:!0}},setup(a){const t=E(!1),l=q(()=>/Unknown/i.test(a.patientService.getMWNationalID())?"":a.patientService.getMWNationalID()),u=ce({givenName:{label:"First Name",value:a.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:s=>He(s)},familyName:{label:"last Name",value:a.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:s=>He(s)},middleName:{label:"middle Name",value:a.patientService.getMiddleName(),placeholder:"middle Name",validation:s=>!!s&&He(s)},nationalId:{label:"Malawi National ID Number",value:l.value,placeholder:"Enter Malawi National ID Number",validation:s=>s&&s.label?ba(s):null},gender:{value:a.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:a.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:a.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async s=>!(s.value==="Unknown"||s.value==="N/A")&&Ot(s)},homeVillage:{value:a.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:a.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),m=async s=>{var V,b,g,T,R;let d,f;try{(V=s==null?void 0:s.other)!=null&&V.traditional_authority_id&&(d=await Dt.getTraditionalAuthorityById(s.other.traditional_authority_id)),d&&(f=await Dt.getDistrictByID(d.district_id))}catch(C){Be("Unable to resolve patient address. Saving using default address"),console.error(C)}return{home_district:(b=f==null?void 0:f.name)!=null?b:"N/A",home_traditional_authority:(g=d==null?void 0:d.name)!=null?g:"N/A",home_village:(s==null?void 0:s.label)||"N/A",current_district:(T=f==null?void 0:f.name)!=null?T:"N/A",current_traditional_authority:(R=d==null?void 0:d.name)!=null?R:"N/A",current_village:(s==null?void 0:s.label)||"N/A"}};return{today:K,patient:u,getLandmarks:_a,genderOptions:Va,isBirthdateEstimated:t,modal:L,onFinish:async()=>Ue(u,async s=>{const d={};if(s.givenName!==a.patientService.getGivenName()&&(d.given_name=s.givenName),s.familyName!==a.patientService.getFamilyName()&&(d.family_name=s.familyName),s.middleName!==a.patientService.getMiddleName()&&(d.middle_name=s.middleName),s.birthdate!==a.patientService.getBirthdate()&&(d.birthdate=s.birthdate),s.gender.value!==a.patientService.getGender()&&(d.gender=s.gender.value),s.cellPhoneNumber!==a.patientService.getPhoneNumber()&&(d.cell_phone_number=s.cellPhoneNumber),s.landmark.label!==a.patientService.getClosestLandmark()&&(d.landmark=s.landmark.label),s.homeVillage!==a.patientService.getCurrentVillage()&&Object.assign(d,{...d,...await m(s.homeVillage)}),!Y(d)){const f=new ut;f.setPersonID(a.patientService.getID()),await f.updatePerson(d)}s.nationalId!==l.value&&await a.patientService.updateMWNationalId(s.nationalId),await L.hide(),W.emit(x.RELOAD_PATIENT_DATA)}),getVillagesByName:ya}}});function fn(a,t,l,u,m,h){const s=w("ion-title"),d=w("ion-icon"),f=w("ion-button"),V=w("ion-buttons"),b=w("ion-toolbar"),g=w("ion-header"),T=w("TextInput"),R=w("ion-col"),C=w("SelectInput"),I=w("DateInput"),_=w("ion-row"),D=w("ion-grid"),P=w("ion-content"),U=w("ion-footer");return A(),z(J,null,[e(g,null,{default:n(()=>[e(b,null,{default:n(()=>[e(s,null,{default:n(()=>[...t[12]||(t[12]=[k("Edit Patient Demographics",-1)])]),_:1}),e(V,{slot:"end"},{default:n(()=>[e(f,{onClick:t[0]||(t[0]=v=>a.modal.hide())},{default:n(()=>[e(d,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(P,{class:"ion-padding"},{default:n(()=>[e(D,null,{default:n(()=>[e(_,null,{default:n(()=>[e(R,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.givenName,"onUpdate:modelValue":t[1]||(t[1]=v=>a.patient.givenName=v)},null,8,["modelValue"])]),_:1}),e(R,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.middleName,"onUpdate:modelValue":t[2]||(t[2]=v=>a.patient.middleName=v)},null,8,["modelValue"])]),_:1}),e(R,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.familyName,"onUpdate:modelValue":t[3]||(t[3]=v=>a.patient.familyName=v)},null,8,["modelValue"])]),_:1}),e(R,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.nationalId,"onUpdate:modelValue":t[4]||(t[4]=v=>a.patient.nationalId=v)},null,8,["modelValue"])]),_:1}),e(R,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(C,{modelValue:a.patient.gender,"onUpdate:modelValue":t[5]||(t[5]=v=>a.patient.gender=v),options:a.genderOptions},null,8,["modelValue","options"])]),_:1}),e(R,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(I,{modelValue:a.patient.birthdate,"onUpdate:modelValue":t[6]||(t[6]=v=>a.patient.birthdate=v),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:a.today,onIsEstimated:t[7]||(t[7]=v=>a.isBirthdateEstimated=v)},null,8,["modelValue","maxDate"])]),_:1}),e(R,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.cellPhoneNumber,"onUpdate:modelValue":t[8]||(t[8]=v=>a.patient.cellPhoneNumber=v),allowUnknown:""},null,8,["modelValue"])]),_:1}),e(R,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(C,{modelValue:a.patient.homeVillage,"onUpdate:modelValue":t[9]||(t[9]=v=>a.patient.homeVillage=v),asyncOptions:a.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),e(R,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(C,{modelValue:a.patient.landmark,"onUpdate:modelValue":t[10]||(t[10]=v=>a.patient.landmark=v),asyncOptions:a.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),e(U,null,{default:n(()=>[e(b,null,{default:n(()=>[e(f,{color:"primary",onClick:t[11]||(t[11]=v=>a.modal.hide()),slot:"end"},{default:n(()=>[...t[13]||(t[13]=[k("Close",-1)])]),_:1}),e(f,{class:"ion-margin-end",color:"success",onClick:a.onFinish,slot:"end"},{default:n(()=>[...t[14]||(t[14]=[k("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const gn=_e(vn,[["render",fn]]),bn=ae({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(a){var C,I;const t=new ut,l=a,u=E(Y(l.guardians)),m=q(()=>"".concat(u.value?"Add":"Edit"," Guardian Demographics")),h=q(()=>"".concat(u.value?"Edit":"Add"," Guardian")),s=E([]),d=(I=(C=l.guardians)==null?void 0:C.map(_=>({label:"".concat(_.name," (").concat(_.relationshipType,")"),value:_.name,other:_})))!=null?I:[],f=ce({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),V=ce({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:_=>He(_)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:_=>He(_)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async _=>_.value!=="Unknown"&&Ot(_)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});fe(()=>f.guardian.value,_=>{var D,P,U,v,y,N,$,M;V.givenName.value=(P=(D=_==null?void 0:_.other)==null?void 0:D.names.given_name)!=null?P:"",V.familyName.value=(v=(U=_==null?void 0:_.other)==null?void 0:U.names.family_name)!=null?v:"",V.cellPhoneNumber.value=(N=(y=_==null?void 0:_.other)==null?void 0:y.phoneNumber)!=null?N:"",V.relation.value=(M=($=_==null?void 0:_.other)==null?void 0:$.relationshipType)!=null?M:""},{deep:!0,immediate:!0});function b(){u.value=!u.value,f.guardian.value=""}async function g(_){var D,P;await t.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:l.patientId,..._}),await it.createRelation(l.patientId,t.getPersonID(),(P=(D=_.relation)==null?void 0:D.value)!=null?P:13)}async function T(_,D){var v,y;const P=D.names.person_id,U={};if(D.names.given_name!==_.given_name&&(U.given_name=_.given_name),D.names.family_name!==_.family_name&&(U.family_name=_.family_name),D.phoneNumber!==_.cell_phone_number&&(U.cell_phone_number=_.cell_phone_number),!Y(U)){const N=new ut;N.setPersonID(P),await N.updatePerson(U)}D.relationshipType!==_.relation.label&&await it.amendRelation(l.patientId,P,D.id,(y=(v=_.relation)==null?void 0:v.value)!=null?y:13)}const R=async()=>Ue(V,async _=>{!u.value&&!Y(f.guardian.value)?await T(_,f.guardian.value.other):await g(_),await L.hide(),W.emit(x.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return Ve(async()=>{const _=(await it.getRelations()).data;s.value=_.map(D=>({label:D.b_is_to_a,value:D.relationship_type_id,other:D}))}),(_,D)=>{const P=w("ion-title"),U=w("ion-icon"),v=w("ion-button"),y=w("ion-buttons"),N=w("ion-toolbar"),$=w("ion-header"),M=w("ion-content"),j=w("ion-footer");return A(),z(J,null,[e($,null,{default:n(()=>[e(N,null,{default:n(()=>[e(P,null,{default:n(()=>[k(ue(m.value),1)]),_:1}),e(y,{slot:"end"},{default:n(()=>[e(v,{onClick:D[0]||(D[0]=H=>i(L).hide())},{default:n(()=>[e(U,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(M,{class:"ion-padding"},{default:n(()=>[e(i(ve),null,{default:n(()=>[e(i(oe),null,{default:n(()=>[u.value?G("",!0):(A(),F(i(O),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(me,{modelValue:f.guardian,"onUpdate:modelValue":D[1]||(D[1]=H=>f.guardian=H),options:i(d)},null,8,["modelValue","options"])]),_:1})),f.guardian.value||u.value?(A(),z(J,{key:1},[e(i(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Pe,{modelValue:V.givenName,"onUpdate:modelValue":D[2]||(D[2]=H=>V.givenName=H)},null,8,["modelValue"])]),_:1}),e(i(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Pe,{modelValue:V.familyName,"onUpdate:modelValue":D[3]||(D[3]=H=>V.familyName=H)},null,8,["modelValue"])]),_:1}),e(i(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Pe,{modelValue:V.cellPhoneNumber,"onUpdate:modelValue":D[4]||(D[4]=H=>V.cellPhoneNumber=H),allowUnknown:""},null,8,["modelValue"])]),_:1}),e(i(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(me,{modelValue:V.relation,"onUpdate:modelValue":D[5]||(D[5]=H=>V.relation=H),options:s.value},null,8,["modelValue","options"])]),_:1})],64)):G("",!0)]),_:1})]),_:1})]),_:1}),e(j,null,{default:n(()=>[e(N,null,{default:n(()=>[i(Y)(l.guardians)?G("",!0):(A(),F(v,{key:0,color:"primary",onClick:b,slot:"start"},{default:n(()=>[k(ue(h.value),1)]),_:1})),e(v,{color:"primary",onClick:D[6]||(D[6]=H=>i(L).hide()),slot:"end"},{default:n(()=>[...D[7]||(D[7]=[k("Close",-1)])]),_:1}),e(v,{class:"ion-margin-end",color:"success",onClick:R,slot:"end"},{default:n(()=>[...D[8]||(D[8]=[k("Save",-1)])]),_:1})]),_:1})]),_:1})],64)}}}),_n=ae({components:{IonGrid:ve,IonRow:oe,IonCol:O,TextInput:Pe},props:{patient:{type:Object,required:!0}},setup(a){const{facility:t}=mt(),l=q(()=>a.patient.getArvNumber()),u=q(()=>!Y(l.value)&&l.value!=="Unknown"),m=ce({arvNumber:{value:u.value?l.value.split("-")[2]:"",label:"".concat(u.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async d=>{const f=re(d,"POSITIVE_INTEGERS");if(f!==null)return f;if(d.value===l.value.split("-")[2])return null;const V=await Le.findByOtherID(4,"".concat(t.code,"-ARV-").concat(d.value));return V.ok?Y(V.data)?null:["ARV Number already taken"]:[V.errorMessage||V.clientErrorType||"Unable to determine ARV number with status: ".concat(V.httpStatusResponse)]}}});return{form:m,modal:L,arvNumber:l,facility:t,hasValidARVNumber:u,onFinish:async()=>Ue(m,async d=>{d.arvNumber!==l.value.split("-")[2]&&(u.value?await a.patient.updateARVNumber("".concat(t.code,"-ARV-").concat(d.arvNumber)):await a.patient.createArvNumber("".concat(t.code,"-ARV-").concat(d.arvNumber)),W.emit(x.RELOAD_PATIENT_DATA)),await L.hide()}),voidARV:async()=>{if(await he("Are you sure you want to void this ARV Number ".concat(l.value,"?"))){await le.show("Voiding ARV Number...");try{await Ie.postJson("/programs/".concat(ra,"/void_arv_number/").concat(l),{}),await le.hide(),await L.hide(),W.emit(x.RELOAD_PATIENT_DATA)}catch(f){await le.hide(),console.log(f)}}}}}});function yn(a,t,l,u,m,h){const s=w("ion-title"),d=w("ion-icon"),f=w("ion-button"),V=w("ion-buttons"),b=w("ion-toolbar"),g=w("ion-header"),T=w("text-input"),R=w("ion-col"),C=w("ion-row"),I=w("ion-grid"),_=w("ion-content"),D=w("ion-footer");return A(),z(J,null,[e(g,null,{default:n(()=>[e(b,null,{default:n(()=>[e(s,null,{default:n(()=>[...t[3]||(t[3]=[k("ARV NUMBER",-1)])]),_:1}),e(V,{slot:"end"},{default:n(()=>[e(f,{onClick:t[0]||(t[0]=P=>a.modal.hide())},{default:n(()=>[e(d,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(_,{class:"ion-padding"},{default:n(()=>[e(I,null,{default:n(()=>[e(C,null,{default:n(()=>[e(R,null,{default:n(()=>[e(T,{modelValue:a.form.arvNumber,"onUpdate:modelValue":t[1]||(t[1]=P=>a.form.arvNumber=P),form:a.form,prefix:"".concat(a.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),e(D,{class:"ion-padding-horizontal"},{default:n(()=>[e(b,null,{default:n(()=>[e(f,{color:"primary",onClick:t[2]||(t[2]=P=>a.modal.hide()),slot:"end"},{default:n(()=>[...t[4]||(t[4]=[k("Close",-1)])]),_:1}),a.hasValidARVNumber?(A(),F(f,{key:0,color:"danger",onClick:a.voidARV,slot:"start"},{default:n(()=>[...t[5]||(t[5]=[k("Void ARV Number",-1)])]),_:1},8,["onClick"])):G("",!0),e(f,{color:"success",onClick:a.onFinish,slot:"end"},{default:n(()=>[...t[6]||(t[6]=[k("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const hn=_e(_n,[["render",yn]]),Vn=ae({components:{VisitsSummary:nn,InformationHeader:pn},setup(){const a=ua(),t=parseInt(a.params.patientId.toString())||0,l=E(),u=E(""),m=E([]),h=q(()=>!Y(l.value)),s=q(()=>{var C;return(C=l.value)==null?void 0:C.getNationalID()}),d=async()=>{if(t){const C=(await Le.findByID(t)).data;C&&(l.value=new Le(C))}},f=async()=>{m.value=await Sa.getGuardianDetails(t)},V=async C=>{await L.show(gn,{patientService:l.value,attribute:C})},b=async()=>{await L.show(bn,{patientId:t,guardians:m.value})},g=async()=>{await L.show(hn,{patient:l.value})},T=async()=>{var I;await le.show("Client has Invalid NPID. Assigning NPID...");const C=await Le.assignNPID(t);C.ok?(await d(),await le.hide()):(await le.hide(),Be((I=C.errorMessage)!=null?I:"Failed to assign NPID"))},R=async()=>{var I;let C=!1;if(Aa.value)C=!((I=l.value)==null?void 0:I.getDocID())||Ia(s.value)||await Ra(t);else{const _=await Ta(s.value);C=!_||_.length>1}C&&await T()};return W.on(x.RELOAD_PATIENT_DATA,async()=>{await d()}),W.on(x.RELOAD_GUARDIAN_DATA,async()=>{await f()}),Ve(async()=>{var I;await Na(),await d(),await R();const C=await((I=l.value)==null?void 0:I.getARTStartDate());u.value=C?pe(C):"N/A",f()}),{patient:l,artStartDate:u,guardians:m,isReady:h,updateDemographics:V,updateGuardian:b,updateARVNumber:g}}});function wn(a,t,l,u,m,h){const s=w("information-header"),d=w("ion-col"),f=w("ion-row"),V=w("visits-summary"),b=w("ion-grid");return a.isReady?(A(),F(b,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[e(f,null,{default:n(()=>[e(d,{size:"12"},{default:n(()=>[a.patient?(A(),F(s,{key:0,patient:a.patient,guardians:a.guardians,artStartDate:a.artStartDate,onUpdateARVNumber:a.updateARVNumber,onUpdateGuardian:a.updateGuardian,onUpdatePatient:a.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):G("",!0)]),_:1})]),_:1}),e(f,null,{default:n(()=>[e(d,null,{default:n(()=>[a.patient?(A(),F(V,{key:0,patient:a.patient,startDate:a.artStartDate},null,8,["patient","startDate"])):G("",!0)]),_:1})]),_:1})]),_:1})):G("",!0)}const Xn=_e(Vn,[["render",wn]]);export{Xn as default};
