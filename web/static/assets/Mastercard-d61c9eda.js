var kt=Object.defineProperty;var $t=(e,a,l)=>a in e?kt(e,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[a]=l;var dt=(e,a,l)=>($t(e,typeof a!="symbol"?a+"":a,l),l);import{D as Me,H as ft}from"./Date-91d646d9.js";import{G as he,F as gt,d as x,r as O,ae as oe,a6 as ve,a2 as Ve,c as M,a as t,w as n,u as v,K as W,o as I,q as Ee,$ as Ze,b as k,S as xe,i as ce,j as le,k as C,J as qe,s as Ge,am as Qe,C as et,I as ae,n as tt,ai as ye,H as B,L as f,f as fe,h as U,y as F,ao as Ut,t as ue,ap as Bt,N as Ne,aq as Ft,a5 as Ht,ar as Mt,l as qt,a4 as Gt,as as Lt,p as zt,e as Wt,U as Yt,af as jt,an as ct,at as Jt}from"./index-23369c78.js";import{g as Qt,D as bt,C as He,P as Le,O as Ue}from"./patient_service-c0fa9c71.js";import{g as Ye,i as q}from"./common-abc2f84d.js";import{A as de,P as Kt,V as Xt,C as Zt,E as mt}from"./consultation_service-fd217298.js";import{P as _t}from"./program_service-aa88d5b7.js";import{p as xt}from"./VoidReason-2c79cb43.js";import{t as Se,d as Z,a as X,e as ea}from"./his_date-4b772130.js";import{D as ge}from"./DateInput-15fffa68.js";import{S as ne}from"./SelectInput-18cafc7c.js";import{N as ee,R as Te}from"./regimen_service-83967df6.js";import{t as ze,a as ta,g as aa}from"./DTFormElements-a1199b88.js";import{e as Pe}from"./encounter_types-ae359711.js";import{s as we,i as na,r as oa,a as Be}from"./form-45afd31d.js";import{E as G,a as L}from"./emc_event-4721851b.js";import{m as H,D as la}from"./DrilldownTable-063461ad.js";import{a as Ce,t as at}from"./toasts-be7ddb9d.js";import{D as ht}from"./index-58141fd8.js";import{_ as te}from"./_plugin-vue_export-helper-c27b6911.js";import{T as Re}from"./TextInput-98aaebeb.js";import{g as ia,a as ra,b as sa}from"./location_options-46d64115.js";import{r as se,v as Fe,d as re,e as pt,a as Oe,b as ua,c as yt}from"./validations-b9fbcec4.js";import{Y as pe}from"./YesNoInput-3d452e8c.js";import{c as da,u as vt}from"./arrays-31d2d38b.js";import{t as ca}from"./Strs-7ee8a435.js";import{P as Ke,R as je}from"./relations_service-f6f7950b.js";import{l as Je}from"./loader-3c3c166b.js";import"./patient_identifier_service-7de26e08.js";import"./index-95d3a767.js";import"./vue-datepicker-c15ae9ca.js";const ma=e=>{const a=e.given_name,l=e.family_name,s=e.middle_name?e.middle_name:"";return"".concat(a," ").concat(s," ").concat(l)};class pa{static getRelationships(a){return he.getJson("/people/".concat(a,"/relationships")).then(l=>l.data)}static async getGuardianDetails(a){return await this.getRelationships(a).then(l=>l.map(s=>{const c=Ye(s,"relation.names[0]");return{id:s.relationship_id,name:c?ma(c):"",relationshipType:Ye(s,"type.b_is_to_a",""),phoneNumber:Qt(Ye(s,"relation.person_attributes",[]),12),names:c}}))}}const Ie=class Ie extends de{constructor(a){super(a,Pe.LAB_ORDERS)}async loadConcepts(){Ie.conceptID=await de.getConceptID("HIV Viral Load")}createLabOrder(a,l){const s=he.getUsername(),c=gt().facility.name,b=de.getCachedConceptID(l,!0);return he.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:s,target_lab:c,reason_for_test_id:b,encounter_id:this.encounterID,tests:[{concept_id:Ie.conceptID}],date:this.date,specimen:{concept_id:a}}]})}createLabResult(a,l,s,c="numeric"){return he.postJson("lab/tests/".concat(a,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Ie.conceptID},value:l,value_modifier:s,value_type:c}]})}static getSpecimens(a){return he.getJson("/lab/specimen_types",{test_type:a})}static async getlatestViralLoadResult(a,l={}){var b;const c=(b=(await he.getJson("/lab/orders",{patient_id:a,...l})).data)==null?void 0:b.reduce((i,u)=>{const m=u.tests.filter(y=>y.name.match(/hiv/i)&&!q(y.result)).map(y=>y.result);return i.push(...m.flat()),i},[]).sort((i,u)=>new Date(i.date)>new Date(u.date)?-1:1);return c&&c.length>0?"".concat(c[0].value_modifier).concat(c[0].value," (").concat(Se(c[0].date),")"):"N/A"}};dt(Ie,"conceptID",-1);let Ae=Ie;const Vt=x({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=O(!1),s=ze(["=",">","<",">=","<="]),c=ze(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),b=O([]),i=a.patient.getBirthdate(),u=oe({orderDate:{value:"",label:"Order Date",required:!0,validation:async g=>Z(g.value).isValid()?new Date(g.value)>new Date(X())?["Order date cannot be in the future"]:new Date(g.value)<new Date(i)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(g,V)=>Z(g.value).isValid()?new Date(g.value)>new Date(X())?["Result date cannot be in the future"]:new Date(g.value)<new Date(V.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function m(){we(u,async g=>{const V=new Ae(a.patient.getID());if(await V.loadConcepts(),V.setDate(g.orderDate),!await V.createEncounter())throw new Error("Unable to create lab order encounter");const _=await V.createLabOrder(g.specimen.value,g.reason.value);if(!_.ok||!_.data)throw new Error("Unable to save lab orders");const A=new Ae(a.patient.getID());if(A.setDate(g.resultDate),!await A.createEncounter())throw new Error("Unable to create lab result encounter");const h=l.value?"LDL":parseInt(g.result),w=l.value?"=":g.modifier.value,T=l.value?"text":"numeric",$=_.data[0].tests[0].id;await A.createLabResult($,h,w,T),await H.hide(),G.emit(L.RELOAD_LATEST_VL_RESULT),G.emit(L.RELOAD_PATIENT_VISIT_DATA)})}async function y(){if(await ye("Are you sure you want to clear all fields?")){l.value=!1;for(const g in u)u[g].value="",u[g].error="";G.emit(L.ON_CLEAR)}}return ve(l,g=>{g&&(u.modifier.value="",u.result.value=void 0,u.modifier.error="",u.result.error=""),u.modifier.disabled=g,u.modifier.required=!g,u.result.disabled=g,u.result.required=!g}),Ve(async()=>{b.value=(await Ae.getSpecimens("HIV viral load")).data.map(g=>({label:g.name,value:g.concept_id}))}),(g,V)=>(I(),M(W,null,[t(v(xe),null,{default:n(()=>[t(v(Ee),null,{default:n(()=>[t(v(Ze),null,{default:n(()=>[k("Viral Load Results")]),_:1})]),_:1})]),_:1}),t(v(et),{class:"ion-padding"},{default:n(()=>[t(v(ce),{style:{width:"100%"}},{default:n(()=>[t(v(le),null,{default:n(()=>[t(v(C),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:u.orderDate,"onUpdate:modelValue":V[0]||(V[0]=N=>u.orderDate=N),form:u,minDate:v(i),maxDate:v(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ne,{modelValue:u.reason,"onUpdate:modelValue":V[1]||(V[1]=N=>u.reason=N),options:v(c)},null,8,["modelValue","options"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ne,{modelValue:u.specimen,"onUpdate:modelValue":V[2]||(V[2]=N=>u.specimen=N),options:b.value},null,8,["modelValue","options"])]),_:1}),t(v(C),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:u.resultDate,"onUpdate:modelValue":V[3]||(V[3]=N=>u.resultDate=N),form:u,minDate:u.orderDate.value,"max-date":v(X)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ne,{modelValue:u.modifier,"onUpdate:modelValue":V[4]||(V[4]=N=>u.modifier=N),options:v(s)},null,8,["modelValue","options"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.result,"onUpdate:modelValue":V[5]||(V[5]=N=>u.result=N),form:u,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),t(v(le),{class:"ion-margin-top"},{default:n(()=>[t(v(C),{size:"12"},{default:n(()=>[t(v(qe),{class:"ion-padding-vertical bold"},{default:n(()=>[k(" Other Results Options: ")]),_:1}),t(v(Ge),null,{default:n(()=>[t(v(qe),null,{default:n(()=>[k("LDL")]),_:1}),t(v(Qe),{slot:"start",modelValue:l.value,"onUpdate:modelValue":V[6]||(V[6]=N=>l.value=N)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(v(tt),null,{default:n(()=>[t(v(Ee),null,{default:n(()=>[t(v(ae),{color:"primary",onClick:V[7]||(V[7]=N=>v(H).hide()),slot:"end"},{default:n(()=>[k(" Close ")]),_:1}),t(v(ae),{color:"warning",onClick:y,slot:"end"},{default:n(()=>[k(" Reset ")]),_:1}),t(v(ae),{color:"success",onClick:m,slot:"end"},{default:n(()=>[k(" Save ")]),_:1})]),_:1})]),_:1})],64))}}),va=x({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:ht},emits:["voidOutcome"],setup(e,{emit:a}){const l=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:i=>Z(i).format(Me)},{path:"end_date",label:"End Date",formatter:i=>Z(i).format(Me)}],s={showSearchField:!1,showSubmitButton:!1};return{rows:B(()=>e.patientStates.map((i,u)=>({...i,index:u}))),columns:l,tableConfig:s,TableRowActions:[{label:"void",color:"danger",action:async i=>{await ye("Are you sure you want to void this outcome?")&&a("voidOutcome",{stateId:i.patient_state_id,index:i.index})}}]}}}),fa=fe("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1);function ga(e,a,l,s,c,b){const i=f("data-table");return I(),M(W,null,[fa,t(i,{rows:e.rows,columns:e.columns,config:e.tableConfig,"row-actions-buttons":e.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const ba=te(va,[["render",ga]]),_a=x({name:"EnrollmentForm",components:{DateInput:ge,IonGrid:ce,IonRow:le,IonCol:C,IonButton:ae},props:["birthdate"],emits:["enrollProgram"],setup(e,{emit:a}){const l=Z().format("YYYY-MM-DD"),s=oe({date:{value:"",label:"Date of Enrollment",required:!0,validation:async i=>new Date(i.value)<new Date(e.birthdate)?["Date of enrollment cannot be before date of birth"]:new Date(i.value)>new Date(l)?["Date of enrollment cannot be in the future"]:null}});return{form:s,today:l,onReset:async()=>{await ye("Are you sure you want to clear all fields")&&(s.date.value="",s.date.error="",G.emit(L.ON_CLEAR))},enrollProgram:async()=>we(s,({date:i})=>a("enrollProgram",i))}}});function ha(e,a,l,s,c,b){const i=f("DateInput"),u=f("ion-col"),m=f("ion-button"),y=f("ion-row"),g=f("ion-grid");return I(),U(g,null,{default:n(()=>[t(y,null,{default:n(()=>[t(u,{size:"12"},{default:n(()=>[t(i,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=V=>e.form.date=V),form:e.form,minDate:e.birthdate,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(u,null,{default:n(()=>[t(m,{color:"warning",onClick:e.onReset},{default:n(()=>[k("Reset")]),_:1},8,["onClick"]),t(m,{color:"success",onClick:e.enrollProgram},{default:n(()=>[k("Enroll")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const ya=te(_a,[["render",ha]]),Va=x({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:ge,IonGrid:ce,IonRow:le,IonCol:C,IonButton:ae,SelectInput:ne,TextInput:Re},emits:["saveOutcome"],setup(e,{emit:a}){const l=Z().format("YYYY-MM-DD"),s=oe({date:{value:"",label:"Outcome Date",required:!0,validation:async m=>new Date(m.value)<new Date(e.birthdate)?["Outcome date cannot be before date of birth - ".concat(Z(e.birthdate).format(Me))]:new Date(m.value)<new Date(e.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(Z(e.dateEnrolled).format(Me))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(m,y)=>y.status.value.label==="Patient transferred out"&&se(m)},reason:{value:"",label:"Reason for transfer out",validation:async(m,y)=>y.status.value.label==="Patient transferred out"&&se(m)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(m,y)=>{var g,V,N,_;return((V=(g=y.status)==null?void 0:g.value)==null?void 0:V.label)==="Patient transferred out"&&((_=(N=y.reason)==null?void 0:N.value)==null?void 0:_.label)==="Other"&&se(m)}}}),c=B(()=>{var m;return((m=s.status.value)==null?void 0:m.label)==="Patient transferred out"}),b=B(()=>{var m,y;return((y=(m=s.reason)==null?void 0:m.value)==null?void 0:y.label)==="Other"});return{form:s,today:l,isTransferredOut:c,specifyOther:b,onSave:()=>we(s,m=>a("saveOutcome",{...m,isTransferredOut:c.value})),onReset:async()=>{if(await ye("are you sure you want to clear all fields")){for(const m in s)s[m].value="",s[m].error="";G.emit(L.ON_CLEAR)}},getFacilities:ia,transferOutReasons:ta}}}),wa=fe("p",null,"Add New Outcome",-1);function Da(e,a,l,s,c,b){const i=f("ion-col"),u=f("DateInput"),m=f("SelectInput"),y=f("text-input"),g=f("ion-button"),V=f("ion-row"),N=f("ion-grid");return I(),U(N,null,{default:n(()=>[t(V,null,{default:n(()=>[t(i,{size:"12"},{default:n(()=>[wa]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(u,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=_=>e.form.date=_),form:e.form,minDate:e.dateEnrolled,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(m,{modelValue:e.form.status,"onUpdate:modelValue":a[1]||(a[1]=_=>e.form.status=_),form:e.form,options:e.outcomes},null,8,["modelValue","form","options"])]),_:1}),e.isTransferredOut?(I(),M(W,{key:0},[t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(m,{modelValue:e.form.nextFacility,"onUpdate:modelValue":a[2]||(a[2]=_=>e.form.nextFacility=_),form:e.form,asyncOptions:e.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(m,{modelValue:e.form.reason,"onUpdate:modelValue":a[3]||(a[3]=_=>e.form.reason=_),form:e.form,options:e.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),e.specifyOther?(I(),U(i,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[t(y,{modelValue:e.form.otherReason,"onUpdate:modelValue":a[4]||(a[4]=_=>e.form.otherReason=_),form:e.form},null,8,["modelValue","form"])]),_:1})):F("",!0)],64)):F("",!0),t(i,{size:"12",class:"ion-margin-top"},{default:n(()=>[t(g,{color:"warning",onClick:e.onReset},{default:n(()=>[k("Reset")]),_:1},8,["onClick"]),t(g,{color:"success",onClick:e.onSave},{default:n(()=>[k("Save")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Ia=te(Va,[["render",Da]]),Na=x({components:{IonContent:et,IonFooter:tt,IonHeader:xe,IonTitle:Ze,IonToolbar:Ee,IonButton:ae,IonGrid:ce,IonRow:le,IonCol:C,IonBadge:Ut,OutcomesTable:ba,EnrollmentForm:ya,OutcomeForm:Ia},props:{patient:{type:Object,required:!0}},setup(e){const{toStandardHisDisplayFormat:a,toStandardHisFormat:l}=ft,s=new Kt(e.patient.getID()),c=B(()=>l(e.patient.getBirthdate())),b=O(),i=B(()=>!q(b.value)),u=O(""),m=O(),y=B(()=>{var D,h,w;return(w=(h=(D=b.value)==null?void 0:D.patient_states)==null?void 0:h.length)!=null?w:0}),g=B(()=>i.value&&u.value?"Patient enrolled in this porgram on ".concat(a(u.value)):"Patient is not enrolled in this program"),V=async({date:D,status:h,nextFacility:w,reason:T,otherReason:$,isTransferredOut:R})=>{if(s.setStateDate(D),s.setStateId(h.value),R){const P=T.value!=="Other"?T.value:$;await s.transferOutEncounter(w.other,P)}await s.updateState(),await Ce("Outcome saved successfully",1e3),await H.hide(),G.emit(L.RELOAD_PATIENT_VISIT_DATA)},N=async D=>{s.setProgramDate(D),await s.enrollProgram(),await Ce("Program enrolled successfully",1e3),await H.hide(),G.emit(L.RELOAD_PATIENT_VISIT_DATA)},_=async()=>{var D;s.setPatientProgramId(((D=b.value)==null?void 0:D.patient_program_id)||-1),await s.voidProgram("duplicate / system error"),await Ce("Patient voided from program successfully",1e3),await H.hide(),G.emit(L.RELOAD_PATIENT_VISIT_DATA)},A=async({stateId:D,index:h})=>{var w;s.setStateId(D),await s.voidState("duplicate / system error"),Ce("Outcome voided successfully"),(w=b.value)==null||w.patient_states.splice(h,1),G.emit(L.RELOAD_PATIENT_VISIT_DATA)};return Ve(async()=>{const D=(await s.getPrograms()).data;if(b.value=D.find(h=>h.program.name==="HIV PROGRAM"),b.value){u.value=b.value.date_enrolled;const h=await s.getProgramOutcomes(),w=new Set(s.removedStates);m.value=h.map(T=>({label:T.name,value:T.program_workflow_state_id,other:T})).filter(T=>!w.has(T.label))}}),{modal:H,patientProgram:s,isEnrolled:i,enrollDate:u,birthdate:c,enrollmentStatus:g,outcomes:m,program:b,totalStates:y,toStandardHisDisplayFormat:a,saveOutcome:V,enrollProgram:N,voidProgram:_,voidOutcome:A}}});function Ra(e,a,l,s,c,b){const i=f("ion-title"),u=f("ion-toolbar"),m=f("ion-header"),y=f("ion-badge"),g=f("ion-col"),V=f("ion-row"),N=f("enrollment-form"),_=f("outcome-form"),A=f("outcomes-table"),D=f("ion-grid"),h=f("ion-content"),w=f("ion-button"),T=f("ion-footer");return I(),M(W,null,[t(m,null,{default:n(()=>[t(u,null,{default:n(()=>[t(i,null,{default:n(()=>[k("Patient Outcomes")]),_:1})]),_:1})]),_:1}),t(h,null,{default:n(()=>[t(D,{style:{width:"100%"}},{default:n(()=>[t(V,null,{default:n(()=>[t(g,null,{default:n(()=>[t(y,{color:"lightblue",class:"ion-padding",style:{width:"100%"},disabled:""},{default:n(()=>[k(ue(e.enrollmentStatus),1)]),_:1})]),_:1})]),_:1}),e.isEnrolled?(I(),M(W,{key:1},[e.outcomes?(I(),U(V,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[t(_,{"date-enrolled":e.enrollDate,birthdate:e.birthdate,outcomes:e.outcomes,onSaveOutcome:e.saveOutcome},null,8,["date-enrolled","birthdate","outcomes","onSaveOutcome"])]),_:1})):F("",!0),t(V,{class:"his-card",style:Bt({minHeight:e.totalStates?"0":"30vh"})},{default:n(()=>[t(g,{size:"12",class:"ion-no-padding"},{default:n(()=>{var $;return[t(A,{patientStates:($=e.program)==null?void 0:$.patient_states,onVoidOutcome:e.voidOutcome},null,8,["patientStates","onVoidOutcome"])]}),_:1})]),_:1},8,["style"])],64)):(I(),U(V,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[t(g,{size:"12"},{default:n(()=>[t(N,{patientProgram:e.patientProgram,birthdate:e.birthdate,onEnrollProgram:e.enrollProgram},null,8,["patientProgram","birthdate","onEnrollProgram"])]),_:1})]),_:1}))]),_:1})]),_:1}),t(T,null,{default:n(()=>[t(u,null,{default:n(()=>[t(w,{color:"primary",onClick:a[0]||(a[0]=$=>e.modal.hide()),slot:"end"},{default:n(()=>[k("Close")]),_:1}),e.isEnrolled?(I(),U(w,{key:0,color:"danger",onClick:e.voidProgram,slot:"end"},{default:n(()=>[k("Void Program")]),_:1},8,["onClick"])):F("",!0)]),_:1})]),_:1})],64)}const Aa=te(Na,[["render",Ra]]),Sa=x({name:"MultiColumnView",components:{IonGrid:ce,IonRow:le,IonCol:C},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(e){const a={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:B(()=>da(e.items,Math.ceil(e.items.length/e.numberOfColumns))),grid:a}}});function Pa(e,a,l,s,c,b){const i=f("ion-col"),u=f("ion-row"),m=f("ion-grid");return I(),U(m,null,{default:n(()=>[t(u,null,{default:n(()=>[(I(!0),M(W,null,Ne(e.computedItems,(y,g)=>(I(),U(i,{key:g,size:e.grid[e.numberOfColumns]},{default:n(()=>[Ft(e.$slots,"default",{entries:y})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const Xe=te(Sa,[["render",Pa]]);class Ta extends de{constructor(a,l=X()){super(a,Pe.HIV_RECEPTION,l)}}class Ca extends de{constructor(a,l=X()){super(a,Pe.ART_ADHERENCE,l)}buildPillCountObs(a,l){return this.buildValueNumber("Number of tablets brought to clinic",l,null,a)}async buildAdherenceObs(a,l,s){return{concept_id:await de.getConceptID("Drug adherence",!0),value_numeric:s,value_drug:l,value_modifier:"%",order_id:a,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(a,l,s){return Math.round(100*(a-l)/(a-s))}calculateExpected(a,l,s,c){const b=c==="QW"?"week":"day",i=this.calcTimeElapsed(s,b);return a-i*parseFloat(l.toString())}calcTimeElapsed(a,l){return Z(this.date).diff(a,l)+1}}class Oa extends de{constructor(a,l=X()){super(a,Pe.APPOINTMENT,l)}}class Ea extends de{constructor(a,l=X()){super(a,Pe.TREATMENT,l)}calculateDosage(a,l){let s=0;return l===0&&(s=a),a==0&&(s=l),a>0&&l>0&&(s=(a+l)/2),s}calculateEquivalentDosage(a,l){return a+l}calculateDrugRunOutDate(a,l){return ea(Z(l).add(a,"days"))}getInstructions(a,l,s,c){return"".concat(a," :- Morning: ").concat(l," ").concat(c,", Evening: ").concat(s," ").concat(c)}toDrugOrder(a,l,s,c){return{drug_inventory_id:a.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(a.am,a.pm),start_date:c,auto_expire_date:this.calculateDrugRunOutDate(s,c),units:a.units,instructions:this.getInstructions(a.drug_name,a.am,a.pm,a.units),dose:this.calculateDosage(a.am,a.pm),frequency:a.frequency,qty:l}}async createDrugOrder(a){return bt.create({encounter_id:this.encounterID,drug_orders:a})}}class ka{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(a,l,s){let c={result:"",color:"",index:s};if(s<=0)return c.index=0,c;if(l<5&&l>0)c.result="Use MUAC to calculate nutrition status",c.color="red";else{l>18&&(l=19);const b=await this.getBMIData(),i=b[a][l];i&&(c=this.buildBounds(Object.keys(i),i,s,b.colors))}return c}static buildBounds(a,l,s,c){const b={result:"",color:"",index:s};return a.forEach(i=>{if(i.indexOf("-")>=0){const u=i.split("-");s>=parseFloat(u[0])&&s<=parseFloat(u[1])&&(b.result=l[i],b.color=c[l[i]])}else if(i.indexOf("<")>=0){const u=i.replace("<","");s<parseFloat(u)&&(b.result=l[i],b.color=c[l[i]])}else if(i.indexOf(">=")>=0){const u=i.replace(">=","");s>=parseFloat(u)&&(b.result=l[i],b.color=c[l[i]])}}),b}static getBMI(a,l,s,c){const b=this.calculateBMI(a,l);return this.getBMIResult(s,c,b)}static calculateBMI(a,l){if(l==0||a==0)return 0;let s=a/l/l*1e4;return s=Math.round(s*10)/10}}class $a extends de{constructor(a,l=X()){super(a,Pe.DISPENSING,l)}buildDispensations(a,l,s){const c=[];for(let b=0;b<s;b++)c.push({drug_order_id:a,date:this.date,quantity:l/s});return c}saveDispensations(a){return he.postJson("/dispensations",{dispensations:a,program_id:this.programID})}}const Ua=x({__name:"PatientVisit",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=B(()=>a.patient.getID()),s=new Xt(l.value),c=new Zt(l.value),b=new Ea(l.value),i=new $a(l.value),u=new Ta(l.value),m=new Ca(l.value),y=new Oa(l.value),g=O(),V=O(),N=O([]),_=O([]),A=O([]),D=O([]),h=B(()=>!(g.value&&a.patient.getAge()>18)),w=B(()=>a.patient.isFemale()),T=O(""),$=a.patient.getBirthdate(),R=O(!1),P=oe({}),r=oe({visitDate:{value:Z().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async o=>new Date(o.value)>new Date(X())?["Visit date cannot be after today's date"]:new Date(o.value)<new Date($)?["Visit date cannot be before patient's birth date"]:null},weight:{value:void 0,label:"Weight",required:!0,computedValue:o=>({tag:"vitals",obs:s.buildValueNumber("Weight",o)}),validation:(o,p)=>(q(o)||!o.value)&&p.patientPresent.value==="No"?null:Fe([()=>se(o),()=>re(o,"DECIMALS"),()=>pt(o,2,250)])},height:{value:void 0,label:"Height",computedValue:o=>({tag:"vitals",obs:s.buildValueNumber("Height",o)}),validation:o=>!h.value||(q(o)||!o.value)&&r.patientPresent.value==="No"?null:Fe([()=>se(o),()=>re(o),()=>pt(o,20,220)])},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:w.value,computedValue:o=>({tag:"consultation",obs:c.buildValueCoded("Is patient pregnant",o)}),validation:async o=>w.value&&se(o)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:w.value,computedValue:o=>({tag:"consultation",obs:c.buildValueCoded("Is patient breast feeding",o)}),validation:async o=>w.value&&se(o)},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:o=>({tag:"appointment",obs:y.buildValueDate("Appointment date",o)}),validation:async(o,p)=>new Date(o.value)<new Date(p.visitDate.value)?["Appointment date cannot be before visit date"]:new Date(o.value)>new Date(T.value)?["Appointment date cannot be after drug run out date"]:null},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:o=>({tag:"reception",obs:u.buildValueCoded("Patient present",o)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:o=>({tag:"reception",obs:u.buildValueCoded("Guardian present",o)})},pillCount:{value:void 0,label:"Pill Count",required:D.value.length>0,validation:async o=>D.value.length>0&&re(o)},regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","INH")}),validation:async(o,p)=>{var d,E;return(((d=p.tbMed.value)==null?void 0:d.label)==="6H"||((E=p.tbMed.value)==null?void 0:E.label)==="3HP (RFP + INH)")&&re(o)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(o,p)=>{var d;return((d=p.tbMed.value)==null?void 0:d.label)==="3HP (RFP + INH)"&&re(o)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:b.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(o,p)=>{var d;return((d=p.tbMed.value)==null?void 0:d.label)==="3HP (INH 300 / RFP 300)"&&re(o)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(o,p)=>{var d;return((d=p.tbMed.value)==null?void 0:d.label)&&re(o)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async o=>Fe([()=>se(o),()=>o.value==="No"||_.value.some(p=>p.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async o=>Fe([()=>se(o),()=>o.value==="No"||A.value.some(p=>p.isChecked)?null:["Please select at least one side effect"]])},tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:o=>({tag:"consultation",obs:c.buildValueCoded("TB Status",o.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async o=>{if(!R.value){if(new Date(o.value)>new Date(X()))return["TB treatment start date cannot be after today's date"];if(new Date(o.value)<new Date($))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:o=>({tag:"consultation",obs:c.buildValueDate("TB treatment start date",o)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:o=>({tag:"consultation",obs:c.buildValueNumber("TB treatment period",o)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:o=>({tag:"consultation",obs:c.buildGroupValueCoded("TB screening method used","chest xray",o)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:o=>({tag:"consultation",obs:c.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",o)})}}),j=async(o,p)=>{const d={label:"Unkown",value:"Unkown",other:[{drug_id:1046,drug_name:"Unknown ARV",am:1,pm:0,units:"",frequency:"Daily (QOD)"}]},E=(await Te.getRegimensByWeight(o,p)).data;return q(E)?[d]:Object.keys(E).map(J=>({label:J,value:J,other:E[J]})).concat([d])};ve(()=>r.regimen.value,o=>{var p;We(),o&&((p=o==null?void 0:o.other)==null||p.forEach(d=>{var E;P[d.drug_name]={label:"".concat((E=d.alternative_drug_name)!=null?E:d.drug_name," given"),value:0,required:!0,validation:J=>re(J,"POSITIVE_INTEGERS")}}))}),ve(r.patientPresent,o=>{o.value==="No"?(r.weight.required=!1,r.weight.error="",r.guardianPresent.value="Yes"):r.weight.required=!0}),ve(r.guardianPresent,o=>{o.value==="No"&&(r.patientPresent.value="Yes")}),ve([()=>r.weight.value,()=>r.tbStatus.value],async([o,p])=>{r.regimen.value=void 0,We();const d=!q(p)&&!p.label.match(/TB Not Suspected/i);o?(N.value=await j(r.weight.value,d),r.patientPresent.value="Yes",r.patientPresent.disabled=!0):!o&&r.weight.required&&(r.patientPresent.value=void 0,r.patientPresent.disabled=!1),r.tbMed.disabled=d||R.value});const ie=()=>{var o,p;return q(P)?1/0:Math.min(...(p=(o=r.regimen.value)==null?void 0:o.other)==null?void 0:p.map(d=>{var E,J,me,ke,$e;return((J=(E=P[d.drug_name])==null?void 0:E.value)!=null?J:0)/(((me=d.am)!=null?me:0)+((ke=d.noon)!=null?ke:0)+(($e=d.pm)!=null?$e:0))||1}))};ve([()=>P,()=>r.pillCount.value,()=>r.visitDate.value],()=>{const o=parseInt(r.pillCount.value)||0,p=ie();p!==1/0&&(T.value=b.calculateDrugRunOutDate(p+o,r.visitDate.value),r.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(Se(T.value),")"),r.nextAppointmentDate.value=T.value)},{deep:!0}),ve(()=>r.visitDate.value,()=>ot());const be=B(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (INH 300 / RFP 300)"}),z=B(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (RFP + INH)"}),S=B(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="6H"}),De=B(()=>r.hasContraindications.value==="Yes"),nt=B(()=>r.hasSideEffects.value==="Yes"),wt=B(()=>{var o;return/Confirmed TB on treatment/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),Dt=B(()=>{var o;return/Suspected/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),It=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Nt=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Rt=ze(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),At=ze(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),ot=async()=>{c.setDate(r.visitDate.value),R.value=!1;const o=await c.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(o)){const p=await c.getFirstValueDatetime("TB treatment start date"),d=await c.getFirstValueNumber("TB treatment period")||6;if(p){const E=Z(r.visitDate.value).diff(p,"months");R.value=E<=d}}r.tbStatus.required=!R.value},St=async o=>{const p=o.height||g.value,d=ka.calculateBMI(o.weight,p);return s.buildValueNumber("BMI",d)},Pt=async()=>{const o=[await c.buildValueCoded("Patient using family planning","No")];return c.getFamilyPlanningMethods().forEach(async d=>{o.push(await c.buildValueCoded(d,"No"))}),o},Tt=async()=>Promise.all(He.getConceptsByCategory("tb_symptom",!0).map(async o=>c.buildGroupValueCoded(o.name,o.name,"No"))),Ct=async()=>{s.setDate(r.visitDate.value),c.setDate(r.visitDate.value),b.setDate(r.visitDate.value),u.setDate(r.visitDate.value),m.setDate(r.visitDate.value),y.setDate(r.visitDate.value),i.setDate(r.visitDate.value),await we(r,async(o,p)=>{var lt,it,rt,st,ut;const d=[];let E=0;if(!q(o.regimen)&&await na(P)){const K=o.regimen.other,Q=oa(P).formData;E=ie(),K.forEach(Y=>d.push(b.toDrugOrder(Y,Q[Y.drug_name],E,o.visitDate)))}else if(!await ye("Are you sure you want to continue without dispensing ART drugs?"))return;if(o.totalCPTGiven&&vt((await Te.getRegimenExtras("Cotrimoxazole",(lt=o.weight)!=null?lt:V.value)).data,"concept_name").filter(K=>K.frequency==="Daily (QOD)").forEach(K=>d.push(b.toDrugOrder(K,o.totalCPTGiven,E,o.visitDate))),(it=o.tbMed)!=null&&it.value){const K=vt((await Te.getRegimenExtras("INH",(rt=o.weight)!=null?rt:V.value)).data,["concept_name","frequency"]),Q=K.find(Y=>Y.concept_name==="Pyridoxine");if(Q&&o.totalPyridoxineGiven&&d.push(b.toDrugOrder(Q,o.totalPyridoxineGiven,E,o.visitDate)),o.totalIPTGiven){const Y=K.find(_e=>_e.concept_name==="Isoniazid"&&(S.value&&_e.frequency==="Daily (QOD)"||z.value&&_e.frequency==="Weekly (QW)"));d.push(b.toDrugOrder(Y,o.totalIPTGiven,E,o.visitDate))}if(o.totalRFPGiven&&z.value){const Y=(await Te.getRegimenExtras("Rifapentine",(st=o.weight)!=null?st:V.value)).data;Y.length&&d.push(b.toDrugOrder(Y[0],o.totalRFPGiven,E,o.visitDate))}if(o.total3HPGiven&&be.value){const Y=(await Te.getRegimenExtras("INH / RFP",(ut=o.weight)!=null?ut:V.value)).data;d.push(b.toDrugOrder(Y[0],o.total3HPGiven,E,o.visitDate))}}if(!q(d)){await b.createEncounter();const Q=(await b.createDrugOrder(d)).data.map(Y=>{const _e=d.find(Et=>Et.drug_inventory_id===Y.drug_inventory_id);return i.buildDispensations(Y.order_id,_e.qty,1)});await i.saveDispensations(Q.flat(1))}const J=await Be(p,"vitals");if(!q(J)){await s.createEncounter();const K=await St(o);await s.saveObservationList([...J,K])}await c.createEncounter();const me=await Be(p,"consultation");me.push(...await c.buildOptionsGroupObs("Malawi ART side effects",_.value)),me.push(...await Tt()),nt.value&&me.push(...await c.buildOptionsGroupObs("Other side effect",A.value)),w.value&&me.push(...await Pt()),await c.saveObservationList(me),await u.createEncounter();const ke=await Be(p,"reception");if(await u.saveObservationList(ke),D.value.length>0){await m.createEncounter();const K=await Promise.all(D.value.map(async Q=>{const Y=m.calculateExpected(Q.quantity,Q.equivalent_daily_dose,Q.order.start_date,Q.frequency),_e=m.calculateAdherence(Q.quantity,o.pillCount,Y);return[await m.buildAdherenceObs(Q.order_id,Q.drug_inventory_id,_e),await m.buildPillCountObs(Q.order_id,o.pillCount)]}));await m.saveObservationList(K.flat(1))}await y.createEncounter();const $e=await Be(p,"appointment");await y.saveObservationList($e),await Ce("Patient visit saved successfully"),await H.hide(),G.emit(L.RELOAD_PATIENT_VISIT_DATA),G.emit(L.RELOAD_STAGING_INFORMATION)})},Ot=async()=>{if(await ye("Are you sure you want to clear all fields?")){for(const o in r)r[o].value="",r[o].error="",r[o].disabled=!1;We(),G.emit(L.ON_CLEAR)}},We=()=>{for(const o in P)delete P[o]};return Ve(async()=>{try{await ot(),g.value=await a.patient.getRecentHeight(),V.value=await a.patient.getRecentWeight(),V.value&&(N.value=await j(V.value)),D.value=(await bt.getLastDrugsReceived(a.patient.getID())).data,r.pillCount.required=D.value.length>0,_.value=He.getConceptsByCategory("contraindication",!0).map(o=>({value:o.concept_id,label:o.name,other:o})),A.value=He.getConceptsByCategory("side_effect",!0).map(o=>({value:o.concept_id,label:o.name,other:o}))}catch(o){at("Form initialization failed. Try to refresh the page"),console.error(o)}}),(o,p)=>(I(),M(W,null,[t(v(xe),null,{default:n(()=>[t(v(Ee),null,{default:n(()=>[t(v(Ze),null,{default:n(()=>[k("Patient Visit")]),_:1})]),_:1})]),_:1}),t(v(et),{class:"ion-padding"},{default:n(()=>[t(v(ce),{style:{width:"100%"}},{default:n(()=>[t(v(le),null,{default:n(()=>[t(v(C),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:r.visitDate,"onUpdate:modelValue":p[0]||(p[0]=d=>r.visitDate=d),form:r,minDate:v($),maxDate:v(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.patientPresent,"onUpdate:modelValue":p[1]||(p[1]=d=>r.patientPresent=d),inline:"",disabled:r.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.guardianPresent,"onUpdate:modelValue":p[2]||(p[2]=d=>r.guardianPresent=d),inline:""},null,8,["modelValue"])]),_:1}),w.value?(I(),M(W,{key:0},[t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.isPregnant,"onUpdate:modelValue":p[3]||(p[3]=d=>r.isPregnant=d),inline:""},null,8,["modelValue"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.isBreastfeeding,"onUpdate:modelValue":p[4]||(p[4]=d=>r.isBreastfeeding=d),inline:""},null,8,["modelValue"])]),_:1})],64)):F("",!0),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.hasContraindications,"onUpdate:modelValue":p[5]||(p[5]=d=>r.hasContraindications=d),inline:""},null,8,["modelValue"]),De.value?(I(),U(Xe,{key:0,items:_.value,numberOfColumns:2},{default:n(({entries:d})=>[(I(!0),M(W,null,Ne(d,E=>(I(),U(v(Ge),{lines:"none",key:E.value},{default:n(()=>[t(v(qe),null,{default:n(()=>[k(ue(E.label),1)]),_:2},1024),t(v(Qe),{slot:"start",modelValue:E.isChecked,"onUpdate:modelValue":J=>E.isChecked=J},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):F("",!0)]),_:1}),t(v(C),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[t(pe,{modelValue:r.hasSideEffects,"onUpdate:modelValue":p[6]||(p[6]=d=>r.hasSideEffects=d),inline:""},null,8,["modelValue"]),nt.value?(I(),U(Xe,{key:0,items:A.value,numberOfColumns:2},{default:n(({entries:d})=>[(I(!0),M(W,null,Ne(d,E=>(I(),U(v(Ge),{lines:"none",key:E.value},{default:n(()=>[t(v(qe),null,{default:n(()=>[k(ue(E.label),1)]),_:2},1024),t(v(Qe),{slot:"start",modelValue:E.isChecked,"onUpdate:modelValue":J=>E.isChecked=J},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):F("",!0)]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.weight,"onUpdate:modelValue":p[7]||(p[7]=d=>r.weight=d),form:r,min:1},null,8,["modelValue","form"])]),_:1}),h.value?(I(),U(v(C),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.height,"onUpdate:modelValue":p[8]||(p[8]=d=>r.height=d),form:r,min:1},null,8,["modelValue","form"])]),_:1})):F("",!0),R.value?F("",!0):(I(),U(v(C),{key:2,class:"ion-margin-vertical",size:h.value?"12":"6"},{default:n(()=>[t(ne,{modelValue:r.tbStatus,"onUpdate:modelValue":p[9]||(p[9]=d=>r.tbStatus=d),options:v(At)},null,8,["modelValue","options"])]),_:1},8,["size"])),wt.value?(I(),M(W,{key:3},[t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:r.tbTreatmentStartDate,"onUpdate:modelValue":p[10]||(p[10]=d=>r.tbTreatmentStartDate=d),form:r,minDate:v($),maxDate:v(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.tbTreatmentPeriod,"onUpdate:modelValue":p[11]||(p[11]=d=>r.tbTreatmentPeriod=d),form:r,min:1},null,8,["modelValue","form"])]),_:1})],64)):Dt.value?(I(),M(W,{key:4},[t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.cxrResult,"onUpdate:modelValue":p[12]||(p[12]=d=>r.cxrResult=d),"custom-options":It},null,8,["modelValue"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.mwrdResult,"onUpdate:modelValue":p[13]||(p[13]=d=>r.mwrdResult=d),"custom-options":Nt},null,8,["modelValue"])]),_:1})],64)):F("",!0),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ne,{modelValue:r.regimen,"onUpdate:modelValue":p[14]||(p[14]=d=>r.regimen=d),options:N.value},null,8,["modelValue","options"])]),_:1}),v(q)(P)?F("",!0):(I(!0),M(W,{key:5},Ne(Object.values(P),(d,E)=>(I(),U(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{"model-value":d,form:P,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.totalCPTGiven,"onUpdate:modelValue":p[15]||(p[15]=d=>r.totalCPTGiven=d),form:r,min:1},null,8,["modelValue","form"])]),_:1}),t(v(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ne,{modelValue:r.tbMed,"onUpdate:modelValue":p[16]||(p[16]=d=>r.tbMed=d),options:v(Rt)},null,8,["modelValue","options"])]),_:1}),S.value||z.value?(I(),U(v(C),{key:6,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.totalIPTGiven,"onUpdate:modelValue":p[17]||(p[17]=d=>r.totalIPTGiven=d),form:r,min:1},null,8,["modelValue","form"])]),_:1})):F("",!0),z.value?(I(),U(v(C),{key:7,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.totalRFPGiven,"onUpdate:modelValue":p[18]||(p[18]=d=>r.totalRFPGiven=d),form:r,min:1},null,8,["modelValue","form"])]),_:1})):F("",!0),be.value?(I(),U(v(C),{key:8,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.total3HPGiven,"onUpdate:modelValue":p[19]||(p[19]=d=>r.total3HPGiven=d),form:r,min:1},null,8,["modelValue","form"])]),_:1})):F("",!0),be.value||z.value||S.value?(I(),U(v(C),{key:9,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.totalPyridoxineGiven,"onUpdate:modelValue":p[20]||(p[20]=d=>r.totalPyridoxineGiven=d),form:r,min:1},null,8,["modelValue","form"])]),_:1})):F("",!0),D.value.length>0?(I(),U(v(C),{key:10,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.pillCount,"onUpdate:modelValue":p[21]||(p[21]=d=>r.pillCount=d),form:r,min:1},null,8,["modelValue","form"])]),_:1})):F("",!0),t(v(C),{size:D.value.length>0?"6":"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:r.nextAppointmentDate,"onUpdate:modelValue":p[22]||(p[22]=d=>r.nextAppointmentDate=d),form:r,minDate:r.visitDate.value,maxDate:T.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1},8,["size"])]),_:1})]),_:1})]),_:1}),t(v(tt),null,{default:n(()=>[t(v(Ee),null,{default:n(()=>[t(v(ae),{color:"primary",onClick:p[23]||(p[23]=d=>v(H).hide()),slot:"end"},{default:n(()=>[k("Close")]),_:1}),t(v(ae),{color:"warning",onClick:Ot,slot:"end"},{default:n(()=>[k("Reset")]),_:1}),t(v(ae),{color:"success",onClick:Ct,slot:"end"},{default:n(()=>[k("Save")]),_:1})]),_:1})]),_:1})],64))}});const Ba=te(Ua,[["__scopeId","data-v-8a4de3a4"]]),Fa=x({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:ht,IonCard:Ht,IonCardHeader:Mt,IonCardTitle:qt,IonCardContent:Gt,IonButton:ae},setup(e){const a=O([]),l=B(()=>e.patient.getID()),s=oe({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),c=O([{label:"Add Visit",action:async()=>{await H.show(Ba,{patient:e.patient})}},{label:"Update Outcome",action:async()=>H.show(Aa,{patient:e.patient})},{label:"Enter VL Results",action:async()=>H.show(Vt,{patient:e.patient})}]),b=_=>{const A=e.startDate!=="N/A"?"("+Z(_).diff(e.startDate,"months")+"M)":"";return"".concat(Se(_)," ").concat(A)},i=O([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To"},{path:"weight",label:"Weight (Kg)"},{path:"height",label:"Height (cm)"},{path:"bmi",label:"BMI"},...e.patient.isFemale()?[{path:"pregnant",label:"Preg"},{path:"breastfeeding",label:"B/F"}]:[],{path:"tbStatus",label:"TB Status"},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:_=>_.length>0?"Yes":"No"},{path:"regimen",label:"ART Regimen",drillable:!0},{path:"nextAppointment",label:"Next Appointment"},{path:"outcome",label:"Outcome"},{path:"vlResult",label:"Viral Load"}]),u=_=>({title:"Side effects noted on ".concat(_.row.visitDate),rows:_.row.sideEffects.map(A=>({sideEffect:A})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),m=_=>({title:"Drugs dispensed on ".concat(_.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:_.row.drugs.map(A=>({name:A[0],quantity:A[1],units:"tab (s)"}))}),y=async _=>{const A=/regimen/i.test(_.column.path)?m(_):u(_);q(A.rows)||await H.show(la,A)},g=[{label:"void",icon:Lt,color:"danger",action(_,A){xt(async D=>{var w;const h=await mt.getEncounters(l.value,{date:_.date});h.ok?((w=h.data)==null||w.forEach(async T=>{await mt.voidEncounter(T.encounter_id,D)}),a.value.splice(A,1)):at(h.errorMessage||"Failed to void encounters")},"small-modal")}}],V=async _=>_.tb_status.match(/Unknown/i)||_.outcome==="Defaulted"?"":He.getCachedConceptName(_.tb_status),N=()=>{Le.getPatientVisits(l.value,!0).then(async _=>{a.value=[];for(const A of _){const D=(await _t.getCurrentProgramInformation(l.value,A)).data;let h="",w="",T="",$="";if(D.outcome!=="Defaulted"){const R=await Ue.getFirstValueDatetime(l.value,"appointment date",A);if(R&&(h=Se(R)),w=await Ue.getFirstValueCoded(l.value,"Is patient pregnant",A),T=await Ue.getFirstValueCoded(l.value,"Is patient breast feeding",A),D.viral_load==="N/A"){const P=await Ue.getFirstObs(l.value,"HIV viral load",A);P&&P.value_text&&P.value_numeric&&($=P.value_numeric===1?"LDL":P.value_text+P.value_numeric.toString())}else $=D.viral_load}D&&a.value.push({visitDate:b(A),visitBy:D.visit_by.match(/Unk/i)?"":D.visit_by,weight:D.outcome==="Defaulted"?"":D.weight,height:D.outcome==="Defaulted"?"":D.height,bmi:D.outcome==="Defaulted"?"":D.bmi,pregnant:w,breastfeeding:T,tbStatus:await V(D),sideEffects:D.outcome==="Defaulted"?"":D.side_effects,regimen:D.outcome==="Defaulted"?"":D.regimen,nextAppointment:h,outcome:D.outcome.match(/Unk/i)?"":D.outcome,vlResult:$,drugs:D.pills_dispensed,date:A})}})};return G.on(L.RELOAD_PATIENT_VISIT_DATA,()=>N()),Ve(()=>{N()}),{actionButtons:c,tableConfig:s,rowButtons:g,columns:i,rows:a,onDrilldownHandler:y}}});const Ha=e=>(zt("data-v-c585a8e7"),e=e(),Wt(),e),Ma=Ha(()=>fe("span",{class:"title"},"Summary of Visits",-1)),qa={class:"ion-float-right ion-margin-end ion-margin-bottom"};function Ga(e,a,l,s,c,b){const i=f("ion-icon"),u=f("ion-button"),m=f("ion-card-title"),y=f("ion-card-header"),g=f("data-table"),V=f("ion-card-content"),N=f("ion-card");return I(),U(N,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[t(y,null,{default:n(()=>[t(m,null,{default:n(()=>[Ma,fe("span",qa,[(I(!0),M(W,null,Ne(e.actionButtons,_=>(I(),U(u,{key:_.label,onClick:_.action,color:_.color||"primary"},{default:n(()=>[_.icon?(I(),U(i,{key:0,icon:_.icon,class:"ion-margin-right"},null,8,["icon"])):F("",!0),k(" "+ue(_.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),t(V,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[t(g,{rows:e.rows,columns:e.columns,"row-actions-buttons":e.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:e.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const La=te(Fa,[["render",Ga],["__scopeId","data-v-c585a8e7"]]),za=x({components:{MultiColumnView:Xe,IonList:Yt,IonItem:Ge},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(e,{emit:a}){const l=O(0),s=O(0),c=O(0),b=O(""),i=O(""),u=O(""),m=O(""),y=O(""),g=O(""),V=O(""),N=O(""),_=O(""),A=O(""),D=O(""),h=S=>S.other&&typeof S.other.onClickHandler=="function",w=B(()=>!q(e.guardians)),T=async S=>{var De;h(S)&&await((De=S.other)==null?void 0:De.onClickHandler())},$=()=>{const S=e.patient.getBirthdate(),De=e.artStartDate!=="N/A"?Z(e.artStartDate).diff(S,"years"):"";return"".concat(Se(S)," (").concat(De,")")},R=()=>{Ae.getlatestViralLoadResult(e.patient.getID()).then(S=>A.value=S)},P=()=>({onClickHandler(){jt.push("/patient/reception/".concat(e.patient.getID(),"/false"))}}),r=()=>w.value?e.guardians.map(S=>"".concat(S.name," (").concat(S.relationshipType,")")).join(","):"Add",j=()=>({onClickHandler:()=>a("updatePatient")}),ie=B(()=>[{label:"ARV Number",value:e.patient.getArvNumber(),other:{onClickHandler:()=>a("updateARVNumber")}},{label:"MW National ID",value:e.patient.getMWNationalID(),other:j()},{label:"Name",value:e.patient.getGivenName()+" "+e.patient.getFamilyName(),other:j()},{label:"DOB and Age at Initiation",value:$(),other:j()},{label:"Sex",value:ca(e.patient.getGender()),other:j()},{label:"Location",value:e.patient.getCurrentVillage(),other:j()},{label:"Landmark",value:e.patient.getClosestLandmark(),other:j()},{label:"Phone Number",value:e.patient.getPhoneNumber(),other:j()},{label:"Guardian",value:r(),other:{onClickHandler:()=>a("updateGuardian")}},{label:"Agrees to follow up",value:y.value,other:P()},{label:"Date of starting first line ARV Regimen",value:e.artStartDate,other:P()},{label:"Initial Weight (KG)",value:l.value,other:P()},{label:"Initial Height (CM)",value:s.value,other:P()},{label:"Initial BMI",value:c.value,other:P()},{label:"Initial TB Status",value:b.value,other:P()},{label:"Pregnant at Initiation",value:u.value,other:P()},{label:"Breastfeeding at Initiation",value:i.value,other:P()},{label:"Latest VL Result and Result Date",value:A.value,other:{onClickHandler:()=>H.show(Vt,{patient:e.patient})}},{label:"TI",value:m.value,other:P()},{label:"HIV test place",value:N.value,other:P()},{label:"HIV test date",value:V.value,other:P()},{label:"WHO stage",value:D.value,other:P()},{label:"Reason for starting ART",value:g.value,other:P()},{label:"Staging codition",value:_.value,other:P()}]),be=async()=>{const S=await e.patient.getHIVTestDate();S&&(V.value=Se(S))},z=()=>{e.patient.getInitialWeight().then(S=>l.value=S),e.patient.getInitialHeight().then(S=>s.value=S),e.patient.getInitialBMI().then(S=>c.value=S),e.patient.getInitialTBStatus().then(S=>b.value=S),e.patient.hasPregnancyAtARTInitiation().then(S=>u.value=S),e.patient.breastFeedingAtARTInitiation().then(S=>i.value=S),e.patient.everReceivedART().then(S=>m.value=S),e.patient.agreesToFollowUp().then(S=>y.value=S),e.patient.getReasonForStartingART().then(S=>g.value=S),e.patient.getHIVTestLocation().then(S=>N.value=S),e.patient.getStagingCondition().then(S=>_.value=S),e.patient.getWhoStage().then(S=>D.value=S),be()};return Ve(()=>{z(),R(),G.on(L.RELOAD_LATEST_VL_RESULT,()=>R()),G.on(L.RELOAD_STAGING_INFORMATION,()=>z())}),{patientInfo:ie,onClickHandler:T,clickable:h}}});const Wa={style:{width:"100%",display:"flex",justifyContent:"space-between"}},Ya={key:0},ja={key:1},Ja={key:2},Qa={key:3};function Ka(e,a,l,s,c,b){const i=f("ion-item"),u=f("ion-list"),m=f("multi-column-view");return I(),U(m,{items:e.patientInfo,numberOfColumns:3},{default:n(({entries:y})=>[t(u,{class:"his-card ion-margin-end"},{default:n(()=>[(I(!0),M(W,null,Ne(y,(g,V)=>(I(),U(i,{key:V,lines:V===y.length-1?"none":void 0,button:e.clickable(g),onClick:N=>e.onClickHandler(g)},{default:n(()=>[fe("div",Wa,[g.label?(I(),M("span",Ya,ue(g.label)+": ",1)):(I(),M("span",ja)),e.clickable(g)?(I(),M("span",Ja,[fe("a",null,[fe("b",null,ue(g.value||"N/A"),1)])])):(I(),M("span",Qa,[fe("b",null,ue(g.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const Xa=te(za,[["render",Ka],["__scopeId","data-v-2be31ecd"]]),Za=x({components:{IonGrid:ce,IonRow:le,IonCol:C,TextInput:Re,DateInput:ge,SelectInput:ne},props:{patientService:{type:Object,required:!0}},setup(e){const a=O(!1),l=B(()=>/Unknown/i.test(e.patientService.getMWNationalID())?"":e.patientService.getMWNationalID()),s=oe({givenName:{label:"First Name",value:e.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:i=>Oe(i)},familyName:{label:"last Name",value:e.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:i=>Oe(i)},middleName:{label:"middle Name",value:e.patientService.getMiddleName(),placeholder:"middle Name",validation:i=>!!i&&Oe(i)},nationalId:{label:"Malawi National ID Number",value:l.value,placeholder:"Enter Malawi National ID Number",validation:i=>i&&i.label?ua(i):null},gender:{value:e.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:e.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:e.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async i=>!(i.value==="Unknown"||i.value==="N/A")&&yt(i)},homeVillage:{value:e.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:e.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),c=async i=>{var y,g,V,N,_;let u,m;try{(y=i==null?void 0:i.other)!=null&&y.traditional_authority_id&&(u=await ct.getTraditionalAuthorityById(i.other.traditional_authority_id)),u&&(m=await ct.getDistrictByID(u.district_id))}catch(A){at("Unable to resolve patient address. Saving using default address"),console.error(A)}return{home_district:(g=m==null?void 0:m.name)!=null?g:"N/A",home_traditional_authority:(V=u==null?void 0:u.name)!=null?V:"N/A",home_village:(i==null?void 0:i.label)||"N/A",current_district:(N=m==null?void 0:m.name)!=null?N:"N/A",current_traditional_authority:(_=u==null?void 0:u.name)!=null?_:"N/A",current_village:(i==null?void 0:i.label)||"N/A"}};return{today:X,patient:s,getLandmarks:ra,genderOptions:aa,isBirthdateEstimated:a,modal:H,onFinish:async()=>we(s,async i=>{const u={};if(i.givenName!==e.patientService.getGivenName()&&(u.given_name=i.givenName),i.familyName!==e.patientService.getFamilyName()&&(u.family_name=i.familyName),i.middleName!==e.patientService.getMiddleName()&&(u.middle_name=i.middleName),i.birthdate!==e.patientService.getBirthdate()&&(u.birthdate=i.birthdate),i.gender.value!==e.patientService.getGender()&&(u.gender=i.gender.value),i.cellPhoneNumber!==e.patientService.getPhoneNumber()&&(u.cell_phone_number=i.cellPhoneNumber),i.landmark.label!==e.patientService.getClosestLandmark()&&(u.landmark=i.landmark.label),i.homeVillage!==e.patientService.getCurrentVillage()&&Object.assign(u,{...u,...await c(i.homeVillage)}),!q(u)){const m=new Ke;m.setPersonID(e.patientService.getID()),await m.updatePerson(u)}i.nationalId!==l.value&&await e.patientService.updateMWNationalId(i.nationalId),await H.hide(),G.emit(L.RELOAD_PATIENT_DATA)}),getVillagesByName:sa}}});function xa(e,a,l,s,c,b){const i=f("ion-title"),u=f("ion-icon"),m=f("ion-button"),y=f("ion-buttons"),g=f("ion-toolbar"),V=f("ion-header"),N=f("TextInput"),_=f("ion-col"),A=f("SelectInput"),D=f("DateInput"),h=f("ion-row"),w=f("ion-grid"),T=f("ion-content"),$=f("ion-footer");return I(),M(W,null,[t(V,null,{default:n(()=>[t(g,null,{default:n(()=>[t(i,null,{default:n(()=>[k("Edit Patient Demographics")]),_:1}),t(y,{slot:"end"},{default:n(()=>[t(m,{onClick:a[0]||(a[0]=R=>e.modal.hide())},{default:n(()=>[t(u,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(T,{class:"ion-padding"},{default:n(()=>[t(w,null,{default:n(()=>[t(h,null,{default:n(()=>[t(_,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.givenName,"onUpdate:modelValue":a[1]||(a[1]=R=>e.patient.givenName=R)},null,8,["modelValue"])]),_:1}),t(_,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.middleName,"onUpdate:modelValue":a[2]||(a[2]=R=>e.patient.middleName=R)},null,8,["modelValue"])]),_:1}),t(_,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.familyName,"onUpdate:modelValue":a[3]||(a[3]=R=>e.patient.familyName=R)},null,8,["modelValue"])]),_:1}),t(_,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.nationalId,"onUpdate:modelValue":a[4]||(a[4]=R=>e.patient.nationalId=R)},null,8,["modelValue"])]),_:1}),t(_,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(A,{modelValue:e.patient.gender,"onUpdate:modelValue":a[5]||(a[5]=R=>e.patient.gender=R),options:e.genderOptions},null,8,["modelValue","options"])]),_:1}),t(_,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(D,{modelValue:e.patient.birthdate,"onUpdate:modelValue":a[6]||(a[6]=R=>e.patient.birthdate=R),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:e.today,onIsEstimated:a[7]||(a[7]=R=>e.isBirthdateEstimated=R)},null,8,["modelValue","maxDate"])]),_:1}),t(_,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.cellPhoneNumber,"onUpdate:modelValue":a[8]||(a[8]=R=>e.patient.cellPhoneNumber=R),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(_,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(A,{modelValue:e.patient.homeVillage,"onUpdate:modelValue":a[9]||(a[9]=R=>e.patient.homeVillage=R),asyncOptions:e.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),t(_,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(A,{modelValue:e.patient.landmark,"onUpdate:modelValue":a[10]||(a[10]=R=>e.patient.landmark=R),asyncOptions:e.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),t($,null,{default:n(()=>[t(g,null,{default:n(()=>[t(m,{color:"primary",onClick:a[11]||(a[11]=R=>e.modal.hide()),slot:"end"},{default:n(()=>[k("Close")]),_:1}),t(m,{class:"ion-margin-end",color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[k("Save")]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const en=te(Za,[["render",xa]]),tn=x({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(e){var A,D;const a=new Ke,l=e,s=O(q(l.guardians)),c=B(()=>"".concat(s.value?"Add":"Edit"," Guardian Demographics")),b=B(()=>"".concat(s.value?"Edit":"Add"," Guardian")),i=O([]),u=(D=(A=l.guardians)==null?void 0:A.map(h=>({label:"".concat(h.name," (").concat(h.relationshipType,")"),value:h.name,other:h})))!=null?D:[],m=oe({label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}),y=oe({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:h=>Oe(h)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:h=>Oe(h)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async h=>h.value!=="Unknown"&&yt(h)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});ve(()=>m.value,h=>{var w,T,$,R,P,r,j,ie;y.givenName.value=(T=(w=h==null?void 0:h.other)==null?void 0:w.names.given_name)!=null?T:"",y.familyName.value=(R=($=h==null?void 0:h.other)==null?void 0:$.names.family_name)!=null?R:"",y.cellPhoneNumber.value=(r=(P=h==null?void 0:h.other)==null?void 0:P.phoneNumber)!=null?r:"",y.relation.value=(ie=(j=h==null?void 0:h.other)==null?void 0:j.relationshipType)!=null?ie:""},{deep:!0,immediate:!0});function g(){s.value=!s.value,m.value=""}async function V(h){var w,T;await a.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:l.patientId,...h}),await je.createRelation(l.patientId,a.getPersonID(),(T=(w=h.relation)==null?void 0:w.value)!=null?T:13)}async function N(h,w){var R,P;const T=w.names.person_id,$={};if(w.names.given_name!==h.given_name&&($.given_name=h.given_name),w.names.family_name!==h.family_name&&($.family_name=h.family_name),w.phoneNumber!==h.cell_phone_number&&($.cell_phone_number=h.cell_phone_number),!q($)){const r=new Ke;r.setPersonID(T),await r.updatePerson($)}w.relationshipType!==h.relation.label&&await je.amendRelation(l.patientId,T,w.id,(P=(R=h.relation)==null?void 0:R.value)!=null?P:13)}const _=async()=>we(y,async h=>{!s.value&&!q(m.value)?await N(h,m.value.other):await V(h),await H.hide(),G.emit(L.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return Ve(async()=>{const h=(await je.getRelations()).data;i.value=h.map(w=>({label:w.b_is_to_a,value:w.relationship_type_id,other:w}))}),(h,w)=>{const T=f("ion-title"),$=f("ion-icon"),R=f("ion-button"),P=f("ion-buttons"),r=f("ion-toolbar"),j=f("ion-header"),ie=f("ion-content"),be=f("ion-footer");return I(),M(W,null,[t(j,null,{default:n(()=>[t(r,null,{default:n(()=>[t(T,null,{default:n(()=>[k(ue(c.value),1)]),_:1}),t(P,{slot:"end"},{default:n(()=>[t(R,{onClick:w[0]||(w[0]=z=>v(H).hide())},{default:n(()=>[t($,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(ie,{class:"ion-padding"},{default:n(()=>[t(v(ce),null,{default:n(()=>[t(v(le),null,{default:n(()=>[s.value?F("",!0):(I(),U(v(C),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(ne,{modelValue:m,"onUpdate:modelValue":w[1]||(w[1]=z=>m=z),options:v(u)},null,8,["modelValue","options"])]),_:1})),m.value||s.value?(I(),M(W,{key:1},[t(v(C),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Re,{modelValue:y.givenName,"onUpdate:modelValue":w[2]||(w[2]=z=>y.givenName=z)},null,8,["modelValue"])]),_:1}),t(v(C),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Re,{modelValue:y.familyName,"onUpdate:modelValue":w[3]||(w[3]=z=>y.familyName=z)},null,8,["modelValue"])]),_:1}),t(v(C),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Re,{modelValue:y.cellPhoneNumber,"onUpdate:modelValue":w[4]||(w[4]=z=>y.cellPhoneNumber=z),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(v(C),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(ne,{modelValue:y.relation,"onUpdate:modelValue":w[5]||(w[5]=z=>y.relation=z),options:i.value},null,8,["modelValue","options"])]),_:1})],64)):F("",!0)]),_:1})]),_:1})]),_:1}),t(be,null,{default:n(()=>[t(r,null,{default:n(()=>[v(q)(l.guardians)?F("",!0):(I(),U(R,{key:0,color:"primary",onClick:g,slot:"start"},{default:n(()=>[k(ue(b.value),1)]),_:1})),t(R,{color:"primary",onClick:w[6]||(w[6]=z=>v(H).hide()),slot:"end"},{default:n(()=>[k("Close")]),_:1}),t(R,{class:"ion-margin-end",color:"success",onClick:_,slot:"end"},{default:n(()=>[k("Save")]),_:1})]),_:1})]),_:1})],64)}}}),an=x({components:{IonGrid:ce,IonRow:le,IonCol:C,TextInput:Re},props:{patient:{type:Object,required:!0}},setup(e){const{facility:a}=gt(),l=B(()=>e.patient.getArvNumber()),s=B(()=>!q(l.value)&&l.value!=="Unknown"),c=oe({arvNumber:{value:s.value?l.value.split("-")[2]:"",label:"".concat(s.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async u=>{const m=re(u,"POSITIVE_INTEGERS");if(m!==null)return m;if(u.value===l.value.split("-")[2])return null;const y=await Le.findByOtherID(4,"".concat(a.code,"-ARV-").concat(u.value));return y.ok?q(y.data)?null:["ARV Number already taken"]:[y.errorMessage||y.clientErrorType||"Unable to determine ARV number with status: ".concat(y.httpStatusResponse)]}}});return{form:c,modal:H,arvNumber:l,facility:a,hasValidARVNumber:s,onFinish:async()=>we(c,async u=>{u.arvNumber!==l.value.split("-")[2]&&(s.value?await e.patient.updateARVNumber("".concat(a.code,"-ARV-").concat(u.arvNumber)):await e.patient.createArvNumber("".concat(a.code,"-ARV-").concat(u.arvNumber)),G.emit(L.RELOAD_PATIENT_DATA)),await H.hide()}),voidARV:async()=>{if(await ye("Are you sure you want to void this ARV Number ".concat(l.value,"?"))){await Je.show("Voiding ARV Number...");try{await _t.voidARVNumber(l.value),await Je.hide(),await H.hide(),G.emit(L.RELOAD_PATIENT_DATA)}catch(m){await Je.hide(),console.log(m)}}}}}});function nn(e,a,l,s,c,b){const i=f("ion-title"),u=f("ion-icon"),m=f("ion-button"),y=f("ion-buttons"),g=f("ion-toolbar"),V=f("ion-header"),N=f("text-input"),_=f("ion-col"),A=f("ion-row"),D=f("ion-grid"),h=f("ion-content"),w=f("ion-footer");return I(),M(W,null,[t(V,null,{default:n(()=>[t(g,null,{default:n(()=>[t(i,null,{default:n(()=>[k("ARV NUMBER")]),_:1}),t(y,{slot:"end"},{default:n(()=>[t(m,{onClick:a[0]||(a[0]=T=>e.modal.hide())},{default:n(()=>[t(u,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(h,{class:"ion-padding"},{default:n(()=>[t(D,null,{default:n(()=>[t(A,null,{default:n(()=>[t(_,null,{default:n(()=>[t(N,{modelValue:e.form.arvNumber,"onUpdate:modelValue":a[1]||(a[1]=T=>e.form.arvNumber=T),form:e.form,prefix:"".concat(e.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),t(w,{class:"ion-padding-horizontal"},{default:n(()=>[t(g,null,{default:n(()=>[t(m,{color:"primary",onClick:a[2]||(a[2]=T=>e.modal.hide()),slot:"end"},{default:n(()=>[k("Close")]),_:1}),e.hasValidARVNumber?(I(),U(m,{key:0,color:"danger",onClick:e.voidARV,slot:"start"},{default:n(()=>[k("Void ARV Number")]),_:1},8,["onClick"])):F("",!0),t(m,{color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[k("Save")]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const on=te(an,[["render",nn]]),ln=x({components:{VisitsSummary:La,InformationHeader:Xa},setup(){const e=Jt(),a=parseInt(e.params.patientId.toString())||0,l=O(),s=O(""),c=O([]),b=B(()=>!q(l.value)),i=async()=>{if(a){const V=(await Le.findByID(a)).data;V&&(l.value=new Le(V))}},u=async()=>{c.value=await pa.getGuardianDetails(a)},m=async V=>{await H.show(en,{patientService:l.value,attribute:V})},y=async()=>{await H.show(tn,{patientId:a,guardians:c.value})},g=async()=>{await H.show(on,{patient:l.value})};return G.on(L.RELOAD_PATIENT_DATA,async()=>{await i()}),G.on(L.RELOAD_GUARDIAN_DATA,async()=>{await u()}),Ve(async()=>{var N;await i();const V=await((N=l.value)==null?void 0:N.getARTStartDate());s.value=V?ft.toStandardHisDisplayFormat(V):"N/A",await u()}),{patient:l,artStartDate:s,guardians:c,isReady:b,updateDemographics:m,updateGuardian:y,updateARVNumber:g}}});function rn(e,a,l,s,c,b){const i=f("information-header"),u=f("ion-col"),m=f("ion-row"),y=f("visits-summary"),g=f("ion-grid");return e.isReady?(I(),U(g,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[t(m,null,{default:n(()=>[t(u,{size:"12"},{default:n(()=>[e.patient?(I(),U(i,{key:0,patient:e.patient,guardians:e.guardians,artStartDate:e.artStartDate,onUpdateARVNumber:e.updateARVNumber,onUpdateGuardian:e.updateGuardian,onUpdatePatient:e.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):F("",!0)]),_:1})]),_:1}),t(m,null,{default:n(()=>[t(u,null,{default:n(()=>[e.patient?(I(),U(y,{key:0,patient:e.patient,startDate:e.artStartDate},null,8,["patient","startDate"])):F("",!0)]),_:1})]),_:1})]),_:1})):F("",!0)}const Hn=te(ln,[["render",rn]]);export{Hn as default};
