var jt=Object.defineProperty;var Yt=(a,t,l)=>t in a?jt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l;var wt=(a,t,l)=>(Yt(a,typeof t!="symbol"?t+"":t,l),l);import{K as De,k as mt,d as ae,r as E,aj as ce,a8 as _e,i as he,c as z,e,w as n,u as i,M as J,o as R,v as se,a2 as We,b as k,U as Ee,l as ve,m as oe,n as O,L as Ge,x as ze,aB as st,G as ke,I as Q,am as H,s as $e,aq as Ne,h as q,_ as be,N as w,a as fe,j as F,A as G,W as At,P as Ie,t as ue,Y as Jt,aF as Qt,aG as Tt,aH as Xt,aI as Kt,aJ as lt,aK as Zt,a7 as ea,aL as ta,p as aa,a6 as na,aM as la,aN as oa,ak as ia,aD as Dt,ar as sa,aO as ra}from"./index-cea95aa1.js";import{g as ua,D as ct,C as Qe,P as He,O as Je}from"./patient_service-6f7f49fb.js";import{g as ot,i as Y}from"./common-abc2f84d.js";import{A as de,u as et,V as da,C as ma,E as It}from"./consultation_service-93d28a44.js";import{p as St}from"./VoidReason-82640d50.js";import{a as X,t as pe,d as ee,e as pt,f as ca}from"./his_date-61f0525f.js";import{_ as ge}from"./DateInput.vue_vue_type_style_index_0_lang-579a8ddd.js";import{S as me}from"./SelectInput-a73832c0.js";import{N as ie,R as Te}from"./regimen_service-ee223dc4.js";import{e as Re}from"./encounter_types-1e88a09d.js";import{s as pa,a as Xe,c as va,u as Nt}from"./arrays-1b521787.js";import{s as Ue,i as Ke,r as rt,a as qe}from"./form-b8f6250f.js";import{E as W,a as x}from"./emc_event-4721851b.js";import{a as Ce,t as Be}from"./toasts-3ce877d4.js";import{D as Ze}from"./Date-4221c74c.js";import{D as vt}from"./index-b9b8006b.js";import{l as le}from"./loader-464dccb0.js";import{d as Pt,r as ye,v as Me,e as fa,f as re,g as Rt,a as Le,b as ga,c as Ot}from"./validations-62a32052.js";import{T as Se}from"./TextInput-375e5b52.js";import{g as Ct,a as ba,b as _a}from"./location_options-4852fc12.js";import{t as ya,g as ha}from"./DTFormElements-9dbc03af.js";import{Y as we}from"./YesNoInput-37dbb1f3.js";import{D as Va}from"./DrilldownTable-195b2a77.js";import{t as wa,i as Da}from"./Strs-0c962638.js";import{P as ut,R as it}from"./relations_service-0d399bf4.js";import{r as Ia,d as Na,h as Ra,a as Aa}from"./dde-a4be54e9.js";import"./patient_identifier_service-2b86717b.js";import"./vue-datepicker-f625d37c.js";const Ta=a=>{const t=a.given_name,l=a.family_name,u=a.middle_name?a.middle_name:"";return"".concat(t," ").concat(u," ").concat(l)};class Sa{static getRelationships(t){return De.getJson("/people/".concat(t,"/relationships")).then(l=>l.data)}static async getGuardianDetails(t){return await this.getRelationships(t).then(l=>l.map(u=>{const m=ot(u,"relation.names[0]");return{id:u.relationship_id,name:m?Ta(m):"",relationshipType:ot(u,"type.b_is_to_a",""),phoneNumber:ua(ot(u,"relation.person_attributes",[]),12),names:m}}))}}const Oe=class Oe extends de{constructor(t){super(t,Re.LAB_ORDERS,X())}async loadConcepts(){Oe.conceptID=await de.getConceptID("HIV Viral Load")}createLabOrder(t,l){const u=De.getUsername(),m=mt().facility.name,h=de.getCachedConceptID(l,!0);return De.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:u,target_lab:m,reason_for_test_id:h,encounter_id:this.encounterID,tests:[{concept_id:Oe.conceptID}],date:this.date,specimen:{concept_id:t}}]})}createLabResult(t,l,u,m="numeric"){return De.postJson("lab/tests/".concat(t,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Oe.conceptID},value:l,value_modifier:u,value_type:m}]})}static getSpecimens(t){return De.getJson("/lab/specimen_types",{test_type:t})}static async getOrders(t,l={}){var m;return(m=(await De.getJson("/lab/orders",{patient_id:t,...l})).data)!=null?m:[]}static async getViralLoadResultTrail(t,l={}){return(await this.getOrders(t,l)).reduce((m,h)=>(h.tests.forEach(s=>s.result.forEach(d=>m.push({...h,test:s.name,result:"".concat(d.value_modifier," ").concat(d.value),result_date:d.date}))),m),[])}static async getlatestViralLoadResult(t,l={}){const m=(await this.getOrders(t,l)).flatMap(s=>s.tests.flatMap(d=>d.result)).filter(Boolean);if(Y(m))return"N/A";const h=pa(m,"date","desc")[0];return"".concat(h.value_modifier).concat(h.value," (").concat(pe(h.date),")")}};wt(Oe,"conceptID",-1);let Pe=Oe;const Pa=ae({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=E(!1),u=Xe(["=",">","<",">=","<="]),m=Xe(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),h=E([]),s=t.patient.getBirthdate(),d=ce({orderDate:{value:"",label:"Order Date",required:!0,validation:async b=>ee(b.value).isValid()?new Date(b.value)>new Date(X())?["Order date cannot be in the future"]:new Date(b.value)<new Date(s)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(b,g)=>ee(b.value).isValid()?new Date(b.value)>new Date(X())?["Result date cannot be in the future"]:new Date(b.value)<new Date(g.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function f(){Ue(d,async b=>{const g=new Pe(t.patient.getID());if(await g.loadConcepts(),g.setDate(b.orderDate),!await g.createEncounter())throw new Error("Unable to create lab order encounter");const A=await g.createLabOrder(b.specimen.value,b.reason.value);if(!A.ok||!A.data)throw new Error("Unable to save lab orders");const C=new Pe(t.patient.getID());if(C.setDate(b.resultDate),!await C.createEncounter())throw new Error("Unable to create lab result encounter");const _=l.value?"LDL":parseInt(b.result),D=l.value?"=":b.modifier.value,S=l.value?"text":"numeric",B=A.data[0].tests[0].id;await C.createLabResult(B,_,D,S),await H.hide(),W.emit(x.RELOAD_LATEST_VL_RESULT),W.emit(x.RELOAD_PATIENT_VISIT_DATA)})}async function V(){if(await Ne("Are you sure you want to clear all fields?")){l.value=!1;for(const b in d)d[b].value="",d[b].error="";W.emit(x.ON_CLEAR)}}return _e(l,b=>{b&&(d.modifier.value="",d.result.value=void 0,d.modifier.error="",d.result.error=""),d.modifier.disabled=b,d.modifier.required=!b,d.result.disabled=b,d.result.required=!b}),he(async()=>{h.value=(await Pe.getSpecimens("HIV viral load")).data.map(b=>({label:b.name,value:b.concept_id}))}),(b,g)=>(R(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>g[8]||(g[8]=[k("Viral Load Results")])),_:1,__:[8]})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(oe),null,{default:n(()=>[e(i(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:d.orderDate,"onUpdate:modelValue":g[0]||(g[0]=T=>d.orderDate=T),form:d,minDate:i(s),maxDate:i(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:d.reason,"onUpdate:modelValue":g[1]||(g[1]=T=>d.reason=T),options:i(m)},null,8,["modelValue","options"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:d.specimen,"onUpdate:modelValue":g[2]||(g[2]=T=>d.specimen=T),options:h.value},null,8,["modelValue","options"])]),_:1}),e(i(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:d.resultDate,"onUpdate:modelValue":g[3]||(g[3]=T=>d.resultDate=T),form:d,minDate:d.orderDate.value,"max-date":i(X)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:d.modifier,"onUpdate:modelValue":g[4]||(g[4]=T=>d.modifier=T),options:i(u)},null,8,["modelValue","options"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:d.result,"onUpdate:modelValue":g[5]||(g[5]=T=>d.result=T),form:d,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),e(i(oe),{class:"ion-margin-top"},{default:n(()=>[e(i(O),{size:"12"},{default:n(()=>[e(i(Ge),{class:"ion-padding-vertical bold"},{default:n(()=>g[9]||(g[9]=[k(" Other Results Options: ")])),_:1,__:[9]}),e(i(ze),null,{default:n(()=>[e(i(Ge),null,{default:n(()=>g[10]||(g[10]=[k("LDL")])),_:1,__:[10]}),e(i(st),{slot:"start",modelValue:l.value,"onUpdate:modelValue":g[6]||(g[6]=T=>l.value=T)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:g[7]||(g[7]=T=>i(H).hide()),slot:"end"},{default:n(()=>g[11]||(g[11]=[k(" Close ")])),_:1,__:[11]}),e(i(Q),{color:"warning",onClick:V,slot:"end"},{default:n(()=>g[12]||(g[12]=[k(" Reset ")])),_:1,__:[12]}),e(i(Q),{color:"success",onClick:f,slot:"end"},{default:n(()=>g[13]||(g[13]=[k(" Save ")])),_:1,__:[13]})]),_:1})]),_:1})],64))}}),Oa=ae({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:vt},emits:["voidOutcome"],setup(a,{emit:t}){const l=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:s=>ee(s).format(Ze)},{path:"end_date",label:"End Date",formatter:s=>ee(s).format(Ze)}],u={showSearchField:!1,showSubmitButton:!1};return{rows:q(()=>a.patientStates.map((s,d)=>({...s,index:d}))),columns:l,tableConfig:u,TableRowActions:[{label:"void",color:"danger",action:async s=>{await Ne("Are you sure you want to void this outcome?")&&t("voidOutcome",{stateId:s.patient_state_id,index:s.index})}}]}}});function Ca(a,t,l,u,m,h){const s=w("data-table");return R(),z(J,null,[t[0]||(t[0]=fe("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1)),e(s,{rows:a.rows,columns:a.columns,config:a.tableConfig,"row-actions-buttons":a.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const Ea=be(Oa,[["render",Ca]]),ka=ae({name:"EnrollmentForm",components:{DateInput:ge,IonGrid:ve,IonRow:oe,IonCol:O,IonButton:Q},props:["birthdate","patientId"],setup(a){const t=ce({programId:{label:"Select program",required:!0,value:""},date:{value:"",label:"Date of Enrollment",required:!0,validation:async s=>Pt(s,a.birthdate)}}),{enrollPatient:l,fetchPatientPrograms:u}=et(a.patientId),m=async()=>{await Ne("Are you sure you want to clear all fields")&&(t.date.value="",t.date.error="",W.emit(x.ON_CLEAR))};async function h(){await Ke(t)&&le.show(),await l(t.date.value),await Ce("Program enrolled successfully"),await H.hide(),u().catch(console.error)}return{form:t,today:X,onReset:m,enrollProgram:h}}});function $a(a,t,l,u,m,h){const s=w("DateInput"),d=w("ion-col"),f=w("ion-button"),V=w("ion-row"),b=w("ion-grid");return R(),F(b,null,{default:n(()=>[e(V,null,{default:n(()=>[e(d,{size:"12"},{default:n(()=>[e(s,{modelValue:a.form.date,"onUpdate:modelValue":t[0]||(t[0]=g=>a.form.date=g),form:a.form,minDate:a.birthdate,"max-date":a.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(d,null,{default:n(()=>[e(f,{color:"warning",onClick:a.onReset},{default:n(()=>t[1]||(t[1]=[k("Reset")])),_:1,__:[1]},8,["onClick"]),e(f,{color:"success",onClick:a.enrollProgram},{default:n(()=>t[2]||(t[2]=[k("Enroll")])),_:1,__:[2]},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Ba=be(ka,[["render",$a]]),Ua=ae({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:ge,IonGrid:ve,IonRow:oe,IonCol:O,IonButton:Q,SelectInput:me,TextInput:Se},emits:["saveOutcome"],setup(a,{emit:t}){const l=ee().format("YYYY-MM-DD"),u=ce({date:{value:"",label:"Outcome Date",required:!0,validation:async f=>new Date(f.value)<new Date(a.birthdate)?["Outcome date cannot be before date of birth - ".concat(ee(a.birthdate).format(Ze))]:new Date(f.value)<new Date(a.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(ee(a.dateEnrolled).format(Ze))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(f,V)=>V.status.value.label==="Patient transferred out"&&ye(f)},reason:{value:"",label:"Reason for transfer out",validation:async(f,V)=>V.status.value.label==="Patient transferred out"&&ye(f)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(f,V)=>{var b,g,T,A;return((g=(b=V.status)==null?void 0:b.value)==null?void 0:g.label)==="Patient transferred out"&&((A=(T=V.reason)==null?void 0:T.value)==null?void 0:A.label)==="Other"&&ye(f)}}}),m=q(()=>{var f;return((f=u.status.value)==null?void 0:f.label)==="Patient transferred out"}),h=q(()=>{var f,V;return((V=(f=u.reason)==null?void 0:f.value)==null?void 0:V.label)==="Other"});return{form:u,today:l,isTransferredOut:m,specifyOther:h,onSave:()=>Ue(u,f=>t("saveOutcome",{...f,isTransferredOut:m.value})),onReset:async()=>{if(await Ne("are you sure you want to clear all fields")){for(const f in u)u[f].value="",u[f].error="";W.emit(x.ON_CLEAR)}},getFacilities:Ct,transferOutReasons:ya}}});function Fa(a,t,l,u,m,h){const s=w("ion-col"),d=w("DateInput"),f=w("SelectInput"),V=w("text-input"),b=w("ion-button"),g=w("ion-row"),T=w("ion-grid");return R(),F(T,null,{default:n(()=>[e(g,null,{default:n(()=>[e(s,{size:"12"},{default:n(()=>t[5]||(t[5]=[fe("p",null,"Add New Outcome",-1)])),_:1,__:[5]}),e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(d,{modelValue:a.form.date,"onUpdate:modelValue":t[0]||(t[0]=A=>a.form.date=A),form:a.form,minDate:a.dateEnrolled,"max-date":a.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(f,{modelValue:a.form.status,"onUpdate:modelValue":t[1]||(t[1]=A=>a.form.status=A),form:a.form,options:a.outcomes},null,8,["modelValue","form","options"])]),_:1}),a.isTransferredOut?(R(),z(J,{key:0},[e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(f,{modelValue:a.form.nextFacility,"onUpdate:modelValue":t[2]||(t[2]=A=>a.form.nextFacility=A),form:a.form,asyncOptions:a.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(f,{modelValue:a.form.reason,"onUpdate:modelValue":t[3]||(t[3]=A=>a.form.reason=A),form:a.form,options:a.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),a.specifyOther?(R(),F(s,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[e(V,{modelValue:a.form.otherReason,"onUpdate:modelValue":t[4]||(t[4]=A=>a.form.otherReason=A),form:a.form},null,8,["modelValue","form"])]),_:1})):G("",!0)],64)):G("",!0),e(s,{size:"12",class:"ion-margin-top"},{default:n(()=>[e(b,{color:"warning",onClick:a.onReset},{default:n(()=>t[6]||(t[6]=[k("Reset")])),_:1,__:[6]},8,["onClick"]),e(b,{color:"success",onClick:a.onSave},{default:n(()=>t[7]||(t[7]=[k("Save")])),_:1,__:[7]},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Ma=be(Ua,[["render",Fa]]),qa={class:"ion-page",id:"main"},Ha={class:"ion-margin-start"},La=ae({__name:"OutcomeStatus",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=E(),u=q(()=>t.patient.getID()),m=q(()=>{var y,N;return(N=(y=l.value)==null?void 0:y.other)==null?void 0:N.date_enrolled}),h=q(()=>pt(t.patient.getBirthdate())),s=q(()=>{var y;return V.value.get((y=l.value)==null?void 0:y.value)}),d=q(()=>{var y,N,$,M;return(M=($=(N=(y=l.value)==null?void 0:y.other)==null?void 0:N.patient_states)==null?void 0:$.length)!=null?M:0}),{patientPrograms:f,programStates:V,hasArtProgram:b,updateState:g,voidProgram:T,voidState:A,fetchPatientPrograms:C}=et(u.value);function I(y){l.value=y}async function _(y,N,$=""){const M=new de(u.value,Re.EXIT_FROM_HIV_CARE,N);if(!await M.createEncounter())throw"Unable to transfer out encounter";return $&&await M.saveValueTextObs("Reason for transfer out",$),M.saveValueTextObs("Transfer to",y.name)}async function D(y){var r;const{date:N,status:$,nextFacility:M,reason:j,otherReason:L,isTransferredOut:P}=y;if(P){const xe=j.value!=="Other"?j.value:L;await _(M.other,N,xe)}await g($.value,N,(r=l.value)==null?void 0:r.value),await Ce("Outcome saved successfully",1e3),await H.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}async function S(){var y,N,$;await T(($=(N=(y=l.value)==null?void 0:y.other)==null?void 0:N.patient_program_id)!=null?$:-1,"duplicate / system error"),await Ce("Patient voided from program successfully",1e3),await H.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}async function B({stateId:y,index:N}){var $,M,j;await A(y,"duplicate / system error",($=l.value)==null?void 0:$.value),Ce("Outcome voided successfully"),(j=(M=l.value)==null?void 0:M.other)==null||j.patient_states.splice(N,1),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}async function v(){await H.show(Ba,{birthdate:h.value,patientId:u.value},"custom-modal custom-modal-backdrop")}return he(C),(y,N)=>{const $=w("ion-icon"),M=w("ion-buttons");return R(),F(i(Xt),{when:"xs",contentId:"main"},{default:n(()=>[e(i(Jt),{contentId:"main"},{default:n(()=>[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>N[0]||(N[0]=[k("Patient Programs")])),_:1,__:[0]})]),_:1})]),_:1}),e(i(ke),{class:"ion-no-padding"},{default:n(()=>[e(i(At),null,{default:n(()=>[(R(!0),z(J,null,Ie(i(f),j=>{var L;return R(),F(i(ze),{button:"",key:j.value,color:j.value===((L=l.value)==null?void 0:L.value)?"secondary":"light",onClick:P=>I(j)},{default:n(()=>[e(i(Ge),null,{default:n(()=>[k(ue(j.label),1)]),_:2},1024)]),_:2},1032,["color","onClick"])}),128))]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),{class:"ion-padding-start"},{default:n(()=>[l.value?(R(),F(i(Q),{key:0,color:"danger",onClick:S,slot:"start"},{default:n(()=>N[1]||(N[1]=[k("Void Program")])),_:1,__:[1]})):G("",!0),i(b)?G("",!0):(R(),F(i(Q),{key:1,onClick:v,slot:"start"},{default:n(()=>N[2]||(N[2]=[k("Enroll HIV Program")])),_:1,__:[2]}))]),_:1})]),_:1})]),_:1}),fe("div",qa,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(M,{slot:"end"},{default:n(()=>[e(i(Q),{onClick:i(H).hide,color:"danger",size:"large"},{default:n(()=>[e($,{size:"large",icon:i(Qt)},null,8,["icon"])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[l.value?(R(),F(i(ve),{key:0,style:{width:"100%"}},{default:n(()=>[e(i(oe),{class:"his-card",style:Tt({minHeight:d.value?"0":"30vh"})},{default:n(()=>[e(i(O),{size:"12",class:"ion-no-padding"},{default:n(()=>{var j,L,P;return[fe("h5",Ha," Enrollment Date: "+ue(m.value?i(pe)(m.value):"Unknown"),1),e(Ea,{patientStates:(P=(L=(j=l.value)==null?void 0:j.other)==null?void 0:L.patient_states)!=null?P:[],onVoidOutcome:B},null,8,["patientStates"])]}),_:1})]),_:1},8,["style"]),s.value?(R(),F(i(oe),{key:0,class:"his-card ion-margin-top",style:{"margin-bottom":"0.4rem"}},{default:n(()=>[e(Ma,{"date-enrolled":m.value,birthdate:h.value,outcomes:s.value,onSaveOutcome:D},null,8,["date-enrolled","birthdate","outcomes"])]),_:1})):G("",!0)]),_:1})):G("",!0)]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{slot:"end",color:"warning"},{default:n(()=>N[3]||(N[3]=[k(" Reset ")])),_:1,__:[3]}),e(i(Q),{slot:"end",color:"primary"},{default:n(()=>N[4]||(N[4]=[k(" Submit ")])),_:1,__:[4]})]),_:1})]),_:1})])]),_:1})}}}),Ga=ae({name:"MultiColumnView",components:{IonGrid:ve,IonRow:oe,IonCol:O},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(a){const t={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:q(()=>va(a.items,Math.ceil(a.items.length/a.numberOfColumns))),grid:t}}});function za(a,t,l,u,m,h){const s=w("ion-col"),d=w("ion-row"),f=w("ion-grid");return R(),F(f,null,{default:n(()=>[e(d,null,{default:n(()=>[(R(!0),z(J,null,Ie(a.computedItems,(V,b)=>(R(),F(s,{key:b,size:a.grid[a.numberOfColumns]},{default:n(()=>[Kt(a.$slots,"default",{entries:V})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const dt=be(Ga,[["render",za]]);class Wa extends de{constructor(t,l=X()){super(t,Re.HIV_RECEPTION,l)}}class Et extends de{constructor(t,l=X()){super(t,Re.ART_ADHERENCE,l)}buildPillCountObs(t,l){return this.buildValueNumber("Number of tablets brought to clinic",l,null,t)}async buildAdherenceObs(t,l,u){return{concept_id:await de.getConceptID("Drug adherence",!0),value_numeric:u,value_drug:l,value_modifier:"%",order_id:t,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(t,l,u){return Math.round(100*(t-l)/(t-u))}calculateExpected(t,l,u,m){const h=m==="QW"?"week":"day",s=this.calcTimeElapsed(u,h);return t-s*parseFloat(l.toString())}calcTimeElapsed(t,l){return ee(this.date).diff(t,l)+1}}class xa extends de{constructor(t,l=X()){super(t,Re.APPOINTMENT,l)}}class ja extends de{constructor(t,l=X()){super(t,Re.TREATMENT,l)}calculateDosage(t,l){let u=0;return l===0&&(u=t),t==0&&(u=l),t>0&&l>0&&(u=(t+l)/2),u}calculateEquivalentDosage(t,l){return t+l}calculateDrugRunOutDate(t,l){return pt(ee(l).add(t,"days"))}getInstructions(t,l,u,m){return"".concat(t," :- Morning: ").concat(l," ").concat(m,", Evening: ").concat(u," ").concat(m)}toDrugOrder(t,l,u,m){return{drug_inventory_id:t.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(t.am,t.pm),start_date:m,auto_expire_date:this.calculateDrugRunOutDate(u,m),units:t.units,instructions:this.getInstructions(t.drug_name,t.am,t.pm,t.units),dose:this.calculateDosage(t.am,t.pm),frequency:t.frequency,qty:l}}async createDrugOrder(t){return ct.create({encounter_id:this.encounterID,drug_orders:t})}}class Ya{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(t,l,u){let m={result:"",color:"",index:u};if(u<=0)return m.index=0,m;if(l<5&&l>0)m.result="Use MUAC to calculate nutrition status",m.color="red";else{l>18&&(l=19);const h=await this.getBMIData(),s=h[t][l];s&&(m=this.buildBounds(Object.keys(s),s,u,h.colors))}return m}static buildBounds(t,l,u,m){const h={result:"",color:"",index:u};return t.forEach(s=>{if(s.indexOf("-")>=0){const d=s.split("-");u>=parseFloat(d[0])&&u<=parseFloat(d[1])&&(h.result=l[s],h.color=m[l[s]])}else if(s.indexOf("<")>=0){const d=s.replace("<","");u<parseFloat(d)&&(h.result=l[s],h.color=m[l[s]])}else if(s.indexOf(">=")>=0){const d=s.replace(">=","");u>=parseFloat(d)&&(h.result=l[s],h.color=m[l[s]])}}),h}static getBMI(t,l,u,m){const h=this.calculateBMI(t,l);return this.getBMIResult(u,m,h)}static calculateBMI(t,l){if(l==0||t==0)return 0;let u=t/l/l*1e4;return u=Math.round(u*10)/10}}class Ja extends de{constructor(t,l=X()){super(t,Re.DISPENSING,l)}buildDispensations(t,l,u){const m=[];for(let h=0;h<u;h++)m.push({drug_order_id:t,date:this.date,quantity:l/u});return m}saveDispensations(t){return De.postJson("/dispensations",{dispensations:t,program_id:this.programID})}}const Qa=ae({__name:"PatientVisit",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=q(()=>t.patient.getID()),u=new da(l.value),m=new ma(l.value),h=new ja(l.value),s=new Ja(l.value),d=new Wa(l.value),f=new Et(l.value),V=new xa(l.value),b=E(),g=E(),T=E([]),A=E([]),C=E([]),I=E([]),_=q(()=>t.patient.isFemale()),D=E(""),S=t.patient.getBirthdate(),B=E(!1),v=ce({}),y=q(()=>!(b.value&&t.patient.getAge()>18)),{isDICSite:N,refreshDICStatus:$}=mt(),{enrollPatient:M,fetchPatientPrograms:j,hasProgram:L,updateState:P}=et(l.value),r=ce({visitDate:{value:ee().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async o=>new Date(o.value)>new Date(X())?["Visit date cannot be after today's date"]:Pt(o,S)},weight:{value:void 0,label:"Weight",required:!0,computedValue:o=>({tag:"vitals",obs:u.buildValueNumber("Weight",o)}),validation:(o,c)=>(Y(o)||!o.value)&&c.patientPresent.value==="No"?null:Me([()=>ye(o),()=>re(o,"DECIMALS"),()=>Rt(o,2,250)])},bp:{value:"",label:"Blood Pressure (mmHG)",placeholder:"Enter Blood Pressure e.g 120/80",validation:o=>Y(o)||!o.value?null:fa(o),computedValue:o=>{if(Y(o))return null;const[c,p]=o.split("/").map(Number);return{tag:"vitals",obs:[u.buildValueNumber("Systolic",c),u.buildValueNumber("Diastolic",p)]}}},height:{value:void 0,label:"Height (cm)",computedValue:o=>({tag:"vitals",obs:u.buildValueNumber("Height",o)}),validation:o=>!y.value||(Y(o)||!o.value)&&r.patientPresent.value==="No"?null:Me([()=>ye(o),()=>re(o),()=>Rt(o,20,220)])},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:_.value,computedValue:o=>({tag:"consultation",obs:m.buildValueCoded("Is patient pregnant",o)}),validation:async o=>_.value&&ye(o)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:_.value,computedValue:o=>({tag:"consultation",obs:m.buildValueCoded("Is patient breast feeding",o)}),validation:async o=>_.value&&ye(o)},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:o=>({tag:"appointment",obs:V.buildValueDate("Appointment date",o)}),validation:async(o,c)=>new Date(o.value)<new Date(c.visitDate.value)?["Appointment date cannot be before visit date"]:new Date(o.value)>new Date(D.value)?["Appointment date cannot be after drug run out date"]:ee(D.value).diff(ee(o.value),"days")>7?["Appointment date is more than 7 days earlier than drug run out date. The client will have excess medication"]:null},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:o=>({tag:"reception",obs:d.buildValueCoded("Patient present",o)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:o=>({tag:"reception",obs:d.buildValueCoded("Guardian present",o)})},pillCount:{value:void 0,label:"Pill Count",required:I.value.length>0,validation:async o=>I.value.length>0&&re(o)},regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","INH")}),validation:async(o,c)=>{var p,U;return(((p=c.tbMed.value)==null?void 0:p.label)==="6H"||((U=c.tbMed.value)==null?void 0:U.label)==="3HP (RFP + INH)")&&re(o)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(o,c)=>{var p;return((p=c.tbMed.value)==null?void 0:p.label)==="3HP (RFP + INH)"&&re(o)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(o,c)=>{var p;return((p=c.tbMed.value)==null?void 0:p.label)==="3HP (INH 300 / RFP 300)"&&re(o)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(o,c)=>{var p;return((p=c.tbMed.value)==null?void 0:p.label)&&re(o)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async o=>Me([()=>ye(o),()=>o.value==="No"||A.value.some(c=>c.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async o=>Me([()=>ye(o),()=>o.value==="No"||C.value.some(c=>c.isChecked)?null:["Please select at least one side effect"]])},tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:o=>({tag:"consultation",obs:m.buildValueCoded("TB Status",o.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async o=>{if(!B.value){if(new Date(o.value)>new Date(X()))return["TB treatment start date cannot be after today's date"];if(new Date(o.value)<new Date(S))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:o=>({tag:"consultation",obs:m.buildValueDate("TB treatment start date",o)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:o=>({tag:"consultation",obs:m.buildValueNumber("TB treatment period",o)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:o=>({tag:"consultation",obs:m.buildGroupValueCoded("TB screening method used","chest xray",o)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:o=>({tag:"consultation",obs:m.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",o)})}});_e(()=>r.regimen.value,o=>{var c;nt(),o&&((c=o==null?void 0:o.other)==null||c.forEach(p=>{var U;v[p.drug_name]={label:"".concat((U=p.alternative_drug_name)!=null?U:p.drug_name," given"),value:0,required:!0,validation:K=>Me([()=>re(K,"POSITIVE_INTEGERS"),()=>Number(K.value)%30!==0?["Quantity should be in multiples of 30"]:null])}}))}),_e(r.patientPresent,o=>{o.value==="No"?(r.weight.required=!1,r.weight.error="",r.guardianPresent.value="Yes"):r.weight.required=!0}),_e(r.guardianPresent,o=>{o.value==="No"&&(r.patientPresent.value="Yes")}),_e([()=>r.weight.value,()=>r.tbStatus.value],async([o,c])=>{var U;r.regimen.value=void 0,nt();const p=B.value||/confirmed/i.test((U=c==null?void 0:c.label)!=null?U:"");o?(T.value=await Te.getRegimensByWeight(r.weight.value,p),r.patientPresent.value="Yes",r.patientPresent.disabled=!0):!o&&r.weight.required&&(r.patientPresent.value=void 0,r.patientPresent.disabled=!1),r.tbMed.disabled=p});const xe=()=>{var o,c;return Y(v)?1/0:Math.min(...(c=(o=r.regimen.value)==null?void 0:o.other)==null?void 0:c.map(p=>{var U,K,Ve,je,Ye;return((K=(U=v[p.drug_name])==null?void 0:U.value)!=null?K:0)/(((Ve=p.am)!=null?Ve:0)+((je=p.noon)!=null?je:0)+((Ye=p.pm)!=null?Ye:0))||1}))};_e([()=>v,()=>r.pillCount.value,()=>r.visitDate.value],()=>{const o=parseInt(r.pillCount.value)||0,c=xe();if(c!==1/0){D.value=h.calculateDrugRunOutDate(c+o,r.visitDate.value),r.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(pe(D.value),")");const p=ee(D.value).subtract(2,"day"),U=p.day();let K;U===0?K=p.subtract(2,"day"):U===6?K=p.subtract(1,"day"):K=p,r.nextAppointmentDate.value=pt(K)}},{deep:!0}),_e(()=>r.visitDate.value,()=>gt());const tt=q(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (INH 300 / RFP 300)"}),Fe=q(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (RFP + INH)"}),at=q(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="6H"}),kt=q(()=>r.hasContraindications.value==="Yes"),ft=q(()=>r.hasSideEffects.value==="Yes"),$t=q(()=>{var o;return/Confirmed TB on treatment/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),Bt=q(()=>{var o;return/Suspected/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),Ut=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Ft=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Mt=Xe(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),qt=Xe(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),gt=async()=>{m.setDate(r.visitDate.value),B.value=!1;const o=await m.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(o)){const c=await m.getFirstValueDatetime("TB treatment start date"),p=(await m.getFirstValueNumber("TB treatment period")||6)*30;if(c){const U=ee(r.visitDate.value).diff(c,"days");B.value=U<=p}}r.tbStatus.required=!B.value},Ht=async o=>{const c=o.height||b.value,p=Ya.calculateBMI(o.weight,c);return u.buildValueNumber("BMI",p)},Lt=async()=>{const o=[await m.buildValueCoded("Patient using family planning","No")];return m.getFamilyPlanningMethods().forEach(async p=>{o.push(await m.buildValueCoded(p,"No"))}),o},Gt=async()=>Promise.all(Qe.getConceptsByCategory("tb_symptom",!0).map(async o=>m.buildGroupValueCoded(o.name,o.name,"No"))),zt=async()=>{u.setDate(r.visitDate.value),m.setDate(r.visitDate.value),h.setDate(r.visitDate.value),d.setDate(r.visitDate.value),f.setDate(r.visitDate.value),V.setDate(r.visitDate.value),s.setDate(r.visitDate.value),await Ue(r,async(o,c)=>{var bt,_t,yt,ht,Vt;const p=[];let U=0;if(!Y(o.regimen)&&await Ke(v)){const ne=o.regimen.other,te=rt(v).formData;U=xe(),ne.forEach(Z=>p.push(h.toDrugOrder(Z,te[Z.drug_name],U,o.visitDate)))}else if(!await Ne("Are you sure you want to continue without dispensing ART drugs?"))return;if(le.show("Saving patient visit..."),o.totalCPTGiven&&Nt((await Te.getRegimenExtras("Cotrimoxazole",(bt=o.weight)!=null?bt:g.value)).data,"concept_name").filter(ne=>ne.frequency==="Daily (QOD)").forEach(ne=>p.push(h.toDrugOrder(ne,o.totalCPTGiven,U,o.visitDate))),(_t=o.tbMed)!=null&&_t.value){const ne=Nt((await Te.getRegimenExtras("INH",(yt=o.weight)!=null?yt:g.value)).data,["concept_name","frequency"]),te=ne.find(Z=>Z.concept_name==="Pyridoxine");if(te&&o.totalPyridoxineGiven&&p.push(h.toDrugOrder(te,o.totalPyridoxineGiven,U,o.visitDate)),o.totalIPTGiven){const Z=ne.find(Ae=>Ae.concept_name==="Isoniazid"&&(at.value&&Ae.frequency==="Daily (QOD)"||Fe.value&&Ae.frequency==="Weekly (QW)"));p.push(h.toDrugOrder(Z,o.totalIPTGiven,U,o.visitDate))}if(o.totalRFPGiven&&Fe.value){const Z=(await Te.getRegimenExtras("Rifapentine",(ht=o.weight)!=null?ht:g.value)).data;Z.length&&p.push(h.toDrugOrder(Z[0],o.totalRFPGiven,U,o.visitDate))}if(o.total3HPGiven&&tt.value){const Z=(await Te.getRegimenExtras("INH / RFP",(Vt=o.weight)!=null?Vt:g.value)).data;p.push(h.toDrugOrder(Z[0],o.total3HPGiven,U,o.visitDate))}}if(!Y(p)){await h.createEncounter();const te=(await h.createDrugOrder(p)).data.map(Z=>{const Ae=p.find(xt=>xt.drug_inventory_id===Z.drug_inventory_id);return s.buildDispensations(Z.order_id,Ae.qty,1)});await s.saveDispensations(te.flat(1))}const K=await qe(c,"vitals");if(!Y(K)){await u.createEncounter();const ne=await Ht(o);await u.saveObservationList([...K,ne])}await m.createEncounter();const Ve=await qe(c,"consultation");Ve.push(...await m.buildOptionsGroupObs("Malawi ART side effects",A.value)),Ve.push(...await Gt()),ft.value&&Ve.push(...await m.buildOptionsGroupObs("Other side effect",C.value)),_.value&&Ve.push(...await Lt()),await m.saveObservationList(Ve),await d.createEncounter();const je=await qe(c,"reception");if(await d.saveObservationList(je),I.value.length>0){await f.createEncounter();const ne=await Promise.all(I.value.map(async te=>{const Z=f.calculateExpected(te.quantity,te.equivalent_daily_dose,te.order.start_date,te.frequency),Ae=f.calculateAdherence(te.quantity,o.pillCount,Z);return[await f.buildAdherenceObs(te.order_id,te.drug_inventory_id,Ae),await f.buildPillCountObs(te.order_id,o.pillCount)]}));await f.saveObservationList(ne.flat(1))}await V.createEncounter();const Ye=await qe(c,"appointment");await V.saveObservationList(Ye),await Ce("Patient visit saved successfully"),N.value&&!L(lt)&&(await M(o.visitDate,lt),await P(Zt,o.visitDate,lt)),await H.hide(),le.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA),W.emit(x.RELOAD_STAGING_INFORMATION)},{showloader:!1})},Wt=async()=>{if(await Ne("Are you sure you want to clear all fields?")){for(const o in r)r[o].value="",r[o].error="",r[o].disabled=!1;nt(),W.emit(x.ON_CLEAR)}},nt=()=>{for(const o in v)delete v[o]};return he(async()=>{try{await gt(),b.value=await t.patient.getRecentHeight(),g.value=await t.patient.getRecentWeight(),g.value&&(T.value=await Te.getRegimensByWeight(g.value)),I.value=await ct.getLastDrugsReceived(t.patient.getID()),r.pillCount.required=I.value.length>0,A.value=Qe.getConceptsByCategory("contraindication",!0).map(o=>({value:o.concept_id,label:o.name,other:o})),C.value=Qe.getConceptsByCategory("side_effect",!0).map(o=>({value:o.concept_id,label:o.name,other:o}))}catch(o){Be("Form initialization failed. Try to refresh the page"),console.error(o)}$().catch(console.error),j().catch(console.error)}),(o,c)=>(R(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>c[25]||(c[25]=[k("Patient Visit")])),_:1,__:[25]})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(oe),null,{default:n(()=>[e(i(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:r.visitDate,"onUpdate:modelValue":c[0]||(c[0]=p=>r.visitDate=p),form:r,minDate:i(S),maxDate:i(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.patientPresent,"onUpdate:modelValue":c[1]||(c[1]=p=>r.patientPresent=p),inline:"",disabled:r.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.guardianPresent,"onUpdate:modelValue":c[2]||(c[2]=p=>r.guardianPresent=p),inline:""},null,8,["modelValue"])]),_:1}),_.value?(R(),z(J,{key:0},[e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.isPregnant,"onUpdate:modelValue":c[3]||(c[3]=p=>r.isPregnant=p),inline:""},null,8,["modelValue"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.isBreastfeeding,"onUpdate:modelValue":c[4]||(c[4]=p=>r.isBreastfeeding=p),inline:""},null,8,["modelValue"])]),_:1})],64)):G("",!0),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.hasContraindications,"onUpdate:modelValue":c[5]||(c[5]=p=>r.hasContraindications=p),inline:""},null,8,["modelValue"]),kt.value?(R(),F(dt,{key:0,items:A.value,numberOfColumns:2},{default:n(({entries:p})=>[(R(!0),z(J,null,Ie(p,U=>(R(),F(i(ze),{lines:"none",key:U.value},{default:n(()=>[e(i(Ge),null,{default:n(()=>[k(ue(U.label),1)]),_:2},1024),e(i(st),{slot:"start",modelValue:U.isChecked,"onUpdate:modelValue":K=>U.isChecked=K},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1}),e(i(O),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[e(we,{modelValue:r.hasSideEffects,"onUpdate:modelValue":c[6]||(c[6]=p=>r.hasSideEffects=p),inline:""},null,8,["modelValue"]),ft.value?(R(),F(dt,{key:0,items:C.value,numberOfColumns:2},{default:n(({entries:p})=>[(R(!0),z(J,null,Ie(p,U=>(R(),F(i(ze),{lines:"none",key:U.value},{default:n(()=>[e(i(Ge),null,{default:n(()=>[k(ue(U.label),1)]),_:2},1024),e(i(st),{slot:"start",modelValue:U.isChecked,"onUpdate:modelValue":K=>U.isChecked=K},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.weight,"onUpdate:modelValue":c[7]||(c[7]=p=>r.weight=p),form:r,min:1},null,8,["modelValue","form"])]),_:1}),y.value?(R(),F(i(O),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.height,"onUpdate:modelValue":c[8]||(c[8]=p=>r.height=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Se,{modelValue:r.bp,"onUpdate:modelValue":c[9]||(c[9]=p=>r.bp=p),form:r},null,8,["modelValue","form"])]),_:1}),B.value?G("",!0):(R(),F(i(O),{key:2,class:"ion-margin-vertical",size:y.value?"6":"12"},{default:n(()=>[e(me,{modelValue:r.tbStatus,"onUpdate:modelValue":c[10]||(c[10]=p=>r.tbStatus=p),options:i(qt)},null,8,["modelValue","options"])]),_:1},8,["size"])),$t.value?(R(),z(J,{key:3},[e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:r.tbTreatmentStartDate,"onUpdate:modelValue":c[11]||(c[11]=p=>r.tbTreatmentStartDate=p),form:r,minDate:i(S),maxDate:i(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.tbTreatmentPeriod,"onUpdate:modelValue":c[12]||(c[12]=p=>r.tbTreatmentPeriod=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})],64)):Bt.value?(R(),z(J,{key:4},[e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.cxrResult,"onUpdate:modelValue":c[13]||(c[13]=p=>r.cxrResult=p),"custom-options":Ut},null,8,["modelValue"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.mwrdResult,"onUpdate:modelValue":c[14]||(c[14]=p=>r.mwrdResult=p),"custom-options":Ft},null,8,["modelValue"])]),_:1})],64)):G("",!0),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:r.regimen,"onUpdate:modelValue":c[15]||(c[15]=p=>r.regimen=p),options:T.value},null,8,["modelValue","options"])]),_:1}),i(Y)(v)?G("",!0):(R(!0),z(J,{key:5},Ie(Object.values(v),(p,U)=>(R(),F(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{"model-value":p,form:v,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.totalCPTGiven,"onUpdate:modelValue":c[16]||(c[16]=p=>r.totalCPTGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:r.tbMed,"onUpdate:modelValue":c[17]||(c[17]=p=>r.tbMed=p),options:i(Mt)},null,8,["modelValue","options"])]),_:1}),at.value||Fe.value?(R(),F(i(O),{key:6,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.totalIPTGiven,"onUpdate:modelValue":c[18]||(c[18]=p=>r.totalIPTGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),Fe.value?(R(),F(i(O),{key:7,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.totalRFPGiven,"onUpdate:modelValue":c[19]||(c[19]=p=>r.totalRFPGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),tt.value?(R(),F(i(O),{key:8,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.total3HPGiven,"onUpdate:modelValue":c[20]||(c[20]=p=>r.total3HPGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),tt.value||Fe.value||at.value?(R(),F(i(O),{key:9,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.totalPyridoxineGiven,"onUpdate:modelValue":c[21]||(c[21]=p=>r.totalPyridoxineGiven=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),I.value.length>0?(R(),F(i(O),{key:10,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{modelValue:r.pillCount,"onUpdate:modelValue":c[22]||(c[22]=p=>r.pillCount=p),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e(i(O),{size:I.value.length>0?"6":"12",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:r.nextAppointmentDate,"onUpdate:modelValue":c[23]||(c[23]=p=>r.nextAppointmentDate=p),form:r,minDate:r.visitDate.value,maxDate:D.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1},8,["size"])]),_:1})]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:c[24]||(c[24]=p=>i(H).hide()),slot:"end"},{default:n(()=>c[26]||(c[26]=[k(" Close ")])),_:1,__:[26]}),e(i(Q),{color:"warning",onClick:Wt,slot:"end"},{default:n(()=>c[27]||(c[27]=[k(" Reset ")])),_:1,__:[27]}),e(i(Q),{color:"success",onClick:zt,slot:"end"},{default:n(()=>c[28]||(c[28]=[k(" Save ")])),_:1,__:[28]})]),_:1})]),_:1})],64))}});const Xa=be(Qa,[["__scopeId","data-v-f8ce0839"]]),Ka=ae({__name:"EmergencyRefill",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=q(()=>t.patient.getID()),u=new Et(l.value),m=E(),h=E([]),s=E([]),d=q(()=>{var v;return(v=s.value[0])==null?void 0:v.order.start_date}),f=E(""),V=t.patient.getBirthdate(),b=E({}),g=ce({date:{value:X(),label:"Date of emergency refill",required:!0,computedValue:v=>({obs:u.buildValueDate("Prescription refill date",v)})},facility:{value:void 0,label:"Facility where emergency refill was collected",required:!0,placeholder:"Select a facility",computedValue:v=>({obs:u.buildValueText("Health facility name",v.label)})},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:v=>({obs:u.buildValueDate("Appointment date",v)})}});async function T(v,y,N){const $=u.calculateExpected(v.quantity,v.equivalent_daily_dose,v.order.start_date,v.frequency),M=u.calculateAdherence(v.quantity,N,$);return{...await u.buildValueCoded("Medications dispensed",v.drug.concept_id),child:[await u.buildAdherenceObs(v.order_id,v.drug_inventory_id,M),await u.buildPillCountObs(v.order_id,N),,await u.buildValueNumber("Amount of drug dispensed",y)]}}async function A(){if(await Ne("Are you sure you want to clear all fields?")){for(const v in g)g[v].value="",g[v].error="",g[v].disabled=!1;C(),W.emit(x.ON_CLEAR)}}function C(){for(const v in b.value)delete b.value[v]}function I(v){return v.regimen?"".concat(v.regimen," - ").concat(v.drug.name):v.drug.name}function _(){return Y(s.value)?1/0:Math.min(...s.value.map(v=>{var j,L,P,r;const y=I(v),N=Number((L=(j=b.value["".concat(y,"_given")])==null?void 0:j.value)!=null?L:0),$=Number((r=(P=b.value["".concat(y,"_brought")])==null?void 0:P.value)!=null?r:0),M=Number(v.equivalent_daily_dose);return(N+$)/M}))}function D(){const v=_();v!==1/0&&(f.value=ca(g.date.value,v,"days"),g.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(pe(f.value),")"),g.nextAppointmentDate.value=f.value)}async function S(){if(await Ke(g)&&await Ke(b.value))try{le.show(),u.setDate(g.date.value);const v=await qe({...rt(g).computedFormData,...rt(b.value).computedFormData}),y=new de(l.value,Re.EMERGENCY_DRUG_REFILL,g.date.value);await y.createEncounter(),await y.saveObservationList(v),Ce("Emergency refill saved successfully"),H.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA),W.emit(x.RELOAD_STAGING_INFORMATION)}catch(v){console.error(v),Be("Failed to save emergency refill")}finally{le.hide()}}function B(){s.value.forEach(v=>{const y=I(v);b.value["".concat(y,"_brought")]={label:"".concat(y," brought"),value:void 0,required:!0,placeholder:"Enter the number of pills brought",validation:N=>re(N,"POSITIVE_INTEGERS")},b.value["".concat(y,"_given")]={label:"".concat(y," given"),value:void 0,required:!0,placeholder:"Enter the number of pills given",validation:N=>re(N,"POSITIVE_INTEGERS"),computedValue:(N,$)=>T(v,N,$["".concat(y,"_brought")].value)}})}return _e([()=>b,()=>g.date.value],D,{deep:!0,immediate:!0}),he(async()=>{try{le.show(),m.value=await t.patient.getRecentWeight(),h.value=await Te.getRegimensByWeight(m.value),s.value=await ct.getLastDrugsReceived(l.value),B()}catch(v){Be("Form initialization failed. Try to refresh the page"),console.error(v)}finally{le.hide()}}),(v,y)=>(R(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>y[4]||(y[4]=[k("Emergency Drug Refill")])),_:1,__:[4]})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(oe),null,{default:n(()=>[e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:g.date,"onUpdate:modelValue":y[0]||(y[0]=N=>g.date=N),form:g,minDate:d.value||i(V),maxDate:i(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:g.facility,"onUpdate:modelValue":y[1]||(y[1]=N=>g.facility=N),form:g,asyncOptions:i(Ct)},null,8,["modelValue","form","asyncOptions"])]),_:1}),(R(!0),z(J,null,Ie(Object.values(b.value),N=>(R(),F(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ie,{"model-value":N,form:b.value,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),e(i(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:g.nextAppointmentDate,"onUpdate:modelValue":y[2]||(y[2]=N=>g.nextAppointmentDate=N),form:g,minDate:g.date.value,maxDate:f.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1})]),_:1})]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:y[3]||(y[3]=N=>i(H).hide()),slot:"end"},{default:n(()=>y[5]||(y[5]=[k(" Close ")])),_:1,__:[5]}),e(i(Q),{color:"warning",onClick:A,slot:"end"},{default:n(()=>y[6]||(y[6]=[k(" Reset ")])),_:1,__:[6]}),e(i(Q),{color:"success",onClick:S,slot:"end"},{default:n(()=>y[7]||(y[7]=[k(" Save ")])),_:1,__:[7]})]),_:1})]),_:1})],64))}}),Za=ae({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:vt,IonCard:ea,IonCardHeader:ta,IonCardTitle:aa,IonCardContent:na,IonButton:Q},setup(a){const t=E([]),l=q(()=>a.patient.getID()),u=ce({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),m=E([{label:"Add Visit",action:async()=>{await H.show(Xa,{patient:a.patient})}},{label:"Emegency Refill",action:async()=>{await H.show(Ka,{patient:a.patient})}},{label:"Update Outcome",action:async()=>H.show(La,{patient:a.patient})},{label:"Enter VL Results",action:async()=>H.show(Pa,{patient:a.patient})}]),h=I=>{const _=a.startDate!=="N/A"?"("+ee(I).diff(a.startDate,"months")+"M)":"";return"".concat(pe(I)," ").concat(_)},s={minWidth:"68px !important"},d=E([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:s},{path:"vitals",label:"Vitals",sortable:!1,thStyles:s},...a.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:s},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:s}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:I=>I.length>0?"Yes":"No",sortable:!1,thStyles:s},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:s},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:s},{path:"vlResult",label:"Viral Load",sortable:!1}]),f=I=>({title:"Side effects noted on ".concat(I.row.visitDate),rows:I.row.sideEffects.map(_=>({sideEffect:_})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),V=I=>({title:"Drugs dispensed on ".concat(I.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:I.row.drugs.map(_=>({name:_[0],quantity:_[1],units:"tab (s)"}))}),b=async I=>{const _=/regimen/i.test(I.column.path)?V(I):f(I);Y(_.rows)||await H.show(Va,_)},g=[{label:"void",icon:la,color:"danger",action(I,_){St(async D=>{var B;const S=await It.getEncounters(l.value,{date:I.date});S.ok?((B=S.data)==null||B.forEach(async v=>{await It.voidEncounter(v.encounter_id,D)}),t.value.splice(_,1)):Be(S.errorMessage||"Failed to void encounters")},"small-modal")}}],T=async I=>I.tb_status.match(/Unknown/i)||I.outcome==="Defaulted"?"":Qe.getCachedConceptName(I.tb_status),A=I=>{const _=I.weight?"Wt: ".concat(I.weight,"kg"):"",D=I.height?"Ht: ".concat(I.height,"cm"):"",S=I.bmi?"BMI: ".concat(I.bmi):"",B=I.bp?"BP: ".concat(I.bp):"";return[_,D,S,B].filter(Boolean).join(", ")},C=()=>{const{getProgramInfo:I}=et(l.value);He.getPatientVisits(l.value,!0).then(async _=>{t.value=[];for(const D of _){const S=await I(D);let B="",v="",y="",N="";if(S.outcome!=="Defaulted"){const $=await Je.getFirstValueDatetime(l.value,"appointment date",D);if($&&(B=pe($)),v=await Je.getFirstValueCoded(l.value,"Is patient pregnant",D),y=await Je.getFirstValueCoded(l.value,"Is patient breast feeding",D),S.viral_load==="N/A"){const M=await Je.getFirstObs(l.value,"HIV viral load",D);M&&M.value_text&&M.value_numeric&&(N=M.value_numeric===1?"LDL":M.value_text+M.value_numeric.toString())}else N=S.viral_load}S&&t.value.push({visitDate:h(D),visitBy:S.visit_by.match(/Unk/i)?"":S.visit_by,vitals:A(S),pregnant:v,breastfeeding:y,tbStatus:await T(S),sideEffects:S.outcome==="Defaulted"?"":S.side_effects,regimen:S.outcome==="Defaulted"?"":S.regimen,nextAppointment:B,outcome:S.outcome.match(/Unk/i)?"":S.outcome,vlResult:N,drugs:S.pills_dispensed,date:D})}})};return W.on(x.RELOAD_PATIENT_VISIT_DATA,()=>C()),he(()=>{C()}),{actionButtons:m,tableConfig:u,rowButtons:g,columns:d,rows:t,onDrilldownHandler:b}}});const en={class:"ion-float-right ion-margin-end ion-margin-bottom"};function tn(a,t,l,u,m,h){const s=w("ion-icon"),d=w("ion-button"),f=w("ion-card-title"),V=w("ion-card-header"),b=w("data-table"),g=w("ion-card-content"),T=w("ion-card");return R(),F(T,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[e(V,null,{default:n(()=>[e(f,null,{default:n(()=>[t[0]||(t[0]=fe("span",{class:"title"},"Summary of Visits",-1)),fe("span",en,[(R(!0),z(J,null,Ie(a.actionButtons,A=>(R(),F(d,{key:A.label,onClick:A.action,color:A.color||"primary"},{default:n(()=>[A.icon?(R(),F(s,{key:0,icon:A.icon,class:"ion-margin-right"},null,8,["icon"])):G("",!0),k(" "+ue(A.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1,__:[0]})]),_:1}),e(g,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[e(b,{rows:a.rows,columns:a.columns,"row-actions-buttons":a.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:a.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const an=be(Za,[["render",tn],["__scopeId","data-v-824715c1"]]),nn=ae({__name:"ViralLoadTrail",props:{patient:{}},setup(a){const t=a,l=q(()=>"Viral Load Results Trail for ".concat(t.patient.getFullName())),u=E([]),m=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:pe},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:pe}],h={label:"X",color:"danger",action({encounter_id:s}){St(async d=>{try{await oa.void(s,d),H.hide(),W.emit(x.RELOAD_LATEST_VL_RESULT),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}catch(f){console.error(f)}},"small-modal custom-modal-backdrop")}};return he(async()=>{u.value=await Pe.getViralLoadResultTrail(t.patient.getID())}),(s,d)=>(R(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(We),null,{default:n(()=>[k(ue(l.value),1)]),_:1})]),_:1})]),_:1}),e(i(ke),null,{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(oe),{style:Tt([{padding:"0 !important"},{minHeight:u.value.length?"0":"30vh"}])},{default:n(()=>[e(i(O),{size:"12",class:"ion-no-padding"},{default:n(()=>[e(i(vt),{rows:u.value,columns:m,"row-actions-buttons":[h],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(se),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:d[0]||(d[0]=f=>i(H).hide()),slot:"end"},{default:n(()=>d[1]||(d[1]=[k(" Close ")])),_:1,__:[1]})]),_:1})]),_:1})],64))}}),ln=ae({components:{MultiColumnView:dt,IonList:At,IonItem:ze},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(a,{emit:t}){const l=E(0),u=E(0),m=E(0),h=E(""),s=E(""),d=E(""),f=E(""),V=E(""),b=E(""),g=E(""),T=E(""),A=E(""),C=E(""),I=E(""),_=P=>P.other&&typeof P.other.onClickHandler=="function",D=q(()=>!Y(a.guardians)),S=async P=>{var r;_(P)&&await((r=P.other)==null?void 0:r.onClickHandler())},B=()=>{const P=a.patient.getBirthdate(),r=a.artStartDate!=="N/A"?ee(a.artStartDate).diff(P,"years"):"";return"".concat(pe(P)," (").concat(r,")")},v=()=>{Pe.getlatestViralLoadResult(a.patient.getID()).then(P=>C.value=P)},y=()=>({onClickHandler(){ia.push("/patient/reception/".concat(a.patient.getID(),"/false"))}}),N=()=>D.value?a.guardians.map(P=>"".concat(P.name," (").concat(P.relationshipType,")")).join(","):"Add",$=()=>({onClickHandler:()=>t("updatePatient")}),M=q(()=>[{label:"ARV Number",value:a.patient.getArvNumber(),other:{onClickHandler:()=>t("updateARVNumber")}},{label:"NPID",value:a.patient.getNationalID()},{label:"MW National ID",value:a.patient.getMWNationalID(),other:$()},{label:"Name",value:a.patient.getGivenName()+" "+a.patient.getFamilyName(),other:$()},{label:"DOB and Age at Initiation",value:B(),other:$()},{label:"Sex",value:wa(a.patient.getGender()),other:$()},{label:"Location",value:a.patient.getCurrentVillage(),other:$()},{label:"Landmark",value:a.patient.getClosestLandmark(),other:$()},{label:"Phone Number",value:a.patient.getPhoneNumber(),other:$()},{label:"Guardian",value:N(),other:{onClickHandler:()=>t("updateGuardian")}},{label:"Agrees to follow up",value:V.value,other:y()},{label:"Date of starting first line ARV Regimen",value:a.artStartDate,other:y()},{label:"Initial Weight and Height",value:"".concat(l.value,"Kg, ").concat(u.value,"cm"),other:y()},{label:"Initial BMI",value:m.value,other:y()},{label:"Initial TB Status",value:h.value,other:y()},{label:"Pregnant at Initiation",value:d.value,other:y()},{label:"Breastfeeding at Initiation",value:s.value,other:y()},{label:"Latest VL Result and Result Date",value:C.value,other:{onClickHandler:()=>H.show(nn,{patient:a.patient})}},{label:"TI",value:f.value,other:y()},{label:"HIV test place",value:T.value,other:y()},{label:"HIV test date",value:g.value,other:y()},{label:"WHO stage",value:I.value,other:y()},{label:"Reason for starting ART",value:b.value,other:y()},{label:"Staging codition",value:A.value,other:y()}]),j=async()=>{const P=await a.patient.getHIVTestDate();P&&(g.value=pe(P))},L=()=>{a.patient.getInitialWeight().then(P=>l.value=P),a.patient.getInitialHeight().then(P=>u.value=P),a.patient.getInitialBMI().then(P=>m.value=P),a.patient.getInitialTBStatus().then(P=>h.value=P),a.patient.hasPregnancyAtARTInitiation().then(P=>d.value=P),a.patient.breastFeedingAtARTInitiation().then(P=>s.value=P),a.patient.everReceivedART().then(P=>f.value=P),a.patient.agreesToFollowUp().then(P=>V.value=P),a.patient.getReasonForStartingART().then(P=>b.value=P),a.patient.getHIVTestLocation().then(P=>T.value=P),a.patient.getStagingCondition().then(P=>A.value=P),a.patient.getWhoStage().then(P=>I.value=P),j()};return he(()=>{L(),v(),W.on(x.RELOAD_LATEST_VL_RESULT,()=>v()),W.on(x.RELOAD_STAGING_INFORMATION,()=>L())}),{patientInfo:M,onClickHandler:S,clickable:_}}});const on={style:{width:"100%",display:"flex",justifyContent:"space-between"}},sn={key:0},rn={key:1},un={key:2},dn={key:3};function mn(a,t,l,u,m,h){const s=w("ion-item"),d=w("ion-list"),f=w("multi-column-view");return R(),F(f,{items:a.patientInfo,numberOfColumns:3},{default:n(({entries:V})=>[e(d,{class:"his-card ion-margin-end"},{default:n(()=>[(R(!0),z(J,null,Ie(V,(b,g)=>(R(),F(s,{key:g,lines:g===V.length-1?"none":void 0,button:a.clickable(b),onClick:T=>a.onClickHandler(b)},{default:n(()=>[fe("div",on,[b.label?(R(),z("span",sn,ue(b.label)+": ",1)):(R(),z("span",rn)),a.clickable(b)?(R(),z("span",un,[fe("a",null,[fe("b",null,ue(b.value||"N/A"),1)])])):(R(),z("span",dn,[fe("b",null,ue(b.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const cn=be(ln,[["render",mn],["__scopeId","data-v-1195e33c"]]),pn=ae({components:{IonGrid:ve,IonRow:oe,IonCol:O,TextInput:Se,DateInput:ge,SelectInput:me},props:{patientService:{type:Object,required:!0}},setup(a){const t=E(!1),l=q(()=>/Unknown/i.test(a.patientService.getMWNationalID())?"":a.patientService.getMWNationalID()),u=ce({givenName:{label:"First Name",value:a.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:s=>Le(s)},familyName:{label:"last Name",value:a.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:s=>Le(s)},middleName:{label:"middle Name",value:a.patientService.getMiddleName(),placeholder:"middle Name",validation:s=>!!s&&Le(s)},nationalId:{label:"Malawi National ID Number",value:l.value,placeholder:"Enter Malawi National ID Number",validation:s=>s&&s.label?ga(s):null},gender:{value:a.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:a.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:a.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async s=>!(s.value==="Unknown"||s.value==="N/A")&&Ot(s)},homeVillage:{value:a.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:a.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),m=async s=>{var V,b,g,T,A;let d,f;try{(V=s==null?void 0:s.other)!=null&&V.traditional_authority_id&&(d=await Dt.getTraditionalAuthorityById(s.other.traditional_authority_id)),d&&(f=await Dt.getDistrictByID(d.district_id))}catch(C){Be("Unable to resolve patient address. Saving using default address"),console.error(C)}return{home_district:(b=f==null?void 0:f.name)!=null?b:"N/A",home_traditional_authority:(g=d==null?void 0:d.name)!=null?g:"N/A",home_village:(s==null?void 0:s.label)||"N/A",current_district:(T=f==null?void 0:f.name)!=null?T:"N/A",current_traditional_authority:(A=d==null?void 0:d.name)!=null?A:"N/A",current_village:(s==null?void 0:s.label)||"N/A"}};return{today:X,patient:u,getLandmarks:ba,genderOptions:ha,isBirthdateEstimated:t,modal:H,onFinish:async()=>Ue(u,async s=>{const d={};if(s.givenName!==a.patientService.getGivenName()&&(d.given_name=s.givenName),s.familyName!==a.patientService.getFamilyName()&&(d.family_name=s.familyName),s.middleName!==a.patientService.getMiddleName()&&(d.middle_name=s.middleName),s.birthdate!==a.patientService.getBirthdate()&&(d.birthdate=s.birthdate),s.gender.value!==a.patientService.getGender()&&(d.gender=s.gender.value),s.cellPhoneNumber!==a.patientService.getPhoneNumber()&&(d.cell_phone_number=s.cellPhoneNumber),s.landmark.label!==a.patientService.getClosestLandmark()&&(d.landmark=s.landmark.label),s.homeVillage!==a.patientService.getCurrentVillage()&&Object.assign(d,{...d,...await m(s.homeVillage)}),!Y(d)){const f=new ut;f.setPersonID(a.patientService.getID()),await f.updatePerson(d)}s.nationalId!==l.value&&await a.patientService.updateMWNationalId(s.nationalId),await H.hide(),W.emit(x.RELOAD_PATIENT_DATA)}),getVillagesByName:_a}}});function vn(a,t,l,u,m,h){const s=w("ion-title"),d=w("ion-icon"),f=w("ion-button"),V=w("ion-buttons"),b=w("ion-toolbar"),g=w("ion-header"),T=w("TextInput"),A=w("ion-col"),C=w("SelectInput"),I=w("DateInput"),_=w("ion-row"),D=w("ion-grid"),S=w("ion-content"),B=w("ion-footer");return R(),z(J,null,[e(g,null,{default:n(()=>[e(b,null,{default:n(()=>[e(s,null,{default:n(()=>t[12]||(t[12]=[k("Edit Patient Demographics")])),_:1,__:[12]}),e(V,{slot:"end"},{default:n(()=>[e(f,{onClick:t[0]||(t[0]=v=>a.modal.hide())},{default:n(()=>[e(d,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(S,{class:"ion-padding"},{default:n(()=>[e(D,null,{default:n(()=>[e(_,null,{default:n(()=>[e(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.givenName,"onUpdate:modelValue":t[1]||(t[1]=v=>a.patient.givenName=v)},null,8,["modelValue"])]),_:1}),e(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.middleName,"onUpdate:modelValue":t[2]||(t[2]=v=>a.patient.middleName=v)},null,8,["modelValue"])]),_:1}),e(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.familyName,"onUpdate:modelValue":t[3]||(t[3]=v=>a.patient.familyName=v)},null,8,["modelValue"])]),_:1}),e(A,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.nationalId,"onUpdate:modelValue":t[4]||(t[4]=v=>a.patient.nationalId=v)},null,8,["modelValue"])]),_:1}),e(A,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(C,{modelValue:a.patient.gender,"onUpdate:modelValue":t[5]||(t[5]=v=>a.patient.gender=v),options:a.genderOptions},null,8,["modelValue","options"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(I,{modelValue:a.patient.birthdate,"onUpdate:modelValue":t[6]||(t[6]=v=>a.patient.birthdate=v),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:a.today,onIsEstimated:t[7]||(t[7]=v=>a.isBirthdateEstimated=v)},null,8,["modelValue","maxDate"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.cellPhoneNumber,"onUpdate:modelValue":t[8]||(t[8]=v=>a.patient.cellPhoneNumber=v),allowUnknown:""},null,8,["modelValue"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(C,{modelValue:a.patient.homeVillage,"onUpdate:modelValue":t[9]||(t[9]=v=>a.patient.homeVillage=v),asyncOptions:a.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(C,{modelValue:a.patient.landmark,"onUpdate:modelValue":t[10]||(t[10]=v=>a.patient.landmark=v),asyncOptions:a.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),e(B,null,{default:n(()=>[e(b,null,{default:n(()=>[e(f,{color:"primary",onClick:t[11]||(t[11]=v=>a.modal.hide()),slot:"end"},{default:n(()=>t[13]||(t[13]=[k("Close")])),_:1,__:[13]}),e(f,{class:"ion-margin-end",color:"success",onClick:a.onFinish,slot:"end"},{default:n(()=>t[14]||(t[14]=[k("Save")])),_:1,__:[14]},8,["onClick"])]),_:1})]),_:1})],64)}const fn=be(pn,[["render",vn]]),gn=ae({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(a){var C,I;const t=new ut,l=a,u=E(Y(l.guardians)),m=q(()=>"".concat(u.value?"Add":"Edit"," Guardian Demographics")),h=q(()=>"".concat(u.value?"Edit":"Add"," Guardian")),s=E([]),d=(I=(C=l.guardians)==null?void 0:C.map(_=>({label:"".concat(_.name," (").concat(_.relationshipType,")"),value:_.name,other:_})))!=null?I:[],f=ce({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),V=ce({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:_=>Le(_)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:_=>Le(_)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async _=>_.value!=="Unknown"&&Ot(_)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});_e(()=>f.guardian.value,_=>{var D,S,B,v,y,N,$,M;V.givenName.value=(S=(D=_==null?void 0:_.other)==null?void 0:D.names.given_name)!=null?S:"",V.familyName.value=(v=(B=_==null?void 0:_.other)==null?void 0:B.names.family_name)!=null?v:"",V.cellPhoneNumber.value=(N=(y=_==null?void 0:_.other)==null?void 0:y.phoneNumber)!=null?N:"",V.relation.value=(M=($=_==null?void 0:_.other)==null?void 0:$.relationshipType)!=null?M:""},{deep:!0,immediate:!0});function b(){u.value=!u.value,f.guardian.value=""}async function g(_){var D,S;await t.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:l.patientId,..._}),await it.createRelation(l.patientId,t.getPersonID(),(S=(D=_.relation)==null?void 0:D.value)!=null?S:13)}async function T(_,D){var v,y;const S=D.names.person_id,B={};if(D.names.given_name!==_.given_name&&(B.given_name=_.given_name),D.names.family_name!==_.family_name&&(B.family_name=_.family_name),D.phoneNumber!==_.cell_phone_number&&(B.cell_phone_number=_.cell_phone_number),!Y(B)){const N=new ut;N.setPersonID(S),await N.updatePerson(B)}D.relationshipType!==_.relation.label&&await it.amendRelation(l.patientId,S,D.id,(y=(v=_.relation)==null?void 0:v.value)!=null?y:13)}const A=async()=>Ue(V,async _=>{!u.value&&!Y(f.guardian.value)?await T(_,f.guardian.value.other):await g(_),await H.hide(),W.emit(x.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return he(async()=>{const _=(await it.getRelations()).data;s.value=_.map(D=>({label:D.b_is_to_a,value:D.relationship_type_id,other:D}))}),(_,D)=>{const S=w("ion-title"),B=w("ion-icon"),v=w("ion-button"),y=w("ion-buttons"),N=w("ion-toolbar"),$=w("ion-header"),M=w("ion-content"),j=w("ion-footer");return R(),z(J,null,[e($,null,{default:n(()=>[e(N,null,{default:n(()=>[e(S,null,{default:n(()=>[k(ue(m.value),1)]),_:1}),e(y,{slot:"end"},{default:n(()=>[e(v,{onClick:D[0]||(D[0]=L=>i(H).hide())},{default:n(()=>[e(B,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(M,{class:"ion-padding"},{default:n(()=>[e(i(ve),null,{default:n(()=>[e(i(oe),null,{default:n(()=>[u.value?G("",!0):(R(),F(i(O),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(me,{modelValue:f.guardian,"onUpdate:modelValue":D[1]||(D[1]=L=>f.guardian=L),options:i(d)},null,8,["modelValue","options"])]),_:1})),f.guardian.value||u.value?(R(),z(J,{key:1},[e(i(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Se,{modelValue:V.givenName,"onUpdate:modelValue":D[2]||(D[2]=L=>V.givenName=L)},null,8,["modelValue"])]),_:1}),e(i(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Se,{modelValue:V.familyName,"onUpdate:modelValue":D[3]||(D[3]=L=>V.familyName=L)},null,8,["modelValue"])]),_:1}),e(i(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Se,{modelValue:V.cellPhoneNumber,"onUpdate:modelValue":D[4]||(D[4]=L=>V.cellPhoneNumber=L),allowUnknown:""},null,8,["modelValue"])]),_:1}),e(i(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(me,{modelValue:V.relation,"onUpdate:modelValue":D[5]||(D[5]=L=>V.relation=L),options:s.value},null,8,["modelValue","options"])]),_:1})],64)):G("",!0)]),_:1})]),_:1})]),_:1}),e(j,null,{default:n(()=>[e(N,null,{default:n(()=>[i(Y)(l.guardians)?G("",!0):(R(),F(v,{key:0,color:"primary",onClick:b,slot:"start"},{default:n(()=>[k(ue(h.value),1)]),_:1})),e(v,{color:"primary",onClick:D[6]||(D[6]=L=>i(H).hide()),slot:"end"},{default:n(()=>D[7]||(D[7]=[k("Close")])),_:1,__:[7]}),e(v,{class:"ion-margin-end",color:"success",onClick:A,slot:"end"},{default:n(()=>D[8]||(D[8]=[k("Save")])),_:1,__:[8]})]),_:1})]),_:1})],64)}}}),bn=ae({components:{IonGrid:ve,IonRow:oe,IonCol:O,TextInput:Se},props:{patient:{type:Object,required:!0}},setup(a){const{facility:t}=mt(),l=q(()=>a.patient.getArvNumber()),u=q(()=>!Y(l.value)&&l.value!=="Unknown"),m=ce({arvNumber:{value:u.value?l.value.split("-")[2]:"",label:"".concat(u.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async d=>{const f=re(d,"POSITIVE_INTEGERS");if(f!==null)return f;if(d.value===l.value.split("-")[2])return null;const V=await He.findByOtherID(4,"".concat(t.code,"-ARV-").concat(d.value));return V.ok?Y(V.data)?null:["ARV Number already taken"]:[V.errorMessage||V.clientErrorType||"Unable to determine ARV number with status: ".concat(V.httpStatusResponse)]}}});return{form:m,modal:H,arvNumber:l,facility:t,hasValidARVNumber:u,onFinish:async()=>Ue(m,async d=>{d.arvNumber!==l.value.split("-")[2]&&(u.value?await a.patient.updateARVNumber("".concat(t.code,"-ARV-").concat(d.arvNumber)):await a.patient.createArvNumber("".concat(t.code,"-ARV-").concat(d.arvNumber)),W.emit(x.RELOAD_PATIENT_DATA)),await H.hide()}),voidARV:async()=>{if(await Ne("Are you sure you want to void this ARV Number ".concat(l.value,"?"))){await le.show("Voiding ARV Number...");try{await De.postJson("/programs/".concat(sa,"/void_arv_number/").concat(l),{}),await le.hide(),await H.hide(),W.emit(x.RELOAD_PATIENT_DATA)}catch(f){await le.hide(),console.log(f)}}}}}});function _n(a,t,l,u,m,h){const s=w("ion-title"),d=w("ion-icon"),f=w("ion-button"),V=w("ion-buttons"),b=w("ion-toolbar"),g=w("ion-header"),T=w("text-input"),A=w("ion-col"),C=w("ion-row"),I=w("ion-grid"),_=w("ion-content"),D=w("ion-footer");return R(),z(J,null,[e(g,null,{default:n(()=>[e(b,null,{default:n(()=>[e(s,null,{default:n(()=>t[3]||(t[3]=[k("ARV NUMBER")])),_:1,__:[3]}),e(V,{slot:"end"},{default:n(()=>[e(f,{onClick:t[0]||(t[0]=S=>a.modal.hide())},{default:n(()=>[e(d,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(_,{class:"ion-padding"},{default:n(()=>[e(I,null,{default:n(()=>[e(C,null,{default:n(()=>[e(A,null,{default:n(()=>[e(T,{modelValue:a.form.arvNumber,"onUpdate:modelValue":t[1]||(t[1]=S=>a.form.arvNumber=S),form:a.form,prefix:"".concat(a.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),e(D,{class:"ion-padding-horizontal"},{default:n(()=>[e(b,null,{default:n(()=>[e(f,{color:"primary",onClick:t[2]||(t[2]=S=>a.modal.hide()),slot:"end"},{default:n(()=>t[4]||(t[4]=[k("Close")])),_:1,__:[4]}),a.hasValidARVNumber?(R(),F(f,{key:0,color:"danger",onClick:a.voidARV,slot:"start"},{default:n(()=>t[5]||(t[5]=[k("Void ARV Number")])),_:1,__:[5]},8,["onClick"])):G("",!0),e(f,{color:"success",onClick:a.onFinish,slot:"end"},{default:n(()=>t[6]||(t[6]=[k("Save")])),_:1,__:[6]},8,["onClick"])]),_:1})]),_:1})],64)}const yn=be(bn,[["render",_n]]),hn=ae({components:{VisitsSummary:an,InformationHeader:cn},setup(){const a=ra(),t=parseInt(a.params.patientId.toString())||0,l=E(),u=E(""),m=E([]),h=q(()=>!Y(l.value)),s=q(()=>{var C;return(C=l.value)==null?void 0:C.getNationalID()}),d=async()=>{if(t){const C=(await He.findByID(t)).data;C&&(l.value=new He(C))}},f=async()=>{m.value=await Sa.getGuardianDetails(t)},V=async C=>{await H.show(fn,{patientService:l.value,attribute:C})},b=async()=>{await H.show(gn,{patientId:t,guardians:m.value})},g=async()=>{await H.show(yn,{patient:l.value})},T=async()=>{var I;await le.show("Client has Invalid NPID. Assigning NPID...");const C=await He.assignNPID(t);C.ok?(await d(),await le.hide()):(await le.hide(),Be((I=C.errorMessage)!=null?I:"Failed to assign NPID"))},A=async()=>{var I;let C=!1;if(Na.value)C=!((I=l.value)==null?void 0:I.getDocID())||Da(s.value)||await Ra(t);else{const _=await Aa(s.value);C=!_||_.length>1}C&&await T()};return W.on(x.RELOAD_PATIENT_DATA,async()=>{await d()}),W.on(x.RELOAD_GUARDIAN_DATA,async()=>{await f()}),he(async()=>{var I;await Ia(),await d(),await A();const C=await((I=l.value)==null?void 0:I.getARTStartDate());u.value=C?pe(C):"N/A",f()}),{patient:l,artStartDate:u,guardians:m,isReady:h,updateDemographics:V,updateGuardian:b,updateARVNumber:g}}});function Vn(a,t,l,u,m,h){const s=w("information-header"),d=w("ion-col"),f=w("ion-row"),V=w("visits-summary"),b=w("ion-grid");return a.isReady?(R(),F(b,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[e(f,null,{default:n(()=>[e(d,{size:"12"},{default:n(()=>[a.patient?(R(),F(s,{key:0,patient:a.patient,guardians:a.guardians,artStartDate:a.artStartDate,onUpdateARVNumber:a.updateARVNumber,onUpdateGuardian:a.updateGuardian,onUpdatePatient:a.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):G("",!0)]),_:1})]),_:1}),e(f,null,{default:n(()=>[e(d,null,{default:n(()=>[a.patient?(R(),F(V,{key:0,patient:a.patient,startDate:a.artStartDate},null,8,["patient","startDate"])):G("",!0)]),_:1})]),_:1})]),_:1})):G("",!0)}const Xn=be(hn,[["render",Vn]]);export{Xn as default};
