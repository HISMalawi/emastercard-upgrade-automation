var $t=Object.defineProperty;var Ut=(e,a,l)=>a in e?$t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[a]=l;var ct=(e,a,l)=>(Ut(e,typeof a!="symbol"?a+"":a,l),l);import{D as Me,H as gt}from"./Date-a30e6d6f.js";import{G as Ve,F as bt,d as x,r as O,ae as ie,a6 as ve,a2 as _e,c as M,a as t,w as n,u as c,K as z,o as I,q as De,$ as We,b as k,S as Ye,i as re,j as ae,k as T,J as qe,s as Le,ar as xe,C as je,I as te,n as Je,ai as Ie,H as B,L as b,f as fe,h as U,y as H,at as Bt,t as oe,au as _t,N as Se,av as Ft,a5 as Ht,aw as Mt,l as qt,a4 as Lt,ax as Gt,p as zt,e as Wt,ay as Yt,U as jt,af as Jt,as as mt,az as Qt}from"./index-a3fc2e12.js";import{g as Kt,D as ht,C as He,P as Ge,O as Ue}from"./patient_service-5afecb64.js";import{g as Ke,i as W}from"./common-abc2f84d.js";import{A as ce,P as Xt,V as Zt,C as xt,E as pt}from"./consultation_service-4db27026.js";import{P as yt}from"./program_service-f2f47ad0.js";import{p as Vt}from"./VoidReason-28e88135.js";import{a as K,t as be,d as Z,c as ea}from"./his_date-1bddad28.js";import{_ as ge}from"./DateInput.vue_vue_type_style_index_0_lang-c93f6776.js";import{S as le}from"./SelectInput-1728ba18.js";import{N as ee,R as Ce}from"./regimen_service-46d436b5.js";import{t as ze,a as ta,g as aa}from"./DTFormElements-a1199b88.js";import{e as Te}from"./encounter_types-ae359711.js";import{s as Ne,i as na,r as oa,a as Be}from"./form-1795cc6c.js";import{E as q,a as L}from"./emc_event-4721851b.js";import{m as F,D as la}from"./DrilldownTable-df83cd6e.js";import{a as Oe,t as at}from"./toasts-d882244a.js";import{D as nt}from"./index-b8a0d675.js";import{_ as ne}from"./_plugin-vue_export-helper-c27b6911.js";import{T as Pe}from"./TextInput-7e75aa6a.js";import{g as ia,a as ra,b as sa}from"./location_options-6034f107.js";import{r as de,v as Fe,d as ue,e as vt,a as Ee,b as ua,c as wt}from"./validations-b9fbcec4.js";import{Y as pe}from"./YesNoInput-0c815f4b.js";import{c as da,u as ft}from"./arrays-31d2d38b.js";import{t as ca}from"./Strs-7ee8a435.js";import{P as et,R as Xe}from"./relations_service-bb9fac8a.js";import{l as Ze}from"./loader-1c88a23f.js";import"./patient_identifier_service-4b6c219d.js";import"./index-95d3a767.js";import"./vue-datepicker-7c4021ca.js";const ma=e=>{const a=e.given_name,l=e.family_name,s=e.middle_name?e.middle_name:"";return"".concat(a," ").concat(s," ").concat(l)};class pa{static getRelationships(a){return Ve.getJson("/people/".concat(a,"/relationships")).then(l=>l.data)}static async getGuardianDetails(a){return await this.getRelationships(a).then(l=>l.map(s=>{const d=Ke(s,"relation.names[0]");return{id:s.relationship_id,name:d?ma(d):"",relationshipType:Ke(s,"type.b_is_to_a",""),phoneNumber:Kt(Ke(s,"relation.person_attributes",[]),12),names:d}}))}}const Ae=class Ae extends ce{constructor(a){super(a,Te.LAB_ORDERS,K())}async loadConcepts(){Ae.conceptID=await ce.getConceptID("HIV Viral Load")}createLabOrder(a,l){const s=Ve.getUsername(),d=bt().facility.name,g=ce.getCachedConceptID(l,!0);return Ve.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:s,target_lab:d,reason_for_test_id:g,encounter_id:this.encounterID,tests:[{concept_id:Ae.conceptID}],date:this.date,specimen:{concept_id:a}}]})}createLabResult(a,l,s,d="numeric"){return Ve.postJson("lab/tests/".concat(a,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Ae.conceptID},value:l,value_modifier:s,value_type:d}]})}static getSpecimens(a){return Ve.getJson("/lab/specimen_types",{test_type:a})}static async getOrders(a,l={}){var d;return(d=(await Ve.getJson("/lab/orders",{patient_id:a,...l})).data)!=null?d:[]}static async getViralLoadResultTrail(a,l={}){return(await this.getOrders(a,l)).reduce((d,g)=>(g.tests.forEach(i=>i.result.forEach(u=>d.push({...g,test:i.name,result:"".concat(u.value_modifier," ").concat(u.value),result_date:u.date}))),d),[])}static async getlatestViralLoadResult(a,l={}){const d=(await this.getOrders(a,l)).reduce((g,i)=>(g.push(...i.tests.flatMap(u=>u.result)),g),[]).sort((g,i)=>new Date(g.date)>new Date(i.date)?-1:1);return d&&d.length>0?"".concat(d[0].value_modifier).concat(d[0].value," (").concat(be(d[0].date),")"):"N/A"}};ct(Ae,"conceptID",-1);let we=Ae;const va=x({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=O(!1),s=ze(["=",">","<",">=","<="]),d=ze(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),g=O([]),i=a.patient.getBirthdate(),u=ie({orderDate:{value:"",label:"Order Date",required:!0,validation:async _=>Z(_.value).isValid()?new Date(_.value)>new Date(K())?["Order date cannot be in the future"]:new Date(_.value)<new Date(i)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(_,h)=>Z(_.value).isValid()?new Date(_.value)>new Date(K())?["Result date cannot be in the future"]:new Date(_.value)<new Date(h.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function p(){Ne(u,async _=>{const h=new we(a.patient.getID());if(await h.loadConcepts(),h.setDate(_.orderDate),!await h.createEncounter())throw new Error("Unable to create lab order encounter");const w=await h.createLabOrder(_.specimen.value,_.reason.value);if(!w.ok||!w.data)throw new Error("Unable to save lab orders");const R=new we(a.patient.getID());if(R.setDate(_.resultDate),!await R.createEncounter())throw new Error("Unable to create lab result encounter");const v=l.value?"LDL":parseInt(_.result),V=l.value?"=":_.modifier.value,P=l.value?"text":"numeric",$=w.data[0].tests[0].id;await R.createLabResult($,v,V,P),await F.hide(),q.emit(L.RELOAD_LATEST_VL_RESULT),q.emit(L.RELOAD_PATIENT_VISIT_DATA)})}async function y(){if(await Ie("Are you sure you want to clear all fields?")){l.value=!1;for(const _ in u)u[_].value="",u[_].error="";q.emit(L.ON_CLEAR)}}return ve(l,_=>{_&&(u.modifier.value="",u.result.value=void 0,u.modifier.error="",u.result.error=""),u.modifier.disabled=_,u.modifier.required=!_,u.result.disabled=_,u.result.required=!_}),_e(async()=>{g.value=(await we.getSpecimens("HIV viral load")).data.map(_=>({label:_.name,value:_.concept_id}))}),(_,h)=>(I(),M(z,null,[t(c(Ye),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(We),null,{default:n(()=>[k("Viral Load Results")]),_:1})]),_:1})]),_:1}),t(c(je),{class:"ion-padding"},{default:n(()=>[t(c(re),{style:{width:"100%"}},{default:n(()=>[t(c(ae),null,{default:n(()=>[t(c(T),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:u.orderDate,"onUpdate:modelValue":h[0]||(h[0]=N=>u.orderDate=N),form:u,minDate:c(i),maxDate:c(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:u.reason,"onUpdate:modelValue":h[1]||(h[1]=N=>u.reason=N),options:c(d)},null,8,["modelValue","options"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:u.specimen,"onUpdate:modelValue":h[2]||(h[2]=N=>u.specimen=N),options:g.value},null,8,["modelValue","options"])]),_:1}),t(c(T),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:u.resultDate,"onUpdate:modelValue":h[3]||(h[3]=N=>u.resultDate=N),form:u,minDate:u.orderDate.value,"max-date":c(K)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:u.modifier,"onUpdate:modelValue":h[4]||(h[4]=N=>u.modifier=N),options:c(s)},null,8,["modelValue","options"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:u.result,"onUpdate:modelValue":h[5]||(h[5]=N=>u.result=N),form:u,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),t(c(ae),{class:"ion-margin-top"},{default:n(()=>[t(c(T),{size:"12"},{default:n(()=>[t(c(qe),{class:"ion-padding-vertical bold"},{default:n(()=>[k(" Other Results Options: ")]),_:1}),t(c(Le),null,{default:n(()=>[t(c(qe),null,{default:n(()=>[k("LDL")]),_:1}),t(c(xe),{slot:"start",modelValue:l.value,"onUpdate:modelValue":h[6]||(h[6]=N=>l.value=N)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(c(Je),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(te),{color:"primary",onClick:h[7]||(h[7]=N=>c(F).hide()),slot:"end"},{default:n(()=>[k(" Close ")]),_:1}),t(c(te),{color:"warning",onClick:y,slot:"end"},{default:n(()=>[k(" Reset ")]),_:1}),t(c(te),{color:"success",onClick:p,slot:"end"},{default:n(()=>[k(" Save ")]),_:1})]),_:1})]),_:1})],64))}}),fa=x({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:nt},emits:["voidOutcome"],setup(e,{emit:a}){const l=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:i=>Z(i).format(Me)},{path:"end_date",label:"End Date",formatter:i=>Z(i).format(Me)}],s={showSearchField:!1,showSubmitButton:!1};return{rows:B(()=>e.patientStates.map((i,u)=>({...i,index:u}))),columns:l,tableConfig:s,TableRowActions:[{label:"void",color:"danger",action:async i=>{await Ie("Are you sure you want to void this outcome?")&&a("voidOutcome",{stateId:i.patient_state_id,index:i.index})}}]}}}),ga=fe("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1);function ba(e,a,l,s,d,g){const i=b("data-table");return I(),M(z,null,[ga,t(i,{rows:e.rows,columns:e.columns,config:e.tableConfig,"row-actions-buttons":e.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const _a=ne(fa,[["render",ba]]),ha=x({name:"EnrollmentForm",components:{DateInput:ge,IonGrid:re,IonRow:ae,IonCol:T,IonButton:te},props:["birthdate"],emits:["enrollProgram"],setup(e,{emit:a}){const l=Z().format("YYYY-MM-DD"),s=ie({date:{value:"",label:"Date of Enrollment",required:!0,validation:async i=>new Date(i.value)<new Date(e.birthdate)?["Date of enrollment cannot be before date of birth"]:new Date(i.value)>new Date(l)?["Date of enrollment cannot be in the future"]:null}});return{form:s,today:l,onReset:async()=>{await Ie("Are you sure you want to clear all fields")&&(s.date.value="",s.date.error="",q.emit(L.ON_CLEAR))},enrollProgram:async()=>Ne(s,({date:i})=>a("enrollProgram",i))}}});function ya(e,a,l,s,d,g){const i=b("DateInput"),u=b("ion-col"),p=b("ion-button"),y=b("ion-row"),_=b("ion-grid");return I(),U(_,null,{default:n(()=>[t(y,null,{default:n(()=>[t(u,{size:"12"},{default:n(()=>[t(i,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=h=>e.form.date=h),form:e.form,minDate:e.birthdate,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(u,null,{default:n(()=>[t(p,{color:"warning",onClick:e.onReset},{default:n(()=>[k("Reset")]),_:1},8,["onClick"]),t(p,{color:"success",onClick:e.enrollProgram},{default:n(()=>[k("Enroll")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Va=ne(ha,[["render",ya]]),wa=x({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:ge,IonGrid:re,IonRow:ae,IonCol:T,IonButton:te,SelectInput:le,TextInput:Pe},emits:["saveOutcome"],setup(e,{emit:a}){const l=Z().format("YYYY-MM-DD"),s=ie({date:{value:"",label:"Outcome Date",required:!0,validation:async p=>new Date(p.value)<new Date(e.birthdate)?["Outcome date cannot be before date of birth - ".concat(Z(e.birthdate).format(Me))]:new Date(p.value)<new Date(e.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(Z(e.dateEnrolled).format(Me))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(p,y)=>y.status.value.label==="Patient transferred out"&&de(p)},reason:{value:"",label:"Reason for transfer out",validation:async(p,y)=>y.status.value.label==="Patient transferred out"&&de(p)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(p,y)=>{var _,h,N,w;return((h=(_=y.status)==null?void 0:_.value)==null?void 0:h.label)==="Patient transferred out"&&((w=(N=y.reason)==null?void 0:N.value)==null?void 0:w.label)==="Other"&&de(p)}}}),d=B(()=>{var p;return((p=s.status.value)==null?void 0:p.label)==="Patient transferred out"}),g=B(()=>{var p,y;return((y=(p=s.reason)==null?void 0:p.value)==null?void 0:y.label)==="Other"});return{form:s,today:l,isTransferredOut:d,specifyOther:g,onSave:()=>Ne(s,p=>a("saveOutcome",{...p,isTransferredOut:d.value})),onReset:async()=>{if(await Ie("are you sure you want to clear all fields")){for(const p in s)s[p].value="",s[p].error="";q.emit(L.ON_CLEAR)}},getFacilities:ia,transferOutReasons:ta}}}),Da=fe("p",null,"Add New Outcome",-1);function Ia(e,a,l,s,d,g){const i=b("ion-col"),u=b("DateInput"),p=b("SelectInput"),y=b("text-input"),_=b("ion-button"),h=b("ion-row"),N=b("ion-grid");return I(),U(N,null,{default:n(()=>[t(h,null,{default:n(()=>[t(i,{size:"12"},{default:n(()=>[Da]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(u,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=w=>e.form.date=w),form:e.form,minDate:e.dateEnrolled,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(p,{modelValue:e.form.status,"onUpdate:modelValue":a[1]||(a[1]=w=>e.form.status=w),form:e.form,options:e.outcomes},null,8,["modelValue","form","options"])]),_:1}),e.isTransferredOut?(I(),M(z,{key:0},[t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(p,{modelValue:e.form.nextFacility,"onUpdate:modelValue":a[2]||(a[2]=w=>e.form.nextFacility=w),form:e.form,asyncOptions:e.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(p,{modelValue:e.form.reason,"onUpdate:modelValue":a[3]||(a[3]=w=>e.form.reason=w),form:e.form,options:e.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),e.specifyOther?(I(),U(i,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[t(y,{modelValue:e.form.otherReason,"onUpdate:modelValue":a[4]||(a[4]=w=>e.form.otherReason=w),form:e.form},null,8,["modelValue","form"])]),_:1})):H("",!0)],64)):H("",!0),t(i,{size:"12",class:"ion-margin-top"},{default:n(()=>[t(_,{color:"warning",onClick:e.onReset},{default:n(()=>[k("Reset")]),_:1},8,["onClick"]),t(_,{color:"success",onClick:e.onSave},{default:n(()=>[k("Save")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Na=ne(wa,[["render",Ia]]),Ra=x({components:{IonContent:je,IonFooter:Je,IonHeader:Ye,IonTitle:We,IonToolbar:De,IonButton:te,IonGrid:re,IonRow:ae,IonCol:T,IonBadge:Bt,OutcomesTable:_a,EnrollmentForm:Va,OutcomeForm:Na},props:{patient:{type:Object,required:!0}},setup(e){const{toStandardHisDisplayFormat:a,toStandardHisFormat:l}=gt,s=new Xt(e.patient.getID()),d=B(()=>l(e.patient.getBirthdate())),g=O(),i=B(()=>!W(g.value)),u=O(""),p=O(),y=B(()=>{var D,v,V;return(V=(v=(D=g.value)==null?void 0:D.patient_states)==null?void 0:v.length)!=null?V:0}),_=B(()=>i.value&&u.value?"Patient enrolled in this porgram on ".concat(a(u.value)):"Patient is not enrolled in this program"),h=async({date:D,status:v,nextFacility:V,reason:P,otherReason:$,isTransferredOut:A})=>{if(s.setStateDate(D),s.setStateId(v.value),A){const C=P.value!=="Other"?P.value:$;await s.transferOutEncounter(V.other,C)}await s.updateState(),await Oe("Outcome saved successfully",1e3),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},N=async D=>{s.setProgramDate(D),await s.enrollProgram(),await Oe("Program enrolled successfully",1e3),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},w=async()=>{var D;s.setPatientProgramId(((D=g.value)==null?void 0:D.patient_program_id)||-1),await s.voidProgram("duplicate / system error"),await Oe("Patient voided from program successfully",1e3),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA)},R=async({stateId:D,index:v})=>{var V;s.setStateId(D),await s.voidState("duplicate / system error"),Oe("Outcome voided successfully"),(V=g.value)==null||V.patient_states.splice(v,1),q.emit(L.RELOAD_PATIENT_VISIT_DATA)};return _e(async()=>{const D=(await s.getPrograms()).data;if(g.value=D.find(v=>v.program.name==="HIV PROGRAM"),g.value){u.value=g.value.date_enrolled;const v=await s.getProgramOutcomes(),V=new Set(s.removedStates);p.value=v.map(P=>({label:P.name,value:P.program_workflow_state_id,other:P})).filter(P=>!V.has(P.label))}}),{modal:F,patientProgram:s,isEnrolled:i,enrollDate:u,birthdate:d,enrollmentStatus:_,outcomes:p,program:g,totalStates:y,toStandardHisDisplayFormat:a,saveOutcome:h,enrollProgram:N,voidProgram:w,voidOutcome:R}}});function Aa(e,a,l,s,d,g){const i=b("ion-title"),u=b("ion-toolbar"),p=b("ion-header"),y=b("ion-badge"),_=b("ion-col"),h=b("ion-row"),N=b("enrollment-form"),w=b("outcome-form"),R=b("outcomes-table"),D=b("ion-grid"),v=b("ion-content"),V=b("ion-button"),P=b("ion-footer");return I(),M(z,null,[t(p,null,{default:n(()=>[t(u,null,{default:n(()=>[t(i,null,{default:n(()=>[k("Patient Outcomes")]),_:1})]),_:1})]),_:1}),t(v,null,{default:n(()=>[t(D,{style:{width:"100%"}},{default:n(()=>[t(h,null,{default:n(()=>[t(_,null,{default:n(()=>[t(y,{color:"lightblue",class:"ion-padding",style:{width:"100%"},disabled:""},{default:n(()=>[k(oe(e.enrollmentStatus),1)]),_:1})]),_:1})]),_:1}),e.isEnrolled?(I(),M(z,{key:1},[e.outcomes?(I(),U(h,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[t(w,{"date-enrolled":e.enrollDate,birthdate:e.birthdate,outcomes:e.outcomes,onSaveOutcome:e.saveOutcome},null,8,["date-enrolled","birthdate","outcomes","onSaveOutcome"])]),_:1})):H("",!0),t(h,{class:"his-card",style:_t({minHeight:e.totalStates?"0":"30vh"})},{default:n(()=>[t(_,{size:"12",class:"ion-no-padding"},{default:n(()=>{var $;return[t(R,{patientStates:($=e.program)==null?void 0:$.patient_states,onVoidOutcome:e.voidOutcome},null,8,["patientStates","onVoidOutcome"])]}),_:1})]),_:1},8,["style"])],64)):(I(),U(h,{key:0,class:"his-card",style:{"margin-bottom":".4rem"}},{default:n(()=>[t(_,{size:"12"},{default:n(()=>[t(N,{patientProgram:e.patientProgram,birthdate:e.birthdate,onEnrollProgram:e.enrollProgram},null,8,["patientProgram","birthdate","onEnrollProgram"])]),_:1})]),_:1}))]),_:1})]),_:1}),t(P,null,{default:n(()=>[t(u,null,{default:n(()=>[t(V,{color:"primary",onClick:a[0]||(a[0]=$=>e.modal.hide()),slot:"end"},{default:n(()=>[k("Close")]),_:1}),e.isEnrolled?(I(),U(V,{key:0,color:"danger",onClick:e.voidProgram,slot:"end"},{default:n(()=>[k("Void Program")]),_:1},8,["onClick"])):H("",!0)]),_:1})]),_:1})],64)}const Sa=ne(Ra,[["render",Aa]]),Pa=x({name:"MultiColumnView",components:{IonGrid:re,IonRow:ae,IonCol:T},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(e){const a={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:B(()=>da(e.items,Math.ceil(e.items.length/e.numberOfColumns))),grid:a}}});function Ta(e,a,l,s,d,g){const i=b("ion-col"),u=b("ion-row"),p=b("ion-grid");return I(),U(p,null,{default:n(()=>[t(u,null,{default:n(()=>[(I(!0),M(z,null,Se(e.computedItems,(y,_)=>(I(),U(i,{key:_,size:e.grid[e.numberOfColumns]},{default:n(()=>[Ft(e.$slots,"default",{entries:y})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const tt=ne(Pa,[["render",Ta]]);class Ca extends ce{constructor(a,l=K()){super(a,Te.HIV_RECEPTION,l)}}class Oa extends ce{constructor(a,l=K()){super(a,Te.ART_ADHERENCE,l)}buildPillCountObs(a,l){return this.buildValueNumber("Number of tablets brought to clinic",l,null,a)}async buildAdherenceObs(a,l,s){return{concept_id:await ce.getConceptID("Drug adherence",!0),value_numeric:s,value_drug:l,value_modifier:"%",order_id:a,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(a,l,s){return Math.round(100*(a-l)/(a-s))}calculateExpected(a,l,s,d){const g=d==="QW"?"week":"day",i=this.calcTimeElapsed(s,g);return a-i*parseFloat(l.toString())}calcTimeElapsed(a,l){return Z(this.date).diff(a,l)+1}}class Ea extends ce{constructor(a,l=K()){super(a,Te.APPOINTMENT,l)}}class ka extends ce{constructor(a,l=K()){super(a,Te.TREATMENT,l)}calculateDosage(a,l){let s=0;return l===0&&(s=a),a==0&&(s=l),a>0&&l>0&&(s=(a+l)/2),s}calculateEquivalentDosage(a,l){return a+l}calculateDrugRunOutDate(a,l){return ea(Z(l).add(a,"days"))}getInstructions(a,l,s,d){return"".concat(a," :- Morning: ").concat(l," ").concat(d,", Evening: ").concat(s," ").concat(d)}toDrugOrder(a,l,s,d){return{drug_inventory_id:a.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(a.am,a.pm),start_date:d,auto_expire_date:this.calculateDrugRunOutDate(s,d),units:a.units,instructions:this.getInstructions(a.drug_name,a.am,a.pm,a.units),dose:this.calculateDosage(a.am,a.pm),frequency:a.frequency,qty:l}}async createDrugOrder(a){return ht.create({encounter_id:this.encounterID,drug_orders:a})}}class $a{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(a,l,s){let d={result:"",color:"",index:s};if(s<=0)return d.index=0,d;if(l<5&&l>0)d.result="Use MUAC to calculate nutrition status",d.color="red";else{l>18&&(l=19);const g=await this.getBMIData(),i=g[a][l];i&&(d=this.buildBounds(Object.keys(i),i,s,g.colors))}return d}static buildBounds(a,l,s,d){const g={result:"",color:"",index:s};return a.forEach(i=>{if(i.indexOf("-")>=0){const u=i.split("-");s>=parseFloat(u[0])&&s<=parseFloat(u[1])&&(g.result=l[i],g.color=d[l[i]])}else if(i.indexOf("<")>=0){const u=i.replace("<","");s<parseFloat(u)&&(g.result=l[i],g.color=d[l[i]])}else if(i.indexOf(">=")>=0){const u=i.replace(">=","");s>=parseFloat(u)&&(g.result=l[i],g.color=d[l[i]])}}),g}static getBMI(a,l,s,d){const g=this.calculateBMI(a,l);return this.getBMIResult(s,d,g)}static calculateBMI(a,l){if(l==0||a==0)return 0;let s=a/l/l*1e4;return s=Math.round(s*10)/10}}class Ua extends ce{constructor(a,l=K()){super(a,Te.DISPENSING,l)}buildDispensations(a,l,s){const d=[];for(let g=0;g<s;g++)d.push({drug_order_id:a,date:this.date,quantity:l/s});return d}saveDispensations(a){return Ve.postJson("/dispensations",{dispensations:a,program_id:this.programID})}}const Ba=x({__name:"PatientVisit",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=B(()=>a.patient.getID()),s=new Zt(l.value),d=new xt(l.value),g=new ka(l.value),i=new Ua(l.value),u=new Ca(l.value),p=new Oa(l.value),y=new Ea(l.value),_=O(),h=O(),N=O([]),w=O([]),R=O([]),D=O([]),v=B(()=>!(_.value&&a.patient.getAge()>18)),V=B(()=>a.patient.isFemale()),P=O(""),$=a.patient.getBirthdate(),A=O(!1),C=ie({}),r=ie({visitDate:{value:Z().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async o=>new Date(o.value)>new Date(K())?["Visit date cannot be after today's date"]:new Date(o.value)<new Date($)?["Visit date cannot be before patient's birth date"]:null},weight:{value:void 0,label:"Weight",required:!0,computedValue:o=>({tag:"vitals",obs:s.buildValueNumber("Weight",o)}),validation:(o,f)=>(W(o)||!o.value)&&f.patientPresent.value==="No"?null:Fe([()=>de(o),()=>ue(o,"DECIMALS"),()=>vt(o,2,250)])},height:{value:void 0,label:"Height",computedValue:o=>({tag:"vitals",obs:s.buildValueNumber("Height",o)}),validation:o=>!v.value||(W(o)||!o.value)&&r.patientPresent.value==="No"?null:Fe([()=>de(o),()=>ue(o),()=>vt(o,20,220)])},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:V.value,computedValue:o=>({tag:"consultation",obs:d.buildValueCoded("Is patient pregnant",o)}),validation:async o=>V.value&&de(o)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:V.value,computedValue:o=>({tag:"consultation",obs:d.buildValueCoded("Is patient breast feeding",o)}),validation:async o=>V.value&&de(o)},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:o=>({tag:"appointment",obs:y.buildValueDate("Appointment date",o)}),validation:async(o,f)=>new Date(o.value)<new Date(f.visitDate.value)?["Appointment date cannot be before visit date"]:new Date(o.value)>new Date(P.value)?["Appointment date cannot be after drug run out date"]:null},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:o=>({tag:"reception",obs:u.buildValueCoded("Patient present",o)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:o=>({tag:"reception",obs:u.buildValueCoded("Guardian present",o)})},pillCount:{value:void 0,label:"Pill Count",required:D.value.length>0,validation:async o=>D.value.length>0&&ue(o)},regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:g.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:g.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:g.buildValueCoded("Medication orders","INH")}),validation:async(o,f)=>{var m,E;return(((m=f.tbMed.value)==null?void 0:m.label)==="6H"||((E=f.tbMed.value)==null?void 0:E.label)==="3HP (RFP + INH)")&&ue(o)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:g.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(o,f)=>{var m;return((m=f.tbMed.value)==null?void 0:m.label)==="3HP (RFP + INH)"&&ue(o)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:g.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(o,f)=>{var m;return((m=f.tbMed.value)==null?void 0:m.label)==="3HP (INH 300 / RFP 300)"&&ue(o)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(o,f)=>{var m;return((m=f.tbMed.value)==null?void 0:m.label)&&ue(o)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async o=>Fe([()=>de(o),()=>o.value==="No"||w.value.some(f=>f.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async o=>Fe([()=>de(o),()=>o.value==="No"||R.value.some(f=>f.isChecked)?null:["Please select at least one side effect"]])},tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:o=>({tag:"consultation",obs:d.buildValueCoded("TB Status",o.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async o=>{if(!A.value){if(new Date(o.value)>new Date(K()))return["TB treatment start date cannot be after today's date"];if(new Date(o.value)<new Date($))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:o=>({tag:"consultation",obs:d.buildValueDate("TB treatment start date",o)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:o=>({tag:"consultation",obs:d.buildValueNumber("TB treatment period",o)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:o=>({tag:"consultation",obs:d.buildGroupValueCoded("TB screening method used","chest xray",o)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:o=>({tag:"consultation",obs:d.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",o)})}}),j=async(o,f)=>{const m={label:"Unkown",value:"Unkown",other:[{drug_id:1046,drug_name:"Unknown ARV",am:1,pm:0,units:"",frequency:"Daily (QOD)"}]},E=(await Ce.getRegimensByWeight(o,f)).data;return W(E)?[m]:Object.keys(E).map(J=>({label:J,value:J,other:E[J]})).concat([m])};ve(()=>r.regimen.value,o=>{var f;Qe(),o&&((f=o==null?void 0:o.other)==null||f.forEach(m=>{var E;C[m.drug_name]={label:"".concat((E=m.alternative_drug_name)!=null?E:m.drug_name," given"),value:0,required:!0,validation:J=>ue(J,"POSITIVE_INTEGERS")}}))}),ve(r.patientPresent,o=>{o.value==="No"?(r.weight.required=!1,r.weight.error="",r.guardianPresent.value="Yes"):r.weight.required=!0}),ve(r.guardianPresent,o=>{o.value==="No"&&(r.patientPresent.value="Yes")}),ve([()=>r.weight.value,()=>r.tbStatus.value],async([o,f])=>{var E;r.regimen.value=void 0,Qe();const m=/confirmed/i.test((E=f==null?void 0:f.label)!=null?E:"");o?(N.value=await j(r.weight.value,m),r.patientPresent.value="Yes",r.patientPresent.disabled=!0):!o&&r.weight.required&&(r.patientPresent.value=void 0,r.patientPresent.disabled=!1),r.tbMed.disabled=m||A.value});const se=()=>{var o,f;return W(C)?1/0:Math.min(...(f=(o=r.regimen.value)==null?void 0:o.other)==null?void 0:f.map(m=>{var E,J,me,ke,$e;return((J=(E=C[m.drug_name])==null?void 0:E.value)!=null?J:0)/(((me=m.am)!=null?me:0)+((ke=m.noon)!=null?ke:0)+(($e=m.pm)!=null?$e:0))||1}))};ve([()=>C,()=>r.pillCount.value,()=>r.visitDate.value],()=>{const o=parseInt(r.pillCount.value)||0,f=se();f!==1/0&&(P.value=g.calculateDrugRunOutDate(f+o,r.visitDate.value),r.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(be(P.value),")"),r.nextAppointmentDate.value=P.value)},{deep:!0}),ve(()=>r.visitDate.value,()=>lt());const he=B(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (INH 300 / RFP 300)"}),G=B(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (RFP + INH)"}),S=B(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="6H"}),Re=B(()=>r.hasContraindications.value==="Yes"),ot=B(()=>r.hasSideEffects.value==="Yes"),Dt=B(()=>{var o;return/Confirmed TB on treatment/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),It=B(()=>{var o;return/Suspected/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),Nt=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Rt=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],At=ze(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),St=ze(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),lt=async()=>{d.setDate(r.visitDate.value),A.value=!1;const o=await d.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(o)){const f=await d.getFirstValueDatetime("TB treatment start date"),m=await d.getFirstValueNumber("TB treatment period")||6;if(f){const E=Z(r.visitDate.value).diff(f,"months");A.value=E<=m}}r.tbStatus.required=!A.value},Pt=async o=>{const f=o.height||_.value,m=$a.calculateBMI(o.weight,f);return s.buildValueNumber("BMI",m)},Tt=async()=>{const o=[await d.buildValueCoded("Patient using family planning","No")];return d.getFamilyPlanningMethods().forEach(async m=>{o.push(await d.buildValueCoded(m,"No"))}),o},Ct=async()=>Promise.all(He.getConceptsByCategory("tb_symptom",!0).map(async o=>d.buildGroupValueCoded(o.name,o.name,"No"))),Ot=async()=>{s.setDate(r.visitDate.value),d.setDate(r.visitDate.value),g.setDate(r.visitDate.value),u.setDate(r.visitDate.value),p.setDate(r.visitDate.value),y.setDate(r.visitDate.value),i.setDate(r.visitDate.value),await Ne(r,async(o,f)=>{var it,rt,st,ut,dt;const m=[];let E=0;if(!W(o.regimen)&&await na(C)){const X=o.regimen.other,Q=oa(C).formData;E=se(),X.forEach(Y=>m.push(g.toDrugOrder(Y,Q[Y.drug_name],E,o.visitDate)))}else if(!await Ie("Are you sure you want to continue without dispensing ART drugs?"))return;if(o.totalCPTGiven&&ft((await Ce.getRegimenExtras("Cotrimoxazole",(it=o.weight)!=null?it:h.value)).data,"concept_name").filter(X=>X.frequency==="Daily (QOD)").forEach(X=>m.push(g.toDrugOrder(X,o.totalCPTGiven,E,o.visitDate))),(rt=o.tbMed)!=null&&rt.value){const X=ft((await Ce.getRegimenExtras("INH",(st=o.weight)!=null?st:h.value)).data,["concept_name","frequency"]),Q=X.find(Y=>Y.concept_name==="Pyridoxine");if(Q&&o.totalPyridoxineGiven&&m.push(g.toDrugOrder(Q,o.totalPyridoxineGiven,E,o.visitDate)),o.totalIPTGiven){const Y=X.find(ye=>ye.concept_name==="Isoniazid"&&(S.value&&ye.frequency==="Daily (QOD)"||G.value&&ye.frequency==="Weekly (QW)"));m.push(g.toDrugOrder(Y,o.totalIPTGiven,E,o.visitDate))}if(o.totalRFPGiven&&G.value){const Y=(await Ce.getRegimenExtras("Rifapentine",(ut=o.weight)!=null?ut:h.value)).data;Y.length&&m.push(g.toDrugOrder(Y[0],o.totalRFPGiven,E,o.visitDate))}if(o.total3HPGiven&&he.value){const Y=(await Ce.getRegimenExtras("INH / RFP",(dt=o.weight)!=null?dt:h.value)).data;m.push(g.toDrugOrder(Y[0],o.total3HPGiven,E,o.visitDate))}}if(!W(m)){await g.createEncounter();const Q=(await g.createDrugOrder(m)).data.map(Y=>{const ye=m.find(kt=>kt.drug_inventory_id===Y.drug_inventory_id);return i.buildDispensations(Y.order_id,ye.qty,1)});await i.saveDispensations(Q.flat(1))}const J=await Be(f,"vitals");if(!W(J)){await s.createEncounter();const X=await Pt(o);await s.saveObservationList([...J,X])}await d.createEncounter();const me=await Be(f,"consultation");me.push(...await d.buildOptionsGroupObs("Malawi ART side effects",w.value)),me.push(...await Ct()),ot.value&&me.push(...await d.buildOptionsGroupObs("Other side effect",R.value)),V.value&&me.push(...await Tt()),await d.saveObservationList(me),await u.createEncounter();const ke=await Be(f,"reception");if(await u.saveObservationList(ke),D.value.length>0){await p.createEncounter();const X=await Promise.all(D.value.map(async Q=>{const Y=p.calculateExpected(Q.quantity,Q.equivalent_daily_dose,Q.order.start_date,Q.frequency),ye=p.calculateAdherence(Q.quantity,o.pillCount,Y);return[await p.buildAdherenceObs(Q.order_id,Q.drug_inventory_id,ye),await p.buildPillCountObs(Q.order_id,o.pillCount)]}));await p.saveObservationList(X.flat(1))}await y.createEncounter();const $e=await Be(f,"appointment");await y.saveObservationList($e),await Oe("Patient visit saved successfully"),await F.hide(),q.emit(L.RELOAD_PATIENT_VISIT_DATA),q.emit(L.RELOAD_STAGING_INFORMATION)})},Et=async()=>{if(await Ie("Are you sure you want to clear all fields?")){for(const o in r)r[o].value="",r[o].error="",r[o].disabled=!1;Qe(),q.emit(L.ON_CLEAR)}},Qe=()=>{for(const o in C)delete C[o]};return _e(async()=>{try{await lt(),_.value=await a.patient.getRecentHeight(),h.value=await a.patient.getRecentWeight(),h.value&&(N.value=await j(h.value)),D.value=(await ht.getLastDrugsReceived(a.patient.getID())).data,r.pillCount.required=D.value.length>0,w.value=He.getConceptsByCategory("contraindication",!0).map(o=>({value:o.concept_id,label:o.name,other:o})),R.value=He.getConceptsByCategory("side_effect",!0).map(o=>({value:o.concept_id,label:o.name,other:o}))}catch(o){at("Form initialization failed. Try to refresh the page"),console.error(o)}}),(o,f)=>(I(),M(z,null,[t(c(Ye),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(We),null,{default:n(()=>[k("Patient Visit")]),_:1})]),_:1})]),_:1}),t(c(je),{class:"ion-padding"},{default:n(()=>[t(c(re),{style:{width:"100%"}},{default:n(()=>[t(c(ae),null,{default:n(()=>[t(c(T),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:r.visitDate,"onUpdate:modelValue":f[0]||(f[0]=m=>r.visitDate=m),form:r,minDate:c($),maxDate:c(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.patientPresent,"onUpdate:modelValue":f[1]||(f[1]=m=>r.patientPresent=m),inline:"",disabled:r.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.guardianPresent,"onUpdate:modelValue":f[2]||(f[2]=m=>r.guardianPresent=m),inline:""},null,8,["modelValue"])]),_:1}),V.value?(I(),M(z,{key:0},[t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.isPregnant,"onUpdate:modelValue":f[3]||(f[3]=m=>r.isPregnant=m),inline:""},null,8,["modelValue"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.isBreastfeeding,"onUpdate:modelValue":f[4]||(f[4]=m=>r.isBreastfeeding=m),inline:""},null,8,["modelValue"])]),_:1})],64)):H("",!0),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.hasContraindications,"onUpdate:modelValue":f[5]||(f[5]=m=>r.hasContraindications=m),inline:""},null,8,["modelValue"]),Re.value?(I(),U(tt,{key:0,items:w.value,numberOfColumns:2},{default:n(({entries:m})=>[(I(!0),M(z,null,Se(m,E=>(I(),U(c(Le),{lines:"none",key:E.value},{default:n(()=>[t(c(qe),null,{default:n(()=>[k(oe(E.label),1)]),_:2},1024),t(c(xe),{slot:"start",modelValue:E.isChecked,"onUpdate:modelValue":J=>E.isChecked=J},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):H("",!0)]),_:1}),t(c(T),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[t(pe,{modelValue:r.hasSideEffects,"onUpdate:modelValue":f[6]||(f[6]=m=>r.hasSideEffects=m),inline:""},null,8,["modelValue"]),ot.value?(I(),U(tt,{key:0,items:R.value,numberOfColumns:2},{default:n(({entries:m})=>[(I(!0),M(z,null,Se(m,E=>(I(),U(c(Le),{lines:"none",key:E.value},{default:n(()=>[t(c(qe),null,{default:n(()=>[k(oe(E.label),1)]),_:2},1024),t(c(xe),{slot:"start",modelValue:E.isChecked,"onUpdate:modelValue":J=>E.isChecked=J},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):H("",!0)]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.weight,"onUpdate:modelValue":f[7]||(f[7]=m=>r.weight=m),form:r,min:1},null,8,["modelValue","form"])]),_:1}),v.value?(I(),U(c(T),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.height,"onUpdate:modelValue":f[8]||(f[8]=m=>r.height=m),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),A.value?H("",!0):(I(),U(c(T),{key:2,class:"ion-margin-vertical",size:v.value?"12":"6"},{default:n(()=>[t(le,{modelValue:r.tbStatus,"onUpdate:modelValue":f[9]||(f[9]=m=>r.tbStatus=m),options:c(St)},null,8,["modelValue","options"])]),_:1},8,["size"])),Dt.value?(I(),M(z,{key:3},[t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:r.tbTreatmentStartDate,"onUpdate:modelValue":f[10]||(f[10]=m=>r.tbTreatmentStartDate=m),form:r,minDate:c($),maxDate:c(K)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.tbTreatmentPeriod,"onUpdate:modelValue":f[11]||(f[11]=m=>r.tbTreatmentPeriod=m),form:r,min:1},null,8,["modelValue","form"])]),_:1})],64)):It.value?(I(),M(z,{key:4},[t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.cxrResult,"onUpdate:modelValue":f[12]||(f[12]=m=>r.cxrResult=m),"custom-options":Nt},null,8,["modelValue"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(pe,{modelValue:r.mwrdResult,"onUpdate:modelValue":f[13]||(f[13]=m=>r.mwrdResult=m),"custom-options":Rt},null,8,["modelValue"])]),_:1})],64)):H("",!0),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:r.regimen,"onUpdate:modelValue":f[14]||(f[14]=m=>r.regimen=m),options:N.value},null,8,["modelValue","options"])]),_:1}),c(W)(C)?H("",!0):(I(!0),M(z,{key:5},Se(Object.values(C),(m,E)=>(I(),U(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{"model-value":m,form:C,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.totalCPTGiven,"onUpdate:modelValue":f[15]||(f[15]=m=>r.totalCPTGiven=m),form:r,min:1},null,8,["modelValue","form"])]),_:1}),t(c(T),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(le,{modelValue:r.tbMed,"onUpdate:modelValue":f[16]||(f[16]=m=>r.tbMed=m),options:c(At)},null,8,["modelValue","options"])]),_:1}),S.value||G.value?(I(),U(c(T),{key:6,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.totalIPTGiven,"onUpdate:modelValue":f[17]||(f[17]=m=>r.totalIPTGiven=m),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),G.value?(I(),U(c(T),{key:7,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.totalRFPGiven,"onUpdate:modelValue":f[18]||(f[18]=m=>r.totalRFPGiven=m),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),he.value?(I(),U(c(T),{key:8,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.total3HPGiven,"onUpdate:modelValue":f[19]||(f[19]=m=>r.total3HPGiven=m),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),he.value||G.value||S.value?(I(),U(c(T),{key:9,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.totalPyridoxineGiven,"onUpdate:modelValue":f[20]||(f[20]=m=>r.totalPyridoxineGiven=m),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),D.value.length>0?(I(),U(c(T),{key:10,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ee,{modelValue:r.pillCount,"onUpdate:modelValue":f[21]||(f[21]=m=>r.pillCount=m),form:r,min:1},null,8,["modelValue","form"])]),_:1})):H("",!0),t(c(T),{size:D.value.length>0?"6":"12",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:r.nextAppointmentDate,"onUpdate:modelValue":f[22]||(f[22]=m=>r.nextAppointmentDate=m),form:r,minDate:r.visitDate.value,maxDate:P.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1},8,["size"])]),_:1})]),_:1})]),_:1}),t(c(Je),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(te),{color:"primary",onClick:f[23]||(f[23]=m=>c(F).hide()),slot:"end"},{default:n(()=>[k(" Close ")]),_:1}),t(c(te),{color:"warning",onClick:Et,slot:"end"},{default:n(()=>[k(" Reset ")]),_:1}),t(c(te),{color:"success",onClick:Ot,slot:"end"},{default:n(()=>[k(" Save ")]),_:1})]),_:1})]),_:1})],64))}});const Fa=ne(Ba,[["__scopeId","data-v-d227ee11"]]),Ha=x({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:nt,IonCard:Ht,IonCardHeader:Mt,IonCardTitle:qt,IonCardContent:Lt,IonButton:te},setup(e){const a=O([]),l=B(()=>e.patient.getID()),s=ie({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),d=O([{label:"Add Visit",action:async()=>{await F.show(Fa,{patient:e.patient})}},{label:"Update Outcome",action:async()=>F.show(Sa,{patient:e.patient})},{label:"Enter VL Results",action:async()=>F.show(va,{patient:e.patient})}]),g=R=>{const D=e.startDate!=="N/A"?"("+Z(R).diff(e.startDate,"months")+"M)":"";return"".concat(be(R)," ").concat(D)},i={minWidth:"68px !important"},u=O([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:i},{path:"weight",label:"Weight (Kg)",sortable:!1,thStyles:i},{path:"height",label:"Height (cm)",sortable:!1,thStyles:i},{path:"bmi",label:"BMI",sortable:!1,thStyles:i},...e.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:i},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:i}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:R=>R.length>0?"Yes":"No",sortable:!1,thStyles:i},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:i},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:i},{path:"vlResult",label:"Viral Load",sortable:!1}]),p=R=>({title:"Side effects noted on ".concat(R.row.visitDate),rows:R.row.sideEffects.map(D=>({sideEffect:D})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),y=R=>({title:"Drugs dispensed on ".concat(R.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:R.row.drugs.map(D=>({name:D[0],quantity:D[1],units:"tab (s)"}))}),_=async R=>{const D=/regimen/i.test(R.column.path)?y(R):p(R);W(D.rows)||await F.show(la,D)},h=[{label:"void",icon:Gt,color:"danger",action(R,D){Vt(async v=>{var P;const V=await pt.getEncounters(l.value,{date:R.date});V.ok?((P=V.data)==null||P.forEach(async $=>{await pt.voidEncounter($.encounter_id,v)}),a.value.splice(D,1)):at(V.errorMessage||"Failed to void encounters")},"small-modal")}}],N=async R=>R.tb_status.match(/Unknown/i)||R.outcome==="Defaulted"?"":He.getCachedConceptName(R.tb_status),w=()=>{Ge.getPatientVisits(l.value,!0).then(async R=>{a.value=[];for(const D of R){const v=(await yt.getCurrentProgramInformation(l.value,D)).data;let V="",P="",$="",A="";if(v.outcome!=="Defaulted"){const C=await Ue.getFirstValueDatetime(l.value,"appointment date",D);if(C&&(V=be(C)),P=await Ue.getFirstValueCoded(l.value,"Is patient pregnant",D),$=await Ue.getFirstValueCoded(l.value,"Is patient breast feeding",D),v.viral_load==="N/A"){const r=await Ue.getFirstObs(l.value,"HIV viral load",D);r&&r.value_text&&r.value_numeric&&(A=r.value_numeric===1?"LDL":r.value_text+r.value_numeric.toString())}else A=v.viral_load}v&&a.value.push({visitDate:g(D),visitBy:v.visit_by.match(/Unk/i)?"":v.visit_by,weight:v.outcome==="Defaulted"?"":v.weight,height:v.outcome==="Defaulted"?"":v.height,bmi:v.outcome==="Defaulted"?"":v.bmi,pregnant:P,breastfeeding:$,tbStatus:await N(v),sideEffects:v.outcome==="Defaulted"?"":v.side_effects,regimen:v.outcome==="Defaulted"?"":v.regimen,nextAppointment:V,outcome:v.outcome.match(/Unk/i)?"":v.outcome,vlResult:A,drugs:v.pills_dispensed,date:D})}})};return q.on(L.RELOAD_PATIENT_VISIT_DATA,()=>w()),_e(()=>{w()}),{actionButtons:d,tableConfig:s,rowButtons:h,columns:u,rows:a,onDrilldownHandler:_}}});const Ma=e=>(zt("data-v-b764fd01"),e=e(),Wt(),e),qa=Ma(()=>fe("span",{class:"title"},"Summary of Visits",-1)),La={class:"ion-float-right ion-margin-end ion-margin-bottom"};function Ga(e,a,l,s,d,g){const i=b("ion-icon"),u=b("ion-button"),p=b("ion-card-title"),y=b("ion-card-header"),_=b("data-table"),h=b("ion-card-content"),N=b("ion-card");return I(),U(N,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[t(y,null,{default:n(()=>[t(p,null,{default:n(()=>[qa,fe("span",La,[(I(!0),M(z,null,Se(e.actionButtons,w=>(I(),U(u,{key:w.label,onClick:w.action,color:w.color||"primary"},{default:n(()=>[w.icon?(I(),U(i,{key:0,icon:w.icon,class:"ion-margin-right"},null,8,["icon"])):H("",!0),k(" "+oe(w.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),t(h,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[t(_,{rows:e.rows,columns:e.columns,"row-actions-buttons":e.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:e.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const za=ne(Ha,[["render",Ga],["__scopeId","data-v-b764fd01"]]),Wa=x({__name:"ViralLoadTrail",props:{patient:{}},setup(e){const a=e,l=B(()=>"Viral Load Results Trail for ".concat(a.patient.getFullName())),s=O([]),d=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:be},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:be}],g={label:"X",color:"danger",action({encounter_id:i}){Vt(async u=>{try{await Yt.void(i,u),F.hide(),q.emit(L.RELOAD_LATEST_VL_RESULT),q.emit(L.RELOAD_PATIENT_VISIT_DATA)}catch(p){console.error(p)}},"small-modal custom-modal-backdrop")}};return _e(async()=>{s.value=await we.getViralLoadResultTrail(a.patient.getID())}),(i,u)=>(I(),M(z,null,[t(c(Ye),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(We),null,{default:n(()=>[k(oe(l.value),1)]),_:1})]),_:1})]),_:1}),t(c(je),null,{default:n(()=>[t(c(re),{style:{width:"100%"}},{default:n(()=>[t(c(ae),{style:_t([{padding:"0 !important"},{minHeight:s.value.length?"0":"30vh"}])},{default:n(()=>[t(c(T),{size:"12",class:"ion-no-padding"},{default:n(()=>[t(c(nt),{rows:s.value,columns:d,"row-actions-buttons":[g],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),t(c(Je),null,{default:n(()=>[t(c(De),null,{default:n(()=>[t(c(te),{color:"primary",onClick:u[0]||(u[0]=p=>c(F).hide()),slot:"end"},{default:n(()=>[k(" Close ")]),_:1})]),_:1})]),_:1})],64))}}),Ya=x({components:{MultiColumnView:tt,IonList:jt,IonItem:Le},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(e,{emit:a}){const l=O(0),s=O(0),d=O(0),g=O(""),i=O(""),u=O(""),p=O(""),y=O(""),_=O(""),h=O(""),N=O(""),w=O(""),R=O(""),D=O(""),v=S=>S.other&&typeof S.other.onClickHandler=="function",V=B(()=>!W(e.guardians)),P=async S=>{var Re;v(S)&&await((Re=S.other)==null?void 0:Re.onClickHandler())},$=()=>{const S=e.patient.getBirthdate(),Re=e.artStartDate!=="N/A"?Z(e.artStartDate).diff(S,"years"):"";return"".concat(be(S)," (").concat(Re,")")},A=()=>{we.getlatestViralLoadResult(e.patient.getID()).then(S=>R.value=S)},C=()=>({onClickHandler(){Jt.push("/patient/reception/".concat(e.patient.getID(),"/false"))}}),r=()=>V.value?e.guardians.map(S=>"".concat(S.name," (").concat(S.relationshipType,")")).join(","):"Add",j=()=>({onClickHandler:()=>a("updatePatient")}),se=B(()=>[{label:"ARV Number",value:e.patient.getArvNumber(),other:{onClickHandler:()=>a("updateARVNumber")}},{label:"MW National ID",value:e.patient.getMWNationalID(),other:j()},{label:"Name",value:e.patient.getGivenName()+" "+e.patient.getFamilyName(),other:j()},{label:"DOB and Age at Initiation",value:$(),other:j()},{label:"Sex",value:ca(e.patient.getGender()),other:j()},{label:"Location",value:e.patient.getCurrentVillage(),other:j()},{label:"Landmark",value:e.patient.getClosestLandmark(),other:j()},{label:"Phone Number",value:e.patient.getPhoneNumber(),other:j()},{label:"Guardian",value:r(),other:{onClickHandler:()=>a("updateGuardian")}},{label:"Agrees to follow up",value:y.value,other:C()},{label:"Date of starting first line ARV Regimen",value:e.artStartDate,other:C()},{label:"Initial Weight (KG)",value:l.value,other:C()},{label:"Initial Height (CM)",value:s.value,other:C()},{label:"Initial BMI",value:d.value,other:C()},{label:"Initial TB Status",value:g.value,other:C()},{label:"Pregnant at Initiation",value:u.value,other:C()},{label:"Breastfeeding at Initiation",value:i.value,other:C()},{label:"Latest VL Result and Result Date",value:R.value,other:{onClickHandler:()=>F.show(Wa,{patient:e.patient})}},{label:"TI",value:p.value,other:C()},{label:"HIV test place",value:N.value,other:C()},{label:"HIV test date",value:h.value,other:C()},{label:"WHO stage",value:D.value,other:C()},{label:"Reason for starting ART",value:_.value,other:C()},{label:"Staging codition",value:w.value,other:C()}]),he=async()=>{const S=await e.patient.getHIVTestDate();S&&(h.value=be(S))},G=()=>{e.patient.getInitialWeight().then(S=>l.value=S),e.patient.getInitialHeight().then(S=>s.value=S),e.patient.getInitialBMI().then(S=>d.value=S),e.patient.getInitialTBStatus().then(S=>g.value=S),e.patient.hasPregnancyAtARTInitiation().then(S=>u.value=S),e.patient.breastFeedingAtARTInitiation().then(S=>i.value=S),e.patient.everReceivedART().then(S=>p.value=S),e.patient.agreesToFollowUp().then(S=>y.value=S),e.patient.getReasonForStartingART().then(S=>_.value=S),e.patient.getHIVTestLocation().then(S=>N.value=S),e.patient.getStagingCondition().then(S=>w.value=S),e.patient.getWhoStage().then(S=>D.value=S),he()};return _e(()=>{G(),A(),q.on(L.RELOAD_LATEST_VL_RESULT,()=>A()),q.on(L.RELOAD_STAGING_INFORMATION,()=>G())}),{patientInfo:se,onClickHandler:P,clickable:v}}});const ja={style:{width:"100%",display:"flex",justifyContent:"space-between"}},Ja={key:0},Qa={key:1},Ka={key:2},Xa={key:3};function Za(e,a,l,s,d,g){const i=b("ion-item"),u=b("ion-list"),p=b("multi-column-view");return I(),U(p,{items:e.patientInfo,numberOfColumns:3},{default:n(({entries:y})=>[t(u,{class:"his-card ion-margin-end"},{default:n(()=>[(I(!0),M(z,null,Se(y,(_,h)=>(I(),U(i,{key:h,lines:h===y.length-1?"none":void 0,button:e.clickable(_),onClick:N=>e.onClickHandler(_)},{default:n(()=>[fe("div",ja,[_.label?(I(),M("span",Ja,oe(_.label)+": ",1)):(I(),M("span",Qa)),e.clickable(_)?(I(),M("span",Ka,[fe("a",null,[fe("b",null,oe(_.value||"N/A"),1)])])):(I(),M("span",Xa,[fe("b",null,oe(_.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const xa=ne(Ya,[["render",Za],["__scopeId","data-v-5306de30"]]),en=x({components:{IonGrid:re,IonRow:ae,IonCol:T,TextInput:Pe,DateInput:ge,SelectInput:le},props:{patientService:{type:Object,required:!0}},setup(e){const a=O(!1),l=B(()=>/Unknown/i.test(e.patientService.getMWNationalID())?"":e.patientService.getMWNationalID()),s=ie({givenName:{label:"First Name",value:e.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:i=>Ee(i)},familyName:{label:"last Name",value:e.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:i=>Ee(i)},middleName:{label:"middle Name",value:e.patientService.getMiddleName(),placeholder:"middle Name",validation:i=>!!i&&Ee(i)},nationalId:{label:"Malawi National ID Number",value:l.value,placeholder:"Enter Malawi National ID Number",validation:i=>i&&i.label?ua(i):null},gender:{value:e.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:e.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:e.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async i=>!(i.value==="Unknown"||i.value==="N/A")&&wt(i)},homeVillage:{value:e.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:e.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),d=async i=>{var y,_,h,N,w;let u,p;try{(y=i==null?void 0:i.other)!=null&&y.traditional_authority_id&&(u=await mt.getTraditionalAuthorityById(i.other.traditional_authority_id)),u&&(p=await mt.getDistrictByID(u.district_id))}catch(R){at("Unable to resolve patient address. Saving using default address"),console.error(R)}return{home_district:(_=p==null?void 0:p.name)!=null?_:"N/A",home_traditional_authority:(h=u==null?void 0:u.name)!=null?h:"N/A",home_village:(i==null?void 0:i.label)||"N/A",current_district:(N=p==null?void 0:p.name)!=null?N:"N/A",current_traditional_authority:(w=u==null?void 0:u.name)!=null?w:"N/A",current_village:(i==null?void 0:i.label)||"N/A"}};return{today:K,patient:s,getLandmarks:ra,genderOptions:aa,isBirthdateEstimated:a,modal:F,onFinish:async()=>Ne(s,async i=>{const u={};if(i.givenName!==e.patientService.getGivenName()&&(u.given_name=i.givenName),i.familyName!==e.patientService.getFamilyName()&&(u.family_name=i.familyName),i.middleName!==e.patientService.getMiddleName()&&(u.middle_name=i.middleName),i.birthdate!==e.patientService.getBirthdate()&&(u.birthdate=i.birthdate),i.gender.value!==e.patientService.getGender()&&(u.gender=i.gender.value),i.cellPhoneNumber!==e.patientService.getPhoneNumber()&&(u.cell_phone_number=i.cellPhoneNumber),i.landmark.label!==e.patientService.getClosestLandmark()&&(u.landmark=i.landmark.label),i.homeVillage!==e.patientService.getCurrentVillage()&&Object.assign(u,{...u,...await d(i.homeVillage)}),!W(u)){const p=new et;p.setPersonID(e.patientService.getID()),await p.updatePerson(u)}i.nationalId!==l.value&&await e.patientService.updateMWNationalId(i.nationalId),await F.hide(),q.emit(L.RELOAD_PATIENT_DATA)}),getVillagesByName:sa}}});function tn(e,a,l,s,d,g){const i=b("ion-title"),u=b("ion-icon"),p=b("ion-button"),y=b("ion-buttons"),_=b("ion-toolbar"),h=b("ion-header"),N=b("TextInput"),w=b("ion-col"),R=b("SelectInput"),D=b("DateInput"),v=b("ion-row"),V=b("ion-grid"),P=b("ion-content"),$=b("ion-footer");return I(),M(z,null,[t(h,null,{default:n(()=>[t(_,null,{default:n(()=>[t(i,null,{default:n(()=>[k("Edit Patient Demographics")]),_:1}),t(y,{slot:"end"},{default:n(()=>[t(p,{onClick:a[0]||(a[0]=A=>e.modal.hide())},{default:n(()=>[t(u,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(P,{class:"ion-padding"},{default:n(()=>[t(V,null,{default:n(()=>[t(v,null,{default:n(()=>[t(w,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.givenName,"onUpdate:modelValue":a[1]||(a[1]=A=>e.patient.givenName=A)},null,8,["modelValue"])]),_:1}),t(w,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.middleName,"onUpdate:modelValue":a[2]||(a[2]=A=>e.patient.middleName=A)},null,8,["modelValue"])]),_:1}),t(w,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.familyName,"onUpdate:modelValue":a[3]||(a[3]=A=>e.patient.familyName=A)},null,8,["modelValue"])]),_:1}),t(w,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.nationalId,"onUpdate:modelValue":a[4]||(a[4]=A=>e.patient.nationalId=A)},null,8,["modelValue"])]),_:1}),t(w,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(R,{modelValue:e.patient.gender,"onUpdate:modelValue":a[5]||(a[5]=A=>e.patient.gender=A),options:e.genderOptions},null,8,["modelValue","options"])]),_:1}),t(w,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(D,{modelValue:e.patient.birthdate,"onUpdate:modelValue":a[6]||(a[6]=A=>e.patient.birthdate=A),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:e.today,onIsEstimated:a[7]||(a[7]=A=>e.isBirthdateEstimated=A)},null,8,["modelValue","maxDate"])]),_:1}),t(w,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(N,{modelValue:e.patient.cellPhoneNumber,"onUpdate:modelValue":a[8]||(a[8]=A=>e.patient.cellPhoneNumber=A),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(w,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(R,{modelValue:e.patient.homeVillage,"onUpdate:modelValue":a[9]||(a[9]=A=>e.patient.homeVillage=A),asyncOptions:e.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),t(w,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(R,{modelValue:e.patient.landmark,"onUpdate:modelValue":a[10]||(a[10]=A=>e.patient.landmark=A),asyncOptions:e.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),t($,null,{default:n(()=>[t(_,null,{default:n(()=>[t(p,{color:"primary",onClick:a[11]||(a[11]=A=>e.modal.hide()),slot:"end"},{default:n(()=>[k("Close")]),_:1}),t(p,{class:"ion-margin-end",color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[k("Save")]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const an=ne(en,[["render",tn]]),nn=x({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(e){var R,D;const a=new et,l=e,s=O(W(l.guardians)),d=B(()=>"".concat(s.value?"Add":"Edit"," Guardian Demographics")),g=B(()=>"".concat(s.value?"Edit":"Add"," Guardian")),i=O([]),u=(D=(R=l.guardians)==null?void 0:R.map(v=>({label:"".concat(v.name," (").concat(v.relationshipType,")"),value:v.name,other:v})))!=null?D:[],p=ie({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),y=ie({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:v=>Ee(v)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:v=>Ee(v)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async v=>v.value!=="Unknown"&&wt(v)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});ve(()=>p.guardian.value,v=>{var V,P,$,A,C,r,j,se;y.givenName.value=(P=(V=v==null?void 0:v.other)==null?void 0:V.names.given_name)!=null?P:"",y.familyName.value=(A=($=v==null?void 0:v.other)==null?void 0:$.names.family_name)!=null?A:"",y.cellPhoneNumber.value=(r=(C=v==null?void 0:v.other)==null?void 0:C.phoneNumber)!=null?r:"",y.relation.value=(se=(j=v==null?void 0:v.other)==null?void 0:j.relationshipType)!=null?se:""},{deep:!0,immediate:!0});function _(){s.value=!s.value,p.guardian.value=""}async function h(v){var V,P;await a.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:l.patientId,...v}),await Xe.createRelation(l.patientId,a.getPersonID(),(P=(V=v.relation)==null?void 0:V.value)!=null?P:13)}async function N(v,V){var A,C;const P=V.names.person_id,$={};if(V.names.given_name!==v.given_name&&($.given_name=v.given_name),V.names.family_name!==v.family_name&&($.family_name=v.family_name),V.phoneNumber!==v.cell_phone_number&&($.cell_phone_number=v.cell_phone_number),!W($)){const r=new et;r.setPersonID(P),await r.updatePerson($)}V.relationshipType!==v.relation.label&&await Xe.amendRelation(l.patientId,P,V.id,(C=(A=v.relation)==null?void 0:A.value)!=null?C:13)}const w=async()=>Ne(y,async v=>{!s.value&&!W(p.guardian.value)?await N(v,p.guardian.value.other):await h(v),await F.hide(),q.emit(L.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return _e(async()=>{const v=(await Xe.getRelations()).data;i.value=v.map(V=>({label:V.b_is_to_a,value:V.relationship_type_id,other:V}))}),(v,V)=>{const P=b("ion-title"),$=b("ion-icon"),A=b("ion-button"),C=b("ion-buttons"),r=b("ion-toolbar"),j=b("ion-header"),se=b("ion-content"),he=b("ion-footer");return I(),M(z,null,[t(j,null,{default:n(()=>[t(r,null,{default:n(()=>[t(P,null,{default:n(()=>[k(oe(d.value),1)]),_:1}),t(C,{slot:"end"},{default:n(()=>[t(A,{onClick:V[0]||(V[0]=G=>c(F).hide())},{default:n(()=>[t($,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(se,{class:"ion-padding"},{default:n(()=>[t(c(re),null,{default:n(()=>[t(c(ae),null,{default:n(()=>[s.value?H("",!0):(I(),U(c(T),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(le,{modelValue:p.guardian,"onUpdate:modelValue":V[1]||(V[1]=G=>p.guardian=G),options:c(u)},null,8,["modelValue","options"])]),_:1})),p.guardian.value||s.value?(I(),M(z,{key:1},[t(c(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Pe,{modelValue:y.givenName,"onUpdate:modelValue":V[2]||(V[2]=G=>y.givenName=G)},null,8,["modelValue"])]),_:1}),t(c(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Pe,{modelValue:y.familyName,"onUpdate:modelValue":V[3]||(V[3]=G=>y.familyName=G)},null,8,["modelValue"])]),_:1}),t(c(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Pe,{modelValue:y.cellPhoneNumber,"onUpdate:modelValue":V[4]||(V[4]=G=>y.cellPhoneNumber=G),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(c(T),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(le,{modelValue:y.relation,"onUpdate:modelValue":V[5]||(V[5]=G=>y.relation=G),options:i.value},null,8,["modelValue","options"])]),_:1})],64)):H("",!0)]),_:1})]),_:1})]),_:1}),t(he,null,{default:n(()=>[t(r,null,{default:n(()=>[c(W)(l.guardians)?H("",!0):(I(),U(A,{key:0,color:"primary",onClick:_,slot:"start"},{default:n(()=>[k(oe(g.value),1)]),_:1})),t(A,{color:"primary",onClick:V[6]||(V[6]=G=>c(F).hide()),slot:"end"},{default:n(()=>[k("Close")]),_:1}),t(A,{class:"ion-margin-end",color:"success",onClick:w,slot:"end"},{default:n(()=>[k("Save")]),_:1})]),_:1})]),_:1})],64)}}}),on=x({components:{IonGrid:re,IonRow:ae,IonCol:T,TextInput:Pe},props:{patient:{type:Object,required:!0}},setup(e){const{facility:a}=bt(),l=B(()=>e.patient.getArvNumber()),s=B(()=>!W(l.value)&&l.value!=="Unknown"),d=ie({arvNumber:{value:s.value?l.value.split("-")[2]:"",label:"".concat(s.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async u=>{const p=ue(u,"POSITIVE_INTEGERS");if(p!==null)return p;if(u.value===l.value.split("-")[2])return null;const y=await Ge.findByOtherID(4,"".concat(a.code,"-ARV-").concat(u.value));return y.ok?W(y.data)?null:["ARV Number already taken"]:[y.errorMessage||y.clientErrorType||"Unable to determine ARV number with status: ".concat(y.httpStatusResponse)]}}});return{form:d,modal:F,arvNumber:l,facility:a,hasValidARVNumber:s,onFinish:async()=>Ne(d,async u=>{u.arvNumber!==l.value.split("-")[2]&&(s.value?await e.patient.updateARVNumber("".concat(a.code,"-ARV-").concat(u.arvNumber)):await e.patient.createArvNumber("".concat(a.code,"-ARV-").concat(u.arvNumber)),q.emit(L.RELOAD_PATIENT_DATA)),await F.hide()}),voidARV:async()=>{if(await Ie("Are you sure you want to void this ARV Number ".concat(l.value,"?"))){await Ze.show("Voiding ARV Number...");try{await yt.voidARVNumber(l.value),await Ze.hide(),await F.hide(),q.emit(L.RELOAD_PATIENT_DATA)}catch(p){await Ze.hide(),console.log(p)}}}}}});function ln(e,a,l,s,d,g){const i=b("ion-title"),u=b("ion-icon"),p=b("ion-button"),y=b("ion-buttons"),_=b("ion-toolbar"),h=b("ion-header"),N=b("text-input"),w=b("ion-col"),R=b("ion-row"),D=b("ion-grid"),v=b("ion-content"),V=b("ion-footer");return I(),M(z,null,[t(h,null,{default:n(()=>[t(_,null,{default:n(()=>[t(i,null,{default:n(()=>[k("ARV NUMBER")]),_:1}),t(y,{slot:"end"},{default:n(()=>[t(p,{onClick:a[0]||(a[0]=P=>e.modal.hide())},{default:n(()=>[t(u,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(v,{class:"ion-padding"},{default:n(()=>[t(D,null,{default:n(()=>[t(R,null,{default:n(()=>[t(w,null,{default:n(()=>[t(N,{modelValue:e.form.arvNumber,"onUpdate:modelValue":a[1]||(a[1]=P=>e.form.arvNumber=P),form:e.form,prefix:"".concat(e.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),t(V,{class:"ion-padding-horizontal"},{default:n(()=>[t(_,null,{default:n(()=>[t(p,{color:"primary",onClick:a[2]||(a[2]=P=>e.modal.hide()),slot:"end"},{default:n(()=>[k("Close")]),_:1}),e.hasValidARVNumber?(I(),U(p,{key:0,color:"danger",onClick:e.voidARV,slot:"start"},{default:n(()=>[k("Void ARV Number")]),_:1},8,["onClick"])):H("",!0),t(p,{color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[k("Save")]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const rn=ne(on,[["render",ln]]),sn=x({components:{VisitsSummary:za,InformationHeader:xa},setup(){const e=Qt(),a=parseInt(e.params.patientId.toString())||0,l=O(),s=O(""),d=O([]),g=B(()=>!W(l.value)),i=async()=>{if(a){const h=(await Ge.findByID(a)).data;h&&(l.value=new Ge(h))}},u=async()=>{d.value=await pa.getGuardianDetails(a)},p=async h=>{await F.show(an,{patientService:l.value,attribute:h})},y=async()=>{await F.show(nn,{patientId:a,guardians:d.value})},_=async()=>{await F.show(rn,{patient:l.value})};return q.on(L.RELOAD_PATIENT_DATA,async()=>{await i()}),q.on(L.RELOAD_GUARDIAN_DATA,async()=>{await u()}),_e(async()=>{var N;await i();const h=await((N=l.value)==null?void 0:N.getARTStartDate());s.value=h?gt.toStandardHisDisplayFormat(h):"N/A",await u()}),{patient:l,artStartDate:s,guardians:d,isReady:g,updateDemographics:p,updateGuardian:y,updateARVNumber:_}}});function un(e,a,l,s,d,g){const i=b("information-header"),u=b("ion-col"),p=b("ion-row"),y=b("visits-summary"),_=b("ion-grid");return e.isReady?(I(),U(_,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[t(p,null,{default:n(()=>[t(u,{size:"12"},{default:n(()=>[e.patient?(I(),U(i,{key:0,patient:e.patient,guardians:e.guardians,artStartDate:e.artStartDate,onUpdateARVNumber:e.updateARVNumber,onUpdateGuardian:e.updateGuardian,onUpdatePatient:e.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):H("",!0)]),_:1})]),_:1}),t(p,null,{default:n(()=>[t(u,null,{default:n(()=>[e.patient?(I(),U(y,{key:0,patient:e.patient,startDate:e.artStartDate},null,8,["patient","startDate"])):H("",!0)]),_:1})]),_:1})]),_:1})):H("",!0)}const qn=ne(sn,[["render",un]]);export{qn as default};
