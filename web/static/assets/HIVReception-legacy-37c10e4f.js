!function(){function t(t,e,a){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var i=a.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}System.register(["./index-legacy-c5b3ee2e.js","./patient_service-legacy-0c5216cb.js","./toasts-legacy-337d818a.js","./loader-legacy-6ec05884.js","./encounter_types-legacy-4fed5cb0.js","./consultation_service-legacy-0b0da62b.js","./his_date-legacy-5e1e6c30.js","./form-legacy-e4bdf62a.js","./common-legacy-e8d6ba88.js","./emc_event-legacy-0252f26c.js"],function(e,a){"use strict";var i,n,s,o,r,c,u,l,d,g,v,_,m,p,y,w,f,h,b,I,S,C,N,A,O,T,V,R,D,j,P,E,L,x,G,F,B,W,H,k,$;return{setters:[t=>{i=t.aV,n=t.d,s=t.aW,o=t.m,r=t.n,c=t.p,u=t.I,l=t.aT,d=t.g,g=t.i,v=t.j,_=t.J,m=t.ak,p=t.aR,y=t.ar,w=t.aX,f=t._,h=t.O,b=t.k,I=t.w,S=t.o,C=t.e,N=t.W,A=t.aL,O=t.A},t=>{T=t.P,V=t.C},t=>{R=t.a,D=t.t},t=>{j=t.l},t=>{P=t.e},t=>{E=t.A,L=t.u,x=t.V,G=t.C},t=>{F=t.a},t=>{B=t.a},t=>{W=t.i,H=t.g},t=>{k=t.E,$=t.a}],execute:function(){class z extends E{constructor(t,e=F()){super(t,P.HIV_CLINIC_REGISTRATION,e)}}e("C",z);class J extends E{constructor(t,e=F()){super(t,P.REGISTRATION,e)}}e("P",J);class U extends E{constructor(e,a,i=F()){super(e,P.HIV_STAGING,i),t(this,"age",void 0),t(this,"confirmatoryTest",void 0),this.age=a,this.confirmatoryTest=null}isAdult(){return this.age>=15}cd4CountIsValid(t){try{return!!t.match(/^(=|<|>)([0-9]*)$/m)}catch(e){return!1}}getStagingConditions(t){const e=this.getStagingCategoryByNum(t);return E.getConceptsByCategory(e)}getAllWhoStages(){return E.getConceptsByCategory("whole_staging_numbers")}getAllReasonsForART(t=this.date,e=!1){return E.getConceptsByCategory("reason_for_art").filter(a=>!(new Date(t)>new Date(i)&&a.name.match(/cd4/i))&&(!e||!a.name.match(/breastfeeding|pregnant/i)))}buildWhoStageObs(t){return this.buildValueCoded("Who stage",t)}buildWhoCriteriaObs(t){return this.buildValueCoded("Who stages criteria present",t)}buildReasonForArtObs(t){return this.buildValueCoded("Reason for ART eligibility",t)}getStagingCategoryByNum(t){switch(t){case 1:return this.isAdult()?"stage_1_conditions_adults":"stage_1_conditions_pedaids";case 2:return this.isAdult()?"stage_2_conditions_adults":"stage_2_conditions_pedaids";case 3:return this.isAdult()?"stage_3_conditions_adults":"stage_3_conditions_pedaids";case 4:return this.isAdult()?"stage_4_conditions_adults":"stage_4_conditions_pedaids";default:return""}}}e("S",U);const K=n({components:{ClinicRegistration:s(()=>w(()=>a.import("./ClinicRegistration-legacy-322b542c.js"),void 0)),Staging:s(()=>w(()=>a.import("./Staging-legacy-640ce3bf.js"),void 0)),IonGrid:o,IonRow:r,IonCol:c,IonButton:u},setup(){const t=l(),e=d(),a=_(!1),i=m({}),n=_("ClinicRegistration"),s=parseInt(t.params.patientId.toString()||""),o=!!t.params.new.toString().match(/true/i),r=g(()=>"Staging"===n.value),c=g(()=>"Staging"===n.value),u=_({}),w=_(""),f=_(""),h=_([]),b=m({}),{hasProgram:I,fetchPatientPrograms:S,enrollPatient:C}=L(s),N=async t=>{for(const e of t){h.value.includes(e.encounter_id)||h.value.push(e.encounter_id);const t=await V.getConceptName(e.concept_id);let a="";e.value_datetime||e.value_drug?a=e.value_datetime:e.value_text?a=e.value_text:e.value_numeric?a=e.value_numeric:e.value_coded&&(a=await V.getConceptName(e.value_coded)),e.value_modifier&&(a=e.value_modifier+a),b[t]=a}};return v(async()=>{S();const t=await T.findByID(s);t.ok&&(u.value=new T(t.data)),o||await(async()=>{const{HIV_CLINIC_CONSULTATION:t,HIV_CLINIC_REGISTRATION:e,REGISTRATION:a,HIV_STAGING:i,VITALS:n}=P;try{const o=(await p.all({encounter_type_id:e,patient_id:s})).data;if(W(o))return;if(w.value=H(o,"[0].encounter_datetime",""),w.value){await N(o[0].observations);const e=(await p.all({program_id:y,patient_id:s,date:w.value})).data||[];for(const s of e){let e=[a,i];/yes/i.test(`${b["Ever registered at ART clinic"]}`)&&(e=[...e,t,n]),e.includes(s.encounter_type)&&await N(s.observations)}}}catch(o){D("Unable to load previous observations")}})(),a.value=!0,k.on($.ON_INITIAL_VISIT_DATE,t=>{w.value=t}),k.on($.ON_ART_START_DATE,t=>{f.value=t})}),{activeForm:n,patient:u,isNewPatient:o,isStaging:r,isRegistration:c,isReady:a,initialVisitDate:w,observations:b,artStartDate:f,onValue:t=>i[t.type]=t.data,onFinish:async()=>{const{arvNumberEditable:t,formData:a,computedData:n}=i.registration,{computedData:r}=i.staging;try{if(j.show(),!o&&!W(h.value))for(const t of h.value)await p.void(t,"Duplicate");t&&a.arvNumber&&await u.value.createArvNumber(a.arvNumber);const i=new J(s,a.initialVisitDate);await i.createEncounter();const c=await B(n,"patient type");await i.saveObservationList(c);const l=new z(s,a.initialVisitDate);await l.createEncounter();const d=await B(n,"registration");if(await l.saveObservationList(d),"Yes"===a.everRegisteredAtClinic){const t=new x(s,a.initialVisitDate);await t.createEncounter();const e=await B(n,"vitals");await t.saveObservationList(e);const i=new G(s,a.initialVisitDate);await i.createEncounter();const o=await B(n,"consultation");await i.saveObservationList(o)}const g=new U(s,u.value.getAge(),a.initialVisitDate);await g.createEncounter();const v=await B(r);await g.saveObservationList(v),!o&&I()||await C(a.initialVisitDate),await j.hide(),await R("Saved successfully"),e.push(`/patient/${s}`)}catch(c){await j.hide(),console.log(c),D(`${c}`)}},onNext:()=>n.value="Staging",onPrevious:()=>n.value="ClinicRegistration"}}});const M=f(K,[["render",function(t,e,a,i,n,s){const o=h("ion-col"),r=h("ion-row"),c=h("ion-grid");return S(),b(c,null,{default:I(()=>[C(r,{class:"his-card"},{default:I(()=>[t.isReady?(S(),b(o,{key:0,size:"12"},{default:I(()=>[(S(),b(N,null,[(S(),b(A(t.activeForm),{patient:t.patient,isNewPatient:t.isNewPatient,initialVisitDate:t.initialVisitDate,artStartDate:t.artStartDate,observations:t.observations,onOnValue:t.onValue,onOnNext:t.onNext,onOnPrevious:t.onPrevious,onOnFinish:t.onFinish},null,40,["patient","isNewPatient","initialVisitDate","artStartDate","observations","onOnValue","onOnNext","onOnPrevious","onOnFinish"]))],1024))]),_:1})):O("",!0)]),_:1})]),_:1})}]]),X=Object.freeze(Object.defineProperty({__proto__:null,default:M},Symbol.toStringTag,{value:"Module"}));e("H",X)}}})}();
