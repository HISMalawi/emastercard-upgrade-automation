var ia=Object.defineProperty;var oa=(e,a,l)=>a in e?ia(e,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[a]=l;var Ht=(e,a,l)=>(oa(e,typeof a!="symbol"?a+"":a,l),l);import{L as Re,l as kt,d as Z,r as q,ak as le,a9 as ye,j as _e,c as U,e as t,w as n,u as o,N as J,o as _,x as ve,a3 as ot,b as $,V as He,m as ce,n as ae,p as O,M as Ue,y as it,aB as Pt,H as Ge,I as K,am as L,v as Le,aq as De,i as M,_ as re,O as D,a as C,k as E,B as G,X as Wt,Q as we,t as Q,Z as la,aF as sa,aG as Yt,aH as ra,aI as Xt,aJ as ua,ao as Jt,aA as da,z as ft,a1 as Ut,aK as Gt,aL as ma,aM as ca,W as fa,aN as va,aO as At,aP as pa,a8 as ba,aQ as ga,q as ya,a7 as ha,aR as _a,aS as wa,aT as Va,aD as Lt,ar as Da,aU as Ia}from"./index-95a528fa.js";import{g as Na,D as Et,C as vt,P as at,O as ct}from"./patient_service-09f5142e.js";import{g as St,i as x}from"./common-abc2f84d.js";import{A as be,u as yt,V as Ra,C as Aa,E as zt}from"./consultation_service-e12c1036.js";import{p as Qt}from"./VoidReason-d2365638.js";import{a as ee,t as me,d as ie,e as $t,f as Sa}from"./his_date-34d66586.js";import{_ as Ie}from"./DateInput.vue_vue_type_style_index_0_lang-1b5fcc7d.js";import{S as ge}from"./SelectInput-3cfd0ea9.js";import{N as fe,R as Pe}from"./regimen_service-542f1101.js";import{e as Se}from"./encounter_types-1e88a09d.js";import{s as Ta,a as pt,u as xt,c as Pa}from"./arrays-1b521787.js";import{s as ze,i as qe,r as bt,a as Fe}from"./form-76c875c3.js";import{E as j,a as W}from"./emc_event-4721851b.js";import{a as Me,t as ke}from"./toasts-be8db332.js";import{D as gt}from"./Date-a98c3a89.js";import{D as Ft}from"./index-b6ce75d6.js";import{l as se}from"./loader-053b81cd.js";import{d as Kt,r as Ve,v as tt,e as Oa,f as he,g as jt,a as nt,b as Ca,c as Zt}from"./validations-5098ffac.js";import{T as Oe}from"./TextInput-a0428fce.js";import{g as ea,a as ka,b as Ea}from"./location_options-f1713e06.js";import{t as $a,g as Fa}from"./DTFormElements-9dbc03af.js";import{Y as Ae}from"./YesNoInput-c8fd3f55.js";import{D as Ba}from"./DrilldownTable-779772ea.js";import{t as qa,i as Ma}from"./Strs-0c962638.js";import{P as Ot,R as Tt}from"./relations_service-3541d1cf.js";import{r as Ha,d as Ua,h as Ga,a as La}from"./dde-012608fa.js";import"./patient_identifier_service-8163ea6d.js";import"./vue-datepicker-4bce48f6.js";const za=e=>{const a=e.given_name,l=e.family_name,u=e.middle_name?e.middle_name:"";return"".concat(a," ").concat(u," ").concat(l)};class xa{static getRelationships(a){return Re.getJson("/people/".concat(a,"/relationships")).then(l=>l.data)}static async getGuardianDetails(a){return await this.getRelationships(a).then(l=>l.map(u=>{const d=St(u,"relation.names[0]");return{id:u.relationship_id,name:d?za(d):"",relationshipType:St(u,"type.b_is_to_a",""),phoneNumber:Na(St(u,"relation.person_attributes",[]),12),names:d}}))}}const Be=class Be extends be{constructor(a){super(a,Se.LAB_ORDERS,ee())}async loadConcepts(){Be.conceptID=await be.getConceptID("HIV Viral Load")}createLabOrder(a,l){const u=Re.getUsername(),d=kt().facility.name,b=be.getCachedConceptID(l,!0);return Re.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:u,target_lab:d,reason_for_test_id:b,encounter_id:this.encounterID,tests:[{concept_id:Be.conceptID}],date:this.date,specimen:{concept_id:a}}]})}createLabResult(a,l,u,d="numeric"){return Re.postJson("lab/tests/".concat(a,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Be.conceptID},value:l,value_modifier:u,value_type:d}]})}static getSpecimens(a){return Re.getJson("/lab/specimen_types",{test_type:a})}static async getOrders(a,l={}){var d;return(d=(await Re.getJson("/lab/orders",{patient_id:a,...l})).data)!=null?d:[]}static async getViralLoadResultTrail(a,l={}){return(await this.getOrders(a,l)).reduce((d,b)=>(b.tests.forEach(i=>i.result.forEach(r=>d.push({...b,test:i.name,result:"".concat(r.value_modifier," ").concat(r.value),result_date:r.date}))),d),[])}static async getlatestViralLoadResult(a,l={}){const d=(await this.getOrders(a,l)).flatMap(i=>i.tests.flatMap(r=>r.result)).filter(Boolean);if(x(d))return"N/A";const b=Ta(d,"date","desc")[0];return"".concat(b.value_modifier).concat(b.value," (").concat(me(b.date),")")}};Ht(Be,"conceptID",-1);let Ce=Be;const ja=Z({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=q(!1),u=pt(["=",">","<",">=","<="]),d=pt(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),b=q([]),i=a.patient.getBirthdate(),r=le({orderDate:{value:"",label:"Order Date",required:!0,validation:async p=>ie(p.value).isValid()?new Date(p.value)>new Date(ee())?["Order date cannot be in the future"]:new Date(p.value)<new Date(i)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(p,v)=>ie(p.value).isValid()?new Date(p.value)>new Date(ee())?["Result date cannot be in the future"]:new Date(p.value)<new Date(v.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function m(){ze(r,async p=>{const v=new Ce(a.patient.getID());if(await v.loadConcepts(),v.setDate(p.orderDate),!await v.createEncounter())throw new Error("Unable to create lab order encounter");const R=await v.createLabOrder(p.specimen.value,p.reason.value);if(!R.ok||!R.data)throw new Error("Unable to save lab orders");const k=new Ce(a.patient.getID());if(k.setDate(p.resultDate),!await k.createEncounter())throw new Error("Unable to create lab result encounter");const g=l.value?"LDL":parseInt(p.result),I=l.value?"=":p.modifier.value,S=l.value?"text":"numeric",F=R.data[0].tests[0].id;await k.createLabResult(F,g,I,S),await L.hide(),j.emit(W.RELOAD_LATEST_VL_RESULT),j.emit(W.RELOAD_PATIENT_VISIT_DATA)})}async function f(){if(await De("Are you sure you want to clear all fields?")){l.value=!1;for(const p in r)r[p].value="",r[p].error="";j.emit(W.ON_CLEAR)}}return ye(l,p=>{p&&(r.modifier.value="",r.result.value=void 0,r.modifier.error="",r.result.error=""),r.modifier.disabled=p,r.modifier.required=!p,r.result.disabled=p,r.result.required=!p}),_e(async()=>{b.value=(await Ce.getSpecimens("HIV viral load")).data.map(p=>({label:p.name,value:p.concept_id}))}),(p,v)=>(_(),U(J,null,[t(o(He),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(ot),null,{default:n(()=>[...v[8]||(v[8]=[$("Viral Load Results",-1)])]),_:1})]),_:1})]),_:1}),t(o(Ge),{class:"ion-padding"},{default:n(()=>[t(o(ce),{style:{width:"100%"}},{default:n(()=>[t(o(ae),null,{default:n(()=>[t(o(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Ie,{modelValue:r.orderDate,"onUpdate:modelValue":v[0]||(v[0]=T=>r.orderDate=T),form:r,minDate:o(i),maxDate:o(ee)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:r.reason,"onUpdate:modelValue":v[1]||(v[1]=T=>r.reason=T),options:o(d)},null,8,["modelValue","options"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:r.specimen,"onUpdate:modelValue":v[2]||(v[2]=T=>r.specimen=T),options:b.value},null,8,["modelValue","options"])]),_:1}),t(o(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Ie,{modelValue:r.resultDate,"onUpdate:modelValue":v[3]||(v[3]=T=>r.resultDate=T),form:r,minDate:r.orderDate.value,"max-date":o(ee)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:r.modifier,"onUpdate:modelValue":v[4]||(v[4]=T=>r.modifier=T),options:o(u)},null,8,["modelValue","options"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(fe,{modelValue:r.result,"onUpdate:modelValue":v[5]||(v[5]=T=>r.result=T),form:r,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),t(o(ae),{class:"ion-margin-top"},{default:n(()=>[t(o(O),{size:"12"},{default:n(()=>[t(o(Ue),{class:"ion-padding-vertical bold"},{default:n(()=>[...v[9]||(v[9]=[$(" Other Results Options: ",-1)])]),_:1}),t(o(it),null,{default:n(()=>[t(o(Ue),null,{default:n(()=>[...v[10]||(v[10]=[$("LDL",-1)])]),_:1}),t(o(Pt),{slot:"start",modelValue:l.value,"onUpdate:modelValue":v[6]||(v[6]=T=>l.value=T)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(o(Le),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(K),{color:"primary",onClick:v[7]||(v[7]=T=>o(L).hide()),slot:"end"},{default:n(()=>[...v[11]||(v[11]=[$(" Close ",-1)])]),_:1}),t(o(K),{color:"warning",onClick:f,slot:"end"},{default:n(()=>[...v[12]||(v[12]=[$(" Reset ",-1)])]),_:1}),t(o(K),{color:"success",onClick:m,slot:"end"},{default:n(()=>[...v[13]||(v[13]=[$(" Save ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),Wa=Z({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:Ft},emits:["voidOutcome"],setup(e,{emit:a}){const l=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:i=>ie(i).format(gt)},{path:"end_date",label:"End Date",formatter:i=>ie(i).format(gt)}],u={showSearchField:!1,showSubmitButton:!1};return{rows:M(()=>e.patientStates.map((i,r)=>({...i,index:r}))),columns:l,tableConfig:u,TableRowActions:[{label:"void",color:"danger",action:async i=>{await De("Are you sure you want to void this outcome?")&&a("voidOutcome",{stateId:i.patient_state_id,index:i.index})}}]}}});function Ya(e,a,l,u,d,b){const i=D("data-table");return _(),U(J,null,[a[0]||(a[0]=C("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1)),t(i,{rows:e.rows,columns:e.columns,config:e.tableConfig,"row-actions-buttons":e.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const Xa=re(Wa,[["render",Ya]]),Ja=Z({name:"EnrollmentForm",components:{DateInput:Ie,IonGrid:ce,IonRow:ae,IonCol:O,IonButton:K},props:["birthdate","patientId"],setup(e){const a=le({programId:{label:"Select program",required:!0,value:""},date:{value:"",label:"Date of Enrollment",required:!0,validation:async i=>Kt(i,e.birthdate)}}),{enrollPatient:l,fetchPatientPrograms:u}=yt(e.patientId),d=async()=>{await De("Are you sure you want to clear all fields")&&(a.date.value="",a.date.error="",j.emit(W.ON_CLEAR))};async function b(){await qe(a)&&se.show(),await l(a.date.value),await Me("Program enrolled successfully"),await L.hide(),u().catch(console.error)}return{form:a,today:ee,onReset:d,enrollProgram:b}}});function Qa(e,a,l,u,d,b){const i=D("DateInput"),r=D("ion-col"),m=D("ion-button"),f=D("ion-row"),p=D("ion-grid");return _(),E(p,null,{default:n(()=>[t(f,null,{default:n(()=>[t(r,{size:"12"},{default:n(()=>[t(i,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=v=>e.form.date=v),form:e.form,minDate:e.birthdate,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(r,null,{default:n(()=>[t(m,{color:"warning",onClick:e.onReset},{default:n(()=>[...a[1]||(a[1]=[$("Reset",-1)])]),_:1},8,["onClick"]),t(m,{color:"success",onClick:e.enrollProgram},{default:n(()=>[...a[2]||(a[2]=[$("Enroll",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Ka=re(Ja,[["render",Qa]]),Za=Z({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:Ie,IonGrid:ce,IonRow:ae,IonCol:O,IonButton:K,SelectInput:ge,TextInput:Oe},emits:["saveOutcome"],setup(e,{emit:a}){const l=ie().format("YYYY-MM-DD"),u=le({date:{value:"",label:"Outcome Date",required:!0,validation:async m=>new Date(m.value)<new Date(e.birthdate)?["Outcome date cannot be before date of birth - ".concat(ie(e.birthdate).format(gt))]:new Date(m.value)<new Date(e.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(ie(e.dateEnrolled).format(gt))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(m,f)=>f.status.value.label==="Patient transferred out"&&Ve(m)},reason:{value:"",label:"Reason for transfer out",validation:async(m,f)=>f.status.value.label==="Patient transferred out"&&Ve(m)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(m,f)=>{var p,v,T,R;return((v=(p=f.status)==null?void 0:p.value)==null?void 0:v.label)==="Patient transferred out"&&((R=(T=f.reason)==null?void 0:T.value)==null?void 0:R.label)==="Other"&&Ve(m)}}}),d=M(()=>{var m;return((m=u.status.value)==null?void 0:m.label)==="Patient transferred out"}),b=M(()=>{var m,f;return((f=(m=u.reason)==null?void 0:m.value)==null?void 0:f.label)==="Other"});return{form:u,today:l,isTransferredOut:d,specifyOther:b,onSave:()=>ze(u,m=>a("saveOutcome",{...m,isTransferredOut:d.value})),onReset:async()=>{if(await De("are you sure you want to clear all fields")){for(const m in u)u[m].value="",u[m].error="";j.emit(W.ON_CLEAR)}},getFacilities:ea,transferOutReasons:$a}}});function en(e,a,l,u,d,b){const i=D("ion-col"),r=D("DateInput"),m=D("SelectInput"),f=D("text-input"),p=D("ion-button"),v=D("ion-row"),T=D("ion-grid");return _(),E(T,null,{default:n(()=>[t(v,null,{default:n(()=>[t(i,{size:"12"},{default:n(()=>[...a[5]||(a[5]=[C("p",null,"Add New Outcome",-1)])]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(r,{modelValue:e.form.date,"onUpdate:modelValue":a[0]||(a[0]=R=>e.form.date=R),form:e.form,minDate:e.dateEnrolled,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(m,{modelValue:e.form.status,"onUpdate:modelValue":a[1]||(a[1]=R=>e.form.status=R),form:e.form,options:e.outcomes},null,8,["modelValue","form","options"])]),_:1}),e.isTransferredOut?(_(),U(J,{key:0},[t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(m,{modelValue:e.form.nextFacility,"onUpdate:modelValue":a[2]||(a[2]=R=>e.form.nextFacility=R),form:e.form,asyncOptions:e.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),t(i,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[t(m,{modelValue:e.form.reason,"onUpdate:modelValue":a[3]||(a[3]=R=>e.form.reason=R),form:e.form,options:e.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),e.specifyOther?(_(),E(i,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[t(f,{modelValue:e.form.otherReason,"onUpdate:modelValue":a[4]||(a[4]=R=>e.form.otherReason=R),form:e.form},null,8,["modelValue","form"])]),_:1})):G("",!0)],64)):G("",!0),t(i,{size:"12",class:"ion-margin-top"},{default:n(()=>[t(p,{color:"warning",onClick:e.onReset},{default:n(()=>[...a[6]||(a[6]=[$("Reset",-1)])]),_:1},8,["onClick"]),t(p,{color:"success",onClick:e.onSave},{default:n(()=>[...a[7]||(a[7]=[$("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const tn=re(Za,[["render",en]]),an={class:"ion-page",id:"main"},nn={class:"ion-margin-start"},on=Z({__name:"OutcomeStatus",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=q(),u=M(()=>a.patient.getID()),d=M(()=>{var h,V;return(V=(h=l.value)==null?void 0:h.other)==null?void 0:V.date_enrolled}),b=M(()=>$t(a.patient.getBirthdate())),i=M(()=>{var h;return f.value.get((h=l.value)==null?void 0:h.value)}),r=M(()=>{var h,V,B,H;return(H=(B=(V=(h=l.value)==null?void 0:h.other)==null?void 0:V.patient_states)==null?void 0:B.length)!=null?H:0}),{patientPrograms:m,programStates:f,hasArtProgram:p,updateState:v,voidProgram:T,voidState:R,fetchPatientPrograms:k}=yt(u.value);function w(h){l.value=h}async function g(h,V,B=""){const H=new be(u.value,Se.EXIT_FROM_HIV_CARE,V);if(!await H.createEncounter())throw"Unable to transfer out encounter";return B&&await H.saveValueTextObs("Reason for transfer out",B),H.saveValueTextObs("Transfer to",h.name)}async function I(h){var ue;const{date:V,status:B,nextFacility:H,reason:Y,otherReason:y,isTransferredOut:P}=h;if(P){const xe=Y.value!=="Other"?Y.value:y;await g(H.other,V,xe)}await v(B.value,V,(ue=l.value)==null?void 0:ue.value),await Me("Outcome saved successfully",1e3),await L.hide(),j.emit(W.RELOAD_PATIENT_VISIT_DATA)}async function S(){var h,V,B;await T((B=(V=(h=l.value)==null?void 0:h.other)==null?void 0:V.patient_program_id)!=null?B:-1,"duplicate / system error"),await Me("Patient voided from program successfully",1e3),await L.hide(),j.emit(W.RELOAD_PATIENT_VISIT_DATA)}async function F({stateId:h,index:V}){var B,H,Y;await R(h,"duplicate / system error",(B=l.value)==null?void 0:B.value),Me("Outcome voided successfully"),(Y=(H=l.value)==null?void 0:H.other)==null||Y.patient_states.splice(V,1),j.emit(W.RELOAD_PATIENT_VISIT_DATA)}async function c(){await L.show(Ka,{birthdate:b.value,patientId:u.value},"custom-modal custom-modal-backdrop")}return _e(k),(h,V)=>{const B=D("ion-icon"),H=D("ion-buttons");return _(),E(o(ra),{when:"xs",contentId:"main"},{default:n(()=>[t(o(la),{contentId:"main"},{default:n(()=>[t(o(He),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(ot),null,{default:n(()=>[...V[0]||(V[0]=[$("Patient Programs",-1)])]),_:1})]),_:1})]),_:1}),t(o(Ge),{class:"ion-no-padding"},{default:n(()=>[t(o(Wt),null,{default:n(()=>[(_(!0),U(J,null,we(o(m),Y=>{var y;return _(),E(o(it),{button:"",key:Y.value,color:Y.value===((y=l.value)==null?void 0:y.value)?"secondary":"light",onClick:P=>w(Y)},{default:n(()=>[t(o(Ue),null,{default:n(()=>[$(Q(Y.label),1)]),_:2},1024)]),_:2},1032,["color","onClick"])}),128))]),_:1})]),_:1}),t(o(Le),null,{default:n(()=>[t(o(ve),{class:"ion-padding-start"},{default:n(()=>[l.value?(_(),E(o(K),{key:0,color:"danger",onClick:S,slot:"start"},{default:n(()=>[...V[1]||(V[1]=[$("Void Program",-1)])]),_:1})):G("",!0),o(p)?G("",!0):(_(),E(o(K),{key:1,onClick:c,slot:"start"},{default:n(()=>[...V[2]||(V[2]=[$("Enroll HIV Program",-1)])]),_:1}))]),_:1})]),_:1})]),_:1}),C("div",an,[t(o(He),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(H,{slot:"end"},{default:n(()=>[t(o(K),{onClick:o(L).hide,color:"danger",size:"large"},{default:n(()=>[t(B,{size:"large",icon:o(sa)},null,8,["icon"])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),t(o(Ge),{class:"ion-padding"},{default:n(()=>[l.value?(_(),E(o(ce),{key:0,style:{width:"100%"}},{default:n(()=>[t(o(ae),{class:"his-card",style:Yt({minHeight:r.value?"0":"30vh"})},{default:n(()=>[t(o(O),{size:"12",class:"ion-no-padding"},{default:n(()=>{var Y,y,P;return[C("h5",nn," Enrollment Date: "+Q(d.value?o(me)(d.value):"Unknown"),1),t(Xa,{patientStates:(P=(y=(Y=l.value)==null?void 0:Y.other)==null?void 0:y.patient_states)!=null?P:[],onVoidOutcome:F},null,8,["patientStates"])]}),_:1})]),_:1},8,["style"]),i.value?(_(),E(o(ae),{key:0,class:"his-card ion-margin-top",style:{"margin-bottom":"0.4rem"}},{default:n(()=>[t(tn,{"date-enrolled":d.value,birthdate:b.value,outcomes:i.value,onSaveOutcome:I},null,8,["date-enrolled","birthdate","outcomes"])]),_:1})):G("",!0)]),_:1})):G("",!0)]),_:1}),t(o(Le),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(K),{slot:"end",color:"warning"},{default:n(()=>[...V[3]||(V[3]=[$(" Reset ",-1)])]),_:1}),t(o(K),{slot:"end",color:"primary"},{default:n(()=>[...V[4]||(V[4]=[$(" Submit ",-1)])]),_:1})]),_:1})]),_:1})])]),_:1})}}});class ln extends be{constructor(a,l=ee()){super(a,Se.TREATMENT,l)}calculateDosage(a,l){let u=0;return l===0&&(u=a),a==0&&(u=l),a>0&&l>0&&(u=(a+l)/2),u}calculateEquivalentDosage(a,l){return a+l}calculateDrugRunOutDate(a,l){return $t(ie(l).add(a,"days"))}getInstructions(a,l,u,d){return"".concat(a," :- Morning: ").concat(l," ").concat(d,", Evening: ").concat(u," ").concat(d)}toDrugOrder(a,l,u,d){return{drug_inventory_id:a.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(a.am,a.pm),start_date:d,auto_expire_date:this.calculateDrugRunOutDate(u,d),units:a.units,instructions:this.getInstructions(a.drug_name,a.am,a.pm,a.units),dose:this.calculateDosage(a.am,a.pm),frequency:a.frequency,qty:l}}async createDrugOrder(a){return Et.create({encounter_id:this.encounterID,drug_orders:a})}}class sn extends be{constructor(a,l=ee()){super(a,Se.HIV_RECEPTION,l)}}class ta extends be{constructor(a,l=ee()){super(a,Se.ART_ADHERENCE,l)}buildPillCountObs(a,l){return this.buildValueNumber("Number of tablets brought to clinic",l,null,a)}async buildAdherenceObs(a,l,u){return{concept_id:await be.getConceptID("Drug adherence",!0),value_numeric:u,value_drug:l,value_modifier:"%",order_id:a,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(a,l,u){return Math.round(100*(a-l)/(a-u))}calculateExpected(a,l,u,d){const b=d==="QW"?"week":"day",i=this.calcTimeElapsed(u,b);return a-i*parseFloat(l.toString())}calcTimeElapsed(a,l){return ie(this.date).diff(a,l)+1}}class rn extends be{constructor(a,l=ee()){super(a,Se.APPOINTMENT,l)}}class un extends be{constructor(a,l=ee()){super(a,Se.DISPENSING,l)}buildDispensations(a,l,u){const d=[];for(let b=0;b<u;b++)d.push({drug_order_id:a,date:this.date,quantity:l/u});return d}saveDispensations(a){return Re.postJson("/dispensations",{dispensations:a,program_id:this.programID})}}class dn{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(a,l,u){let d={result:"",color:"",index:u};if(u<=0)return d.index=0,d;if(l<5&&l>0)d.result="Use MUAC to calculate nutrition status",d.color="red";else{l>18&&(l=19);const b=await this.getBMIData(),i=b[a][l];i&&(d=this.buildBounds(Object.keys(i),i,u,b.colors))}return d}static buildBounds(a,l,u,d){const b={result:"",color:"",index:u};return a.forEach(i=>{if(i.indexOf("-")>=0){const r=i.split("-");u>=parseFloat(r[0])&&u<=parseFloat(r[1])&&(b.result=l[i],b.color=d[l[i]])}else if(i.indexOf("<")>=0){const r=i.replace("<","");u<parseFloat(r)&&(b.result=l[i],b.color=d[l[i]])}else if(i.indexOf(">=")>=0){const r=i.replace(">=","");u>=parseFloat(r)&&(b.result=l[i],b.color=d[l[i]])}}),b}static getBMI(a,l,u,d){const b=this.calculateBMI(a,l);return this.getBMIResult(u,d,b)}static calculateBMI(a,l){if(l==0||a==0)return 0;let u=a/l/l*1e4;return u=Math.round(u*10)/10}}function mn(e){const a=M(()=>e.getID()),l=new Ra(a.value),u=new Aa(a.value),d=new ln(a.value),b=new un(a.value),i=new sn(a.value),r=new ta(a.value),m=new rn(a.value),f=q(),p=q(),v=q([]),T=q([]),R=q([]),k=q([]),w=M(()=>e.isFemale()),g=q(""),I=e.getBirthdate(),S=q(!1),F=le({}),c=M(()=>k.value.reduce((s,N)=>{var z;const A=(z=N.drug.name)!=null?z:N.regimen;return s[A]={label:"".concat(A," brought"),placeholder:"Enter number of ".concat(A," pills brought"),required:!0,computedValue:async ne=>{const pe=r.calculateExpected(N.quantity,N.equivalent_daily_dose,N.order.start_date,N.frequency),Te=r.calculateAdherence(N.quantity,ne,pe);return[await r.buildAdherenceObs(N.order_id,N.drug_inventory_id,Te),await r.buildPillCountObs(N.order_id,ne)]}},s},{})),h=M(()=>!(f.value&&e.getAge()>18)),V=le({visitDate:{value:ie().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async s=>new Date(s.value)>new Date(ee())?["Visit date cannot be after today's date"]:Kt(s,I)},patientPresent:{label:"Is the patient present?",required:!0,computedValue:s=>({tag:"reception",obs:i.buildValueCoded("Patient present",s)})},guardianPresent:{label:"Is the guardian present?",required:!0,computedValue:s=>({tag:"reception",obs:i.buildValueCoded("Guardian present",s)})},isPregnant:{label:"Is the patient pregnant?",required:w.value,computedValue:s=>({tag:"consultation",obs:u.buildValueCoded("Is patient pregnant",s)}),validation:async(s,N)=>!s.value&&N.patientPresent.value==="No"?null:w.value&&Ve(s)},isBreastfeeding:{label:"Is the patient breastfeeding?",required:w.value,computedValue:s=>({tag:"consultation",obs:u.buildValueCoded("Is patient breast feeding",s)}),validation:async(s,N)=>!s.value&&N.patientPresent.value==="No"?null:w.value&&Ve(s)},weight:{label:"Weight",required:!0,computedValue:s=>({tag:"vitals",obs:l.buildValueNumber("Weight",s)}),validation:(s,N)=>!s.value&&N.patientPresent.value==="No"?null:tt([()=>Ve(s),()=>he(s,"DECIMALS"),()=>jt(s,2,250)])},height:{label:"Height (cm)",computedValue:s=>({tag:"vitals",obs:l.buildValueNumber("Height",s)}),validation:s=>!h.value||(x(s)||!s.value)&&V.patientPresent.value==="No"?null:tt([()=>Ve(s),()=>he(s),()=>jt(s,20,220)])},bp:{value:"",label:"Blood Pressure (mmHG)",placeholder:"Enter Blood Pressure e.g 120/80",validation:s=>x(s)||!s.value?null:Oa(s),computedValue:s=>{if(x(s))return null;const[N,A]=s.split("/").map(Number);return{tag:"vitals",obs:[l.buildValueNumber("Systolic",N),l.buildValueNumber("Diastolic",A)]}}}}),B=le({tbStatus:{label:"TB Status",required:!0,computedValue:s=>({tag:"consultation",obs:u.buildValueCoded("TB Status",s.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async s=>{if(!S.value){if(new Date(s.value)>new Date(ee()))return["TB treatment start date cannot be after today's date"];if(new Date(s.value)<new Date(I))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:s=>({tag:"consultation",obs:u.buildValueDate("TB treatment start date",s)})},tbTreatmentPeriod:{label:"TB treatment period (months)",computedValue:s=>({tag:"consultation",obs:u.buildValueNumber("TB treatment period",s)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:s=>({tag:"consultation",obs:u.buildGroupValueCoded("TB screening method used","chest xray",s)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:s=>({tag:"consultation",obs:u.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",s)})},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async s=>tt([()=>Ve(s),()=>s.value==="No"||T.value.some(N=>N.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async s=>tt([()=>Ve(s),()=>s.value==="No"||R.value.some(N=>N.isChecked)?null:["Please select at least one side effect"]])}}),H=le({regimen:{label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:d.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:d.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:d.buildValueCoded("Medication orders","INH")}),validation:async(s,N)=>{var A,z;return(((A=N.tbMed.value)==null?void 0:A.label)==="6H"||((z=N.tbMed.value)==null?void 0:z.label)==="3HP (RFP + INH)")&&he(s)}},totalRFPGiven:{label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:d.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(s,N)=>{var A;return((A=N.tbMed.value)==null?void 0:A.label)==="3HP (RFP + INH)"&&he(s)}},total3HPGiven:{label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:d.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(s,N)=>{var A;return((A=N.tbMed.value)==null?void 0:A.label)==="3HP (INH 300 / RFP 300)"&&he(s)}},totalPyridoxineGiven:{label:"Total Pyridoxine Given",validation:async(s,N)=>{var A;return((A=N.tbMed.value)==null?void 0:A.label)&&he(s)}},tbMed:{label:"TPT Medication",placeholder:"Select a TPT medication"}}),Y=le({nextAppointmentDate:{label:"Next Appointment Date",required:!0,computedValue:s=>({tag:"appointment",obs:m.buildValueDate("Appointment date",s)}),validation:async(s,N)=>new Date(s.value)<new Date(V.visitDate.value)?["Appointment date cannot be before visit date"]:g.value&&new Date(s.value)>new Date(g.value)?["Appointment date cannot be after drug run out date"]:null}}),y=le({...V,...B,...H,...Y}),P=pt(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),ue=pt(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),xe=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],_t=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],lt=M(()=>{var s;return((s=y.tbMed.value)==null?void 0:s.label)==="3HP (INH 300 / RFP 300)"}),je=M(()=>{var s;return((s=y.tbMed.value)==null?void 0:s.label)==="3HP (RFP + INH)"}),st=M(()=>{var s;return((s=y.tbMed.value)==null?void 0:s.label)==="6H"}),wt=M(()=>y.hasContraindications.value==="Yes"),rt=M(()=>y.hasSideEffects.value==="Yes"),ut=M(()=>{var s;return/Confirmed TB on treatment/i.test((s=y.tbStatus.value)==null?void 0:s.label)}),Vt=M(()=>{var s;return/Suspected/i.test((s=y.tbStatus.value)==null?void 0:s.label)});async function We(s){for(const N of s){const A=y[N];if(!A)continue;const{required:z,value:ne,validation:pe}=A;if(z&&x(ne)){A.error="This field is required";continue}if(typeof pe=="function"){const Ne=await pe(typeof ne=="object"?ne:{label:ne,value:ne},y);A.error=x(Ne)?"":Ne.join()}else A.error=""}return s.every(N=>{var A;return!((A=y[N])!=null&&A.error)})}async function Dt(){const s=["visitDate","patientPresent","guardianPresent","weight"];return w.value&&s.push("isPregnant","isBreastfeeding"),h.value&&s.push("height"),We(s)}async function It(){const s=["tbStatus"];return ut.value&&!S.value&&s.push("tbTreatmentStartDate","tbTreatmentPeriod"),We(s)}async function Nt(){return!(!x(c.value)&&!await qe(c.value)||y.regimen.value&&!x(F)&&!await qe(F))}async function Rt(){return We(["nextAppointmentDate"])}ye(()=>y.regimen.value,s=>{var N;Je(),s&&((N=s==null?void 0:s.other)==null||N.forEach(A=>{var z;F[A.drug_name]={label:"".concat((z=A.drug_name)!=null?z:A.alternative_drug_name," given"),required:!0,validation:ne=>tt([()=>he(ne,"POSITIVE_INTEGERS"),()=>Number(ne.value)%30!==0?["Quantity should be in multiples of 30"]:null])}}))}),ye(()=>y.patientPresent.value,s=>{s==="No"?(y.weight.required=!1,y.weight.error="",y.guardianPresent.value="Yes",w.value&&(y.isPregnant.required=!1,y.isPregnant.error="",y.isBreastfeeding.required=!1,y.isBreastfeeding.error="")):(y.weight.required=!0,w.value&&(y.isPregnant.required=!0,y.isBreastfeeding.required=!0))}),ye(()=>y.guardianPresent.value,s=>{s==="No"&&(y.patientPresent.value="Yes")}),ye([()=>y.weight.value,()=>{var s;return(s=y.tbStatus)==null?void 0:s.value}],async([s,N])=>{var z;y.regimen.value=void 0,Je();const A=/confirmed/i.test((z=N==null?void 0:N.label)!=null?z:"");s?(v.value=await Pe.getRegimens(s,A,y.visitDate.value),y.patientPresent.value="Yes",y.patientPresent.disabled=!0):!s&&y.weight.required&&(y.patientPresent.value=void 0,y.patientPresent.disabled=!1),y.tbMed.disabled=A}),ye(()=>y.nextAppointmentDate.value,async s=>{s&&g.value&&ie(g.value).diff(ie(s),"days")>7&&await De("The selected appointment date ".concat(me(s)," is more than 7 days earlier than drug run out date. \n            The client will have excess medication"),{header:"Drug Dispensation Alert",icon:"informationOutline",confirmBtnLabel:"OK",showCancelBtn:!1,color:"danger"})});const Ye=()=>{var s,N;return x(F)?1/0:Math.min(...((N=(s=y.regimen.value)==null?void 0:s.other)!=null?N:[]).map(A=>{var Te,Ne,mt,Ke,Ze;const z=Number((Ne=(Te=F[A.drug_name])==null?void 0:Te.value)!=null?Ne:0),ne=Number(A.am+A.noon+A.pm||1),pe=Number((Ze=(Ke=(mt=c.value)==null?void 0:mt[A.drug_name])==null?void 0:Ke.value)!=null?Ze:0);return z/ne+pe}))};ye([()=>F,()=>c,()=>y.visitDate.value],()=>{const s=Ye();if(s!==1/0){g.value=d.calculateDrugRunOutDate(s,y.visitDate.value),y.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(me(g.value),")");const N=ie(g.value).subtract(2,"day"),A=N.day();let z;A===0?z=N.subtract(2,"day"):A===6?z=N.subtract(1,"day"):z=N,y.nextAppointmentDate.value=$t(z)}},{deep:!0,immediate:!0}),ye(()=>y.visitDate.value,()=>Xe());const Xe=async()=>{u.setDate(y.visitDate.value),S.value=!1;const s=await u.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(s)){const N=await u.getFirstValueDatetime("TB treatment start date"),A=(await u.getFirstValueNumber("TB treatment period")||6)*30;if(N){const z=ie(y.visitDate.value).diff(N,"days");S.value=z<=A}}y.tbStatus.required=!S.value},Je=()=>{for(const s in F)delete F[s]},dt=async s=>{const N=s.height||f.value,A=dn.calculateBMI(s.weight,N);return l.buildValueNumber("BMI",A)},te=async()=>{const s=[await u.buildValueCoded("Patient using family planning","No")];return u.getFamilyPlanningMethods().forEach(async A=>{s.push(await u.buildValueCoded(A,"No"))}),s},X=async()=>Promise.all(vt.getConceptsByCategory("tb_symptom",!0).map(async s=>u.buildGroupValueCoded(s.name,s.name,"No")));return{form:y,drugsForm:F,adherenceForm:c,regimens:v,contraIndications:T,sideEffects:R,prevDrugs:k,isFemale:w,drugRunOutDate:g,isOnActiveTBTreatment:S,showHeightField:h,tbMeds:P,tbStatuses:ue,chestXRayResultsOptions:xe,mwrdResultsOptions:_t,hasGiven3HP:lt,hasGivenRFP:je,hasGiven6H:st,hasContraindications:wt,hasSideEffects:rt,isOnTBTreatment:ut,canTestForTB:Vt,loadPatientData:async()=>{try{await Xe(),f.value=await e.getRecentHeight(),p.value=await e.getRecentWeight(),p.value&&(v.value=await Pe.getRegimens(p.value)),k.value=await Et.getLastDrugsReceived(e.getID()),T.value=vt.getConceptsByCategory("contraindication",!0).map(s=>({value:s.concept_id,label:s.name,other:s,isChecked:!1})),R.value=vt.getConceptsByCategory("side_effect",!0).map(s=>({value:s.concept_id,label:s.name,other:s,isChecked:!1}))}catch(s){ke("Form initialization failed. Try to refresh the page"),console.error(s)}},resetForm:async()=>{if(await De("Are you sure you want to clear all fields?")){for(const s in y)y[s].value="",y[s].error="",y[s].disabled=!1;return Je(),!0}return!1},saveVisit:async()=>{l.setDate(y.visitDate.value),u.setDate(y.visitDate.value),d.setDate(y.visitDate.value),i.setDate(y.visitDate.value),r.setDate(y.visitDate.value),m.setDate(y.visitDate.value),b.setDate(y.visitDate.value),await ze(y,async(s,N)=>{var Ke,Ze,Bt,qt,Mt;const A=[];let z=0;if(!x(s.regimen)&&await qe(F)){const oe=s.regimen.other,$e=bt(F).formData;z=Ye(),oe.forEach(de=>A.push(d.toDrugOrder(de,$e[de.drug_name],z,s.visitDate)))}else if(!await De("Are you sure you want to continue without dispensing ART drugs?"))return;if(se.show("Saving patient visit..."),s.totalCPTGiven&&xt((await Pe.getRegimenExtras("Cotrimoxazole",(Ke=s.weight)!=null?Ke:p.value)).data,"concept_name").filter(oe=>oe.frequency==="Daily (QOD)").forEach(oe=>A.push(d.toDrugOrder(oe,s.totalCPTGiven,z,s.visitDate))),(Ze=s.tbMed)!=null&&Ze.value){const oe=xt((await Pe.getRegimenExtras("INH",(Bt=s.weight)!=null?Bt:p.value)).data,["concept_name","frequency"]),$e=oe.find(de=>de.concept_name==="Pyridoxine");if($e&&s.totalPyridoxineGiven&&A.push(d.toDrugOrder($e,s.totalPyridoxineGiven,z,s.visitDate)),s.totalIPTGiven){const de=oe.find(et=>et.concept_name==="Isoniazid"&&(st.value&&et.frequency==="Daily (QOD)"||je.value&&et.frequency==="Weekly (QW)"));A.push(d.toDrugOrder(de,s.totalIPTGiven,z,s.visitDate))}if(s.totalRFPGiven&&je.value){const de=(await Pe.getRegimenExtras("Rifapentine",(qt=s.weight)!=null?qt:p.value)).data;de.length&&A.push(d.toDrugOrder(de[0],s.totalRFPGiven,z,s.visitDate))}if(s.total3HPGiven&&lt.value){const de=(await Pe.getRegimenExtras("INH / RFP",(Mt=s.weight)!=null?Mt:p.value)).data;A.push(d.toDrugOrder(de[0],s.total3HPGiven,z,s.visitDate))}}if(!x(A)){await d.createEncounter();const $e=(await d.createDrugOrder(A)).data.map(de=>{const et=A.find(na=>na.drug_inventory_id===de.drug_inventory_id);return b.buildDispensations(de.order_id,et.qty,1)});await b.saveDispensations($e.flat(1))}const ne=await Fe(N,"vitals");if(!x(ne)){await l.createEncounter();const oe=await dt(s);await l.saveObservationList([...ne,oe])}await u.createEncounter();const pe=await Fe(N,"consultation");pe.push(...await u.buildOptionsGroupObs("Malawi ART side effects",T.value),...await X()),rt.value&&pe.push(...await u.buildOptionsGroupObs("Other side effect",R.value)),w.value&&pe.push(...await te()),await u.saveObservationList(pe),await i.createEncounter();const Te=await Fe(N,"reception");await i.saveObservationList(Te);const Ne=bt(c.value).computedFormData;if(!x(Ne)){const oe=await Fe(Ne);x(oe)||(await r.createEncounter(),await r.saveObservationList(oe.flat()))}await m.createEncounter();const mt=await Fe(N,"appointment");await m.saveObservationList(mt)},{showloader:!1,skipValidation:!0})},validateReceptionStep:Dt,validateConsultationStep:It,validateMedicationStep:Nt,validateAppointmentStep:Rt}}const cn={class:"step-container"},fn=Z({__name:"StepContainer",props:{title:{type:String,required:!0},isFirstStep:{type:Boolean,default:!1},isLastStep:{type:Boolean,default:!1},stepIndex:{type:Number,required:!0}},emits:["back","next"],setup(e,{emit:a}){return(l,u)=>(_(),U("div",cn,[C("h2",null,Q(e.title),1),Xt(l.$slots,"default",{},void 0,!0)]))}});const ht=re(fn,[["__scopeId","data-v-fc159c8d"]]),vn=Z({__name:"ReceptionStep",props:{form:{type:Object,required:!0},isFemale:{type:Boolean,required:!0},birthdate:{type:String,required:!0},showHeightField:{type:Boolean,required:!0}},emits:["next"],setup(e,{emit:a}){const l=a,u=()=>{l("next",0)};return(d,b)=>(_(),E(ht,{title:"Reception","is-first-step":!0,"is-last-step":!1,"step-index":0,onNext:u},{default:n(()=>[t(o(ce),{style:{width:"100%"}},{default:n(()=>[t(o(ae),null,{default:n(()=>[t(o(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Ie,{modelValue:e.form.visitDate,"onUpdate:modelValue":b[0]||(b[0]=i=>e.form.visitDate=i),form:e.form,minDate:e.birthdate,maxDate:o(ee)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Ae,{modelValue:e.form.patientPresent,"onUpdate:modelValue":b[1]||(b[1]=i=>e.form.patientPresent=i),disabled:e.form.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Ae,{modelValue:e.form.guardianPresent,"onUpdate:modelValue":b[2]||(b[2]=i=>e.form.guardianPresent=i)},null,8,["modelValue"])]),_:1}),e.isFemale?(_(),U(J,{key:0},[t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Ae,{modelValue:e.form.isPregnant,"onUpdate:modelValue":b[3]||(b[3]=i=>e.form.isPregnant=i)},null,8,["modelValue"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Ae,{modelValue:e.form.isBreastfeeding,"onUpdate:modelValue":b[4]||(b[4]=i=>e.form.isBreastfeeding=i)},null,8,["modelValue"])]),_:1})],64)):G("",!0),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(fe,{modelValue:e.form.weight,"onUpdate:modelValue":b[5]||(b[5]=i=>e.form.weight=i),form:e.form,min:1},null,8,["modelValue","form"])]),_:1}),e.showHeightField?(_(),E(o(O),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(fe,{modelValue:e.form.height,"onUpdate:modelValue":b[6]||(b[6]=i=>e.form.height=i),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Oe,{modelValue:e.form.bp,"onUpdate:modelValue":b[7]||(b[7]=i=>e.form.bp=i),form:e.form},null,8,["modelValue","form"])]),_:1})]),_:1})]),_:1})]),_:1}))}});const pn=re(vn,[["__scopeId","data-v-153ee5f1"]]),bn=Z({name:"MultiColumnView",components:{IonGrid:ce,IonRow:ae,IonCol:O},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(e){const a={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:M(()=>Pa(e.items,Math.ceil(e.items.length/e.numberOfColumns))),grid:a}}});function gn(e,a,l,u,d,b){const i=D("ion-col"),r=D("ion-row"),m=D("ion-grid");return _(),E(m,null,{default:n(()=>[t(r,null,{default:n(()=>[(_(!0),U(J,null,we(e.computedItems,(f,p)=>(_(),E(i,{key:p,size:e.grid[e.numberOfColumns]},{default:n(()=>[Xt(e.$slots,"default",{entries:f})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const Ct=re(bn,[["render",gn]]),yn=Z({__name:"ConsultationStep",props:{form:{type:Object,required:!0},showHeightField:{type:Boolean,required:!0},tbStatuses:{type:Array,required:!0},chestXRayResultsOptions:{type:Array,required:!0},mwrdResultsOptions:{type:Array,required:!0},isOnTBTreatment:{type:Boolean,required:!0},isOnActiveTBTreatment:{type:Boolean,required:!0},canTestForTB:{type:Boolean,required:!0},birthdate:{type:String,required:!0},contraIndications:{type:Array,required:!0},sideEffects:{type:Array,required:!0},hasContraindications:{type:Boolean,required:!0},hasSideEffects:{type:Boolean,required:!0}},emits:["back","next"],setup(e,{emit:a}){const l=a,u=()=>{l("back",1)},d=()=>{l("next",1)};return(b,i)=>(_(),E(ht,{title:"Consultation","step-index":1,onBack:u,onNext:d},{default:n(()=>[t(o(ce),{style:{width:"100%"}},{default:n(()=>[t(o(ae),null,{default:n(()=>[t(o(O),{size:"12"},{default:n(()=>[...i[7]||(i[7]=[C("h4",{class:"section-title"},"TB Assessment",-1)])]),_:1}),t(o(O),{class:"ion-margin-vertical",size:"12"},{default:n(()=>[t(ge,{modelValue:e.form.tbStatus,"onUpdate:modelValue":i[0]||(i[0]=r=>e.form.tbStatus=r),options:e.tbStatuses},null,8,["modelValue","options"])]),_:1}),e.isOnTBTreatment&&!e.isOnActiveTBTreatment?(_(),U(J,{key:0},[t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Ie,{modelValue:e.form.tbTreatmentStartDate,"onUpdate:modelValue":i[1]||(i[1]=r=>e.form.tbTreatmentStartDate=r),form:e.form,minDate:e.birthdate,maxDate:o(ee)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(fe,{modelValue:e.form.tbTreatmentPeriod,"onUpdate:modelValue":i[2]||(i[2]=r=>e.form.tbTreatmentPeriod=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})],64)):e.canTestForTB?(_(),U(J,{key:1},[t(o(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Ae,{modelValue:e.form.cxrResult,"onUpdate:modelValue":i[3]||(i[3]=r=>e.form.cxrResult=r),"custom-options":e.chestXRayResultsOptions},null,8,["modelValue","custom-options"])]),_:1}),t(o(O),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[t(Ae,{modelValue:e.form.mwrdResult,"onUpdate:modelValue":i[4]||(i[4]=r=>e.form.mwrdResult=r),"custom-options":e.mwrdResultsOptions},null,8,["modelValue","custom-options"])]),_:1})],64)):G("",!0)]),_:1}),t(o(ae),null,{default:n(()=>[t(o(O),{size:"12"},{default:n(()=>[...i[8]||(i[8]=[C("h4",{class:"section-title"},"Side Effects & Contraindications",-1)])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Ae,{modelValue:e.form.hasContraindications,"onUpdate:modelValue":i[5]||(i[5]=r=>e.form.hasContraindications=r)},null,8,["modelValue"]),e.hasContraindications?(_(),E(Ct,{key:0,items:e.contraIndications,numberOfColumns:2},{default:n(({entries:r})=>[(_(!0),U(J,null,we(r,m=>(_(),E(o(it),{lines:"none",key:m.value},{default:n(()=>[t(o(Ue),null,{default:n(()=>[$(Q(m.label),1)]),_:2},1024),t(o(Pt),{slot:"start",modelValue:m.isChecked,"onUpdate:modelValue":f=>m.isChecked=f},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1}),t(o(O),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[t(Ae,{modelValue:e.form.hasSideEffects,"onUpdate:modelValue":i[6]||(i[6]=r=>e.form.hasSideEffects=r)},null,8,["modelValue"]),e.hasSideEffects?(_(),E(Ct,{key:0,items:e.sideEffects,numberOfColumns:2},{default:n(({entries:r})=>[(_(!0),U(J,null,we(r,m=>(_(),E(o(it),{lines:"none",key:m.value},{default:n(()=>[t(o(Ue),null,{default:n(()=>[$(Q(m.label),1)]),_:2},1024),t(o(Pt),{slot:"start",modelValue:m.isChecked,"onUpdate:modelValue":f=>m.isChecked=f},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1})]),_:1})]),_:1})]),_:1}))}});const hn=re(yn,[["__scopeId","data-v-1d2ba071"]]),_n=Z({__name:"MedicationStep",props:{form:{type:Object,required:!0},drugsForm:{type:Object,required:!0},adherenceForm:{type:Object,required:!0},regimens:{type:Array,required:!0},tbMeds:{type:Array,required:!0},hasGiven3HP:{type:Boolean,required:!0},hasGivenRFP:{type:Boolean,required:!0},hasGiven6H:{type:Boolean,required:!0}},emits:["back","next"],setup(e,{emit:a}){const l=a,u=()=>{l("back",3)},d=()=>{l("next",3)};return(b,i)=>(_(),E(ht,{title:"Medication & Adherence","step-index":3,onBack:u,onNext:d},{default:n(()=>[t(o(ce),{style:{width:"100%"}},{default:n(()=>[t(o(ae),null,{default:n(()=>[e.adherenceForm&&!o(x)(e.adherenceForm)?(_(),U(J,{key:0},[t(o(O),{size:"12"},{default:n(()=>[...i[7]||(i[7]=[C("h4",{class:"section-title"},"Adherence Assessment",-1),C("p",{class:"section-description"},"Record the number of pills the patient has brought back from their previous visit",-1)])]),_:1}),(_(!0),U(J,null,we(Object.values(e.adherenceForm),(r,m)=>(_(),E(o(O),{size:"6",class:"ion-margin-bottom",key:m},{default:n(()=>[t(fe,{"model-value":r,form:e.adherenceForm,min:0},null,8,["model-value","form"])]),_:2},1024))),128))],64)):G("",!0),t(o(O),{size:"12"},{default:n(()=>[...i[8]||(i[8]=[C("h4",{class:"section-title"},"Medication Orders",-1),C("p",{class:"section-description"},"Record the number of pills the patient has received during this visit",-1)])]),_:1}),t(o(O),{size:"12",class:"ion-margin-bottom"},{default:n(()=>[t(ge,{modelValue:e.form.regimen,"onUpdate:modelValue":i[0]||(i[0]=r=>e.form.regimen=r),options:e.regimens},null,8,["modelValue","options"])]),_:1}),o(x)(e.drugsForm)?G("",!0):(_(!0),U(J,{key:1},we(Object.values(e.drugsForm),(r,m)=>(_(),E(o(O),{size:"6",class:"ion-margin-bottom",key:"drug-".concat(m)},{default:n(()=>[t(fe,{"model-value":r,form:e.drugsForm,min:1},null,8,["model-value","form"])]),_:2},1024))),128)),t(o(O),{size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(fe,{modelValue:e.form.totalCPTGiven,"onUpdate:modelValue":i[1]||(i[1]=r=>e.form.totalCPTGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(ge,{modelValue:e.form.tbMed,"onUpdate:modelValue":i[2]||(i[2]=r=>e.form.tbMed=r),options:e.tbMeds,"drop-direction":"top"},null,8,["modelValue","options"])]),_:1}),e.hasGiven6H||e.hasGivenRFP?(_(),E(o(O),{key:2,size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(fe,{modelValue:e.form.totalIPTGiven,"onUpdate:modelValue":i[3]||(i[3]=r=>e.form.totalIPTGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e.hasGivenRFP?(_(),E(o(O),{key:3,size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(fe,{modelValue:e.form.totalRFPGiven,"onUpdate:modelValue":i[4]||(i[4]=r=>e.form.totalRFPGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e.hasGiven3HP?(_(),E(o(O),{key:4,size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(fe,{modelValue:e.form.total3HPGiven,"onUpdate:modelValue":i[5]||(i[5]=r=>e.form.total3HPGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e.hasGiven3HP||e.hasGivenRFP||e.hasGiven6H?(_(),E(o(O),{key:5,size:"6",class:"ion-margin-bottom"},{default:n(()=>[t(fe,{modelValue:e.form.totalPyridoxineGiven,"onUpdate:modelValue":i[6]||(i[6]=r=>e.form.totalPyridoxineGiven=r),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0)]),_:1})]),_:1})]),_:1}))}});const wn=re(_n,[["__scopeId","data-v-27c751fc"]]),Vn={class:"calendar-section"},Dn={class:"date-picker-container"},In={key:0,class:"text-danger"},Nn={class:"info-section"},Rn={class:"info-box"},An={class:"drug-runout-info"},Sn={class:"info-content"},Tn={class:"date"},Pn={class:"summary-section"},On={class:"summary-content"},Cn={class:"summary-item"},kn={class:"value"},En={class:"summary-item"},$n={class:"value"},Fn={class:"summary-item"},Bn={class:"value"},qn={key:0,class:"summary-item"},Mn={class:"value"},Hn={key:1,class:"summary-item"},Un={class:"value"},Gn={key:2,class:"summary-item"},Ln={class:"value"},zn=Z({__name:"AppointmentStep",props:{form:{type:Object,required:!0},drugRunOutDate:{type:String,required:!0}},emits:["back","next"],setup(e,{emit:a}){const l=e,u=a,d=M(()=>l.drugRunOutDate?me(l.drugRunOutDate):"Not available"),b=m=>m?me(m):"",i=()=>{u("back",4)},r=()=>{u("next",4)};return(m,f)=>(_(),E(ht,{title:"Next Appointment","step-index":4,"is-last-step":!0,onBack:i,onNext:r},{default:n(()=>[t(o(ce),{style:{width:"100%"}},{default:n(()=>[t(o(ae),null,{default:n(()=>[t(o(O),{size:"12","size-md":"6",class:"left-column"},{default:n(()=>[C("div",Vn,[f[1]||(f[1]=C("h4",{class:"section-title"},"Schedule Next Appointment",-1)),C("div",Dn,[t(o(Ue),{class:"ion-padding-bottom bold"},{default:n(()=>[C("span",null,Q(e.form.nextAppointmentDate.label),1),e.form.nextAppointmentDate.required?(_(),U("span",In," *")):G("",!0)]),_:1}),t(o(ua),{presentation:"date",class:Jt(["ion-margin-top",e.form.nextAppointmentDate.error?"box-input-error":"box-input"]),modelValue:e.form.nextAppointmentDate.value,"onUpdate:modelValue":f[0]||(f[0]=p=>e.form.nextAppointmentDate.value=p),min:e.form.visitDate.value,max:e.drugRunOutDate,onIonChange:()=>{}},null,8,["class","modelValue","min","max"]),e.form.nextAppointmentDate.error?(_(),E(o(da),{key:0,color:"danger"},{default:n(()=>[$(Q(e.form.nextAppointmentDate.error),1)]),_:1})):G("",!0)])])]),_:1}),t(o(O),{size:"12","size-md":"6",class:"right-column"},{default:n(()=>[C("div",Nn,[f[3]||(f[3]=C("h4",{class:"section-title"},"Drug Run Out Information",-1)),C("div",Rn,[C("div",An,[t(o(ft),{name:"calendar-outline",class:"info-icon"}),C("div",Sn,[C("div",Tn,Q(d.value),1),f[2]||(f[2]=C("p",{class:"note"},"The patient will run out of medication on this date",-1))])])])]),C("div",Pn,[f[10]||(f[10]=C("h4",{class:"section-title"},"Visit Summary",-1)),C("div",On,[C("div",Cn,[f[4]||(f[4]=C("div",{class:"label"},"Visit Date:",-1)),C("div",kn,Q(b(e.form.visitDate.value)),1)]),C("div",En,[f[5]||(f[5]=C("div",{class:"label"},"Patient Present:",-1)),C("div",$n,Q(e.form.patientPresent.value),1)]),C("div",Fn,[f[6]||(f[6]=C("div",{class:"label"},"Guardian Present:",-1)),C("div",Bn,Q(e.form.guardianPresent.value),1)]),e.form.weight.value?(_(),U("div",qn,[f[7]||(f[7]=C("div",{class:"label"},"Weight:",-1)),C("div",Mn,Q(e.form.weight.value)+" kg",1)])):G("",!0),e.form.regimen.value?(_(),U("div",Hn,[f[8]||(f[8]=C("div",{class:"label"},"Regimen:",-1)),C("div",Un,Q(e.form.regimen.value.label),1)])):G("",!0),e.form.tbStatus.value?(_(),U("div",Gn,[f[9]||(f[9]=C("div",{class:"label"},"TB Status:",-1)),C("div",Ln,Q(e.form.tbStatus.value.label),1)])):G("",!0)])])]),_:1})]),_:1})]),_:1})]),_:1}))}});const xn=re(zn,[["__scopeId","data-v-db361dbb"]]),jn={class:"visit-container"},Wn={class:"side-navigation"},Yn=["onClick"],Xn={class:"nav-number"},Jn={class:"nav-label"},Qn={class:"main-content"},Kn=Z({__name:"Index",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=[{label:"Reception",component:pn},{label:"Consultation",component:hn},{label:"Medication",component:wn},{label:"Appointment",component:xn}],u=M(()=>r.patientPresent.value==="No"&&r.guardianPresent.value==="Yes"?l.filter(te=>te.label!=="Consultation"):l),d=q(0),b=M(()=>(d.value+1)/u.value.length),i=M(()=>u.value[d.value].component),{form:r,drugsForm:m,adherenceForm:f,regimens:p,contraIndications:v,sideEffects:T,isFemale:R,drugRunOutDate:k,isOnActiveTBTreatment:w,showHeightField:g,tbMeds:I,tbStatuses:S,chestXRayResultsOptions:F,mwrdResultsOptions:c,hasGiven3HP:h,hasGivenRFP:V,hasGiven6H:B,hasContraindications:H,hasSideEffects:Y,isOnTBTreatment:y,canTestForTB:P,loadPatientData:ue,resetForm:xe,saveVisit:_t,validateReceptionStep:lt,validateConsultationStep:je,validateMedicationStep:st,validateAppointmentStep:wt}=mn(a.patient),rt=a.patient.getBirthdate(),{isDICSite:ut,refreshDICStatus:Vt}=kt(),{enrollPatient:We,fetchPatientPrograms:Dt,hasProgram:It,updateState:Nt}=yt(a.patient.getID()),Rt=te=>{te<=d.value&&(d.value=te)},Ye=te=>{te>0&&(d.value=te-1)},Xe=async te=>{let X=!1;switch(u.value[te].label){case"Reception":X=await lt();break;case"Consultation":X=await je();break;case"Medication":X=await st();break;case"Appointment":X=await wt();break;default:X=!0}X?te<u.value.length-1?d.value=te+1:dt():ke("Please correct the errors before proceeding")},Je=async()=>{await xe()&&(d.value=0,j.emit(W.ON_CLEAR))},dt=async()=>{se.show("Saving patient visit...");try{await _t(),ut.value&&!It(At)&&(await We(r.visitDate.value,At),await Nt(pa,r.visitDate.value,At)),await Me("Patient visit saved successfully"),await se.hide(),await L.hide(),j.emit(W.RELOAD_PATIENT_VISIT_DATA),j.emit(W.RELOAD_STAGING_INFORMATION)}catch(te){console.error("Error saving visit:",te)}finally{se.hide()}};return _e(async()=>{await ue(),await Vt(),await Dt()}),_e(()=>{j.on(W.ON_CLEAR,()=>{d.value=0})}),(te,X)=>(_(),U(J,null,[t(o(He),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(ot),null,{default:n(()=>[...X[2]||(X[2]=[$("Patient Visit",-1)])]),_:1}),t(o(Ut),{slot:"end"},{default:n(()=>[t(o(K),{color:"danger",fill:"clear",size:"large",onClick:o(L).hide},{default:n(()=>[t(o(ft),{icon:o(Gt)},null,8,["icon"])]),_:1},8,["onClick"])]),_:1})]),_:1}),t(o(ma),{value:b.value},null,8,["value"])]),_:1}),t(o(Ge),{class:"ion-padding"},{default:n(()=>[C("div",jn,[C("div",Wn,[(_(!0),U(J,null,we(u.value,(Qe,Ee)=>(_(),U("div",{key:Ee,class:Jt(["nav-item",{active:d.value===Ee,completed:d.value>Ee}]),onClick:aa=>Rt(Ee)},[C("div",Xn,Q(Ee+1),1),C("div",Jn,Q(Qe.label),1)],10,Yn))),128))]),C("div",Qn,[(_(),E(fa,null,[(_(),E(ca(i.value),{form:o(r),drugsForm:o(m),adherenceForm:o(f),regimens:o(p),contraIndications:o(v),sideEffects:o(T),showHeightField:o(g),isFemale:o(R),drugRunOutDate:o(k),birthdate:o(rt),tbMeds:o(I),tbStatuses:o(S),chestXRayResultsOptions:o(F),mwrdResultsOptions:o(c),isOnTBTreatment:o(y),isOnActiveTBTreatment:o(w),canTestForTB:o(P),hasGiven3HP:o(h),hasGivenRFP:o(V),hasGiven6H:o(B),hasContraindications:o(H),hasSideEffects:o(Y),onBack:Ye,onNext:Xe},null,40,["form","drugsForm","adherenceForm","regimens","contraIndications","sideEffects","showHeightField","isFemale","drugRunOutDate","birthdate","tbMeds","tbStatuses","chestXRayResultsOptions","mwrdResultsOptions","isOnTBTreatment","isOnActiveTBTreatment","canTestForTB","hasGiven3HP","hasGivenRFP","hasGiven6H","hasContraindications","hasSideEffects"]))],1024))])])]),_:1}),t(o(Le),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(Ut),{slot:"end"},{default:n(()=>[d.value>0?(_(),E(o(K),{key:0,color:"primary",fill:"solid",onClick:X[0]||(X[0]=Qe=>Ye(d.value))},{default:n(()=>[...X[3]||(X[3]=[$(" Back ",-1)])]),_:1})):G("",!0),t(o(K),{color:"danger",fill:"solid",onClick:o(L).hide},{default:n(()=>[t(o(ft),{slot:"start",icon:o(Gt)},null,8,["icon"]),X[4]||(X[4]=$(" Cancel ",-1))]),_:1},8,["onClick"]),t(o(K),{color:"warning",fill:"solid",onClick:Je},{default:n(()=>[t(o(ft),{slot:"start",icon:o(va)},null,8,["icon"]),X[5]||(X[5]=$(" Reset ",-1))]),_:1}),d.value<u.value.length-1?(_(),E(o(K),{key:1,color:"primary",fill:"solid",onClick:X[1]||(X[1]=Qe=>Xe(d.value))},{default:n(()=>[...X[6]||(X[6]=[$(" Next ",-1)])]),_:1})):(_(),E(o(K),{key:2,color:"success",fill:"solid",onClick:dt},{default:n(()=>[...X[7]||(X[7]=[$(" Save Visit ",-1)])]),_:1}))]),_:1})]),_:1})]),_:1})],64))}});const Zn=re(Kn,[["__scopeId","data-v-3587db08"]]),ei=Z({__name:"EmergencyRefill",props:{patient:{type:Object,required:!0}},setup(e){const a=e,l=M(()=>a.patient.getID()),u=new ta(l.value),d=q(),b=q([]),i=q([]),r=M(()=>{var c;return(c=i.value[0])==null?void 0:c.order.start_date}),m=q(""),f=a.patient.getBirthdate(),p=q({}),v=le({date:{value:ee(),label:"Date of emergency refill",required:!0,computedValue:c=>({obs:u.buildValueDate("Prescription refill date",c)})},facility:{value:void 0,label:"Facility where emergency refill was collected",required:!0,placeholder:"Select a facility",computedValue:c=>({obs:u.buildValueText("Health facility name",c.label)})},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:c=>({obs:u.buildValueDate("Appointment date",c)})}});async function T(c,h,V){const B=u.calculateExpected(c.quantity,c.equivalent_daily_dose,c.order.start_date,c.frequency),H=u.calculateAdherence(c.quantity,V,B);return{...await u.buildValueCoded("Medications dispensed",c.drug.concept_id),child:[await u.buildAdherenceObs(c.order_id,c.drug_inventory_id,H),await u.buildPillCountObs(c.order_id,V),,await u.buildValueNumber("Amount of drug dispensed",h)]}}async function R(){if(await De("Are you sure you want to clear all fields?")){for(const c in v)v[c].value="",v[c].error="",v[c].disabled=!1;k(),j.emit(W.ON_CLEAR)}}function k(){for(const c in p.value)delete p.value[c]}function w(c){return c.regimen?"".concat(c.regimen," - ").concat(c.drug.name):c.drug.name}function g(){return x(i.value)?1/0:Math.min(...i.value.map(c=>{var Y,y,P,ue;const h=w(c),V=Number((y=(Y=p.value["".concat(h,"_given")])==null?void 0:Y.value)!=null?y:0),B=Number((ue=(P=p.value["".concat(h,"_brought")])==null?void 0:P.value)!=null?ue:0),H=Number(c.equivalent_daily_dose);return(V+B)/H}))}function I(){const c=g();c!==1/0&&(m.value=Sa(v.date.value,c,"days"),v.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(me(m.value),")"),v.nextAppointmentDate.value=m.value)}async function S(){if(await qe(v)&&await qe(p.value))try{se.show(),u.setDate(v.date.value);const c=await Fe({...bt(v).computedFormData,...bt(p.value).computedFormData}),h=new be(l.value,Se.EMERGENCY_DRUG_REFILL,v.date.value);await h.createEncounter(),await h.saveObservationList(c),Me("Emergency refill saved successfully"),L.hide(),j.emit(W.RELOAD_PATIENT_VISIT_DATA),j.emit(W.RELOAD_STAGING_INFORMATION)}catch(c){console.error(c),ke("Failed to save emergency refill")}finally{se.hide()}}function F(){i.value.forEach(c=>{const h=w(c);p.value["".concat(h,"_brought")]={label:"".concat(h," brought"),value:void 0,required:!0,placeholder:"Enter the number of pills brought",validation:V=>he(V,"POSITIVE_INTEGERS")},p.value["".concat(h,"_given")]={label:"".concat(h," given"),value:void 0,required:!0,placeholder:"Enter the number of pills given",validation:V=>he(V,"POSITIVE_INTEGERS"),computedValue:(V,B)=>T(c,V,B["".concat(h,"_brought")].value)}})}return ye([()=>p,()=>v.date.value],I,{deep:!0,immediate:!0}),_e(async()=>{try{se.show(),d.value=await a.patient.getRecentWeight(),b.value=await Pe.getRegimens(d.value,void 0,v.date.value),i.value=await Et.getLastDrugsReceived(l.value),F()}catch(c){ke("Form initialization failed. Try to refresh the page"),console.error(c)}finally{se.hide()}}),(c,h)=>(_(),U(J,null,[t(o(He),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(ot),null,{default:n(()=>[...h[4]||(h[4]=[$("Emergency Drug Refill",-1)])]),_:1})]),_:1})]),_:1}),t(o(Ge),{class:"ion-padding"},{default:n(()=>[t(o(ce),{style:{width:"100%"}},{default:n(()=>[t(o(ae),null,{default:n(()=>[t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Ie,{modelValue:v.date,"onUpdate:modelValue":h[0]||(h[0]=V=>v.date=V),form:v,minDate:r.value||o(f),maxDate:o(ee)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(ge,{modelValue:v.facility,"onUpdate:modelValue":h[1]||(h[1]=V=>v.facility=V),form:v,asyncOptions:o(ea)},null,8,["modelValue","form","asyncOptions"])]),_:1}),(_(!0),U(J,null,we(Object.values(p.value),V=>(_(),E(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(fe,{"model-value":V,form:p.value,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),t(o(O),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[t(Ie,{modelValue:v.nextAppointmentDate,"onUpdate:modelValue":h[2]||(h[2]=V=>v.nextAppointmentDate=V),form:v,minDate:v.date.value,maxDate:m.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1})]),_:1})]),_:1})]),_:1}),t(o(Le),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(K),{color:"primary",onClick:h[3]||(h[3]=V=>o(L).hide()),slot:"end"},{default:n(()=>[...h[5]||(h[5]=[$(" Close ",-1)])]),_:1}),t(o(K),{color:"warning",onClick:R,slot:"end"},{default:n(()=>[...h[6]||(h[6]=[$(" Reset ",-1)])]),_:1}),t(o(K),{color:"success",onClick:S,slot:"end"},{default:n(()=>[...h[7]||(h[7]=[$(" Save ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),ti=Z({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:Ft,IonCard:ba,IonCardHeader:ga,IonCardTitle:ya,IonCardContent:ha,IonButton:K},setup(e){const a=q([]),l=M(()=>e.patient.getID()),u=le({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),d=q([{label:"Add Visit",action:async()=>{await L.show(Zn,{patient:e.patient})}},{label:"Emergency Refill",action:async()=>{await L.show(ei,{patient:e.patient})}},{label:"Update Outcome",action:async()=>L.show(on,{patient:e.patient})},{label:"Enter VL Results",action:async()=>L.show(ja,{patient:e.patient})}]),b=w=>{const g=e.startDate!=="N/A"?"("+ie(w).diff(e.startDate,"months")+"M)":"";return"".concat(me(w)," ").concat(g)},i={minWidth:"68px !important"},r=q([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:i},{path:"vitals",label:"Vitals",sortable:!1,thStyles:{minWidth:"120px !important"}},...e.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:i},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:i}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:w=>w.length>0?"Yes":"No",sortable:!1,thStyles:i},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:i},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:i},{path:"vlResult",label:"Viral Load",sortable:!1}]),m=w=>({title:"Side effects noted on ".concat(w.row.visitDate),rows:w.row.sideEffects.map(g=>({sideEffect:g})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),f=w=>({title:"Drugs dispensed on ".concat(w.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:w.row.drugs.map(g=>({name:g[0],quantity:g[1],units:"tab (s)"}))}),p=async w=>{const g=/regimen/i.test(w.column.path)?f(w):m(w);x(g.rows)||await L.show(Ba,g)},v=[{label:"void",icon:_a,color:"danger",action(w,g){Qt(async I=>{var F;const S=await zt.getEncounters(l.value,{date:w.date});S.ok?((F=S.data)==null||F.forEach(async c=>{await zt.voidEncounter(c.encounter_id,I)}),a.value.splice(g,1)):ke(S.errorMessage||"Failed to void encounters")},"small-modal")}}],T=async w=>w.tb_status.match(/Unknown/i)||w.outcome==="Defaulted"?"":vt.getCachedConceptName(w.tb_status),R=w=>{const g=w.weight?"Wt: ".concat(w.weight,"kg"):"",I=w.height?"Ht: ".concat(w.height,"cm"):"",S=w.bmi?"BMI: ".concat(w.bmi):"",F=w.systolic_blood_pressure&&w.diastolic_blood_pressure?"BP: ".concat(w.systolic_blood_pressure,"/").concat(w.diastolic_blood_pressure):"";return[g,I,S,F].filter(Boolean).join(", ")},k=()=>{const{getProgramInfo:w}=yt(l.value);at.getPatientVisits(l.value,!0).then(async g=>{a.value=[];for(const I of g){const S=await w(I);let F="",c="",h="",V="";if(S.outcome!=="Defaulted"){const B=await ct.getFirstValueDatetime(l.value,"appointment date",I);if(B&&(F=me(B)),c=await ct.getFirstValueCoded(l.value,"Is patient pregnant",I),h=await ct.getFirstValueCoded(l.value,"Is patient breast feeding",I),S.viral_load==="N/A"){const H=await ct.getFirstObs(l.value,"HIV viral load",I);H&&H.value_text&&H.value_numeric&&(V=H.value_numeric===1?"LDL":H.value_text+H.value_numeric.toString())}else V=S.viral_load}S&&a.value.push({visitDate:b(I),visitBy:S.visit_by.match(/Unk/i)?"":S.visit_by,vitals:R(S),pregnant:c,breastfeeding:h,tbStatus:await T(S),sideEffects:S.outcome==="Defaulted"?"":S.side_effects,regimen:S.outcome==="Defaulted"?"":S.regimen,nextAppointment:F,outcome:S.outcome.match(/Unk/i)?"":S.outcome,vlResult:V,drugs:S.pills_dispensed,date:I})}})};return j.on(W.RELOAD_PATIENT_VISIT_DATA,()=>k()),_e(()=>{k()}),{actionButtons:d,tableConfig:u,rowButtons:v,columns:r,rows:a,onDrilldownHandler:p}}});const ai={class:"ion-float-right ion-margin-end ion-margin-bottom"};function ni(e,a,l,u,d,b){const i=D("ion-icon"),r=D("ion-button"),m=D("ion-card-title"),f=D("ion-card-header"),p=D("data-table"),v=D("ion-card-content"),T=D("ion-card");return _(),E(T,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[t(f,null,{default:n(()=>[t(m,null,{default:n(()=>[a[0]||(a[0]=C("span",{class:"title"},"Summary of Visits",-1)),C("span",ai,[(_(!0),U(J,null,we(e.actionButtons,R=>(_(),E(r,{key:R.label,onClick:R.action,color:R.color||"primary"},{default:n(()=>[R.icon?(_(),E(i,{key:0,icon:R.icon,class:"ion-margin-right"},null,8,["icon"])):G("",!0),$(" "+Q(R.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),t(v,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[t(p,{rows:e.rows,columns:e.columns,"row-actions-buttons":e.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:e.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const ii=re(ti,[["render",ni],["__scopeId","data-v-7bb05fd5"]]),oi=Z({__name:"ViralLoadTrail",props:{patient:{}},setup(e){const a=e,l=M(()=>"Viral Load Results Trail for ".concat(a.patient.getFullName())),u=q([]),d=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:me},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:me}],b={label:"X",color:"danger",action({encounter_id:i}){Qt(async r=>{try{await wa.void(i,r),L.hide(),j.emit(W.RELOAD_LATEST_VL_RESULT),j.emit(W.RELOAD_PATIENT_VISIT_DATA)}catch(m){console.error(m)}},"small-modal custom-modal-backdrop")}};return _e(async()=>{u.value=await Ce.getViralLoadResultTrail(a.patient.getID())}),(i,r)=>(_(),U(J,null,[t(o(He),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(ot),null,{default:n(()=>[$(Q(l.value),1)]),_:1})]),_:1})]),_:1}),t(o(Ge),null,{default:n(()=>[t(o(ce),{style:{width:"100%"}},{default:n(()=>[t(o(ae),{style:Yt([{padding:"0 !important"},{minHeight:u.value.length?"0":"30vh"}])},{default:n(()=>[t(o(O),{size:"12",class:"ion-no-padding"},{default:n(()=>[t(o(Ft),{rows:u.value,columns:d,"row-actions-buttons":[b],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),t(o(Le),null,{default:n(()=>[t(o(ve),null,{default:n(()=>[t(o(K),{color:"primary",onClick:r[0]||(r[0]=m=>o(L).hide()),slot:"end"},{default:n(()=>[...r[1]||(r[1]=[$(" Close ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),li=Z({components:{MultiColumnView:Ct,IonList:Wt,IonItem:it},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(e,{emit:a}){const l=q(0),u=q(0),d=q(0),b=q(""),i=q(""),r=q(""),m=q(""),f=q(""),p=q(""),v=q(""),T=q(""),R=q(""),k=q(""),w=q(""),g=P=>P.other&&typeof P.other.onClickHandler=="function",I=M(()=>!x(e.guardians)),S=async P=>{var ue;g(P)&&await((ue=P.other)==null?void 0:ue.onClickHandler())},F=()=>{const P=e.patient.getBirthdate(),ue=e.artStartDate!=="N/A"?ie(e.artStartDate).diff(P,"years"):"";return"".concat(me(P)," (").concat(ue,")")},c=()=>{Ce.getlatestViralLoadResult(e.patient.getID()).then(P=>k.value=P)},h=()=>({onClickHandler(){Va.push("/patient/reception/".concat(e.patient.getID(),"/false"))}}),V=()=>I.value?e.guardians.map(P=>"".concat(P.name," (").concat(P.relationshipType,")")).join(","):"Add",B=()=>({onClickHandler:()=>a("updatePatient")}),H=M(()=>[{label:"ARV Number",value:e.patient.getArvNumber(),other:{onClickHandler:()=>a("updateARVNumber")}},{label:"NPID",value:e.patient.getNationalID()},{label:"MW National ID",value:e.patient.getMWNationalID(),other:B()},{label:"Name",value:e.patient.getGivenName()+" "+e.patient.getFamilyName(),other:B()},{label:"DOB and Age at Initiation",value:F(),other:B()},{label:"Sex",value:qa(e.patient.getGender()),other:B()},{label:"Location",value:e.patient.getCurrentVillage(),other:B()},{label:"Landmark",value:e.patient.getClosestLandmark(),other:B()},{label:"Phone Number",value:e.patient.getPhoneNumber(),other:B()},{label:"Guardian",value:V(),other:{onClickHandler:()=>a("updateGuardian")}},{label:"Agrees to follow up",value:f.value,other:h()},{label:"Date of starting first line ARV Regimen",value:e.artStartDate,other:h()},{label:"Initial Weight and Height",value:"".concat(l.value,"Kg, ").concat(u.value,"cm"),other:h()},{label:"Initial BMI",value:d.value,other:h()},{label:"Initial TB Status",value:b.value,other:h()},{label:"Pregnant at Initiation",value:r.value,other:h()},{label:"Breastfeeding at Initiation",value:i.value,other:h()},{label:"Latest VL Result and Result Date",value:k.value,other:{onClickHandler:()=>L.show(oi,{patient:e.patient})}},{label:"TI",value:m.value,other:h()},{label:"HIV test place",value:T.value,other:h()},{label:"HIV test date",value:v.value,other:h()},{label:"WHO stage",value:w.value,other:h()},{label:"Reason for starting ART",value:p.value,other:h()},{label:"Staging condition",value:R.value,other:h()}]),Y=async()=>{const P=await e.patient.getHIVTestDate();P&&(v.value=me(P))},y=()=>{e.patient.getInitialWeight().then(P=>l.value=P),e.patient.getInitialHeight().then(P=>u.value=P),e.patient.getInitialBMI().then(P=>d.value=P),e.patient.getInitialTBStatus().then(P=>b.value=P),e.patient.hasPregnancyAtARTInitiation().then(P=>r.value=P),e.patient.breastFeedingAtARTInitiation().then(P=>i.value=P),e.patient.everReceivedART().then(P=>m.value=P),e.patient.agreesToFollowUp().then(P=>f.value=P),e.patient.getReasonForStartingART().then(P=>p.value=P),e.patient.getHIVTestLocation().then(P=>T.value=P),e.patient.getStagingCondition().then(P=>R.value=P),e.patient.getWhoStage().then(P=>w.value=P),Y()};return _e(()=>{y(),c(),j.on(W.RELOAD_LATEST_VL_RESULT,()=>c()),j.on(W.RELOAD_STAGING_INFORMATION,()=>y())}),{patientInfo:H,onClickHandler:S,clickable:g}}});const si={style:{width:"100%",display:"flex",justifyContent:"space-between"}},ri={key:0},ui={key:1},di={key:2},mi={key:3};function ci(e,a,l,u,d,b){const i=D("ion-item"),r=D("ion-list"),m=D("multi-column-view");return _(),E(m,{items:e.patientInfo,numberOfColumns:3},{default:n(({entries:f})=>[t(r,{class:"his-card ion-margin-end"},{default:n(()=>[(_(!0),U(J,null,we(f,(p,v)=>(_(),E(i,{key:v,lines:v===f.length-1?"none":void 0,button:e.clickable(p),onClick:T=>e.onClickHandler(p)},{default:n(()=>[C("div",si,[p.label?(_(),U("span",ri,Q(p.label)+": ",1)):(_(),U("span",ui)),e.clickable(p)?(_(),U("span",di,[C("a",null,[C("b",null,Q(p.value||"N/A"),1)])])):(_(),U("span",mi,[C("b",null,Q(p.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const fi=re(li,[["render",ci],["__scopeId","data-v-6b436603"]]),vi=Z({components:{IonGrid:ce,IonRow:ae,IonCol:O,TextInput:Oe,DateInput:Ie,SelectInput:ge},props:{patientService:{type:Object,required:!0}},setup(e){const a=q(!1),l=M(()=>/Unknown/i.test(e.patientService.getMWNationalID())?"":e.patientService.getMWNationalID()),u=le({givenName:{label:"First Name",value:e.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:i=>nt(i)},familyName:{label:"last Name",value:e.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:i=>nt(i)},middleName:{label:"middle Name",value:e.patientService.getMiddleName(),placeholder:"middle Name",validation:i=>!!i&&nt(i)},nationalId:{label:"Malawi National ID Number",value:l.value,placeholder:"Enter Malawi National ID Number",validation:i=>i&&i.label?Ca(i):null},gender:{value:e.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:e.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:e.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async i=>!(i.value==="Unknown"||i.value==="N/A")&&Zt(i)},homeVillage:{value:e.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:e.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),d=async i=>{var f,p,v,T,R;let r,m;try{(f=i==null?void 0:i.other)!=null&&f.traditional_authority_id&&(r=await Lt.getTraditionalAuthorityById(i.other.traditional_authority_id)),r&&(m=await Lt.getDistrictByID(r.district_id))}catch(k){ke("Unable to resolve patient address. Saving using default address"),console.error(k)}return{home_district:(p=m==null?void 0:m.name)!=null?p:"N/A",home_traditional_authority:(v=r==null?void 0:r.name)!=null?v:"N/A",home_village:(i==null?void 0:i.label)||"N/A",current_district:(T=m==null?void 0:m.name)!=null?T:"N/A",current_traditional_authority:(R=r==null?void 0:r.name)!=null?R:"N/A",current_village:(i==null?void 0:i.label)||"N/A"}};return{today:ee,patient:u,getLandmarks:ka,genderOptions:Fa,isBirthdateEstimated:a,modal:L,onFinish:async()=>ze(u,async i=>{const r={};if(i.givenName!==e.patientService.getGivenName()&&(r.given_name=i.givenName),i.familyName!==e.patientService.getFamilyName()&&(r.family_name=i.familyName),i.middleName!==e.patientService.getMiddleName()&&(r.middle_name=i.middleName),i.birthdate!==e.patientService.getBirthdate()&&(r.birthdate=i.birthdate),i.gender.value!==e.patientService.getGender()&&(r.gender=i.gender.value),i.cellPhoneNumber!==e.patientService.getPhoneNumber()&&(r.cell_phone_number=i.cellPhoneNumber),i.landmark.label!==e.patientService.getClosestLandmark()&&(r.landmark=i.landmark.label),i.homeVillage!==e.patientService.getCurrentVillage()&&Object.assign(r,{...r,...await d(i.homeVillage)}),!x(r)){const m=new Ot;m.setPersonID(e.patientService.getID()),await m.updatePerson(r)}i.nationalId!==l.value&&await e.patientService.updateMWNationalId(i.nationalId),await L.hide(),j.emit(W.RELOAD_PATIENT_DATA)}),getVillagesByName:Ea}}});function pi(e,a,l,u,d,b){const i=D("ion-title"),r=D("ion-icon"),m=D("ion-button"),f=D("ion-buttons"),p=D("ion-toolbar"),v=D("ion-header"),T=D("TextInput"),R=D("ion-col"),k=D("SelectInput"),w=D("DateInput"),g=D("ion-row"),I=D("ion-grid"),S=D("ion-content"),F=D("ion-footer");return _(),U(J,null,[t(v,null,{default:n(()=>[t(p,null,{default:n(()=>[t(i,null,{default:n(()=>[...a[12]||(a[12]=[$("Edit Patient Demographics",-1)])]),_:1}),t(f,{slot:"end"},{default:n(()=>[t(m,{onClick:a[0]||(a[0]=c=>e.modal.hide())},{default:n(()=>[t(r,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(S,{class:"ion-padding"},{default:n(()=>[t(I,null,{default:n(()=>[t(g,null,{default:n(()=>[t(R,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.givenName,"onUpdate:modelValue":a[1]||(a[1]=c=>e.patient.givenName=c)},null,8,["modelValue"])]),_:1}),t(R,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.middleName,"onUpdate:modelValue":a[2]||(a[2]=c=>e.patient.middleName=c)},null,8,["modelValue"])]),_:1}),t(R,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.familyName,"onUpdate:modelValue":a[3]||(a[3]=c=>e.patient.familyName=c)},null,8,["modelValue"])]),_:1}),t(R,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.nationalId,"onUpdate:modelValue":a[4]||(a[4]=c=>e.patient.nationalId=c)},null,8,["modelValue"])]),_:1}),t(R,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(k,{modelValue:e.patient.gender,"onUpdate:modelValue":a[5]||(a[5]=c=>e.patient.gender=c),options:e.genderOptions},null,8,["modelValue","options"])]),_:1}),t(R,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(w,{modelValue:e.patient.birthdate,"onUpdate:modelValue":a[6]||(a[6]=c=>e.patient.birthdate=c),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:e.today,onIsEstimated:a[7]||(a[7]=c=>e.isBirthdateEstimated=c)},null,8,["modelValue","maxDate"])]),_:1}),t(R,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(T,{modelValue:e.patient.cellPhoneNumber,"onUpdate:modelValue":a[8]||(a[8]=c=>e.patient.cellPhoneNumber=c),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(R,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(k,{modelValue:e.patient.homeVillage,"onUpdate:modelValue":a[9]||(a[9]=c=>e.patient.homeVillage=c),asyncOptions:e.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),t(R,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(k,{modelValue:e.patient.landmark,"onUpdate:modelValue":a[10]||(a[10]=c=>e.patient.landmark=c),asyncOptions:e.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),t(F,null,{default:n(()=>[t(p,null,{default:n(()=>[t(m,{color:"primary",onClick:a[11]||(a[11]=c=>e.modal.hide()),slot:"end"},{default:n(()=>[...a[13]||(a[13]=[$("Close",-1)])]),_:1}),t(m,{class:"ion-margin-end",color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[...a[14]||(a[14]=[$("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const bi=re(vi,[["render",pi]]),gi=Z({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(e){var k,w;const a=new Ot,l=e,u=q(x(l.guardians)),d=M(()=>"".concat(u.value?"Add":"Edit"," Guardian Demographics")),b=M(()=>"".concat(u.value?"Edit":"Add"," Guardian")),i=q([]),r=(w=(k=l.guardians)==null?void 0:k.map(g=>({label:"".concat(g.name," (").concat(g.relationshipType,")"),value:g.name,other:g})))!=null?w:[],m=le({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),f=le({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:g=>nt(g)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:g=>nt(g)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async g=>g.value!=="Unknown"&&Zt(g)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});ye(()=>m.guardian.value,g=>{var I,S,F,c,h,V,B,H;f.givenName.value=(S=(I=g==null?void 0:g.other)==null?void 0:I.names.given_name)!=null?S:"",f.familyName.value=(c=(F=g==null?void 0:g.other)==null?void 0:F.names.family_name)!=null?c:"",f.cellPhoneNumber.value=(V=(h=g==null?void 0:g.other)==null?void 0:h.phoneNumber)!=null?V:"",f.relation.value=(H=(B=g==null?void 0:g.other)==null?void 0:B.relationshipType)!=null?H:""},{deep:!0,immediate:!0});function p(){u.value=!u.value,m.guardian.value=""}async function v(g){var I,S;await a.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:l.patientId,...g}),await Tt.createRelation(l.patientId,a.getPersonID(),(S=(I=g.relation)==null?void 0:I.value)!=null?S:13)}async function T(g,I){var c,h;const S=I.names.person_id,F={};if(I.names.given_name!==g.given_name&&(F.given_name=g.given_name),I.names.family_name!==g.family_name&&(F.family_name=g.family_name),I.phoneNumber!==g.cell_phone_number&&(F.cell_phone_number=g.cell_phone_number),!x(F)){const V=new Ot;V.setPersonID(S),await V.updatePerson(F)}I.relationshipType!==g.relation.label&&await Tt.amendRelation(l.patientId,S,I.id,(h=(c=g.relation)==null?void 0:c.value)!=null?h:13)}const R=async()=>ze(f,async g=>{!u.value&&!x(m.guardian.value)?await T(g,m.guardian.value.other):await v(g),await L.hide(),j.emit(W.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return _e(async()=>{const g=(await Tt.getRelations()).data;i.value=g.map(I=>({label:I.b_is_to_a,value:I.relationship_type_id,other:I}))}),(g,I)=>{const S=D("ion-title"),F=D("ion-icon"),c=D("ion-button"),h=D("ion-buttons"),V=D("ion-toolbar"),B=D("ion-header"),H=D("ion-content"),Y=D("ion-footer");return _(),U(J,null,[t(B,null,{default:n(()=>[t(V,null,{default:n(()=>[t(S,null,{default:n(()=>[$(Q(d.value),1)]),_:1}),t(h,{slot:"end"},{default:n(()=>[t(c,{onClick:I[0]||(I[0]=y=>o(L).hide())},{default:n(()=>[t(F,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(H,{class:"ion-padding"},{default:n(()=>[t(o(ce),null,{default:n(()=>[t(o(ae),null,{default:n(()=>[u.value?G("",!0):(_(),E(o(O),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(ge,{modelValue:m.guardian,"onUpdate:modelValue":I[1]||(I[1]=y=>m.guardian=y),options:o(r)},null,8,["modelValue","options"])]),_:1})),m.guardian.value||u.value?(_(),U(J,{key:1},[t(o(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Oe,{modelValue:f.givenName,"onUpdate:modelValue":I[2]||(I[2]=y=>f.givenName=y)},null,8,["modelValue"])]),_:1}),t(o(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Oe,{modelValue:f.familyName,"onUpdate:modelValue":I[3]||(I[3]=y=>f.familyName=y)},null,8,["modelValue"])]),_:1}),t(o(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(Oe,{modelValue:f.cellPhoneNumber,"onUpdate:modelValue":I[4]||(I[4]=y=>f.cellPhoneNumber=y),allowUnknown:""},null,8,["modelValue"])]),_:1}),t(o(O),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[t(ge,{modelValue:f.relation,"onUpdate:modelValue":I[5]||(I[5]=y=>f.relation=y),options:i.value},null,8,["modelValue","options"])]),_:1})],64)):G("",!0)]),_:1})]),_:1})]),_:1}),t(Y,null,{default:n(()=>[t(V,null,{default:n(()=>[o(x)(l.guardians)?G("",!0):(_(),E(c,{key:0,color:"primary",onClick:p,slot:"start"},{default:n(()=>[$(Q(b.value),1)]),_:1})),t(c,{color:"primary",onClick:I[6]||(I[6]=y=>o(L).hide()),slot:"end"},{default:n(()=>[...I[7]||(I[7]=[$("Close",-1)])]),_:1}),t(c,{class:"ion-margin-end",color:"success",onClick:R,slot:"end"},{default:n(()=>[...I[8]||(I[8]=[$("Save",-1)])]),_:1})]),_:1})]),_:1})],64)}}}),yi=Z({components:{IonGrid:ce,IonRow:ae,IonCol:O,TextInput:Oe},props:{patient:{type:Object,required:!0}},setup(e){const{facility:a}=kt(),l=M(()=>e.patient.getArvNumber()),u=M(()=>!x(l.value)&&l.value!=="Unknown"),d=le({arvNumber:{value:u.value?l.value.split("-")[2]:"",label:"".concat(u.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async r=>{const m=he(r,"POSITIVE_INTEGERS");if(m!==null)return m;if(r.value===l.value.split("-")[2])return null;const f=await at.findByOtherID(4,"".concat(a.code,"-ARV-").concat(r.value));return f.ok?x(f.data)?null:["ARV Number already taken"]:[f.errorMessage||f.clientErrorType||"Unable to determine ARV number with status: ".concat(f.httpStatusResponse)]}}});return{form:d,modal:L,arvNumber:l,facility:a,hasValidARVNumber:u,onFinish:async()=>ze(d,async r=>{r.arvNumber!==l.value.split("-")[2]&&(u.value?await e.patient.updateARVNumber("".concat(a.code,"-ARV-").concat(r.arvNumber)):await e.patient.createArvNumber("".concat(a.code,"-ARV-").concat(r.arvNumber)),j.emit(W.RELOAD_PATIENT_DATA)),await L.hide()}),voidARV:async()=>{if(await De("Are you sure you want to void this ARV Number ".concat(l.value,"?"))){await se.show("Voiding ARV Number...");try{await Re.postJson("/programs/".concat(Da,"/void_arv_number/").concat(l),{}),await se.hide(),await L.hide(),j.emit(W.RELOAD_PATIENT_DATA)}catch(m){await se.hide(),console.log(m)}}}}}});function hi(e,a,l,u,d,b){const i=D("ion-title"),r=D("ion-icon"),m=D("ion-button"),f=D("ion-buttons"),p=D("ion-toolbar"),v=D("ion-header"),T=D("text-input"),R=D("ion-col"),k=D("ion-row"),w=D("ion-grid"),g=D("ion-content"),I=D("ion-footer");return _(),U(J,null,[t(v,null,{default:n(()=>[t(p,null,{default:n(()=>[t(i,null,{default:n(()=>[...a[3]||(a[3]=[$("ARV NUMBER",-1)])]),_:1}),t(f,{slot:"end"},{default:n(()=>[t(m,{onClick:a[0]||(a[0]=S=>e.modal.hide())},{default:n(()=>[t(r,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),t(g,{class:"ion-padding"},{default:n(()=>[t(w,null,{default:n(()=>[t(k,null,{default:n(()=>[t(R,null,{default:n(()=>[t(T,{modelValue:e.form.arvNumber,"onUpdate:modelValue":a[1]||(a[1]=S=>e.form.arvNumber=S),form:e.form,prefix:"".concat(e.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),t(I,{class:"ion-padding-horizontal"},{default:n(()=>[t(p,null,{default:n(()=>[t(m,{color:"primary",onClick:a[2]||(a[2]=S=>e.modal.hide()),slot:"end"},{default:n(()=>[...a[4]||(a[4]=[$("Close",-1)])]),_:1}),e.hasValidARVNumber?(_(),E(m,{key:0,color:"danger",onClick:e.voidARV,slot:"start"},{default:n(()=>[...a[5]||(a[5]=[$("Void ARV Number",-1)])]),_:1},8,["onClick"])):G("",!0),t(m,{color:"success",onClick:e.onFinish,slot:"end"},{default:n(()=>[...a[6]||(a[6]=[$("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const _i=re(yi,[["render",hi]]),wi=Z({components:{VisitsSummary:ii,InformationHeader:fi},setup(){const e=Ia(),a=parseInt(e.params.patientId.toString())||0,l=q(),u=q(""),d=q([]),b=M(()=>!x(l.value)),i=M(()=>{var k;return(k=l.value)==null?void 0:k.getNationalID()}),r=async()=>{if(a){const k=(await at.findByID(a)).data;k&&(l.value=new at(k))}},m=async()=>{d.value=await xa.getGuardianDetails(a)},f=async k=>{await L.show(bi,{patientService:l.value,attribute:k})},p=async()=>{await L.show(gi,{patientId:a,guardians:d.value})},v=async()=>{await L.show(_i,{patient:l.value})},T=async()=>{var w;await se.show("Client has Invalid NPID. Assigning NPID...");const k=await at.assignNPID(a);k.ok?(await r(),await se.hide()):(await se.hide(),ke((w=k.errorMessage)!=null?w:"Failed to assign NPID"))},R=async()=>{var w;let k=!1;if(Ua.value)k=!((w=l.value)==null?void 0:w.getDocID())||Ma(i.value)||await Ga(a);else{const g=await La(i.value);k=!g||g.length>1}k&&await T()};return j.on(W.RELOAD_PATIENT_DATA,async()=>{await r()}),j.on(W.RELOAD_GUARDIAN_DATA,async()=>{await m()}),_e(async()=>{var w;await Ha(),await r(),await R();const k=await((w=l.value)==null?void 0:w.getARTStartDate());u.value=k?me(k):"N/A",m()}),{patient:l,artStartDate:u,guardians:d,isReady:b,updateDemographics:f,updateGuardian:p,updateARVNumber:v}}});function Vi(e,a,l,u,d,b){const i=D("information-header"),r=D("ion-col"),m=D("ion-row"),f=D("visits-summary"),p=D("ion-grid");return e.isReady?(_(),E(p,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[t(m,null,{default:n(()=>[t(r,{size:"12"},{default:n(()=>[e.patient?(_(),E(i,{key:0,patient:e.patient,guardians:e.guardians,artStartDate:e.artStartDate,onUpdateARVNumber:e.updateARVNumber,onUpdateGuardian:e.updateGuardian,onUpdatePatient:e.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):G("",!0)]),_:1})]),_:1}),t(m,null,{default:n(()=>[t(r,null,{default:n(()=>[e.patient?(_(),E(f,{key:0,patient:e.patient,startDate:e.artStartDate},null,8,["patient","startDate"])):G("",!0)]),_:1})]),_:1})]),_:1})):G("",!0)}const Ki=re(wi,[["render",Vi]]);export{Ki as default};
