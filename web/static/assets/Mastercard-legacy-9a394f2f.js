!function(){function e(e,t,a){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var l=a.call(e,t||"default");if("object"!=typeof l)return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}System.register(["./index-legacy-5f56363a.js","./patient_service-legacy-d1a085bd.js","./common-legacy-e8d6ba88.js","./consultation_service-legacy-e593fd20.js","./VoidReason-legacy-22fe6289.js","./his_date-legacy-5770feb0.js","./DateInput.vue_vue_type_style_index_0_lang-legacy-52e37539.js","./SelectInput-legacy-9319cd99.js","./regimen_service-legacy-3bf4967a.js","./encounter_types-legacy-4fed5cb0.js","./arrays-legacy-86abe4a8.js","./form-legacy-2a6d2fbd.js","./emc_event-legacy-0252f26c.js","./toasts-legacy-60ae7d37.js","./Date-legacy-081ad6ef.js","./index-legacy-d42c7d8b.js","./loader-legacy-a13fba1a.js","./validations-legacy-3f76bec5.js","./TextInput-legacy-cbe0c3c2.js","./location_options-legacy-df0f4f23.js","./DTFormElements-legacy-6f485257.js","./YesNoInput-legacy-398344f2.js","./DrilldownTable-legacy-fb804e4c.js","./Strs-legacy-b5721578.js","./relations_service-legacy-4af203b2.js","./dde-legacy-4e0ed00d.js","./patient_identifier_service-legacy-b3ceff90.js","./vue-datepicker-legacy-30c26adf.js"],function(t,a){"use strict";var l,n,i,o,r,u,d,s,c,m,v,p,f,b,g,h,y,_,w,D,V,I,N,R,A,T,S,P,O,x,C,k,E,B,F,q,G,U,H,z,L,M,j,$,W,Y,X,J,Q,K,Z,ee,te,ae,le,ne,ie,oe,re,ue,de,se,ce,me,ve,pe,fe,be,ge,he,ye,_e,we,De,Ve,Ie,Ne,Re,Ae,Te,Se,Pe,Oe,xe,Ce,ke,Ee,Be,Fe,qe,Ge,Ue,He,ze,Le,Me,je,$e,We,Ye,Xe,Je,Qe,Ke,Ze,et,tt,at,lt,nt,it,ot,rt,ut,dt,st,ct,mt,vt,pt,ft,bt,gt,ht,yt,_t,wt;return{setters:[e=>{l=e.L,n=e.l,i=e.d,o=e.r,r=e.ak,u=e.a9,d=e.j,s=e.c,c=e.e,m=e.w,v=e.u,p=e.N,f=e.o,b=e.x,g=e.a3,h=e.b,y=e.V,_=e.m,w=e.n,D=e.p,V=e.M,I=e.y,N=e.aB,R=e.H,A=e.I,T=e.am,S=e.v,P=e.aq,O=e.i,x=e._,C=e.O,k=e.a,E=e.k,B=e.B,F=e.X,q=e.Q,G=e.t,U=e.Z,H=e.aF,z=e.aG,L=e.aH,M=e.aI,j=e.aJ,$=e.ao,W=e.aA,Y=e.z,X=e.a1,J=e.aK,Q=e.aL,K=e.aM,Z=e.W,ee=e.aN,te=e.aO,ae=e.aP,le=e.a8,ne=e.aQ,ie=e.q,oe=e.a7,re=e.aR,ue=e.aS,de=e.aT,se=e.aD,ce=e.ar,me=e.aU},e=>{ve=e.g,pe=e.D,fe=e.C,be=e.P,ge=e.O},e=>{he=e.g,ye=e.i},e=>{_e=e.A,we=e.u,De=e.V,Ve=e.C,Ie=e.E},e=>{Ne=e.p},e=>{Re=e.a,Ae=e.t,Te=e.d,Se=e.e,Pe=e.f},e=>{Oe=e._},e=>{xe=e.S},e=>{Ce=e.N,ke=e.R},e=>{Ee=e.e},e=>{Be=e.s,Fe=e.a,qe=e.u,Ge=e.c},e=>{Ue=e.s,He=e.i,ze=e.r,Le=e.a},e=>{Me=e.E,je=e.a},e=>{$e=e.a,We=e.t},e=>{Ye=e.D},e=>{Xe=e.D},e=>{Je=e.l},e=>{Qe=e.d,Ke=e.r,Ze=e.v,et=e.e,tt=e.f,at=e.g,lt=e.a,nt=e.b,it=e.c},e=>{ot=e.T},e=>{rt=e.g,ut=e.a,dt=e.b},e=>{st=e.t,ct=e.g},e=>{mt=e.Y},e=>{vt=e.D},e=>{pt=e.t,ft=e.i},e=>{bt=e.P,gt=e.R},e=>{ht=e.r,yt=e.d,_t=e.h,wt=e.a},null,null],execute:function(){var a=document.createElement("style");a.textContent=".step-container[data-v-fc159c8d]{display:flex;flex-direction:column;height:100%}.step-container h2[data-v-fc159c8d]{margin-bottom:1rem;font-size:1.2rem;color:var(--ion-color-primary)}.step-navigation[data-v-fc159c8d]{display:flex;justify-content:flex-end;gap:1rem;margin-top:auto;padding-top:1rem}.section-title[data-v-153ee5f1]{margin-top:1rem;font-size:1rem;color:var(--ion-color-medium);border-bottom:1px solid var(--ion-color-light);padding-bottom:.5rem}ion-input[data-v-153ee5f1],ion-select[data-v-153ee5f1],ion-textarea[data-v-153ee5f1],ion-datetime[data-v-153ee5f1]{width:100%!important}.box-input[data-v-153ee5f1],.box-input-error[data-v-153ee5f1]{width:100%!important}.section-title[data-v-1d2ba071]{margin-top:1rem;font-size:1rem;color:var(--ion-color-medium);border-bottom:1px solid var(--ion-color-light);padding-bottom:.5rem}ion-input[data-v-1d2ba071],ion-select[data-v-1d2ba071],ion-textarea[data-v-1d2ba071],ion-datetime[data-v-1d2ba071]{width:100%!important}.box-input[data-v-1d2ba071],.box-input-error[data-v-1d2ba071]{width:100%!important}.section-title[data-v-27c751fc]{margin-top:1rem;font-size:1rem;color:var(--ion-color-medium);border-bottom:1px solid var(--ion-color-light);padding-bottom:.5rem}.section-description[data-v-27c751fc]{font-size:.9rem;color:var(--ion-color-medium-shade);margin-top:0;margin-bottom:.5rem}ion-input[data-v-27c751fc],ion-select[data-v-27c751fc],ion-textarea[data-v-27c751fc],ion-datetime[data-v-27c751fc]{width:100%!important}.box-input[data-v-27c751fc],.box-input-error[data-v-27c751fc]{width:100%!important}.section-title[data-v-db361dbb]{margin-top:1rem;font-size:1rem;color:var(--ion-color-medium);border-bottom:1px solid var(--ion-color-light);padding-bottom:.5rem}.left-column[data-v-db361dbb]{padding-right:1rem}.right-column[data-v-db361dbb]{padding-left:1rem}.calendar-section[data-v-db361dbb]{height:100%}.date-picker-container[data-v-db361dbb]{margin-top:1rem}.info-section[data-v-db361dbb]{margin-bottom:2rem}.info-box[data-v-db361dbb]{background-color:var(--ion-color-light);border-radius:8px;padding:1rem;margin-top:1rem}.drug-runout-info[data-v-db361dbb]{display:flex;align-items:center;gap:1rem}.info-icon[data-v-db361dbb]{font-size:2rem;color:var(--ion-color-primary);min-width:2rem}.info-content .date[data-v-db361dbb]{font-size:1.2rem;font-weight:700;color:var(--ion-color-primary);margin-bottom:.25rem}.info-content .note[data-v-db361dbb]{font-size:.9rem;color:var(--ion-color-medium);margin:0}.recommendation[data-v-db361dbb]{display:flex;align-items:flex-start;gap:.5rem;margin-top:1rem;padding:.75rem;background-color:var(--ion-color-warning-tint);border-left:4px solid var(--ion-color-warning);border-radius:4px}.recommendation ion-icon[data-v-db361dbb]{color:var(--ion-color-warning);font-size:1.2rem;margin-top:.1rem}.recommendation p[data-v-db361dbb]{margin:0;font-size:.9rem;color:var(--ion-color-dark)}.summary-section[data-v-db361dbb]{background-color:var(--ion-color-light);border-radius:8px;padding:1rem}.summary-content[data-v-db361dbb]{margin-top:1rem}.summary-item[data-v-db361dbb]{display:flex;margin-bottom:.5rem;padding:.25rem 0}.summary-item .label[data-v-db361dbb]{font-weight:500;width:45%;color:var(--ion-color-medium)}.summary-item .value[data-v-db361dbb]{width:55%;color:var(--ion-color-dark)}@media (max-width: 768px){.left-column[data-v-db361dbb],.right-column[data-v-db361dbb]{padding-left:0;padding-right:0}.left-column[data-v-db361dbb]{margin-bottom:2rem}}ion-input[data-v-db361dbb],ion-select[data-v-db361dbb],ion-textarea[data-v-db361dbb],ion-datetime[data-v-db361dbb]{width:100%!important}.box-input[data-v-db361dbb],.box-input-error[data-v-db361dbb]{width:100%!important;border-radius:4px}ion-datetime[data-v-db361dbb]{--background: transparent;--color: var(--ion-color-dark);padding:8px}ion-datetime.box-input[data-v-db361dbb]{border:1px solid #a3a3a3}ion-datetime.box-input-error[data-v-db361dbb]{border:1px solid #ff0000}ion-label.bold[data-v-db361dbb]{font-weight:500;color:var(--ion-color-dark)}.text-danger[data-v-db361dbb]{color:var(--ion-color-danger)}.visit-container[data-v-94ed98d5]{display:flex;height:100%}.side-navigation[data-v-94ed98d5]{width:220px;border-right:1px solid var(--ion-color-light);padding:1rem 0;overflow-y:auto;display:flex;flex-direction:column;gap:1rem}.main-content[data-v-94ed98d5]{flex:1;padding:0 1rem;overflow-y:auto}.nav-item[data-v-94ed98d5]{display:flex;align-items:center;gap:.5rem;padding:.75rem;cursor:pointer;border-left:4px solid transparent;opacity:.6;transition:all .2s ease-in-out}.nav-item.active[data-v-94ed98d5]{border-left-color:var(--ion-color-primary);background-color:rgba(var(--ion-color-primary-rgb),.1);opacity:1}.nav-item.completed[data-v-94ed98d5]{opacity:.8;border-left-color:var(--ion-color-success)}.nav-number[data-v-94ed98d5]{width:28px;height:28px;border-radius:50%;background-color:var(--ion-color-medium);color:#fff;display:flex;justify-content:center;align-items:center;font-weight:700}.active .nav-number[data-v-94ed98d5]{background-color:var(--ion-color-primary)}.completed .nav-number[data-v-94ed98d5]{background-color:var(--ion-color-success)}.nav-label[data-v-94ed98d5]{font-size:.9rem;white-space:nowrap}ion-progress-bar[data-v-94ed98d5]{--buffer-background: var(--ion-color-light);--progress-background: var(--ion-color-primary)}@media (max-width: 768px){.visit-container[data-v-94ed98d5]{flex-direction:column}.side-navigation[data-v-94ed98d5]{width:100%;border-right:none;border-bottom:1px solid var(--ion-color-light);padding:.5rem 0;flex-direction:row;overflow-x:auto}.nav-item[data-v-94ed98d5]{flex-direction:column;text-align:center;min-width:80px;border-left:none;border-bottom:4px solid transparent}.nav-item.active[data-v-94ed98d5]{border-left-color:transparent;border-bottom-color:var(--ion-color-primary)}.nav-item.completed[data-v-94ed98d5]{border-left-color:transparent;border-bottom-color:var(--ion-color-success)}}.title[data-v-7bb05fd5]{font-weight:700}ion-list[data-v-6b436603]{height:100%}\n",document.head.appendChild(a);const Dt=e=>{const t=e.given_name,a=e.family_name;return`${t} ${e.middle_name?e.middle_name:""} ${a}`};class Vt{static getRelationships(e){return l.getJson(`/people/${e}/relationships`).then(e=>e.data)}static async getGuardianDetails(e){return await this.getRelationships(e).then(e=>e.map(e=>{const t=he(e,"relation.names[0]");return{id:e.relationship_id,name:t?Dt(t):"",relationshipType:he(e,"type.b_is_to_a",""),phoneNumber:ve(he(e,"relation.person_attributes",[]),12),names:t}}))}}class It extends _e{constructor(e){super(e,Ee.LAB_ORDERS,Re())}async loadConcepts(){It.conceptID=await _e.getConceptID("HIV Viral Load")}createLabOrder(e,t){const a=l.getUsername(),i=n().facility.name,o=_e.getCachedConceptID(t,!0);return l.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:a,target_lab:i,reason_for_test_id:o,encounter_id:this.encounterID,tests:[{concept_id:It.conceptID}],date:this.date,specimen:{concept_id:e}}]})}createLabResult(e,t,a,n="numeric"){return l.postJson(`lab/tests/${e}/results`,{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:It.conceptID},value:t,value_modifier:a,value_type:n}]})}static getSpecimens(e){return l.getJson("/lab/specimen_types",{test_type:e})}static async getOrders(e,t={}){var a;return null!==(a=(await l.getJson("/lab/orders",{patient_id:e,...t})).data)&&void 0!==a?a:[]}static async getViralLoadResultTrail(e,t={}){return(await this.getOrders(e,t)).reduce((e,t)=>(t.tests.forEach(a=>a.result.forEach(l=>e.push({...t,test:a.name,result:`${l.value_modifier} ${l.value}`,result_date:l.date}))),e),[])}static async getlatestViralLoadResult(e,t={}){const a=(await this.getOrders(e,t)).flatMap(e=>e.tests.flatMap(e=>e.result)).filter(Boolean);if(ye(a))return"N/A";const l=Be(a,"date","desc")[0];return`${l.value_modifier}${l.value} (${Ae(l.date)})`}}e(It,"conceptID",-1);const Nt=i({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(e){const t=e,a=o(!1),l=Fe(["=",">","<",">=","<="]),n=Fe(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),i=o([]),O=t.patient.getBirthdate(),x=r({orderDate:{value:"",label:"Order Date",required:!0,validation:async e=>Te(e.value).isValid()?new Date(e.value)>new Date(Re())?["Order date cannot be in the future"]:new Date(e.value)<new Date(O)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(e,t)=>Te(e.value).isValid()?new Date(e.value)>new Date(Re())?["Result date cannot be in the future"]:new Date(e.value)<new Date(t.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function C(){Ue(x,async e=>{const l=new It(t.patient.getID());await l.loadConcepts(),l.setDate(e.orderDate);if(!(await l.createEncounter()))throw new Error("Unable to create lab order encounter");const n=await l.createLabOrder(e.specimen.value,e.reason.value);if(!n.ok||!n.data)throw new Error("Unable to save lab orders");const i=new It(t.patient.getID());i.setDate(e.resultDate);if(!(await i.createEncounter()))throw new Error("Unable to create lab result encounter");const o=a.value?"LDL":parseInt(e.result),r=a.value?"=":e.modifier.value,u=a.value?"text":"numeric",d=n.data[0].tests[0].id;await i.createLabResult(d,o,r,u),await T.hide(),Me.emit(je.RELOAD_LATEST_VL_RESULT),Me.emit(je.RELOAD_PATIENT_VISIT_DATA)})}async function k(){if(await P("Are you sure you want to clear all fields?")){a.value=!1;for(const e in x)x[e].value="",x[e].error="";Me.emit(je.ON_CLEAR)}}return u(a,e=>{e&&(x.modifier.value="",x.result.value=void 0,x.modifier.error="",x.result.error=""),x.modifier.disabled=e,x.modifier.required=!e,x.result.disabled=e,x.result.required=!e}),d(async()=>{i.value=(await It.getSpecimens("HIV viral load")).data.map(e=>({label:e.name,value:e.concept_id}))}),(e,t)=>(f(),s(p,null,[c(v(y),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(g),null,{default:m(()=>[...t[8]||(t[8]=[h("Viral Load Results",-1)])]),_:1})]),_:1})]),_:1}),c(v(R),{class:"ion-padding"},{default:m(()=>[c(v(_),{style:{width:"100%"}},{default:m(()=>[c(v(w),null,{default:m(()=>[c(v(D),{size:"12",class:"ion-margin-vertical"},{default:m(()=>[c(Oe,{modelValue:x.orderDate,"onUpdate:modelValue":t[0]||(t[0]=e=>x.orderDate=e),form:x,minDate:v(O),maxDate:v(Re)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(xe,{modelValue:x.reason,"onUpdate:modelValue":t[1]||(t[1]=e=>x.reason=e),options:v(n)},null,8,["modelValue","options"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(xe,{modelValue:x.specimen,"onUpdate:modelValue":t[2]||(t[2]=e=>x.specimen=e),options:i.value},null,8,["modelValue","options"])]),_:1}),c(v(D),{size:"12",class:"ion-margin-vertical"},{default:m(()=>[c(Oe,{modelValue:x.resultDate,"onUpdate:modelValue":t[3]||(t[3]=e=>x.resultDate=e),form:x,minDate:x.orderDate.value,"max-date":v(Re)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(xe,{modelValue:x.modifier,"onUpdate:modelValue":t[4]||(t[4]=e=>x.modifier=e),options:v(l)},null,8,["modelValue","options"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(Ce,{modelValue:x.result,"onUpdate:modelValue":t[5]||(t[5]=e=>x.result=e),form:x,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),c(v(w),{class:"ion-margin-top"},{default:m(()=>[c(v(D),{size:"12"},{default:m(()=>[c(v(V),{class:"ion-padding-vertical bold"},{default:m(()=>[...t[9]||(t[9]=[h(" Other Results Options: ",-1)])]),_:1}),c(v(I),null,{default:m(()=>[c(v(V),null,{default:m(()=>[...t[10]||(t[10]=[h("LDL",-1)])]),_:1}),c(v(N),{slot:"start",modelValue:a.value,"onUpdate:modelValue":t[6]||(t[6]=e=>a.value=e)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),c(v(S),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(A),{color:"primary",onClick:t[7]||(t[7]=e=>v(T).hide()),slot:"end"},{default:m(()=>[...t[11]||(t[11]=[h(" Close ",-1)])]),_:1}),c(v(A),{color:"warning",onClick:k,slot:"end"},{default:m(()=>[...t[12]||(t[12]=[h(" Reset ",-1)])]),_:1}),c(v(A),{color:"success",onClick:C,slot:"end"},{default:m(()=>[...t[13]||(t[13]=[h(" Save ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),Rt=i({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:Xe},emits:["voidOutcome"],setup(e,{emit:t}){const a=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:e=>Te(e).format(Ye)},{path:"end_date",label:"End Date",formatter:e=>Te(e).format(Ye)}];return{rows:O(()=>e.patientStates.map((e,t)=>({...e,index:t}))),columns:a,tableConfig:{showSearchField:!1,showSubmitButton:!1},TableRowActions:[{label:"void",color:"danger",action:async e=>{await P("Are you sure you want to void this outcome?")&&t("voidOutcome",{stateId:e.patient_state_id,index:e.index})}}]}}});const At=x(Rt,[["render",function(e,t,a,l,n,i){const o=C("data-table");return f(),s(p,null,[t[0]||(t[0]=k("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1)),c(o,{rows:e.rows,columns:e.columns,config:e.tableConfig,"row-actions-buttons":e.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}]]),Tt=i({name:"EnrollmentForm",components:{DateInput:Oe,IonGrid:_,IonRow:w,IonCol:D,IonButton:A},props:["birthdate","patientId"],setup(e){const t=r({programId:{label:"Select program",required:!0,value:""},date:{value:"",label:"Date of Enrollment",required:!0,validation:async t=>Qe(t,e.birthdate)}}),{enrollPatient:a,fetchPatientPrograms:l}=we(e.patientId);return{form:t,today:Re,onReset:async()=>{await P("Are you sure you want to clear all fields")&&(t.date.value="",t.date.error="",Me.emit(je.ON_CLEAR))},enrollProgram:async function(){await He(t)&&Je.show(),await a(t.date.value),await $e("Program enrolled successfully"),await T.hide(),l().catch(console.error)}}}});const St=x(Tt,[["render",function(e,t,a,l,n,i){const o=C("DateInput"),r=C("ion-col"),u=C("ion-button"),d=C("ion-row"),s=C("ion-grid");return f(),E(s,null,{default:m(()=>[c(d,null,{default:m(()=>[c(r,{size:"12"},{default:m(()=>[c(o,{modelValue:e.form.date,"onUpdate:modelValue":t[0]||(t[0]=t=>e.form.date=t),form:e.form,minDate:e.birthdate,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),c(r,null,{default:m(()=>[c(u,{color:"warning",onClick:e.onReset},{default:m(()=>[...t[1]||(t[1]=[h("Reset",-1)])]),_:1},8,["onClick"]),c(u,{color:"success",onClick:e.enrollProgram},{default:m(()=>[...t[2]||(t[2]=[h("Enroll",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}]]),Pt=i({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:Oe,IonGrid:_,IonRow:w,IonCol:D,IonButton:A,SelectInput:xe,TextInput:ot},emits:["saveOutcome"],setup(e,{emit:t}){const a=Te().format("YYYY-MM-DD"),l=r({date:{value:"",label:"Outcome Date",required:!0,validation:async t=>new Date(t.value)<new Date(e.birthdate)?[`Outcome date cannot be before date of birth - ${Te(e.birthdate).format(Ye)}`]:new Date(t.value)<new Date(e.dateEnrolled)?[`Outcome date cannot be before enrollment date- ${Te(e.dateEnrolled).format(Ye)}`]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(e,t)=>"Patient transferred out"===t.status.value.label&&Ke(e)},reason:{value:"",label:"Reason for transfer out",validation:async(e,t)=>"Patient transferred out"===t.status.value.label&&Ke(e)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(e,t)=>{var a,l;return"Patient transferred out"===(null===(a=t.status)||void 0===a||null===(a=a.value)||void 0===a?void 0:a.label)&&"Other"===(null===(l=t.reason)||void 0===l||null===(l=l.value)||void 0===l?void 0:l.label)&&Ke(e)}}}),n=O(()=>{var e;return"Patient transferred out"===(null===(e=l.status.value)||void 0===e?void 0:e.label)}),i=O(()=>{var e;return"Other"===(null===(e=l.reason)||void 0===e||null===(e=e.value)||void 0===e?void 0:e.label)});return{form:l,today:a,isTransferredOut:n,specifyOther:i,onSave:()=>Ue(l,e=>t("saveOutcome",{...e,isTransferredOut:n.value})),onReset:async()=>{if(await P("are you sure you want to clear all fields")){for(const e in l)l[e].value="",l[e].error="";Me.emit(je.ON_CLEAR)}},getFacilities:rt,transferOutReasons:st}}});const Ot=x(Pt,[["render",function(e,t,a,l,n,i){const o=C("ion-col"),r=C("DateInput"),u=C("SelectInput"),d=C("text-input"),v=C("ion-button"),b=C("ion-row"),g=C("ion-grid");return f(),E(g,null,{default:m(()=>[c(b,null,{default:m(()=>[c(o,{size:"12"},{default:m(()=>[...t[5]||(t[5]=[k("p",null,"Add New Outcome",-1)])]),_:1}),c(o,{size:"6",class:"ion-margin-top-vertical"},{default:m(()=>[c(r,{modelValue:e.form.date,"onUpdate:modelValue":t[0]||(t[0]=t=>e.form.date=t),form:e.form,minDate:e.dateEnrolled,"max-date":e.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),c(o,{size:"6",class:"ion-margin-top-vertical"},{default:m(()=>[c(u,{modelValue:e.form.status,"onUpdate:modelValue":t[1]||(t[1]=t=>e.form.status=t),form:e.form,options:e.outcomes},null,8,["modelValue","form","options"])]),_:1}),e.isTransferredOut?(f(),s(p,{key:0},[c(o,{size:"6",class:"ion-margin-top-vertical"},{default:m(()=>[c(u,{modelValue:e.form.nextFacility,"onUpdate:modelValue":t[2]||(t[2]=t=>e.form.nextFacility=t),form:e.form,asyncOptions:e.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),c(o,{size:"6",class:"ion-margin-top-vertical"},{default:m(()=>[c(u,{modelValue:e.form.reason,"onUpdate:modelValue":t[3]||(t[3]=t=>e.form.reason=t),form:e.form,options:e.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),e.specifyOther?(f(),E(o,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:m(()=>[c(d,{modelValue:e.form.otherReason,"onUpdate:modelValue":t[4]||(t[4]=t=>e.form.otherReason=t),form:e.form},null,8,["modelValue","form"])]),_:1})):B("",!0)],64)):B("",!0),c(o,{size:"12",class:"ion-margin-top"},{default:m(()=>[c(v,{color:"warning",onClick:e.onReset},{default:m(()=>[...t[6]||(t[6]=[h("Reset",-1)])]),_:1},8,["onClick"]),c(v,{color:"success",onClick:e.onSave},{default:m(()=>[...t[7]||(t[7]=[h("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}]]),xt={class:"ion-page",id:"main"},Ct={class:"ion-margin-start"},kt=i({__name:"OutcomeStatus",props:{patient:{type:Object,required:!0}},setup(e){const t=e,a=o(),l=O(()=>t.patient.getID()),n=O(()=>{var e;return null===(e=a.value)||void 0===e||null===(e=e.other)||void 0===e?void 0:e.date_enrolled}),i=O(()=>Se(t.patient.getBirthdate())),r=O(()=>{var e;return P.value.get(null===(e=a.value)||void 0===e?void 0:e.value)}),u=O(()=>{var e,t;return null!==(e=null===(t=a.value)||void 0===t||null===(t=t.other)||void 0===t||null===(t=t.patient_states)||void 0===t?void 0:t.length)&&void 0!==e?e:0}),{patientPrograms:N,programStates:P,hasArtProgram:x,updateState:M,voidProgram:j,voidState:$,fetchPatientPrograms:W}=we(l.value);async function Y(e){var t;const{date:n,status:i,nextFacility:o,reason:r,otherReason:u,isTransferredOut:d}=e;if(d){const e="Other"!==r.value?r.value:u;await async function(e,t,a=""){const n=new _e(l.value,Ee.EXIT_FROM_HIV_CARE,t);if(!(await n.createEncounter()))throw"Unable to transfer out encounter";return a&&await n.saveValueTextObs("Reason for transfer out",a),n.saveValueTextObs("Transfer to",e.name)}(o.other,n,e)}await M(i.value,n,null===(t=a.value)||void 0===t?void 0:t.value),await $e("Outcome saved successfully",1e3),await T.hide(),Me.emit(je.RELOAD_PATIENT_VISIT_DATA)}async function X(){var e,t;await j(null!==(e=null===(t=a.value)||void 0===t||null===(t=t.other)||void 0===t?void 0:t.patient_program_id)&&void 0!==e?e:-1,"duplicate / system error"),await $e("Patient voided from program successfully",1e3),await T.hide(),Me.emit(je.RELOAD_PATIENT_VISIT_DATA)}async function J({stateId:e,index:t}){var l,n;await $(e,"duplicate / system error",null===(l=a.value)||void 0===l?void 0:l.value),$e("Outcome voided successfully"),null===(n=a.value)||void 0===n||null===(n=n.other)||void 0===n||n.patient_states.splice(t,1),Me.emit(je.RELOAD_PATIENT_VISIT_DATA)}async function Q(){await T.show(St,{birthdate:i.value,patientId:l.value},"custom-modal custom-modal-backdrop")}return d(W),(e,t)=>{const l=C("ion-icon"),o=C("ion-buttons");return f(),E(v(L),{when:"xs",contentId:"main"},{default:m(()=>[c(v(U),{contentId:"main"},{default:m(()=>[c(v(y),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(g),null,{default:m(()=>[...t[0]||(t[0]=[h("Patient Programs",-1)])]),_:1})]),_:1})]),_:1}),c(v(R),{class:"ion-no-padding"},{default:m(()=>[c(v(F),null,{default:m(()=>[(f(!0),s(p,null,q(v(N),e=>{var t;return f(),E(v(I),{button:"",key:e.value,color:e.value===(null===(t=a.value)||void 0===t?void 0:t.value)?"secondary":"light",onClick:t=>function(e){a.value=e}(e)},{default:m(()=>[c(v(V),null,{default:m(()=>[h(G(e.label),1)]),_:2},1024)]),_:2},1032,["color","onClick"])}),128))]),_:1})]),_:1}),c(v(S),null,{default:m(()=>[c(v(b),{class:"ion-padding-start"},{default:m(()=>[a.value?(f(),E(v(A),{key:0,color:"danger",onClick:X,slot:"start"},{default:m(()=>[...t[1]||(t[1]=[h("Void Program",-1)])]),_:1})):B("",!0),v(x)?B("",!0):(f(),E(v(A),{key:1,onClick:Q,slot:"start"},{default:m(()=>[...t[2]||(t[2]=[h("Enroll HIV Program",-1)])]),_:1}))]),_:1})]),_:1})]),_:1}),k("div",xt,[c(v(y),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(o,{slot:"end"},{default:m(()=>[c(v(A),{onClick:v(T).hide,color:"danger",size:"large"},{default:m(()=>[c(l,{size:"large",icon:v(H)},null,8,["icon"])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),c(v(R),{class:"ion-padding"},{default:m(()=>[a.value?(f(),E(v(_),{key:0,style:{width:"100%"}},{default:m(()=>[c(v(w),{class:"his-card",style:z({minHeight:u.value?"0":"30vh"})},{default:m(()=>[c(v(D),{size:"12",class:"ion-no-padding"},{default:m(()=>{var e,t;return[k("h5",Ct," Enrollment Date: "+G(n.value?v(Ae)(n.value):"Unknown"),1),c(At,{patientStates:null!==(e=null===(t=a.value)||void 0===t||null===(t=t.other)||void 0===t?void 0:t.patient_states)&&void 0!==e?e:[],onVoidOutcome:J},null,8,["patientStates"])]}),_:1})]),_:1},8,["style"]),r.value?(f(),E(v(w),{key:0,class:"his-card ion-margin-top",style:{"margin-bottom":"0.4rem"}},{default:m(()=>[c(Ot,{"date-enrolled":n.value,birthdate:i.value,outcomes:r.value,onSaveOutcome:Y},null,8,["date-enrolled","birthdate","outcomes"])]),_:1})):B("",!0)]),_:1})):B("",!0)]),_:1}),c(v(S),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(A),{slot:"end",color:"warning"},{default:m(()=>[...t[3]||(t[3]=[h(" Reset ",-1)])]),_:1}),c(v(A),{slot:"end",color:"primary"},{default:m(()=>[...t[4]||(t[4]=[h(" Submit ",-1)])]),_:1})]),_:1})]),_:1})])]),_:1})}}});class Et extends _e{constructor(e,t=Re()){super(e,Ee.TREATMENT,t)}calculateDosage(e,t){let a=0;return 0===t&&(a=e),0==e&&(a=t),e>0&&t>0&&(a=(e+t)/2),a}calculateEquivalentDosage(e,t){return e+t}calculateDrugRunOutDate(e,t){return Se(Te(t).add(e,"days"))}getInstructions(e,t,a,l){return`${e} :- Morning: ${t} ${l}, Evening: ${a} ${l}`}toDrugOrder(e,t,a,l){return{drug_inventory_id:e.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(e.am,e.pm),start_date:l,auto_expire_date:this.calculateDrugRunOutDate(a,l),units:e.units,instructions:this.getInstructions(e.drug_name,e.am,e.pm,e.units),dose:this.calculateDosage(e.am,e.pm),frequency:e.frequency,qty:t}}async createDrugOrder(e){return pe.create({encounter_id:this.encounterID,drug_orders:e})}}class Bt extends _e{constructor(e,t=Re()){super(e,Ee.HIV_RECEPTION,t)}}class Ft extends _e{constructor(e,t=Re()){super(e,Ee.ART_ADHERENCE,t)}buildPillCountObs(e,t){return this.buildValueNumber("Number of tablets brought to clinic",t,null,e)}async buildAdherenceObs(e,t,a){return{concept_id:await _e.getConceptID("Drug adherence",!0),value_numeric:a,value_drug:t,value_modifier:"%",order_id:e,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(e,t,a){return Math.round(100*(e-t)/(e-a))}calculateExpected(e,t,a,l){const n="QW"===l?"week":"day";return e-this.calcTimeElapsed(a,n)*parseFloat(t.toString())}calcTimeElapsed(e,t){return Te(this.date).diff(e,t)+1}}class qt extends _e{constructor(e,t=Re()){super(e,Ee.APPOINTMENT,t)}}class Gt extends _e{constructor(e,t=Re()){super(e,Ee.DISPENSING,t)}buildDispensations(e,t,a){const l=[];for(let n=0;n<a;n++)l.push({drug_order_id:e,date:this.date,quantity:t/a});return l}saveDispensations(e){return l.postJson("/dispensations",{dispensations:e,program_id:this.programID})}}class Ut{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(e,t,a){let l={result:"",color:"",index:a};if(a<=0)return l.index=0,l;if(t<5&&t>0)l.result="Use MUAC to calculate nutrition status",l.color="red";else{t>18&&(t=19);const n=await this.getBMIData(),i=n[e][t];i&&(l=this.buildBounds(Object.keys(i),i,a,n.colors))}return l}static buildBounds(e,t,a,l){const n={result:"",color:"",index:a};return e.forEach(e=>{if(e.indexOf("-")>=0){const i=e.split("-");a>=parseFloat(i[0])&&a<=parseFloat(i[1])&&(n.result=t[e],n.color=l[t[e]])}else if(e.indexOf("<")>=0){const i=e.replace("<","");a<parseFloat(i)&&(n.result=t[e],n.color=l[t[e]])}else if(e.indexOf(">=")>=0){const i=e.replace(">=","");a>=parseFloat(i)&&(n.result=t[e],n.color=l[t[e]])}}),n}static getBMI(e,t,a,l){const n=this.calculateBMI(e,t);return this.getBMIResult(a,l,n)}static calculateBMI(e,t){if(0==t||0==e)return 0;let a=e/t/t*1e4;return Math.round(10*a)/10}}function Ht(e){const t=O(()=>e.getID()),a=new De(t.value),l=new Ve(t.value),n=new Et(t.value),i=new Gt(t.value),d=new Bt(t.value),s=new Ft(t.value),c=new qt(t.value),m=o(),v=o(),p=o([]),f=o([]),b=o([]),g=o([]),h=O(()=>e.isFemale()),y=o(""),_=e.getBirthdate(),w=o(!1),D=r({}),V=O(()=>g.value.reduce((e,t)=>{var a;const l=null!==(a=t.drug.name)&&void 0!==a?a:t.regimen;return e[l]={label:`${l} brought`,placeholder:`Enter number of ${l} pills brought`,required:!0,value:void 0,computedValue:async e=>{const a=s.calculateExpected(t.quantity,t.equivalent_daily_dose,t.order.start_date,t.frequency),l=s.calculateAdherence(t.quantity,e,a);return[await s.buildAdherenceObs(t.order_id,t.drug_inventory_id,l),await s.buildPillCountObs(t.order_id,e)]}},e},{})),I=O(()=>!(m.value&&e.getAge()>18)),N=r({visitDate:{value:Te().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async e=>new Date(e.value)>new Date(Re())?["Visit date cannot be after today's date"]:Qe(e,_)},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:e=>({tag:"reception",obs:d.buildValueCoded("Patient present",e)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:e=>({tag:"reception",obs:d.buildValueCoded("Guardian present",e)})},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:h.value,computedValue:e=>({tag:"consultation",obs:l.buildValueCoded("Is patient pregnant",e)}),validation:async e=>h.value&&Ke(e)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:h.value,computedValue:e=>({tag:"consultation",obs:l.buildValueCoded("Is patient breast feeding",e)}),validation:async e=>h.value&&Ke(e)},weight:{value:void 0,label:"Weight",required:!0,computedValue:e=>({tag:"vitals",obs:a.buildValueNumber("Weight",e)}),validation:(e,t)=>!ye(e)&&e.value||"No"!==t.patientPresent.value?Ze([()=>Ke(e),()=>tt(e,"DECIMALS"),()=>at(e,2,250)]):null},height:{value:void 0,label:"Height (cm)",computedValue:e=>({tag:"vitals",obs:a.buildValueNumber("Height",e)}),validation:e=>I.value&&(!ye(e)&&e.value||"No"!==N.patientPresent.value)?Ze([()=>Ke(e),()=>tt(e),()=>at(e,20,220)]):null},bp:{value:"",label:"Blood Pressure (mmHG)",placeholder:"Enter Blood Pressure e.g 120/80",validation:e=>ye(e)||!e.value?null:et(e),computedValue:e=>{if(ye(e))return null;const[t,l]=e.split("/").map(Number);return{tag:"vitals",obs:[a.buildValueNumber("Systolic",t),a.buildValueNumber("Diastolic",l)]}}}}),R=r({tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:e=>({tag:"consultation",obs:l.buildValueCoded("TB Status",e.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async e=>{if(!w.value){if(new Date(e.value)>new Date(Re()))return["TB treatment start date cannot be after today's date"];if(new Date(e.value)<new Date(_))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:e=>({tag:"consultation",obs:l.buildValueDate("TB treatment start date",e)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:e=>({tag:"consultation",obs:l.buildValueNumber("TB treatment period",e)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:e=>({tag:"consultation",obs:l.buildGroupValueCoded("TB screening method used","chest xray",e)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:e=>({tag:"consultation",obs:l.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",e)})},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async e=>Ze([()=>Ke(e),()=>"No"===e.value||f.value.some(e=>e.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async e=>Ze([()=>Ke(e),()=>"No"===e.value||b.value.some(e=>e.isChecked)?null:["Please select at least one side effect"]])}}),A=r({regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:n.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:n.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:n.buildValueCoded("Medication orders","INH")}),validation:async(e,t)=>{var a,l;return("6H"===(null===(a=t.tbMed.value)||void 0===a?void 0:a.label)||"3HP (RFP + INH)"===(null===(l=t.tbMed.value)||void 0===l?void 0:l.label))&&tt(e)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:n.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(e,t)=>{var a;return"3HP (RFP + INH)"===(null===(a=t.tbMed.value)||void 0===a?void 0:a.label)&&tt(e)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:n.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(e,t)=>{var a;return"3HP (INH 300 / RFP 300)"===(null===(a=t.tbMed.value)||void 0===a?void 0:a.label)&&tt(e)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(e,t)=>{var a;return(null===(a=t.tbMed.value)||void 0===a?void 0:a.label)&&tt(e)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"}}),T=r({nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:e=>({tag:"appointment",obs:c.buildValueDate("Appointment date",e)}),validation:async(e,t)=>new Date(e.value)<new Date(N.visitDate.value)?["Appointment date cannot be before visit date"]:y.value&&new Date(e.value)>new Date(y.value)?["Appointment date cannot be after drug run out date"]:null}}),S=r({...N,...R,...A,...T}),x=Fe(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),C=Fe(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),k=O(()=>{var e;return"3HP (INH 300 / RFP 300)"===(null===(e=S.tbMed.value)||void 0===e?void 0:e.label)}),E=O(()=>{var e;return"3HP (RFP + INH)"===(null===(e=S.tbMed.value)||void 0===e?void 0:e.label)}),B=O(()=>{var e;return"6H"===(null===(e=S.tbMed.value)||void 0===e?void 0:e.label)}),F=O(()=>"Yes"===S.hasContraindications.value),q=O(()=>"Yes"===S.hasSideEffects.value),G=O(()=>{var e;return/Confirmed TB on treatment/i.test(null===(e=S.tbStatus.value)||void 0===e?void 0:e.label)}),U=O(()=>{var e;return/Suspected/i.test(null===(e=S.tbStatus.value)||void 0===e?void 0:e.label)});u(()=>S.regimen.value,e=>{var t;(L(),e)&&(null==e||null===(t=e.other)||void 0===t||t.forEach(e=>{var t;D[e.drug_name]={label:`${null!==(t=e.drug_name)&&void 0!==t?t:e.alternative_drug_name} given`,value:void 0,required:!0,validation:e=>Ze([()=>tt(e,"POSITIVE_INTEGERS"),()=>Number(e.value)%30!=0?["Quantity should be in multiples of 30"]:null])}}))}),u(()=>S.patientPresent.value,e=>{"No"===e?(S.weight.required=!1,S.weight.error="",S.guardianPresent.value="Yes"):S.weight.required=!0}),u(()=>S.guardianPresent.value,e=>{"No"===e&&(S.patientPresent.value="Yes")}),u([()=>S.weight.value,()=>{var e;return null===(e=S.tbStatus)||void 0===e?void 0:e.value}],async([e,t])=>{var a;S.regimen.value=void 0,L();const l=/confirmed/i.test(null!==(a=null==t?void 0:t.label)&&void 0!==a?a:"");e?(p.value=await ke.getRegimensByWeight(e,l),S.patientPresent.value="Yes",S.patientPresent.disabled=!0):!e&&S.weight.required&&(S.patientPresent.value=void 0,S.patientPresent.disabled=!1),S.tbMed.disabled=l}),u(()=>S.nextAppointmentDate.value,async e=>{e&&y.value&&Te(y.value).diff(Te(e),"days")>7&&await P(`The selected appointment date ${Ae(e)} is more than 7 days earlier than drug run out date. \n            The client will have excess medication`,{header:"Drug Dispensation Alert",icon:"informationOutline",confirmBtnLabel:"OK",showCancelBtn:!1,color:"danger"})});const H=()=>{var e,t;return ye(D)?1/0:Math.min(...(null!==(e=null===(t=S.regimen.value)||void 0===t?void 0:t.other)&&void 0!==e?e:[]).map(e=>{var t,a,l,n;return Number(null!==(t=null===(a=D[e.drug_name])||void 0===a?void 0:a.value)&&void 0!==t?t:0)/Number(e.am+e.noon+e.pm||1)+Number(null!==(l=null===(n=V.value)||void 0===n||null===(n=n[e.drug_name])||void 0===n?void 0:n.value)&&void 0!==l?l:0)}))};u([()=>D,()=>V,()=>S.visitDate.value],()=>{const e=H();if(e!==1/0){y.value=n.calculateDrugRunOutDate(e,S.visitDate.value),S.nextAppointmentDate.label=`Next Appointment Date (Drug run out date: ${Ae(y.value)})`;const t=Te(y.value).subtract(2,"day"),a=t.day();let l;l=0===a?t.subtract(2,"day"):6===a?t.subtract(1,"day"):t,S.nextAppointmentDate.value=Se(l)}},{deep:!0,immediate:!0}),u(()=>S.visitDate.value,()=>z());const z=async()=>{l.setDate(S.visitDate.value),w.value=!1;const e=await l.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(e)){const e=await l.getFirstValueDatetime("TB treatment start date"),t=30*(await l.getFirstValueNumber("TB treatment period")||6);if(e){const a=Te(S.visitDate.value).diff(e,"days");w.value=a<=t}}S.tbStatus.required=!w.value},L=()=>{for(const e in D)delete D[e]};return{form:S,drugsForm:D,adherenceForm:V,regimens:p,contraIndications:f,sideEffects:b,prevDrugs:g,isFemale:h,drugRunOutDate:y,isOnActiveTBTreatment:w,showHeightField:I,tbMeds:x,tbStatuses:C,chestXRayResultsOptions:[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],mwrdResultsOptions:[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],hasGiven3HP:k,hasGivenRFP:E,hasGiven6H:B,hasContraindications:F,hasSideEffects:q,isOnTBTreatment:G,canTestForTB:U,loadPatientData:async()=>{try{await z(),m.value=await e.getRecentHeight(),v.value=await e.getRecentWeight(),v.value&&(p.value=await ke.getRegimensByWeight(v.value)),g.value=await pe.getLastDrugsReceived(e.getID()),f.value=fe.getConceptsByCategory("contraindication",!0).map(e=>({value:e.concept_id,label:e.name,other:e,isChecked:!1})),b.value=fe.getConceptsByCategory("side_effect",!0).map(e=>({value:e.concept_id,label:e.name,other:e,isChecked:!1}))}catch(t){We("Form initialization failed. Try to refresh the page"),console.error(t)}},resetForm:async()=>{if(await P("Are you sure you want to clear all fields?")){for(const e in S)S[e].value="",S[e].error="",S[e].disabled=!1;return L(),!0}return!1},saveVisit:async()=>{a.setDate(S.visitDate.value),l.setDate(S.visitDate.value),n.setDate(S.visitDate.value),d.setDate(S.visitDate.value),s.setDate(S.visitDate.value),c.setDate(S.visitDate.value),i.setDate(S.visitDate.value),await Ue(S,async(e,t)=>{var o;const r=[];let u=0;if(!ye(e.regimen)&&await He(D)){const t=e.regimen.other,a=ze(D).formData;u=H(),t.forEach(t=>r.push(n.toDrugOrder(t,a[t.drug_name],u,e.visitDate)))}else{if(!(await P("Are you sure you want to continue without dispensing ART drugs?")))return}var p;(Je.show("Saving patient visit..."),e.totalCPTGiven)&&qe((await ke.getRegimenExtras("Cotrimoxazole",null!==(p=e.weight)&&void 0!==p?p:v.value)).data,"concept_name").filter(e=>"Daily (QOD)"===e.frequency).forEach(t=>r.push(n.toDrugOrder(t,e.totalCPTGiven,u,e.visitDate)));if(null!==(o=e.tbMed)&&void 0!==o&&o.value){var g;const t=qe((await ke.getRegimenExtras("INH",null!==(g=e.weight)&&void 0!==g?g:v.value)).data,["concept_name","frequency"]),a=t.find(e=>"Pyridoxine"===e.concept_name);if(a&&e.totalPyridoxineGiven&&r.push(n.toDrugOrder(a,e.totalPyridoxineGiven,u,e.visitDate)),e.totalIPTGiven){const a=t.find(e=>"Isoniazid"===e.concept_name&&(B.value&&"Daily (QOD)"===e.frequency||E.value&&"Weekly (QW)"===e.frequency));r.push(n.toDrugOrder(a,e.totalIPTGiven,u,e.visitDate))}if(e.totalRFPGiven&&E.value){var y;const t=(await ke.getRegimenExtras("Rifapentine",null!==(y=e.weight)&&void 0!==y?y:v.value)).data;t.length&&r.push(n.toDrugOrder(t[0],e.totalRFPGiven,u,e.visitDate))}if(e.total3HPGiven&&k.value){var _;const t=(await ke.getRegimenExtras("INH / RFP",null!==(_=e.weight)&&void 0!==_?_:v.value)).data;r.push(n.toDrugOrder(t[0],e.total3HPGiven,u,e.visitDate))}}if(!ye(r)){await n.createEncounter();const e=(await n.createDrugOrder(r)).data.map(e=>{const t=r.find(t=>t.drug_inventory_id===e.drug_inventory_id);return i.buildDispensations(e.order_id,t.qty,1)});await i.saveDispensations(e.flat(1))}const w=await Le(t,"vitals");if(!ye(w)){await a.createEncounter();const t=await(async e=>{const t=e.height||m.value,l=Ut.calculateBMI(e.weight,t);return a.buildValueNumber("BMI",l)})(e);await a.saveObservationList([...w,t])}await l.createEncounter();const I=await Le(t,"consultation");I.push(...await l.buildOptionsGroupObs("Malawi ART side effects",f.value)),I.push(...await(async()=>Promise.all(fe.getConceptsByCategory("tb_symptom",!0).map(async e=>l.buildGroupValueCoded(e.name,e.name,"No"))))()),q.value&&I.push(...await l.buildOptionsGroupObs("Other side effect",b.value)),h.value&&I.push(...await(async()=>{const e=[await l.buildValueCoded("Patient using family planning","No")];return l.getFamilyPlanningMethods().forEach(async t=>{e.push(await l.buildValueCoded(t,"No"))}),e})()),await l.saveObservationList(I),await d.createEncounter();const N=await Le(t,"reception");await d.saveObservationList(N);const R=ze(V.value).computedFormData;if(!ye(R)){const e=await Le(R);ye(e)||(await s.createEncounter(),await s.saveObservationList(e.flat()))}await c.createEncounter();const A=await Le(t,"appointment");await c.saveObservationList(A)},{showloader:!1})},validateReceptionStep:async function(){const e=["visitDate","patientPresent","guardianPresent","weight"];h.value&&e.push("isPregnant","isBreastfeeding"),I.value&&e.push("height");for(const t of e){const e=S[t];if(!e)continue;const{required:a,value:l,validation:n}=e;if(a&&ye(l))e.error="This field is required";else if("function"==typeof n){const t="object"==typeof l?l:{label:l,value:l},a=await n(t,S);e.error=ye(a)?"":a.join()}else e.error=""}return e.every(e=>{var t;return!(null!==(t=S[e])&&void 0!==t&&t.error)})},validateConsultationStep:async function(){const e=["tbStatus"];G.value&&!w.value&&e.push("tbTreatmentStartDate","tbTreatmentPeriod");for(const t of e){const e=S[t];if(!e)continue;const{required:a,value:l,validation:n}=e;if(a&&ye(l))e.error="This field is required";else if("function"==typeof n){const t="object"==typeof l?l:{label:l,value:l},a=await n(t,S);e.error=ye(a)?"":a.join()}else e.error=""}return e.every(e=>{var t;return!(null!==(t=S[e])&&void 0!==t&&t.error)})},validateMedicationStep:async function(){if(!ye(V.value)){if(!(await He(V.value)))return!1}if(S.regimen.value&&!ye(D)){if(!(await He(D)))return!1}return!0},validateAppointmentStep:async function(){const e=S.nextAppointmentDate;if(!e)return!0;const{required:t,value:a,validation:l}=e;if(t&&ye(a))return e.error="This field is required",!1;if("function"==typeof l){const t="object"==typeof a?a:{label:a,value:a},n=await l(t,S);return e.error=ye(n)?"":n.join(),!e.error}return e.error="",!0}}}const zt={class:"step-container"},Lt=i({__name:"StepContainer",props:{title:{type:String,required:!0},isFirstStep:{type:Boolean,default:!1},isLastStep:{type:Boolean,default:!1},stepIndex:{type:Number,required:!0}},emits:["back","next"],setup:(e,{emit:t})=>(t,a)=>(f(),s("div",zt,[k("h2",null,G(e.title),1),M(t.$slots,"default",{},void 0,!0)]))}),Mt=x(Lt,[["__scopeId","data-v-fc159c8d"]]),jt=i({__name:"ReceptionStep",props:{form:{type:Object,required:!0},isFemale:{type:Boolean,required:!0},birthdate:{type:String,required:!0},showHeightField:{type:Boolean,required:!0}},emits:["next"],setup(e,{emit:t}){const a=t,l=()=>{a("next",0)};return(t,a)=>(f(),E(Mt,{title:"Reception","is-first-step":!0,"is-last-step":!1,"step-index":0,onNext:l},{default:m(()=>[c(v(_),{style:{width:"100%"}},{default:m(()=>[c(v(w),null,{default:m(()=>[c(v(D),{size:"12",class:"ion-margin-vertical"},{default:m(()=>[c(Oe,{modelValue:e.form.visitDate,"onUpdate:modelValue":a[0]||(a[0]=t=>e.form.visitDate=t),form:e.form,minDate:e.birthdate,maxDate:v(Re)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(mt,{modelValue:e.form.patientPresent,"onUpdate:modelValue":a[1]||(a[1]=t=>e.form.patientPresent=t),disabled:e.form.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(mt,{modelValue:e.form.guardianPresent,"onUpdate:modelValue":a[2]||(a[2]=t=>e.form.guardianPresent=t)},null,8,["modelValue"])]),_:1}),e.isFemale?(f(),s(p,{key:0},[c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(mt,{modelValue:e.form.isPregnant,"onUpdate:modelValue":a[3]||(a[3]=t=>e.form.isPregnant=t)},null,8,["modelValue"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(mt,{modelValue:e.form.isBreastfeeding,"onUpdate:modelValue":a[4]||(a[4]=t=>e.form.isBreastfeeding=t)},null,8,["modelValue"])]),_:1})],64)):B("",!0),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(Ce,{modelValue:e.form.weight,"onUpdate:modelValue":a[5]||(a[5]=t=>e.form.weight=t),form:e.form,min:1},null,8,["modelValue","form"])]),_:1}),e.showHeightField?(f(),E(v(D),{key:1,size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(Ce,{modelValue:e.form.height,"onUpdate:modelValue":a[6]||(a[6]=t=>e.form.height=t),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):B("",!0),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(ot,{modelValue:e.form.bp,"onUpdate:modelValue":a[7]||(a[7]=t=>e.form.bp=t),form:e.form},null,8,["modelValue","form"])]),_:1})]),_:1})]),_:1})]),_:1}))}}),$t=x(jt,[["__scopeId","data-v-153ee5f1"]]),Wt=i({name:"MultiColumnView",components:{IonGrid:_,IonRow:w,IonCol:D},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup:e=>({computedItems:O(()=>Ge(e.items,Math.ceil(e.items.length/e.numberOfColumns))),grid:{1:"12",2:"6",3:"4",4:"3",6:"2"}})});const Yt=x(Wt,[["render",function(e,t,a,l,n,i){const o=C("ion-col"),r=C("ion-row"),u=C("ion-grid");return f(),E(u,null,{default:m(()=>[c(r,null,{default:m(()=>[(f(!0),s(p,null,q(e.computedItems,(t,a)=>(f(),E(o,{key:a,size:e.grid[e.numberOfColumns]},{default:m(()=>[M(e.$slots,"default",{entries:t})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}]]),Xt=i({__name:"ConsultationStep",props:{form:{type:Object,required:!0},showHeightField:{type:Boolean,required:!0},tbStatuses:{type:Array,required:!0},chestXRayResultsOptions:{type:Array,required:!0},mwrdResultsOptions:{type:Array,required:!0},isOnTBTreatment:{type:Boolean,required:!0},isOnActiveTBTreatment:{type:Boolean,required:!0},canTestForTB:{type:Boolean,required:!0},birthdate:{type:String,required:!0},contraIndications:{type:Array,required:!0},sideEffects:{type:Array,required:!0},hasContraindications:{type:Boolean,required:!0},hasSideEffects:{type:Boolean,required:!0}},emits:["back","next"],setup(e,{emit:t}){const a=t,l=()=>{a("back",1)},n=()=>{a("next",1)};return(t,a)=>(f(),E(Mt,{title:"Consultation","step-index":1,onBack:l,onNext:n},{default:m(()=>[c(v(_),{style:{width:"100%"}},{default:m(()=>[c(v(w),null,{default:m(()=>[c(v(D),{size:"12"},{default:m(()=>[...a[7]||(a[7]=[k("h4",{class:"section-title"},"TB Assessment",-1)])]),_:1}),c(v(D),{class:"ion-margin-vertical",size:"12"},{default:m(()=>[c(xe,{modelValue:e.form.tbStatus,"onUpdate:modelValue":a[0]||(a[0]=t=>e.form.tbStatus=t),options:e.tbStatuses},null,8,["modelValue","options"])]),_:1}),e.isOnTBTreatment&&!e.isOnActiveTBTreatment?(f(),s(p,{key:0},[c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(Oe,{modelValue:e.form.tbTreatmentStartDate,"onUpdate:modelValue":a[1]||(a[1]=t=>e.form.tbTreatmentStartDate=t),form:e.form,minDate:e.birthdate,maxDate:v(Re)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(Ce,{modelValue:e.form.tbTreatmentPeriod,"onUpdate:modelValue":a[2]||(a[2]=t=>e.form.tbTreatmentPeriod=t),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})],64)):e.canTestForTB?(f(),s(p,{key:1},[c(v(D),{size:"12",class:"ion-margin-vertical"},{default:m(()=>[c(mt,{modelValue:e.form.cxrResult,"onUpdate:modelValue":a[3]||(a[3]=t=>e.form.cxrResult=t),"custom-options":e.chestXRayResultsOptions},null,8,["modelValue","custom-options"])]),_:1}),c(v(D),{size:"12",class:"ion-margin-vertical"},{default:m(()=>[c(mt,{modelValue:e.form.mwrdResult,"onUpdate:modelValue":a[4]||(a[4]=t=>e.form.mwrdResult=t),"custom-options":e.mwrdResultsOptions},null,8,["modelValue","custom-options"])]),_:1})],64)):B("",!0)]),_:1}),c(v(w),null,{default:m(()=>[c(v(D),{size:"12"},{default:m(()=>[...a[8]||(a[8]=[k("h4",{class:"section-title"},"Side Effects & Contraindications",-1)])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(mt,{modelValue:e.form.hasContraindications,"onUpdate:modelValue":a[5]||(a[5]=t=>e.form.hasContraindications=t)},null,8,["modelValue"]),e.hasContraindications?(f(),E(Yt,{key:0,items:e.contraIndications,numberOfColumns:2},{default:m(({entries:e})=>[(f(!0),s(p,null,q(e,e=>(f(),E(v(I),{lines:"none",key:e.value},{default:m(()=>[c(v(V),null,{default:m(()=>[h(G(e.label),1)]),_:2},1024),c(v(N),{slot:"start",modelValue:e.isChecked,"onUpdate:modelValue":t=>e.isChecked=t},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):B("",!0)]),_:1}),c(v(D),{class:"ion-margin-vertical",size:"6"},{default:m(()=>[c(mt,{modelValue:e.form.hasSideEffects,"onUpdate:modelValue":a[6]||(a[6]=t=>e.form.hasSideEffects=t)},null,8,["modelValue"]),e.hasSideEffects?(f(),E(Yt,{key:0,items:e.sideEffects,numberOfColumns:2},{default:m(({entries:e})=>[(f(!0),s(p,null,q(e,e=>(f(),E(v(I),{lines:"none",key:e.value},{default:m(()=>[c(v(V),null,{default:m(()=>[h(G(e.label),1)]),_:2},1024),c(v(N),{slot:"start",modelValue:e.isChecked,"onUpdate:modelValue":t=>e.isChecked=t},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):B("",!0)]),_:1})]),_:1})]),_:1})]),_:1}))}}),Jt=x(Xt,[["__scopeId","data-v-1d2ba071"]]),Qt=i({__name:"MedicationStep",props:{form:{type:Object,required:!0},drugsForm:{type:Object,required:!0},adherenceForm:{type:Object,required:!0},regimens:{type:Array,required:!0},tbMeds:{type:Array,required:!0},hasGiven3HP:{type:Boolean,required:!0},hasGivenRFP:{type:Boolean,required:!0},hasGiven6H:{type:Boolean,required:!0}},emits:["back","next"],setup(e,{emit:t}){const a=t,l=()=>{a("back",3)},n=()=>{a("next",3)};return(t,a)=>(f(),E(Mt,{title:"Medication & Adherence","step-index":3,onBack:l,onNext:n},{default:m(()=>[c(v(_),{style:{width:"100%"}},{default:m(()=>[c(v(w),null,{default:m(()=>[e.adherenceForm&&!v(ye)(e.adherenceForm)?(f(),s(p,{key:0},[c(v(D),{size:"12"},{default:m(()=>[...a[7]||(a[7]=[k("h4",{class:"section-title"},"Adherence Assessment",-1),k("p",{class:"section-description"},"Record the number of pills the patient has brought back from their previous visit",-1)])]),_:1}),(f(!0),s(p,null,q(Object.values(e.adherenceForm),(t,a)=>(f(),E(v(D),{size:"6",class:"ion-margin-bottom",key:a},{default:m(()=>[c(Ce,{"model-value":t,form:e.adherenceForm,min:0},null,8,["model-value","form"])]),_:2},1024))),128))],64)):B("",!0),c(v(D),{size:"12"},{default:m(()=>[...a[8]||(a[8]=[k("h4",{class:"section-title"},"Medication Orders",-1),k("p",{class:"section-description"},"Record the number of pills the patient has received during this visit",-1)])]),_:1}),c(v(D),{size:"12",class:"ion-margin-bottom"},{default:m(()=>[c(xe,{modelValue:e.form.regimen,"onUpdate:modelValue":a[0]||(a[0]=t=>e.form.regimen=t),options:e.regimens},null,8,["modelValue","options"])]),_:1}),v(ye)(e.drugsForm)?B("",!0):(f(!0),s(p,{key:1},q(Object.values(e.drugsForm),(t,a)=>(f(),E(v(D),{size:"6",class:"ion-margin-bottom",key:`drug-${a}`},{default:m(()=>[c(Ce,{"model-value":t,form:e.drugsForm,min:1},null,8,["model-value","form"])]),_:2},1024))),128)),c(v(D),{size:"6",class:"ion-margin-bottom"},{default:m(()=>[c(Ce,{modelValue:e.form.totalCPTGiven,"onUpdate:modelValue":a[1]||(a[1]=t=>e.form.totalCPTGiven=t),form:e.form,min:1},null,8,["modelValue","form"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-bottom"},{default:m(()=>[c(xe,{modelValue:e.form.tbMed,"onUpdate:modelValue":a[2]||(a[2]=t=>e.form.tbMed=t),options:e.tbMeds,"drop-direction":"top"},null,8,["modelValue","options"])]),_:1}),e.hasGiven6H||e.hasGivenRFP?(f(),E(v(D),{key:2,size:"6",class:"ion-margin-bottom"},{default:m(()=>[c(Ce,{modelValue:e.form.totalIPTGiven,"onUpdate:modelValue":a[3]||(a[3]=t=>e.form.totalIPTGiven=t),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):B("",!0),e.hasGivenRFP?(f(),E(v(D),{key:3,size:"6",class:"ion-margin-bottom"},{default:m(()=>[c(Ce,{modelValue:e.form.totalRFPGiven,"onUpdate:modelValue":a[4]||(a[4]=t=>e.form.totalRFPGiven=t),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):B("",!0),e.hasGiven3HP?(f(),E(v(D),{key:4,size:"6",class:"ion-margin-bottom"},{default:m(()=>[c(Ce,{modelValue:e.form.total3HPGiven,"onUpdate:modelValue":a[5]||(a[5]=t=>e.form.total3HPGiven=t),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):B("",!0),e.hasGiven3HP||e.hasGivenRFP||e.hasGiven6H?(f(),E(v(D),{key:5,size:"6",class:"ion-margin-bottom"},{default:m(()=>[c(Ce,{modelValue:e.form.totalPyridoxineGiven,"onUpdate:modelValue":a[6]||(a[6]=t=>e.form.totalPyridoxineGiven=t),form:e.form,min:1},null,8,["modelValue","form"])]),_:1})):B("",!0)]),_:1})]),_:1})]),_:1}))}}),Kt=x(Qt,[["__scopeId","data-v-27c751fc"]]),Zt={class:"calendar-section"},ea={class:"date-picker-container"},ta={key:0,class:"text-danger"},aa={class:"info-section"},la={class:"info-box"},na={class:"drug-runout-info"},ia={class:"info-content"},oa={class:"date"},ra={class:"summary-section"},ua={class:"summary-content"},da={class:"summary-item"},sa={class:"value"},ca={class:"summary-item"},ma={class:"value"},va={class:"summary-item"},pa={class:"value"},fa={key:0,class:"summary-item"},ba={class:"value"},ga={key:1,class:"summary-item"},ha={class:"value"},ya={key:2,class:"summary-item"},_a={class:"value"},wa=x(i({__name:"AppointmentStep",props:{form:{type:Object,required:!0},drugRunOutDate:{type:String,required:!0}},emits:["back","next"],setup(e,{emit:t}){const a=e,l=t,n=O(()=>a.drugRunOutDate?Ae(a.drugRunOutDate):"Not available"),i=()=>{l("back",4)},o=()=>{l("next",4)};return(t,a)=>(f(),E(Mt,{title:"Next Appointment","step-index":4,"is-last-step":!0,onBack:i,onNext:o},{default:m(()=>[c(v(_),{style:{width:"100%"}},{default:m(()=>[c(v(w),null,{default:m(()=>[c(v(D),{size:"12","size-md":"6",class:"left-column"},{default:m(()=>[k("div",Zt,[a[1]||(a[1]=k("h4",{class:"section-title"},"Schedule Next Appointment",-1)),k("div",ea,[c(v(V),{class:"ion-padding-bottom bold"},{default:m(()=>[k("span",null,G(e.form.nextAppointmentDate.label),1),e.form.nextAppointmentDate.required?(f(),s("span",ta," *")):B("",!0)]),_:1}),c(v(j),{presentation:"date",class:$(["ion-margin-top",e.form.nextAppointmentDate.error?"box-input-error":"box-input"]),modelValue:e.form.nextAppointmentDate.value,"onUpdate:modelValue":a[0]||(a[0]=t=>e.form.nextAppointmentDate.value=t),min:e.form.visitDate.value,max:e.drugRunOutDate,onIonChange:()=>{}},null,8,["class","modelValue","min","max"]),e.form.nextAppointmentDate.error?(f(),E(v(W),{key:0,color:"danger"},{default:m(()=>[h(G(e.form.nextAppointmentDate.error),1)]),_:1})):B("",!0)])])]),_:1}),c(v(D),{size:"12","size-md":"6",class:"right-column"},{default:m(()=>{return[k("div",aa,[a[3]||(a[3]=k("h4",{class:"section-title"},"Drug Run Out Information",-1)),k("div",la,[k("div",na,[c(v(Y),{name:"calendar-outline",class:"info-icon"}),k("div",ia,[k("div",oa,G(n.value),1),a[2]||(a[2]=k("p",{class:"note"},"The patient will run out of medication on this date",-1))])])])]),k("div",ra,[a[10]||(a[10]=k("h4",{class:"section-title"},"Visit Summary",-1)),k("div",ua,[k("div",da,[a[4]||(a[4]=k("div",{class:"label"},"Visit Date:",-1)),k("div",sa,G((t=e.form.visitDate.value,t?Ae(t):"")),1)]),k("div",ca,[a[5]||(a[5]=k("div",{class:"label"},"Patient Present:",-1)),k("div",ma,G(e.form.patientPresent.value),1)]),k("div",va,[a[6]||(a[6]=k("div",{class:"label"},"Guardian Present:",-1)),k("div",pa,G(e.form.guardianPresent.value),1)]),e.form.weight.value?(f(),s("div",fa,[a[7]||(a[7]=k("div",{class:"label"},"Weight:",-1)),k("div",ba,G(e.form.weight.value)+" kg",1)])):B("",!0),e.form.regimen.value?(f(),s("div",ga,[a[8]||(a[8]=k("div",{class:"label"},"Regimen:",-1)),k("div",ha,G(e.form.regimen.value.label),1)])):B("",!0),e.form.tbStatus.value?(f(),s("div",ya,[a[9]||(a[9]=k("div",{class:"label"},"TB Status:",-1)),k("div",_a,G(e.form.tbStatus.value.label),1)])):B("",!0)])])];var t}),_:1})]),_:1})]),_:1})]),_:1}))}}),[["__scopeId","data-v-db361dbb"]]),Da={class:"visit-container"},Va={class:"side-navigation"},Ia=["onClick"],Na={class:"nav-number"},Ra={class:"nav-label"},Aa={class:"main-content"},Ta=x(i({__name:"Index",props:{patient:{type:Object,required:!0}},setup(e){const t=e,a=[{label:"Reception",component:$t},{label:"Consultation",component:Jt},{label:"Medication",component:Kt},{label:"Appointment",component:wa}],l=o(0),i=O(()=>(l.value+1)/a.length),r=O(()=>a[l.value].component),{form:u,drugsForm:_,adherenceForm:w,regimens:D,contraIndications:V,sideEffects:I,isFemale:N,drugRunOutDate:P,isOnActiveTBTreatment:x,showHeightField:C,tbMeds:F,tbStatuses:U,chestXRayResultsOptions:H,mwrdResultsOptions:z,hasGiven3HP:L,hasGivenRFP:M,hasGiven6H:j,hasContraindications:W,hasSideEffects:le,isOnTBTreatment:ne,canTestForTB:ie,loadPatientData:oe,resetForm:re,saveVisit:ue,validateReceptionStep:de,validateConsultationStep:se,validateMedicationStep:ce,validateAppointmentStep:me}=Ht(t.patient),ve=t.patient.getBirthdate(),{isDICSite:pe,refreshDICStatus:fe}=n(),{enrollPatient:be,fetchPatientPrograms:ge,hasProgram:he,updateState:ye}=we(t.patient.getID()),_e=e=>{e>0&&(l.value=e-1)},De=async e=>{let t=!1;switch(e){case 0:t=await de();break;case 1:t=await se();break;case 2:t=await ce();break;case 3:t=await me();break;default:t=!0}t?e<a.length-1?l.value=e+1:Ie():We("Please correct the errors before proceeding")},Ve=async()=>{await re()&&(l.value=0,Me.emit(je.ON_CLEAR))},Ie=async()=>{Je.show("Saving patient visit...");try{await ue(),pe.value&&!he(te)&&(await be(u.visitDate.value,te),await ye(ae,u.visitDate.value,te)),await $e("Patient visit saved successfully"),await Je.hide(),await T.hide(),Me.emit(je.RELOAD_PATIENT_VISIT_DATA),Me.emit(je.RELOAD_STAGING_INFORMATION)}catch(e){console.error("Error saving visit:",e)}finally{Je.hide()}};return d(async()=>{await oe(),await fe(),await ge()}),d(()=>{Me.on(je.ON_CLEAR,()=>{l.value=0})}),(e,t)=>(f(),s(p,null,[c(v(y),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(g),null,{default:m(()=>[...t[2]||(t[2]=[h("Patient Visit",-1)])]),_:1}),c(v(X),{slot:"end"},{default:m(()=>[c(v(A),{color:"danger",fill:"clear",size:"large",onClick:v(T).hide},{default:m(()=>[c(v(Y),{icon:v(J)},null,8,["icon"])]),_:1},8,["onClick"])]),_:1})]),_:1}),c(v(Q),{value:i.value},null,8,["value"])]),_:1}),c(v(R),{class:"ion-padding"},{default:m(()=>[k("div",Da,[k("div",Va,[(f(),s(p,null,q(a,(e,t)=>k("div",{key:t,class:$(["nav-item",{active:l.value===t,completed:l.value>t}]),onClick:e=>(e=>{e<=l.value&&(l.value=e)})(t)},[k("div",Na,G(t+1),1),k("div",Ra,G(e.label),1)],10,Ia)),64))]),k("div",Aa,[(f(),E(Z,null,[(f(),E(K(r.value),{form:v(u),drugsForm:v(_),adherenceForm:v(w),regimens:v(D),contraIndications:v(V),sideEffects:v(I),showHeightField:v(C),isFemale:v(N),drugRunOutDate:v(P),birthdate:v(ve),tbMeds:v(F),tbStatuses:v(U),chestXRayResultsOptions:v(H),mwrdResultsOptions:v(z),isOnTBTreatment:v(ne),isOnActiveTBTreatment:v(x),canTestForTB:v(ie),hasGiven3HP:v(L),hasGivenRFP:v(M),hasGiven6H:v(j),hasContraindications:v(W),hasSideEffects:v(le),onBack:_e,onNext:De},null,40,["form","drugsForm","adherenceForm","regimens","contraIndications","sideEffects","showHeightField","isFemale","drugRunOutDate","birthdate","tbMeds","tbStatuses","chestXRayResultsOptions","mwrdResultsOptions","isOnTBTreatment","isOnActiveTBTreatment","canTestForTB","hasGiven3HP","hasGivenRFP","hasGiven6H","hasContraindications","hasSideEffects"]))],1024))])])]),_:1}),c(v(S),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(X),{slot:"end"},{default:m(()=>[l.value>0?(f(),E(v(A),{key:0,color:"primary",fill:"solid",onClick:t[0]||(t[0]=e=>_e(l.value))},{default:m(()=>[...t[3]||(t[3]=[h(" Back ",-1)])]),_:1})):B("",!0),c(v(A),{color:"danger",fill:"solid",onClick:v(T).hide},{default:m(()=>[c(v(Y),{slot:"start",icon:v(J)},null,8,["icon"]),t[4]||(t[4]=h(" Cancel ",-1))]),_:1},8,["onClick"]),c(v(A),{color:"warning",fill:"solid",onClick:Ve},{default:m(()=>[c(v(Y),{slot:"start",icon:v(ee)},null,8,["icon"]),t[5]||(t[5]=h(" Reset ",-1))]),_:1}),l.value<a.length-1?(f(),E(v(A),{key:1,color:"primary",fill:"solid",onClick:t[1]||(t[1]=e=>De(l.value))},{default:m(()=>[...t[6]||(t[6]=[h(" Next ",-1)])]),_:1})):(f(),E(v(A),{key:2,color:"success",fill:"solid",onClick:Ie},{default:m(()=>[...t[7]||(t[7]=[h(" Save Visit ",-1)])]),_:1}))]),_:1})]),_:1})]),_:1})],64))}}),[["__scopeId","data-v-94ed98d5"]]),Sa=i({__name:"EmergencyRefill",props:{patient:{type:Object,required:!0}},setup(e){const t=e,a=O(()=>t.patient.getID()),l=new Ft(a.value),n=o(),i=o([]),V=o([]),I=O(()=>{var e;return null===(e=V.value[0])||void 0===e?void 0:e.order.start_date}),N=o(""),x=t.patient.getBirthdate(),C=o({}),k=r({date:{value:Re(),label:"Date of emergency refill",required:!0,computedValue:e=>({obs:l.buildValueDate("Prescription refill date",e)})},facility:{value:void 0,label:"Facility where emergency refill was collected",required:!0,placeholder:"Select a facility",computedValue:e=>({obs:l.buildValueText("Health facility name",e.label)})},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:e=>({obs:l.buildValueDate("Appointment date",e)})}});async function B(){if(await P("Are you sure you want to clear all fields?")){for(const e in k)k[e].value="",k[e].error="",k[e].disabled=!1;!function(){for(const e in C.value)delete C.value[e]}(),Me.emit(je.ON_CLEAR)}}function F(e){return e.regimen?`${e.regimen} - ${e.drug.name}`:e.drug.name}async function G(){if(await He(k)&&await He(C.value))try{Je.show(),l.setDate(k.date.value);const e=await Le({...ze(k).computedFormData,...ze(C.value).computedFormData}),t=new _e(a.value,Ee.EMERGENCY_DRUG_REFILL,k.date.value);await t.createEncounter(),await t.saveObservationList(e),$e("Emergency refill saved successfully"),T.hide(),Me.emit(je.RELOAD_PATIENT_VISIT_DATA),Me.emit(je.RELOAD_STAGING_INFORMATION)}catch(e){console.error(e),We("Failed to save emergency refill")}finally{Je.hide()}}function U(){V.value.forEach(e=>{const t=F(e);C.value[`${t}_brought`]={label:`${t} brought`,value:void 0,required:!0,placeholder:"Enter the number of pills brought",validation:e=>tt(e,"POSITIVE_INTEGERS")},C.value[`${t}_given`]={label:`${t} given`,value:void 0,required:!0,placeholder:"Enter the number of pills given",validation:e=>tt(e,"POSITIVE_INTEGERS"),computedValue:(a,n)=>async function(e,t,a){const n=l.calculateExpected(e.quantity,e.equivalent_daily_dose,e.order.start_date,e.frequency),i=l.calculateAdherence(e.quantity,a,n);return{...await l.buildValueCoded("Medications dispensed",e.drug.concept_id),child:[await l.buildAdherenceObs(e.order_id,e.drug_inventory_id,i),await l.buildPillCountObs(e.order_id,a),,await l.buildValueNumber("Amount of drug dispensed",t)]}}(e,a,n[`${t}_brought`].value)}})}return u([()=>C,()=>k.date.value],function(){const e=ye(V.value)?1/0:Math.min(...V.value.map(e=>{var t,a,l,n;const i=F(e);return(Number(null!==(t=null===(a=C.value[`${i}_given`])||void 0===a?void 0:a.value)&&void 0!==t?t:0)+Number(null!==(l=null===(n=C.value[`${i}_brought`])||void 0===n?void 0:n.value)&&void 0!==l?l:0))/Number(e.equivalent_daily_dose)}));e!==1/0&&(N.value=Pe(k.date.value,e,"days"),k.nextAppointmentDate.label=`Next Appointment Date (Drug run out date: ${Ae(N.value)})`,k.nextAppointmentDate.value=N.value)},{deep:!0,immediate:!0}),d(async()=>{try{Je.show(),n.value=await t.patient.getRecentWeight(),i.value=await ke.getRegimensByWeight(n.value),V.value=await pe.getLastDrugsReceived(a.value),U()}catch(e){We("Form initialization failed. Try to refresh the page"),console.error(e)}finally{Je.hide()}}),(e,t)=>(f(),s(p,null,[c(v(y),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(g),null,{default:m(()=>[...t[4]||(t[4]=[h("Emergency Drug Refill",-1)])]),_:1})]),_:1})]),_:1}),c(v(R),{class:"ion-padding"},{default:m(()=>[c(v(_),{style:{width:"100%"}},{default:m(()=>[c(v(w),null,{default:m(()=>[c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(Oe,{modelValue:k.date,"onUpdate:modelValue":t[0]||(t[0]=e=>k.date=e),form:k,minDate:I.value||v(x),maxDate:v(Re)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(xe,{modelValue:k.facility,"onUpdate:modelValue":t[1]||(t[1]=e=>k.facility=e),form:k,asyncOptions:v(rt)},null,8,["modelValue","form","asyncOptions"])]),_:1}),(f(!0),s(p,null,q(Object.values(C.value),e=>(f(),E(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(Ce,{"model-value":e,form:C.value,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),c(v(D),{size:"6",class:"ion-margin-vertical"},{default:m(()=>[c(Oe,{modelValue:k.nextAppointmentDate,"onUpdate:modelValue":t[2]||(t[2]=e=>k.nextAppointmentDate=e),form:k,minDate:k.date.value,maxDate:N.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1})]),_:1})]),_:1})]),_:1}),c(v(S),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(A),{color:"primary",onClick:t[3]||(t[3]=e=>v(T).hide()),slot:"end"},{default:m(()=>[...t[5]||(t[5]=[h(" Close ",-1)])]),_:1}),c(v(A),{color:"warning",onClick:B,slot:"end"},{default:m(()=>[...t[6]||(t[6]=[h(" Reset ",-1)])]),_:1}),c(v(A),{color:"success",onClick:G,slot:"end"},{default:m(()=>[...t[7]||(t[7]=[h(" Save ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),Pa=i({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:Xe,IonCard:le,IonCardHeader:ne,IonCardTitle:ie,IonCardContent:oe,IonButton:A},setup(e){const t=o([]),a=O(()=>e.patient.getID()),l=r({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),n=o([{label:"Add Visit",action:async()=>{await T.show(Ta,{patient:e.patient})}},{label:"Emergency Refill",action:async()=>{await T.show(Sa,{patient:e.patient})}},{label:"Update Outcome",action:async()=>T.show(kt,{patient:e.patient})},{label:"Enter VL Results",action:async()=>T.show(Nt,{patient:e.patient})}]),i=t=>{const a="N/A"!==e.startDate?"("+Te(t).diff(e.startDate,"months")+"M)":"";return`${Ae(t)} ${a}`},u={minWidth:"68px !important"},s=o([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:u},{path:"vitals",label:"Vitals",sortable:!1,thStyles:{minWidth:"120px !important"}},...e.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:u},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:u}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:e=>e.length>0?"Yes":"No",sortable:!1,thStyles:u},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:u},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:u},{path:"vlResult",label:"Viral Load",sortable:!1}]),c=[{label:"void",icon:re,color:"danger",action(e,l){Ne(async n=>{const i=await Ie.getEncounters(a.value,{date:e.date});var o;i.ok?(null===(o=i.data)||void 0===o||o.forEach(async e=>{await Ie.voidEncounter(e.encounter_id,n)}),t.value.splice(l,1)):We(i.errorMessage||"Failed to void encounters")},"small-modal")}}],m=async e=>e.tb_status.match(/Unknown/i)||"Defaulted"===e.outcome?"":fe.getCachedConceptName(e.tb_status),v=e=>[e.weight?`Wt: ${e.weight}kg`:"",e.height?`Ht: ${e.height}cm`:"",e.bmi?`BMI: ${e.bmi}`:"",e.systolic_blood_pressure&&e.diastolic_blood_pressure?`BP: ${e.systolic_blood_pressure}/${e.diastolic_blood_pressure}`:""].filter(Boolean).join(", "),p=()=>{const{getProgramInfo:e}=we(a.value);be.getPatientVisits(a.value,!0).then(async l=>{t.value=[];for(const n of l){const l=await e(n);let o="",r="",u="",d="";if("Defaulted"!==l.outcome){const e=await ge.getFirstValueDatetime(a.value,"appointment date",n);if(e&&(o=Ae(e)),r=await ge.getFirstValueCoded(a.value,"Is patient pregnant",n),u=await ge.getFirstValueCoded(a.value,"Is patient breast feeding",n),"N/A"===l.viral_load){const e=await ge.getFirstObs(a.value,"HIV viral load",n);e&&e.value_text&&e.value_numeric&&(d=1===e.value_numeric?"LDL":e.value_text+e.value_numeric.toString())}else d=l.viral_load}l&&t.value.push({visitDate:i(n),visitBy:l.visit_by.match(/Unk/i)?"":l.visit_by,vitals:v(l),pregnant:r,breastfeeding:u,tbStatus:await m(l),sideEffects:"Defaulted"===l.outcome?"":l.side_effects,regimen:"Defaulted"===l.outcome?"":l.regimen,nextAppointment:o,outcome:l.outcome.match(/Unk/i)?"":l.outcome,vlResult:d,drugs:l.pills_dispensed,date:n})}})};return Me.on(je.RELOAD_PATIENT_VISIT_DATA,()=>p()),d(()=>{p()}),{actionButtons:n,tableConfig:l,rowButtons:c,columns:s,rows:t,onDrilldownHandler:async e=>{const t=/regimen/i.test(e.column.path)?(e=>({title:`Drugs dispensed on ${e.row.visitDate}`,columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:e.row.drugs.map(e=>({name:e[0],quantity:e[1],units:"tab (s)"}))}))(e):(e=>({title:`Side effects noted on ${e.row.visitDate}`,rows:e.row.sideEffects.map(e=>({sideEffect:e})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}))(e);ye(t.rows)||await T.show(vt,t)}}}}),Oa={class:"ion-float-right ion-margin-end ion-margin-bottom"};const xa=x(Pa,[["render",function(e,t,a,l,n,i){const o=C("ion-icon"),r=C("ion-button"),u=C("ion-card-title"),d=C("ion-card-header"),v=C("data-table"),b=C("ion-card-content"),g=C("ion-card");return f(),E(g,{class:"his-card",style:{padding:"0 !important"}},{default:m(()=>[c(d,null,{default:m(()=>[c(u,null,{default:m(()=>[t[0]||(t[0]=k("span",{class:"title"},"Summary of Visits",-1)),k("span",Oa,[(f(!0),s(p,null,q(e.actionButtons,e=>(f(),E(r,{key:e.label,onClick:e.action,color:e.color||"primary"},{default:m(()=>[e.icon?(f(),E(o,{key:0,icon:e.icon,class:"ion-margin-right"},null,8,["icon"])):B("",!0),h(" "+G(e.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),c(b,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:m(()=>[c(v,{rows:e.rows,columns:e.columns,"row-actions-buttons":e.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:e.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}],["__scopeId","data-v-7bb05fd5"]]),Ca=i({__name:"ViralLoadTrail",props:{patient:{}},setup(e){const t=e,a=O(()=>`Viral Load Results Trail for ${t.patient.getFullName()}`),l=o([]),n=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:Ae},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:Ae}],i={label:"X",color:"danger",action({encounter_id:e}){Ne(async t=>{try{await ue.void(e,t),T.hide(),Me.emit(je.RELOAD_LATEST_VL_RESULT),Me.emit(je.RELOAD_PATIENT_VISIT_DATA)}catch(a){console.error(a)}},"small-modal custom-modal-backdrop")}};return d(async()=>{l.value=await It.getViralLoadResultTrail(t.patient.getID())}),(e,t)=>(f(),s(p,null,[c(v(y),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(g),null,{default:m(()=>[h(G(a.value),1)]),_:1})]),_:1})]),_:1}),c(v(R),null,{default:m(()=>[c(v(_),{style:{width:"100%"}},{default:m(()=>[c(v(w),{style:z([{padding:"0 !important"},{minHeight:l.value.length?"0":"30vh"}])},{default:m(()=>[c(v(D),{size:"12",class:"ion-no-padding"},{default:m(()=>[c(v(Xe),{rows:l.value,columns:n,"row-actions-buttons":[i],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),c(v(S),null,{default:m(()=>[c(v(b),null,{default:m(()=>[c(v(A),{color:"primary",onClick:t[0]||(t[0]=e=>v(T).hide()),slot:"end"},{default:m(()=>[...t[1]||(t[1]=[h(" Close ",-1)])]),_:1})]),_:1})]),_:1})],64))}}),ka=i({components:{MultiColumnView:Yt,IonList:F,IonItem:I},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(e,{emit:t}){const a=o(0),l=o(0),n=o(0),i=o(""),r=o(""),u=o(""),s=o(""),c=o(""),m=o(""),v=o(""),p=o(""),f=o(""),b=o(""),g=o(""),h=e=>e.other&&"function"==typeof e.other.onClickHandler,y=O(()=>!ye(e.guardians)),_=()=>{const t=e.patient.getBirthdate(),a="N/A"!==e.artStartDate?Te(e.artStartDate).diff(t,"years"):"";return`${Ae(t)} (${a})`},w=()=>{It.getlatestViralLoadResult(e.patient.getID()).then(e=>b.value=e)},D=()=>({onClickHandler(){de.push(`/patient/reception/${e.patient.getID()}/false`)}}),V=()=>({onClickHandler:()=>t("updatePatient")}),I=O(()=>[{label:"ARV Number",value:e.patient.getArvNumber(),other:{onClickHandler:()=>t("updateARVNumber")}},{label:"NPID",value:e.patient.getNationalID()},{label:"MW National ID",value:e.patient.getMWNationalID(),other:V()},{label:"Name",value:e.patient.getGivenName()+" "+e.patient.getFamilyName(),other:V()},{label:"DOB and Age at Initiation",value:_(),other:V()},{label:"Sex",value:pt(e.patient.getGender()),other:V()},{label:"Location",value:e.patient.getCurrentVillage(),other:V()},{label:"Landmark",value:e.patient.getClosestLandmark(),other:V()},{label:"Phone Number",value:e.patient.getPhoneNumber(),other:V()},{label:"Guardian",value:y.value?e.guardians.map(e=>`${e.name} (${e.relationshipType})`).join(","):"Add",other:{onClickHandler:()=>t("updateGuardian")}},{label:"Agrees to follow up",value:c.value,other:D()},{label:"Date of starting first line ARV Regimen",value:e.artStartDate,other:D()},{label:"Initial Weight and Height",value:`${a.value}Kg, ${l.value}cm`,other:D()},{label:"Initial BMI",value:n.value,other:D()},{label:"Initial TB Status",value:i.value,other:D()},{label:"Pregnant at Initiation",value:u.value,other:D()},{label:"Breastfeeding at Initiation",value:r.value,other:D()},{label:"Latest VL Result and Result Date",value:b.value,other:{onClickHandler:()=>T.show(Ca,{patient:e.patient})}},{label:"TI",value:s.value,other:D()},{label:"HIV test place",value:p.value,other:D()},{label:"HIV test date",value:v.value,other:D()},{label:"WHO stage",value:g.value,other:D()},{label:"Reason for starting ART",value:m.value,other:D()},{label:"Staging condition",value:f.value,other:D()}]),N=()=>{e.patient.getInitialWeight().then(e=>a.value=e),e.patient.getInitialHeight().then(e=>l.value=e),e.patient.getInitialBMI().then(e=>n.value=e),e.patient.getInitialTBStatus().then(e=>i.value=e),e.patient.hasPregnancyAtARTInitiation().then(e=>u.value=e),e.patient.breastFeedingAtARTInitiation().then(e=>r.value=e),e.patient.everReceivedART().then(e=>s.value=e),e.patient.agreesToFollowUp().then(e=>c.value=e),e.patient.getReasonForStartingART().then(e=>m.value=e),e.patient.getHIVTestLocation().then(e=>p.value=e),e.patient.getStagingCondition().then(e=>f.value=e),e.patient.getWhoStage().then(e=>g.value=e),(async()=>{const t=await e.patient.getHIVTestDate();t&&(v.value=Ae(t))})()};return d(()=>{N(),w(),Me.on(je.RELOAD_LATEST_VL_RESULT,()=>w()),Me.on(je.RELOAD_STAGING_INFORMATION,()=>N())}),{patientInfo:I,onClickHandler:async e=>{var t;h(e)&&await(null===(t=e.other)||void 0===t?void 0:t.onClickHandler())},clickable:h}}}),Ea={style:{width:"100%",display:"flex",justifyContent:"space-between"}},Ba={key:0},Fa={key:1},qa={key:2},Ga={key:3};const Ua=x(ka,[["render",function(e,t,a,l,n,i){const o=C("ion-item"),r=C("ion-list"),u=C("multi-column-view");return f(),E(u,{items:e.patientInfo,numberOfColumns:3},{default:m(({entries:t})=>[c(r,{class:"his-card ion-margin-end"},{default:m(()=>[(f(!0),s(p,null,q(t,(a,l)=>(f(),E(o,{key:l,lines:l===t.length-1?"none":void 0,button:e.clickable(a),onClick:t=>e.onClickHandler(a)},{default:m(()=>[k("div",Ea,[a.label?(f(),s("span",Ba,G(a.label)+": ",1)):(f(),s("span",Fa)),e.clickable(a)?(f(),s("span",qa,[k("a",null,[k("b",null,G(a.value||"N/A"),1)])])):(f(),s("span",Ga,[k("b",null,G(a.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}],["__scopeId","data-v-6b436603"]]),Ha=i({components:{IonGrid:_,IonRow:w,IonCol:D,TextInput:ot,DateInput:Oe,SelectInput:xe},props:{patientService:{type:Object,required:!0}},setup(e){const t=o(!1),a=O(()=>/Unknown/i.test(e.patientService.getMWNationalID())?"":e.patientService.getMWNationalID()),l=r({givenName:{label:"First Name",value:e.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:e=>lt(e)},familyName:{label:"last Name",value:e.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:e=>lt(e)},middleName:{label:"middle Name",value:e.patientService.getMiddleName(),placeholder:"middle Name",validation:e=>!!e&&lt(e)},nationalId:{label:"Malawi National ID Number",value:a.value,placeholder:"Enter Malawi National ID Number",validation:e=>e&&e.label?nt(e):null},gender:{value:e.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:e.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:e.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async e=>!("Unknown"===e.value||"N/A"===e.value)&&it(e)},homeVillage:{value:e.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:e.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),n=async e=>{var t,a,l,n,i,o,r,u;let d,s;try{var c;null!=e&&null!==(c=e.other)&&void 0!==c&&c.traditional_authority_id&&(d=await se.getTraditionalAuthorityById(e.other.traditional_authority_id)),d&&(s=await se.getDistrictByID(d.district_id))}catch(m){We("Unable to resolve patient address. Saving using default address"),console.error(m)}return{home_district:null!==(t=null===(a=s)||void 0===a?void 0:a.name)&&void 0!==t?t:"N/A",home_traditional_authority:null!==(l=null===(n=d)||void 0===n?void 0:n.name)&&void 0!==l?l:"N/A",home_village:(null==e?void 0:e.label)||"N/A",current_district:null!==(i=null===(o=s)||void 0===o?void 0:o.name)&&void 0!==i?i:"N/A",current_traditional_authority:null!==(r=null===(u=d)||void 0===u?void 0:u.name)&&void 0!==r?r:"N/A",current_village:(null==e?void 0:e.label)||"N/A"}};return{today:Re,patient:l,getLandmarks:ut,genderOptions:ct,isBirthdateEstimated:t,modal:T,onFinish:async()=>Ue(l,async t=>{const l={};if(t.givenName!==e.patientService.getGivenName()&&(l.given_name=t.givenName),t.familyName!==e.patientService.getFamilyName()&&(l.family_name=t.familyName),t.middleName!==e.patientService.getMiddleName()&&(l.middle_name=t.middleName),t.birthdate!==e.patientService.getBirthdate()&&(l.birthdate=t.birthdate),t.gender.value!==e.patientService.getGender()&&(l.gender=t.gender.value),t.cellPhoneNumber!==e.patientService.getPhoneNumber()&&(l.cell_phone_number=t.cellPhoneNumber),t.landmark.label!==e.patientService.getClosestLandmark()&&(l.landmark=t.landmark.label),t.homeVillage!==e.patientService.getCurrentVillage()&&Object.assign(l,{...l,...await n(t.homeVillage)}),!ye(l)){const t=new bt;t.setPersonID(e.patientService.getID()),await t.updatePerson(l)}t.nationalId!==a.value&&await e.patientService.updateMWNationalId(t.nationalId),await T.hide(),Me.emit(je.RELOAD_PATIENT_DATA)}),getVillagesByName:dt}}});const za=x(Ha,[["render",function(e,t,a,l,n,i){const o=C("ion-title"),r=C("ion-icon"),u=C("ion-button"),d=C("ion-buttons"),v=C("ion-toolbar"),b=C("ion-header"),g=C("TextInput"),y=C("ion-col"),_=C("SelectInput"),w=C("DateInput"),D=C("ion-row"),V=C("ion-grid"),I=C("ion-content"),N=C("ion-footer");return f(),s(p,null,[c(b,null,{default:m(()=>[c(v,null,{default:m(()=>[c(o,null,{default:m(()=>[...t[12]||(t[12]=[h("Edit Patient Demographics",-1)])]),_:1}),c(d,{slot:"end"},{default:m(()=>[c(u,{onClick:t[0]||(t[0]=t=>e.modal.hide())},{default:m(()=>[c(r,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),c(I,{class:"ion-padding"},{default:m(()=>[c(V,null,{default:m(()=>[c(D,null,{default:m(()=>[c(y,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(g,{modelValue:e.patient.givenName,"onUpdate:modelValue":t[1]||(t[1]=t=>e.patient.givenName=t)},null,8,["modelValue"])]),_:1}),c(y,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(g,{modelValue:e.patient.middleName,"onUpdate:modelValue":t[2]||(t[2]=t=>e.patient.middleName=t)},null,8,["modelValue"])]),_:1}),c(y,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(g,{modelValue:e.patient.familyName,"onUpdate:modelValue":t[3]||(t[3]=t=>e.patient.familyName=t)},null,8,["modelValue"])]),_:1}),c(y,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(g,{modelValue:e.patient.nationalId,"onUpdate:modelValue":t[4]||(t[4]=t=>e.patient.nationalId=t)},null,8,["modelValue"])]),_:1}),c(y,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(_,{modelValue:e.patient.gender,"onUpdate:modelValue":t[5]||(t[5]=t=>e.patient.gender=t),options:e.genderOptions},null,8,["modelValue","options"])]),_:1}),c(y,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(w,{modelValue:e.patient.birthdate,"onUpdate:modelValue":t[6]||(t[6]=t=>e.patient.birthdate=t),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:e.today,onIsEstimated:t[7]||(t[7]=t=>e.isBirthdateEstimated=t)},null,8,["modelValue","maxDate"])]),_:1}),c(y,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(g,{modelValue:e.patient.cellPhoneNumber,"onUpdate:modelValue":t[8]||(t[8]=t=>e.patient.cellPhoneNumber=t),allowUnknown:""},null,8,["modelValue"])]),_:1}),c(y,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(_,{modelValue:e.patient.homeVillage,"onUpdate:modelValue":t[9]||(t[9]=t=>e.patient.homeVillage=t),asyncOptions:e.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),c(y,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(_,{modelValue:e.patient.landmark,"onUpdate:modelValue":t[10]||(t[10]=t=>e.patient.landmark=t),asyncOptions:e.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),c(N,null,{default:m(()=>[c(v,null,{default:m(()=>[c(u,{color:"primary",onClick:t[11]||(t[11]=t=>e.modal.hide()),slot:"end"},{default:m(()=>[...t[13]||(t[13]=[h("Close",-1)])]),_:1}),c(u,{class:"ion-margin-end",color:"success",onClick:e.onFinish,slot:"end"},{default:m(()=>[...t[14]||(t[14]=[h("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}]]),La=i({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(e){var t,a;const l=new bt,n=e,i=o(ye(n.guardians)),b=O(()=>(i.value?"Add":"Edit")+" Guardian Demographics"),g=O(()=>(i.value?"Edit":"Add")+" Guardian"),y=o([]),V=null!==(t=null===(a=n.guardians)||void 0===a?void 0:a.map(e=>({label:`${e.name} (${e.relationshipType})`,value:e.name,other:e})))&&void 0!==t?t:[],I=r({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),N=r({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:e=>lt(e)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:e=>lt(e)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async e=>"Unknown"!==e.value&&it(e)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});function R(){i.value=!i.value,I.guardian.value=""}u(()=>I.guardian.value,e=>{var t,a,l,n,i,o,r,u;N.givenName.value=null!==(t=null==e||null===(a=e.other)||void 0===a?void 0:a.names.given_name)&&void 0!==t?t:"",N.familyName.value=null!==(l=null==e||null===(n=e.other)||void 0===n?void 0:n.names.family_name)&&void 0!==l?l:"",N.cellPhoneNumber.value=null!==(i=null==e||null===(o=e.other)||void 0===o?void 0:o.phoneNumber)&&void 0!==i?i:"",N.relation.value=null!==(r=null==e||null===(u=e.other)||void 0===u?void 0:u.relationshipType)&&void 0!==r?r:""},{deep:!0,immediate:!0});const A=async()=>Ue(N,async e=>{i.value||ye(I.guardian.value)?await async function(e){var t,a;await l.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:n.patientId,...e}),await gt.createRelation(n.patientId,l.getPersonID(),null!==(t=null===(a=e.relation)||void 0===a?void 0:a.value)&&void 0!==t?t:13)}(e):await async function(e,t){const a=t.names.person_id,l={};if(t.names.given_name!==e.given_name&&(l.given_name=e.given_name),t.names.family_name!==e.family_name&&(l.family_name=e.family_name),t.phoneNumber!==e.cell_phone_number&&(l.cell_phone_number=e.cell_phone_number),!ye(l)){const e=new bt;e.setPersonID(a),await e.updatePerson(l)}var i,o;t.relationshipType!==e.relation.label&&await gt.amendRelation(n.patientId,a,t.id,null!==(i=null===(o=e.relation)||void 0===o?void 0:o.value)&&void 0!==i?i:13)}(e,I.guardian.value.other),await T.hide(),Me.emit(je.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return d(async()=>{const e=(await gt.getRelations()).data;y.value=e.map(e=>({label:e.b_is_to_a,value:e.relationship_type_id,other:e}))}),(e,t)=>{const a=C("ion-title"),l=C("ion-icon"),o=C("ion-button"),r=C("ion-buttons"),u=C("ion-toolbar"),d=C("ion-header"),S=C("ion-content"),P=C("ion-footer");return f(),s(p,null,[c(d,null,{default:m(()=>[c(u,null,{default:m(()=>[c(a,null,{default:m(()=>[h(G(b.value),1)]),_:1}),c(r,{slot:"end"},{default:m(()=>[c(o,{onClick:t[0]||(t[0]=e=>v(T).hide())},{default:m(()=>[c(l,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),c(S,{class:"ion-padding"},{default:m(()=>[c(v(_),null,{default:m(()=>[c(v(w),null,{default:m(()=>[i.value?B("",!0):(f(),E(v(D),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(xe,{modelValue:I.guardian,"onUpdate:modelValue":t[1]||(t[1]=e=>I.guardian=e),options:v(V)},null,8,["modelValue","options"])]),_:1})),I.guardian.value||i.value?(f(),s(p,{key:1},[c(v(D),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(ot,{modelValue:N.givenName,"onUpdate:modelValue":t[2]||(t[2]=e=>N.givenName=e)},null,8,["modelValue"])]),_:1}),c(v(D),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(ot,{modelValue:N.familyName,"onUpdate:modelValue":t[3]||(t[3]=e=>N.familyName=e)},null,8,["modelValue"])]),_:1}),c(v(D),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(ot,{modelValue:N.cellPhoneNumber,"onUpdate:modelValue":t[4]||(t[4]=e=>N.cellPhoneNumber=e),allowUnknown:""},null,8,["modelValue"])]),_:1}),c(v(D),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:m(()=>[c(xe,{modelValue:N.relation,"onUpdate:modelValue":t[5]||(t[5]=e=>N.relation=e),options:y.value},null,8,["modelValue","options"])]),_:1})],64)):B("",!0)]),_:1})]),_:1})]),_:1}),c(P,null,{default:m(()=>[c(u,null,{default:m(()=>[v(ye)(n.guardians)?B("",!0):(f(),E(o,{key:0,color:"primary",onClick:R,slot:"start"},{default:m(()=>[h(G(g.value),1)]),_:1})),c(o,{color:"primary",onClick:t[6]||(t[6]=e=>v(T).hide()),slot:"end"},{default:m(()=>[...t[7]||(t[7]=[h("Close",-1)])]),_:1}),c(o,{class:"ion-margin-end",color:"success",onClick:A,slot:"end"},{default:m(()=>[...t[8]||(t[8]=[h("Save",-1)])]),_:1})]),_:1})]),_:1})],64)}}}),Ma=i({components:{IonGrid:_,IonRow:w,IonCol:D,TextInput:ot},props:{patient:{type:Object,required:!0}},setup(e){const{facility:t}=n(),a=O(()=>e.patient.getArvNumber()),i=O(()=>!ye(a.value)&&"Unknown"!==a.value),o=r({arvNumber:{value:i.value?a.value.split("-")[2]:"",label:(i.value?"Edit":"Add New")+" ARV Number",placeholder:"Enter ARV Number",required:!0,validation:async e=>{const l=tt(e,"POSITIVE_INTEGERS");if(null!==l)return l;if(e.value===a.value.split("-")[2])return null;const n=await be.findByOtherID(4,`${t.code}-ARV-${e.value}`);return n.ok?ye(n.data)?null:["ARV Number already taken"]:[n.errorMessage||n.clientErrorType||`Unable to determine ARV number with status: ${n.httpStatusResponse}`]}}});return{form:o,modal:T,arvNumber:a,facility:t,hasValidARVNumber:i,onFinish:async()=>Ue(o,async l=>{l.arvNumber!==a.value.split("-")[2]&&(i.value?await e.patient.updateARVNumber(`${t.code}-ARV-${l.arvNumber}`):await e.patient.createArvNumber(`${t.code}-ARV-${l.arvNumber}`),Me.emit(je.RELOAD_PATIENT_DATA)),await T.hide()}),voidARV:async()=>{if(await P(`Are you sure you want to void this ARV Number ${a.value}?`)){await Je.show("Voiding ARV Number...");try{await l.postJson(`/programs/${ce}/void_arv_number/${a}`,{}),await Je.hide(),await T.hide(),Me.emit(je.RELOAD_PATIENT_DATA)}catch(e){await Je.hide(),console.log(e)}}}}}});const ja=x(Ma,[["render",function(e,t,a,l,n,i){const o=C("ion-title"),r=C("ion-icon"),u=C("ion-button"),d=C("ion-buttons"),v=C("ion-toolbar"),b=C("ion-header"),g=C("text-input"),y=C("ion-col"),_=C("ion-row"),w=C("ion-grid"),D=C("ion-content"),V=C("ion-footer");return f(),s(p,null,[c(b,null,{default:m(()=>[c(v,null,{default:m(()=>[c(o,null,{default:m(()=>[...t[3]||(t[3]=[h("ARV NUMBER",-1)])]),_:1}),c(d,{slot:"end"},{default:m(()=>[c(u,{onClick:t[0]||(t[0]=t=>e.modal.hide())},{default:m(()=>[c(r,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),c(D,{class:"ion-padding"},{default:m(()=>[c(w,null,{default:m(()=>[c(_,null,{default:m(()=>[c(y,null,{default:m(()=>[c(g,{modelValue:e.form.arvNumber,"onUpdate:modelValue":t[1]||(t[1]=t=>e.form.arvNumber=t),form:e.form,prefix:`${e.facility.code}-ARV-`},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),c(V,{class:"ion-padding-horizontal"},{default:m(()=>[c(v,null,{default:m(()=>[c(u,{color:"primary",onClick:t[2]||(t[2]=t=>e.modal.hide()),slot:"end"},{default:m(()=>[...t[4]||(t[4]=[h("Close",-1)])]),_:1}),e.hasValidARVNumber?(f(),E(u,{key:0,color:"danger",onClick:e.voidARV,slot:"start"},{default:m(()=>[...t[5]||(t[5]=[h("Void ARV Number",-1)])]),_:1},8,["onClick"])):B("",!0),c(u,{color:"success",onClick:e.onFinish,slot:"end"},{default:m(()=>[...t[6]||(t[6]=[h("Save",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})],64)}]]),$a=i({components:{VisitsSummary:xa,InformationHeader:Ua},setup(){const e=me(),t=parseInt(e.params.patientId.toString())||0,a=o(),l=o(""),n=o([]),i=O(()=>!ye(a.value)),r=O(()=>{var e;return null===(e=a.value)||void 0===e?void 0:e.getNationalID()}),u=async()=>{if(t){const e=(await be.findByID(t)).data;e&&(a.value=new be(e))}},s=async()=>{n.value=await Vt.getGuardianDetails(t)},c=async()=>{let e=!1;if(yt.value){var l;e=!(null===(l=a.value)||void 0===l?void 0:l.getDocID())||ft(r.value)||await _t(t)}else{const t=await wt(r.value);e=!t||t.length>1}e&&await(async()=>{await Je.show("Client has Invalid NPID. Assigning NPID...");const e=await be.assignNPID(t);var a;e.ok?(await u(),await Je.hide()):(await Je.hide(),We(null!==(a=e.errorMessage)&&void 0!==a?a:"Failed to assign NPID"))})()};return Me.on(je.RELOAD_PATIENT_DATA,async()=>{await u()}),Me.on(je.RELOAD_GUARDIAN_DATA,async()=>{await s()}),d(async()=>{var e;await ht(),await u(),await c();const t=await(null===(e=a.value)||void 0===e?void 0:e.getARTStartDate());l.value=t?Ae(t):"N/A",s()}),{patient:a,artStartDate:l,guardians:n,isReady:i,updateDemographics:async e=>{await T.show(za,{patientService:a.value,attribute:e})},updateGuardian:async()=>{await T.show(La,{patientId:t,guardians:n.value})},updateARVNumber:async()=>{await T.show(ja,{patient:a.value})}}}});t("default",x($a,[["render",function(e,t,a,l,n,i){const o=C("information-header"),r=C("ion-col"),u=C("ion-row"),d=C("visits-summary"),s=C("ion-grid");return e.isReady?(f(),E(s,{key:0,class:"ion-no-margin ion-no-padding"},{default:m(()=>[c(u,null,{default:m(()=>[c(r,{size:"12"},{default:m(()=>[e.patient?(f(),E(o,{key:0,patient:e.patient,guardians:e.guardians,artStartDate:e.artStartDate,onUpdateARVNumber:e.updateARVNumber,onUpdateGuardian:e.updateGuardian,onUpdatePatient:e.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):B("",!0)]),_:1})]),_:1}),c(u,null,{default:m(()=>[c(r,null,{default:m(()=>[e.patient?(f(),E(d,{key:0,patient:e.patient,startDate:e.artStartDate},null,8,["patient","startDate"])):B("",!0)]),_:1})]),_:1})]),_:1})):B("",!0)}]]))}}})}();
