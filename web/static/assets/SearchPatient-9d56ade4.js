import{d as W,l as x,m as F,n as G,I as U,ap as j,f as L,r as y,h as T,aj as Q,i as q,K as z,k as Y,aQ as R,aC as $,aV as P,_ as H,N as c,j as J,w as l,o as X,e as s,C as M,a as k,b as N}from"./index-f1e5fa33.js";import{t as S,b as Z}from"./toasts-d1d3b45b.js";import{g as ee}from"./DTFormElements-9dbc03af.js";import{S as ae}from"./SelectInput-95bf7c98.js";import{D as te}from"./index-df3a20fe.js";import{p as ne}from"./VoidReason-c552cb66.js";import{t as oe}from"./Strs-0c962638.js";import{t as re,h as se}from"./his_date-4bcc965c.js";import{r as ie,a as le,i as ce,b as ue}from"./dde-2fdf22a7.js";import{b as de}from"./validations-f17a1dc8.js";import"./arrays-1b521787.js";import"./common-abc2f84d.js";const me=W({components:{IonGrid:x,IonRow:F,IonCol:G,SelectInput:ae,IonButton:U,IonSearchbar:j,DataTable:te},setup(){const n=L(),{facility:o}=Y(),r=y(""),C=y(document.getElementById("selectInput")),u=y(!1),d=y([]),I=T(()=>o.code+"-ARV-"),m=Q({value:void 0,placeholder:"select gender"});q(()=>ie());const p=[{label:"ARV Number",path:"arv_number"},{label:"MW National ID",path:"national_id"},{path:"given_name",label:"First name"},{path:"family_name",label:"Last name"},{path:"gender",label:"Gender",formatter:oe},{path:"birthdate",label:"Date of Birth (AGE)",formatter:a=>"".concat(re(a)," (").concat(se(a),")")},{path:"source",label:"Source"}],f={showSearchField:!1,showSubmitButton:!1},_=async a=>{var t;const e=await R.searchByOtherID($,a);return e.ok?e.data:(S((t=e.errorMessage)!=null?t:"Searching client by Malawi National ID returned error: ".concat(e.clientErrorType)),[])},b=async a=>{var t;const e=await R.searchByOtherID(P,a);return e.ok?e.data:(S((t=e.errorMessage)!=null?t:"Searching client by ARV Number returned error: ".concat(e.clientErrorType)),[])},D=(a,e)=>{const t={},i=a.split(" ").filter(v=>/\S/.test(v));return e&&(t.gender=e),i.length>0&&(t.given_name=i[0],t.family_name=i[2]||i[1]||"",t.middle_name=i[2]?i[1]:""),ue(t)},h=a=>a.split(" ").length===1&&(a.length>=6||a.length===13),g=a=>{u.value&&(u.value=!1),a==null||a.map(e=>{var t,i,v,A,B;return d.value.push({arv_number:(t=e.patient_identifiers.find(w=>w.identifier_type==P))==null?void 0:t.identifier,national_id:(i=e.patient_identifiers.find(w=>w.identifier_type==$))==null?void 0:i.identifier,given_name:e.person.names[0].given_name,family_name:e.person.names[0].family_name,gender:e.person.gender,birthdate:e.person.birthdate,personId:e.patient_id,source:(v=e.source)!=null?v:"locals",docID:(A=e.docID)!=null?A:"",ddeClientRequiresImport:(B=e==null?void 0:e.ddeClientRequiresImport)!=null?B:!1})})},V=async()=>{var a;if(r.value&&!u.value)try{u.value=!0,d.value=[],r.value.match(/^(\w+-ARV-\w+)$/)&&b(r.value).then(g),de({value:r.value,label:r.value})===null&&_(r.value).then(g),h(r.value)&&le(r.value).then(g),r.value.match(/^(\d+)$/)?b("".concat(I.value).concat(r.value)).then(g):D(r.value,(a=m.value)==null?void 0:a.value).then(g)}catch(e){S("Unable to search patients"),console.error(e)}},E=()=>{r.value="",d.value=[],m.value=void 0},K=()=>({label:"void",color:"danger",action:async a=>{ne(async e=>{try{await R.void(a.personId,e),await V()}catch(t){Z("".concat(t))}},"void-modal")}}),O=T(()=>{const a=[{label:"Select",action:e=>{e.ddeClientRequiresImport?ce(e.docID).then(t=>{t&&n.push("/patient/".concat(t.patient_id))}):n.push("/patient/".concat(e.personId))}}];return z.userHasRoles(["Program Manager","Superuser","System Developer"])&&a.push(K()),a});return{searchText:r,gender:m,tableRows:d,tableColumns:p,tableConfig:f,genderOptions:ee,selectInput:C,TableRowActions:O,searchPatient:V,resetQuery:E}}});const pe={style:{"max-width":"250px"},class:"ion-margin-end ion-margin-vertical"};function fe(n,o,r,C,u,d){const I=c("ion-searchbar"),m=c("SelectInput"),p=c("ion-button"),f=c("ion-col"),_=c("ion-row"),b=c("data-table"),D=c("ion-grid");return X(),J(D,null,{default:l(()=>[s(_,{class:"his-card"},{default:l(()=>[s(f,{size:"10",style:{display:"flex","justify-content":"flex-start"}},{default:l(()=>[s(I,{style:{width:"350px",height:"2.75rem"},class:"box-input ion-no-padding ion-margin-end ion-margin-vertical",placeholder:"Search by Name or ARV Number or MW National ID",modelValue:n.searchText,"onUpdate:modelValue":o[0]||(o[0]=h=>n.searchText=h),onKeyup:M(n.searchPatient,["enter"])},null,8,["modelValue","onKeyup"]),k("div",pe,[s(m,{modelValue:n.gender,"onUpdate:modelValue":o[1]||(o[1]=h=>n.gender=h),options:n.genderOptions,onKeyup:M(n.searchPatient,["enter"])},null,8,["modelValue","options","onKeyup"])]),s(p,{class:"ion-margin-vertical",onClick:n.searchPatient},{default:l(()=>[...o[2]||(o[2]=[N("Search",-1)])]),_:1},8,["onClick"]),s(p,{class:"ion-margin-vertical",onClick:n.resetQuery,color:"secondary"},{default:l(()=>[...o[3]||(o[3]=[N("Reset",-1)])]),_:1},8,["onClick"])]),_:1}),s(f,null,{default:l(()=>[s(p,{class:"ion-margin-vertical",href:"/patient/registration",color:"success",style:{float:"right"}},{default:l(()=>[...o[4]||(o[4]=[N(" Add New Patient ",-1)])]),_:1})]),_:1})]),_:1}),s(_,{class:"his-card ion-margin-top",style:{padding:"0 !important"}},{default:l(()=>[s(f,{size:"12",style:{"min-height":"320px"},class:"ion-no-padding"},{default:l(()=>[o[5]||(o[5]=k("h1",{class:"ion-margin"},"Patients Search Results",-1)),s(b,{rows:n.tableRows,columns:n.tableColumns,config:n.tableConfig,"row-actions-buttons":n.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])]),_:1})]),_:1})]),_:1})}const Ce=H(me,[["render",fe]]);export{Ce as default};
